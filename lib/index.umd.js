(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
    typeof define === 'function' && define.amd ? define(['exports'], factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.NECallKit = {}));
})(this, (function (exports) { 'use strict';

    /******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    /* global Reflect, Promise */

    var extendStatics = function(d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };

    function __extends(d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    }

    var __assign = function() {
        __assign = Object.assign || function __assign(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };

    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    function __generator(thisArg, body) {
        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
        return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
        function verb(n) { return function (v) { return step([n, v]); }; }
        function step(op) {
            if (f) throw new TypeError("Generator is already executing.");
            while (_) try {
                if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
                if (y = 0, t) op = [op[0] & 2, t.value];
                switch (op[0]) {
                    case 0: case 1: t = op; break;
                    case 4: _.label++; return { value: op[1], done: false };
                    case 5: _.label++; y = op[1]; op = [0]; continue;
                    case 7: op = _.ops.pop(); _.trys.pop(); continue;
                    default:
                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                        if (t[2]) _.ops.pop();
                        _.trys.pop(); continue;
                }
                op = body.call(thisArg, _);
            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
        }
    }

    function __values(o) {
        var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
        if (m) return m.call(o);
        if (o && typeof o.length === "number") return {
            next: function () {
                if (o && i >= o.length) o = void 0;
                return { value: o && o[i++], done: !o };
            }
        };
        throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
    }

    var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

    function unwrapExports (x) {
    	return x && x.__esModule && Object.prototype.hasOwnProperty.call(x, 'default') ? x['default'] : x;
    }

    function createCommonjsModule(fn, module) {
    	return module = { exports: {} }, fn(module, module.exports), module.exports;
    }

    var NERTC = createCommonjsModule(function (module, exports) {
    /*! NeRTC 4.6.50|BUILD v4.6.50-0-gaba0865d production 20230315 */
    !function(e,t){module.exports=t();}(window,(function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r});},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0});},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=205)}([function(e,t){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=i);},function(e,t,i){var r=i(32)("wks"),s=i(22),a=i(0).Symbol,o="function"==typeof a;(e.exports=function(e){return r[e]||(r[e]=o&&a[e]||(o?a:s)("Symbol."+e))}).store=r;},function(e,t){var i=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=i);},function(e,t,i){var r=i(7);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getParameters=void 0;const r=i(70);let s={tracks:{audio:[],video:[]},shimVideoOrientation:"never",shimCanvas:"ios151",clients:[],localStreams:[],debugG2:!1,enableAlerter:"never",videoLowMaxWidth:320,videoLowMaxHeight:180,videoLowFramerate:15,videoLowCheckCanvasBlank:"ios",screenLowMaxWidth:320,screenLowMaxHeight:180,screenLowFramerate:15,controlOnPaused:!0,hideControlOnResume:!0,maxTransportRebuildCnt:Number.MAX_SAFE_INTEGER,logLevel:r.loglevels.INFO,forceLogLevel:-1,forceLogUpload:"default",forceListenDeviceChange:!0,codecOptions:{audio:{opusStereo:!0,opusDtx:!0}},videoHighStartBitrate:1e3,videoHighMinBitrate:0,videoLowStartBitrate:500,videoLowMinBitrate:0,screenHighStartBitrate:2e3,screenHighMinBitrate:0,screenLowStartBitrate:500,screenLowMinBitrate:0,screenFocus:!0,allowEmptyMedia:!0,keepLocalstreamOnLeave:!1,joinFirstTimeout:2e3,joinMaxRetry:3,reconnectionFirstTimeout:2e3,reconnectionMaxRetry:3,leaveOnUnload:!0,trustOnOnline:!1,h264Wait:1e3,encoderWatermarkLimit:1,encoderWatermarkFontFamily:"Verdana",forceEncodedInsertableStreams:!1,forceCustomEncryptionOff:!1,h264StrictHigh:!1,disableH264Send:!1,disableVP8Send:!1,enableTcpCandidate:!0,enableUdpCandidate:!0,maxEventLoopLagWarning:3,enableCompatAudio:!1,audioInputcompatMode:"auto",fireBackupDelay:5e3,audioAslFlag:!0,keepAspectRatio:!1,disableLBSService:!1,protooMessageTimeout:3e4,reuseMid:!0,playMediaTimeout:3e3,disableWebAudio:!1,disable2dContext:!1,disableWebGLContext:!1,reportPageBrowserId:!0,doHeartbeatInterval:1e3,deviceChangeInterval:0,h264ProfileLevel:"",h264ProfileLevelSignal:"42e01f",forceBWE:"transport-cc",shimLocalCanvas:"safari"};try{if(location.search&&"function"==typeof URLSearchParams){const e=new URLSearchParams(location.search);let t;for(t in s){const i=s[t],r=e.get(t);if(r){let e=null;"string"==typeof i?e=r:"boolean"==typeof i?"true"!==r&&"false"!==r||(e="true"===r):"number"==typeof i&&(e=Number(r),Number(r)>Number.MIN_SAFE_INTEGER&&(e=Number(r))),null!==e&&i!==e&&(console.warn(`NERTC 通过URL改变了私有化变量：${t}:`,i,"=>",e),s[t]=e);}}}}catch(e){}t.getParameters=()=>s;},function(e,t,i){var r=i(6),s=i(21);e.exports=i(8)?function(e,t,i){return r.f(e,t,s(1,i))}:function(e,t,i){return e[t]=i,e};},function(e,t,i){var r=i(3),s=i(41),a=i(29),o=Object.defineProperty;t.f=i(8)?Object.defineProperty:function(e,t,i){if(r(e),t=a(t,!0),r(i),s)try{return o(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return "value"in i&&(e[t]=i.value),e};},function(e,t){e.exports=function(e){return "object"==typeof e?null!==e:"function"==typeof e};},function(e,t,i){e.exports=!i(20)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}));},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)};},function(e,t,i){var r=Object.prototype.hasOwnProperty,s="~";function a(){}function o(e,t,i){this.fn=e,this.context=t,this.once=i||!1;}function n(){this._events=new a,this._eventsCount=0;}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(s=!1)),n.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},n.prototype.listeners=function(e,t){var i=s?s+e:e,r=this._events[i];if(t)return !!r;if(!r)return [];if(r.fn)return [r.fn];for(var a=0,o=r.length,n=new Array(o);a<o;a++)n[a]=r[a].fn;return n},n.prototype.emit=function(e,t,i,r,a,o){var n=s?s+e:e;if(!this._events[n])return !1;var d,c,l=this._events[n],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,r),!0;case 5:return l.fn.call(l.context,t,i,r,a),!0;case 6:return l.fn.call(l.context,t,i,r,a,o),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d);}else {var h,p=l.length;for(c=0;c<p;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,i);break;case 4:l[c].fn.call(l[c].context,t,i,r);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d);}}return !0},n.prototype.on=function(e,t,i){var r=new o(t,i||this),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},n.prototype.once=function(e,t,i){var r=new o(t,i||this,!0),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},n.prototype.removeListener=function(e,t,i,r){var o=s?s+e:e;if(!this._events[o])return this;if(!t)return 0==--this._eventsCount?this._events=new a:delete this._events[o],this;var n=this._events[o];if(n.fn)n.fn!==t||r&&!n.once||i&&n.context!==i||(0==--this._eventsCount?this._events=new a:delete this._events[o]);else {for(var d=0,c=[],l=n.length;d<l;d++)(n[d].fn!==t||r&&!n[d].once||i&&n[d].context!==i)&&c.push(n[d]);c.length?this._events[o]=1===c.length?c[0]:c:0==--this._eventsCount?this._events=new a:delete this._events[o];}return this},n.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&(0==--this._eventsCount?this._events=new a:delete this._events[t])):(this._events=new a,this._eventsCount=0),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this},n.prefixed=s,n.EventEmitter=n,e.exports=n;},function(e,t,i){var r=i(82),s=i(27);e.exports=function(e){return r(s(e))};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});t.default={PAGE_UNLOAD:3e4,LOGIN_FAILED:30001,MEDIA_CONNECTION_DISCONNECTED:30204,SIGNAL_CONNECTION_DISCONNECTED:30205,CLIENT_BANNED:30206,CHANNEL_CLOSED:30207,UID_DUPLICATE:30209,PERMKEY_TIMEOUT:30902,AUTO_PLAY_NOT_ALLOWED:41030,INVALID_PARAMETER_ERROR:1e4,NOT_SUPPORT_ERROR:10001,NETWORK_ERROR:10002,NETWORK_REQUEST_ERROR:10003,INVALID_OPERATION_ERROR:10008,API_CALL_SEQUENCE_BEFORE_ERROR:10009,API_CALL_SEQUENCE_AFTER_ERROR:10010,LOCALSTREAM_NOT_FOUND_ERROR:10011,UNKNOWN_TYPE_ERROR:10012,LOGIN_REQUEST_ERROR:10017,RECONNECTING:10020,SERVER_UNKNOWN_ERROR:10099,JOIN_FAILED:10100,REPEAT_JOIN_ERROR:10101,USER_NOT_IN_CHANNEL_ERROR:10104,JOIN_PERMKEY_ERROR:10109,JOIN_WITHOUT_CHANNEL_NAME:10110,JOIN_RECORD_TYPE_ERROR:10111,JOIN_UID_TYPE_ERROR:10112,SERVER_AUTH_ERROR:10119,SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR:10121,TASKS_ROLE_ERROR:10131,ADD_TASK_PARAMETER_ERROR:10132,ADD_TASK_FAILED_ERROR:10133,DELETE_TASK_PARAMETER_ERROR:10134,DELETE_TASK_FAILED_ERROR:10135,UPDATE_TASK_PARAMETER_ERROR:10136,UPDATE_TASKS_FAILED_ERROR:10137,STREAM_UID_ERROR:10210,STREAM_PROFILE_ERROR:10211,MEDIA_DEVICE_ERROR:10212,STREAM_PLAY_ARGUMENT_ERROR:10215,STREAM_RENDER_ARGUMENT_ERROR:10216,STREAM_ISPLAYING_ARGUMENT_ERROR:10218,STREAM_OPTN_NO_TYPE_ERROR:10220,REPEAT_OPEN_MIC_ERROR:10221,REPEAT_OPEN_AUDIO_SLAVE_ERROR:10222,REPEAT_OPEN_CAMERA_ERROR:10223,REPEAT_OPEN_SCREEN_ERROR:10224,STREAM_CLOSE_ARGUMENT_ERROR:10228,STREAM_CLOSE_AUDIO_ERROR:10229,STREAM_CLOSE_AUDIO_SLAVE_ERROR:10230,STREAM_CLOSE_CAMERA_ERROR:10231,STREAM_CLOSE_SCREEN_ERROR:10232,STREAM_NOT_SUBSCRIBE_AUDIO:10240,STREAM_NOT_SUBSCRIBE_AUDIO_SLAVE:10241,STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR:10242,STREAM_TAKE_SNAPSHOT_ERROR:10247,STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR:10248,SET_AUDIO_VOLUME_ARGUMENTS_ERROR:10250,SET_AUDIO_VOLUME_ERROR:10251,SET_CAPTURE_VOLUME_ARGUMENTS_ERROR:10252,SET_AUDIO_OUTPUT_ERROR:10253,SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR:10254,SWITCH_DEVICE_REPEAT_ERROR:10255,SWITCH_DEVICE_NO_MIC_ERROR:10256,SWITCH_DEVICE_NO_SUPPORT_AUDIO:10257,SWITCH_DEVICE_NO_CAMERA_ERROR:10258,SWITCH_DEVICE_NO_SUPPORT_VIDEO:10259,STREAM_MUTE_AUDIO_ERROR:10265,STREAM_NOT_MUTE_AUDIO_YET:10266,STREAM_UNMUTE_AUDIO_WITHOUT_STREAM:10267,STREAM_MUTE_AUDIO_SLAVE_ERROR:10270,STREAM_NOT_MUTE_AUDIO_SLAVE_YET:10271,STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM:10272,STREAM_MUTE_VIDEO_ERROR:10275,STREAM_NOT_MUTE_VIDEO_YET:10276,STREAM_UNMUTE_VIDEO_WITHOUT_STREAM:10277,STREAM_MUTE_SCREEN_ERROR:10280,STREAM_NOT_MUTE_SCREEN_YET:10281,STREAM_UNMUTE_SCREEN_WITHOUT_STREAM:10282,PUBLISH_NO_STREAM:10350,PUBLISH_ROLE_ERROR:10351,PUBLISH_SERVER_ERROR:10355,SUBSCRIBE_SERVER_ERROR:10360,WEBGL_NOT_SUPPORT_ERROR:10401,WEBGL_LOSE_CONTEXT_ERROR:10402,WEBGL_RESTORED_FAILD_ERROR:10403,BASIC_BEAUTY_RES_ERROR:10404,ADV_BEAUTY_RES_ERROR:10405,PLUGIN_LOADED_ERROR:10406,PLUGIN_ERROR:10407,PLUGIN_REGISTER_ERROR:10408,PLUGIN_NOT_REGISTER:10409,AUDIO_MIX_NO_AUDIO:10420,AUDIO_MIX_FILE_ERROR:10421,AUDIO_MIX_NO_SUPPORT:10422,AUDIO_MIX_NOT_STATE_ERROR:10423,AUDIO_MIX_NOT_PAUSE:10424,AUDIO_MIX_VOLUME_ERROR:10425,AUDIO_MIX_PLAY_START_TIME_ERROR:10426,AUDIO_EFFECT_NO_SUPPORT:10430,AUDIO_EFFECT_FILE_ERROR:10431,AUDIO_EFFECT_NO_AUDIO:10432,AUDIO_EFFECT_NOT_STATE_ERROR:10433,AUDIO_EFFECT_FILE_LOST_ERROR:10434,AUDIO_EFFECT_NOT_PAUSE:10435,AUDIO_EFFECT_PLAY_ALREADY:10436,AUDIO_EFFECT_ERROR:10437,SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR:10445,UPDATE_PERMKEY_ERROR:10446,RECORDING_NOT_SUPPORT:10450,REPEAT_RECORDING_ERROR:10451,RECORDING_CACHE_ERROR:10452,RECORDING_ERROR:10453,RECORDING_NOT_START_ERROR:10454,WATERMARKS_EXCEEDED_ERROR:10460,LBS_REQUEST_ERROR:10461,LBS_JSON_ERROR:10462,CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR:10471,SET_ENCRYPTION_MODE_ERROR:10472,SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR:10473,ROLE_TYPE_ERROR:10477,GET_SYSTEM_STATS_NOT_SUPPORT_ERROR:10480};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(i(12));class a extends Error{constructor(e){let t=e.url?e.url:"https://doc.yunxin.163.com/docs/interface/NERTC_SDK/Latest/Web/api/index.html#errorCode",i=e.advice?` advice: ${e.advice} `:"";super(e.message+` <${function(e){for(let t in s.default)if(s.default[t]===e)return t;return "UNKNOWN"}(e.code)} ${e.code.toString()}> `+i+t),this.code_=e.code||0,this.message_=e.message||null,this.advice_=e.advice||null,this.extraCode_=e.extraCode||null;}get code(){return this.code_}get message(){return this.message_}get extraCode(){return this.extraCode_}get advice(){return this.advice_}getCode(){return this.code_}getMessage(){return this.message_}getProposal(){return this.advice_}getExtraCode(){return this.extraCode_}}t.default=a;},function(e,t){e.exports=!0;},function(e,t,i){var r=i(0),s=i(2),a=i(18),o=i(5),n=i(9),d=function(e,t,i){var c,l,u,h=e&d.F,p=e&d.G,m=e&d.S,f=e&d.P,g=e&d.B,v=e&d.W,y=p?s:s[t]||(s[t]={}),S=y.prototype,_=p?r:m?r[t]:(r[t]||{}).prototype;for(c in p&&(i=t),i)(l=!h&&_&&void 0!==_[c])&&n(y,c)||(u=l?_[c]:i[c],y[c]=p&&"function"!=typeof _[c]?i[c]:g&&l?a(u,r):v&&_[c]==u?function(e){var t=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,i)}return new e(t,i,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):f&&"function"==typeof u?a(Function.call,u):u,f&&((y.virtual||(y.virtual={}))[c]=u,e&d.R&&S&&!S[c]&&o(S,c,u)));};d.F=1,d.G=2,d.S=4,d.P=8,d.B=16,d.W=32,d.U=64,d.R=128,e.exports=d;},function(e,t){e.exports={};},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)};},function(e,t,i){var r=i(19);e.exports=function(e,t,i){if(r(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}};},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e};},function(e,t){e.exports=function(e){try{return !!e()}catch(e){return !0}};},function(e,t){e.exports=function(e,t){return {enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}};},function(e,t){var i=0,r=Math.random();e.exports=function(e){return "Symbol(".concat(void 0===e?"":e,")_",(++i+r).toString(36))};},function(e,t,i){var r=i(6).f,s=i(9),a=i(1)("toStringTag");e.exports=function(e,t,i){e&&!s(e=i?e:e.prototype,a)&&r(e,a,{configurable:!0,value:t});};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ELECTRON_VERSION=t.IS_ELECTRON=t.IS_UCBROWSER=t.IS_WX=t.IS_LINUX=t.MACOS_VERSION=t.IS_MAC=t.WIN_VERSION=t.IS_WIN=t.IPADQQB_VERSION=t.IS_IPADQQB=t.MACQQB_VERSION=t.IS_MACQQB=t.WQQB_VERSION=t.IS_WQQB=t.MQQB_VERSION=t.IS_MQQB=t.IS_X5MQQB=t.WECHAT_MAJOR_VERSION=t.WECHAT_VERSION=t.IS_WECHAT=t.IE_VERSION=t.IS_IE=t.IS_IE8=t.XWEB_VERSION=t.IS_XWEB=t.TBS_VERSION=t.IS_TBS=t.SOGOU_VERSION=t.IS_SOGOU=t.SOGOUM_VERSION=t.IS_SOGOUM=t.EDG_VERSION=t.EDG_MAJOR_VERSION=t.IS_EDG=t.EDGE_VERSION=t.IS_EDGE=t.FIREFOX_MAJOR_VERSION=t.FIREFOX_VERSION=t.IS_FIREFOX=t.ANDROID_VERSION=t.IS_ANDROID=t.IOS_MAJOR_VERSION=t.IOS_VERSION=t.IS_IOS=t.IS_IPOD=t.IS_IPHONE=t.IS_IPAD=t.USER_LANGUAGE=t.USER_AGENT=void 0,t.IS_EN=t.IS_ZH=t.IS_LOCAL=t.IS_IOS_SAFARI=t.IS_MAC_SAFARI=t.SAFARI_VERSION=t.SAFARI_MAJOR_VERSION=t.IS_ANY_SAFARI=t.IS_SAFARI=t.IOS_FIREFOX_MAJOR_VERSION=t.IOS_FIREFOX_VERSION=t.IS_IOS_FIREFOX=t.IOS_EDGE_MAJOR_VERSION=t.IOS_EDGE_VERSION=t.IS_IOS_EDGE=t.IOS_CHROME_MAJOR_VERSION=t.IOS_CHROME_VERSION=t.IS_IOS_CHROME=t.ANY_CHROME_MAJOR_VERSION=t.CHROME_VERSION=t.CHROME_MAJOR_VERSION=t.IS_CHROME=t.IS_CHROME_ONLY=t.VIVO_VERSION=t.IS_VIVOBROWSER=t.OPPO_VERSION=t.IS_OPPOBROWSER=t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER=t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER=t.MI_VERSION=t.IS_MIBROWSER=void 0,t.USER_AGENT=window.navigator&&window.navigator.userAgent||"",t.USER_LANGUAGE=window.navigator&&window.navigator.language,t.IS_IPAD=/iPad/i.test(t.USER_AGENT),t.IS_IPHONE=/iPhone/i.test(t.USER_AGENT)&&!t.IS_IPAD,t.IS_IPOD=/iPod/i.test(t.USER_AGENT),t.IS_IOS=t.IS_IPHONE||t.IS_IPAD||t.IS_IPOD,t.IOS_VERSION=t.IS_IOS&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IOS_MAJOR_VERSION=t.IOS_VERSION&&function(){const e=t.IOS_VERSION.match(/\d+.?\d/);return e&&e[0]?parseFloat(e[0]):null}(),t.IS_ANDROID=/Android/i.test(t.USER_AGENT),t.ANDROID_VERSION=t.IS_ANDROID&&function(){const e=t.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const i=e[1],r=e[2],s=e[3];return i&&r&&s?i+"."+r+"."+s:i&&r?i+"."+r:i||null}(),t.IS_FIREFOX=/Firefox/i.test(t.USER_AGENT),t.FIREFOX_VERSION=t.IS_FIREFOX&&function(){const e=navigator.userAgent.match(/Firefox\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.FIREFOX_MAJOR_VERSION=t.IS_FIREFOX&&function(){const e=t.USER_AGENT.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_EDGE=/Edge\//i.test(t.USER_AGENT),t.EDGE_VERSION=t.IS_EDGE&&function(){var e=t.USER_AGENT.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_EDG=/Edg\//i.test(t.USER_AGENT),t.EDG_MAJOR_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.EDG_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SOGOUM=/SogouMobileBrowser\//i.test(t.USER_AGENT),t.SOGOUM_VERSION=t.IS_SOGOUM&&function(){const e=t.USER_AGENT.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SOGOU=/MetaSr\s/i.test(t.USER_AGENT),t.SOGOU_VERSION=t.IS_SOGOU&&function(){const e=t.USER_AGENT.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_TBS=/TBS\/\d+/i.test(t.USER_AGENT),t.TBS_VERSION=t.IS_TBS&&function(){var e=t.USER_AGENT.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_XWEB=/XWEB\/\d+/i.test(t.USER_AGENT),t.XWEB_VERSION=t.IS_XWEB&&function(){var e=t.USER_AGENT.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_IE8=/MSIE\s8\.0/.test(t.USER_AGENT),t.IS_IE=/MSIE\/\d+/i.test(t.USER_AGENT),t.IE_VERSION=t.IS_IE&&function(){const e=/MSIE\s(\d+)\.\d/.exec(t.USER_AGENT);let i=e&&parseFloat(e[1]);return !i&&/Trident\/7.0/i.test(t.USER_AGENT)&&/rv:11.0/.test(t.USER_AGENT)&&(i=11),i}(),t.IS_WECHAT=/(micromessenger|webbrowser)/i.test(t.USER_AGENT),t.WECHAT_VERSION=t.IS_WECHAT&&function(){var e=navigator.userAgent.match(/MicroMessenger\/([\d.]+)/);if(e&&e[1])return e[1]}(),t.WECHAT_MAJOR_VERSION=t.IS_WECHAT&&function(){var e=t.USER_AGENT.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return parseFloat(e[1])}(),t.IS_X5MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&/COVC\/\d+/i.test(t.USER_AGENT),t.IS_MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&!/COVC\/\d+/i.test(t.USER_AGENT),t.MQQB_VERSION=(t.IS_MQQB||t.IS_X5MQQB)&&function(){const e=t.USER_AGENT.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WQQB=!t.IS_TBS&&/ QQBrowser\/\d+/i.test(t.USER_AGENT),t.WQQB_VERSION=t.IS_WQQB&&function(){const e=t.USER_AGENT.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MACQQB=!t.IS_TBS&&/QQBrowserLite\/\d+/i.test(t.USER_AGENT),t.MACQQB_VERSION=t.IS_MACQQB&&function(){const e=t.USER_AGENT.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_IPADQQB=!t.IS_TBS&&/MQBHD\/\d+/i.test(t.USER_AGENT),t.IPADQQB_VERSION=t.IS_IPADQQB&&function(){const e=t.USER_AGENT.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WIN=/Windows/i.test(t.USER_AGENT),t.WIN_VERSION=t.IS_WIN&&function(){const e=t.USER_AGENT.match(/Windows NT (\d+)(?:\.(\d+))?(?:\.(\d+))*/i),i=e&&e[1],r=e&&e[2];return i&&r?i+"."+r:i||null}(),t.IS_MAC=!t.IS_IOS&&/MAC OS X/i.test(t.USER_AGENT),t.MACOS_VERSION=t.IS_MAC&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IS_LINUX=!t.IS_ANDROID&&/Linux/i.test(t.USER_AGENT),t.IS_WX=/MicroMessenger/i.test(t.USER_AGENT),t.IS_UCBROWSER=/UCBrowser/i.test(t.USER_AGENT),t.IS_ELECTRON=/Electron/i.test(t.USER_AGENT),t.ELECTRON_VERSION=t.IS_ELECTRON&&function(){const e=t.USER_AGENT.match(/Electron\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MIBROWSER=/MiuiBrowser/i.test(t.USER_AGENT),t.MI_VERSION=t.IS_MIBROWSER&&function(){const e=t.USER_AGENT.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_HUAWEIBROWSER=/HuaweiBrowser/i.test(t.USER_AGENT),t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER&&function(){const e=t.USER_AGENT.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAMSUNGBROWSER=/SamsungBrowser/i.test(t.USER_AGENT),t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER&&function(){const e=t.USER_AGENT.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_OPPOBROWSER=/HeyTapBrowser/i.test(t.USER_AGENT),t.OPPO_VERSION=t.IS_OPPOBROWSER&&function(){const e=t.USER_AGENT.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_VIVOBROWSER=/VivoBrowser/i.test(t.USER_AGENT),t.VIVO_VERSION=t.IS_VIVOBROWSER&&function(){const e=t.USER_AGENT.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_CHROME_ONLY=/Chrome/i.test(t.USER_AGENT),t.IS_CHROME=!t.IS_EDGE&&!t.IS_SOGOU&&!t.IS_SOGOUM&&!t.IS_TBS&&!t.IS_XWEB&&!t.IS_EDG&&!t.IS_WQQB&&!t.IS_MIBROWSER&&!t.IS_HUAWEIBROWSER&&!t.IS_SAMSUNGBROWSER&&!t.IS_OPPOBROWSER&&!t.IS_VIVOBROWSER&&/Chrome/i.test(t.USER_AGENT),t.CHROME_MAJOR_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.CHROME_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.ANY_CHROME_MAJOR_VERSION=function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_CHROME=/CriOS/i.test(t.USER_AGENT),t.IOS_CHROME_VERSION=t.IS_IOS_CHROME&&function(){const e=t.USER_AGENT.match(/CriOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_CHROME_MAJOR_VERSION=t.IS_IOS_CHROME&&function(){const e=t.USER_AGENT.match(/CriOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_EDGE=/EdgiOS/i.test(t.USER_AGENT),t.IOS_EDGE_VERSION=t.IS_IOS_EDGE&&function(){const e=t.USER_AGENT.match(/EdgiOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_EDGE_MAJOR_VERSION=t.IS_IOS_EDGE&&function(){const e=t.USER_AGENT.match(/EdgiOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_FIREFOX=/FxiOS/i.test(t.USER_AGENT),t.IOS_FIREFOX_VERSION=t.IS_IOS_FIREFOX&&function(){const e=t.USER_AGENT.match(/FxiOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_FIREFOX_MAJOR_VERSION=t.IS_IOS_FIREFOX&&function(){const e=t.USER_AGENT.match(/FxiOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SAFARI=!t.IS_CHROME_ONLY&&!t.IS_MQQB&&!t.IS_X5MQQB&&!t.IS_MACQQB&&!t.IS_IPADQQB&&/Safari/i.test(t.USER_AGENT),t.IS_ANY_SAFARI=t.IS_SAFARI||t.IS_IOS,t.SAFARI_MAJOR_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.SAFARI_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MAC_SAFARI=t.IS_SAFARI&&t.IS_MAC,t.IS_IOS_SAFARI=t.IS_SAFARI&&t.IS_IOS,t.IS_LOCAL="file:"===window.location.protocol||"localhost"===window.location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname),t.IS_ZH=/zh/i.test(t.USER_LANGUAGE),t.IS_EN=/en/i.test(t.USER_LANGUAGE);},function(e,t,i){var r,s,a=e.exports=i(58),o=i(180);a.codegen=i(262),a.fetch=i(263),a.path=i(264),a.fs=a.inquire("fs"),a.toArray=function(e){if(e){for(var t=Object.keys(e),i=new Array(t.length),r=0;r<t.length;)i[r]=e[t[r++]];return i}return []},a.toObject=function(e){for(var t={},i=0;i<e.length;){var r=e[i++],s=e[i++];void 0!==s&&(t[r]=s);}return t};var n=/\\/g,d=/"/g;a.isReserved=function(e){return /^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},a.safeProp=function(e){return !/^[$\w_]+$/.test(e)||a.isReserved(e)?'["'+e.replace(n,"\\\\").replace(d,'\\"')+'"]':"."+e},a.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var c=/_([a-z])/g;a.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(c,(function(e,t){return t.toUpperCase()}))},a.compareFieldsById=function(e,t){return e.id-t.id},a.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(a.decorateRoot.remove(e.$type),e.$type.name=t,a.decorateRoot.add(e.$type)),e.$type;r||(r=i(182));var s=new r(t||e.name);return a.decorateRoot.add(s),s.ctor=e,Object.defineProperty(e,"$type",{value:s,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:s,enumerable:!1}),s};var l=0;a.decorateEnum=function(e){if(e.$type)return e.$type;s||(s=i(59));var t=new s("Enum"+l++,e);return a.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},a.setProperty=function(e,t,i){if("object"!=typeof e)throw TypeError("dst must be an object");if(!t)throw TypeError("path must be specified");return function e(t,i,r){var s=i.shift();if(i.length>0)t[s]=e(t[s]||{},i,r);else {var a=t[s];a&&(r=[].concat(a).concat(r)),t[s]=r;}return t}(e,t=t.split("."),i)},Object.defineProperty(a,"decorateRoot",{get:function(){return o.decorated||(o.decorated=new(i(190)))}});},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)};},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e};},function(e,t,i){var r=i(7),s=i(0).document,a=r(s)&&r(s.createElement);e.exports=function(e){return a?s.createElement(e):{}};},function(e,t,i){var r=i(7);e.exports=function(e,t){if(!r(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!r(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")};},function(e,t,i){var r=i(44),s=i(33);e.exports=Object.keys||function(e){return r(e,s)};},function(e,t,i){var r=i(32)("keys"),s=i(22);e.exports=function(e){return r[e]||(r[e]=s(e))};},function(e,t,i){var r=i(2),s=i(0),a=s["__core-js_shared__"]||(s["__core-js_shared__"]={});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:i(14)?"pure":"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"});},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",");},function(e,t,i){var r=i(19);function s(e){var t,i;this.promise=new e((function(e,r){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=r;})),this.resolve=r(t),this.reject=r(i);}e.exports.f=function(e){return new s(e)};},function(e,t,i){t.f=i(1);},function(e,t,i){var r=i(0),s=i(2),a=i(14),o=i(35),n=i(6).f;e.exports=function(e){var t=s.Symbol||(s.Symbol=a?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||n(t,e,{value:o.f(e)});};},function(e,t){t.f={}.propertyIsEnumerable;},function(e,t){},function(e,t,i){var r=i(79)(!0);i(40)(String,"String",(function(e){this._t=String(e),this._i=0;}),(function(){var e,t=this._t,i=this._i;return i>=t.length?{value:void 0,done:!0}:(e=r(t,i),this._i+=e.length,{value:e,done:!1})}));},function(e,t,i){var r=i(14),s=i(15),a=i(42),o=i(5),n=i(16),d=i(80),c=i(23),l=i(85),u=i(1)("iterator"),h=!([].keys&&"next"in[].keys()),p=function(){return this};e.exports=function(e,t,i,m,f,g,v){d(i,t,m);var y,S,_,R=function(e){if(!h&&e in A)return A[e];switch(e){case"keys":case"values":return function(){return new i(this,e)}}return function(){return new i(this,e)}},b=t+" Iterator",T="values"==f,E=!1,A=e.prototype,w=A[u]||A["@@iterator"]||f&&A[f],I=w||R(f),C=f?T?R("entries"):I:void 0,O="Array"==t&&A.entries||w;if(O&&(_=l(O.call(new e)))!==Object.prototype&&_.next&&(c(_,b,!0),r||"function"==typeof _[u]||o(_,u,p)),T&&w&&"values"!==w.name&&(E=!0,I=function(){return w.call(this)}),r&&!v||!h&&!E&&A[u]||o(A,u,I),n[t]=I,n[b]=p,f)if(y={values:T?I:R("values"),keys:g?I:R("keys"),entries:C},v)for(S in y)S in A||a(A,S,y[S]);else s(s.P+s.F*(h||E),t,y);return y};},function(e,t,i){e.exports=!i(8)&&!i(20)((function(){return 7!=Object.defineProperty(i(28)("div"),"a",{get:function(){return 7}}).a}));},function(e,t,i){e.exports=i(5);},function(e,t,i){var r=i(3),s=i(81),a=i(33),o=i(31)("IE_PROTO"),n=function(){},d=function(){var e,t=i(28)("iframe"),r=a.length;for(t.style.display="none",i(46).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),d=e.F;r--;)delete d.prototype[a[r]];return d()};e.exports=Object.create||function(e,t){var i;return null!==e?(n.prototype=r(e),i=new n,n.prototype=null,i[o]=e):i=d(),void 0===t?i:s(i,t)};},function(e,t,i){var r=i(9),s=i(11),a=i(83)(!1),o=i(31)("IE_PROTO");e.exports=function(e,t){var i,n=s(e),d=0,c=[];for(i in n)i!=o&&r(n,i)&&c.push(i);for(;t.length>d;)r(n,i=t[d++])&&(~a(c,i)||c.push(i));return c};},function(e,t,i){var r=i(26),s=Math.min;e.exports=function(e){return e>0?s(r(e),9007199254740991):0};},function(e,t,i){var r=i(0).document;e.exports=r&&r.documentElement;},function(e,t,i){var r=i(27);e.exports=function(e){return Object(r(e))};},function(e,t,i){i(86);for(var r=i(0),s=i(5),a=i(16),o=i(1)("toStringTag"),n="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),d=0;d<n.length;d++){var c=n[d],l=r[c],u=l&&l.prototype;u&&!u[o]&&s(u,o,c),a[c]=a.Array;}},function(e,t,i){var r=i(17),s=i(1)("toStringTag"),a="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,i,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),s))?i:a?r(t):"Object"==(o=r(t))&&"function"==typeof t.callee?"Arguments":o};},function(e,t,i){var r=i(3),s=i(19),a=i(1)("species");e.exports=function(e,t){var i,o=r(e).constructor;return void 0===o||null==(i=r(o)[a])?t:s(i)};},function(e,t,i){var r,s,a,o=i(18),n=i(95),d=i(46),c=i(28),l=i(0),u=l.process,h=l.setImmediate,p=l.clearImmediate,m=l.MessageChannel,f=l.Dispatch,g=0,v={},y=function(){var e=+this;if(v.hasOwnProperty(e)){var t=v[e];delete v[e],t();}},S=function(e){y.call(e.data);};h&&p||(h=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return v[++g]=function(){n("function"==typeof e?e:Function(e),t);},r(g),g},p=function(e){delete v[e];},"process"==i(17)(u)?r=function(e){u.nextTick(o(y,e,1));}:f&&f.now?r=function(e){f.now(o(y,e,1));}:m?(a=(s=new m).port2,s.port1.onmessage=S,r=o(a.postMessage,a,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*");},l.addEventListener("message",S,!1)):r="onreadystatechange"in c("script")?function(e){d.appendChild(c("script")).onreadystatechange=function(){d.removeChild(this),y.call(e);};}:function(e){setTimeout(o(y,e,1),0);}),e.exports={set:h,clear:p};},function(e,t){e.exports=function(e){try{return {e:!1,v:e()}}catch(e){return {e:!0,v:e}}};},function(e,t,i){var r=i(3),s=i(7),a=i(34);e.exports=function(e,t){if(r(e),s(t)&&t.constructor===e)return t;var i=a.f(e);return (0, i.resolve)(t),i.promise};},function(e,t){t.f=Object.getOwnPropertySymbols;},function(e,t,i){var r=i(44),s=i(33).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,s)};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;const r=i(70),s=i(57),a=i(69),o=i(4),n="mediasoup-client";let d=window;t.Logger={debug(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("DEBUG",t,i),o.getParameters().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t);},warn(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("WARN",t,i),o.getParameters().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t);},error(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("ERROR",t,i),o.getParameters().logLevel<=r.loglevels.ERROR&&console.error.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t);},formatArgs(e,t,i){let r=new Date,o=this.formatTimeUnit(""+(r.getMonth()+1))+"-"+this.formatTimeUnit(""+r.getDate())+" "+this.formatTimeUnit(""+r.getHours())+":"+this.formatTimeUnit(""+r.getMinutes())+":"+this.formatTimeUnit(""+r.getSeconds())+":"+this.formatTimeUnit(""+r.getMilliseconds(),3),n=`[NERTC:${e}:${a.updateLogIndex()} ${o} ${i.toUpperCase()}]  `;for(let e=t.length-1;e>=0;e--)t[e]=s.formatSingleArg(t[e]);return t.unshift(n),t},formatTimeUnit(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i}};},function(e,t,i){function r(e,t=1,i=1){return e<=1?i:r(e-1,i,t+i)}Object.defineProperty(t,"__esModule",{value:!0}),t.getDomInfo=t.makePrintable=t.formatSingleArg=t.deepCopy=t.randomString=t.randomId=t.generateUUID=t.getReconnectionTimeout=t.fibonacci=void 0,t.fibonacci=r,t.getReconnectionTimeout=function(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*r(t)};t.generateUUID=function(){return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return ("x"==e?t:3&t|8).toString(16)}))};t.randomId=function(){return "xxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return ("x"==e?t:3&t|8).toString(16)}))};function s(e){if(window.RTCRtpSender&&e instanceof RTCRtpSender){return `[RTCRtpSender track: ${s(e.track)}]`}if(e instanceof MediaStreamTrack){const t=e;return `[MediaStreamTrack kind:${t.kind} label:${t.label} readyState:${t.readyState} id: ${t.id} enabled:${t.enabled} muted: ${t.muted}]`}if(e instanceof HTMLElement){const t=e;return `[${t.tagName}.${t.className} ${t.clientWidth}x${t.clientHeight}]`}if(e instanceof MediaStream){const t=e;return `[MediaStream active:${t.active} a:${t.getAudioTracks().length} v:${t.getVideoTracks().length}]`}return e}t.randomString=(e,t)=>{if(!e||!t)return "";let i="";for(var r=t;r>0;--r)i+=e[Math.floor(Math.random()*e.length)];return i},t.deepCopy=function e(t){var i=Array.isArray(t)?[]:{};for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&null!==t[r]?i[r]=e(t[r]):i[r]=t[r]);return i},t.formatSingleArg=s,t.makePrintable=function e(t,i,r=[]){if("object"!=typeof t||!(null==t?void 0:t.hasOwnProperty))return t;var a=Array.isArray(t)?[]:{};for(var o in t)if(t.hasOwnProperty(o)){const n=s(t[o]);n&&("client"===o&&n.adapterRef||["adapterRef","sdkRef","logger","_events"].indexOf(o)>-1||(n&&"object"==typeof n?r.indexOf(n)>-1?a[o]="[Circular obj]":(r.push(a[o]),i>=1?a[o]=e(n,i-1,r):(null==n?void 0:n.toString)?a[o]=n.toString():a[o]=typeof n):a[o]=n));}return a},t.getDomInfo=function(e){if(!e)return ""+e;let t=e.tagName;return e.id&&(t+="#"+e.id),e.className&&(t+="."+e.className),(e.offsetWidth||e.offsetHeight)&&(t+=` ${e.offsetWidth}x${e.offsetHeight}`),t};},function(e,t,i){(function(e){var r=t;function s(e,t,i){for(var r=Object.keys(t),s=0;s<r.length;++s)void 0!==e[r[s]]&&i||(e[r[s]]=t[r[s]]);return e}function a(e){function t(e,i){if(!(this instanceof t))return new t(e,i);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&s(this,i);}return (t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}r.asPromise=i(177),r.base64=i(253),r.EventEmitter=i(254),r.float=i(255),r.inquire=i(178),r.utf8=i(256),r.pool=i(257),r.LongBits=i(258),r.isNode=Boolean(void 0!==e&&e&&e.process&&e.process.versions&&e.process.versions.node),r.global=r.isNode&&e||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(e){return "number"==typeof e&&isFinite(e)&&Math.floor(e)===e},r.isString=function(e){return "string"==typeof e||e instanceof String},r.isObject=function(e){return e&&"object"==typeof e},r.isset=r.isSet=function(e,t){var i=e[t];return !(null==i||!e.hasOwnProperty(t))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},r.Buffer=function(){try{var e=r.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(e){return "number"==typeof e?r.Buffer?r._Buffer_allocUnsafe(e):new r.Array(e):r.Buffer?r._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(e){return e?r.LongBits.from(e).toHash():r.LongBits.zeroHash},r.longFromHash=function(e,t){var i=r.LongBits.fromHash(e);return r.Long?r.Long.fromBits(i.lo,i.hi,t):i.toNumber(Boolean(t))},r.merge=s,r.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},r.newError=a,r.ProtocolError=a("ProtocolError"),r.oneOfGetter=function(e){for(var t={},i=0;i<e.length;++i)t[e[i]]=1;return function(){for(var e=Object.keys(this),i=e.length-1;i>-1;--i)if(1===t[e[i]]&&void 0!==this[e[i]]&&null!==this[e[i]])return e[i]}},r.oneOfSetter=function(e){return function(t){for(var i=0;i<e.length;++i)e[i]!==t&&delete this[e[i]];}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var e=r.Buffer;e?(r._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,i){return new e(t,i)},r._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):r._Buffer_from=r._Buffer_allocUnsafe=null;};}).call(this,i(67));},function(e,t,i){e.exports=o;var r=i(120);((o.prototype=Object.create(r.prototype)).constructor=o).className="Enum";var s=i(129),a=i(25);function o(e,t,i,s,a){if(r.call(this,e,i),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=s,this.comments=a||{},this.reserved=void 0,t)for(var o=Object.keys(t),n=0;n<o.length;++n)"number"==typeof t[o[n]]&&(this.valuesById[this.values[o[n]]=t[o[n]]]=o[n]);}o.fromJSON=function(e,t){var i=new o(e,t.values,t.options,t.comment,t.comments);return i.reserved=t.reserved,i},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},o.prototype.add=function(e,t,i){if(!a.isString(e))throw TypeError("name must be a string");if(!a.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t;}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=i||null,this},o.prototype.remove=function(e){if(!a.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},o.prototype.isReservedId=function(e){return s.isReservedId(this.reserved,e)},o.prototype.isReservedName=function(e){return s.isReservedName(this.reserved,e)};},function(e,t,i){e.exports=i(75);},function(e,t,i){t.__esModule=!0;var r,s=i(77),a=(r=s)&&r.__esModule?r:{default:r};t.default=function(e){return function(){var t=e.apply(this,arguments);return new a.default((function(e,i){return function r(s,o){try{var n=t[s](o),d=n.value;}catch(e){return void i(e)}if(!n.done)return a.default.resolve(d).then((function(e){r("next",e);}),(function(e){r("throw",e);}));e(d);}("next")}))}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SDK_VERSION=t.roomsTaskUrl=t.lbsUrl=t.LBS_BUILD_CONFIG=t.getCloudProxyInfoUrl=t.getChannelInfoUrl=t.ENV=t.ENGINE_VERSION=t.createChannelUrl=t.checkSumUrl=t.BUILD=void 0;t.SDK_VERSION="4.6.50";t.ENGINE_VERSION="4.6.50.0";t.BUILD="v4.6.50-0-gaba0865d";const r=i(207);Object.defineProperty(t,"ENV",{enumerable:!0,get:function(){return r.ENV}}),Object.defineProperty(t,"LBS_BUILD_CONFIG",{enumerable:!0,get:function(){return r.LBS_BUILD_CONFIG}});const s=r.Config.checkSumUrl;t.checkSumUrl=s;const a=r.Config.createChannelUrl;t.createChannelUrl=a;const o=r.Config.getChannelInfoUrl;t.getChannelInfoUrl=o;const n=r.Config.roomsTaskUrl;t.roomsTaskUrl=n;const d=r.Config.getCloudProxyInfoUrl;t.getCloudProxyInfoUrl=d;const c=r.Config.lbsUrl;t.lbsUrl=c;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebAudio=t.getAudioLevelDestination=t.getAudioContext=t.tryResumeAudioContext=void 0;const s=i(10),a=i(163),o=r(i(12)),n=r(i(13)),d=i(164),c=i(4),l=d.RtcSupport.checkWebAudio();let u;class h{constructor(e){this.id=e.id,this.label=e.label,this.audioNode=e.audioNode,this.gainNode=e.context.createGain(),this.type=e.type,this.audioNode.connect(this.gainNode);}connect(e){this.gainNode.connect(e);}disconnect(){try{this.audioNode.disconnect(this.gainNode);}catch(e){}this.gainNode.disconnect();}}function p(){return u?"suspended"===u.state&&(u.resume().catch(e=>{}),!0):null}function m(){return u?(p(),u):c.getParameters().disableWebAudio?null:l.WebAudio&&l.MediaStream?(u=new window.AudioContext,u):null}t.tryResumeAudioContext=p,t.getAudioContext=m;let f=null;t.getAudioLevelDestination=function(){if(!f){const e=m();e&&(f=e.createMediaStreamDestination());}return f};class g extends s.EventEmitter{constructor(e){super();const{logger:t,isAnalyze:i=!1,isRemote:r=!1}=e;this.support=l.WebAudio&&l.MediaStream,this.gain=1,this.logger=t,this.audioInArr=[],this.isAnalyze=i,this.isRemote=r||!1,this.instant=0,this.slow=0,this.clip=0,this.mediaHelper=e.mediaHelper,this.mixAudioConf={state:a.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.context=m(),this.context?(this.destination=this.createDestination(),this.musicDestination=this.createDestination(),this.analyzeDestination=this.createDestination()):(this.destination=null,this.musicDestination=null,this.analyzeDestination=null),this.support&&(this.resetMixConf(),this.init());}createDestination(){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"===e.name)return this.context.createMediaStreamDestination();throw e}}createSource(e){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioSourceNode(this.context,e)}catch(t){if("TypeError"===t.name)return this.context.createMediaStreamSource(e.mediaStream);throw t}}init(){this.isAnalyze&&this.initMonitor(),this.initWebAudio(),this.initAudioIn();}initMonitor(){var e=this;this.context?(this.script=this.context.createScriptProcessor(0,1,1)).onaudioprocess=function(t){var i,r=t.inputBuffer.getChannelData(0),s=0,a=0;for(i=0;i<r.length;++i)s+=Math.abs(r[i]),Math.abs(r[i])>.99&&(a+=1);e.instant=Math.sqrt(s/r.length),e.slow=.95*e.slow+.05*e.instant,e.clip=a/r.length;let o=t.inputBuffer,n=t.outputBuffer;n.copyToChannel&&n.copyToChannel(o.getChannelData(0),0,0);}:e.logger.error("initMonitor:参数不够");}initWebAudio(){this.context&&this.destination?(this.gainFilter=this.context.createGain(),this.gainFilter.gain.value=this.gain):this.logger.error("initMonitor:参数不够");}initAudioIn(){var e,t,i;const r=this;if(!r.context||!r.gainFilter||!r.destination)return this.logger.error("initAudioIn:参数不够"),null;let s=(null===(t=null===(e=this.mediaHelper.audio.stageAIProcessing)||void 0===e?void 0:e.node)||void 0===t?void 0:t.audioNode)||null,o=null===(i=this.mediaHelper.audio.stageAIProcessing)||void 0===i?void 0:i.enabled;if(s)if(o)s.connect(r.gainFilter);else try{s.disconnect(r.gainFilter);}catch(e){}for(var n=0;n<r.audioInArr.length;n++){const e=r.audioInArr[n];if(s)if(o){try{e.gainNode.disconnect(r.gainFilter);}catch(e){}e.connect(s);}else {try{e.gainNode.disconnect(s);}catch(e){}e.connect(r.gainFilter);}else "MIX_PLAYING"===this.mixAudioConf.state&&this.mixAudioConf.replace?this.logger.log("当前正在以Replace模式播放伴音，暂不接入"):e.connect(r.gainFilter);}r.mixAudioConf.state===a.AuidoMixingState.UNSTART&&(r.script&&r.analyzeDestination&&(r.gainFilter.connect(r.script),r.script.connect(r.analyzeDestination)),r.gainFilter.connect(r.destination)),this.logger.log("WebAudio: initAudioIn: 初始化音频 state: ",r.context.state),"running"!==r.context.state&&r.context.resume().then(()=>{this.context&&this.logger.log("WebAudio: addMs: 状态变更成功 state: ",this.context.state);}).catch(e=>{this.logger.log("WebAudio: addMs: 状态变更出错: ",e.name,e.message,e),this.context&&this.context.resume();});}updateTracks(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];e.find(e=>e.track&&i&&e.track.id===i.id)||(this.logger.log("updateTracks，删除",i.label,i.id),this.audioInArr.splice(t,1),i.disconnect());}for(let t=e.length-1;t>=0;t--){const i=e[t];if(!this.audioInArr.find(e=>i.track&&i.track.id===e.id)&&i.track)if(this.context){const e=new MediaStream;e.addTrack(i.track);const t={context:this.context,id:i.track.id,label:i.track.label,audioNode:this.createSource({mediaStream:e}),type:i.type},r=new h(t);r.gainNode.gain.value=this.gain,this.audioInArr.push(r);}else this.logger.error("updateTracks：没有audioContext");}this.initAudioIn();}removeTrack(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];i.id===e.id&&(this.logger.log("removeTrack，删除track",e.id,e.label),this.audioInArr.splice(t,1),i.disconnect());}}setGain(e,t){for(let i=0;i<this.audioInArr.length;i++){const r=this.audioInArr[i];t&&t!==r.type||(this.logger.log("WebAudio.setGain",t,e,r.type,r.label,r.id),r.gainNode.gain.value=e);}t||(this.gain=e);}getGain(){if(this.gainFilter)return this.gain}getGainMin(){let e=1;for(let t=0;t<this.audioInArr.length;t++){const i=this.audioInArr[t];i.gainNode.gain.value<e&&(e=i.gainNode.gain.value);}return e}stop(){this.gainFilter&&(this.script?this.script.disconnect(0):this.gainFilter.disconnect(0),this.instant=0);}start(){this.gainFilter&&this.destination&&(this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination));}resetMixConf(){var e,t;if(null===(e=this.mixAudioConf.audioSource)||void 0===e||e.disconnect(0),null===(t=this.mixAudioConf.gainFilter)||void 0===t||t.disconnect(0),this.mixAudioConf.replace&&(this.logger.log("伴音停止了，恢复mic"),this.gainFilter&&this.destination)){for(var i=0;i<this.audioInArr.length;i++){this.audioInArr[i].gainNode.connect(this.gainFilter);}this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination);}this.mixAudioConf={state:a.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.gainFilter&&1===this.gainFilter.gain.value&&this.emit("audioFilePlaybackCompleted");}startMix(e){if(!this.context||!this.destination||!this.gainFilter)return this.logger.error("startMix: 不支持伴音"),Promise.reject(new n.default({code:o.default.AUDIO_MIX_NO_SUPPORT,message:"startMix:不支持伴音"}));if(this.logger.log("开始混音: ",JSON.stringify(e)),this.mixAudioConf.audioSource=this.context.createBufferSource(),this.mixAudioConf.gainFilter=this.context.createGain(),this.mixAudioConf.audioSource.buffer=e.buffer,this.mixAudioConf.replace=e.replace,this.mixAudioConf.cycle=e.cycle,this.mixAudioConf.playStartTime=e.playStartTime,this.mixAudioConf.volume=e.volume?e.volume/255:1,this.mixAudioConf.auidoMixingEnd=e.auidoMixingEnd,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.gainFilter.connect(this.gainFilter),this.musicDestination&&this.mixAudioConf.gainFilter.connect(this.musicDestination),e.replace)for(var t=0;t<this.audioInArr.length;t++){const e=this.audioInArr[t];try{e.gainNode.disconnect(this.gainFilter),this.logger.log(`已断开音频：【${e.label}】`);}catch(t){"InvalidAccessError"===t.name?this.logger.log(`音频断开前未连接：【${e.label}】`):this.logger.error(`无法断开音频:【${e.label}】${t.name}`,t.message);}}if(this.mixAudioConf.audioSource.onended=e=>{this.audioEnd(e);},this.mixAudioConf.totalTime=e.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.gain.value=this.mixAudioConf.volume,e.loopback&&e.cycle>1){this.mixAudioConf.audioSource.loop=e.loopback;const t=e.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",t),this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime,t-1);}else e.loopback&&1==e.cycle?(this.mixAudioConf.audioSource.loop=!1,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",e.loopback),this.mixAudioConf.audioSource.loop=e.loopback,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state=a.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now(),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter)return void this.logger.error("pauseAudioMixing: 缺失audioSource/gainFilter");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state=a.AuidoMixingState.PAUSED;let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(e){return this.logger.log("恢复混音"),this.mixAudioConf.pauseTime=0,e.volume=255*this.mixAudioConf.volume,this.startMix(e)}stopAudioMixing(e=!0){return this.mixAudioConf.audioSource&&this.mixAudioConf.gainFilter?(this.logger.log("开始停止混音, isFinished: ",e),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.state=a.AuidoMixingState.STOPED,e&&this.resetMixConf(),this.logger.log("混音已停止"),Promise.resolve()):Promise.reject(new n.default({code:o.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"}))}audioEnd(e){if(this.mixAudioConf.state===a.AuidoMixingState.PLAYED){if(!(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.loop&&this.mixAudioConf.cycle<=0))return this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),Promise.resolve();this.logger.log("无限循环时, 伴音播放完成event: ",e);}else this.logger.error("audioEnd:参数不够");}setAudioMixingVolume(e){if(this.mixAudioConf.gainFilter)return this.mixAudioConf.gainFilter.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.gain.value,Promise.resolve();this.logger.error("setAudioMixingVolume: 参数缺失gainFilter");}setAudioMixingPlayTime(e){return this.mixAudioConf.state===a.AuidoMixingState.PLAYED&&(this.mixAudioConf.setPlayStartTime=e.playStartTime),e.volume=255*this.mixAudioConf.volume,this.startMix(e)}getAudioMixingPlayedTime(){let e=Date.now();this.mixAudioConf.state==a.AuidoMixingState.PAUSED&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return {totalTime:this.mixAudioConf.totalTime}}createAudioBufferSource(e){if(!this.context||!this.destination||!this.gainFilter)throw new n.default({code:o.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_createAudioBufferSource: 接口调用状态异常"});const t=this.context.createBufferSource();t.buffer=e;const i=this.context.createGain();t.connect(i);return {sourceNode:t,gainNode:i}}startAudioEffectMix(e){if(!this.context||!this.destination||!this.gainFilter)return Promise.reject(new n.default({code:o.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:d,cycle:c}=e;i&&t&&(this.logger.log("startAudioEffectMix: ",JSON.stringify(e)),i.connect(this.gainFilter),this.musicDestination&&i.connect(this.musicDestination),i.gain.value=d/100,c>1?(t.loop=!0,t.start(0,s,r)):(t.loop=!1,t.start(0,s)),this.mixAudioConf.state=a.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now());}stopAudioEffectMix(e){const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:a,cycle:d}=e;if(!i||!t)return Promise.reject(new n.default({code:o.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));this.logger.log("stopAudioEffectMix: ",JSON.stringify(e)),t.onended=null,t.disconnect(0),i.disconnect(0),t.stop();}destroy(){this.logger.log("AudioContext 清除"),this.instant=0,this.slow=0,this.clip=0,this.gainFilter&&this.gainFilter.disconnect(0),this.script&&this.script.disconnect(0);for(let e=0;e<this.audioInArr.length;e++)this.audioInArr[e]&&this.audioInArr[e].disconnect();this.audioInArr=[];}getVolumeData(){return this.instant.toFixed(2)}}t.WebAudio=g;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformType=t.PlatformTypeMap=t.MediaTypeList=t.MediaTypeListVideo=t.MediaTypeListAudio=void 0,t.MediaTypeListAudio=["audio","audioSlave"],t.MediaTypeListVideo=["video","screen"],t.MediaTypeList=["audio","video","screen","audioSlave"],t.PlatformTypeMap={"-1":"unknown",1:"aos",2:"ios",4:"pc",8:"winphone",9:"mac",16:"web"},function(e){e[e.unknown=-1]="unknown",e[e.aos=1]="aos",e[e.ios=2]="ios",e[e.pc=4]="pc",e[e.winphone=8]="winphone",e[e.mac=9]="mac",e[e.web=16]="web";}(t.PlatformType||(t.PlatformType={}));},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isNumber=t.isExistOptions=t.checkValidObject=t.checkValidString=t.checkValidInteger=t.checkValidFloat=t.checkValidBoolean=t.checkExists=t.isValidInteger=void 0;const n=o(i(12)),d=o(i(13)),c=a(i(24)),l=e=>Number.isInteger(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值 "+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值 "+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是整数",enMsg:"Parameter is not Number"};t.isValidInteger=l;t.checkValidInteger=e=>{const t=l(e);if(!t.result){let i=c.IS_ZH?`checkValidInteger: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidInteger: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidBoolean=e=>{const t=(e=>"boolean"!=typeof e.value?{result:!1,enMsg:"The parameter is not Boolean",zhMsg:"参数不是布尔类型"}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidBoolean: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidBoolean: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidString=e=>{const t=(e=>"string"!=typeof e.value?{result:!1,zhMsg:"参数不是字符串",enMsg:"The parameter is not String"}:"number"==typeof e.min&&e.value.length<e.min?{result:!1,zhMsg:"参数长度最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value.length>e.max?{result:!1,zhMsg:"参数长度大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidString: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidString: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidObject=e=>{const t=(e=>"object"!=typeof e.value?{result:!1,zhMsg:"参数不是对象",enMsg:"The parameter is not Object"}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidObject: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidObject: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidFloat=e=>{const t=(e=>Number.isFinite(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是float类型",enMsg:"The parameter is not float"})(e);if(!t.result){let i=c.IS_ZH?`checkValidFloat: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidFloat: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};const u=e=>void 0===e.value||null===e.value?{result:!1,zhMsg:"未填必选参数",enMsg:"Missing required parameters"}:{result:!0};t.isExistOptions=u;t.checkExists=e=>{const t=u(e);if(!t.result){let i=c.IS_ZH?`checkExists: 参数错误: ${e.tag}:${t.zhMsg}`:`checkExists: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.isNumber=e=>!isNaN(parseFloat(e))&&"number"==typeof e;},function(e,t){var i,r,s=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function n(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a;}catch(e){i=a;}try{r="function"==typeof clearTimeout?clearTimeout:o;}catch(e){r=o;}}();var d,c=[],l=!1,u=-1;function h(){l&&d&&(l=!1,d.length?c=d.concat(c):u=-1,c.length&&p());}function p(){if(!l){var e=n(h);l=!0;for(var t=c.length;t;){for(d=c,c=[];++u<t;)d&&d[u].run();u=-1,t=c.length;}d=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e);}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e);}}function m(e,t){this.fun=e,this.array=t;}function f(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new m(e,t)),1!==c.length||l||n(p);},m.prototype.run=function(){this.fun.apply(null,this.array);},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=f,s.addListener=f,s.once=f,s.off=f,s.removeListener=f,s.removeAllListeners=f,s.emit=f,s.prependListener=f,s.prependOnceListener=f,s.listeners=function(e){return []},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return "/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0};},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")();}catch(e){"object"==typeof window&&(i=window);}e.exports=i;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCEventEmitter=void 0;const r=i(10);class s extends r.EventEmitter{constructor(){super(),this._events||(this._events={});}safeEmit(e,...t){try{e.match(/^@/)||this.emit("@"+e,...t),this.emit(e,...t);}catch(t){(this.logger||console).error(`Error on event ${e}: ${t.name} ${t.message}`,t.stack);}}}t.RTCEventEmitter=s;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultLogger=t.Logger=t.updateLogIndex=void 0;const r=i(4),s=i(70),a=i(208),o=i(118),n=i(57),d=i(62);let c=0,l=[];function u(){return c++,(""+c).padStart(4,"0")}t.updateLogIndex=u;class h{constructor(e){this.style="color:#1cb977;",this.options=e,this.api="log",this.tagGen=e.tagGen,e.isSavedLogs&&(this.logHelper=new a.logHelper(e)),this.supportedBrowsers=["Chrome","Safari","Firefox","Chrome Mobile","Electron"],this.cs=console;}getChild(e){const t=Object.assign({},this.options),i=new h(t);return i.tagGen=e,i.parent=this,i}debug(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("DEBUG",[].slice.call(arguments,0));r.getParameters().logLevel<=s.loglevels.DEBUG&&this._log("debug",e),f(e);}log(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("LOG",[].slice.call(arguments,0));if(-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]){e[0]="%c"+e[0],e.splice(1,0,this.style);for(let t=2;t<e.length&&"string"==typeof e[t];t++)e[0]+="%c"+e[t],e[t]="";}r.getParameters().logLevel<=s.loglevels.INFO&&this._log("log",e),f(e);}info(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("INFO",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.INFO&&this._log("info",e),f(e);}warn(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("WARN",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.WARNING&&this._log("warn",e),f(e);}error(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("ERROR",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.ERROR&&this._log("error",e),f(e);}_log(e,t){let i=this.options.logFunc,r=null;if(i&&(i[e]&&(r=i[e]),"function"==typeof r))r.apply(i,t);else if(this.cs[e])try{this.cs[e].apply?this.chrome(e,t):this.ie(e,t);}catch(e){}}chrome(e,t){o.getBrowserInfo().browserName;this.cs[e]?this.cs[e].apply(this.cs,t):this.cs.log?this.cs.log.apply(this.cs,t):this.ie(e,t);}ie(e,t){var i=this;t.forEach((function(t){i.cs[e](JSON.stringify(t,null,4));}));}formatArgs(e,t){var i=new Date,r=m(""+(i.getMonth()+1))+"-"+m(""+i.getDate())+" "+m(""+i.getHours())+":"+m(""+i.getMinutes())+":"+m(""+i.getSeconds())+":"+m(""+i.getMilliseconds(),3);let s=this,a="";for(let e=0;e<3&&(s.tagGen&&(a=`[${s.tagGen()}]`+a),s.parent);e++)s=s.parent;return a=`[NERTC:${e}:${u()} ${r}]${a}`,t.splice(0,0,a),t.forEach((function(e,i){e=n.formatSingleArg(e),t[i]="object"==typeof e?function e(t,i=[]){if(!(t=n.formatSingleArg(t))||"object"!=typeof t)return t;let r={};for(let s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||(t[s]&&"object"==typeof t[s]?-1!==i.indexOf(t[s])?r[s]="[Circular obj]":(i.push(t[s]),r[s]=e(t[s],i)):r[s]=t[s]);return r}(e):e;})),t}}t.Logger=h;let p=null;t.getDefaultLogger=function(){return p||(p=new h({tagGen:()=>""+d.BUILD})),p};var m=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i};function f(e){let t=window;if(t.logUpload)if(t.wsTransport)l.length&&(l.forEach(e=>{t.wsTransport&&t.wsTransport.sendLog(e.args);}),l=[]),t.wsTransport&&t.wsTransport.sendLog(e);else {let t=Date.now();try{l.length&&l[l.length-1].args[0].replace("[NERTC","[缓存][NERTC");}catch(e){}l.push({time:t,args:e});}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.loglevelMap=t.loglevels=void 0,function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE";}(t.loglevels||(t.loglevels={})),t.loglevelMap={0:"DEBUG",1:"INFO",2:"WARNING",3:"ERROR",4:"NONE"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.reduceCodecs=t.getSupportedCodecs=t.VideoCodecList=void 0;const r=i(4),s=i(140);function a(e){const t={video:[],audio:[]};return e.match(/ H264/i)&&t.video.push("H264"),e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ opus/i)&&t.audio.push("OPUS"),t}function o(e,t,i){const s={video:[],audio:[]};if(t&&t.codecs&&t.codecs.length)for(let i=0;i<t.codecs.length;i++){const a=t.codecs[i];"video/H264"==a.mimeType&&-1===s.video.indexOf("H264")&&("recv"===e&&a.sdpFmtpLine&&a.sdpFmtpLine.indexOf("profile-level-id")>-1?r.getParameters().h264StrictHigh?a.sdpFmtpLine.indexOf("profile-level-id=64")>-1&&s.video.push("H264"):s.video.push("H264"):-1===s.video.indexOf("H264")&&s.video.push("H264")),"video/VP8"==a.mimeType&&-1===s.video.indexOf("VP8")&&s.video.push("VP8");}if(i&&i.codecs&&i.codecs.length)for(let e=0;e<i.codecs.length;e++){"audio/opus"==i.codecs[e].mimeType&&s.audio.push("OPUS");}return s}function n(e){if("undefined"!=typeof RTCRtpSender){const t=RTCRtpSender.getCapabilities("video");if(t)for(let i in t.codecs){const r=t.codecs[i];if("video/H264"===r.mimeType&&r.sdpFmtpLine&&r.sdpFmtpLine.indexOf(e)>-1)return !0}}return !1}t.VideoCodecList=["H264","VP8"],t.getSupportedCodecs=async function(e="recv",t=RTCPeerConnection){if("recv"===e){if("undefined"!=typeof RTCRtpReceiver&&RTCRtpReceiver.getCapabilities){return o(e,RTCRtpReceiver.getCapabilities("video"),RTCRtpReceiver.getCapabilities("audio"))}{const e=new t({});e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const i=await e.createOffer({});if(e.close(),!i.sdp)return !1;return a(i.sdp)}}if("undefined"!=typeof RTCRtpSender&&RTCRtpSender.getCapabilities){return o(e,RTCRtpSender.getCapabilities("video"),RTCRtpSender.getCapabilities("audio"))}{const e=new t({});let i=new s.RTCCanvas("canvas");const r=i._canvas.captureStream(0);e.addTrack(r.getVideoTracks()[0],r);const o=await e.createOffer({});if(e.close(),!o.sdp)return !1;const n=a(o.sdp);return i.destroy(),n}},t.reduceCodecs=function(e,i){const s=[];for(let a=0;a<e.length;a++){if(e[a].mimeType&&i&&t.VideoCodecList.indexOf(e[a].mimeType.split("/")[1])>-1&&e[a].mimeType!==i.mimeType){a++;continue}const o=e[a];"video/H264"===o.mimeType&&r.getParameters().h264ProfileLevel&&(o.parameters["profile-level-id"]&&n(r.getParameters().h264ProfileLevel)?(console.warn(`Changing Codec ${o.parameters["profile-level-id"]} => ${r.getParameters().h264ProfileLevel}`),o.parameters["profile-level-id"]=r.getParameters().h264ProfileLevel):console.warn("H264 Profile Level is not supported in current browser")),s.push(e[a]);}return s};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.generateRandomNumber=t.clone=void 0,t.clone=function(e,t={}){return void 0===e?t:JSON.parse(JSON.stringify(e))},t.generateRandomNumber=function(){return Math.round(1e7*Math.random())};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getStream=t.getScreenStream=t.emptyStreamWith=t.printForLongPromise=t.watchTrack=void 0;const r=i(174),s=i(147),a=i(117),o=i(4),n=i(63),d=i(241),c=i(242),l=i(69),u=new l.Logger({tagGen:()=>"GUM"});let h=0;t.getStream=async function(e,t){if(e.audio){if(!e.audio.deviceId){const i=a.Device.deviceHistory.audioIn.find(e=>"default"===e.deviceId);i&&(t.log("getStream：音频使用默认设备"+i.label),e.audio.deviceId={exact:i.deviceId});}s.compatAudioInputList.enabled&&(t.log("兼容模式：constraint强制将channelCount设为2，echoCancellation设为false"),e.audio.channelCount=2,e.audio.echoCancellation=!1);}const i=++h;t.log("getLocalStream constraint: #"+i,JSON.stringify(e));try{const a=navigator.mediaDevices.getUserMedia(e);v(a,"仍在等待 getUserMedia 返回 #"+i);const l=await a;t.log("获取到媒体流: #"+i,l.id);const u=l.getTracks();for(let e=0;e<u.length;e++){const i=u[e];if(g(i),"video"===i.kind){if(d.canShimCanvas()){t.warn("使用canvas track取代videoTrack",i.label);const e=d.shimCanvas(i);g(e),l.removeTrack(i),l.addTrack(e);}}else if("audio"===i.kind&&s.compatAudioInputList.enabled){const e=i.getSettings?i.getSettings():{};e.channelCount&&e.channelCount>=2?t.log("该设备支持兼容模式："+i.label,e):t.warn("该设备为单声道设备，强行开启兼容模式(右声道无声)："+i.label,e);const a=n.getAudioContext();if(a){const e=a.createChannelSplitter(2),n=a.createMediaStreamDestination(),d=new MediaStream([i]),u=a.createMediaStreamSource(d),h=new r.AudioLevel({stream:d,logger:t,sourceNode:u});let p=0;"left"===o.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用左声道"),p=0):"right"===o.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用右声道"),p=1):"auto"===o.getParameters().audioInputcompatMode&&(t.log("兼容模式：在左右声道间根据音量切换"),h.on("channel-state-change",r=>{"leftLoud"===r.state&&1===p?(t.log("兼容模式切换至左声道：",i.label),e.disconnect(n),e.connect(n,0),p=0):"rightLoud"===r.state&&0===p&&(t.log("兼容模式切换至右声道：",i.label),e.disconnect(n),e.connect(n,1),p=1);})),u.connect(e),e.connect(n,p);const m=n.stream.getTracks()[0];g(m),s.compatAudioInputList.compatTracks.push({source:i,dest:m}),c.syncTrackState(i,m,"bidirectional"),l.removeTrack(i),l.addTrack(m),t.log("getStream：启用兼容模式成功");}}}return l}catch(i){return t.error(`getUserMedia error: ${i.name} [${i.message}] constraint: ${JSON.stringify(e)}`),Promise.reject(i)}},t.getScreenStream=async function(e,t){var i;const r=++h;let s;t.log("getScreenStream constraint: #"+r,JSON.stringify(e,null," ")),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia;try{const t=navigator.mediaDevices.getDisplayMedia(e);v(t,"仍在等待 getDisplayMedia 返回 #"+r),s=await t;}catch(o){if(!((null===(i=null==o?void 0:o.message)||void 0===i?void 0:i.indexOf("user gesture"))>-1&&a.Device.onUserGestureNeeded))throw t.error("屏幕共享获取失败: #"+r,o.name,o.message),o;t.warn("荧幕共享获取中断，需要手势触发。",r),a.Device.onUserGestureNeeded(o);try{s=await new Promise((t,i)=>{a.Device.once("user-gesture-fired",()=>{navigator.mediaDevices.getDisplayMedia(e).then(t).catch(i);});});}catch(e){throw t.error("第二次屏幕共享获取失败: #"+r,e.name,e.message),e}}return (e=>{t.log("获取到屏幕共享流: #"+r,e.id);e.getTracks().forEach(e=>{if(g(e),"video"===e.kind&&o.getParameters().screenFocus)if(e.focus){t.log("屏幕共享不跳转到被共享页面");try{e.focus("no-focus-change");}catch(e){}}else t.log("当前浏览器不支持屏幕共享跳转控制");}),Promise.resolve(e);})(s),s};let p=Date.now();let m=0;const f=()=>{const e=o.getParameters().tracks.video,t=o.getParameters().tracks.audio,i=Date.now();if(i-p>5e3&&m<o.getParameters().maxEventLoopLagWarning){let e=`侦测到主线程事件循环从卡死中恢复。卡顿时间：${i-p-1e3}毫秒。`;e+="这可能是由于页面切往后台、设备休眠、频繁的dom操作、阻塞性代码引起的。",e+=`当前页面页面是否隐藏：${document.hidden}，可见性：${document.visibilityState}，网络状态：${navigator.onLine}。`,m+=1,m===o.getParameters().maxEventLoopLagWarning&&(e+="今后不再提示。"),u.warn(e);}p=i,e.forEach((e,t)=>{if(e&&!e.endedAt&&"ended"===e.readyState){u.log(`VIDEOTRACK#${t} 已停止：【${e.label}】`),e.endedAt=i;const r=new CustomEvent("neTrackEnded");e.dispatchEvent(r);}}),t.forEach((e,t)=>{if(e&&!e.endedAt&&"ended"===e.readyState){u.log(`AUDIOTRACK#${t} 已停止：【${e.label}】`),e.endedAt=i;const r=new CustomEvent("neTrackEnded");e.dispatchEvent(r);}});};function g(e){if(e)if("ended"===e.readyState&&u.error("注意：输入的track已经停止：",e),"audio"===e.kind){const t=o.getParameters().tracks.audio;u.log("获取到的设备类型: AUDIOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(u.warn(`注意：AUDIOTRACK#${t.length} 与 AUDIOTRACK#${i} 相同`),t.push(null)):(e.addEventListener("ended",f),t.push(e));}else {const t=o.getParameters().tracks.video;u.log("获取到的设备类型: VIDEOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(u.warn(`注意：VIDEOTRACK#${t.length} 与 VIDEOTRACK#${i} 相同`),t.push(null)):(e.addEventListener("ended",f),t.push(e));}}async function v(e,t){let i=0;const r=Date.now();let s=setInterval(()=>{i++,l.getDefaultLogger().warn(`${t} ${Date.now()-r}ms`),s&&i>10&&(clearInterval(s),s=null);},6e3);e.then(()=>{s&&(clearInterval(s),s=null);}).catch(e=>{s&&(clearInterval(s),s=null);});}setInterval(f,1e3),t.watchTrack=g,t.printForLongPromise=v,t.emptyStreamWith=function(e,t){let i=!1;e.getTracks().forEach(r=>{r!==t?(e.removeTrack(r),e.onremovetrack&&e.onremovetrack({track:r})):i=!0;}),!i&&t&&(e.addTrack(t),e.onaddtrack&&e.onaddtrack({track:t}));};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NeAudioNode=t.NeAudioNodeNullable=void 0;const r=i(68);let s=0;class a extends r.RTCEventEmitter{constructor(e,t){super(),this.id=s++,this.connectedTo=[],this.connectedFrom=[],this.tag=e,this.audioNode=t;}connect(e){this.audioNode&&e.audioNode&&this.audioNode.connect(e.audioNode),-1===this.connectedTo.indexOf(e)&&this.connectedTo.push(e),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.push(this);}disconnect(e){this.audioNode&&e.audioNode&&this.audioNode.disconnect(e.audioNode),-1!==this.connectedTo.indexOf(e)&&this.connectedTo.splice(this.connectedTo.indexOf(e),1),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.splice(e.connectedFrom.indexOf(this),1);}isConnectedTo(e){return this.connectedTo.indexOf(e)>-1}isConnectedFrom(e){return this.connectedFrom.indexOf(e)>-1}disconnectFromAll(){this.connectedFrom.forEach(e=>{e.audioNode&&this.audioNode&&e.audioNode.disconnect(this.audioNode);const t=e.connectedTo.indexOf(this);t>-1&&e.connectedTo.splice(t,1);}),this.connectedFrom.length=0;}disconnectToAll(){this.connectedTo.forEach(e=>{e.audioNode&&this.audioNode&&this.audioNode.disconnect(e.audioNode);const t=e.connectedFrom.indexOf(this);t>-1&&e.connectedFrom.splice(t,1);}),this.connectedTo.length=0;}updateNode(e){this.connectedTo.forEach(t=>{t.audioNode&&(this.audioNode&&this.audioNode.disconnect(t.audioNode),e.connect(t.audioNode));}),this.connectedFrom.forEach(t=>{t.audioNode&&(this.audioNode&&t.audioNode.disconnect(this.audioNode),t.audioNode.connect(e));}),this.audioNode=e;}}t.NeAudioNodeNullable=a;t.NeAudioNode=class extends a{constructor(e,t){super(e,t),this.tag=e,this.audioNode=t;}};},function(e,t,i){var r=function(){return this}()||Function("return this")(),s=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,a=s&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,e.exports=i(76),s)r.regeneratorRuntime=a;else try{delete r.regeneratorRuntime;}catch(e){r.regeneratorRuntime=void 0;}},function(e,t){!function(t){var i=Object.prototype,r=i.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",n=s.toStringTag||"@@toStringTag",d="object"==typeof e,c=t.regeneratorRuntime;if(c)d&&(e.exports=c);else {(c=t.regeneratorRuntime=d?e.exports:{}).wrap=f;var l={},u={};u[a]=function(){return this};var h=Object.getPrototypeOf,p=h&&h(h(w([])));p&&p!==i&&r.call(p,a)&&(u=p);var m=S.prototype=v.prototype=Object.create(u);y.prototype=m.constructor=S,S.constructor=y,S[n]=y.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return !!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,n in e||(e[n]="GeneratorFunction")),e.prototype=Object.create(m),e},c.awrap=function(e){return {__await:e}},_(R.prototype),R.prototype[o]=function(){return this},c.AsyncIterator=R,c.async=function(e,t,i,r){var s=new R(f(e,t,i,r));return c.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},_(m),m[n]="Generator",m[a]=function(){return this},m.toString=function(){return "[object Generator]"},c.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},c.values=w,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0);},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(i,r){return o.type="throw",o.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s],o=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var n=r.call(a,"catchLoc"),d=r.call(a,"finallyLoc");if(n&&d){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(n){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else {if(!d)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var a=s;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return "break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),E(i),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var s=r.arg;E(i);}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:w(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),l}};}function f(e,t,i,r){var s=t&&t.prototype instanceof v?t:v,a=Object.create(s.prototype),o=new A(r||[]);return a._invoke=function(e,t,i){var r="suspendedStart";return function(s,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===s)throw a;return I()}for(i.method=s,i.arg=a;;){var o=i.delegate;if(o){var n=b(o,i);if(n){if(n===l)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg);}else "return"===i.method&&i.abrupt("return",i.arg);r="executing";var d=g(e,t,i);if("normal"===d.type){if(r=i.done?"completed":"suspendedYield",d.arg===l)continue;return {value:d.arg,done:i.done}}"throw"===d.type&&(r="completed",i.method="throw",i.arg=d.arg);}}}(e,i,o),a}function g(e,t,i){try{return {type:"normal",arg:e.call(t,i)}}catch(e){return {type:"throw",arg:e}}}function v(){}function y(){}function S(){}function _(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)};}));}function R(e){var t;this._invoke=function(i,s){function a(){return new Promise((function(t,a){!function t(i,s,a,o){var n=g(e[i],e,s);if("throw"!==n.type){var d=n.arg,c=d.value;return c&&"object"==typeof c&&r.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,a,o);}),(function(e){t("throw",e,a,o);})):Promise.resolve(c).then((function(e){d.value=e,a(d);}),o)}o(n.arg);}(i,s,t,a);}))}return t=t?t.then(a,a):a()};}function b(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method");}return l}var r=g(i,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t);}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t;}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0);}function w(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return {next:I}}function I(){return {value:void 0,done:!0}}}(function(){return this}()||Function("return this")());},function(e,t,i){e.exports={default:i(78),__esModule:!0};},function(e,t,i){i(38),i(39),i(48),i(89),i(101),i(102),e.exports=i(2).Promise;},function(e,t,i){var r=i(26),s=i(27);e.exports=function(e){return function(t,i){var a,o,n=String(s(t)),d=r(i),c=n.length;return d<0||d>=c?e?"":void 0:(a=n.charCodeAt(d))<55296||a>56319||d+1===c||(o=n.charCodeAt(d+1))<56320||o>57343?e?n.charAt(d):a:e?n.slice(d,d+2):o-56320+(a-55296<<10)+65536}};},function(e,t,i){var r=i(43),s=i(21),a=i(23),o={};i(5)(o,i(1)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(o,{next:s(1,i)}),a(e,t+" Iterator");};},function(e,t,i){var r=i(6),s=i(3),a=i(30);e.exports=i(8)?Object.defineProperties:function(e,t){s(e);for(var i,o=a(t),n=o.length,d=0;n>d;)r.f(e,i=o[d++],t[i]);return e};},function(e,t,i){var r=i(17);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return "String"==r(e)?e.split(""):Object(e)};},function(e,t,i){var r=i(11),s=i(45),a=i(84);e.exports=function(e){return function(t,i,o){var n,d=r(t),c=s(d.length),l=a(o,c);if(e&&i!=i){for(;c>l;)if((n=d[l++])!=n)return !0}else for(;c>l;l++)if((e||l in d)&&d[l]===i)return e||l||0;return !e&&-1}};},function(e,t,i){var r=i(26),s=Math.max,a=Math.min;e.exports=function(e,t){return (e=r(e))<0?s(e+t,0):a(e,t)};},function(e,t,i){var r=i(9),s=i(47),a=i(31)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=s(e),r(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null};},function(e,t,i){var r=i(87),s=i(88),a=i(16),o=i(11);e.exports=i(40)(Array,"Array",(function(e,t){this._t=o(e),this._i=0,this._k=t;}),(function(){var e=this._t,t=this._k,i=this._i++;return !e||i>=e.length?(this._t=void 0,s(1)):s(0,"keys"==t?i:"values"==t?e[i]:[i,e[i]])}),"values"),a.Arguments=a.Array,r("keys"),r("values"),r("entries");},function(e,t){e.exports=function(){};},function(e,t){e.exports=function(e,t){return {value:t,done:!!e}};},function(e,t,i){var r,s,a,o,n=i(14),d=i(0),c=i(18),l=i(49),u=i(15),h=i(7),p=i(19),m=i(90),f=i(91),g=i(50),v=i(51).set,y=i(96)(),S=i(34),_=i(52),R=i(97),b=i(53),T=d.TypeError,E=d.process,A=E&&E.versions,w=A&&A.v8||"",I=d.Promise,C="process"==l(E),O=function(){},k=s=S.f,P=!!function(){try{var e=I.resolve(1),t=(e.constructor={})[i(1)("species")]=function(e){e(O,O);};return (C||"function"==typeof PromiseRejectionEvent)&&e.then(O)instanceof t&&0!==w.indexOf("6.6")&&-1===R.indexOf("Chrome/66")}catch(e){}}(),x=function(e){var t;return !(!h(e)||"function"!=typeof(t=e.then))&&t},M=function(e,t){if(!e._n){e._n=!0;var i=e._c;y((function(){for(var r=e._v,s=1==e._s,a=0,o=function(t){var i,a,o,n=s?t.ok:t.fail,d=t.resolve,c=t.reject,l=t.domain;try{n?(s||(2==e._h&&L(e),e._h=1),!0===n?i=r:(l&&l.enter(),i=n(r),l&&(l.exit(),o=!0)),i===t.promise?c(T("Promise-chain cycle")):(a=x(i))?a.call(i,d,c):d(i)):c(r);}catch(e){l&&!o&&l.exit(),c(e);}};i.length>a;)o(i[a++]);e._c=[],e._n=!1,t&&!e._h&&D(e);}));}},D=function(e){v.call(d,(function(){var t,i,r,s=e._v,a=N(e);if(a&&(t=_((function(){C?E.emit("unhandledRejection",s,e):(i=d.onunhandledrejection)?i({promise:e,reason:s}):(r=d.console)&&r.error&&r.error("Unhandled promise rejection",s);})),e._h=C||N(e)?2:1),e._a=void 0,a&&t.e)throw t.v}));},N=function(e){return 1!==e._h&&0===(e._a||e._c).length},L=function(e){v.call(d,(function(){var t;C?E.emit("rejectionHandled",e):(t=d.onrejectionhandled)&&t({promise:e,reason:e._v});}));},F=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),M(t,!0));},V=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw T("Promise can't be resolved itself");(t=x(e))?y((function(){var r={_w:i,_d:!1};try{t.call(e,c(V,r,1),c(F,r,1));}catch(e){F.call(r,e);}})):(i._v=e,i._s=1,M(i,!1));}catch(e){F.call({_w:i,_d:!1},e);}}};P||(I=function(e){m(this,I,"Promise","_h"),p(e),r.call(this);try{e(c(V,this,1),c(F,this,1));}catch(e){F.call(this,e);}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1;}).prototype=i(98)(I.prototype,{then:function(e,t){var i=k(g(this,I));return i.ok="function"!=typeof e||e,i.fail="function"==typeof t&&t,i.domain=C?E.domain:void 0,this._c.push(i),this._a&&this._a.push(i),this._s&&M(this,!1),i.promise},catch:function(e){return this.then(void 0,e)}}),a=function(){var e=new r;this.promise=e,this.resolve=c(V,e,1),this.reject=c(F,e,1);},S.f=k=function(e){return e===I||e===o?new a(e):s(e)}),u(u.G+u.W+u.F*!P,{Promise:I}),i(23)(I,"Promise"),i(99)("Promise"),o=i(2).Promise,u(u.S+u.F*!P,"Promise",{reject:function(e){var t=k(this);return (0, t.reject)(e),t.promise}}),u(u.S+u.F*(n||!P),"Promise",{resolve:function(e){return b(n&&this===o?I:this,e)}}),u(u.S+u.F*!(P&&i(100)((function(e){I.all(e).catch(O);}))),"Promise",{all:function(e){var t=this,i=k(t),r=i.resolve,s=i.reject,a=_((function(){var i=[],a=0,o=1;f(e,!1,(function(e){var n=a++,d=!1;i.push(void 0),o++,t.resolve(e).then((function(e){d||(d=!0,i[n]=e,--o||r(i));}),s);})),--o||r(i);}));return a.e&&s(a.v),i.promise},race:function(e){var t=this,i=k(t),r=i.reject,s=_((function(){f(e,!1,(function(e){t.resolve(e).then(i.resolve,r);}));}));return s.e&&r(s.v),i.promise}});},function(e,t){e.exports=function(e,t,i,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(i+": incorrect invocation!");return e};},function(e,t,i){var r=i(18),s=i(92),a=i(93),o=i(3),n=i(45),d=i(94),c={},l={};(t=e.exports=function(e,t,i,u,h){var p,m,f,g,v=h?function(){return e}:d(e),y=r(i,u,t?2:1),S=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(p=n(e.length);p>S;S++)if((g=t?y(o(m=e[S])[0],m[1]):y(e[S]))===c||g===l)return g}else for(f=v.call(e);!(m=f.next()).done;)if((g=s(f,y,m.value,t))===c||g===l)return g}).BREAK=c,t.RETURN=l;},function(e,t,i){var r=i(3);e.exports=function(e,t,i,s){try{return s?t(r(i)[0],i[1]):t(i)}catch(t){var a=e.return;throw void 0!==a&&r(a.call(e)),t}};},function(e,t,i){var r=i(16),s=i(1)("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||a[s]===e)};},function(e,t,i){var r=i(49),s=i(1)("iterator"),a=i(16);e.exports=i(2).getIteratorMethod=function(e){if(null!=e)return e[s]||e["@@iterator"]||a[r(e)]};},function(e,t){e.exports=function(e,t,i){var r=void 0===i;switch(t.length){case 0:return r?e():e.call(i);case 1:return r?e(t[0]):e.call(i,t[0]);case 2:return r?e(t[0],t[1]):e.call(i,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(i,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(i,t[0],t[1],t[2],t[3])}return e.apply(i,t)};},function(e,t,i){var r=i(0),s=i(51).set,a=r.MutationObserver||r.WebKitMutationObserver,o=r.process,n=r.Promise,d="process"==i(17)(o);e.exports=function(){var e,t,i,c=function(){var r,s;for(d&&(r=o.domain)&&r.exit();e;){s=e.fn,e=e.next;try{s();}catch(r){throw e?i():t=void 0,r}}t=void 0,r&&r.enter();};if(d)i=function(){o.nextTick(c);};else if(!a||r.navigator&&r.navigator.standalone)if(n&&n.resolve){var l=n.resolve(void 0);i=function(){l.then(c);};}else i=function(){s.call(r,c);};else {var u=!0,h=document.createTextNode("");new a(c).observe(h,{characterData:!0}),i=function(){h.data=u=!u;};}return function(r){var s={fn:r,next:void 0};t&&(t.next=s),e||(e=s,i()),t=s;}};},function(e,t,i){var r=i(0).navigator;e.exports=r&&r.userAgent||"";},function(e,t,i){var r=i(5);e.exports=function(e,t,i){for(var s in t)i&&e[s]?e[s]=t[s]:r(e,s,t[s]);return e};},function(e,t,i){var r=i(0),s=i(2),a=i(6),o=i(8),n=i(1)("species");e.exports=function(e){var t="function"==typeof s[e]?s[e]:r[e];o&&t&&!t[n]&&a.f(t,n,{configurable:!0,get:function(){return this}});};},function(e,t,i){var r=i(1)("iterator"),s=!1;try{var a=[7][r]();a.return=function(){s=!0;},Array.from(a,(function(){throw 2}));}catch(e){}e.exports=function(e,t){if(!t&&!s)return !1;var i=!1;try{var a=[7],o=a[r]();o.next=function(){return {done:i=!0}},a[r]=function(){return o},e(a);}catch(e){}return i};},function(e,t,i){var r=i(15),s=i(2),a=i(0),o=i(50),n=i(53);r(r.P+r.R,"Promise",{finally:function(e){var t=o(this,s.Promise||a.Promise),i="function"==typeof e;return this.then(i?function(i){return n(t,e()).then((function(){return i}))}:e,i?function(i){return n(t,e()).then((function(){throw i}))}:e)}});},function(e,t,i){var r=i(15),s=i(34),a=i(52);r(r.S,"Promise",{try:function(e){var t=s.f(this),i=a(e);return (i.e?t.reject:t.resolve)(i.v),t.promise}});},function(e,t,i){t.__esModule=!0;var r=o(i(104)),s=o(i(106)),a="function"==typeof s.default&&"symbol"==typeof r.default?function(e){return typeof e}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":typeof e};function o(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof s.default&&"symbol"===a(r.default)?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":void 0===e?"undefined":a(e)};},function(e,t,i){e.exports={default:i(105),__esModule:!0};},function(e,t,i){i(39),i(48),e.exports=i(35).f("iterator");},function(e,t,i){e.exports={default:i(107),__esModule:!0};},function(e,t,i){i(108),i(38),i(114),i(115),e.exports=i(2).Symbol;},function(e,t,i){var r=i(0),s=i(9),a=i(8),o=i(15),n=i(42),d=i(109).KEY,c=i(20),l=i(32),u=i(23),h=i(22),p=i(1),m=i(35),f=i(36),g=i(110),v=i(111),y=i(3),S=i(7),_=i(47),R=i(11),b=i(29),T=i(21),E=i(43),A=i(112),w=i(113),I=i(54),C=i(6),O=i(30),k=w.f,P=C.f,x=A.f,M=r.Symbol,D=r.JSON,N=D&&D.stringify,L=p("_hidden"),F=p("toPrimitive"),V={}.propertyIsEnumerable,B=l("symbol-registry"),U=l("symbols"),j=l("op-symbols"),H=Object.prototype,$="function"==typeof M&&!!I.f,W=r.QObject,G=!W||!W.prototype||!W.prototype.findChild,q=a&&c((function(){return 7!=E(P({},"a",{get:function(){return P(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=k(H,t);r&&delete H[t],P(e,t,i),r&&e!==H&&P(H,t,r);}:P,z=function(e){var t=U[e]=E(M.prototype);return t._k=e,t},J=$&&"symbol"==typeof M.iterator?function(e){return "symbol"==typeof e}:function(e){return e instanceof M},Y=function(e,t,i){return e===H&&Y(j,t,i),y(e),t=b(t,!0),y(i),s(U,t)?(i.enumerable?(s(e,L)&&e[L][t]&&(e[L][t]=!1),i=E(i,{enumerable:T(0,!1)})):(s(e,L)||P(e,L,T(1,{})),e[L][t]=!0),q(e,t,i)):P(e,t,i)},K=function(e,t){y(e);for(var i,r=g(t=R(t)),s=0,a=r.length;a>s;)Y(e,i=r[s++],t[i]);return e},Q=function(e){var t=V.call(this,e=b(e,!0));return !(this===H&&s(U,e)&&!s(j,e))&&(!(t||!s(this,e)||!s(U,e)||s(this,L)&&this[L][e])||t)},X=function(e,t){if(e=R(e),t=b(t,!0),e!==H||!s(U,t)||s(j,t)){var i=k(e,t);return !i||!s(U,t)||s(e,L)&&e[L][t]||(i.enumerable=!0),i}},Z=function(e){for(var t,i=x(R(e)),r=[],a=0;i.length>a;)s(U,t=i[a++])||t==L||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===H,r=x(i?j:R(e)),a=[],o=0;r.length>o;)!s(U,t=r[o++])||i&&!s(H,t)||a.push(U[t]);return a};$||(n((M=function(){if(this instanceof M)throw TypeError("Symbol is not a constructor!");var e=h(arguments.length>0?arguments[0]:void 0),t=function(i){this===H&&t.call(j,i),s(this,L)&&s(this[L],e)&&(this[L][e]=!1),q(this,e,T(1,i));};return a&&G&&q(H,e,{configurable:!0,set:t}),z(e)}).prototype,"toString",(function(){return this._k})),w.f=X,C.f=Y,i(55).f=A.f=Z,i(37).f=Q,I.f=ee,a&&!i(14)&&n(H,"propertyIsEnumerable",Q,!0),m.f=function(e){return z(p(e))}),o(o.G+o.W+o.F*!$,{Symbol:M});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)p(te[ie++]);for(var re=O(p.store),se=0;re.length>se;)f(re[se++]);o(o.S+o.F*!$,"Symbol",{for:function(e){return s(B,e+="")?B[e]:B[e]=M(e)},keyFor:function(e){if(!J(e))throw TypeError(e+" is not a symbol!");for(var t in B)if(B[t]===e)return t},useSetter:function(){G=!0;},useSimple:function(){G=!1;}}),o(o.S+o.F*!$,"Object",{create:function(e,t){return void 0===t?E(e):K(E(e),t)},defineProperty:Y,defineProperties:K,getOwnPropertyDescriptor:X,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var ae=c((function(){I.f(1);}));o(o.S+o.F*ae,"Object",{getOwnPropertySymbols:function(e){return I.f(_(e))}}),D&&o(o.S+o.F*(!$||c((function(){var e=M();return "[null]"!=N([e])||"{}"!=N({a:e})||"{}"!=N(Object(e))}))),"JSON",{stringify:function(e){for(var t,i,r=[e],s=1;arguments.length>s;)r.push(arguments[s++]);if(i=t=r[1],(S(t)||void 0!==e)&&!J(e))return v(t)||(t=function(e,t){if("function"==typeof i&&(t=i.call(this,e,t)),!J(t))return t}),r[1]=t,N.apply(D,r)}}),M.prototype[F]||i(5)(M.prototype,F,M.prototype.valueOf),u(M,"Symbol"),u(Math,"Math",!0),u(r.JSON,"JSON",!0);},function(e,t,i){var r=i(22)("meta"),s=i(7),a=i(9),o=i(6).f,n=0,d=Object.isExtensible||function(){return !0},c=!i(20)((function(){return d(Object.preventExtensions({}))})),l=function(e){o(e,r,{value:{i:"O"+ ++n,w:{}}});},u=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!s(e))return "symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,r)){if(!d(e))return "F";if(!t)return "E";l(e);}return e[r].i},getWeak:function(e,t){if(!a(e,r)){if(!d(e))return !0;if(!t)return !1;l(e);}return e[r].w},onFreeze:function(e){return c&&u.NEED&&d(e)&&!a(e,r)&&l(e),e}};},function(e,t,i){var r=i(30),s=i(54),a=i(37);e.exports=function(e){var t=r(e),i=s.f;if(i)for(var o,n=i(e),d=a.f,c=0;n.length>c;)d.call(e,o=n[c++])&&t.push(o);return t};},function(e,t,i){var r=i(17);e.exports=Array.isArray||function(e){return "Array"==r(e)};},function(e,t,i){var r=i(11),s=i(55).f,a={}.toString,o="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?function(e){try{return s(e)}catch(e){return o.slice()}}(e):s(r(e))};},function(e,t,i){var r=i(37),s=i(21),a=i(11),o=i(29),n=i(9),d=i(41),c=Object.getOwnPropertyDescriptor;t.f=i(8)?c:function(e,t){if(e=a(e),t=o(t,!0),d)try{return c(e,t)}catch(e){}if(n(e,t))return s(!r.f.call(e,t),e[t])};},function(e,t,i){i(36)("asyncIterator");},function(e,t,i){i(36)("observable");},function(e,t,i){function r(e){return e>0&&0==(e&e-1)}Object.defineProperty(t,"__esModule",{value:!0}),t.loadImageBatch=t.retryLoadImage=t.loadImage=t.createTexture=t.imgDataSize=t.toNthPower=t.isNthPower=void 0,t.isNthPower=r,t.toNthPower=function(e){if(r(e))return e;const t=[4096,2048,1024,512,256,128,64,32,16,8,4,2,1];let i=1/0;for(let r=0;r<t.length;r++){const s=t[r],a=Math.abs(e-s);if(e>=s)return a>i?t[r-1]:s;i=a;}return 1},t.imgDataSize=function(e,t,i){if(i=null!=i?i:Math.min(t)){const i=Math.max(e,t);if(i>512){const r=i/512;return {width:e/r>>0,height:t/r>>0}}}return {width:e,height:t}},t.createTexture=function e(t,i,r){const s=t.createTexture();if(!s)return console.error(`texture:[${i}] created error.`),null;const a=Object.assign({flipY:!0,wrapS:"clamp",wrapT:"clamp",genMipMaps:!1},r),o={clamp:t.CLAMP_TO_EDGE,repeat:t.REPEAT,mirror:t.MIRRORED_REPEAT},n={glTexture:s,source:i,refresh(){const{source:e,glTexture:i,opts:r}=n,{genMipMaps:s}=r,a=t.TEXTURE_2D;t.bindTexture(a,i);const{flipY:d}=r;d?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(a,t.TEXTURE_WRAP_S,o[r.wrapS]),t.texParameteri(a,t.TEXTURE_WRAP_T,o[r.wrapT]),t.texParameteri(a,t.TEXTURE_MIN_FILTER,s?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(a,t.TEXTURE_MAG_FILTER,t.LINEAR),"width"in r&&"height"in r?t.texImage2D(a,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,e):null!==e&&t.texImage2D(a,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s&&t.generateMipmap(a);},updateMipMap(){const{glTexture:e,opts:i}=n,{genMipMaps:r}=i;if(!r)return;const s=t.TEXTURE_2D;t.bindTexture(s,e),t.generateMipmap(s);},clone:()=>e(t,n.source,n.opts),opts:a};return n.refresh(),n};const s={};function a(e,t,i){"string"==typeof e&&e&&(s[e]?null==t||t(s[e]):fetch(e+"?rdn="+Date.now()).then(e=>e.arrayBuffer()).then(r=>{let a=!1;const o=new Blob([r],{type:"image/*"}),n=new Image;new URL(e,window.location.href).origin!==window.location.origin&&(n.crossOrigin="anonymous"),n.onload=()=>{a||(a=!0,s[e]=n,null==t||t(n));},n.onerror=e=>{null==i||i(e);},n.src=URL.createObjectURL(o),setTimeout(()=>{!a&&n.complete&&n.naturalHeight>0&&(a=!0,s[e]=n,null==t||t(n));},0);}).catch(e=>{null==i||i(e);}));}function o(e,t=3,i,r){let s=null;const o=(n=0)=>{(n+=1)<=t?a(e,e=>{null==i||i(e);},e=>{s=e,o(n);}):null==r||r(s);};o();}t.loadImage=a,t.retryLoadImage=o,t.loadImageBatch=function(e,t=3,i){let r={},s=[];const a=()=>{Object.keys(r).length+s.length===e.length&&(null==i||i(r,s));};e.forEach(e=>{o(e,t,t=>{r[e]=t,a();},()=>{s.push(e),a();});});};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.alerter=void 0;const s=r(i(12)),a=r(i(13)),o=i(68),n=i(69),d=i(146);Object.defineProperty(t,"alerter",{enumerable:!0,get:function(){return d.alerter}});const c=i(147),l=i(4);class u extends o.RTCEventEmitter{constructor(){super(),this.deviceChangeDetectionTimer=null,this.deviceInited=!1,this.hasPerm={audioIn:!1,video:!1,audioOut:!1},this.deviceHistory={audioIn:[],video:[],audioOut:[]},this.compatAudioInputList=c.compatAudioInputList,this.onUserGestureNeeded=null,this.logger=new n.Logger({tagGen:()=>`Device m${this.deviceHistory.audioIn.length}c${this.deviceHistory.video.length}s${this.deviceHistory.audioOut.length}`}),this.handleDeviceChange=this.detectDeviceChange.bind(this),this.onUserGestureNeeded=this.defaultHandleUserGestureNeeded.bind(this),d.alerter.addListener("@user-gesture-fired",()=>{this.safeEmit("user-gesture-fired");});}async getDevices(e){if(!navigator.mediaDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices),new a.default({code:s.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 mediaDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});if(!navigator.mediaDevices.enumerateDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices.enumerateDevices),new a.default({code:s.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 enumerateDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});let t={video:[],audioIn:[],audioOut:[]},i=await navigator.mediaDevices.enumerateDevices(),r=null;if(e.requestPerm){const t=i.find(t=>e.audioinput&&"audioinput"==t.kind&&!t.label),s=i.find(t=>e.videoinput&&"videoinput"==t.kind&&!t.label);if(t||s)try{r=await navigator.mediaDevices.getUserMedia({audio:t,video:s});}catch(e){this.logger.error(e.name,e.message,e.stack);}}return i=await navigator.mediaDevices.enumerateDevices(),i.forEach((function(i){if(e.videoinput&&"videoinput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"camera "+(t.video.length+1))};e.groupId&&(r.groupId=i.groupId),t.video.push(r);}else if(e.audioinput&&"audioinput"===i.kind){let r;r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"microphone "+(t.audioIn.length+1))},e.groupId&&(r.groupId=i.groupId),t.audioIn.push(r);}else if(e.audiooutput&&"audiooutput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"speaker "+(t.audioOut.length+1))};e.groupId&&(r.groupId=i.groupId),t.audioOut.push(r);}r&&r.getTracks().forEach(e=>{e.stop();});})),t}async getCameras(e){const t=await this.getDevices({videoinput:!0,requestPerm:e});return t?t.video:[]}async getMicrophones(e){const t=await this.getDevices({audioinput:!0,requestPerm:e});return t?t.audioIn:[]}async getSpeakers(e){const t=await this.getDevices({audioinput:!0,audiooutput:!0,requestPerm:e});return t?t.audioOut:[]}async detectDeviceChange(){let e={audioIn:{added:[],changed:[],removed:[]},video:{added:[],changed:[],removed:[]},audioOut:{added:[],changed:[],removed:[]}};const t=await this.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:!1,groupId:!0,noFillLabel:!0});["audioIn","video","audioOut"].forEach(i=>{if(this.deviceInited){const r=t[i].find(e=>e.deviceId&&e.label);r?this.hasPerm[i]?(t[i].forEach(t=>{const r=this.deviceHistory[i].find(e=>e.deviceId===t.deviceId||""===e.deviceId&&"default"===t.deviceId);if(r){if(r.label!==t.label||r.groupId!==t.groupId){let s=`检测到设备改变：${i}: deviceId ${t.deviceId}`;r.label!==t.label?s+=`【Label ${r.label} => ${t.label}】`:s+=" Label "+t.label,r.groupId!==t.groupId&&(s+="【groupId changed】"),this.logger.log(s),e[i].changed.push(t);}}else this.logger.log(`检测到设备新增：${i}: deviceId ${t.deviceId} 【${t.label}】`),e[i].added.push(t);}),this.deviceHistory[i].forEach(r=>{t[i].find(e=>r.deviceId===e.deviceId||""===r.deviceId&&"default"===e.deviceId)||(this.logger.log(`检测到设备拔出：${i}: deviceId ${r.deviceId} 【${r.label}】`),e[i].removed.push(r));}),this.deviceHistory[i]=t[i],e[i].added.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"ACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"ACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"ACTIVE"});}),e[i].changed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"CHANGED"}):"video"===i?this.emit("camera-changed",{device:e,state:"CHANGED"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"CHANGED"});}),e[i].removed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"INACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"INACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"INACTIVE"});})):(this.hasPerm[i]=!0,this.deviceHistory[i]=t[i],"audioIn"===i?(this.logger.log(`麦克风设备：${r.deviceId}【${r.label}】`),this.emit("recording-device-init")):"video"===i?(this.logger.log(`摄像头设备：【${t[i].map(e=>e.label).join("】【")}】`),this.emit("camera-init")):"audioOut"===i&&(this.logger.log(`扬声器设备：${r.deviceId}【${r.label}】`),this.emit("playout-device-init"))):this.deviceHistory[i]=t[i];}else this.deviceHistory[i]=t[i];}),this.deviceInited||(this.deviceInited=!0,t.audioIn.length||this.logger.error("未侦测到可用麦克风"),t.video.length||this.logger.error("未侦测到可用摄像头"));}async startDeviceChangeDetection(){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(this.deviceChangeDetectionTimer&&clearInterval(this.deviceChangeDetectionTimer),await this.handleDeviceChange(),navigator.mediaDevices.ondevicechange?navigator.mediaDevices.ondevicechange===this.handleDeviceChange||(l.getParameters().forceListenDeviceChange?navigator.mediaDevices.ondevicechange=this.handleDeviceChange:this.logger.warn("系统设备枚举回调已被占用，设备枚举实效性将受到影响")):navigator.mediaDevices.ondevicechange=this.handleDeviceChange,l.getParameters().deviceChangeInterval&&(this.deviceChangeDetectionTimer=setInterval(this.handleDeviceChange,1e3))):this.logger.warn("当前环境不支持设备枚举");}stopDeviceChangeDetection(){this.logger.log("停止监听浏览器设备变化"),this.deviceChangeDetectionTimer&&(clearInterval(this.deviceChangeDetectionTimer),this.deviceChangeDetectionTimer=null),navigator.mediaDevices&&navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null),this.deviceInited=!1,this.deviceHistory.audioIn=[],this.deviceHistory.audioOut=[],this.deviceHistory.video=[],this.hasPerm.audioIn=!1,this.hasPerm.video=!1,this.hasPerm.audioOut=!1;}enableCompatMode(){this.logger.log("开启兼容模式"),c.compatAudioInputList.enabled=!0,this.handleDeviceChange();}disableCompatMode(){this.logger.log("关闭兼容模式。"),c.compatAudioInputList.enabled=!1,this.handleDeviceChange();}defaultHandleUserGestureNeeded(e){const t=`由于浏览器限制，该操作需手势触发。<br/>${e.name}<br/>${e.message}<br/>点击此处以继续`;d.alerter.alert(t),this.logger.warn('为避免看到这个消息，您应该实现 Device.onUserGestureNeeded 方法，引导用户作出手势，并触发 Device.on("user-gesture-fired")事件。');}clean(){}}const h=new u;t.Device=h;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.getBrowserInfo=t.getOSInfo=void 0;const o=a(i(24)),n=new Map([[o.IS_ANDROID,["Android",o.ANDROID_VERSION]],[o.IS_IOS,["iOS",o.IOS_VERSION]],[o.IS_WIN,["Windows",o.WIN_VERSION]],[o.IS_MAC,["MacOS",o.MACOS_VERSION]]]);t.getOSInfo=function(){let e="unknown",t="unknown";return n.get(!0)&&(e=n.get(!0)[0],t=n.get(!0)[1]),{osName:e,osVersion:t}};const d=new Map([[o.IS_FIREFOX,["Firefox",o.FIREFOX_VERSION]],[o.IS_EDG,["Edg",o.EDG_VERSION]],[o.IS_CHROME,["Chrome",o.CHROME_VERSION]],[o.IS_SAFARI,["Safari",o.SAFARI_VERSION]],[o.IS_WECHAT,["WeChat",o.WECHAT_VERSION]],[o.IS_WQQB,["QQ(Win)",o.WQQB_VERSION]],[o.IS_MQQB,["QQ(Mobile)",o.MQQB_VERSION]],[o.IS_X5MQQB,["QQ(Mobile X5)",o.MQQB_VERSION]],[o.IS_MACQQB,["QQ(Mac)",o.MACQQB_VERSION]],[o.IS_IPADQQB,["QQ(iPad)",o.IPADQQB_VERSION]],[o.IS_MIBROWSER,["MI",o.MI_VERSION]],[o.IS_HUAWEIBROWSER,["HW",o.HUAWEI_VERSION]],[o.IS_SAMSUNGBROWSER,["Samsung",o.SAMSUNG_VERSION]],[o.IS_OPPOBROWSER,["OPPO",o.OPPO_VERSION]],[o.IS_VIVOBROWSER,["VIVO",o.VIVO_VERSION]],[o.IS_EDGE,["EDGE",o.EDGE_VERSION]],[o.IS_SOGOUM,["SogouMobile",o.SOGOUM_VERSION]],[o.IS_SOGOU,["Sogou",o.SOGOU_VERSION]],[o.IS_ELECTRON,["Electron",o.ELECTRON_VERSION]]]);t.getBrowserInfo=function(){let e="unknown",t="unknown";return d.get(!0)&&(e=d.get(!0)[0],t=d.get(!0)[1]),{browserName:e,browserVersion:t}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.JSONBigStringify=t.JSONBigParse=void 0;const r=i(244),s=i(245);t.JSONBigParse=s.JSONParse(),t.JSONBigStringify=r.stringify;},function(e,t,i){e.exports=a,a.className="ReflectionObject";var r,s=i(25);function a(e,t){if(!s.isString(e))throw TypeError("name must be a string");if(t&&!s.isObject(t))throw TypeError("options must be an object");this.options=t,this.parsedOptions=null,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null;}Object.defineProperties(a.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),a.prototype.toJSON=function(){throw Error()},a.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof r&&t._handleAdd(this);},a.prototype.onRemove=function(e){var t=e.root;t instanceof r&&t._handleRemove(this),this.parent=null,this.resolved=!1;},a.prototype.resolve=function(){return this.resolved||this.root instanceof r&&(this.resolved=!0),this},a.prototype.getOption=function(e){if(this.options)return this.options[e]},a.prototype.setOption=function(e,t,i){return i&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},a.prototype.setParsedOption=function(e,t,i){this.parsedOptions||(this.parsedOptions=[]);var r=this.parsedOptions;if(i){var a=r.find((function(t){return Object.prototype.hasOwnProperty.call(t,e)}));if(a){var o=a[e];s.setProperty(o,i,t);}else (a={})[e]=s.setProperty({},i,t),r.push(a);}else {var n={};n[e]=t,r.push(n);}return this},a.prototype.setOptions=function(e,t){if(e)for(var i=Object.keys(e),r=0;r<i.length;++r)this.setOption(i[r],e[i[r]],t);return this},a.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},a._configure=function(e){r=e;};},function(e,t,i){e.exports=c;var r=i(120);((c.prototype=Object.create(r.prototype)).constructor=c).className="Field";var s,a=i(59),o=i(130),n=i(25),d=/^required|optional|repeated$/;function c(e,t,i,s,a,c,l){if(n.isObject(s)?(l=a,c=s,s=a=void 0):n.isObject(a)&&(l=c,c=a,a=void 0),r.call(this,e,c),!n.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!n.isString(i))throw TypeError("type must be a string");if(void 0!==s&&!d.test(s=s.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==a&&!n.isString(a))throw TypeError("extend must be a string");"proto3_optional"===s&&(s="optional"),this.rule=s&&"optional"!==s?s:void 0,this.type=i,this.id=t,this.extend=a||void 0,this.required="required"===s,this.optional=!this.required,this.repeated="repeated"===s,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!n.Long&&void 0!==o.long[i],this.bytes="bytes"===i,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=l;}c.fromJSON=function(e,t){return new c(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(c.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),c.prototype.setOption=function(e,t,i){return "packed"===e&&(this._packed=null),r.prototype.setOption.call(this,e,t,i)},c.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return n.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=o.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof s?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof a&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof a)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=n.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;n.base64.test(this.typeDefault)?n.base64.decode(this.typeDefault,e=n.newBuffer(n.base64.length(this.typeDefault)),0):n.utf8.write(this.typeDefault,e=n.newBuffer(n.utf8.length(this.typeDefault)),0),this.typeDefault=e;}return this.map?this.defaultValue=n.emptyObject:this.repeated?this.defaultValue=n.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof s&&(this.parent.ctor.prototype[this.name]=this.defaultValue),r.prototype.resolve.call(this)},c.d=function(e,t,i,r){return "function"==typeof t?t=n.decorateType(t).name:t&&"object"==typeof t&&(t=n.decorateEnum(t).name),function(s,a){n.decorateType(s.constructor).add(new c(a,e,t,i,{default:r}));}},c._configure=function(e){s=e;};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.STREAM_TYPE_REV=t.STREAM_TYPE=t.NERTC_VIDEO_QUALITY_REV=t.NERTC_VIDEO_QUALITY=t.NERTC_VIDEO_QUALITY_ENUM=t.NERTC_RECORD_VIDEO_FRAME_RATE=t.NERTC_RECORD_VIDEO_QUALITY=t.VIDEO_FRAME_RATE=t.VIDEO_FRAME_RATE_ENUM=void 0,function(e){e[e.CHAT_VIDEO_FRAME_RATE_NORMAL=0]="CHAT_VIDEO_FRAME_RATE_NORMAL",e[e.CHAT_VIDEO_FRAME_RATE_5=1]="CHAT_VIDEO_FRAME_RATE_5",e[e.CHAT_VIDEO_FRAME_RATE_10=2]="CHAT_VIDEO_FRAME_RATE_10",e[e.CHAT_VIDEO_FRAME_RATE_15=3]="CHAT_VIDEO_FRAME_RATE_15",e[e.CHAT_VIDEO_FRAME_RATE_20=4]="CHAT_VIDEO_FRAME_RATE_20",e[e.CHAT_VIDEO_FRAME_RATE_25=5]="CHAT_VIDEO_FRAME_RATE_25",e[e.CHAT_VIDEO_FRAME_RATE_30=6]="CHAT_VIDEO_FRAME_RATE_30";}(t.VIDEO_FRAME_RATE_ENUM||(t.VIDEO_FRAME_RATE_ENUM={})),t.VIDEO_FRAME_RATE={CHAT_VIDEO_FRAME_RATE_NORMAL:0,CHAT_VIDEO_FRAME_RATE_5:1,CHAT_VIDEO_FRAME_RATE_10:2,CHAT_VIDEO_FRAME_RATE_15:3,CHAT_VIDEO_FRAME_RATE_20:4,CHAT_VIDEO_FRAME_RATE_25:5,CHAT_VIDEO_FRAME_RATE_30:6},t.NERTC_RECORD_VIDEO_QUALITY={RECORD_VIDEO_QUALITY_360p:360,RECORD_VIDEO_QUALITY_480p:480,RECORD_VIDEO_QUALITY_720p:720},t.NERTC_RECORD_VIDEO_FRAME_RATE={RECORD_VIDEO_FRAME_RATE_15:15,RECORD_VIDEO_FRAME_RATE_30:30},function(e){e[e.VIDEO_QUALITY_180p=2]="VIDEO_QUALITY_180p",e[e.VIDEO_QUALITY_480p=4]="VIDEO_QUALITY_480p",e[e.VIDEO_QUALITY_720p=8]="VIDEO_QUALITY_720p",e[e.VIDEO_QUALITY_1080p=16]="VIDEO_QUALITY_1080p";}(t.NERTC_VIDEO_QUALITY_ENUM||(t.NERTC_VIDEO_QUALITY_ENUM={})),t.NERTC_VIDEO_QUALITY={VIDEO_QUALITY_180p:2,VIDEO_QUALITY_480p:4,VIDEO_QUALITY_720p:8,VIDEO_QUALITY_1080p:16},t.NERTC_VIDEO_QUALITY_REV={[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p]:"320x180",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p]:"640x480",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p]:"1280x720",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p]:"1920x1080"},t.STREAM_TYPE={HIGH:0,LOW:1},t.STREAM_TYPE_REV={0:"HIGH",1:"LOW"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getWebGLContext=t.get2DContext=void 0;const r=i(4);t.get2DContext=function(e,t){return r.getParameters().disable2dContext?null:e.getContext("2d",t)},t.getWebGLContext=function(e,t){return r.getParameters().disableWebGLContext?null:e.getContext("webgl",t)};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.EnhancedEventEmitter=void 0;const r=i(168),s=i(56),a="EnhancedEventEmitter";class o extends r.EventEmitter{constructor(){super(),this.setMaxListeners(1/0);}safeEmit(e,...t){const i=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return s.Logger.error(a,"safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(i)}}async safeEmitAsPromise(e,...t){return new Promise((i,r)=>{try{this.emit(e,...t,i,r);}catch(t){s.Logger.error(a,"safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,t),r(t);}})}}t.EnhancedEventEmitter=o;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=t.UnsupportedError=void 0;class r extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(e).stack;}}t.UnsupportedError=r;class s extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,s):this.stack=new Error(e).stack;}}t.InvalidStateError=s;},function(e,t,i){var r=i(219),s=i(220);t.write=s,t.parse=r.parse,t.parseParams=r.parseParams,t.parseFmtpConfig=r.parseFmtpConfig,t.parsePayloads=r.parsePayloads,t.parseRemoteCandidates=r.parseRemoteCandidates,t.parseImageAttributes=r.parseImageAttributes,t.parseSimulcastStreamList=r.parseSimulcastStreamList;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.canReceive=t.canSend=t.generateProbatorRtpParameters=t.reduceCodecs=t.getSendingRemoteRtpParameters=t.getSendingRtpParameters=t.getRecvRtpCapabilities=t.getExtendedRtpCapabilities=t.validateSctpStreamParameters=t.validateSctpParameters=t.validateNumSctpStreams=t.validateSctpCapabilities=t.validateRtcpParameters=t.validateRtpEncodingParameters=t.validateRtpHeaderExtensionParameters=t.validateRtpCodecParameters=t.validateRtpParameters=t.validateRtpHeaderExtension=t.validateRtcpFeedback=t.validateRtpCodecCapability=t.validateRtpCapabilities=void 0;const o=a(i(221)),n=a(i(72));function d(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if(e.kind=i[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t);}function c(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="");}function l(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv");}function u(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)h(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)p(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)m(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),f(e.rtcp);}function h(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===i[1].toLowerCase()?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t);}function p(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError("invalid header extension parameter")}}function m(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function f(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0);}function g(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function v(e){return !!e&&/.+\/rtx$/i.test(e.mimeType)}function y(e,t,{strict:i=!1,modify:r=!1}={}){const s=e.mimeType.toLowerCase();if(s!==t.mimeType.toLowerCase())return !1;if(e.clockRate!==t.clockRate)return !1;if(e.channels!==t.channels)return !1;switch(s){case"video/h265":case"video/vp9":case"video/av1":return !1;case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return !1;if(i){if(!o.isSameProfile(e.parameters,t.parameters))return !1;let i;try{i=o.generateProfileLevelIdForAnswer(e.parameters,t.parameters);}catch(e){return !1}r&&(i?e.parameters["profile-level-id"]=i:delete e.parameters["profile-level-id"]);}break}return !0}function S(e,t){return (!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function _(e,t){const i=[];for(const r of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find(e=>e.type===r.type&&(e.parameter===r.parameter||!e.parameter&&!r.parameter));e&&i.push(e);}return i}t.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)d(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)l(t);},t.validateRtpCodecCapability=d,t.validateRtcpFeedback=c,t.validateRtpHeaderExtension=l,t.validateRtpParameters=u,t.validateRtpCodecParameters=h,t.validateRtpHeaderExtensionParameters=p,t.validateRtpEncodingParameters=m,t.validateRtcpParameters=f,t.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");g(e.numStreams);},t.validateNumSctpStreams=g,t.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},t.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},t.getExtendedRtpCapabilities=function(e,t){const i={codecs:[],headerExtensions:[]};for(const r of t.codecs||[]){if(v(r))continue;const t=(e.codecs||[]).find(e=>y(e,r,{strict:!0,modify:!0}));if(!t)continue;const s={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:r.parameters,rtcpFeedback:_(t,r)};i.codecs.push(s);}for(const r of i.codecs){const i=e.codecs.find(e=>v(e)&&e.parameters.apt===r.localPayloadType),s=t.codecs.find(e=>v(e)&&e.parameters.apt===r.remotePayloadType);i&&s&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=s.preferredPayloadType);}for(const r of t.headerExtensions){const t=e.headerExtensions.find(e=>S(e,r));if(!t)continue;const s={kind:r.kind,uri:r.uri,sendId:t.preferredId,recvId:r.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":s.direction="sendrecv";break;case"recvonly":s.direction="sendonly";break;case"sendonly":s.direction="recvonly";break;case"inactive":s.direction="inactive";}i.headerExtensions.push(s);}return i},t.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const i of e.codecs){const e={mimeType:i.mimeType,kind:i.kind,preferredPayloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(e),!i.localRtxPayloadType)continue;const r={mimeType:i.kind+"/rtx",kind:i.kind,preferredPayloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(r);}for(const i of e.headerExtensions){if("sendrecv"!==i.direction&&"recvonly"!==i.direction)continue;const e={kind:i.kind,uri:i.uri,preferredId:i.sendId,preferredEncrypt:i.encrypt,direction:i.direction};t.headerExtensions.push(e);}return t},t.getSendingRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e);}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t);}return i},t.getSendingRemoteRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e);}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t);}if(i.headerExtensions.some(e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"goog-remb"!==e.type);else if(i.headerExtensions.some(e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type);else for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type&&"goog-remb"!==e.type);return i},t.reduceCodecs=function(e,t){const i=[];if(t){for(let r=0;r<e.length;++r)if(y(e[r],t)){i.push(e[r]),v(e[r+1])&&i.push(e[r+1]);break}if(0===i.length)throw new TypeError("no matching codec found")}else i.push(e[0]),v(e[1])&&i.push(e[1]);return i},t.generateProbatorRtpParameters=function(e,t){u(e=n.clone(e,{}));const i={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:t}],rtcp:{cname:"probator"}};return i.codecs.push(e.codecs[0]),i.codecs[0].payloadType=127,i.headerExtensions=e.headerExtensions,i},t.canSend=function(e,t){return t.codecs.some(t=>t.kind===e)},t.canReceive=function(e,t){if(u(e),0===e.codecs.length)return !1;for(let i in e.codecs)if("video/rtx"!==e.codecs[i].mimeType)for(let r in t.codecs)if(t.codecs[r].localPayloadType===e.codecs[i].payloadType)return !0;return !1};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getBlobUrl=void 0;const s=r(i(236)),a=r(i(237)),o=r(i(238)),n=r(i(239)),d=r(i(240)),c={volumeProcessor:{blobParts:[a.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioWorkletAgentProcessor:{blobParts:[d.default],options:{type:"text/javascript; charset=utf-8"},url:""},webWorkerTimer:{blobParts:[o.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioAIProcessor:{blobParts:[n.default],options:{type:"text/javascript; charset=utf-8"},url:""},rtcTimer:{blobParts:[s.default],options:{type:"text/js-worker"},url:""}};t.getBlobUrl=function(e){if(!c[e].url){const t=new Blob(c[e].blobParts,c[e].options);c[e].url=window.URL.createObjectURL(t);}return c[e].url};},function(e,t,i){e.exports=u;var r=i(120);((u.prototype=Object.create(r.prototype)).constructor=u).className="Namespace";var s,a,o,n=i(121),d=i(144),c=i(25);function l(e,t){if(e&&e.length){for(var i={},r=0;r<e.length;++r)i[e[r].name]=e[r].toJSON(t);return i}}function u(e,t){r.call(this,e,t),this.nested=void 0,this._nestedArray=null;}function h(e){return e._nestedArray=null,e}u.fromJSON=function(e,t){return new u(e,t.options).addJSON(t.nested)},u.arrayToJSON=l,u.isReservedId=function(e,t){if(e)for(var i=0;i<e.length;++i)if("string"!=typeof e[i]&&e[i][0]<=t&&e[i][1]>t)return !0;return !1},u.isReservedName=function(e,t){if(e)for(var i=0;i<e.length;++i)if(e[i]===t)return !0;return !1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=c.toArray(this.nested))}}),u.prototype.toJSON=function(e){return c.toObject(["options",this.options,"nested",l(this.nestedArray,e)])},u.prototype.addJSON=function(e){if(e)for(var t,i=Object.keys(e),r=0;r<i.length;++r)t=e[i[r]],this.add((void 0!==t.fields?s.fromJSON:void 0!==t.values?o.fromJSON:void 0!==t.methods?a.fromJSON:void 0!==t.id?n.fromJSON:u.fromJSON)(i[r],t));return this},u.prototype.get=function(e){return this.nested&&this.nested[e]||null},u.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof o)return this.nested[e].values;throw Error("no such enum: "+e)},u.prototype.add=function(e){if(!(e instanceof n&&void 0!==e.extend||e instanceof s||e instanceof o||e instanceof a||e instanceof u||e instanceof d))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof u&&e instanceof u)||t instanceof s||t instanceof a)throw Error("duplicate name '"+e.name+"' in "+this);for(var i=t.nestedArray,r=0;r<i.length;++r)e.add(i[r]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0);}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),h(this)},u.prototype.remove=function(e){if(!(e instanceof r))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),h(this)},u.prototype.define=function(e,t){if(c.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var i=this;e.length>0;){var r=e.shift();if(i.nested&&i.nested[r]){if(!((i=i.nested[r])instanceof u))throw Error("path conflicts with non-namespace objects")}else i.add(i=new u(r));}return t&&i.addJSON(t),i},u.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof u?e[t++].resolveAll():e[t++].resolve();return this.resolve()},u.prototype.lookup=function(e,t,i){if("boolean"==typeof t?(i=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),c.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".");}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var r=this.get(e[0]);if(r){if(1===e.length){if(!t||t.indexOf(r.constructor)>-1)return r}else if(r instanceof u&&(r=r.lookup(e.slice(1),t,!0)))return r}else for(var s=0;s<this.nestedArray.length;++s)if(this._nestedArray[s]instanceof u&&(r=this._nestedArray[s].lookup(e,t,!0)))return r;return null===this.parent||i?null:this.parent.lookup(e,t)},u.prototype.lookupType=function(e){var t=this.lookup(e,[s]);if(!t)throw Error("no such type: "+e);return t},u.prototype.lookupEnum=function(e){var t=this.lookup(e,[o]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},u.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[s,o]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},u.prototype.lookupService=function(e){var t=this.lookup(e,[a]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},u._configure=function(e,t,i){s=e,a=t,o=i;};},function(e,t,i){var r=t,s=i(25),a=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(e,t){var i=0,r={};for(t|=0;i<e.length;)r[a[i+t]]=e[i++];return r}r.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),r.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",s.emptyArray,null]),r.long=o([0,0,0,1,1],7),r.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),r.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0]);},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createFrameBuffer=void 0;const r=i(116);t.createFrameBuffer=function(e,t,i,s){const a=e.createFramebuffer();if(!a)return console.error("framebuffer created error."),null;const o=r.createTexture(e,null,{width:t,height:i,genMipMaps:null!=s&&s});return o?(e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o.glTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),{framebuffer:a,targetTexture:o,bind:t=>{t?e.bindFramebuffer(e.FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,a);}}):null};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Program=void 0;const r=i(301),s=i(159),a=i(302),o=i(303);t.Program=class{constructor(e,t){this.shaders={},this.uniforms={},this.attributes={},this.indices=null,this.gl=e,this.draw=t,this._program=e.createProgram(),this.setShader(r.defaultShader.vShader,"VERTEX"),this.setShader(r.defaultShader.fShader,"FRAGMENT");}get program(){return this._program||console.error("program create error."),this._program}parseUniforms(){const e=o.parseUniforms(this.gl,this.program);for(const t in e)t in this.uniforms&&e[t].setter(this.uniforms[t].value);this.uniforms=e;}parseAttributes(){const e=this.gl,t=s.parseAttributes(this.gl,this.program);for(const i in this.attributes){const r=this.attributes[i];if(i in t){const e=r.attributeBuffer;e&&t[i].bufferSetter(e);}else e.deleteBuffer(r.buffer);}this.attributes=t;}get count(){const e=this.attributes;let t=-1;for(const i in e){const r=e[i];-1!==t&&t!==r.count&&console.warn("inconsistent attribute length."),t=Math.max(t,r.count);}return t}setShader(e,t){const i=this.gl,s=this.program,o=a.createShader(i,e,t);if(o){const e=this.shaders[t];e&&(i.detachShader(s,e),i.deleteShader(e)),i.attachShader(s,o),this.shaders[t]=o,this.shaders.VERTEX&&this.shaders.FRAGMENT&&(i.linkProgram(s),this.parseUniforms(),this.parseAttributes());}else "VERTEX"===t?this.setShader(r.defaultShader.vShader,"VERTEX"):this.setShader(r.defaultShader.fShader,"FRAGMENT");}getUniform(e){var t;const i=null!==(t=this.uniforms[e])&&void 0!==t?t:null;return i||console.warn(`uniform:[${e}] does not exist.`),i}setUniform(e,t){var i;null===(i=this.getUniform(e))||void 0===i||i.setter(t);}updateUniform(e,t){var i;const r=this.getUniform(e);null==r||r.setter(null!==(i=t(r.value))&&void 0!==i?i:r.value);}setAttributeBuffer(e){var t;e&&(null===(t=this.getAttribute(e.name))||void 0===t||t.bufferSetter(e));}getAttribute(e){return this.attributes[e]||console.warn(`attribute:[${e}] does not exist.`),this.attributes[e]}setAttribute(e,t){var i;null===(i=this.getAttribute(e))||void 0===i||i.setter(t);}updateAttribute(e,t){var i;const r=this.getAttribute(e);null==r||r.setter(null!==(i=t(r.typedArray))&&void 0!==i?i:r.typedArray);}setIndices(e){if(e&&"indices"===e.name){const t=this.gl;t.bindBuffer(e.target,e.buffer),t.bufferData(e.target,e.typedArray,e.usage);}this.indices=e;}render(){const e=this.gl,t=this.program;e.useProgram(t);const i=this.uniforms;for(const e in i)i[e].setter();const r=this.attributes;for(const e in r){r[e].setter();}this.indices&&e.bindBuffer(this.indices.target,this.indices.buffer),this.draw?this.draw():e.drawArrays(e.TRIANGLE_STRIP,0,this.count);}destroy(e=!0){var t,i;const r=this.gl;if(e){for(const e in this.attributes){const t=this.attributes[e];if(t){const i=r.getAttribLocation(this.program,e);r.disableVertexAttribArray(i),r.deleteBuffer(t.buffer);}}this.indices&&r.deleteBuffer(this.indices.buffer);}r.deleteShader(null!==(t=this.shaders.VERTEX)&&void 0!==t?t:null),r.deleteShader(null!==(i=this.shaders.FRAGMENT)&&void 0!==i?i:null),r.deleteProgram(this.program);}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.baseTextureShader=void 0,t.baseTextureShader={vShader:"\n    attribute vec4 position;\n    attribute vec2 uv;\n    varying vec2 vuv;\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vuv);\n    }\n",yFlipFShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vec2(vuv.x, 1.0 - vuv.y));\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;const r=i(10);class s extends r.EventEmitter{constructor(e,t,i,r){super(),this.programs={},this.framebuffers={},this.renderer=e,this._map=t,this.posBuffer=i,this.uvBuffer=r;}get map(){return this._map}set map(e){}get output(){return this._map}updateSize(){}render(){}destroy(e=!0){this.removeAllListeners();const t=this.renderer.gl,i=this.framebuffers,r=this.programs;for(const e in i){const r=i[e];r.bind(!0),null==t||t.deleteTexture(r.targetTexture.glTexture),null==t||t.deleteFramebuffer(r.framebuffer);}for(const t in r){r[t].destroy(e);}}}t.Filter=s;},,,,,,function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCCanvas=void 0;const r=i(123);t.RTCCanvas=class{constructor(e,t){this.isAppend=!1,this.title=e,this.isAppend=t,this.createCanvas();}get _canvas(){return this.canvas}get _ctx(){return this.ctx}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=r.get2DContext(this.canvas),this.isAppend&&document.body.appendChild(this.canvas);}setSize(e,t){this.canvas&&(this.canvas.width=e,this.canvas.height=t);}destroy(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isAppend&&document.body.removeChild(this.canvas),this.canvas=null;}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.HandlerInterface=void 0;const r=i(124);class s extends r.EnhancedEventEmitter{constructor(){super();}}t.HandlerInterface=s;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.filterTransportCCFromSdp=t.filterTransportCCFromRtpParameters=void 0,t.filterTransportCCFromRtpParameters=function(e){if(e.headerExtensions)for(let t=e.headerExtensions.length-1;t>=0;t--)e.headerExtensions[t].uri.indexOf("transport-wide-cc")>-1&&e.headerExtensions.splice(t,1);for(let t=e.codecs.length-1;t>=0;t--){const i=e.codecs[t];if(i.rtcpFeedback)for(let e=i.rtcpFeedback.length-1;e>=0;e--)"transport-cc"===i.rtcpFeedback[e].type&&i.rtcpFeedback.splice(e,1);}},t.filterTransportCCFromSdp=function(e){for(let t in e.media){const i=e.media[t];if(i.ext)for(let e=i.ext.length-1;e>=0;e--)i.ext[e].uri.indexOf("transport-wide-cc")>-1&&i.ext.splice(e,1);if(i.rtcpFb)for(let e=i.rtcpFb.length-1;e>=0;e--)"transport-cc"===i.rtcpFb[e].type&&i.rtcpFb.splice(e,1);}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleBig=void 0;class r{constructor(e){this.isSimpleBig=!0,"string"==typeof e?this.numStr=e:e>Number.MIN_SAFE_INTEGER?this.numStr=e.toString():(console.error("Invalid numStr:",e),this.numStr="-1");}toString(){return this.numStr}static fromHex(e){if(e.length<13)return parseInt(e,16);let t="0";return e.split("").forEach(e=>{var i=parseInt(e,16);for(let e=8;e;e>>=1)t=s(t,t),i&e&&(t=s(t,"1"));}),new r(t)}}function s(e,t){let i=0,r=[],s=e.split("").map(Number),a=t.split("").map(Number);for(;s.length||a.length;){const e=(s.pop()||0)+(a.pop()||0)+i;r.unshift(e<10?e:e-10),i=e<10?0:1;}return i&&r.unshift(i),r.join("")}t.SimpleBig=r;},function(e,t,i){e.exports=o;var r=i(120);((o.prototype=Object.create(r.prototype)).constructor=o).className="OneOf";var s=i(121),a=i(25);function o(e,t,i,s){if(Array.isArray(t)||(i=t,t=void 0),r.call(this,e,i),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=s;}function n(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t]);}o.fromJSON=function(e,t){return new o(e,t.oneof,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},o.prototype.add=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,n(this),this},o.prototype.remove=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},o.prototype.onAdd=function(e){r.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var i=e.get(this.oneof[t]);i&&!i.partOf&&(i.partOf=this,this.fieldsArray.push(i));}n(this);},o.prototype.onRemove=function(e){for(var t,i=0;i<this.fieldsArray.length;++i)(t=this.fieldsArray[i]).parent&&t.parent.remove(t);r.prototype.onRemove.call(this,e);},o.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,i){a.decorateType(t.constructor).add(new o(i,e)),Object.defineProperty(t,i,{get:a.oneOfGetter(e),set:a.oneOfSetter(e)});}};},function(e,t,i){var r=i(70),s=i(69),a=i(4);e.exports=class{constructor(e){this.formatTimeUnit=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i},this.prefix=e?"protoo-client:"+e:"protoo-client";}debug(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0, a.getParameters)().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e);}warn(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0, a.getParameters)().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e);}error(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0, a.getParameters)().logLevel<=r.loglevels.ERROR&&console.error.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e);}formatArgs(e){var t=new Date,i=this.formatTimeUnit(""+(t.getMonth()+1))+"-"+this.formatTimeUnit(""+t.getDate())+" "+this.formatTimeUnit(""+t.getHours())+":"+this.formatTimeUnit(""+t.getMinutes())+":"+this.formatTimeUnit(""+t.getSeconds())+":"+this.formatTimeUnit(""+t.getMilliseconds(),3),r="[NERTC:LOG:"+(0, s.updateLogIndex)()+" "+i+" "+this.prefix.toUpperCase()+"]";return e.unshift(r),e}};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.alerter=void 0;const o=i(162),n=a(i(24)),d=i(68),c=i(4),l=i(63);class u extends d.RTCEventEmitter{constructor(){super(...arguments),this.elem=null;}alert(e,t){t||(t={resume:!1}),this.elem||(this.elem=document.createElement("div"),this.elem.style.fontSize="20px",this.elem.style.position="fixed",this.elem.style.background="yellow",this.elem.style.margin="auto",this.elem.style.width="100%",this.elem.style.zIndex="9999",this.elem.style.top="0",this.elem.addEventListener("click",()=>{var e;(null===(e=this.elem)||void 0===e?void 0:e.parentNode)&&this.elem.parentNode.removeChild(this.elem),this.safeEmit("@user-gesture-fired");})),this.elem.style.display="block",this.elem.innerHTML=e,document.body.appendChild(this.elem),t.resume&&this.elem.addEventListener("click",h,{once:!0});}watchClient(e){e.addListener("@pairing-join-start",()=>{if(0===o.systemChecker.checkCnt||"always"===c.getParameters().enableAlerter){const e=72;if(n.IS_CHROME&&(n.IS_MAC||n.IS_WIN)&&n.CHROME_MAJOR_VERSION&&n.CHROME_MAJOR_VERSION<e){let e=`您当前正在使用的Chrome浏览器版本为${n.CHROME_MAJOR_VERSION}, 不在NERTC的支持范围。请更新您的浏览器。<br/>您看到这条提示是因为您未调用 NERTC.checkSystemRequirements()，并且浏览器版本过低。`;this.alert(e);}}}),e.addListener("@connection-state-change",t=>{if("DISCONNECTING"===t.curState&&"CONNECTING"===t.prevState&&(e._events&&!e._events["connection-state-change"]&&!e._events.SOCKET_ERROR||"always"===c.getParameters().enableAlerter)){let e="由于网络原因，您当前已经退出房间。<br/>您看到这条提示是因为您未监听 connection-state-change 或 SOCKET_ERROR 事件，并且加入房间后意外退出了房间。";this.alert(e);}});}watchLocalStream(e){e.on("@notAllowedError",t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0});}});}watchRemoteStream(e){e.on("@notAllowedError",t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0});}});}}function h(){const e=c.getParameters().clients;for(let t=0;t<e.length;t++){const i=e[t];if(!i.destroyed)for(let e in i.adapterRef.remoteStreamMap){i.adapterRef.remoteStreamMap[e].resume();}}const t=c.getParameters().localStreams;for(let e=0;e<t.length;e++){const i=t[e];i.destroyed||i.resume();}const i=l.getAudioContext();"suspended"===(null==i?void 0:i.state)&&(e[0]&&e[0].logger.warn("尝试恢复 AudioContext"),i.resume());}t.alerter=new u;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.compatAudioInputList=void 0;const r=i(4);t.compatAudioInputList=new class{constructor(){this.enabled=r.getParameters().enableCompatAudio,this.compatTracks=[];}findSource(e){const t=this.compatTracks.find(t=>t.dest.id===e);return t?t.source:null}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encryptionModeToInt=t.EncryptionModes=t.Encryption=void 0;const s=i(10),a=r(i(149)),o={none:-1,"sm4-128-ecb":0};t.EncryptionModes=o,t.encryptionModeToInt=function(e){return "none"===e||"sm4-128-ecb"===e?o[e]:void 0};class n extends s.EventEmitter{constructor(e){super(),this.encryptionMode="none",this.encryptionSecret="",this.encodedInsertableStreams=!1,this.adapterRef=e;}setEncryptionMode(e){this.encryptionMode=e;}setEncryptionSecret(e){this.encryptionSecret=a.default(e);}handleUpstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("生成第一帧上行自定义加密（明文）。长度:",t.data.byteLength,e.mediaType,e.streamType),this.adapterRef.instance.safeEmit("sender-transform",{uid:this.adapterRef.channelInfo.uid,mediaType:e.mediaType,streamType:e.streamType,encodedFrame:t,controller:i});}handleDownstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("收到第一帧下行自定义加密（密文）。长度:",t.data.byteLength,e.uid,e.mediaType),"key"===t.type&&this.adapterRef.state.videoFirstIframeTime<this.adapterRef.state.signalJoinSuccessTime&&(this.adapterRef.state.videoFirstIframeTime=Date.now()),this.adapterRef.instance.safeEmit("receiver-transform",{uid:e.uid,mediaType:e.mediaType,encodedFrame:t,controller:i});}}t.Encryption=n;},function(e,t,i){var r,s,a,o,n;r=i(209),s=i(165).utf8,a=i(210),o=i(165).bin,(n=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?o.stringToBytes(e):s.stringToBytes(e):a(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var i=r.bytesToWords(e),d=8*e.length,c=1732584193,l=-271733879,u=-1732584194,h=271733878,p=0;p<i.length;p++)i[p]=16711935&(i[p]<<8|i[p]>>>24)|4278255360&(i[p]<<24|i[p]>>>8);i[d>>>5]|=128<<d%32,i[14+(d+64>>>9<<4)]=d;var m=n._ff,f=n._gg,g=n._hh,v=n._ii;for(p=0;p<i.length;p+=16){var y=c,S=l,_=u,R=h;c=m(c,l,u,h,i[p+0],7,-680876936),h=m(h,c,l,u,i[p+1],12,-389564586),u=m(u,h,c,l,i[p+2],17,606105819),l=m(l,u,h,c,i[p+3],22,-1044525330),c=m(c,l,u,h,i[p+4],7,-176418897),h=m(h,c,l,u,i[p+5],12,1200080426),u=m(u,h,c,l,i[p+6],17,-1473231341),l=m(l,u,h,c,i[p+7],22,-45705983),c=m(c,l,u,h,i[p+8],7,1770035416),h=m(h,c,l,u,i[p+9],12,-1958414417),u=m(u,h,c,l,i[p+10],17,-42063),l=m(l,u,h,c,i[p+11],22,-1990404162),c=m(c,l,u,h,i[p+12],7,1804603682),h=m(h,c,l,u,i[p+13],12,-40341101),u=m(u,h,c,l,i[p+14],17,-1502002290),c=f(c,l=m(l,u,h,c,i[p+15],22,1236535329),u,h,i[p+1],5,-165796510),h=f(h,c,l,u,i[p+6],9,-1069501632),u=f(u,h,c,l,i[p+11],14,643717713),l=f(l,u,h,c,i[p+0],20,-373897302),c=f(c,l,u,h,i[p+5],5,-701558691),h=f(h,c,l,u,i[p+10],9,38016083),u=f(u,h,c,l,i[p+15],14,-660478335),l=f(l,u,h,c,i[p+4],20,-405537848),c=f(c,l,u,h,i[p+9],5,568446438),h=f(h,c,l,u,i[p+14],9,-1019803690),u=f(u,h,c,l,i[p+3],14,-187363961),l=f(l,u,h,c,i[p+8],20,1163531501),c=f(c,l,u,h,i[p+13],5,-1444681467),h=f(h,c,l,u,i[p+2],9,-51403784),u=f(u,h,c,l,i[p+7],14,1735328473),c=g(c,l=f(l,u,h,c,i[p+12],20,-1926607734),u,h,i[p+5],4,-378558),h=g(h,c,l,u,i[p+8],11,-2022574463),u=g(u,h,c,l,i[p+11],16,1839030562),l=g(l,u,h,c,i[p+14],23,-35309556),c=g(c,l,u,h,i[p+1],4,-1530992060),h=g(h,c,l,u,i[p+4],11,1272893353),u=g(u,h,c,l,i[p+7],16,-155497632),l=g(l,u,h,c,i[p+10],23,-1094730640),c=g(c,l,u,h,i[p+13],4,681279174),h=g(h,c,l,u,i[p+0],11,-358537222),u=g(u,h,c,l,i[p+3],16,-722521979),l=g(l,u,h,c,i[p+6],23,76029189),c=g(c,l,u,h,i[p+9],4,-640364487),h=g(h,c,l,u,i[p+12],11,-421815835),u=g(u,h,c,l,i[p+15],16,530742520),c=v(c,l=g(l,u,h,c,i[p+2],23,-995338651),u,h,i[p+0],6,-198630844),h=v(h,c,l,u,i[p+7],10,1126891415),u=v(u,h,c,l,i[p+14],15,-1416354905),l=v(l,u,h,c,i[p+5],21,-57434055),c=v(c,l,u,h,i[p+12],6,1700485571),h=v(h,c,l,u,i[p+3],10,-1894986606),u=v(u,h,c,l,i[p+10],15,-1051523),l=v(l,u,h,c,i[p+1],21,-2054922799),c=v(c,l,u,h,i[p+8],6,1873313359),h=v(h,c,l,u,i[p+15],10,-30611744),u=v(u,h,c,l,i[p+6],15,-1560198380),l=v(l,u,h,c,i[p+13],21,1309151649),c=v(c,l,u,h,i[p+4],6,-145523070),h=v(h,c,l,u,i[p+11],10,-1120210379),u=v(u,h,c,l,i[p+2],15,718787259),l=v(l,u,h,c,i[p+9],21,-343485551),c=c+y>>>0,l=l+S>>>0,u=u+_>>>0,h=h+R>>>0;}return r.endian([c,l,u,h])})._ff=function(e,t,i,r,s,a,o){var n=e+(t&i|~t&r)+(s>>>0)+o;return (n<<a|n>>>32-a)+t},n._gg=function(e,t,i,r,s,a,o){var n=e+(t&r|i&~r)+(s>>>0)+o;return (n<<a|n>>>32-a)+t},n._hh=function(e,t,i,r,s,a,o){var n=e+(t^i^r)+(s>>>0)+o;return (n<<a|n>>>32-a)+t},n._ii=function(e,t,i,r,s,a,o){var n=e+(i^(t|~r))+(s>>>0)+o;return (n<<a|n>>>32-a)+t},n._blocksize=16,n._digestsize=16,e.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var i=r.wordsToBytes(n(e,t));return t&&t.asBytes?i:t&&t.asString?o.bytesToString(i):r.bytesToHex(i)};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Record=void 0;const n=i(10),d=o(i(12)),c=o(i(13)),l=a(i(24));class u extends n.EventEmitter{constructor(e){super(),this._status={recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null},this._recorder=null,this.logger=e.logger.getChild(()=>"recorder "+this._status.recordStatus),this._reset(),this.client=e.client;}get recoder(){return this._recorder}async start(e){const{stream:t=null,uid:i="0",type:r="video",reset:s=!1,recordName:a}=e;this.logger.log("开始本地录制: ",JSON.stringify(e,null,""));let o=null;if(!window.MediaRecorder||!MediaRecorder.isTypeSupported||!l.IS_CHROME)throw o="Record.start: 当前浏览器不支持本地录制",this.logger.warn(o),new c.default({code:d.default.RECORDING_NOT_SUPPORT,message:o});if(this._status.isRecording)throw o="Record.start: 操作异常, 当前正在录制中",this.logger.warn(o),new c.default({code:d.default.REPEAT_RECORDING_ERROR,message:o});if(this._status.recordUrl&&"downloaded"!==this._status.recordStatus){if(!e.reset)throw o="Record.start: 操作异常, 请先下载或重置上一段录制文件",this.logger.warn(o),new c.default({code:d.default.RECORDING_CACHE_ERROR,message:o});this.logger.warn("Record.start: 存在未下载视频，强制清除..."),await this.clean();}o&&this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:o,uid:i,mediaType:r,recordName:""},null," ")}),this._status.stream=t,this._status.option=e,this._status.fileName=this._getFilename(a),this._status.startTime=this._getTimeStamp();let n=["video/mp4;codecs=opus","video/webm","video/webm;codecs=h264","video/x-matroska;codecs=opus","video/invalid"];if("audio"===e.type&&(n=["audio/wav","audio/ogg","audio/pcm","audio/webm"]),!(this._status.mimeType=this._validation(n)[0]))return "RecordBrowserNotSupport";try{await this._format(),await this._start(),this.client.apiFrequencyControl({name:"startMediaRecording",code:0,param:JSON.stringify({uid:i,mediaType:r,recordName:""},null," ")});}catch(e){return this.logger.error("Record.start 内部异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:e.message,uid:i,mediaType:r,recordName:""},null," ")}),Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record.start: 录制异常 "+e.message}))}}stop(e){let t=null;return this._status.isRecording&&this._recorder||(this.logger.log("Record.stop 当前没有进行录制"),t="RecordNotExist"),this._recorder&&"started"!==this._status.state&&(this.logger.warn("Record.stop: record stopping when "+this._recorder.state),t="RecordStateError"),t?(e&&!1===e.isUser||this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""}),Promise.resolve()):(this._status.state="stopped",this._status.recordStatus="stopping",new Promise((t,i)=>{var r;this._status.fileName=this._status.fileName,this._recorder.onstop=()=>{this._onStop(t);},null===(r=null==this?void 0:this._recorder)||void 0===r||r.stop(),this.client.apiFrequencyControl({name:"stopMediaRecording",code:0,param:""}),e&&e.isUser&&this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""});}))}play(e){return "stopped"!==this._status.state?(this.client.apiFrequencyControl({name:"playMediaRecording",code:-1,param:JSON.stringify({reason:"RecordStateError"},null," ")}),this.logger.warn("MediaRecordHelper: record stopping when "+(this._recorder&&this._recorder.state)),Promise.resolve()):(this.client.apiFrequencyControl({name:"playMediaRecording",code:0,param:JSON.stringify({recordId:""},null," ")}),this._play(e))}download(e=!0){return Promise.resolve().then(()=>this._status.isRecording?(this.logger.log("Record.download: 正在录制中，立即停止..."),this.stop({isUser:!1})):Promise.resolve()).then(()=>{if(this._status.recordUrl){const e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=this._status.recordUrl,e.download=(this._status.fileName||this._getTimeStamp())+".webm",e.click(),this._status.recordStatus="downloaded";}else this.logger.log("Record.download: cannot download media without url ...");return e&&this.client.apiFrequencyControl({name:"downloadMediaRecording",code:0,param:""}),Promise.resolve(this._status)})}async clean(){this.client.apiFrequencyControl({name:"cleanMediaRecording",code:0,param:""}),this._status.isRecording&&this._recorder&&await this.stop(),this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._destroy(),this._status.recordStatus="init";}leave(e={uid:0}){if(!this._status.isRecording||!this._recorder)return Promise.resolve();const{uid:t}=e;return t&&this._status.option?t===+this._status.option.uid?this.stop():void 0:Promise.resolve()}pause(){this._recorder&&this._recorder.pause();}resume(){this._recorder&&this._recorder.resume();}_reset(){this._recorder=null,Object.assign(this._status,{recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null});}_getTimeStamp(){return Math.floor(Date.now()/1e3)}_getFilename(e){let t="";e&&(t+=e+"_");const i=new Date;return t+=`${i.getFullYear()}${(i.getMonth()+1).toString().padStart(2,"0")}${i.getDate().toString().padStart(2,"0")}`,t+=`${i.getHours().toString().padStart(2,"0")}${i.getMinutes().toString().padStart(2,"0")}${i.getSeconds().toString().padStart(2,"0")}${i.getMilliseconds().toString().padStart(3,"0")}`,t}_validation(e){return e.filter(e=>MediaRecorder.isTypeSupported(e))}_format(){let e=this._status.stream;this._status.option;return new Promise((t,i)=>{let r=new MediaStream;if(!e)return i(new c.default({code:d.default.RECORDING_ERROR,message:"Record._format: stream 未明确"}));if(this._matchLocalStreamConstructor(e.constructor.toString())&&(e=[e]),Array.isArray(e)){if(e.forEach(e=>{e&&this._matchLocalStreamConstructor(e.constructor.toString())&&e.getTracks().forEach(e=>{r.addTrack(e);});}),0===r.getTracks().length)return this.logger.error("_format: No tracks available"),t(r);this._status.opStream=r,t(r);}})}_matchLocalStreamConstructor(e){return /(LocalMediaStream|MediaStream)/.test(e)}_start(){let e={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:this._status.mimeType};if(!this._status.opStream)return Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record._start: opStream 未明确"}));const t=this._status.opStream.getAudioTracks();let i;i=t.length>1?new MediaStream([t[0]]):this._status.opStream;let r=this._recorder=new MediaRecorder(i,e);return r.ondataavailable=this._onDataAvailable.bind(this),r.onstop=()=>{this.logger.log("MediaRecordHelper: _start: record stop automatically ..."),this._onStop();},this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._status.recordedChunks=[],this._status.isRecording=!0,this._status.state="started",this._status.recordId+=1,this._status.recordStatus="starting",this._recorder.start(),this._clearTimer(),this._startTimer(),Promise.resolve(this._status.recordId)}_startTimer(){this._status.timer||(this._status.timer=setInterval(()=>{this.logger.log(`MediaRecordHelper: startTimer: ${(new Date).toLocaleString()} --\x3e MediaRecorder status: ${this._recorder&&this._recorder.state}`);},5e3));}_onStop(e){this.logger.log("MediaRecordHelper: _onStop: record stoped !!!"),this._clearTimer(),this._status.recordStatus="stopped",this._status.isRecording=!1,this._status.endTime=this._getTimeStamp();let t=new Blob(this._status.recordedChunks,{type:this._status.mimeType});this._status.recordUrl=URL.createObjectURL(t),this.emit("media-recording-stopped",this.getRecordStatus()),e&&e(this._status.fileName);}_play(e){let t=null;if(-1!=this._status.mimeType.indexOf("audio"))t=document.createElement("audio");else {if(-1==this._status.mimeType.indexOf("video"))return Promise.reject(new c.default({code:d.default.NOT_SUPPORT_ERROR,message:"_play: 当前浏览器不支持 MIME type "+this._status.mimeType}));t=document.createElement("video"),t.autoplay=!0;}return this._status.recordUrl?(e.appendChild(t),t.srcObject=null,t.src=this._status.recordUrl,t.controls=!1,t.play(),Promise.resolve(this._status.option)):Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record._play: 录制 url 未明确"}))}async _destroy(){this._status.audioController&&this._status.audioController.destroy(),this._status.isRecording&&await this.stop({isUser:!1}),this._clearTimer(),this._recorder=null,Object.assign(this._status,{stream:null,recordedChunks:[],isRecording:!1,audioController:null,status:"init"});}_clearTimer(){this._status.timer&&(clearInterval(this._status.timer),this._status.timer=null);}_onDataAvailable(e){if(this._status.recordStatus="recording",this.logger.log("MediaRecordHelper: ondataavailable: data received"),!(e.data.size>0))return this.logger.warn("MediaRecordHelper: ondataavailable: no data"),void this.stop();this._status.recordedChunks.push(e.data);}checkIsRecording(){return this._status.isRecording}getRecordStatus(){const e=Object.assign({id:this._status.recordId,type:this._status.mimeType,name:this._status.fileName,status:this._status.recordStatus,isRecording:this._status.isRecording,startTime:this._status.startTime,endTime:this._status.endTime},this._status.option);return this.client.apiFrequencyControl({name:"listMediaRecording",code:0,param:""}),e}destroy(){this._destroy();}}t.Record=u;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.applyCodecParameters=t.getCname=t.extractDtlsParameters=t.extractRtpCapabilities=void 0;const n=a(i(126)),d=o(i(12)),c=o(i(13));t.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,i=[];let r=!1,s=!1;for(const a of e.media){const e=a.type;switch(e){case"audio":if(r)continue;r=!0;break;case"video":if(s)continue;s=!0;break;default:continue}for(const i of a.rtp){const r={kind:e,mimeType:`${e}/${i.codec}`,preferredPayloadType:i.payload,clockRate:i.rate,channels:i.encoding,parameters:{},rtcpFeedback:[]};t.set(r.preferredPayloadType,r);}for(const e of a.fmtp||[]){const i=n.parseParams(e.config),r=t.get(e.payload);r&&(i&&i.hasOwnProperty("profile-level-id")&&(i["profile-level-id"]=String(i["profile-level-id"])),r.parameters=i);}for(const e of a.rtcpFb||[]){const i=t.get(e.payload);if(!i)continue;const r={type:e.type,parameter:e.subtype};r.parameter||delete r.parameter,i.rtcpFeedback.push(r);}for(const t of a.ext||[]){if(t["encrypt-uri"])continue;const r={kind:e,uri:t.uri,preferredId:t.value};i.push(r);}}return {codecs:Array.from(t.values()),headerExtensions:i}},t.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find(e=>e.iceUfrag&&0!==e.port);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"extractDtlsParameters: active media 未找到"});const i=t.fingerprint||e.fingerprint;let r;switch(t.setup){case"active":r="client";break;case"passive":r="server";break;case"actpass":r="auto";}return {role:r,fingerprints:[{algorithm:i.type,value:i.hash}]}},t.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find(e=>"cname"===e.attribute);return t?t.value:""},t.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const i of e.codecs){const e=i.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find(e=>e.payload===i.payloadType))continue;t.fmtp=t.fmtp||[];let r=t.fmtp.find(e=>e.payload===i.payloadType);r||(r={payload:i.payloadType,config:""},t.fmtp.push(r));const s=n.parseParams(r.config);switch(e){case"audio/opus":{const e=i.parameters["sprop-stereo"];void 0!==e&&(s.stereo=e?1:0);break}}r.config="";for(const e of Object.keys(s))r.config&&(r.config+=";"),r.config+=`${e}=${s[e]}`;}};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteSdp=void 0;const o=a(i(126)),n=i(4),d=i(56),c=i(225);t.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=r,this._plainRtpParameters=s,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[e-1].algorithm,hash:i.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}];}s&&(this._sdpObject.origin.address=s.ip,this._sdpObject.origin.ipVer=s.ipVersion);}updateIceParameters(e){d.Logger.debug("RemoteSdp","updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e);}updateDtlsRole(e){d.Logger.debug("RemoteSdp",`updateDtlsRole() [role: ${e}]`),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e);}getNextMediaSectionIdx(){if(n.getParameters().reuseMid)for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return {idx:e,reuseMid:t.mid}}return {idx:this._mediaSections.length}}send({offerMediaObjectArr:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s,extmapAllowMixed:a=!1}){e.length&&e.forEach((e,o)=>{if(!e)return;const n=new c.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s?s[o]:void 0,extmapAllowMixed:a});t?this._replaceMediaSection(n,t):this._addMediaSection(n);});}receive({mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s,reuseMid:a=null,reuseMediaSection:o}){const n=this._midToIndex.get(e);let d;void 0!==n&&(d=this._mediaSections[n]),d?(d=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),this._replaceMediaSection(d,e)):(d=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),null===a?this._addMediaSection(d):this._replaceMediaSection(d,a));}disableMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)return;this._mediaSections[t].disable();}closeMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)return;const i=this._mediaSections[t];e===this._firstMid&&d.Logger.debug("RemoteSdp","closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),i.close();}planBStopReceiving({mid:e,offerRtpParameters:t}){const i=this._midToIndex.get(e);if(void 0===i)return;const r=this._mediaSections[i];r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r);}sendSctpAssociation({offerMediaObject:e}){const t=new c.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t);}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new c.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t);}getSdp(){return this._sdpObject.origin.sessionVersion++,this._sdpObject.media.sort((function(e,t){return e.mid-t.mid})),o.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids();}_replaceMediaSection(e,t){if("string"==typeof t){const i=this._midToIndex.get(t);if(void 0===i)return;const r=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(r.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids();}else {const t=this._midToIndex.get(e.mid);if(void 0===t)return;this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject();}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "));}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addLegacySimulcast=t.getRtpEncodings=void 0;const s=r(i(12)),a=r(i(13));t.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const i of e.ssrcs||[]){const e=i.id;t.add(e);}if(0===t.size)throw new a.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"getRtpEncodings: a=ssrc 行未找到"});const i=new Map;for(const r of e.ssrcGroups||[]){if("FID"!==r.semantics)continue;let[e,s]=r.ssrcs.split(/\s+/);e=Number(e),s=Number(s),t.has(e)&&(t.delete(e),t.delete(s),i.set(e,s));}for(const e of t)i.set(e,null);const r=[];for(const[e,t]of i){const i={ssrc:e};t&&(i.rtx={ssrc:t}),r.push(i);}return r},t.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const i=(e.ssrcs||[]).find(e=>"msid"===e.attribute);if(!i)throw new a.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"addLegacySimulcast: a=ssrc 行的 msid 信息未找到"});const[r,o]=i.value.split(" "),n=i.id;let d;(e.ssrcGroups||[]).some(e=>{if("FID"!==e.semantics)return !1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===n&&(d=Number(t[1]),!0)});const c=e.ssrcs.find(e=>"cname"===e.attribute).value,l=[],u=[];for(let e=0;e<t;++e)l.push(n+e),d&&u.push(d+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:l.join(" ")});for(let t=0;t<l.length;++t){const i=l[t];e.ssrcs.push({id:i,attribute:"cname",value:c}),e.ssrcs.push({id:i,attribute:"msid",value:`${r} ${o}`});}for(let t=0;t<u.length;++t){const i=l[t],s=u[t];e.ssrcs.push({id:s,attribute:"cname",value:c}),e.ssrcs.push({id:s,attribute:"msid",value:`${r} ${o}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${s}`});}};},function(e,t,i){e.exports=u;var r,s=i(58),a=s.LongBits,o=s.base64,n=s.utf8;function d(e,t,i){this.fn=e,this.len=t,this.next=void 0,this.val=i;}function c(){}function l(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states;}function u(){this.len=0,this.head=new d(c,0,0),this.tail=this.head,this.states=null;}var h=function(){return s.Buffer?function(){return (u.create=function(){return new r})()}:function(){return new u}};function p(e,t,i){t[i]=255&e;}function m(e,t){this.len=e,this.next=void 0,this.val=t;}function f(e,t,i){for(;e.hi;)t[i++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[i++]=127&e.lo|128,e.lo=e.lo>>>7;t[i++]=e.lo;}function g(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24;}u.create=h(),u.alloc=function(e){return new s.Array(e)},s.Array!==Array&&(u.alloc=s.pool(u.alloc,s.Array.prototype.subarray)),u.prototype._push=function(e,t,i){return this.tail=this.tail.next=new d(e,t,i),this.len+=t,this},m.prototype=Object.create(d.prototype),m.prototype.fn=function(e,t,i){for(;e>127;)t[i++]=127&e|128,e>>>=7;t[i]=e;},u.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new m((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},u.prototype.int32=function(e){return e<0?this._push(f,10,a.fromNumber(e)):this.uint32(e)},u.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},u.prototype.uint64=function(e){var t=a.from(e);return this._push(f,t.length(),t)},u.prototype.int64=u.prototype.uint64,u.prototype.sint64=function(e){var t=a.from(e).zzEncode();return this._push(f,t.length(),t)},u.prototype.bool=function(e){return this._push(p,1,e?1:0)},u.prototype.fixed32=function(e){return this._push(g,4,e>>>0)},u.prototype.sfixed32=u.prototype.fixed32,u.prototype.fixed64=function(e){var t=a.from(e);return this._push(g,4,t.lo)._push(g,4,t.hi)},u.prototype.sfixed64=u.prototype.fixed64,u.prototype.float=function(e){return this._push(s.float.writeFloatLE,4,e)},u.prototype.double=function(e){return this._push(s.float.writeDoubleLE,8,e)};var v=s.Array.prototype.set?function(e,t,i){t.set(e,i);}:function(e,t,i){for(var r=0;r<e.length;++r)t[i+r]=e[r];};u.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(p,1,0);if(s.isString(e)){var i=u.alloc(t=o.length(e));o.decode(e,i,0),e=i;}return this.uint32(t)._push(v,t,e)},u.prototype.string=function(e){var t=n.length(e);return t?this.uint32(t)._push(n.write,t,e):this._push(p,1,0)},u.prototype.fork=function(){return this.states=new l(this),this.head=this.tail=new d(c,0,0),this.len=0,this},u.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new d(c,0,0),this.len=0),this},u.prototype.ldelim=function(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this},u.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t},u._configure=function(e){r=e,u.create=h(),r._configure();};},function(e,t,i){e.exports=d;var r,s=i(58),a=s.LongBits,o=s.utf8;function n(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function d(e){this.buf=e,this.pos=0,this.len=e.length;}var c,l="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new d(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new d(e);throw Error("illegal buffer")},u=function(){return s.Buffer?function(e){return (d.create=function(e){return s.Buffer.isBuffer(e)?new r(e):l(e)})(e)}:l};function h(){var e=new a(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw n(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw n(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return (e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function m(){if(this.pos+8>this.len)throw n(this,8);return new a(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}d.create=u(),d.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,d.prototype.uint32=(c=4294967295,function(){if(c=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return c;if((this.pos+=5)>this.len)throw this.pos=this.len,n(this,10);return c}),d.prototype.int32=function(){return 0|this.uint32()},d.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},d.prototype.bool=function(){return 0!==this.uint32()},d.prototype.fixed32=function(){if(this.pos+4>this.len)throw n(this,4);return p(this.buf,this.pos+=4)},d.prototype.sfixed32=function(){if(this.pos+4>this.len)throw n(this,4);return 0|p(this.buf,this.pos+=4)},d.prototype.float=function(){if(this.pos+4>this.len)throw n(this,4);var e=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},d.prototype.double=function(){if(this.pos+8>this.len)throw n(this,4);var e=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},d.prototype.bytes=function(){var e=this.uint32(),t=this.pos,i=this.pos+e;if(i>this.len)throw n(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,i):t===i?new this.buf.constructor(0):this._slice.call(this.buf,t,i)},d.prototype.string=function(){var e=this.bytes();return o.read(e,0,e.length)},d.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw n(this,e);this.pos+=e;}else do{if(this.pos>=this.len)throw n(this)}while(128&this.buf[this.pos++]);return this},d.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},d._configure=function(e){r=e,d.create=u(),r._configure();var t=s.Long?"toLong":"toNumber";s.merge(d.prototype,{int64:function(){return h.call(this)[t](!1)},uint64:function(){return h.call(this)[t](!0)},sint64:function(){return h.call(this).zzDecode()[t](!1)},fixed64:function(){return m.call(this)[t](!0)},sfixed64:function(){return m.call(this)[t](!1)}});};},function(e,t,i){e.exports=s;var r=i(58);function s(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)this[t[i]]=e[t[i]];}s.create=function(e){return this.$type.create(e)},s.encode=function(e,t){return this.$type.encode(e,t)},s.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},s.decode=function(e){return this.$type.decode(e)},s.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},s.verify=function(e){return this.$type.verify(e)},s.fromObject=function(e){return this.$type.fromObject(e)},s.toObject=function(e,t){return this.$type.toObject(e,t)},s.prototype.toJSON=function(){return this.$type.toObject(this,r.toJSONOptions)};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ajax=t.getFormData=void 0;const s=r(i(12)),a=r(i(13)),o=i(119);t.getFormData=e=>Object.keys(e).map(t=>encodeURIComponent(t)+"="+encodeURIComponent(/Object/i.test(e[t])?o.JSONBigStringify(e[t]):e[t])).join("&"),t.ajax=function(e){if(!e||!e.url)return Promise.reject(new a.default({code:s.default.NETWORK_REQUEST_ERROR,message:"ajax: 参数异常"}));e.dataType=e.dataType||"json";var i=new XMLHttpRequest;i.open(e.type||"GET",e.url,!0),i.responseType=""+e.dataType;const r=e.contentType||"application/json;charset=UTF-8";return i.setRequestHeader("Content-type",r),e.header&&Object.keys(e.header).map(t=>{e.header&&e.header[t]&&i.setRequestHeader(t,e.header[t]);}),new Promise((n,d)=>{i.onload=function(){if(i.status>400)return Promise.reject(new a.default({code:s.default.NETWORK_REQUEST_ERROR,message:"ajax: 响应异常, code: "+i.status}));var e=i.response;n(e);},i.onerror=function(e){d(e);},i.ontimeout=function(t){d({code:456,desc:"ERR_TIMED_OUT "+e.url});},r.indexOf("x-www-form-urlencoded")>=0?e.data?i.send(t.getFormData(e.data)):i.send():e.data?e.header&&"gzip"===e.header["Content-Encoding"]?i.send(e.data):i.send(o.JSONBigStringify(e.data)):i.send();})};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageBase=void 0;t.StageBase=class{constructor(e){this.enabled=!1,this.node=null,this.state="UNINIT",this.context=e;}isTransparent(){return !1}};},function(e,t,i){function r(e,t){return {ARRAY_BUFFER:e.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER:e.ELEMENT_ARRAY_BUFFER}[null!=t?t:"ARRAY_BUFFER"]}function s(e,t){return {STATIC_DRAW:e.STATIC_DRAW,DYNAMIC_DRAW:e.DYNAMIC_DRAW,STREAM_DRAW:e.STREAM_DRAW}[null!=t?t:"STATIC_DRAW"]}function a(e,t){const i={Int8Array:e.BYTE,Uint8Array:e.UNSIGNED_BYTE,Int16Array:e.SHORT,Uint16Array:e.UNSIGNED_SHORT,Int32Array:e.INT,Uint32Array:e.UNSIGNED_INT,Float32Array:e.FLOAT}[Object.prototype.toString.call(t).replace(/object|\[|\]|\s/g,"")];return void 0===i?(console.warn("attribute buffer type error.\n legal type may << Int8Array、Uint8Array、Int16Array、Uint16Array、Float32Array."),e.FLOAT):i}Object.defineProperty(t,"__esModule",{value:!0}),t.parseAttributes=t.createAttributeBuffer=void 0,t.createAttributeBuffer=function(e,t,i,o,n,d,c,l,u){const h=e.createBuffer();if(!h)return console.error("buffer created failed."),null;const p=i.length;return {type:a(e,i),buffer:h,name:t,typedArray:i,itemSize:null!=o?o:1,count:p/(null!=o?o:1)>>0,normalized:null!=c&&c,target:r(e,n),usage:s(e,d),stride:null!=l?l:0,offset:null!=u?u:0}},t.parseAttributes=function(e,t){const i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o={};for(let n=0;n<i;n++){const i=e.getActiveAttrib(t,n);if(i){const{name:n}=i,d=e.getAttribLocation(t,n);if(null!==d){const t={type:e.FLOAT,buffer:null,typedArray:null,itemSize:1,count:0,normalized:!1,target:r(e),usage:s(e),stride:0,offset:0,setter:i=>{if(i){const{buffer:r}=t;if(!r)return void console.error(`buffer of attribute:[${n}] is not initialized.`);const{type:s}=t;if(a(e,i)!==s)return void console.error(`typedArray's type of attribute:[${n}] is inconsistent.`);t.typedArray=i;const{itemSize:o,normalized:c,target:l,usage:u,stride:h,offset:p}=t;e.bindBuffer(l,r),e.bufferData(l,i,u),e.enableVertexAttribArray(d),e.vertexAttribPointer(d,o,s,c,h,p);}else {const{buffer:i,type:r,itemSize:s,normalized:a,target:o,stride:n,offset:c}=t;e.bindBuffer(o,i),e.vertexAttribPointer(d,s,r,a,n,c);}},bufferSetter:e=>{if(e){const{name:i}=e;i===n&&(t.type=e.type,t.buffer=e.buffer,t.itemSize=e.itemSize,t.count=e.count,t.normalized=e.normalized,t.target=e.target,t.usage=e.usage,t.stride=e.stride,t.offset=e.offset,t.setter(e.typedArray));}},get attributeBuffer(){return null===t.buffer?null:{type:t.type,buffer:t.buffer,name:n,typedArray:t.typedArray,itemSize:t.itemSize,count:t.count,normalized:t.normalized,target:t.target,usage:t.usage,stride:t.stride,offset:t.offset}}};o[n]=t;}else console.warn(`attribute:[${n}] is null.`);}}return o};},,,function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.checkSystemRequirements=t.systemChecker=void 0;t.systemChecker=new class{constructor(){this.checkCnt=0;}checkSystemRequirements(){this.checkCnt++;const e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;return e?e.prototype.getSenders&&e.prototype.addTransceiver&&e.prototype.getTransceivers?!!window.WebSocket||(console.warn("checkSystemRequirements: 没有 WebSocket 对象。"),!1):(console.warn("checkSystemRequirements: RTCPeerConnection不符合sdk要求"),!1):(console.warn("checkSystemRequirements: 没有 RTCPeerConnection 对象。"),!1)}},t.checkSystemRequirements=function(){return t.systemChecker.checkSystemRequirements()};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AuidoMixingState=void 0,t.AuidoMixingState={UNSTART:"MIX_UNSTART",STARTING:"MIX_STARTING",PLAYED:"MIX_PLAYING",PAUSED:"MIX_PAUSED",STOPED:"MIX_STOPED"};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isHttpProtocol=t.checkBrowserCompatibility=t.isBrowserSupported=t.isPullStreamSupported=t.isPushStreamSupported=t.RtcSupport=void 0;const o=i(117),n=i(71),d=a(i(24)),c=i(118);let l={isPullStreamSupport:!1,isPushStreamSupport:!1,isScreenShareSupport:!1},u={video:[],audio:[]},h={video:[],audio:[]};var p=null;d.IS_IOS&&d.IS_WECHAT||(p=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var m=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,f=window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,g=window.MediaStream=window.MediaStream||window.webkitMediaStream;function v(e){let t;return t||(t=document.createElement("video")),!!t.canPlayType({ogg:'video/ogg; codecs="theora"',h264:'video/mp4; codecs="avc1.42E01E"',webm:'video/webm; codecs="vp8, vorbis"',vp9:'video/webm; codecs="vp9"',hls:'application/x-mpegURL; codecs="avc1.42E01E"'}[e]||e)}const y={WebRTC:!!f&&!!g,RTCPeerConnection:!!f,Vp8:v("webm"),Vp9:v("vp9"),H264:v("h264"),GetUserMedia:!!p&&!!navigator.mediaDevices,DataChannel:!!(f&&"undefined"!=typeof RTCDataChannel&&f.prototype&&f.prototype.createDataChannel),WebAudio:!(!m||!m.prototype.createMediaStreamSource),MediaStream:!!g};function S(){let e=c.getBrowserInfo().browserName,t=c.getBrowserInfo().browserVersion;return t=t&&t.match(/\d+/)[0],{prefix:e,version:t}}const _={checkWebRtc:()=>y,checkWebAudio:()=>({WebAudio:y.WebAudio,MediaStream:y.MediaStream}),checkCompatibility(){let e=Object.assign(S(),{system:c.getOSInfo().osName+" "+c.getOSInfo().osVersion,browser:c.getBrowserInfo().browserName,version:c.getBrowserInfo().browserVersion});return new Promise((function(t,i){(async()=>{const i=Object.assign(e,y,{ScreenSharing:!1}),r=await o.Device.getDevices({audiooutput:!0,audioinput:!0,videoinput:!0,requestPerm:!0}).catch(e=>t(i));i.MicrophoneList=r&&r.audioIn||[],i.CameraList=r&&r.video||[],i.Microphone=r&&r.audioIn&&r.audioIn.length>0||!1,i.Camera=r&&r.video&&r.video.length>0||!1,t(i);})();}))},checkVersion:()=>S()};t.RtcSupport=_;const R=function(){return ["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection"].filter(e=>e in window).length>0},b=function(){return !!window.WebSocket&&!!window.WebSocket.prototype.send};async function T(){return await async function(){return !!u.video.length||(u=await n.getSupportedCodecs("send"),u.video.indexOf("H264")>-1||u.video.indexOf("VP8")>-1)}()&&R()&&b()&&function(){if(!navigator.mediaDevices)return !1;const e=["getUserMedia","enumerateDevices"];return e.filter(e=>e in navigator.mediaDevices).length===e.length}()&&async function(){return !!f.prototype.getStats||!!RTCRtpSender.prototype.getStats}()}async function E(){return await async function(){return !!h.video.length||(h=await n.getSupportedCodecs("recv"),h.video.indexOf("H264")>-1||h.video.indexOf("VP8")>-1)}()&&R()&&b()&&async function(){return !!f.prototype.getStats||!!RTCRtpReceiver.prototype.getStats}()}t.isPushStreamSupported=T,t.isPullStreamSupported=E;t.isBrowserSupported=function(){return !!(d.IS_CHROME&&d.CHROME_MAJOR_VERSION>=72)||(!!(d.IS_MAC_SAFARI&&d.SAFARI_MAJOR_VERSION>=12)||(!(!(d.IS_IOS_SAFARI&&d.SAFARI_MAJOR_VERSION>=13)||d.IS_WECHAT)||(!!(d.IS_EDG&&d.EDG_MAJOR_VERSION>=80)||(!!(d.IS_FIREFOX&&d.FIREFOX_MAJOR_VERSION>=66)||(!(!d.IS_IOS||!d.IS_MQQB)||(!!(d.IS_IOS&&d.IOS_VERSION&&parseFloat(d.IOS_VERSION)>=14.3&&d.IS_WECHAT&&d.WECHAT_VERSION&&parseFloat(d.WECHAT_VERSION)>=6.5)||!(!d.IS_ANDROID||!d.IS_TBS&&!d.IS_XWEB)))))))};t.checkBrowserCompatibility=async function(){const e=function(){if(d.IS_ELECTRON)return !0;{let e=navigator.mediaDevices;return !(!e||!e.getDisplayMedia)}}(),t=await T(),i=await E();return l.isScreenShareSupport=e,l.isPushStreamSupport=t,l.isPullStreamSupport=i,l};const A="file:"===location.protocol||"localhost"===location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);t.isHttpProtocol=function(){return "http:"===location.protocol&&!A};},function(e,t){var i={utf8:{stringToBytes:function(e){return i.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(i.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}};e.exports=i;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.parseScalabilityMode=t.Device=t.detectDevice=t.version=t.types=void 0;const o=i(167);Object.defineProperty(t,"detectDevice",{enumerable:!0,get:function(){return o.detectDevice}}),Object.defineProperty(t,"Device",{enumerable:!0,get:function(){return o.Device}});const n=a(i(230));t.types=n,t.version="__MEDIASOUP_CLIENT_VERSION__";var d=i(233);Object.defineProperty(t,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}});},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.detectDevice=void 0;const o=i(124),n=i(125),d=i(218),c=i(226),l=i(227),u=i(56),h=a(i(127)),p=i(170),m=a(i(72)),f=a(i(24)),g=i(118),v="Device";function y(){return "object"==typeof navigator&&"string"==typeof navigator.userAgent?f.IS_CHROME_ONLY&&f.CHROME_MAJOR_VERSION&&f.CHROME_MAJOR_VERSION>=72||f.IS_ANDROID||f.IS_ELECTRON&&f.IS_CHROME_ONLY&&f.ANY_CHROME_MAJOR_VERSION&&f.ANY_CHROME_MAJOR_VERSION>=72?"Chrome74":f.IS_FIREFOX&&f.FIREFOX_MAJOR_VERSION&&f.FIREFOX_MAJOR_VERSION>=60?"Firefox60":f.IS_ANY_SAFARI&&f.SAFARI_MAJOR_VERSION&&f.SAFARI_MAJOR_VERSION>=12||f.IS_ANY_SAFARI&&f.IS_WECHAT?"Safari12":(u.Logger.warn(v,"this._detectDevice() | browser not supported [name:%s, version:%s], using Chrome72 as default",g.getBrowserInfo().browserName,g.getBrowserInfo().browserVersion),"Chrome74"):(u.Logger.warn(v,"this._detectDevice() | unknown device, using Chrome 72 as default"),"Chrome74")}t.detectDevice=y;t.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new o.EnhancedEventEmitter,u.Logger.debug(v,"constructor()"),i){if(u.Logger.warn(v,"constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof i)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=i;}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else {if(e)u.Logger.debug(v,"constructor() | handler given: %s",e);else {if(!(e=y()))throw new n.UnsupportedError("device not supported");u.Logger.debug(v,"constructor() | detected handler: %s",e);}switch(e){case"Chrome74":this._handlerFactory=d.Chrome74.createFactory();break;case"Safari12":this._handlerFactory=l.Safari12.createFactory();break;case"Firefox60":this._handlerFactory=c.Firefox60.createFactory();break;default:u.Logger.warn(`unknown browser handlerName "${e}, using Chrome 74 as default"`),this._handlerFactory=d.Chrome74.createFactory();}}const r=this._handlerFactory();this._handlerName=r.name,r.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0;}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new n.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new n.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){let t;u.Logger.debug(v,"load()"),e=m.clone(e,void 0);try{if(this._loaded)throw new n.InvalidStateError("already loaded");h.validateRtpCapabilities(e),t=this._handlerFactory();const i=await t.getNativeRtpCapabilities();u.Logger.debug(v,"load() | got native RTP capabilities"),h.validateRtpCapabilities(i),this._extendedRtpCapabilities=h.getExtendedRtpCapabilities(i,e),u.Logger.debug(v,"load() | got extended RTP capabilities"),this._canProduceByKind.audio=h.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=h.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=h.getRecvRtpCapabilities(this._extendedRtpCapabilities),h.validateRtpCapabilities(this._recvRtpCapabilities),u.Logger.debug(v,"load() | got receiving RTP capabilities"),this._sctpCapabilities=await t.getNativeSctpCapabilities(),u.Logger.debug(v,"load() | got native SCTP capabilities"),h.validateSctpCapabilities(this._sctpCapabilities),u.Logger.debug(v,"load() succeeded"),this._loaded=!0,t.close();}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new n.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c={}}){return u.Logger.debug(v,"createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c={}}){return u.Logger.debug(v,"createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c})}_createTransport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u={}}){if(!this._loaded)throw new n.InvalidStateError("not loaded");if(u&&"object"!=typeof u)throw new TypeError("if given, appData must be an object");const h=new p.Transport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}};},function(e,t,i){var r,s="object"==typeof Reflect?Reflect:null,a=s&&"function"==typeof s.apply?s.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this);}e.exports=n,e.exports.once=function(e,t){return new Promise((function(i,r){function s(i){e.removeListener(t,a),r(i);}function a(){"function"==typeof e.removeListener&&e.removeListener("error",s),i([].slice.call(arguments));}v(e,t,a,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&v(e,"error",t,i);}(e,s,{once:!0});}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var d=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function u(e,t,i,r){var s,a,o,n;if(c(i),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),o=a[t]),void 0===o)o=a[t]=i,++e._eventsCount;else if("function"==typeof o?o=a[t]=r?[i,o]:[o,i]:r?o.unshift(i):o.push(i),(s=l(e))>0&&o.length>s&&!o.warned){o.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=o.length,n=d,console&&console.warn&&console.warn(n);}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=h.bind(r);return s.listener=i,r.wrapFn=s,s}function m(e,t,i){var r=e._events;if(void 0===r)return [];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(s):g(s,s.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function v(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else {if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(a){r.once&&e.removeEventListener(t,s),i(a);}));}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e;}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0;},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return l(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return !1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var n=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw n.context=o,n}var d=s[e];if(void 0===d)return !1;if("function"==typeof d)a(d,this,t);else {var c=d.length,l=g(d,c);for(i=0;i<c;++i)a(l[i],this,t);}return !0},n.prototype.addListener=function(e,t){return u(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return u(this,e,t,!0)},n.prototype.once=function(e,t){return c(t),this.on(e,p(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,p(this,e,t)),this},n.prototype.removeListener=function(e,t){var i,r,s,a,o;if(c(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){o=i[a].listener,s=a;break}if(s<0)return this;0===s?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop();}(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t);}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,a=Object.keys(i);for(r=0;r<a.length;++r)"removeListener"!==(s=a[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},n.prototype.listeners=function(e){return m(this,e,!0)},n.prototype.rawListeners=function(e){return m(this,e,!1)},n.listenerCount=function(e,t){return "function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]};},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return "extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return "imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return "simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return "ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s");}));}));},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Transport=void 0;const o=i(229),n=i(171),d=i(124),c=i(125),l=i(56),u=a(i(127)),h=i(172),p=a(i(72)),m="Transport";class f extends d.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:n,iceTransportPolicy:u,additionalSettings:h,proprietaryConstraints:f,appData:g,handlerFactory:v,extendedRtpCapabilities:y,canProduceByKind:S}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new o.AwaitQueue({ClosedErrorClass:c.InvalidStateError}),this._observer=new d.EnhancedEventEmitter,this.send=[],this.recv=[],l.Logger.debug(m,`constructor() [id: ${t}, direction: ${e}]`),this._id=t,this._direction=e,this._extendedRtpCapabilities=y,this._canProduceByKind=S,this._maxSctpMessageSize=a?a.maxMessageSize:null,delete(h=p.clone(h,{})).iceServers,delete h.iceTransportPolicy,delete h.bundlePolicy,delete h.rtcpMuxPolicy,delete h.sdpSemantics,this._handler=v(),this._handler.run({direction:e,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:n,iceTransportPolicy:u,additionalSettings:h,proprietaryConstraints:f,extendedRtpCapabilities:y,appData:g}),this._appData=g,this._handleHandler();}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){if(!this._closed){l.Logger.debug(m,"close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear(),this._observer.safeEmit("close");}}async getStats(){if(this._closed)throw new c.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(l.Logger.debug(m,"restartIce()"),this._closed)throw new c.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(l.Logger.debug(m,"updateIceServers()"),this._closed)throw new c.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._handler.updateIceServers(e)}async produce({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,stopTracks:a=!1,disableTrackOnPause:o=!0,zeroRtpOnPause:n=!1,appData:d}){if(l.Logger.debug(m,"produce()"),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new c.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new c.UnsupportedError("cannot produce "+e.kind);if("ended"===e.readyState)throw new c.InvalidStateError("track ended");if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(d&&"object"!=typeof d)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{let c;if(i&&!Array.isArray(i))throw TypeError("encodings must be an array");i&&0===i.length?c=void 0:i&&(c=i.map(e=>{const t={active:!0};return !1===e.active&&(t.active=!1),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"==typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t}));const{localId:l,localIdLow:p,rtpParameters:m,rtpSender:f,rtpSenderLow:g,dtlsParameters:v,offer:y}=await this._handler.send({track:e,trackLow:t,encodings:c,codecOptions:r,appData:d,codec:s});f&&this.updateSenderInfo(f,"screenShare"===d.mediaType?"screen":d.mediaType,"high",l),g&&p&&this.updateSenderInfo(g,"screenShare"===d.mediaType?"screen":d.mediaType,"low",p);try{u.validateRtpParameters(m);const{id:i}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:m,track:e,trackLow:t,appData:d,localDtlsParameters:v,offer:y}),r=new h.Producer({id:i,localId:l,localIdLow:p,rtpSender:f,rtpSenderLow:g,track:e,trackLow:t,rtpParameters:m,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:n,appData:d});return this._producers.set(r.id,r),this._handleProducer(r),this._observer.safeEmit("newproducer",r),r}catch(e){throw this._handler.stopSending(l,d.mediaType).catch(()=>{}),e}},"transport.produce()").catch(e=>{throw e})}async fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:o,codecOptions:n,offer:d,audioProfile:c,codec:l}){await this._handler.fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:o,codecOptions:n,offer:d,codec:l,audioProfile:c});}async prepareLocalSdp(e,t,i){try{const{dtlsParameters:r,rtpCapabilities:s,offer:a,mid:o,iceUfragReg:n}=await this._handler.prepareLocalSdp(e,i);if(!this._recvRtpCapabilities||!u.canSend("audio",this._recvRtpCapabilities)||!u.canSend("video",this._recvRtpCapabilities)){let e=u.getExtendedRtpCapabilities(s,t);this._recvRtpCapabilities=u.getRecvRtpCapabilities(e),u.validateRtpCapabilities(this._recvRtpCapabilities);}return {dtlsParameters:r,rtpCapabilities:this._recvRtpCapabilities,offer:a,mid:o,iceUfragReg:n}}catch(e){throw e}}async recoverLocalSdp(e,t,i){try{return void await this._handler.recoverTransceiver(e,t,i)}catch(e){throw e}}updateSenderInfo(e,t,i,r){let s=this.send.find(t=>t.sender===e);return s?(s.mediaType!==t||s.streamType||i||s.localId!==r)&&(l.Logger.debug(m,`Sender Change. mediaType:${s.mediaType} => ${t}, StreamType: ${s.streamType} => ${i}, LocalId: ${s.localId} => ${r} index: ${s.index}`),s.mediaType=t,s.streamType=i,s.localId=r,s.index=0):(s={sender:e,mediaType:t,streamType:i,localId:r,index:0},this.send.unshift(s)),s}updateReceiverInfo(e,t,i,r){let s=this.recv.find(t=>t.receiver===e);return s?s.uid===t&&s.mediaType===i&&s.localId===r||(l.Logger.debug(m,`Receiver Change. uid:${s.uid} => ${t}, mediaType:${s.mediaType} => ${i} localId: ${s.localId} => ${r} index: ${s.index}`),s.uid=t,s.mediaType=i,s.localId=r,s.index=0):(s={receiver:e,uid:t,mediaType:i,localId:r,index:0},this.recv.unshift(s)),s}async consume({id:e,producerId:t,kind:i,uid:r,mediaType:s,rtpParameters:a,appData:o={},offer:d,iceParameters:u,iceCandidates:h,dtlsParameters:f,sctpParameters:g,probeSSrc:v}){if(l.Logger.debug(m,"consume()"),a=p.clone(a,void 0),this._closed)throw new c.InvalidStateError("closed");if("recv"!==this._direction)throw new c.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==i&&"video"!==i)throw new TypeError(`invalid kind '${i}'`);if(o&&"object"!=typeof o)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{const{localId:c,rtpReceiver:l,track:p}=await this._handler.receive({iceParameters:u,iceCandidates:h,dtlsParameters:f,sctpParameters:g,trackId:e,kind:i,rtpParameters:a,offer:d,probeSSrc:v,remoteUid:o.remoteUid,extendedRtpCapabilities:this._extendedRtpCapabilities,appData:o});l&&this.updateReceiverInfo(l,r,s,c);const m=new n.Consumer({id:e,localId:c,producerId:t,rtpReceiver:l,track:p,rtpParameters:a,appData:o});return this._consumers.set(m.id,m),this._handleConsumer(m),this._observer.safeEmit("newconsumer",m),m},"transport.consume()")}_handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:e},t,i)=>{this._closed?i(new c.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,i);}),e.on("@connectionstatechange",e=>{e!==this._connectionState&&(l.Logger.debug(m,"connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e));});}_handleProducer(e){e.on("@close",()=>{this._closed||(l.Logger.warn(m,"producer 关闭: ",e.localId),this._awaitQueue.push(async()=>this._handler.stopSending(e.localId,e.appData.mediaType)).catch(e=>l.Logger.warn(m,"producer.close() failed:%o",e)));}),e.on("@replacetrack",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(r);}),e.on("@setmaxspatiallayer",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(r);}),e.on("@setrtpencodingparameters",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(r);}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new c.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i);});}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopReceiving(e.localId),"consumer @close event").catch(()=>{});}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new c.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i);});}}t.Transport=f;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Consumer=void 0;const r=i(124),s=i(125),a=i(56),o="Consumer";class n extends r.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:s,track:n,rtpParameters:d,appData:c}){super(),this._closed=!1,this._observer=new r.EnhancedEventEmitter,a.Logger.debug(o,"constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=s,this._track=n,this._rtpParameters=d,this._paused=!n.enabled,this._appData=c,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack();}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){this._closed||(a.Logger.debug(o,"close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"));}transportClosed(){this._closed||(a.Logger.debug(o,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"));}async getStats(){if(this._closed)throw new s.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){a.Logger.debug(o,"pause()"),this._closed?a.Logger.error(o,"pause() | Consumer closed"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"));}resume(){a.Logger.debug(o,"resume()"),this._closed?a.Logger.error(o,"resume() | Consumer closed"):(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume"));}_onTrackEnded(){a.Logger.debug(o,'track "ended" event, %o, %s',this.id,this.kind),this.safeEmit("trackended"),this._observer.safeEmit("trackended");}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded);}_destroyTrack(){a.Logger.debug(o,"don not stop receiver track");}}t.Consumer=n;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Producer=void 0;const o=a(i(24)),n=i(4),d=i(124),c=i(125),l=i(56),u="Producer";class h extends d.EnhancedEventEmitter{constructor({id:e,localId:t,localIdLow:i,rtpSender:r,rtpSenderLow:s,track:a,trackLow:o,rtpParameters:n,stopTracks:c,disableTrackOnPause:h,zeroRtpOnPause:p,appData:m}){super(),this._closed=!1,this._observer=new d.EnhancedEventEmitter,l.Logger.debug(u,"constructor()",t),this._id=e,this._localId=t,this._localIdLow=i,this._rtpSender=r,this._rtpSenderLow=s,this._track=a,this._trackLow=o,this._kind=a.kind,this._rtpParameters=n,this._paused=!!h&&!a.enabled,this._maxSpatialLayer=void 0,this._stopTracks=c,this._disableTrackOnPause=h,this._zeroRtpOnPause=p,this._appData=m,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack();}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){this._closed||(l.Logger.debug(u,"close()"),this._closed=!0,this.emit("@close"),this._observer.safeEmit("close"));}transportClosed(){this._closed||(l.Logger.debug(u,"transportClosed()"),this._closed=!0,this.safeEmit("transportclose"),this._observer.safeEmit("close"));}async getStats(){if(this._closed)throw new c.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){l.Logger.debug(u,"pause()"),this._closed?l.Logger.error(u,"pause() | Producer closed"):(this._paused=!0,o.SAFARI_VERSION&&15.1===parseFloat(o.SAFARI_VERSION)||this._disableTrackOnPause&&(this._track&&(this._track.enabled=!1),this._trackLow&&(this._trackLow.enabled=!1)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch(()=>{}),this._observer.safeEmit("pause"));}resume(){l.Logger.debug(u,"resume()"),this._closed?l.Logger.error(u,"resume() | Producer closed"):(this._paused=!1,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!0),this._trackLow&&(this._trackLow.enabled=!0)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch(()=>{}),this._observer.safeEmit("resume"));}async replaceTrack({track:e}){if(l.Logger.debug(u,"replaceTrack()"),this._closed){if(e&&this._stopTracks)try{if("audio"===e.kind){const t=n.getParameters().tracks.audio.findIndex(t=>e===t);l.Logger.warn(`Stopping AUDIOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`);}else {const t=n.getParameters().tracks.video.findIndex(t=>e===t);l.Logger.warn(`Stopping VIDEOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`);}e.stop();}catch(e){}throw new c.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new c.InvalidStateError("track ended");e!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):l.Logger.debug(u,"replaceTrack() | same track, ignored");}async setMaxSpatialLayer(e){if(this._closed)throw new c.InvalidStateError("closed");if("video"!==this._kind)throw new c.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e);}async setRtpEncodingParameters(e){if(this._closed)throw new c.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e);}_onTrackEnded(){l.Logger.debug(u,'track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended");}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded);}_destroyTrack(){this._track&&l.Logger.warn(u,"don not stop sender track");}}t.Producer=h;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getRTCTimer=void 0;const r=i(128);class s{constructor(e={from:{native:!0,worker:!0,webAudio:!0},minInterval:8}){this.history=[],this.timers=[void 0],this.worker=null,this.options=e;const t=e=>{const t={source:e,ts:Date.now()},i=this.history[this.history.length-1];if(!(i&&t.ts-i.ts<this.options.minInterval)){this.history.push(t),this.history.length>1e3&&this.history.shift();for(let e=0;e<this.timers.length;e++){const i=this.timers[e];if(i&&!(i.cntMax<=i.cnt||t.ts-i.lastCalledAt<i.interval-1)){i.cnt++,i.lastCalledAt=t.ts;try{i.handler();}catch(e){console.error(e);}}}}};e.from.native&&(this.nativeTimer=setInterval(()=>{t("native");},this.options.minInterval)),e.from.worker&&void 0!==typeof Worker&&(this.worker=new Worker(r.getBlobUrl("rtcTimer")),this.worker.onmessage=()=>{t("worker");});}setInterval(e,t){const i={handler:e,id:this.timers.length,interval:t,lastCalledAt:Date.now(),cnt:0,cntMax:Number.MAX_SAFE_INTEGER};return this.timers.push(i),i.id}clearInterval(e){if(!e)return;const t=this.timers[e];t&&(t.id===e?delete this.timers[e]:console.error("timer错位",e,t));}}let a=null;function o(){return a||(a=new s),a}t.getRTCTimer=o;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevel=void 0;const r=i(10),s=i(128),a=i(63);let o="NOTREADY",n=null;class d extends r.EventEmitter{constructor(e){super(),this.volume=0,this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.support=null,this.logger=e.logger.getChild(()=>{let e="AudioLevel";return e+="READY"!==o?" "+o:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e});const t=a.getAudioContext(),i=e.stream;t&&(this.support={stream:i,context:t},this.updateStream(i,e.sourceNode));}async updateStream(e,t){if(this.logger.log("AudioLevel updateStream"),this.support){if(!t)try{t=this.support.context.createMediaStreamSource(e);}catch(i){if("TypeError"!==i.name)return void this.logger.error("无法创建MediaStreamAudioSourceNode",i.name,i.message);t=new MediaStreamAudioSourceNode(this.support.context,{mediaStream:e});}if(this.support.sourceNode&&this.support.sourceNode.disconnect(),this.support.sourceNode=t,!this.support.audioWorkletNode){if(!this.support.context.audioWorklet)return void this.logger.error("该环境不支持音量模块");n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入音量模块"),n=this.support.context.audioWorklet.addModule(s.getBlobUrl("volumeProcessor")),await n,o="READY",this.logger.log("载入音量模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"vumeter"),this.support.audioWorkletNode.port.onmessage=e=>{var t,i;const r=Date.now(),s=Math.floor(r);if(this.volume=e.data.volume,e.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===s||this.left.history.unshift({sec:s,sum:0}),this.left.volume=e.data.left,this.left.history[0].sum+=e.data.left,this.left.history.length>2&&this.left.history.pop();else {const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}if(e.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===s||this.right.history.unshift({sec:s,sum:0}),this.right.volume=e.data.right,this.right.history[0].sum+=e.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(t=this.left)||void 0===t?void 0:t.history[1])&&(null===(i=this.right)||void 0===i?void 0:i.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}else {if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}}};}this.support.sourceNode.connect(this.support.audioWorkletNode);const i=a.getAudioLevelDestination();i&&this.support.audioWorkletNode.connect(i);}}getAudioLevel(){return this.volume}destroy(){this.logger.log("destroy() AudioLevel模块");}}t.AudioLevel=d;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DataReport=void 0;const r=i(62),s=i(24),a=i(247);let o="https://statistic.live.126.net/statics/report/common/form";t.DataReport=class{constructor(e){this.configs=e||{};const t=e.adapterRef;e.sdkRef;this.adapterRef=t;let i=t.instance,r=t.channelInfo||{};this.cid=r.cid||r.channelId||0,this.uid=r.uid||0;const a=i._params&&i._params.appkey;this.time=r.clientNtpTime-r.T4,this.common={name:"common",ver:"2.0",sdk_type:"nrtc2",session_id:this.adapterRef.deviceId,app_key:a},this.eventKeys=[],this.eventMap={},this.api=[],this.heartbeat=null;}addEvent(e,t){return -1==this.eventKeys.indexOf(e)&&this.eventKeys.push(e),t.time?t.time=t.time+this.time:(this.adapterRef.logger.warn(`addEvent:事件${e}没有time属性。使用当前时间戳`),t.time=Date.now()),this.eventMap[e]=t,this}updateCommon(e){return Object.assign(this.common,e),this}setHeartbeat(e){this.heartbeat=e;const t=Object.keys(this.adapterRef.apiEvent),i=Object.keys(this.adapterRef.apiEvents),r=t.concat(i.filter(e=>!t.includes(e)));let s=[];for(let e in r){const t=r[e];this.adapterRef.apiEvents[t]&&this.adapterRef.apiEvents[t].length?(s=s.concat(this.adapterRef.apiEvents[t]),this.adapterRef.apiEvents[t]=[]):this.adapterRef.apiEvent[t]&&this.adapterRef.apiEvent[t].length&&(s=s.concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[]);}return this.api=this.api.concat(s),this}setNetworkChange(e){return this.addEvent("networkChange",e),this}setLogin(e){var t,i,o;e.sdk_ver=e.sdk_ver||r.SDK_VERSION,e.platform=e.platform||"Web",e.app_key=e.app_key||this.common.app_key,e.meeting_mode=e.meeting_mode||1,e.model=e.model,e.build=r.BUILD,e.supported_codec_send=null===(t=this.adapterRef.mediaCapability.supportedCodecSend)||void 0===t?void 0:t.join(","),e.supported_codec_recv=null===(i=this.adapterRef.mediaCapability.supportedCodecRecv)||void 0===i?void 0:i.join(","),e.preferred_codec_send=null===(o=this.adapterRef.mediaCapability.preferredCodecSend.video)||void 0===o?void 0:o.join(","),e.extra_info=JSON.stringify({proc:a.processManager.processId,page:a.processManager.pageId,brow:a.processManager.browserId,userAgent:s.USER_AGENT}),e.lbs_addrs=this.adapterRef.lbsManager.getReportField("nrtc"),this.addEvent("login",e);}setRelogin(e){this.addEvent("relogin",e);}setLogout(e){this.addEvent("logout",e);}deviceAbnormal(e){this.addEvent("deviceAbnormal",e);}setDisconnect(e){this.addEvent("disconnect",e);}setRecvFirstFrame(e){this.addEvent("recvFirstFrame",e);}setSendFirstPackage(e){this.addEvent("firstPacketSent",e);}setRecvFirstPackage(e){this.addEvent("recvFirstPackage",e);}setFunction(e){this.addEvent("function",e);}setRequestLbs(e){this.addEvent("requestLBS",e);}setAudioVideoBanned(e){this.addEvent("audioVideoBanned",e);}setStreamException(e){this.addEvent("streamException",e);}setUserCustomEvent(e){this.addEvent("userCustomEvent",e);}reset(){this.eventKeys=[],this.api=[],this.heartbeat=null;}send(e){let t={common:this.common};if(e||(e=this.eventKeys),this.heartbeat&&(t.heartbeat=this.heartbeat,this.api.length&&(this.api.forEach(e=>{e.uid||(e.uid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid),e.cid||(e.cid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid),e.param&&"object"==typeof e.param&&void 0!==e.param.clientUid&&(e.param.clientUid=e.uid);}),t.event={apiEvent:this.api},this.api=[])),e){if(e.length){let i=0,r={};for(let t=e.length-1;t>=0;t--){const s=e[t];this.eventMap[s]&&(i++,r[s]=this.eventMap[s],delete this.eventMap[s],e.splice(t,1));}i&&(t.event=r);}}else if(!this.heartbeat)return this;return this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer&&(o=this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer),this.adapterRef.lbsManager.ajax({type:"post",url:o,data:t,header:{sdktype:this.common.sdk_type,appkey:this.common.app_key,platform:"web",sdkver:r.SDK_VERSION}}).then(t=>{e===this.eventKeys&&this.reset();}).catch(e=>{this.adapterRef.logger.log("dataReport, send error: ",e.name,e.message,e),this.reset();}),this}};},function(e,t,i){e.exports=i(251);},function(e,t,i){e.exports=function(e,t){var i=new Array(arguments.length-1),r=0,s=2,a=!0;for(;s<arguments.length;)i[r++]=arguments[s++];return new Promise((function(s,o){i[r]=function(e){if(a)if(a=!1,e)o(e);else {for(var t=new Array(arguments.length-1),i=0;i<t.length;)t[i++]=arguments[i];s.apply(null,t);}};try{e.apply(t||null,i);}catch(e){a&&(a=!1,o(e));}}))};},function(module,exports,__webpack_require__){function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire;},function(e,t,i){t.Service=i(261);},function(e,t,i){e.exports={};},function(e,t,i){e.exports=function(e){for(var t,i=a.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),n=e.fieldsArray.slice().sort(a.compareFieldsById),d=0;d<n.length;++d){var c=n[d].resolve(),l=e._fieldsArray.indexOf(c),u=c.resolvedType instanceof r?"int32":c.type,h=s.basic[u];t="m"+a.safeProp(c.name),c.map?(i("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",t,c.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(c.id<<3|2)>>>0,8|s.mapKey[c.keyType],c.keyType),void 0===h?i("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",l,t):i(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|h,u,t),i("}")("}")):c.repeated?(i("if(%s!=null&&%s.length){",t,t),c.packed&&void 0!==s.packed[u]?i("w.uint32(%i).fork()",(c.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",u,t)("w.ldelim()"):(i("for(var i=0;i<%s.length;++i)",t),void 0===h?o(i,c,l,t+"[i]"):i("w.uint32(%i).%s(%s[i])",(c.id<<3|h)>>>0,u,t)),i("}")):(c.optional&&i("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",t,c.name),void 0===h?o(i,c,l,t):i("w.uint32(%i).%s(%s)",(c.id<<3|h)>>>0,u,t));}return i("return w")};var r=i(59),s=i(130),a=i(25);function o(e,t,i,r){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",i,r,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",i,r,(t.id<<3|2)>>>0)}},function(e,t,i){e.exports=y;var r=i(129);((y.prototype=Object.create(r.prototype)).constructor=y).className="Type";var s=i(59),a=i(144),o=i(121),n=i(183),d=i(184),c=i(156),l=i(155),u=i(154),h=i(25),p=i(181),m=i(186),f=i(187),g=i(188),v=i(189);function y(e,t){r.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null;}function S(e){return e._fieldsById=e._fieldsArray=e._oneofsArray=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(y.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var i=this.fields[e[t]],r=i.id;if(this._fieldsById[r])throw Error("duplicate id "+r+" in "+this);this._fieldsById[r]=i;}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=h.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=h.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=y.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof c||((e.prototype=new c).constructor=e,h.merge(e.prototype,t)),e.$type=e.prototype.$type=this,h.merge(e,c,!0),this._ctor=e;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var r={};for(i=0;i<this.oneofsArray.length;++i)r[this._oneofsArray[i].resolve().name]={get:h.oneOfGetter(this._oneofsArray[i].oneof),set:h.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(e.prototype,r);}}}),y.generateConstructor=function(e){for(var t,i=h.codegen(["p"],e.name),r=0;r<e.fieldsArray.length;++r)(t=e._fieldsArray[r]).map?i("this%s={}",h.safeProp(t.name)):t.repeated&&i("this%s=[]",h.safeProp(t.name));return i("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},y.fromJSON=function(e,t){var i=new y(e,t.options);i.extensions=t.extensions,i.reserved=t.reserved;for(var c=Object.keys(t.fields),l=0;l<c.length;++l)i.add((void 0!==t.fields[c[l]].keyType?n.fromJSON:o.fromJSON)(c[l],t.fields[c[l]]));if(t.oneofs)for(c=Object.keys(t.oneofs),l=0;l<c.length;++l)i.add(a.fromJSON(c[l],t.oneofs[c[l]]));if(t.nested)for(c=Object.keys(t.nested),l=0;l<c.length;++l){var u=t.nested[c[l]];i.add((void 0!==u.id?o.fromJSON:void 0!==u.fields?y.fromJSON:void 0!==u.values?s.fromJSON:void 0!==u.methods?d.fromJSON:r.fromJSON)(c[l],u));}return t.extensions&&t.extensions.length&&(i.extensions=t.extensions),t.reserved&&t.reserved.length&&(i.reserved=t.reserved),t.group&&(i.group=!0),t.comment&&(i.comment=t.comment),i},y.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return h.toObject(["options",t&&t.options||void 0,"oneofs",r.arrayToJSON(this.oneofsArray,e),"fields",r.arrayToJSON(this.fieldsArray.filter((function(e){return !e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},y.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var i=this.oneofsArray;for(t=0;t<i.length;)i[t++].resolve();return r.prototype.resolveAll.call(this)},y.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},y.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof o&&void 0===e.extend){if(this._fieldsById?this._fieldsById[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),S(this)}return e instanceof a?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),S(this)):r.prototype.add.call(this,e)},y.prototype.remove=function(e){if(e instanceof o&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),S(this)}if(e instanceof a){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),S(this)}return r.prototype.remove.call(this,e)},y.prototype.isReservedId=function(e){return r.isReservedId(this.reserved,e)},y.prototype.isReservedName=function(e){return r.isReservedName(this.reserved,e)},y.prototype.create=function(e){return new this.ctor(e)},y.prototype.setup=function(){for(var e=this.fullName,t=[],i=0;i<this.fieldsArray.length;++i)t.push(this._fieldsArray[i].resolve().resolvedType);this.encode=p(this)({Writer:u,types:t,util:h}),this.decode=m(this)({Reader:l,types:t,util:h}),this.verify=f(this)({types:t,util:h}),this.fromObject=g.fromObject(this)({types:t,util:h}),this.toObject=g.toObject(this)({types:t,util:h});var r=v[e];if(r){var s=Object.create(this);s.fromObject=this.fromObject,this.fromObject=r.fromObject.bind(s),s.toObject=this.toObject,this.toObject=r.toObject.bind(s);}return this},y.prototype.encode=function(e,t){return this.setup().encode(e,t)},y.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},y.prototype.decode=function(e,t){return this.setup().decode(e,t)},y.prototype.decodeDelimited=function(e){return e instanceof l||(e=l.create(e)),this.decode(e,e.uint32())},y.prototype.verify=function(e){return this.setup().verify(e)},y.prototype.fromObject=function(e){return this.setup().fromObject(e)},y.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},y.d=function(e){return function(t){h.decorateType(t,e);}};},function(e,t,i){e.exports=o;var r=i(121);((o.prototype=Object.create(r.prototype)).constructor=o).className="MapField";var s=i(130),a=i(25);function o(e,t,i,s,o,n){if(r.call(this,e,t,s,void 0,void 0,o,n),!a.isString(i))throw TypeError("keyType must be a string");this.keyType=i,this.resolvedKeyType=null,this.map=!0;}o.fromJSON=function(e,t){return new o(e,t.id,t.keyType,t.type,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},o.prototype.resolve=function(){if(this.resolved)return this;if(void 0===s.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return r.prototype.resolve.call(this)},o.d=function(e,t,i){return "function"==typeof i?i=a.decorateType(i).name:i&&"object"==typeof i&&(i=a.decorateEnum(i).name),function(r,s){a.decorateType(r.constructor).add(new o(s,e,t,i));}};},function(e,t,i){e.exports=n;var r=i(129);((n.prototype=Object.create(r.prototype)).constructor=n).className="Service";var s=i(185),a=i(25),o=i(179);function n(e,t){r.call(this,e,t),this.methods={},this._methodsArray=null;}function d(e){return e._methodsArray=null,e}n.fromJSON=function(e,t){var i=new n(e,t.options);if(t.methods)for(var r=Object.keys(t.methods),a=0;a<r.length;++a)i.add(s.fromJSON(r[a],t.methods[r[a]]));return t.nested&&i.addJSON(t.nested),i.comment=t.comment,i},n.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return a.toObject(["options",t&&t.options||void 0,"methods",r.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},Object.defineProperty(n.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=a.toArray(this.methods))}}),n.prototype.get=function(e){return this.methods[e]||r.prototype.get.call(this,e)},n.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return r.prototype.resolve.call(this)},n.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof s?(this.methods[e.name]=e,e.parent=this,d(this)):r.prototype.add.call(this,e)},n.prototype.remove=function(e){if(e instanceof s){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,d(this)}return r.prototype.remove.call(this,e)},n.prototype.create=function(e,t,i){for(var r,s=new o.Service(e,t,i),n=0;n<this.methodsArray.length;++n){var d=a.lcFirst((r=this._methodsArray[n]).resolve().name).replace(/[^$\w_]/g,"");s[d]=a.codegen(["r","c"],a.isReserved(d)?d+"_":d)("return this.rpcCall(m,q,s,r,c)")({m:r,q:r.resolvedRequestType.ctor,s:r.resolvedResponseType.ctor});}return s};},function(e,t,i){e.exports=a;var r=i(120);((a.prototype=Object.create(r.prototype)).constructor=a).className="Method";var s=i(25);function a(e,t,i,a,o,n,d,c,l){if(s.isObject(o)?(d=o,o=n=void 0):s.isObject(n)&&(d=n,n=void 0),void 0!==t&&!s.isString(t))throw TypeError("type must be a string");if(!s.isString(i))throw TypeError("requestType must be a string");if(!s.isString(a))throw TypeError("responseType must be a string");r.call(this,e,d),this.type=t||"rpc",this.requestType=i,this.requestStream=!!o||void 0,this.responseType=a,this.responseStream=!!n||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=c,this.parsedOptions=l;}a.fromJSON=function(e,t){return new a(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment,t.parsedOptions)},a.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return s.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},a.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),r.prototype.resolve.call(this))};},function(e,t,i){e.exports=function(e){var t=a.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break");t("switch(t>>>3){");for(var i=0;i<e.fieldsArray.length;++i){var n=e._fieldsArray[i].resolve(),d=n.resolvedType instanceof r?"int32":n.type,c="m"+a.safeProp(n.name);t("case %i:",n.id),n.map?(t("if(%s===util.emptyObject)",c)("%s={}",c)("var c2 = r.uint32()+r.pos"),void 0!==s.defaults[n.keyType]?t("k=%j",s.defaults[n.keyType]):t("k=null"),void 0!==s.defaults[d]?t("value=%j",s.defaults[d]):t("value=null"),t("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",n.keyType)("case 2:"),void 0===s.basic[d]?t("value=types[%i].decode(r,r.uint32())",i):t("value=r.%s()",d),t("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==s.long[n.keyType]?t('%s[typeof k==="object"?util.longToHash(k):k]=value',c):t("%s[k]=value",c)):n.repeated?(t("if(!(%s&&%s.length))",c,c)("%s=[]",c),void 0!==s.packed[d]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",c,d)("}else"),void 0===s.basic[d]?t(n.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",c,i):t("%s.push(r.%s())",c,d)):void 0===s.basic[d]?t(n.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",c,i):t("%s=r.%s()",c,d),t("break");}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<e._fieldsArray.length;++i){var l=e._fieldsArray[i];l.required&&t("if(!m.hasOwnProperty(%j))",l.name)("throw util.ProtocolError(%j,{instance:m})",o(l));}return t("return m")};var r=i(59),s=i(130),a=i(25);function o(e){return "missing required '"+e.name+"'"}},function(e,t,i){e.exports=function(e){var t=s.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),i=e.oneofsArray,r={};i.length&&t("var p={}");for(var d=0;d<e.fieldsArray.length;++d){var c=e._fieldsArray[d].resolve(),l="m"+s.safeProp(c.name);if(c.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",l,c.name),c.map)t("if(!util.isObject(%s))",l)("return%j",a(c,"object"))("var k=Object.keys(%s)",l)("for(var i=0;i<k.length;++i){"),n(t,c,"k[i]"),o(t,c,d,l+"[k[i]]")("}");else if(c.repeated)t("if(!Array.isArray(%s))",l)("return%j",a(c,"array"))("for(var i=0;i<%s.length;++i){",l),o(t,c,d,l+"[i]")("}");else {if(c.partOf){var u=s.safeProp(c.partOf.name);1===r[c.partOf.name]&&t("if(p%s===1)",u)("return%j",c.partOf.name+": multiple values"),r[c.partOf.name]=1,t("p%s=1",u);}o(t,c,d,l);}c.optional&&t("}");}return t("return null")};var r=i(59),s=i(25);function a(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function o(e,t,i,s){if(t.resolvedType)if(t.resolvedType instanceof r){e("switch(%s){",s)("default:")("return%j",a(t,"enum value"));for(var o=Object.keys(t.resolvedType.values),n=0;n<o.length;++n)e("case %i:",t.resolvedType.values[o[n]]);e("break")("}");}else e("{")("var e=types[%i].verify(%s);",i,s)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",s)("return%j",a(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",s,s,s,s)("return%j",a(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',s)("return%j",a(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',s)("return%j",a(t,"boolean"));break;case"string":e("if(!util.isString(%s))",s)("return%j",a(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',s,s,s)("return%j",a(t,"buffer"));}return e}function n(e,t,i){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",i)("return%j",a(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",i)("return%j",a(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",i)("return%j",a(t,"boolean key"));}return e}},function(e,t,i){var r=t,s=i(59),a=i(25);function o(e,t,i,r){if(t.resolvedType)if(t.resolvedType instanceof s){e("switch(d%s){",r);for(var a=t.resolvedType.values,o=Object.keys(a),n=0;n<o.length;++n)t.repeated&&a[o[n]]===t.typeDefault&&e("default:"),e("case%j:",o[n])("case %i:",a[o[n]])("m%s=%j",r,a[o[n]])("break");e("}");}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,i,r);else {var d=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":d=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,d)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,d?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r);}}return e}function n(e,t,i,r){if(t.resolvedType)t.resolvedType instanceof s?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",r,i,r,r):e("d%s=types[%i].toObject(m%s,o)",r,i,r);else {var a=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":a=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,a?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r);}}return e}r.fromObject=function(e){var t=e.fieldsArray,i=a.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return i("return new this.ctor");i("var m=new this.ctor");for(var r=0;r<t.length;++r){var n=t[r].resolve(),d=a.safeProp(n.name);n.map?(i("if(d%s){",d)('if(typeof d%s!=="object")',d)("throw TypeError(%j)",n.fullName+": object expected")("m%s={}",d)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",d),o(i,n,r,d+"[ks[i]]")("}")("}")):n.repeated?(i("if(d%s){",d)("if(!Array.isArray(d%s))",d)("throw TypeError(%j)",n.fullName+": array expected")("m%s=[]",d)("for(var i=0;i<d%s.length;++i){",d),o(i,n,r,d+"[i]")("}")("}")):(n.resolvedType instanceof s||i("if(d%s!=null){",d),o(i,n,r,d),n.resolvedType instanceof s||i("}"));}return i("return m")},r.toObject=function(e){var t=e.fieldsArray.slice().sort(a.compareFieldsById);if(!t.length)return a.codegen()("return {}");for(var i=a.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),r=[],o=[],d=[],c=0;c<t.length;++c)t[c].partOf||(t[c].resolve().repeated?r:t[c].map?o:d).push(t[c]);if(r.length){for(i("if(o.arrays||o.defaults){"),c=0;c<r.length;++c)i("d%s=[]",a.safeProp(r[c].name));i("}");}if(o.length){for(i("if(o.objects||o.defaults){"),c=0;c<o.length;++c)i("d%s={}",a.safeProp(o[c].name));i("}");}if(d.length){for(i("if(o.defaults){"),c=0;c<d.length;++c){var l=d[c],u=a.safeProp(l.name);if(l.resolvedType instanceof s)i("d%s=o.enums===String?%j:%j",u,l.resolvedType.valuesById[l.typeDefault],l.typeDefault);else if(l.long)i("if(util.Long){")("var n=new util.Long(%i,%i,%j)",l.typeDefault.low,l.typeDefault.high,l.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",u)("}else")("d%s=o.longs===String?%j:%i",u,l.typeDefault.toString(),l.typeDefault.toNumber());else if(l.bytes){var h="["+Array.prototype.slice.call(l.typeDefault).join(",")+"]";i("if(o.bytes===String)d%s=%j",u,String.fromCharCode.apply(String,l.typeDefault))("else{")("d%s=%s",u,h)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",u,u)("}");}else i("d%s=%j",u,l.typeDefault);}i("}");}var p=!1;for(c=0;c<t.length;++c){l=t[c];var m=e._fieldsArray.indexOf(l);u=a.safeProp(l.name);l.map?(p||(p=!0,i("var ks2")),i("if(m%s&&(ks2=Object.keys(m%s)).length){",u,u)("d%s={}",u)("for(var j=0;j<ks2.length;++j){"),n(i,l,m,u+"[ks2[j]]")("}")):l.repeated?(i("if(m%s&&m%s.length){",u,u)("d%s=[]",u)("for(var j=0;j<m%s.length;++j){",u),n(i,l,m,u+"[j]")("}")):(i("if(m%s!=null&&m.hasOwnProperty(%j)){",u,l.name),n(i,l,m,u),l.partOf&&i("if(o.oneofs)")("d%s=%j",a.safeProp(l.partOf.name),l.name)),i("}");}return i("return d")};},function(e,t,i){var r=t,s=i(156);r[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=e["@type"].substring(e["@type"].lastIndexOf("/")+1),i=this.lookup(t);if(i){var r="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return -1===r.indexOf("/")&&(r="/"+r),this.create({type_url:r,value:i.encode(i.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){var i="",r="";if(t&&t.json&&e.type_url&&e.value){r=e.type_url.substring(e.type_url.lastIndexOf("/")+1),i=e.type_url.substring(0,e.type_url.lastIndexOf("/")+1);var a=this.lookup(r);a&&(e=a.decode(e.value));}if(!(e instanceof this.ctor)&&e instanceof s){var o=e.$type.toObject(e,t);return ""===i&&(i="type.googleapis.com/"),r=i+("."===e.$type.fullName[0]?e.$type.fullName.substr(1):e.$type.fullName),o["@type"]=r,o}return this.toObject(e,t)}};},function(e,t,i){e.exports=u;var r=i(129);((u.prototype=Object.create(r.prototype)).constructor=u).className="Root";var s,a,o,n=i(121),d=i(59),c=i(144),l=i(25);function u(e){r.call(this,"",e),this.deferred=[],this.files=[];}function h(){}u.fromJSON=function(e,t){return t||(t=new u),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},u.prototype.resolvePath=l.path.resolve,u.prototype.fetch=l.fetch,u.prototype.load=function e(t,i,r){"function"==typeof i&&(r=i,i=void 0);var s=this;if(!r)return l.asPromise(e,s,t,i);var n=r===h;function d(e,t){if(r){var i=r;if(r=null,n)throw e;i(e,t);}}function c(e){var t=e.lastIndexOf("google/protobuf/");if(t>-1){var i=e.substring(t);if(i in o)return i}return null}function u(e,t){try{if(l.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),l.isString(t)){a.filename=e;var r,o=a(t,s,i),u=0;if(o.imports)for(;u<o.imports.length;++u)(r=c(o.imports[u])||s.resolvePath(e,o.imports[u]))&&p(r);if(o.weakImports)for(u=0;u<o.weakImports.length;++u)(r=c(o.weakImports[u])||s.resolvePath(e,o.weakImports[u]))&&p(r,!0);}else s.setOptions(t.options).addJSON(t.nested);}catch(e){d(e);}n||m||d(null,s);}function p(e,t){if(!(s.files.indexOf(e)>-1))if(s.files.push(e),e in o)n?u(e,o[e]):(++m,setTimeout((function(){--m,u(e,o[e]);})));else if(n){var i;try{i=l.fs.readFileSync(e).toString("utf8");}catch(e){return void(t||d(e))}u(e,i);}else ++m,s.fetch(e,(function(i,a){--m,r&&(i?t?m||d(null,s):d(i):u(e,a));}));}var m=0;l.isString(t)&&(t=[t]);for(var f,g=0;g<t.length;++g)(f=s.resolvePath("",t[g]))&&p(f);if(n)return s;m||d(null,s);},u.prototype.loadSync=function(e,t){if(!l.isNode)throw Error("not supported");return this.load(e,t,h)},u.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return "'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return r.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function m(e,t){var i=t.parent.lookup(t.extend);if(i){var r=new n(t.fullName,t.id,t.type,t.rule,void 0,t.options);return r.declaringField=t,t.extensionField=r,i.add(r),!0}return !1}u.prototype._handleAdd=function(e){if(e instanceof n)void 0===e.extend||e.extensionField||m(0,e)||this.deferred.push(e);else if(e instanceof d)p.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof c)){if(e instanceof s)for(var t=0;t<this.deferred.length;)m(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var i=0;i<e.nestedArray.length;++i)this._handleAdd(e._nestedArray[i]);p.test(e.name)&&(e.parent[e.name]=e);}},u.prototype._handleRemove=function(e){if(e instanceof n){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else {var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1);}}else if(e instanceof d)p.test(e.name)&&delete e.parent[e.name];else if(e instanceof r){for(var i=0;i<e.nestedArray.length;++i)this._handleRemove(e._nestedArray[i]);p.test(e.name)&&delete e.parent[e.name];}},u._configure=function(e,t,i){s=e,a=t,o=i;};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHelper=void 0;const n=i(10),d=i(163),c=i(122),l=i(157),u=o(i(12)),h=o(i(13)),p=a(i(73)),m=i(73),f=i(65),g=i(272),v=a(i(24)),y=i(56),S=i(147),_=i(117),R=i(4),b=i(273),T=i(63),E=i(274);class A extends n.EventEmitter{constructor(e){super(),this.audio={audioStream:new MediaStream,audioSourceStream:new MediaStream,musicStream:new MediaStream,micStream:new MediaStream,pipeline:null,audioSource:null,micTrack:null,deviceInfo:{mic:{compatAudio:!1,label:""}},webAudio:null,micConstraint:null,mixAudioConf:{index:0,audioBuffer:{},sounds:{}},stageAIProcessing:null,audioRoutingEnabled:!1},this.video={videoStream:new MediaStream,renderStream:new MediaStream,low:null,cameraTrack:null,cameraConstraint:{video:{}},videoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:8e5,contentHint:null},low:{maxBitrate:1e5,contentHint:"motion"}}},this.screen={screenVideoStream:new MediaStream,renderStream:new MediaStream,low:null,screenVideoTrack:null,screenVideoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.screenAudio={screenAudioStream:new MediaStream,screenAudioTrack:null,screenAudioSource:null,pipeline:null},this.listenToTrackEnded=e=>{e&&e.addEventListener("ended",()=>{this.logger.log("Track ended",e.label,e.id),this.stream===this.stream.client.adapterRef.localStream&&(e!==this.audio.micTrack&&e!==this.audio.audioSource||(this.logger.warn("音频轨道已停止"),this.stream.client.safeEmit("audioTrackEnded"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"audioTrackEnded",mediaType:"audio"})),e!==this.video.cameraTrack&&e!==this.video.videoSource||(this.logger.warn("视频轨道已停止"),this.stream.client.safeEmit("videoTrackEnded"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"video"})),(e===this.screen.screenVideoTrack||e===this.screen.screenVideoSource||e.label.indexOf("screen")>-1||e.label.indexOf("window")>-1||e.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已停止"),this.stream.client.safeEmit("stopScreenSharing"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"screen"})),e===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已停止"),this.stream.client.safeEmit("stopScreenAudio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"stopScreenAudio",mediaType:"screenAudio"})));});},this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e;let t="mediaHelper";return this.audio.audioRoutingEnabled&&(t+=" WebAudio"),this.audio.webAudio&&(this.audio.webAudio.context&&"running"!==this.audio.webAudio.context.state&&(t+=" "+this.audio.webAudio.context.state),this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.UNSTART&&(t+=" "+(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf.state))),this.stream.mediaHelper!==this&&(t+="DETACHED"),t}),this.bindRenderStream(),_.Device.on("recording-device-changed",e=>{if(this.audio.micTrack&&this.audio.deviceInfo.mic.deviceId===e.device.deviceId)if("INACTIVE"===e.state)this.logger.error("当前使用的麦克风设备被移除，需重新启用设备",e.device),this.stream.emit("recording-device-changed",e);else {_.Device.deviceHistory.audioIn.find(e=>{e.groupId,this.audio.deviceInfo.mic.groupId;})||(this.logger.error(`当前麦克风已由【${this.audio.deviceInfo.mic.label}】切换至【${e.device.label}】，可能会影响通话质量`),this.audio.deviceInfo.mic.label=e.device.label,this.audio.deviceInfo.mic.groupId=e.device.groupId,this.stream.emit("recording-device-changed",e));}});}getOrCreateAudioPipeline(e="audio"){let t;const i=T.getAudioContext();if(!i)return this.logger.error("getOrCreateAudioPipeline: AudioContext is not supported"),null;if("audio"===e)if(this.audio.pipeline?t=this.audio.pipeline:(t=new E.AudioPipeline({logger:this.logger,outputStream:this.audio.audioStream,context:i}),this.audio.pipeline=t,this.logger.log("getOrCreateAudioPipeline: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.audio.micTrack&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("remote",this.audio.micTrack,"remote"+this.stream.streamID));else {const e=this.audio.micTrack||this.audio.audioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"));}else if(this.screenAudio.pipeline?t=this.screenAudio.pipeline:(t=new E.AudioPipeline({logger:this.logger,outputStream:this.screenAudio.screenAudioStream,context:i}),this.screenAudio.pipeline=t,this.logger.log("getOrCreateAudioPipeline/screenAudio: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.screenAudio.screenAudioTrack&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("remote",this.screenAudio.screenAudioTrack,`remote${this.stream.streamID}/screenAudio`));else {const e=this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"));}return t}bindRenderStream(){v.IS_SAFARI&&"safari"===R.getParameters().shimLocalCanvas||"all"===R.getParameters().shimLocalCanvas?(this.video.videoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=g.pcCloneTrack(e.track);m.watchTrack(t),this.logger.warn("renderStream cloned track for video:",e.track,t),m.emptyStreamWith(this.video.renderStream,t);}else m.emptyStreamWith(this.video.renderStream,e.track);},this.video.videoStream.onremovetrack=e=>{m.emptyStreamWith(this.video.renderStream,null);},this.screen.screenVideoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=g.pcCloneTrack(e.track);m.watchTrack(t),this.logger.warn("renderStream cloned track for screen:",e.track,t),m.emptyStreamWith(this.screen.renderStream,t);}else m.emptyStreamWith(this.screen.renderStream,e.track);},this.screen.screenVideoStream.onremovetrack=e=>{m.emptyStreamWith(this.screen.renderStream,null);}):(this.video.renderStream=this.video.videoStream,this.screen.renderStream=this.screen.screenVideoStream);}assertLive(){if(!this.stream.isRemote&&!this.stream.isRemote&&this.stream.destroyed){throw this._reset(),new h.default({code:u.default.LOCALSTREAM_NOT_FOUND_ERROR,message:"assertLive: localStream 已经销毁"})}}_reset(){this.stopAllEffects(),this.stream.isRemote||(this.audio.webAudio&&(this.audio.webAudio.off("audioFilePlaybackCompleted"),this.audio.webAudio.destroy()),this.audio.webAudio=null,this.audio.micConstraint=null,this.audio.audioRoutingEnabled=!1,this.audio.micTrack&&(this.audio.micTrack.stop(),this.audio.micTrack=null),this.video.low&&(this.video.low.destroy(),this.video.low=null),this.video.videoSource=null,this.video.cameraTrack&&(this.video.cameraTrack.stop(),this.video.cameraTrack=null),this.screen.screenVideoTrack&&(this.screen.screenVideoTrack.stop(),this.screen.screenVideoTrack=null),this.video.cameraConstraint={video:{}},this.screenAudio.screenAudioTrack&&(this.screenAudio.screenAudioTrack.stop(),this.screenAudio.screenAudioTrack=null),this.audio.mixAudioConf={index:0,audioBuffer:{},sounds:{}}),m.emptyStreamWith(this.audio.audioStream,null),m.emptyStreamWith(this.audio.musicStream,null),m.emptyStreamWith(this.audio.micStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null),m.emptyStreamWith(this.video.videoStream,null),m.emptyStreamWith(this.screen.screenVideoStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null);}updateWebAudio(){var e,t;if(!this.audio.webAudio){this.audio.webAudio=new T.WebAudio({mediaHelper:this,logger:this.logger}),this.audio.webAudio.on("audioFilePlaybackCompleted",this._audioFilePlaybackCompletedEvent.bind(this));const i=null===(t=null===(e=this.audio.webAudio)||void 0===e?void 0:e.musicDestination)||void 0===t?void 0:t.stream.getAudioTracks()[0];i&&m.emptyStreamWith(this.audio.musicStream,i);}this.audio.webAudio.updateTracks([{track:this.audio.micTrack||this.audio.audioSource,type:"microphone"}]);}async getScreenSource(e){const{width:t,height:i,frameRate:r}=this.screen.captureConfig.high;try{return await p.getScreenStream({video:{width:{ideal:t},height:{ideal:i},frameRate:{ideal:r,max:r}}},this.logger)}catch(e){const t="screen";return e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.stream.client.safeEmit("accessDenied",t):e.message&&e.message.indexOf("not found")>-1?this.stream.client.safeEmit("notFound",t):e.message&&e.message.indexOf("not start video source")>-1?this.stream.client.safeEmit("beOccupied",t):this.stream.client.safeEmit("deviceError",t),this.stream.emit("device-error",{type:t,error:e}),Promise.reject(e)}}getTrackByMediaType(e){return "audio"===e?this.audio.micTrack||this.audio.audioSource:"audioSlave"===e?this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource:"video"===e?this.video.cameraTrack||this.video.videoSource:"screen"===e?this.screen.screenVideoTrack||this.screen.screenVideoSource:null}async getStream(e){let{audio:t=!1,audioDeviceId:i="",video:r=!1,videoDeviceId:s="",screen:a=!1,sourceId:o="",screenAudio:n=!1,facingMode:d="",audioSource:c=null,videoSource:l=null,screenAudioSource:u=null,screenVideoSource:h=null,deviceId:f=""}=e;if(c&&(t=!0),l&&(r=!0),h&&(a=!0),u&&(n=!0),this.stream.isRemote)this.logger.error("getStream: 远端流不能够调用getStream");else if(t||r||a||n){if(c){if("ended"===c.readyState)return void this.logger.error("不应输入已经停止的轨道:",c.kind,c.label);m.watchTrack(c),this.audio.audioSource=c,m.emptyStreamWith(this.audio.audioSourceStream,c),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,c),this.updateAudioSender(c))),t=!1,this.stream.client.updateRecordingAudioStream();}if(l){if("ended"===l.readyState)return void this.logger.error("不应输入已经停止的轨道:",l.kind,l.label);m.watchTrack(l),this.video.videoSource=l,m.emptyStreamWith(this.video.videoStream,l),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),r=!1;}if(u){if("ended"===u.readyState)return void this.logger.error("不应输入已经停止的轨道:",u.kind,u.label);m.watchTrack(u),this.screenAudio.screenAudioSource=u,m.emptyStreamWith(this.screenAudio.screenAudioStream,u),this.listenToTrackEnded(this.screenAudio.screenAudioSource),m.emptyStreamWith(this.screenAudio.screenAudioStream,u),n=!1;}if(h){if("ended"===h.readyState)return void this.logger.error("不应输入已经停止的轨道:",h.kind,h.label);m.watchTrack(h),this.screen.screenVideoSource=h,m.emptyStreamWith(this.screen.screenVideoStream,h),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),a=!1;}try{if(a){const{width:e,height:i,frameRate:r}=this.screen.captureConfig.high;if(o){const t=(await p.getStream({video:{mandatory:{maxWidth:e,maxHeight:i,maxFrameRate:r,minFrameRate:5,chromeMediaSource:"desktop",chromeMediaSourceId:o}}},this.logger)).getVideoTracks()[0];this.screen.screenVideoTrack=t,m.emptyStreamWith(this.screen.screenVideoStream,t);}else {let t=await p.getScreenStream({video:{width:{ideal:e},height:{ideal:i},frameRate:{ideal:r,max:r}},audio:n&&this.getAudioConstraints("audioSlave")?this.getAudioConstraints("audioSlave"):n},this.logger);if(this.screen.screenVideoTrack=t.getVideoTracks()[0],this.listenToTrackEnded(this.screen.screenVideoTrack),m.emptyStreamWith(this.screen.screenVideoStream,this.screen.screenVideoTrack),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),n){const e=t.getAudioTracks()[0];e?(this.screenAudio.screenAudioTrack=e,m.emptyStreamWith(this.screenAudio.screenAudioStream,e),this.listenToTrackEnded(e),this.stream.client.apiEventReport("setFunction",{name:"pub_second_audio",oper:"1",value:JSON.stringify({result:"success",constaints:this.getAudioConstraints("audioSlave")},null," ")})):(this.logger.warn("getStream screenAudio: 未获取到屏幕共享音频"),this.stream.screenAudio=!1,this.stream.client.emit("error","screenAudioNotAllowed"));}}if(this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"success",constaints:{video:{width:{ideal:e},height:{ideal:i},frameRate:{ideal:r,max:r}},audio:n&&this.getAudioConstraints("audioSlave")?this.getAudioConstraints("audioSlave"):n}},null," ")}),t){let e=await p.getStream({audio:this.getAudioConstraints("audio")},this.logger);this.audio.micTrack=e.getAudioTracks()[0],m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=S.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){this.audio.deviceInfo.mic.compatAudio=!0;const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId;}else {this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId;}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:this.getAudioConstraints("audio")},null," ")});}}else if(n)this.logger.error("无法单独获取屏幕共享音频");else if(t||r){if(this.stream.isRemote)return void this.logger.error("MediaHelper.getStream:远端流不能调用getStream");const{height:e,width:a,frameRate:o}=this.video.captureConfig.high;let n={audio:t&&this.getAudioConstraints("audio")?this.getAudioConstraints("audio"):void 0,video:r?{width:{ideal:a},height:{ideal:e},frameRate:{ideal:o||15}}:void 0};i&&n.audio&&(n.audio.deviceId={exact:i}),n.video&&(d?n.video.facingMode={exact:d}:s&&(n.video.deviceId={exact:s}));const c=await p.getStream(n,this.logger),l=c.getVideoTracks()[0],u=c.getAudioTracks()[0];if(u){this.audio.micTrack=u,this.listenToTrackEnded(this.audio.micTrack),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const e=S.compatAudioInputList.findSource(this.audio.micTrack.id);if(e){this.audio.deviceInfo.mic.compatAudio=!0;const t=e.getSettings();this.audio.deviceInfo.mic.label=e.label,this.audio.deviceInfo.mic.deviceId=t.deviceId,this.audio.deviceInfo.mic.groupId=t.groupId;}else {this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId;}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:n.audio},null," ")}),"object"==typeof n.audio&&(this.audio.micConstraint={audio:n.audio}),this.stream.client.updateRecordingAudioStream();}l&&(this.video.cameraTrack=l,m.emptyStreamWith(this.video.videoStream,l),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.listenToTrackEnded(this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:n.video})}),"object"==typeof n.video&&(this.video.cameraConstraint={video:n.video}));}this.assertLive();}catch(e){this.logger.error("getStream error:",e.name,e.message);let i="audio";return t&&this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")}),r&&(i="video",this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")})),a&&(i="screen",this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")})),"NotAllowedError"===e.name?this.stream.client.safeEmit("accessDenied",i):"NotFoundError"===e.name?this.stream.client.safeEmit("notFound",i):"NotReadableError"===e.name?this.stream.client.safeEmit("beOccupied",i):"OverconstrainedError"===e.name&&this.stream.client.safeEmit("deviceError",i),this.stream.emit("device-error",{type:i,error:e}),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:`getUserMediaError: ${e.name} + ${e.message}`,mediaType:i}),Promise.reject(e)}}else this.logger.error("getStream: 必须指定媒体类型");}async getSecondStream(e){let{audio:t=!1,video:i=!1}=e;if(!this.stream.isRemote)try{const t=await p.getStream(e,this.logger),i=t.getAudioTracks()[0],r=t.getVideoTracks()[0];if(this.logger.log(`getSecondStream: ${i?i.label:""} ${r?r.label:""}`),i){"object"==typeof e.audio&&(this.audio.micConstraint={audio:e.audio}),this.audio.micTrack=i,this._stopTrack(this.audio.micStream),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=S.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){this.audio.deviceInfo.mic.compatAudio=!0;const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId;}else {this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId;}this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:e.audio},null," ")});}if(r){"object"==typeof e.video&&(this.video.cameraConstraint={video:e.video}),this.video.cameraTrack=r,this._stopTrack(this.video.videoStream),m.emptyStreamWith(this.video.videoStream,this.video.cameraTrack),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:e.video},null," ")});const t=this.stream._play.video.view;t&&(await this.stream.play(t),"width"in this.stream.renderMode.local.video&&this.stream.setLocalRenderMode(this.stream.renderMode.local.video,"video"));const i=this.stream.getSender("video","high");(null==i?void 0:i.track)?i.replaceTrack(r):this.logger.warn("getSecondStream video: 此时未发布流");}}catch(e){this.logger.error("getStream error",e.message);const i=t?"set_mic":"set_camera";return this.stream.client.apiEventReport("setFunction",{name:i,oper:"1",value:JSON.stringify({result:"fail",reason:e.message},null," ")}),Promise.reject(e)}}convert(e){const t=e.resolution,i=e.frameRate;let r={width:640,height:480,frameRate:15};return 2===t?(r.width=320,r.height=180):4===t?(r.width=640,r.height=480):8===t||v.IS_IOS_SAFARI?(r.width=1280,r.height=720):16===t&&(r.width=1920,r.height=1080),i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_NORMAL?r.frameRate=15:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_5?r.frameRate=5:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_10?r.frameRate=10:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_15?r.frameRate=15:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_20?r.frameRate=20:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_25?r.frameRate=25:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_30&&(r.frameRate=30),r}getAudioConstraints(e){if(this.stream.isRemote)return void this.logger.error("Remote Stream dont have audio constraints");const t=this.stream.audioProcessing;let i={channelCount:"audio"===e?1:2};switch(t&&(void 0!==t.AEC&&(i.echoCancellation=t.AEC,i.googEchoCancellation=t.AEC,i.googEchoCancellation2=t.AEC),void 0!==t.ANS&&(i.noiseSuppression=t.ANS,i.googNoiseSuppression=t.ANS,i.googNoiseSuppression2=t.ANS),void 0!==t.AGC&&(i.autoGainControl=t.AGC,i.googAutoGainControl=t.AGC,i.googAutoGainControl2=t.AGC)),"audioSlave"===e&&(void 0===i.echoCancellation&&(i.echoCancellation=!1),void 0===i.noiseSuppression&&(i.noiseSuppression=!1),void 0===i.autoGainControl&&(i.autoGainControl=!1)),this.stream.audioProfile){case"standard_stereo":case"high_quality_stereo":i.googAutoGainControl=!1,i.googAutoGainControl2=!1,i.echoCancellation=!1,i.googNoiseSuppression=!1,i.channelCount=2;}return i}getTrackSettings(){const e={};try{if(this.audio.micTrack){const t=S.compatAudioInputList.findSource(this.audio.micTrack.id);e.mic=t?{compat:!0,settings:t.getSettings(),label:t.label,readyState:t.readyState}:{settings:this.audio.micTrack.getSettings(),label:this.audio.micTrack.label,readyState:this.audio.micTrack.readyState};}this.audio.audioSource&&(e.audioSource={settings:this.audio.audioSource.getSettings(),label:this.audio.audioSource.label,readyState:this.audio.audioSource.readyState}),this.video.cameraTrack&&(e.camera={settings:this.video.cameraTrack.getSettings(),label:this.video.cameraTrack.label,readyState:this.video.cameraTrack.readyState}),this.video.videoSource&&(e.videoSource={settings:this.video.videoSource.getSettings(),label:this.video.videoSource.label,readyState:this.video.videoSource.readyState}),this.screen.screenVideoTrack&&(e.screen={settings:this.screen.screenVideoTrack.getSettings(),label:this.screen.screenVideoTrack.label,readyState:this.screen.screenVideoTrack.readyState}),this.screen.screenVideoSource&&(e.screenVideoSource={settings:this.screen.screenVideoSource.getSettings(),label:this.screen.screenVideoSource.label,readyState:this.screen.screenVideoSource.readyState}),this.screenAudio.screenAudioTrack&&(e.screenAudio={settings:this.screenAudio.screenAudioTrack.getSettings(),label:this.screenAudio.screenAudioTrack.label,readyState:this.screenAudio.screenAudioTrack.readyState}),this.screenAudio.screenAudioSource&&(e.screenAudioSource={settings:this.screenAudio.screenAudioSource.getSettings(),label:this.screenAudio.screenAudioSource.label,readyState:this.screenAudio.screenAudioSource.readyState}),_.Device.deviceHistory.audioOut[0]&&(e.audioOutDefault=_.Device.deviceHistory.audioOut[0]);}catch(t){e.errName=t.name,e.errMessage=t.message;}return e}updateStream(e,t){"audio"===e?(this.audio.micTrack=t,m.emptyStreamWith(this.audio.audioStream,t),this.stream._play.audio.dom&&(this.stream._play.audio.dom.srcObject=this.audio.audioStream)):"audioSlave"===e?(this.screenAudio.screenAudioTrack=t,m.emptyStreamWith(this.screenAudio.screenAudioStream,t),this.stream._play.audioSlave.dom&&(this.stream._play.audioSlave.dom.srcObject=this.screenAudio.screenAudioStream)):"video"===e?(this.video.cameraTrack=t,m.emptyStreamWith(this.video.videoStream,t),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream._play.video.dom&&(this.stream._play.video.dom.srcObject=this.video.renderStream)):"screen"===e&&(this.screen.screenVideoTrack=t,m.emptyStreamWith(this.screen.screenVideoStream,t),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),this.stream._play.screen.dom&&(this.stream._play.screen.dom.srcObject=this.screen.renderStream));}stopStream(e){var t,i,r,s;let a="set_mic";"audio"===e?(null===(t=this.audio.micTrack)||void 0===t||t.stop(),this.audio.micTrack=null,m.emptyStreamWith(this.audio.micStream,null),this.audio.audioSource=null,m.emptyStreamWith(this.audio.audioSourceStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting()):"screenAudio"===e?(null===(i=this.screenAudio.screenAudioTrack)||void 0===i||i.stop(),this.screenAudio.screenAudioTrack=null,this.screenAudio.screenAudioSource=null,m.emptyStreamWith(this.screenAudio.screenAudioStream,null),a="pub_second_audio"):"video"===e?(a="set_camera",null===(r=this.video.cameraTrack)||void 0===r||r.stop(),this.video.cameraTrack=null,m.emptyStreamWith(this.video.videoStream,null)):"screen"===e&&(a="set_screen",null===(s=this.screen.screenVideoTrack)||void 0===s||s.stop(),this.screen.screenVideoTrack=null,m.emptyStreamWith(this.screen.screenVideoStream,null)),this.stream.client.apiEventReport("setFunction",{name:a,oper:"0",value:"success"});}_stopTrack(e){if(!e)return;if(this.stream.isRemote)return;this.logger.log("清除stream: ",e);const t=e.getTracks();this.logger.log("清除stream: ",...t),t&&0!==t.length&&t.forEach(t=>{if("audio"===t.kind){const e=R.getParameters().tracks.audio.findIndex(e=>t===e);y.Logger.warn(`Stopping AUDIOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`);}else {const e=R.getParameters().tracks.video.findIndex(e=>t===e);y.Logger.warn(`Stopping VIDEOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`);}t.stop(),e.removeTrack(t),this.audio.micTrack===t&&(this.audio.micTrack=null,this.audio.deviceInfo.mic={compatAudio:S.compatAudioInputList.enabled,label:""},this.updateWebAudio()),this.screenAudio.screenAudioTrack===t&&(this.screenAudio.screenAudioTrack=null,this.updateWebAudio()),this.video.cameraTrack===t&&(this.video.cameraTrack=null),this.screen.screenVideoTrack===t&&(this.screen.screenVideoTrack=null);});}getAudioTrack(){var e;return null===(e=this.audio)||void 0===e?void 0:e.audioStream.getAudioTracks()[0]}getVideoTrack(){var e;return null===(e=this.video)||void 0===e?void 0:e.videoStream.getVideoTracks()[0]}setGain(e,t){this.audio.webAudio?(this.logger.log("setGain",e),this.audio.webAudio.setGain(e,t),this.canDisableAudioRouting()&&this.disableAudioRouting()):this.logger.log("setGain: 缺失本地音频");}getGain(){var e;return (null===(e=this.audio.webAudio)||void 0===e?void 0:e.getVolumeData())||"0.0"}canDisableAudioRouting(){var e;let t=!0;if(!this.audio.webAudio)return !1;if(null===(e=this.audio.stageAIProcessing)||void 0===e?void 0:e.enabled)return !1;this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PLAYED&&this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED||(t=!1),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"STARTING"!==e.state&&"PLAYED"!==e.state&&"PAUSED"!==e.state||(t=!1);});const i=this.audio.webAudio.getGainMin();return t&&1===i&&this.audio.webAudio.audioInArr.length<=1}_audioFilePlaybackCompletedEvent(){this.canDisableAudioRouting()&&this.disableAudioRouting();}startAudioMixing(e){let t,i;return this.logger.log("开始伴音:",JSON.stringify(e,null," ")),Object.assign(this.audio.mixAudioConf,e),this.audio.mixAudioConf.audioFilePath?0!==this.getAudioInputTracks().length&&this.stream.pubStatus.audio.audio?this.audio.webAudio&&this.audio.webAudio.context||(i="startAudioMixing() 浏览器环境不支持伴音",t=u.default.AUDIO_MIX_NO_SUPPORT):(i="startAudioMixing() 当前没有开启过麦克风",t=u.default.AUDIO_MIX_NO_AUDIO):(i="startAudioMixing() 没有设置云端文件路径",t=u.default.AUDIO_MIX_FILE_ERROR),t?(this.logger.error(i),this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),Promise.reject(new h.default({code:t,message:i}))):(this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED&&(this.logger.log("startAudioMixing() 当前已经开启伴音，先关闭之前的伴音"),this.stopAudioMixing()),this.audio.webAudio.mixAudioConf.state,d.AuidoMixingState.STARTING),this.audio.mixAudioConf.audioFilePath&&this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]?(this.logger.log("startAudioMixing() 开始伴音, 已经加载过云端音乐"),this.startMix(this.audio.mixAudioConf.index)):(this.logger.log("startAudioMixing() 开始伴音, 先加载云端音乐"),this.loadRemoteAudioFile(this.audio.mixAudioConf.index)))}loadRemoteAudioFile(e){const t=this.audio.mixAudioConf.audioFilePath;return t?l.ajax({url:t,type:"GET",dataType:"arraybuffer"}).then(i=>(this.logger.log("loadRemoteAudioFile 加载云端音乐成功"),new Promise((r,s)=>{var a,o;null===(o=null===(a=this.audio.webAudio)||void 0===a?void 0:a.context)||void 0===o||o.decodeAudioData(i,i=>{var s;this.logger.log("loadRemoteAudioFile 云端音乐解码成功"),this.audio.mixAudioConf.audioBuffer[t]=i,null===(s=this.startMix(e))||void 0===s||s.then(e=>{r(e);});},e=>{s(new h.default({code:u.default.AUDIO_MIX_FILE_ERROR,message:"loadRemoteAudioFile: 云端音乐解码失败: "+e.message}));});}))).catch(e=>Promise.reject(new h.default({code:u.default.AUDIO_MIX_FILE_ERROR,message:`loadRemoteAudioFile: 加载云端音乐失败: ${e.name} ${e.message}`}))):(this.logger.warn("loadRemoteAudioFile() audioFilePath未设置"),Promise.resolve())}startMix(e){var t;if(this.logger.log("startMix 开始混音:",JSON.stringify(this.audio.mixAudioConf)),e!==this.audio.mixAudioConf.index)return this.logger.log("startMix: 该次伴音已经取消"),Promise.resolve();this.audio.audioRoutingEnabled||this.enableAudioRouting();const{audioFilePath:i="",loopback:r=!1,replace:s=!1,cycle:a=0,playStartTime:o=0,volume:n=255,auidoMixingEnd:d=null}=this.audio.mixAudioConf;return null===(t=this.audio.webAudio)||void 0===t?void 0:t.startMix({buffer:this.audio.mixAudioConf.audioBuffer[i],loopback:r,replace:s,cycle:a,playStartTime:o,volume:n,auidoMixingEnd:d})}stopAudioMixing(e=!0){var t;return (null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio.stopAudioMixing(e)):(this.logger.error("stopAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"stopAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"})))}pauseAudioMixing(){var e;return (null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED?(this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&this.audio.webAudio.pauseAudioMixing()):(this.logger.error("pauseAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"pauseAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"pauseAudioMixing() 当前没有开启伴音"})))}resumeAudioMixing(){var e;let t,i;if((null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED&&(i="resumeAudioMixing() 当前没有暂停伴音",t=u.default.AUDIO_MIX_NOT_PAUSE):(i="resumeAudioMixing() 当前没有开启伴音",t=u.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:t?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:i||""}),null," ")}),t)return this.logger.error(i),Promise.reject(new h.default({code:t,message:i}));if(!this.audio.webAudio)return;let{audioFilePath:r="",loopback:s=!1,replace:a=!1,cycle:o=0,playStartTime:n=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf,l=(this.audio.webAudio.mixAudioConf.pauseTime-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;return l>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime)),o-=Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=o),this.audio.webAudio.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.audio.webAudio.mixAudioConf.setPlayStartTime),n=this.audio.webAudio.mixAudioConf.setPlayStartTime,this.audio.webAudio.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",JSON.stringify(this.audio.webAudio.mixAudioConf)),this.logger.log("已经播放的时间: ",l),l>this.audio.webAudio.mixAudioConf.totalTime&&(l%=this.audio.webAudio.mixAudioConf.totalTime),n=l),this.logger.log("回复重置的时间点：",n),this.audio.webAudio.resumeAudioMixing({buffer:this.audio.mixAudioConf.audioBuffer[r],loopback:s,replace:a,cycle:o,playStartTime:n,auidoMixingEnd:c})}setAudioMixingVolume(e){var t;let i,r;return (null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(!Number.isInteger(e)||e<0||e>255)&&(r="adjustAudioMixingVolume() volume应该是1-255的number类型",i=u.default.AUDIO_MIX_VOLUME_ERROR):(r="adjustAudioMixingVolume() 当前没有开启伴音",i=u.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:i?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:r||"",volume:e}),null," ")}),i?(this.logger.error(r),Promise.reject(new h.default({code:i,message:r}))):this.audio.webAudio&&this.audio.webAudio.setAudioMixingVolume(e)}setAudioMixingPlayTime(e){var t;let i,r;if((null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource){if(e<0)r="setAudioMixingPosition(): 设置的playStartTime 小于 0 了",i=u.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(e>=this.audio.webAudio.mixAudioConf.totalTime)r="setAudioMixingPosition(): 设置的playStartTime大于音频文件总时长了",i=u.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PAUSED)return this.audio.webAudio.mixAudioConf.setPlayStartTime=e,this.logger.log("setAudioMixingPosition() 当前正在暂停，记录设置的播发位置，在恢复伴音时，跳转到此次设置的播放位置: ",e),Promise.resolve()}else r="setAudioMixingPosition(): 当前没有开启伴音",i=u.default.AUDIO_MIX_NOT_STATE_ERROR;return this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:i?-1:0,param:JSON.stringify({playTime:e,reason:r||""},null," ")}),i?(this.logger.error(r),Promise.reject(new h.default({code:i,message:r}))):new Promise((t,i)=>{this.stopAudioMixing(!1).then(r=>{if(!this.audio.webAudio)return;this.audio.mixAudioConf.playStartTime=e;let{audioFilePath:s="",loopback:a=!1,replace:o=!1,cycle:n=0,playStartTime:d=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf;this.logger.log("设置混音的播放位置:",this.audio.webAudio.mixAudioConf);let l=(Date.now()-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;this.logger.log("已经播放的时间: ",l),l>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime)),n-=Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=n),this.logger.log(`setAudioMixingPlayTime, playTime: ${e}, cycle: ${n}`),this.audio.webAudio.setAudioMixingPlayTime({buffer:this.audio.mixAudioConf.audioBuffer[s],loopback:a,replace:o,cycle:n,playStartTime:d,auidoMixingEnd:c}).then(i=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:0,param:JSON.stringify({playTime:e},null," ")}),t(i);}).catch(t=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"重新播放伴音失败"+t.message},null," ")}),i(t);});}).catch(t=>(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"暂停当前播放失败"+t.message},null," ")}),Promise.reject(t)));})}getAudioMixingPlayedTime(){var e,t;return (null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingCurrentPosition",code:0,param:JSON.stringify({playTime:null===(t=this.audio.webAudio.getAudioMixingPlayedTime())||void 0===t?void 0:t.playedTime},null," ")}),this.audio.webAudio.getAudioMixingPlayedTime()):(this.logger.log("getAudioMixingCurrentPosition() 当前没有开启伴音"),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingCurrentPosition() 当前没有开启伴音"})))}getAudioMixingTotalTime(){var e,t;return (null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingDuration",code:0,param:JSON.stringify({totalTime:null===(t=this.audio.webAudio.getAudioMixingTotalTime())||void 0===t?void 0:t.totalTime},null," ")}),this.audio.webAudio.getAudioMixingTotalTime()):(this.logger.log("getAudioMixingDuration() 当前没有开启伴音"),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingDuration() 当前没有开启伴音"})))}isMixAuido(){return !!(this.audio.webAudio&&this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource)}_initSoundIfNotExists(e,t){this.audio.mixAudioConf.sounds[e]||(this.audio.mixAudioConf.sounds[e]={soundId:e,state:"UNSTART",filePath:t||"",volume:100,sourceNode:null,gainNode:null,cycle:1,playStartTime:0,playOverTime:0,pauseTime:0,startTime:0,totalTime:0,options:{}}),t&&(this.audio.mixAudioConf.sounds[e].filePath=t);}async playEffect(e,t){const{soundId:i,filePath:r,cycle:s=1}=e,a={tag:"Stream.playEffect:filePath",value:r};f.checkExists(a);const o={tag:"Stream.playEffect:soundId",value:i,min:1,max:1e4};f.isExistOptions(o).result&&f.checkValidInteger(o);const n={tag:"Stream.playEffect:cycle",value:s,min:1,max:1e4};if(f.isExistOptions(n).result&&f.checkValidInteger(n),this._initSoundIfNotExists(i,r),this.audio.audioRoutingEnabled||this.enableAudioRouting(),!this.audio.webAudio||!this.audio.webAudio.context)return this.logger.log("playEffect() 浏览器不支持"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_NO_SUPPORT,message:"playEffect() 当前浏览器不支持音效功能"}));if(!this.audio.mixAudioConf.sounds[i]||"STARTING"!==this.audio.mixAudioConf.sounds[i].state&&"PLAYED"!==this.audio.mixAudioConf.sounds[i].state&&"PAUSED"!==this.audio.mixAudioConf.sounds[i].state){if(0===this.getAudioInputTracks().length||!this.stream.pubStatus.audio.audio)return Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_NO_AUDIO,message:"playEffect() 当前没有开启麦克风，无法使用音效功能"}))}else if(this.logger.log(`pauseEffect: 该音效文件正处于: ${this.audio.mixAudioConf.sounds[i].state} 状态`),void 0===t)return Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_ERROR,message:"playEffect() playStartTime 异常"}));this.audio.mixAudioConf.sounds[i].state="STARTING",this.audio.mixAudioConf.audioBuffer[r]?this.logger.log("playEffect: 已经 load 音效文件"):(this.logger.log("playEffect, 先 load 音效文件"),await this.preloadEffect(i,r));try{const a=this.audio.webAudio.createAudioBufferSource(this.audio.mixAudioConf.audioBuffer[r]);this.audio.mixAudioConf.sounds[i].sourceNode=a.sourceNode,a&&a.sourceNode&&(a.sourceNode.onended=e=>{this.stopEffect(i);}),this.audio.mixAudioConf.sounds[i].gainNode=a.gainNode,this.audio.mixAudioConf.sounds[i].totalTime=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration,this.audio.mixAudioConf.sounds[i].cycle=s;const o=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration;this.audio.mixAudioConf.sounds[i].playOverTime=o,s>1&&(this.audio.mixAudioConf.sounds[i].playOverTime=s*o-this.audio.mixAudioConf.sounds[i].playStartTime),this.audio.mixAudioConf.sounds[i].playStartTime=t||0,this.audio.webAudio.startAudioEffectMix(this.audio.mixAudioConf.sounds[i]),this.audio.mixAudioConf.sounds[i].state="PLAYED",this.audio.mixAudioConf.sounds[i].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"playEffect",code:0,param:JSON.stringify(e,null," ")});}catch(e){}}async stopEffect(e){var t;const i={tag:"Stream.stopEffect:soundId",value:e};let r,s;if(f.isExistOptions(i).result&&f.checkValidInteger(i),this.audio.mixAudioConf.sounds[e]||(s="pauseEffect() soundId找不到对应的音效文件",r=u.default.AUDIO_EFFECT_FILE_LOST_ERROR),r)throw new h.default({code:r,message:s});null===(t=this.audio.webAudio)||void 0===t||t.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].state="STOPED",this._audioFilePlaybackCompletedEvent(),this.stream.client.apiFrequencyControl({name:"stopEffect",code:0,param:JSON.stringify(e,null," ")});}async pauseEffect(e){const t={tag:"Stream.pauseEffect:soundId",value:e};let i,r;if(f.isExistOptions(t).result&&f.checkValidInteger(t),this.audio.mixAudioConf.sounds[e]){if("PAUSED"===this.audio.mixAudioConf.sounds[e].state)return void this.logger.log("pauseEffect: 已经暂停");"PLAYED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("pauseEffect: 当前没有开启该音效"),r="pauseEffect() 当前没有开启该音效",i=u.default.AUDIO_EFFECT_NOT_STATE_ERROR);}else r="pauseEffect() soundId找不到对应的音效文件",i=u.default.AUDIO_EFFECT_FILE_LOST_ERROR;if(i)throw new h.default({code:i,message:r});if(!this.audio.webAudio)return;this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].pauseTime=Date.now(),this.audio.mixAudioConf.sounds[e].state="PAUSED";let s=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;this.logger.log("pauseEffect 已经播放的时间: ",s),s>this.audio.mixAudioConf.sounds[e].totalTime&&(s%=this.audio.mixAudioConf.sounds[e].totalTime),this.logger.log("pauseEffect 暂停位置: ",s),this.stream.client.apiFrequencyControl({name:"pauseEffect",code:0,param:JSON.stringify(e,null," ")});}async resumeEffect(e){const t={tag:"Stream.resumeEffect:soundId",value:e};let i,r;if(f.isExistOptions(t).result&&f.checkValidInteger(t),this.audio.mixAudioConf.sounds[e]?"PAUSED"!==this.audio.mixAudioConf.sounds[e].state&&(r="resumeEffect() 当前没有暂停该音效文件",i=u.default.AUDIO_EFFECT_NOT_PAUSE):(r="resumeEffect() soundId找不到对应的音效文件",i=u.default.AUDIO_EFFECT_FILE_LOST_ERROR),i)throw new h.default({code:i,message:r});if(!this.audio.webAudio)return;let s=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;if(this.logger.log("resumeEffect 已经播放的时间: ",s),s>this.audio.mixAudioConf.sounds[e].totalTime){const t=Math.floor(s/this.audio.mixAudioConf.sounds[e].totalTime);this.logger.log("播放过的圈数 playedCycle: ",t),s%=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle=this.audio.mixAudioConf.sounds[e].cycle-t;}this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle>1&&(this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].cycle*this.audio.mixAudioConf.sounds[e].totalTime-this.audio.mixAudioConf.sounds[e].playStartTime),s>this.audio.mixAudioConf.sounds[e].totalTime&&(s%=this.audio.mixAudioConf.sounds[e].totalTime),this.audio.mixAudioConf.sounds[e].playStartTime=s,this.logger.log("resumeEffect 回复重置的时间点：",s),this.playEffect({soundId:e,filePath:this.audio.mixAudioConf.sounds[e].filePath,cycle:this.audio.mixAudioConf.sounds[e].cycle},s),this.audio.mixAudioConf.sounds[e].state="PLAYED",this.audio.mixAudioConf.sounds[e].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"resumeEffect",code:0,param:JSON.stringify(e,null," ")});}async setVolumeOfEffect(e,t){var i;const r={tag:"Stream.setVolumeOfEffect:soundId",value:e,min:1};if(f.isExistOptions(r).result&&f.checkValidInteger(r),!this.audio.mixAudioConf.sounds[e])throw new h.default({code:u.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"resumeEffect() soundId找不到对应的音效文件"});const s={tag:"Stream.setVolumeOfEffect:volume",value:t,min:0,max:100};f.isExistOptions(s).result&&f.checkValidInteger(s),this.logger.log(`setVolumeOfEffect 设置 ${e} 音效文件的音量: ${t}`),this._initSoundIfNotExists(e);const a=null===(i=this.audio.mixAudioConf.sounds[e])||void 0===i?void 0:i.gainNode;a?a.gain.value=t/100:this.logger.log("setVolumeOfEffect: no gainNode"),this.audio.mixAudioConf.sounds[e].volume=t,this.stream.client.apiFrequencyControl({name:"setVolumeOfEffect",code:0,param:JSON.stringify({soundId:e,volume:t},null," ")});}async preloadEffect(e,t){const i={tag:"Stream.preloadEffect:filePath",value:t};f.checkExists(i);const r={tag:"Stream.preloadEffect:soundId",value:e};if(f.isExistOptions(r).result&&f.checkValidInteger(r),this.logger.log(`preloadEffect 设置soundId: ${e}, 音效文件的filePath: ${t}`),this._initSoundIfNotExists(e,t),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.audio.mixAudioConf.audioBuffer[t])this.logger.log("preloadEffect: 已经 load 音效文件");else try{await this.loadAudioBuffer(t),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:0,param:JSON.stringify({soundId:e,filePath:t},null," ")});}catch(e){throw this.logger.error("preloadEffect 错误: ",e.name,e.message),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:-1,param:JSON.stringify({reason:e.message},null," ")}),e}}async unloadEffect(e){const t={tag:"Stream.unloadEffect:soundId",value:e,min:1};return f.isExistOptions(t).result&&f.checkValidInteger(t),this.logger.log(`unloadEffect() ${e} 音效文件`),this.audio.mixAudioConf.sounds[e]?"UNSTART"!==this.audio.mixAudioConf.sounds[e].state&&"STOPED"!==this.audio.mixAudioConf.sounds[e].state?(this.logger.log("unloadEffect() 该音效文件正在播放"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_PLAY_ALREADY,message:"unloadEffect() 该音效文件正在播放"}))):(delete this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.sounds[e].filePath],delete this.audio.mixAudioConf.sounds[e],void this.stream.client.apiFrequencyControl({name:"unloadEffect",code:0,param:JSON.stringify({soundId:e},null," ")})):(this.logger.log("unloadEffect() 没有该音效文件"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"unloadEffect() soundId找不到对应的音效文件"})))}getEffectsVolume(){this.logger.log("getEffectsVolume()");const e=[];return Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{e.push({soundId:t.soundId,volume:t.volume});}),this.stream.client.apiFrequencyControl({name:"getEffectsVolume",code:0,param:JSON.stringify(e,null,2)}),e}setEffectsVolume(e){const t={tag:"Stream.setEffectsVolume:volume",value:e,min:0,max:100};f.isExistOptions(t).result&&f.checkValidInteger(t),this.logger.log("setEffectsVolume(), 设置音量: "+e),Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{this.setVolumeOfEffect(t.soundId,e);}),this.stream.client.apiFrequencyControl({name:"setEffectsVolume",code:0,param:JSON.stringify({volume:e},null,2)});}async stopAllEffects(){this.logger.log("stopAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"!==e.state&&"PAUSED"!==e.state||this.stopEffect(e.soundId);}),this.stream.client.apiFrequencyControl({name:"stopAllEffects",code:0,param:JSON.stringify("stopAllEffects",null,2)});}async pauseAllEffects(){this.logger.log("pauseAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"===e.state&&this.pauseEffect(e.soundId);}),this.stream.client.apiFrequencyControl({name:"pauseAllEffects",code:0,param:JSON.stringify("pauseAllEffects",null,2)});}async resumeAllEffects(){this.logger.log("resumeAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PAUSED"===e.state&&this.resumeEffect(e.soundId);}),this.stream.client.apiFrequencyControl({name:"resumeAllEffects",code:0,param:JSON.stringify("resumeAllEffects",null,2)});}getAudioEffectsTotalTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsDuration: 当前没有音效文件"),Promise.resolve();let s;return this._initSoundIfNotExists(t,i),"PLAYED"===this.audio.mixAudioConf.sounds[t].state&&(s=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsDuration",code:0,param:JSON.stringify({totalTime:s},null," ")}),s}getAudioEffectsPlayedTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsCurrentPosition() 当前没有音效文件"),Promise.resolve();this._initSoundIfNotExists(t,i);let s=Date.now();"PAUSED"==this.audio.mixAudioConf.sounds[t].state&&(this.logger.log("getAudioEffectsCurrentPosition() 当前是暂停状态"),s=this.audio.mixAudioConf.sounds[t].pauseTime);let a=(s-this.audio.mixAudioConf.sounds[t].startTime)/1e3+this.audio.mixAudioConf.sounds[t].playStartTime;return a>this.audio.mixAudioConf.sounds[t].totalTime&&(a%=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsCurrentPosition",code:0,param:JSON.stringify({playTime:a},null," ")}),{playedTime:a}}loadAudioBuffer(e){return l.ajax({url:e,type:"GET",dataType:"arraybuffer"}).then(t=>(this.logger.log("loadAudioBuffer 加载 audio file 成功"),new Promise((i,r)=>{var s,a;null===(a=null===(s=this.audio.webAudio)||void 0===s?void 0:s.context)||void 0===a||a.decodeAudioData(t,t=>{this.logger.log("loadAudioBuffer audio file 解码成功"),this.audio.mixAudioConf.audioBuffer[e]=t,i(t);},e=>{this.logger.log("loadAudioBuffer 云端音乐解码失败：",e.message),r(new h.default({code:u.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 云端音乐解码失败: ${e.name} ${e.message}`}));});}))).catch(e=>(this.logger.log("loadAudioBuffer 加载云端音乐失败: ",e),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 加载云端音乐失败: ${e.name} ${e.message}`}))))}getAudioInputTracks(){var e,t;let i=[];return "live"===(null===(e=this.audio.audioSource)||void 0===e?void 0:e.readyState)&&i.push(this.audio.audioSource),"live"===(null===(t=this.audio.micTrack)||void 0===t?void 0:t.readyState)&&i.push(this.audio.micTrack),i}getAudioSlaveInputTracks(){var e,t;let i=[];return "live"===(null===(e=this.screenAudio.screenAudioTrack)||void 0===e?void 0:e.readyState)&&i.push(this.screenAudio.screenAudioTrack),"live"===(null===(t=this.screenAudio.screenAudioSource)||void 0===t?void 0:t.readyState)&&i.push(this.screenAudio.screenAudioSource),i}enableAudioRouting(){if(this.audio.webAudio&&this.audio.webAudio.destination){this.audio.audioRoutingEnabled=!0;const e=this.audio.webAudio.destination.stream.getAudioTracks()[0];this.logger.log("enableAudioRouting: ",e.label);const t=this.audio.audioStream.getAudioTracks()[0];t&&(e.enabled=t.enabled,t.enabled=!0),m.emptyStreamWith(this.audio.audioStream,e),this.stream.audioLevelHelper&&this.stream.audioLevelHelper.updateStream(this.audio.audioStream),this.updateAudioSender(e);}else this.logger.log("enableAudioRouting: 已替换为Destination");}disableAudioRouting(){const e=this.getAudioInputTracks();if(e.length){1===e.length?this.logger.log("disableAudioRouting: ",e[0].label):this.logger.warn("disableAudioRouting: 仍然有多于一个输入",...e);const t=this.audio.audioStream.getAudioTracks()[0];m.emptyStreamWith(this.audio.audioStream,e[0]),e[0].enabled=t.enabled,t.enabled=!0,this.updateAudioSender(e[0]);}else this.logger.log("disableAudioRouting quiet."),m.emptyStreamWith(this.audio.audioStream,null);this.audio.audioRoutingEnabled=!1;}updateAudioSender(e){var t,i,r,s,a,o,n,d,c,l,u,h,p,m,f,g,v;if(this.stream.isRemote)throw new Error("updateAudioSender only for localStream");if(null===(i=null===(t=this.stream.getAdapterRef())||void 0===t?void 0:t._mediasoup)||void 0===i?void 0:i._micProducer)if(null===(a=null===(s=null===(r=this.stream.getAdapterRef())||void 0===r?void 0:r._mediasoup)||void 0===s?void 0:s._micProducer)||void 0===a?void 0:a._rtpSender)this.logger.info("updateAudioSender: 替换当前_micProducer的track",e.label),null===(c=null===(d=null===(n=null===(o=this.stream.getAdapterRef())||void 0===o?void 0:o._mediasoup)||void 0===n?void 0:n._micProducer)||void 0===d?void 0:d._rtpSender)||void 0===c||c.replaceTrack(e);else if(null===(p=null===(h=null===(u=null===(l=this.stream.getAdapterRef())||void 0===l?void 0:l._mediasoup)||void 0===u?void 0:u._sendTransport)||void 0===h?void 0:h.handler)||void 0===p?void 0:p._pc){const t=null===(g=null===(f=null===(m=this.stream.getAdapterRef())||void 0===m?void 0:m._mediasoup)||void 0===f?void 0:f._sendTransport)||void 0===g?void 0:g.handler._pc.audioSender;t&&(this.logger.info("updateAudioSender: 替换audioSender",null===(v=null==t?void 0:t.track)||void 0===v?void 0:v.label),t.replaceTrack(e));}}enablePreProcessing(e,t){b.enablePreProcessing(this,e,t);}disablePreProcessing(e,t=!1){b.disablePreProcessing(this,e,t);}canDisablePreProcessing(e){return b.canDisablePreProcessing(this,e)}getPreprocessingStats(e="video"){var t;const i=null===(t=this[e].preProcessing)||void 0===t?void 0:t.history;if(!(null==i?void 0:i.length))return null;const r=i[i.length-1].endTs-i[0].startTs,s={total:0};for(let e=0;e<i.length;e++){s.total+=i[e].endTs-i[e].startTs;for(let t of i[e].handlerTs)t.spent>0&&(s[t.name]||(s[t.name]=0),s[t.name]+=t.spent);}return {fps:1e3*i.length/r,load:s.total/r,delay:s.total/i.length,spent:s}}destroy(){this.logger.log("清除 meida"),this._reset();}}t.MediaHelper=A;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageAIProcessing=void 0;const r=i(158),s=i(278);class a extends r.StageBase{constructor(e,t){super(e),this.type="stageAIProcessing",this.node=null,this.audioWorkletAgent=null,this.AIDenoise=null,this.enableAIDenoise=!0,this.pluginList=[],this.logger=t,this.enabled=!1;}hasPlugin(e){return -1!==this.pluginList.indexOf(e)}registerPlugin(e,t,i){"AIDenoise"===e&&(this.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"));}registerAIDenoisePlugin(e,t){this.AIDenoise=e;}async init(){var e;this.state="INITING",this.audioWorkletAgent||(this.audioWorkletAgent=new s.AudioWorkletAgent({logger:this.logger,context:this.context}),this.node=this.audioWorkletAgent.node,await this.audioWorkletAgent.init(),this.audioWorkletAgent.on("rawinputs",e=>{this.enabled&&this.AIDenoise&&this.AIDenoise.load&&this.AIDenoise.process(e.inputs[0],t=>{t.length&&(e.inputs[0]=t),this.audioWorkletAgent.outputData(e.inputs[0]);});})),null===(e=this.AIDenoise)||void 0===e||e.init(),this.state="INITED";}unregisterAIDenoise(){this.AIDenoise&&(this.AIDenoise.destroy(),this.AIDenoise=null),this.state="UNINIT";}}t.StageAIProcessing=a;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Play=void 0;const s=i(10),a=i(64),o=r(i(12)),n=r(i(13)),d=i(140),c=i(57),l=i(4),u=i(281),h=i(282),p=i(283),m=i(123);class f extends s.EventEmitter{constructor(e){super(),this.snapshotIndex=0,this.sinkId=null,this.audio={normalizedVolume:1,dom:null},this.audioSlave={normalizedVolume:1,dom:null},this.mask={enabled:!1},this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e,t;let i="player";return (null===(e=this.audio.dom)||void 0===e?void 0:e.paused)&&(i+=" audio_paused"),(null===(t=this.audioSlave.dom)||void 0===t?void 0:t.paused)&&(i+=" audioSlave_paused"),this.stream._play!==this&&(i+=" DETACHED"),i}),this.video={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:u.createCanvasWatermarkControl(this.logger),encoderWatermark:h.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}},this.screen={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:u.createCanvasWatermarkControl(this.logger),encoderWatermark:h.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}};}_initDomAndView(e){const t=this[e];if(t.view){if(!t.containerDom){const i=document.createElement("div");t.containerDom=i,t.containerDom.className=`nertc-${e}-container nertc-${e}-container-${this.stream.isRemote?"remote":"local"}`,i.style.overflow="hidden",i.style.position="relative",i.style.width=t.view.clientWidth+"px",i.style.height=t.view.clientHeight+"px",i.style.display="inline-block";}if(!t.dom){const i=document.createElement("video");t.dom=i,i.style.position="absolute",i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%,-50%)",i.setAttribute("x-webkit-airplay","x-webkit-airplay"),i.setAttribute("playsinline","playsinline"),i.setAttribute("webkit-playsinline","webkit-playsinline"),i.preload="auto",i.dataset.uid=""+this.stream.getId(),i.autoplay=!0,i.muted=!0,t.size.width=0,t.size.height=0,l.getParameters().controlOnPaused&&(i.addEventListener("pause",this.showControlIfVideoPause.bind(this)),i.addEventListener("play",this.handleVideoScreenPlay.bind(this)),i.addEventListener("click",this.handleVideoScreenClick.bind(this))),i.addEventListener("resize",r=>{if(!this[e].dom||this[e].dom!==i||this[e].dom!==r.target)return;const s=i.videoWidth,a=i.videoHeight;s>2&&a>2&&this.stream.isRemote&&this.stream.client.adapterRef.state.videoResizeTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.videoResizeTime=Date.now()),s===t.size.width&&a===t.size.height||(this.logger.log(`[Play] 主流视频分辨率发生变化：${t.size.width}x${t.size.height} => ${s}x${a}。当前父节点：${c.getDomInfo(t.view)}`),s>a&&t.size.width>t.size.height||s<a&&t.size.width<t.size.height||this.setRender(e),t.size.width=s,t.size.height=a);});}t.containerDom==t.dom.parentNode?this.logger.log("[Play] initVideoNode: 节点已挂载，请勿重复挂载"):(t.containerDom.appendChild(t.dom),this.logger.log("[Play] initVideoNode "+e)),t.view==t.containerDom.parentNode?this.logger.log("[Play] mountVideoToDom: 节点已挂载，请勿重复挂载"):(this.logger.log("[Play] mountVideoToDom"),t.view.appendChild(t.containerDom),this.logger.log("[Play] 视频主流dom节点挂载成功。父节点："+c.getDomInfo(t.view)),t.canvasWatermark.watermarks.length?t.canvasWatermark.start(t.containerDom):t.canvasWatermark.div=t.containerDom);}}showControlIfVideoPause(){a.MediaTypeList.forEach(e=>{const t=this[e].dom;(null==t?void 0:t.paused)&&this.logger.log("[Play] 可能遇到了播放问题",e);});}handleVideoScreenClick(){a.MediaTypeList.forEach(e=>{const t=this[e].dom;(null==t?void 0:t.paused)&&(this.logger.log("[Play] 侦测到视频点击，尝试恢复播放:"+e),t.play());});}handleVideoScreenPlay(){a.MediaTypeList.forEach(e=>{const t=this[e].dom;!1===(null==t?void 0:t.paused)&&this.logger.log("[Play] 侦测到播放: "+e);});}isPlaying(e){let t=this[e].dom;if(!t)return !1;if(!t.srcObject)return !1;if(t.paused)return !1;if(4!==t.readyState)return !1;{let i=t.srcObject.getTracks()[0];if(!i)return !1;if(!i.enabled)return !1;if(i.muted)return !1;if("audio"===e||"audioSlave"===e){if(t.muted)return !1;if(0===t.volume)return !1}}return !0}canPlay(e){const t={result:!1,reason:""},i=this.stream.mediaHelper.getTrackByMediaType(e),r=this[e].dom;return i?"ended"===i.readyState?t.reason="ENDED":i.muted||!i.enabled?t.reason="MUTED":r&&r.srcObject?r.paused?"audio"===i.kind?t.result=!0:t.reason="PAUSED":t.reason="PLAYING":t.result=!0:this.stream.isRemote?this.stream.pubStatus[e].producerId?this.stream.pubStatus[e].consumerId?"end"!==this.stream.pubStatus[e].consumerStatus?t.reason="CONSUME_"+this.stream.pubStatus[e].consumerStatus:t.reason="INVALID_STATE":t.reason="NOT_SUBSCRIBED":t.reason="NOT_PUBLISHED":t.reason="NOT_OPENED",t}async resume(){const e=[];a.MediaTypeList.forEach(t=>{const i=this[t].dom;if(null==i?void 0:i.paused){const r=i.play();e.push(r),r.then(()=>{this.logger.log(`[Resume] 恢复播放: ${t} 成功`);}),r.catch(e=>{if(this.logger.error(`[Resume] 恢复播放 ${t} 出现问题:`,e.name,e.message),"notAllowedError"===e.name||"NotAllowedError"===e.name)throw new n.default({code:o.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"resume: 浏览器自动播放受限: "+e.name})});}});try{await Promise.all(e);}catch(e){}}updatePlaybackVolume(){a.MediaTypeListAudio.forEach(e=>{const t=this[e].dom;if(t){let i;i=this.stream.isRemote?this.stream.client.adapterRef.nomalizedPlaybackVolume*this[e].normalizedVolume:this[e].normalizedVolume,Math.abs(t.volume-i)>.01&&(this.logger.log(`updatePlaybackVolume ${e} ${t.volume} => ${i} ( ${this.stream.client.adapterRef.nomalizedPlaybackVolume} * ${this[e].normalizedVolume})`),t.volume=i);}});}async playAudioStream(e,t,i){const r=this[e];r.dom||(r.dom=document.createElement("audio"));const s=r.dom;if(s.muted="boolean"==typeof i&&i,s.srcObject=t,this.updatePlaybackVolume(),this.sinkId){this.logger.log(`[Play ${e}] 音频尝试使用输出设备`,this.sinkId);try{await s.setSinkId(this.sinkId),this.logger.log(`[Play] ${e} 音频使用输出设备成功`,this.sinkId);}catch(e){this.logger.error("[Play] 音频输出设备切换失败",e.name,e.message,e);}}try{await p.playMedia(s,l.getParameters().playMediaTimeout),this.logger.log("[Play] 播放音频完成，当前播放状态:",s.played.length),this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"success",streamUid:this.stream.stringStreamID,muted:s.muted,active:s.srcObject.active,played:s.played.length},null," ")});}catch(t){if(this.logger.warn(`[Play ${e}] 播放音频出现问题: `,t.name,t.message,t),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"fail",reason:`${t.name} + ${t.message}`,uid:this.stream.stringStreamID,muted:s.muted,active:s.srcObject.active,played:s.played.length},null," ")}),"notAllowedError"===t.name||"NotAllowedError"===t.name)throw new n.default({code:o.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:`playStream ${e}: 浏览器自动播放受限: ${t.name}`})}}setPlayVolume(e,t){this[e].normalizedVolume=t,this.updatePlaybackVolume();}async playVideoStream(e,t,i){var r,s,a;const d=this[e];if((null===(r=d.dom)||void 0===r?void 0:r.srcObject)!==t){d.view=i,this._initDomAndView(e),this.mask.enabled&&this.enableMask();try{const i=t.getVideoTracks()[0];i?this.logger.log(`[Play] 开始加载 ${e} 播放视频源：视频参数 "${i.label}",enabled ${i.enabled} , ${JSON.stringify(i.getSettings())}`):this.logger.error(`[Play ${e}] 加载播放视频源失败：没有视频源`);const r=d.dom;if(!r)return;r.srcObject=t,this.stream.isRemote&&this.stream.client.adapterRef.state.domVideoAppendTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.domVideoAppendTime=Date.now()),await p.playMedia(r,l.getParameters().playMediaTimeout),this.logger.log(`[Play] 成功加载主流播放视频源：当前视频实际分辨率${r.videoWidth}x${r.videoHeight}，显示宽高${r.offsetWidth}x${r.offsetHeight}`),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,muted:r.muted,active:r.srcObject.active,played:r.played.length},null," ")}),r.paused&&l.getParameters().controlOnPaused&&this.showControlIfVideoPause();}catch(i){if(this.logger.warn(`[Play ${e}] 播放视频出现问题:`,i.name,i.message,i),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"fail",reason:`${i.name} + ${i.message}`,uid:this.stream.stringStreamID,muted:null===(s=null==d?void 0:d.dom)||void 0===s?void 0:s.muted,active:t.active,played:null===(a=null==d?void 0:d.dom)||void 0===a?void 0:a.played.length},null," ")}),"notAllowedError"===i.name||"NotAllowedError"===i.name)throw new n.default({code:o.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: "+i.name})}}else this.logger.log(`[Play ${e}] playVideoStream: 跳过重复的播放请求`);}async stopPlayStream(e){"audio"===e||"audioSlave"===e?this._stopPlayAudioStream(e):"video"!==e&&"screen"!==e||this._stopPlayVideoStream(e);}async _stopPlayAudioStream(e){const t=this[e].dom;t&&(t.muted=!0,t.srcObject=null,this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,muted:t.muted},null," ")}));}async _stopPlayVideoStream(e){this.logger.log("stopPlayVideoStream 停止播放 "+e);const t=this[e].view,i=this[e].containerDom,r=this[e].dom;if(i&&r){i===r.parentNode?(this.logger.log(`清除 ${e} dom`),i.removeChild(r)):i.lastChild&&(this.logger.log("videoContainerDom 删除子节点"),i.removeChild(i.lastChild));try{r.remove(),r.srcObject=null,this[e].dom=null,this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID},null," ")});}catch(t){this.logger.log("stopPlayVideoStream e: ",t),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"failed",uid:this.stream.stringStreamID,reason:t.message},null," ")});}}t&&i&&(t==i.parentNode?(this.logger.log(`清除 ${e} containerDom`),t.removeChild(i)):t.lastChild&&(this.logger.log(e+" View 删除子节点"),t.removeChild(t.lastChild),t.innerHTML=""),this[e].containerDom=null,this[e].view=null);}setRender(e,t){var i,r,s,a;const o=this[e],n=o.containerDom,d=o.dom;if(t?(this.logger.log(`[Play ${e}] setRender() options: ${JSON.stringify(t)}`),o.renderMode=Object.assign({},t)):(t=o.renderMode,this.logger.log("[Play] setVideoRender() existing videoRenderMode: "+JSON.stringify(t))),!n||!d)return;if(n.style.width=t.width+"px",n.style.height=t.height+"px",!t.cut)return d.style.height="100%",void(d.style.width="100%");d.videoWidth/d.videoHeight>t.width/t.height?(d.style.width="auto",d.style.height="100%"):(d.style.width="100%",d.style.height="auto"),this.stream.client.apiEventReport("setFunction",{name:"set_render_"+e,oper:"1",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,played:d.played.length,domStyleWidth:d.style.width,domStyleHeight:d.style.height,containerDomWidth:null===(r=null===(i=o.containerDom)||void 0===i?void 0:i.style)||void 0===r?void 0:r.width,containerDomHeight:null===(a=null===(s=o.containerDom)||void 0===s?void 0:s.style)||void 0===a?void 0:a.height},null," ")});}async setAudioOutput(e){this.sinkId=e;for(let t of a.MediaTypeListAudio){const i=this[t].dom;if(null==i?void 0:i.srcObject){i.srcObject.getAudioTracks().length&&(await i.setSinkId(e),this.logger.log("[Play] setAudioOutput() 设置通话音频输出设备成功"));}}}async takeSnapshot(e,t,i){if(this.mask.enabled)return this.logger.warn("takeSnapshot: 目前在打码状态"),null;let r=new d.RTCCanvas("canvas"),s=r._canvas,a=r._ctx;if(!a||!s)throw this.logger.error("takeSnapshot() 浏览器环境不支持"),new n.default({code:o.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"takeSnapshot() 浏览器环境不支持"});const c=["video","screen"];let l="";for(let o of c){if(!e.mediaType&&this[o].dom||e.mediaType===o){const n=e.name||(i||this.stream.getId())+"-"+this.snapshotIndex++;a.fillStyle="#ffffff";const d=this[o].dom;if(!d)return;a.fillRect(0,0,d.videoWidth,d.videoHeight),r.setSize(d.videoWidth,d.videoHeight),a.drawImage(d,0,0,d.videoWidth,d.videoHeight,0,0,d.videoWidth,d.videoHeight),"download"===t?l=await new Promise((e,t)=>{s.toBlob(t=>{this.logger.log("takeSnapshot() 获取到截图的blob: ",t);let i=URL.createObjectURL(t),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=n+".png",r.click(),window.URL.revokeObjectURL(i),e(n+".png");});}):"base64"===t&&(l=this.getBase64Image(s));}}return r.destroy(),l}_initFrameDataCanvas(e){const t=this[e].frameData;return t.canvas||(this.logger.log("正在初始化 frameData.canvas "+e),t.canvas=document.createElement("canvas"),t.context=m.get2DContext(t.canvas,{willReadFrequently:!0})),t.context}getCurrentFrameData(e){if(this.mask.enabled)return this.logger.error("getCurrentFrameData: 当前在打码状态"),null;let t,i,r;if(r=e.mediaType&&"video"!==e.mediaType?"screen":"video",i=this[r].dom,t=this[r].frameData,!i)return this.logger.error("getCurrentFrameData: Playing Video is not found"),null;i.paused&&this.logger.warn("getCurrentFrameData: 目前数据源不在播放状态，截图结果可能不是最新。"),t.canvas||this._initFrameDataCanvas(r);const s=t.canvas,a=t.context;if(!a||!s)throw new n.default({code:o.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"getCurrentFrameData() 浏览器环境不支持"});const d=i.videoWidth,c=i.videoHeight;if(!d||!c)return null;let l,u;e.width&&e.width>0?e.height&&e.height>0?(l=e.width,u=e.height):(l=e.width,u=Math.floor(e.width/d*c)):e.height&&e.height>0?(u=e.height,l=Math.floor(e.height/c*d)):(l=d,u=c),s.width!==l&&(s.width=l),s.height!==u&&(s.height=u),a.drawImage(i,0,0,l,u);return a.getImageData(0,0,l,u)}getBase64Image(e){return e.toDataURL("image/",1)}enableMask(){this.mask.enabled=!0,this.video.dom&&(this.video.dom.style.filter="blur(20px)");}disableMask(){this.mask.enabled=!1,this.video.dom&&(this.video.dom.style.filter=""),this.screen.dom&&(this.screen.dom.style.filter="");}destroy(){a.MediaTypeList.forEach(e=>{this.stopPlayStream(e);});}}t.Play=f;},function(e,t,i){var r;!function(s){var a,o,n,d=(a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,o=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,n=/[^-+\dA-Z]/g,function(e,t,i,r){if(1!==arguments.length||"string"!==h(e)||/\d/.test(e)||(t=e,e=void 0),(e=e||new Date)instanceof Date||(e=new Date(e)),isNaN(e))throw TypeError("Invalid date");var s=(t=String(d.masks[t]||t||d.masks.default)).slice(0,4);"UTC:"!==s&&"GMT:"!==s||(t=t.slice(4),i=!0,"GMT:"===s&&(r=!0));var p=i?"getUTC":"get",m=e[p+"Date"](),f=e[p+"Day"](),g=e[p+"Month"](),v=e[p+"FullYear"](),y=e[p+"Hours"](),S=e[p+"Minutes"](),_=e[p+"Seconds"](),R=e[p+"Milliseconds"](),b=i?0:e.getTimezoneOffset(),T=l(e),E=u(e),A={d:m,dd:c(m),ddd:d.i18n.dayNames[f],dddd:d.i18n.dayNames[f+7],m:g+1,mm:c(g+1),mmm:d.i18n.monthNames[g],mmmm:d.i18n.monthNames[g+12],yy:String(v).slice(2),yyyy:v,h:y%12||12,hh:c(y%12||12),H:y,HH:c(y),M:S,MM:c(S),s:_,ss:c(_),l:c(R,3),L:c(Math.round(R/10)),t:y<12?"a":"p",tt:y<12?"am":"pm",T:y<12?"A":"P",TT:y<12?"AM":"PM",Z:r?"GMT":i?"UTC":(String(e).match(o)||[""]).pop().replace(n,""),o:(b>0?"-":"+")+c(100*Math.floor(Math.abs(b)/60)+Math.abs(b)%60,4),S:["th","st","nd","rd"][m%10>3?0:(m%100-m%10!=10)*m%10],W:T,N:E};return t.replace(a,(function(e){return e in A?A[e]:e.slice(1,e.length-1)}))});function c(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function l(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setDate(t.getDate()-(t.getDay()+6)%7+3);var i=new Date(t.getFullYear(),0,4);i.setDate(i.getDate()-(i.getDay()+6)%7+3);var r=t.getTimezoneOffset()-i.getTimezoneOffset();t.setHours(t.getHours()-r);var s=(t-i)/6048e5;return 1+Math.floor(s)}function u(e){var t=e.getDay();return 0===t&&(t=7),t}function h(e){return null===e?"null":void 0===e?"undefined":"object"!=typeof e?typeof e:Array.isArray(e)?"array":{}.toString.call(e).slice(8,-1).toLowerCase()}d.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},d.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},void 0===(r=function(){return d}.call(t,i,t,e))||(e.exports=r);}();},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.measureText=t.numberToRGBA=void 0,t.numberToRGBA=function(e){if(0===e)return "rgba(0,0,0,0)";let t,i,r,s;return r=e%256,i=(e=Math.floor(e/256))%256,t=(e=Math.floor(e/256))%256,s=(e=Math.floor(e/256))>0?(e%256/256).toFixed(2):1,`rgba(${t}, ${i}, ${r}, ${s})`},t.measureText=function(e,t,i){if(!e)return {width:0,height:0};let r=document.createElement("div"),s=document.createElement("span");s.innerText=e,s.style.fontSize=t,s.style.fontFamily=i,r.style.opacity="0",r.style.position="absolute",r.style.height=t,document.body.appendChild(r),r.appendChild(s);const a=r.clientHeight,o=s.offsetWidth;return r.remove(),{width:o,height:a}};},function(e,t,i){var r=a(i(60)),s=a(i(61));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(168).EventEmitter,n=i(145);e.exports=class extends o{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new n("EnhancedEventEmitter");}safeEmit(e){try{for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.emit.apply(this,[e].concat(i));}catch(t){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t);}}safeEmitAsPromise(e){for(var t=this,i=arguments.length,a=Array(i>1?i-1:0),o=1;o<i;o++)a[o-1]=arguments[o];return (0, s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i,r){t.safeEmit.apply(t,[e].concat(a,[i,r]));})));case 1:case"end":return i.stop()}}),i,t)})))()}};},function(e,t,i){var r,s=i(103),a=(r=s)&&r.__esModule?r:{default:r};var o=i(145),n=i(289).generateRandomNumber,d=i(119).JSONBigParse,c=new o("Message");e.exports=class{static parse(e){var t=void 0,i={};try{t=d(e);}catch(e){return void c.error("parse() | invalid JSONbig: %s",e)}if("object"===(void 0===t?"undefined":(0, a.default)(t))&&!Array.isArray(t)){if(t.request){if(i.request=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");if("number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,i.method=t.method,i.data=t.data||{};}else if(t.response){if(i.response=!0,"number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,t.ok?(i.ok=!0,i.data=t.data||{}):(i.ok=!1,i.errorCode=t.errorCode,i.errorReason=t.errorReason);}else {if(!t.notification)return void c.error("parse() | missing request/response field");if(i.notification=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");i.id=t.id,i.method=t.method,i.data=t.data||{};}return i}c.error("parse() | not an object");}static createRequest(e,t){return {request:!0,id:n(),method:e,data:t||{}}}static createSuccessResponse(e,t){return {response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,i){return {response:!0,id:e.id,ok:!1,errorCode:t,errorReason:i}}static createNotification(e,t){return {notification:!0,method:e,data:t||{}}}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(4),s=i(70),a=i(69);let o=window;const n={setLogLevel(e){r.getParameters().logLevel!==e&&(a.getDefaultLogger().info(`NERTC LogLevel was changed: ${s.loglevelMap[r.getParameters().logLevel]} => ${s.loglevelMap[e]}`),r.getParameters().logLevel=e);},enableLogUpload(){o.logUpload=!0;},disableLogUpload(){o.logUpload=!1;}};"on"===r.getParameters().forceLogUpload?n.enableLogUpload():n.disableLogUpload(),t.default=n;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvBeautyFilter=t.resSet=void 0;const r=i(159),s=i(131),a=i(132),o=i(116),n=i(304),d=i(305),c=i(306),l=i(307),u=i(133),h=i(308),p=i(134);t.resSet={faceMask:"https://yx-web-nosdn.netease.im/common/6947be5d3e5604368401950ca0cf094d/facemask-01.png",eyeTeethMask:"https://yx-web-nosdn.netease.im/common/655421269305cac5c1e48d62f0fac8de/eye-teeth-mask-02.png",teethWhiten:"https://yx-web-nosdn.netease.im/common/ca8a6b0be3427ead9b19bcf9ae1245a8/teath.png"};const m={genTopFace(e){const t=h.Vector2.getVec(e,49),i=h.Vector2.getVec(e,43);let r=h.Vector2.sub(i,t),s=1.5*r.length;r=h.Vector2.normalize(r);const a=h.Vector2.sub(h.Vector2.getVec(e,0),i);let o=a.length;const n=h.Vector2.sub(h.Vector2.getVec(e,32),i);let d=n.length;const c=Math.max(o,d);let l=o/c,u=d/c;h.Vector2.setPoint(e,116,h.Vector2.add(i,h.Vector2.scale(r,s)));let p=h.Vector2.angle(a,r),m=h.Matrix3x3.rotate(p/-6,0,0),f=r;[110,109,108,107,106].forEach((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,n=1*(1-a)+l*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*n*(1-a)+o*a)));}),p=h.Vector2.angle(n,r),m=h.Matrix3x3.rotate(p/6,0,0),f=r,[115,114,113,112,111].forEach((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,o=1*(1-a)+u*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*o*(1-a)+d*a)));});},genFaceOutline(e){const t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,106,107,108,109,110,111,112,113,114,115,116],i=h.Vector2.getVec(e,43);for(let r=0;r<t.length;r++){const s=t[r],a=h.Vector2.getVec(e,s),o=h.Vector2.add(i,h.Vector2.scale(h.Vector2.sub(a,i),1.3)),n=2*(117+r);e[n]=o.value[0]>>0,e[n+1]=o.value[1]>>0;}}},f=new Set;let g=null,v=null,y=null;class S extends p.Filter{constructor(e,t,i,s,a,n,d,c,l,u,h,p){super(e,t,i,null),this.isShowWire=!1,this.advData=null,this.wirePosBuffer=null,this.targetPosBuffer=null,this.zIndexBuffer=null,this.indicesBuffer=null,this.faceMaskUVBuffer=null,this.planePosBuffer=null,this.planeUVBuffer=null,this.advEyeTeethPosBuffer=null,this.advEyeTeethIndicesBuffer=null,this.advEyeTeethZindexBuffer=null,this.advEyeTeethUVBuffer=null,this.defParams={enlargeEye:0,roundedEye:0,openCanthus:0,eyeDistance:.5,eyeAngle:.5,shrinkNose:0,lengthenNose:.5,shrinkMouth:.5,widenMouth:.5,mouthCorners:.5,adjustPhiltrum:.5,shrinkUnderjaw:0,shrinkCheekbone:0,lengthenJaw:.5,narrowedFace:0,shrinkFace:0,vShapedFace:0,minifyFace:0,shortenFace:0,whitenTeeth:0,brightenEye:0,fadeHeadWrinkle:0,fadeEyeRim:0,fadeNoseLine:0},f.add(this),this.faceMaskMap=o.createTexture(this.renderer.gl,g),this.eyeTeethMaskMap=o.createTexture(this.renderer.gl,v),this.whiteTeethLutMap=o.createTexture(this.renderer.gl,y,{flipY:!1}),this.params=Object.assign({},this.defParams),m.genTopFace(this.posBuffer.typedArray),m.genFaceOutline(this.posBuffer.typedArray),this.targetPosBuffer=r.createAttributeBuffer(this.renderer.gl,"tPosition",this.posBuffer.typedArray.slice(0),2),this.zIndexBuffer=s,this.indicesBuffer=a,this.faceMaskUVBuffer=n,this.planePosBuffer=d,this.planeUVBuffer=c,this.advEyeTeethPosBuffer=l,this.advEyeTeethIndicesBuffer=u,this.advEyeTeethZindexBuffer=h,this.advEyeTeethUVBuffer=p,this.setWirePosBuffer(),this.initProgramBuffer();}setWirePosBuffer(){if(!this.isShowWire)return;const e=new Set,t=[],i=this.indicesBuffer.typedArray,s=this.posBuffer.typedArray,a=(i,r)=>{if(!e.has(i+"-"+r)&&!e.has(r+"-"+i)){e.add(i+"-"+r);const a=2*i,o=2*r;t.push(s[a],s[a+1],s[o],s[o+1]);}};for(let e=0;e<(i.length-2)/3;e++){const t=3*e,r=i[t],s=i[t+1],o=i[t+2];a(r,s),a(s,o),a(o,r);}this.wirePosBuffer?this.programs.wire.updateAttribute("position",e=>{e.set(t,0);}):this.wirePosBuffer=r.createAttributeBuffer(this.renderer.gl,"position",new Int16Array(t),2);}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i={width:t.width>>2,height:t.height>>2};let r=null;if(this.isShowWire){const i=new a.Program(e,()=>{var t;e.drawArrays(e.LINES,0,(null===(t=this.wirePosBuffer)||void 0===t?void 0:t.count)||0);});i.setShader(c.advBeautyWireShader.vShader,"VERTEX"),i.setShader(c.advBeautyWireShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.wirePosBuffer),r=s.createFrameBuffer(e,t.width,t.height),i.setUniform("size",[t.width,t.height]),this.programs.wire=i,this.framebuffers.wire=r;}const o=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0);});o.setShader(d.advBeautyShader.vShader,"VERTEX"),o.setShader(d.advBeautyShader.fShader,"FRAGMENT"),o.setAttributeBuffer(this.posBuffer),o.setAttributeBuffer(this.targetPosBuffer),o.setAttributeBuffer(this.zIndexBuffer);const h=s.createFrameBuffer(e,t.width,t.height);o.setUniform("size",[t.width,t.height]),this.isShowWire&&o.setUniform("wireMap",r.targetTexture),o.setUniform("showWire",this.isShowWire?1:0),o.setUniform("map",this.map),o.setUniform("teethLut",this.whiteTeethLutMap),o.setUniform("teethIntensity",0),o.setUniform("eyeIntensity",0),o.setIndices(this.indicesBuffer),this.programs.morph=o,this.framebuffers.morph=h;const p=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0);});p.setShader(l.advFaceMaskShader.vShader,"VERTEX"),p.setShader(u.baseTextureShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.targetPosBuffer),p.setAttributeBuffer(this.zIndexBuffer),p.setAttributeBuffer(this.faceMaskUVBuffer);const m=s.createFrameBuffer(e,i.width,i.height);p.setUniform("size",[t.width,t.height]),p.setUniform("map",this.faceMaskMap),p.setIndices(this.indicesBuffer),this.programs.faceMask=p,this.framebuffers.faceMask=m;const f=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.advEyeTeethIndicesBuffer.count,e.UNSIGNED_SHORT,0);});f.setShader(l.advFaceMaskShader.vShader,"VERTEX"),f.setShader(u.baseTextureShader.fShader,"FRAGMENT"),f.setAttributeBuffer(this.advEyeTeethPosBuffer),f.setAttributeBuffer(this.advEyeTeethZindexBuffer),f.setAttributeBuffer(this.advEyeTeethUVBuffer);const g=s.createFrameBuffer(e,i.width,i.height);f.setUniform("size",[t.width,t.height]),f.setUniform("map",this.eyeTeethMaskMap),f.setIndices(this.advEyeTeethIndicesBuffer),this.programs.eyeTeeth=f,this.framebuffers.eyeTeeth=g,o.setUniform("eyeTeethMaskMap",g.targetTexture);for(let r=0;r<2;r++){const o=new a.Program(e);o.setShader(u.baseTextureShader.vShader,"VERTEX"),o.setShader(n.advBeautyEyeShader.fShader,"FRAGMENT"),o.setAttributeBuffer(this.planePosBuffer),o.setAttributeBuffer(this.planeUVBuffer);const d=s.createFrameBuffer(e,t.width,t.height);o.setUniform("map",0===r?h.targetTexture:this.framebuffers.lEye.targetTexture),o.setUniform("eyeCenter",[0,0]),o.setUniform("rdIntensity",0),o.setUniform("lgIntensity",0),o.setUniform("intensRatio",0),o.setUniform("range",0),o.setUniform("rdDir",[0,0]);const c=["lEye","rEye"][r];this.programs[c]=o,this.framebuffers[c]=d;const p=new a.Program(e);p.setShader(u.baseTextureShader.vShader,"VERTEX"),p.setShader(l.advFaceMaskShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.planePosBuffer),p.setAttributeBuffer(this.planeUVBuffer);const f=s.createFrameBuffer(e,i.width,i.height);p.setUniform("map",null),p.setUniform("maskMap",m.targetTexture),p.setUniform("index",r),this.programs["faceMaskMerge"+r]=p,this.framebuffers["faceMaskMerge"+r]=f;}}get output(){return this.advData?this.framebuffers.rEye.targetTexture:super.output}get faceMask(){if(this.advData){const e=this.advData.length/212>>0;return this.framebuffers["faceMaskMerge"+(e-1)%2].targetTexture}return null}updateSize(){const e=this.renderer.getSize(),t={width:e.width>>2,height:e.height>>2};["wire","morph","lEye","rEye","faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].forEach(i=>{var r;-1===["faceMaskMerge0","faceMaskMerge1","lEye","rEye"].indexOf(i)&&(null===(r=this.programs[i])||void 0===r||r.setUniform("size",[e.width,e.height]));const s=this.framebuffers[i];if(s){const r=-1===["faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].indexOf(i)?e:t;s.targetTexture.opts.width=r.width,s.targetTexture.opts.height=r.height,s.targetTexture.refresh();}});}setAdvData(e){this.advData=e.length?e:null;}setAdvEffect(e,t){if(e in this.params&&"number"==typeof t)this.params[e]=Math.min(1,Math.max(0,t)),"whitenTeeth"===e&&0===this.params[e]?this.programs.morph.setUniform("teethIntensity",0):"brightenEye"===e?this.programs.morph.setUniform("eyeIntensity",t):"roundedEye"===e?(this.programs.lEye.setUniform("rdIntensity",t),this.programs.rEye.setUniform("rdIntensity",t)):"enlargeEye"===e&&(this.programs.lEye.setUniform("lgIntensity",t),this.programs.rEye.setUniform("lgIntensity",t));else for(const e in this.defParams)this.setAdvEffect(e,this.defParams[e]);}presetAdvEffect(e){for(const t in this.defParams)t in e?this.setAdvEffect(t,e[t]):this.setAdvEffect(t,this.defParams[t]);}get featureParas(){return this.advData?{forehead:this.params.fadeHeadWrinkle,eyeRim:this.params.fadeEyeRim,noseLine:this.params.fadeNoseLine}:{forehead:0,eyeRim:0,noseLine:0}}posToUV(e,t,i){return new h.Vector2(e.x/t,1-e.y/i)}render(){const e=this.advData;if(e){const t=this.renderer,i=t.gl,r=t.getSize(),s={width:r.width>>2,height:r.height>>2},a=e.length/212>>0;for(let o=0;o<a;o++){const a=e.slice(212*o,212*(o+1)),n=o%2,d=this.programs.morph,c=this.programs["faceMaskMerge"+n];d.setUniform("map",0===o?this.map:this.framebuffers.rEye.targetTexture),d.updateAttribute("position",e=>{e.set(a,0),m.genTopFace(e),m.genFaceOutline(e);});let l=null;if(d.updateAttribute("tPosition",e=>{var t;const i=e;i.set(this.posBuffer.typedArray,0),h.preHandle(i);for(const e in h.handlers){const r=this.params[e];if(r!==this.defParams[e]){const s=null===(t=h.handlers[e])||void 0===t?void 0:t.call(h.handlers,i,r);"whitenTeeth"===e?d.setUniform("teethIntensity",s):"roundedEye"!==e&&"enlargeEye"!==e||(l=Object.assign(Object.assign({},s),{posData:i}));}}}),this.setWirePosBuffer(),this.isShowWire&&(this.framebuffers.wire.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.wire)),t.setViewport(0,0,s.width,s.height),this.framebuffers.faceMask.bind(),this.renderer.render(this.programs.faceMask),c.setUniform("index",o),c.setUniform("map",this.framebuffers["faceMaskMerge"+(0===n?1:0)].targetTexture),this.framebuffers["faceMaskMerge"+n].bind(),this.renderer.render(c),this.programs.eyeTeeth.updateAttribute("tPosition",e=>{const t=e,i=this.targetPosBuffer.typedArray;[52,53,72,54,55,56,73,57,61,60,75,59,58,63,76,62,96,97,98,99,100,101,102,103].forEach((e,r)=>{let s=2*r,a=2*e;t[s]=i[a],t[s+1]=i[a+1];});}),this.framebuffers.eyeTeeth.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.eyeTeeth),t.setViewport(0,0,r.width,r.height),this.framebuffers.morph.bind(),this.renderer.render(d),l){const e=this.posToUV(l.lEyeCenter,r.width,r.height),t=this.posToUV(l.rEyeCenter,r.width,r.height),i=this.posToUV(h.Vector2.getVec(l.posData,52),r.width,r.height),s=this.posToUV(h.Vector2.getVec(l.posData,55),r.width,r.height);let a=h.Vector2.getVec(l.posData,72),o=h.Vector2.getVec(l.posData,73);const n=this.posToUV(h.Vector2.getVec(l.posData,58),r.width,r.height),d=this.posToUV(h.Vector2.getVec(l.posData,61),r.width,r.height);let c=h.Vector2.getVec(l.posData,75),u=h.Vector2.getVec(l.posData,76);const p=Math.min(1,Math.max(0,(h.Vector2.disPow2(a,o)-4)/4)),m=Math.min(1,Math.max(0,(h.Vector2.disPow2(c,u)-4)/4));a=this.posToUV(a,r.width,r.height),o=this.posToUV(o,r.width,r.height),c=this.posToUV(c,r.width,r.height),u=this.posToUV(u,r.width,r.height),this.programs.lEye.setUniform("eyeCenter",e.value),this.programs.lEye.setUniform("range",Math.max(h.Vector2.dis(e,i),h.Vector2.dis(e,s))),this.programs.lEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(a,o)).value),this.programs.lEye.setUniform("intensRatio",p),this.programs.rEye.setUniform("eyeCenter",t.value),this.programs.rEye.setUniform("range",Math.max(h.Vector2.dis(t,n),h.Vector2.dis(t,d))),this.programs.rEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(c,u)).value),this.programs.rEye.setUniform("intensRatio",m);}this.framebuffers.lEye.bind(),this.renderer.render(this.programs.lEye),this.framebuffers.rEye.bind(),this.renderer.render(this.programs.rEye);}}}static configStaticRes(e,i){const r=[];let s=1;const a=()=>{s-=1,s<=0&&(i?i.emit("advBeautyResComplete",r):f.forEach(e=>{try{e.emit("advBeautyResComplete",r);}catch(e){}}));};e.faceMask&&!g&&(s+=1,t.resSet.faceMask=e.faceMask,o.retryLoadImage(e.faceMask,3,e=>{g=e,f.forEach(t=>{try{t.faceMaskMap.source=e,t.faceMaskMap.refresh();}catch(e){}}),a();},()=>{r.push(e.faceMask),a();})),e.eyeTeethMask&&!v&&(s+=1,t.resSet.eyeTeethMask=e.eyeTeethMask,o.retryLoadImage(t.resSet.eyeTeethMask,3,e=>{v=e,f.forEach(t=>{try{t.eyeTeethMaskMap.source=e,t.eyeTeethMaskMap.refresh();}catch(e){}}),a();},()=>{r.push(e.eyeTeethMask),a();})),e.teethWhiten&&!y&&(s+=1,t.resSet.teethWhiten=e.teethWhiten,o.retryLoadImage(t.resSet.teethWhiten,3,e=>{y=e,f.forEach(t=>{try{t.whiteTeethLutMap.source=e,t.whiteTeethLutMap.refresh();}catch(e){}}),a();},()=>{r.push(e.teethWhiten),a();})),a();}destroy(){var e,t,i;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.faceMaskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.eyeTeethMaskMap.glTexture),null===(i=this.renderer.gl)||void 0===i||i.deleteTexture(this.whiteTeethLutMap.glTexture),f.delete(this);}remove(){f.delete(this);}}t.AdvBeautyFilter=S;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.lutShader=void 0,t.lutShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D lut;\n\n    // lut强度\n    uniform float intensity;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec3 color = texture2D(map, vuv).rgb;\n\n        if(intensity > 0.0){\n            float blue = color.b * 63.0;\n\n            vec2 q1;\n            float fb = floor(blue);\n            q1.y = floor(fb * 0.125);\n            q1.x = fb - (q1.y * 8.0);\n\n            vec2 q2;\n            float cb = ceil(blue);\n            q2.y = floor(cb * 0.125);\n            q2.x = cb - (q2.y * 8.0);\n\n            vec2 t = 0.123 * color.rg + vec2(0.000976563);\n            vec2 t1 = q1 * 0.125 + t;\n            vec3 p1 = texture2D(lut, t1).rgb;\n\n            vec2 t2 = q2 * 0.125 + t;\n            vec3 p2 = texture2D(lut, t2).rgb;\n\n            vec3 filter = mix(p1, p2, fract(blue));\n            color = mix(color, filter, intensity);\n        }\n        gl_FragColor = vec4(color, 1.0);\n    }"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.audioPlugins=t.videoPlugins=void 0;t.videoPlugins=["VirtualBackground","AdvancedBeauty"],t.audioPlugins=["AIDenoise"],t.default=["VirtualBackground","AdvancedBeauty","AIDenoise"];},,,,function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NERTC=void 0;const s=i(206),a=i(296),o=i(62),n=i(326),d=i(327),c=i(328),l=i(122),u=i(166),h=i(117),p=i(4),m=i(64),f=i(162),g=r(i(12)),v=r(i(13)),y=r(i(198)),S=i(70),_=i(65),R=i(71),b=i(164);let T,E=window;t.NERTC={Logger:{DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4,setLogLevel(e){const t=p.getParameters().forceLogLevel;-1!==t?null==T||T.logger.error("setLogLevel: 本页面的日志级别固定为 "+S.loglevelMap[t]):(T&&T.apiFrequencyControl({name:"setLogLevel",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||"",level:e}}),y.default.setLogLevel(e));},enableLogUpload(){"off"===p.getParameters().forceLogUpload?null==T||T.logger.error("enableLogUpload: 禁止开启日志上传"):(T&&T.apiFrequencyControl({name:"enableLogUpload",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||""}}),y.default.enableLogUpload());},disableLogUpload(){"on"===p.getParameters().forceLogUpload?null==T||T.logger.error("disableLogUpload: 禁止关闭日志上传"):(T&&T.apiFrequencyControl({name:"disableLogUpload",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||""}}),y.default.disableLogUpload());}},createClient(e){if(!f.checkSystemRequirements())throw console.error("浏览器环境不支持"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"云信sdk不支持，请使用最新版本的chrome浏览器"});_.checkExists({tag:"createClient:ClientOptions",value:e}),_.checkExists({tag:"createClient:ClientOptions.appkey",value:e.appkey});const i=new s.Client(Object.assign(e,{apiList:[],ref:t.NERTC}));return p.getParameters().clients.push(i),T||(T=i),i},createStream(e){if(_.checkExists({tag:"createStream:options",value:e}),b.isHttpProtocol())throw null==T||T.adapterRef.logger.warn("The current protocol is HTTP"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"请使用https环境或者loclhost环境"});if(!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia))throw console.warn("没有 getUserMedia 方法。请使用最新版本的chrome浏览器"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"浏览器不支持开启媒体设备，请使用最新版本的chrome浏览器"});if(e.screenAudio&&!e.screen)throw new v.default({code:g.default.INVALID_OPERATION_ERROR,message:"createStream: screenAudio 要与 screen 一起开启"});if(!e.client&&T&&T.adapterRef.logger.warn("createStream: 未传入client参数。使用默认Client。"),T||e.client){const t=new a.LocalStream(Object.assign(e,{isRemote:!1,client:e.client||T}));return p.getParameters().localStreams.push(t),t}return n.clientNotYetUninitialized},Device:h.Device,getDevices:(e=!1)=>h.Device.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:e}),getCameras:(e=!1)=>h.Device.getCameras(e),getMicrophones:(e=!1)=>h.Device.getMicrophones(e),getSpeakers:(e=!1)=>h.Device.getSpeakers(e),checkSystemRequirements:f.checkSystemRequirements,getSupportedCodec:async()=>await R.getSupportedCodecs(),checkBrowserCompatibility:async()=>await b.checkBrowserCompatibility(),getHandler:()=>u.detectDevice(),getParameters:p.getParameters,destroy(e){let t=e||T;t&&t.destroy(),e||(T=null);},PlatformTypeMap:m.PlatformTypeMap,CHAT_VIDEO_FRAME_RATE_NORMAL:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,CHAT_VIDEO_FRAME_RATE_5:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,CHAT_VIDEO_FRAME_RATE_10:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10,CHAT_VIDEO_FRAME_RATE_15:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15,CHAT_VIDEO_FRAME_RATE_20:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20,CHAT_VIDEO_FRAME_RATE_25:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25,CHAT_VIDEO_FRAME_RATE_30:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_30,VIDEO_QUALITY_180p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p,VIDEO_QUALITY_480p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p,VIDEO_QUALITY_720p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p,VIDEO_QUALITY_1080p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,RECORD_VIDEO_QUALITY_360p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_360p,RECORD_VIDEO_QUALITY_480p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_480p,RECORD_VIDEO_QUALITY_720p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_720p,RECORD_VIDEO_FRAME_RATE_15:l.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_15,RECORD_VIDEO_FRAME_RATE_30:l.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_30,LIVE_STREAM_AUDIO_CODEC_PROFILE:d.LIVE_STREAM_AUDIO_CODEC_PROFILE,LIVE_STREAM_AUDIO_SAMPLE_RATE:d.LIVE_STREAM_AUDIO_SAMPLE_RATE,VIDEO_FRAME_RATE:l.VIDEO_FRAME_RATE,VIDEO_QUALITY:l.NERTC_VIDEO_QUALITY,NETWORK_STATUS:c.NETWORK_STATUS,STREAM_TYPE:l.STREAM_TYPE,VERSION:o.SDK_VERSION,BUILD:o.BUILD,ENV:o.ENV},e.exports=E.WebRTC2=t.NERTC;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const s=i(62),a=i(122),o=i(117),n=i(148),d=i(211),c=i(4),l=i(150),u=i(63),h=i(64),p=r(i(12)),m=r(i(13)),f=i(212),g=i(65),v=i(213),y=i(295);class S extends v.Base{constructor(e){super(e),this.destroyed=!1,this.onJoinFinish=null,this.spatialManager=null,this.apiFrequencyControl({name:"createClient",code:0,param:{clientUid:"",debug:e.debug}}),this.operationQueue=new f.OperationQueue(this.logger),this.handlePageUnload=e=>{"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.logger.warn(`收到 ${null==e?void 0:e.type} 事件，当前状态：${this.adapterRef.channelStatus}，即将离开房间`),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=p.default.PAGE_UNLOAD,this.leave());},this.handleOnOnlineOffline=e=>{var t,i,r,s,a;"online"===(null==e?void 0:e.type)?"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络恢复，恢复重连过程"),this.resumeReconnection()):this.logger.warn("侦测到网络恢复"):"offline"===(null==e?void 0:e.type)&&("CONNECTED"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络断开，主动断开连接"),this.pauseReconnection(),null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i||i.close(),null===(s=null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r._recvTransport)||void 0===s||s.close(),this.adapterRef.channelStatus="connectioning",null===(a=this.adapterRef._signalling)||void 0===a||a._reconnection()):this.logger.warn("侦测到网络断开"));},c.getParameters().leaveOnUnload&&(window.addEventListener("pagehide",this.handlePageUnload),window.addEventListener("beforeunload",this.handlePageUnload)),c.getParameters().trustOnOnline&&(window.addEventListener("online",this.handleOnOnlineOffline),window.addEventListener("offline",this.handleOnOnlineOffline)),this._roleInfo={userRole:0,audienceList:{}},this._init(e),this.logger.info(`NERTC ${s.SDK_VERSION} ${s.BUILD}: 客户端创建成功。`),this.on("@connection-state-change",e=>{var t,i,r;"CONNECTED"===e.prevState&&(null===(t=this.recordManager.record)||void 0===t?void 0:t._status.isRecording)&&"started"===(null===(i=this.recordManager.record)||void 0===i?void 0:i._status.state)&&(this.logger.log("自动停止客户端录制功能"),this.recordManager.record.download()),"CONNECTED"===e.curState&&"CONNECTING"===e.prevState&&(e.reconnect&&this.adapterRef.lbsManager.startUpdate("reconnect"),(null===(r=this.adapterRef.datareportCache)||void 0===r?void 0:r.length)&&(this.logger.log(`上报进频道前事件：${this.adapterRef.datareportCache.length}条: ${this.adapterRef.datareportCache.map(e=>e.func).join()}`),this.adapterRef.datareportCache.forEach(e=>{const t=e.datareport[e.func];t&&(t.cid=t.cid||this.adapterRef.channelInfo.cid,t.uid=t.uid||this.adapterRef.channelInfo.uid),e.datareport.send();}),this.adapterRef.datareportCache=[]));});}_init(e){const{appkey:t="",token:i}=e;this._params.appkey=t,this.adapterRef.lbsManager.loadBuiltinConfig("oninit"),this._params.token=i,this._roleInfo={userRole:0,audienceList:{}},o.Device.deviceInited||o.Device.startDeviceChangeDetection(),o.Device.on("recording-device-changed",e=>{this.destroyed||(this.safeEmit("recording-device-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"recording-device-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}));}),o.Device.on("camera-changed",e=>{this.destroyed||(this.safeEmit("camera-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"camera-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}));}),o.Device.on("playout-device-changed",e=>{this.destroyed||(this.safeEmit("playout-device-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"playout-device-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}));});const r=()=>{this.onJoinFinish?(this.onJoinFinish(),this.onJoinFinish=null):this.logger.debug("孤立的join完成回调");};this.addListener("@pairing-join-success",r),this.addListener("@pairing-join-error",r),"never"!==c.getParameters().enableAlerter&&o.alerter.watchClient(this.adapterRef.instance);}getUid(){return this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid}getParameter(e="getChannelInfo"){if(this.apiFrequencyControl({name:"getParameter",code:0,param:{type:e}}),"getChannelInfo"===e){const e=`appkey=${this._params.appkey}&osType=4&mode=2&netType=0&version=${s.SDK_VERSION+".0"}&webrtc=1&nrtcg2=1&t1=${Date.now()}`,t={"Content-Type":"application/x-www-form-urlencoded"};return JSON.stringify({postData:e,header:t})}}getChannelInfo(){return this.apiFrequencyControl({name:"getChannelInfo",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||""}}),this.adapterRef.channelInfo||{}}startProxyServer(e){let t=null;if(this.adapterRef.logger.log("startProxyServer() type: ",e),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.adapterRef.logger.warn("startProxyServer() 请在加入房间前调用"),t="startProxyServer() 请在加入房间前调用"),this.apiFrequencyControl({name:"startProxyServer",code:t?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:t}}),t)throw new m.default({code:p.default.API_CALL_SEQUENCE_BEFORE_ERROR,message:"startProxyServer() 请在加入房间前调用"});this.adapterRef.proxyServer.enable=!0,e&&(this.adapterRef.proxyServer.type=e);}stopProxyServer(){this.adapterRef.logger.log("stopProxyServer()"),this.adapterRef.proxyServer&&(this.adapterRef.proxyServer.enable=!1,this.adapterRef.proxyServer.wsProxyArray=null),this.apiFrequencyControl({name:"stopProxyServer",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:""}});}setLocalMediaPriority(e){this.logger.log("setLocalMediaPriority() options: ",JSON.stringify(e));let t=0,i="";"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(i="setLocalMediaPriority() 请在加入房间前调用",t=p.default.API_CALL_SEQUENCE_BEFORE_ERROR),100!==e.priority&&50!==e.priority&&(i="setLocalMediaPriority: options.priority应该是100或者50",t=p.default.SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR);const{priority:r=100,preemtiveMode:s=!1}=e;if(this.apiFrequencyControl({name:"setLocalMediaPriority",code:t?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",priority:r,preemtiveMode:s,reason:t,message:i}}),t)throw this.logger.error(i),new m.default({code:t,message:i});this.adapterRef.userPriority=e;}async join(e){this.logger.log("join() 加入频道, options: ",JSON.stringify(e,null," "));try{if(!e.channelName||""===e.channelName)throw this.logger.log("join(): 请填写房间名称"),new m.default({code:p.default.JOIN_WITHOUT_CHANNEL_NAME,message:"join(): 请填写房间名称"});if(e.joinChannelRecordConfig&&(g.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordAudio should be boolean",value:e.joinChannelRecordConfig.recordAudio}),g.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordVideo should be boolean",value:e.joinChannelRecordConfig.recordVideo})),"string"==typeof e.uid){if(this.logger.log("join(): uid是string类型"),!/^\d+(\.\d+)?$/.test(e.uid))throw this.logger.log("join(): uid不是数字字符串格式"),new m.default({code:p.default.JOIN_UID_TYPE_ERROR,message:"join() uid不是数字字符串格式"});this.adapterRef.channelInfo.uidType="string";}else {if("number"!=typeof e.uid)return this.logger.error("join(): uid参数格式非法"),Promise.reject(new m.default({code:p.default.JOIN_UID_TYPE_ERROR,message:"join() uid参数格式非法"}));if(this.logger.log("join(): uid是number类型"),this.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw this.logger.log("join():uid参数越界, 会导致精度缺失"),new m.default({code:p.default.JOIN_UID_TYPE_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1, 请输入正确的参数"})}if(this.onJoinFinish=await this.operationQueue.enqueue({caller:this,method:"join",options:e}),this.safeEmit("@pairing-join-start"),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus)return this.safeEmit("@pairing-join-error"),Promise.reject(new m.default({code:p.default.REPEAT_JOIN_ERROR,message:"join() 重复加入房间"}));this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.prevState="DISCONNECTED",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),e.spatial&&this.initSpatialManager(e.spatial),e.token&&(this._params.token=e.token),e.customData&&(this.adapterRef.channelInfo.customData=e.customData),this._params.JoinChannelRequestParam4WebRTC2={startJoinTime:Date.now(),appkey:this._params.appkey,userRole:this._roleInfo.userRole,channelName:e.channelName,wssArr:e.wssArr,uid:e.uid,permKey:e.permKey||"",token:this._params.token,joinChannelLiveConfig:e.joinChannelLiveConfig||{liveEnable:!1},joinChannelRecordConfig:e.joinChannelRecordConfig||{recordAudio:!1,recordVideo:!1,recordType:0,isHostSpeaker:!1},getChanneInfoResponse:e.getChanneInfoResponse},e.neRtcServerAddresses&&(this._params.neRtcServerAddresses={channelServer:e.neRtcServerAddresses.channelServer||"",statisticsServer:e.neRtcServerAddresses.statisticsServer||"",statisticsWebSocketServer:e.neRtcServerAddresses.statisticsWebSocketServer||"",roomServer:e.neRtcServerAddresses.roomServer||"",webSocketProxyServer:e.neRtcServerAddresses.webSocketProxyServer||"",mediaProxyServer:e.neRtcServerAddresses.mediaProxyServer||""});const t=this.adapterRef.lbsManager.loadLocalConfig("onjoin");if(t.config){const e=t.config.ts+1e3*t.config.config.ttl-Date.now();e<1e3*t.config.config.preloadTimeSec&&(this.logger.log(`join() LBS在 ${Math.floor(e/1e3)} 秒后过期。preloadTimeSec: ${t.config.config.preloadTimeSec}。发起异步刷新请求`),this.adapterRef.lbsManager.startUpdate("renew"));}else this.adapterRef.lbsManager.startUpdate(t.reason);if(this.setStartSessionTime(),this.initMode(),!this.adapterRef.mediaCapability.supportedCodecRecv||!this.adapterRef.mediaCapability.supportedCodecSend)try{await this.adapterRef.mediaCapability.detect();}catch(e){this.logger.warn("join() Failed to detect mediaCapability: ",e.name,e.message);}if(!this.adapterRef._meetings)throw this.logger.error("join() meeting模块缺失"),this.safeEmit("@pairing-join-error"),new m.default({code:p.default.UNKNOWN_TYPE_ERROR,message:"join() meeting模块缺失"});const i=await this.adapterRef._meetings.joinChannel(this._params.JoinChannelRequestParam4WebRTC2);return this.safeEmit("@pairing-join-success"),this.apiFrequencyControl({name:"join",code:0,param:Object.assign({},e)}),i}catch(t){throw this.safeEmit("@pairing-join-error"),this.apiFrequencyControl({name:"join",code:-1,param:Object.assign(Object.assign({},e),{reason:t&&t.message})}),new m.default({code:t.getCode&&t.getCode()||p.default.JOIN_FAILED,message:t.getCode&&t.getMessage()||`join() 内部错误: ${t.name}, ${t.message}`})}}async leave(){var e;const t=await this.operationQueue.enqueue({caller:this,method:"leave",options:null}),i=(null===(e=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2)||void 0===e?void 0:e.logoutReason)||0;this.logger.log("leave() 离开频道: ",i),this.adapterRef.instance.apiEventReport("setLogout",{reason:i}),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings?this.adapterRef._meetings.leaveChannel().then(t):(this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},t()),this.apiFrequencyControl({name:"leave",code:0,param:{clientUid:this.getUid()}});}async leaveRts(){this.logger.log("离开频道"),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus&&this.logger.log(" 状态: ",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings&&this.adapterRef._meetings.leaveChannel();}setEncryptionMode(e){if(g.checkValidInteger({tag:"Valid encryptionModes are: "+Object.keys(n.EncryptionModes).join(","),value:n.encryptionModeToInt(e)}),this.adapterRef.encryption.encodedInsertableStreams){const e="setEncryptionMode() 自定义加密功能与国密加密功能不兼容";throw this.logger.error(e),new m.default({code:p.default.SET_ENCRYPTION_MODE_ERROR,message:e})}this.logger.log("setEncryptionMode() 设置加密模式：",e),this.adapterRef.encryption.setEncryptionMode(e);const t={enable:"none"!==e,mode:n.encryptionModeToInt(e)};this.apiFrequencyControl({name:"setEncryptionMode",code:0,param:JSON.stringify(t,null," ")});}setEncryptionSecret(e){switch(this.adapterRef.encryption.encryptionMode){case"none":throw new m.default({code:p.default.SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR,message:"setEncryptionSecret() 请先设置加密模式"});case"sm4-128-ecb":g.checkValidString({tag:"client.setEncryptionSecret:encryptionSecret",value:e,min:1,max:128});}this.logger.log("设置加密密钥"),this.adapterRef.encryption.setEncryptionSecret(e),this.apiFrequencyControl({name:"setEncryptionSecret",code:0,param:JSON.stringify({encryptionSecret:e},null," ")});}enableCustomTransform(e){var t;let i,r;if("DISCONNECTED"!==this.adapterRef.connectState.curState?(i="enableCustomTransform() 必须在加入频道前调用",r=p.default.API_CALL_SEQUENCE_BEFORE_ERROR):"function"!=typeof window.TransformStream?(i="enableCustomTransform() 浏览器不支持自定义加密, TransformStream 未找到",r=p.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):"function"!=typeof(null===(t=window.RTCRtpReceiver)||void 0===t?void 0:t.prototype.createEncodedStreams)?(i="enableCustomTransform() 浏览器不支持自定义加解密，未找到createEncodedStreams",r=p.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):"none"!==this.adapterRef.encryption.encryptionMode&&(i="enableCustomTransform() 自定义加密功能与国密加密功能不兼容",r=p.default.SET_ENCRYPTION_MODE_ERROR),this.apiFrequencyControl({name:"enableCustomTransform",code:i?-1:0,param:JSON.stringify({enable:e,message:i})}),i)throw this.logger.error(i),new m.default({code:r,message:i});!1===e?(this.adapterRef.encryption.encodedInsertableStreams=!1,this.logger.log("enableCustomTransform() 已关闭自定义加解密")):(this.adapterRef.encryption.encodedInsertableStreams=!0,this.logger.log("enableCustomTransform() 已开启自定义加解密"));}async publish(e){g.checkExists({tag:"client.publish:stream",value:e}),await this.doPublish(e);}async doPublish(e){const t=await this.operationQueue.enqueue({caller:this,method:"publish",options:e});let i=0,r="";const s=()=>{var s,a;t();const o={reason:i,message:r,pubStatus:e.pubStatus};(e.mediaHelper.video.cameraTrack||e.mediaHelper.video.videoSource)&&(o.webcamProducerCodec=null===(s=this.adapterRef._mediasoup)||void 0===s?void 0:s._webcamProducerCodec),(e.mediaHelper.screen.screenVideoTrack||e.mediaHelper.screen.screenVideoSource)&&(o.screenProducerCodec=null===(a=this.adapterRef._mediasoup)||void 0===a?void 0:a._screenProducerCodec),this.apiFrequencyControl({name:"publish",code:i?-1:0,param:JSON.stringify(o)});const n=JSON.stringify(e.mediaHelper.getTrackSettings());this.apiFrequencyControl({name:"_trackSettings",code:0,param:n}),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"media_track_Settings",customIdentify:"publish",param:n});};if(e&&(e.audio||e.video||e.screen||e.screenAudio)?1===this._roleInfo.userRole?(r="publish() 观众禁止Publish, 请先使用setClientRole设为主播",this.logger.error(r),i=p.default.PUBLISH_ROLE_ERROR):"CONNECTING"===this.adapterRef.connectState.curState?(r="publish() 当前正在连接, 将在连接成功后发布媒体流",this.bindLocalStream(e),i=p.default.RECONNECTING):"CONNECTED"!==this.adapterRef.connectState.curState&&(r="publish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(r),i=p.default.API_CALL_SEQUENCE_BEFORE_ERROR):e&&c.getParameters().allowEmptyMedia?this.logger.log("publish() 当前模式允许发布没有媒体流的localStream"):(r="publish() 传入的 stream 格式非法，没有媒体数据",this.logger.error(r),i=p.default.PUBLISH_NO_STREAM),i)return r?(s(),Promise.reject(new m.default({code:i,message:r}))):void s();try{if(!this.adapterRef._mediasoup)throw r="publish() 媒体mediasoup模块缺失",i=p.default.UNKNOWN_TYPE_ERROR,this.logger.error(r),s(),new m.default({code:i,message:r});this.bindLocalStream(e),await this.adapterRef._mediasoup.createProduce(e,"all"),s();}catch(e){throw this.logger.error("publish() 内部错误: ",e.name,e.message),i=p.default.UNKNOWN_TYPE_ERROR,r=e.message,s(),new m.default({code:e.getCode&&e.getCode()||i,message:e.getCode&&e.getMessage()||`publish() 内部错误: ${e.name}, ${e.message}`})}}async unpublish(e){g.checkExists({tag:"client.unpublish:stream",value:e});const t=await this.operationQueue.enqueue({caller:this,method:"unpublish",options:null}),i=()=>{t();JSON.stringify({pubStatus:e&&e.pubStatus,reason:r,message:s},null," ");this.apiFrequencyControl({name:"unpublish",code:r?-1:0,param:{clientUid:this.getUid(),pubStatus:e&&e.pubStatus,reason:r}});};let r=0,s="";if("CONNECTING"===this.adapterRef.connectState.curState?(this.adapterRef.localStream=null,s="unpublish() 当前正在连接, 连接成功后将不再发送媒体流",r=p.default.RECONNECTING):"CONNECTED"!==this.adapterRef.connectState.curState&&(s="unpublish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(s),r=p.default.API_CALL_SEQUENCE_BEFORE_ERROR),r)return i(),s?(this.logger.error(s),Promise.reject(new m.default({code:r,message:s}))):void 0;this.logger.log("unpublish(): 开始取消发布本地流");try{if(!this.adapterRef._mediasoup)throw s="unpublish() 媒体mediasoup模块缺失",r=p.default.UNKNOWN_TYPE_ERROR,this.logger.error(s),i(),new m.default({code:r,message:s});await this.adapterRef._mediasoup.destroyProduce("audio"),await this.adapterRef._mediasoup.destroyProduce("audioSlave"),await this.adapterRef._mediasoup.destroyProduce("video"),await this.adapterRef._mediasoup.destroyProduce("screen"),this.adapterRef.localStream=null,i();}catch(e){throw this.logger.error("unpublish() 内部错误: ",e.name,e.message),r=p.default.UNKNOWN_TYPE_ERROR,s=e.message,i(),new m.default({code:e.getCode&&e.getCode()||r,message:e.getCode&&e.getMessage()||`publish() 内部错误: ${e.name}, ${e.message}`})}}getSubStatus(e,t){let i={status:"unsubscribed",subscribable:!1};if("all"===t){const t=[this.getSubStatus(e,"audio"),this.getSubStatus(e,"audioSlave"),this.getSubStatus(e,"video"),this.getSubStatus(e,"screen")];t.find(e=>"unsubscribing"===e.status)?i.status="unsubscribing":t.find(e=>"subscribing"===e.status)&&(i.status="subscribing"),t.find(e=>"subscribed"===e.status)&&(i.status="subscribed"),"subscribed"!==i.status&&"unsubscribed"!==i.status||t.find(e=>e.subscribable)&&(i.subscribable=!0);}else "start"===e.pubStatus[t].stopconsumerStatus?i.status="unsubscribing":"start"===e.pubStatus[t].consumerStatus?i.status="subscribing":e.pubStatus[t].consumerId?i.status="subscribed":"unsubscribed"===i.status&&e.pubStatus[t].producerId&&e.subConf[t]&&(i.subscribable=!0);return i}async subscribe(e,t){if(!this.spatialManager)return g.checkExists({tag:"client.subscribe:stream",value:e}),t?(this.logger.log(`subscribe [订阅远端: ${e.stringStreamID}] ${JSON.stringify(t)}`),e.doSetSubscribeConfig(t),this.doSubscribe(e)):(this.logger.log("subscribe() [订阅远端: ${stream.stringStreamID}]"),this.doSubscribe(e));this.logger.warn("subscribe() 已开启空间音频，跳过用户订阅步骤");}async doSubscribe(e){var t,i,r,s,o,n;const d=e.getId();if(!this.adapterRef._mediasoup){const e="subscribe() 媒体mediasoup模块缺失";throw this.logger.error(e),new m.default({code:p.default.UNKNOWN_TYPE_ERROR,message:e})}try{if(e.subConf.audio)!1===(null===(t=this.adapterRef.permKeyInfo)||void 0===t?void 0:t.subAudioRight)?(this.logger.error("subscribe() permKey权限控制你没有权限订阅audio"),this.adapterRef.instance.emit("error","no-subscribe-audio-permission")):e.pubStatus.audio.audio&&!e.pubStatus.audio.consumerId&&(this.logger.log(`subscribe() 开始订阅 ${e.getId()} 音频流`),e.pubStatus.audio.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(d,"audio","audio",e.pubStatus.audio.producerId),e.pubStatus.audio.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${e.getId()} 音频流完成`));else if(e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 音频流`),e.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.mediaHelper.updateStream("audio",null),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioStats[t],this.logger.log(`subscribe() 取消订阅 ${e.getId()} 音频流完成`);}if(e.subConf.audioSlave)!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.subAudioRight)?(this.logger.error("subscribe() permKey权限控制你没有权限订阅audio slave"),this.adapterRef.instance.emit("error","no-subscribe-audio-slave-permission")):e.pubStatus.audioSlave.audioSlave&&!e.pubStatus.audioSlave.consumerId&&(this.logger.log(`subscribe() 开始订阅 ${e.getId()} 音频辅流`),e.pubStatus.audioSlave.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(d,"audio","audioSlave",e.pubStatus.audioSlave.producerId),e.pubStatus.audioSlave.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${e.getId()} 音频辅流完成`));else if(e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 音频辅流`),e.pubStatus.audioSlave.stopconsumerStatus="start",await(null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave")),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.mediaHelper.updateStream("audioSlave",null),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log("subscribe() 取消订阅 ${stream.getId()} 音频辅流完成");}if(e.subConf.video)if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.subVideoRight))this.logger.error("subscribe() permKey权限控制你没有权限订阅video"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(e.pubStatus.video.video&&!e.pubStatus.video.consumerId){let t;this.logger.log(`subscribe() 开始订阅 ${e.getId()} 视频流`),t=e.subConf.highOrLow.video===a.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(d,"video","video",e.pubStatus.video.producerId,t),this.logger.log(`subscribe() 订阅 ${e.getId()} 视频流完成`);}else this.logger.log("subscribe() stream.pubStatus.video: ",JSON.stringify(e.pubStatus.video));else e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus&&(this.logger.log("`subscribe() 开始取消订阅 ${stream.getId()} 视频流`"),e.pubStatus.video.stopconsumerStatus="start",await(null===(o=this.adapterRef._mediasoup)||void 0===o?void 0:o.destroyConsumer(e.pubStatus.video.consumerId,e,"video")),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.mediaHelper.updateStream("video",null),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1,this.logger.log(`subscribe() 取消订阅 ${e.getId()} 视频流完成`));if(e.subConf.screen){if(!1===(null===(n=this.adapterRef.permKeyInfo)||void 0===n?void 0:n.subVideoRight))this.logger.error("subscribe() permKey权限控制你没有权利订阅screen"),this.adapterRef.instance.emit("error","no-subscribe-screen-permission");else if(e.pubStatus.screen.screen&&!e.pubStatus.screen.consumerId){let t;this.logger.log(`subscribe() 开始订阅 ${e.getId()} 辅流`),t=e.subConf.highOrLow.screen===a.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(d,"video","screenShare",e.pubStatus.screen.producerId,t),this.logger.log(`subscribe() 订阅 ${e.getId()} 辅流完成`);}}else if(e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 辅流`),e.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.mediaHelper.updateStream("screen",null),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();t&&delete this.adapterRef.remoteScreenStats[t],this.logger.log(`subscribe() 取消订阅 ${e.getId()} 辅流完成`);}this.apiFrequencyControl({name:"subscribe",code:0,param:JSON.stringify({reason:"",subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")});}catch(t){if("resetConsumeRequestStatus"===t)return void this.logger.warn("subscribe() API调用被打断");throw this.logger.error("subscribe() 内部错误: ",t.message),this.apiFrequencyControl({name:"subscribe",code:-1,param:JSON.stringify({reason:t.message,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")}),new m.default({code:t.getCode&&t.getCode()||p.default.UNKNOWN_TYPE_ERROR,message:t.getCode&&t.getMessage()||`subscribe() 内部错误: ${t.name}, ${t.message}`})}}async unsubscribe(e,t){if(g.checkExists({tag:"client.unsubscribe:stream",value:e}),!t)return this.logger.log(`unsubscribe() [取消订阅远端: ${e.getId()}]`),this.doUnsubscribe(e);{g.checkValidObject({tag:"client.unsubscribe:unsubscribeOptions",value:t}),this.logger.log(`unsubscribe ${e.getId()} ${JSON.stringify(t)}`);const i={audio:e.subConf.audio,audioSlave:e.subConf.audio,video:e.subConf.video,screen:e.subConf.screen};h.MediaTypeList.forEach(e=>{!0===t[e]&&(i[e]=!1);}),e.doSetSubscribeConfig(i),this.doSubscribe(e);}}async doUnsubscribe(e,t){if(!this.adapterRef._mediasoup){const e="unsubscribe() 媒体mediasoup模块缺失";throw this.logger.error(e),new m.default({code:p.default.UNKNOWN_TYPE_ERROR,message:e})}try{if((void 0===t||"audio"===t)&&e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的音频流`),e.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.mediaHelper.updateStream("audio",null),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的音频流完成`);}if((void 0===t||"audioSlave"===t)&&e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的音频辅流`),e.pubStatus.audioSlave.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave"),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.mediaHelper.updateStream("audioSlave",null),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的音频辅流完成`);}if((void 0===t||"video"===t)&&e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的视频流`),e.pubStatus.video.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.mediaHelper.updateStream("video",null),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1;e.getId();this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的视频流完成`);}if((void 0===t||"screen"===t)&&e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的视频辅流`),e.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.mediaHelper.updateStream("screen",null),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();t&&delete this.adapterRef.remoteScreenStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的视频辅流完成`);}this.apiFrequencyControl({name:"unsubscribe",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:"",subStatus:e.subStatus,subConf:e.subConf},null," ")});}catch(t){throw this.logger.error("unsubscribe() 内部错误:",t,t.name,t.message),this.apiFrequencyControl({name:"unsubscribe",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:t.message,subStatus:e.subStatus,subConf:e.subConf},null," ")}),new m.default({code:t.getCode&&t.getCode()||p.default.UNKNOWN_TYPE_ERROR,message:t.getCode&&t.getMessage()||`unsubscribe() 内部错误: ${t.name}, ${t.message}`})}}async setRemoteVideoStreamType(e,t){var i;this.logger.log(`setRemoteVideoStreamType() uid ${e.getId()} 订阅成员的${t?"小":"大"}流`,t);try{await(null===(i=this.adapterRef._mediasoup)||void 0===i?void 0:i.setConsumerPreferredLayer(e,t?0:1,"video")),e.subConf.highOrLow.video=t,this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,highOrLow:t},null," ")});}catch(i){throw this.logger.error("setRemoteVideoStreamType() 内部错误: ",i.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:i.message,highOrLow:t},null," ")}),new m.default({code:i.getCode&&i.getCode()||p.default.UNKNOWN_TYPE_ERROR,message:i.getMessage&&i.getMessage()||"内部错误: "+i.message})}}async setRemoteStreamType(e,t,i){var r;this.logger.log(`setRemoteStreamType() 订阅${e.getId()}成员${t}媒体的${t?"小":"大"}流`);try{await(null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r.setConsumerPreferredLayer(e,t?0:1,i)),e.subConf.highOrLow[i]=t,this.apiFrequencyControl({name:"setRemoteStreamType",code:0,param:{highOrLow:t,mediaType:i,clientUid:this.getUid(),streamID:e.stringStreamID}});}catch(r){throw this.logger.error("setRemoteStreamType() 内部错误: ",r.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:r.message,highOrLow:t,mediaType:i,streamID:e.stringStreamID},null," ")}),new m.default({code:r.getCode&&r.getCode()||p.default.UNKNOWN_TYPE_ERROR,message:r.getMessage&&r.getMessage()||"setRemoteStreamType() 内部错误: "+r.message})}}enableAudioVolumeIndicator(){this.logger.log("开启音量提醒");}enableDualStream(e={video:!0,screen:!1}){this.adapterRef.channelInfo.videoLow=e.video,this.adapterRef.channelInfo.screenLow=e.screen,this.logger.log("enableDualStream() 开启双流模式"),this.apiFrequencyControl({name:"enableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}});}disableDualStream(e={video:!1,screen:!1}){this.logger.log("disableDualStream() 关闭双流模式"),this.adapterRef.channelInfo.videoLow=!1,this.adapterRef.channelInfo.screenLow=!1,this.apiFrequencyControl({name:"disableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}});}setPlaybackVolume(e){let t,i;if(!Number.isInteger(e)||e<0||e>100)t=p.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,i="setPlaybackVolume() volume 应该为 0 - 100 的整数";else {const t=e/100;this.logger.log(`setPlaybackVolume: ${this.adapterRef.nomalizedPlaybackVolume} => ${t} normalized`),this.adapterRef.nomalizedPlaybackVolume=t;}if(this.apiFrequencyControl({name:"setPlaybackVolume",code:t?-1:0,param:{volume:e}}),t)throw this.logger.error(i),new m.default({code:t,message:i});for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active&&t._play.updatePlaybackVolume();}}async setClientRole(e){var t;let i,r,s;if("host"===e||"broadcaster"===e?i=0:"audience"===e?i=1:(s="setClientRole() 无法识别的角色："+e,this.logger.error(s),r=p.default.ROLE_TYPE_ERROR,i=-1),!r){const a=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid||"";if(i===this._roleInfo.userRole)this.logger.warn(`setClientRole() 用户${a}的角色已经是${e}了`);else switch(this.adapterRef.connectState.curState){case"CONNECTED":1===i&&this.adapterRef.localStream&&this.isPublished(this.adapterRef.localStream)&&(this.logger.info(`setClientRole() 主播 ${a}将设为观众，自动Unpublish中`),await this.unpublish(this.adapterRef.localStream)),await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.updateUserRole(i)),this._roleInfo.userRole!==i&&(this._roleInfo.userRole=i,this.logger.info(`setClientRole() 本地用户${a} 设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;case"DISCONNECTED":this._roleInfo.userRole!==i&&(this._roleInfo.userRole=i,this.logger.info(`setClientRole() 本地用户${a}设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;default:s=`setClientRole() 本地用户${a}当前不在频道中，可能是网络波动导致暂时断开连接`,this.logger.error(s),r=p.default.USER_NOT_IN_CHANNEL_ERROR;}}if(this.apiFrequencyControl({name:"setClientRole",code:r?-1:0,param:{role:e,reason:r}}),r)throw new m.default({code:r,message:s})}bindLocalStream(e){this.adapterRef.localStream=e,e.client=this,e.logger.parent=this.logger;const t=this.getUid();t&&e.streamID!==t&&(this.logger.warn("localStream更换streamID",e.streamID,"=>",t),e.streamID=t,e.stringStreamID=t.toString());}getConnectionState(){return this.apiFrequencyControl({name:"getConnectionState",code:0,param:JSON.stringify({},null," ")}),this.adapterRef.connectState.curState}getSystemStats(){return navigator.getBattery?new Promise((e,t)=>{navigator.getBattery().then((function(t){e(100*t.level);}));}):Promise.reject(new m.default({code:p.default.GET_SYSTEM_STATS_NOT_SUPPORT_ERROR,message:"getSystemStats() 浏览器不支持, 建议使用最新版的 Chrome 浏览器"}))}getSessionStats(){return new Promise((e,t)=>{this.adapterRef.sessionStats.Duration=(Date.now()-this.adapterRef.state.startSessionTime)/1e3,this.adapterRef.sessionStats.UserCount=Object.keys(this.adapterRef.memberMap).length+1,e(this.adapterRef.sessionStats);})}getTransportStats(){return new Promise((e,t)=>{e(this.adapterRef.transportStats);})}getLocalAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.localAudioStats);})}getLocalAudioSlaveStats(){return new Promise((e,t)=>{e(this.adapterRef.localAudioSlaveStats);})}getLocalVideoStats(e){let t=[];return e&&"video"!==e||(t=t.concat(this.adapterRef.localVideoStats)),e&&"screen"!==e||(t=t.concat(this.adapterRef.localScreenStats)),Promise.resolve(t)}getRemoteAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.remoteAudioStats);})}getRemoteAudioSlaveStats(){return new Promise((e,t)=>{e(this.adapterRef.remoteAudioSlaveStats);})}getRemoteVideoStats(e){let t={};return e&&"screen"!==e||(t=Object.assign(t,this.adapterRef.remoteScreenStats)),e&&"video"!==e||(t=Object.assign(t,this.adapterRef.remoteVideoStats)),Promise.resolve(t)}setChannelProfile(e){const t=(null==e?void 0:e.mode)||null;let i,r;if(this.logger.log("setChannelProfile, options: ",JSON.stringify(e,null," ")),"rtc"!==t&&"live"!==t&&(r="setChannelProfile: 参数格式错误",i=p.default.SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR,this.logger.warn(r)),"DISCONNECTED"!==this.adapterRef.connectState.curState?(r="setChannelProfile() 请在加入房间之前调用",i=p.default.API_CALL_SEQUENCE_BEFORE_ERROR,this.logger.warn(r)):(this.adapterRef.localStream&&("live"===t?this.adapterRef.localStream.audioProfile="music_standard":"rtc"===t&&(this.adapterRef.localStream.audioProfile="speech_low_quality")),this._params.mode=t),this.apiFrequencyControl({name:"setChannelProfile",code:i?-1:0,param:{mode:JSON.stringify(e,null," "),reason:i,message:r}}),i)throw new m.default({code:i,message:r})}async updatePermKey(e){var t;try{this.logger.log("updatePermKey() permKey: "+e),this.adapterRef.channelInfo.permKey=e,await(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t.updatePermKey(e)),this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:0,param:{permKey:e}});}catch(t){throw this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:t.code,param:{permKey:e,reason:t.message}}),t}}async addTasks(e){var t;const{rtmpTasks:i=[]}=e;let r,s;if(this.logger.log("addTasks() 增加互动直播推流任务, options: ",JSON.stringify(e)),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="addTasks() 观众不允许进行添加推流任务",r=p.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="addTasks() 加入房间后进行添加推流任务",r=p.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="addTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",r=p.default.ADD_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new m.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.addTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}});}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),message:e.message}}),e}}async deleteTasks(e){var t;const{taskIds:i=[]}=e;let r,s;if(this.logger.log("deleteTasks() 删除互动直播推流任务, options: ",e),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="deleteTasks() 观众不允许删除推流任务",r=p.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="deleteTasks() 加入房间后才能删除推流任务",r=p.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="deleteTasks() 参数格式错误, taskIds为空, 或者该数组长度为空",r=p.default.DELETE_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new m.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.deleteTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}});}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}async updateTasks(e){var t;const{rtmpTasks:i=[]}=e;let r,s;if(this.logger.log("updateTasks() 更新互动直播推流任务, options: ",e),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="updateTasks() 观众不允许进行添加推流任务",r=p.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="updateTasks() 加入房间后进行添加推流任务",r=p.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="updateTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",r=p.default.UPDATE_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new m.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.updateTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:0,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call")}});}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}async pauseReconnection(){this.logger.log("pauseReconnection：下一次重连行为会被暂停，直到调用resumeReconnection()方法");const e=await new Promise(e=>{this.adapterRef._signalling&&this.adapterRef._signalling.reconnectionControl.pausers.push(e);});return this.logger.log("pauseReconnection：重连已被暂停："+JSON.stringify(e)),e}async resumeReconnection(){if(this.adapterRef._signalling){this.adapterRef._signalling.reconnectionControl.blocker?(this.logger.log("resumeReconnection：即将恢复重连过程"),this.adapterRef._signalling.reconnectionControl.blocker(),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-resume"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.adapterRef._signalling.reconnectionControl.pausers.length?(this.logger.log("resumeReconnection：取消之前的 pauseReconnection 操作。"),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"cancelled"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.logger.warn("resumeReconnection：未发现pauseReconnection操作");const e=await new Promise(e=>{var t;null===(t=this.adapterRef._signalling)||void 0===t||t.reconnectionControl.resumers.push(e);});return this.logger.log("resumeReconnection：恢复重连成功"+JSON.stringify(e)),e}}refreshRemoteEvents(){for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];this.logger.warn("refreshRemoteEvents peer-online",e),this.safeEmit("peer-online",{uid:e}),h.MediaTypeList.forEach(i=>{t.pubStatus[i].producerId&&(this.logger.warn("refreshRemoteEvents stream-added",e,i),this.safeEmit("stream-added",{stream:t,mediaType:i}),t.muteStatus[i].send&&(this.logger.warn("refreshRemoteEvents mute-"+i,e,i),this.safeEmit("mute-"+i,{uid:t.getId()})));});}}initSpatialManager(e){if(!this.spatialManager){const t=u.getAudioContext();if(!t)return void this.logger.error("当前环境不支持WebAudio");this.spatialManager=new y.SpatialManager({client:this,options:e,context:t});}this.spatialManager.init(),this.spatialManager.play();}syncUserList(){return this.adapterRef.memberMap}updateRecordingAudioStream(){if(!this.recordManager||!this.recordManager.formatMedia||!this.recordManager.formatMedia.destination)return;this.logger.log("updateRecordingAudioStream() [更新录制的音频]");const e=[];if(this.adapterRef.remoteStreamMap)for(var t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];e.push(i.mediaHelper.audio.audioStream);}this.adapterRef.localStream&&e.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),this.recordManager.formatMedia.updateStream(e);}async startMediaRecording(e){const{recorder:t,recordConfig:i}=e;this.recordManager.record||(this.recordManager.record=new l.Record({logger:this.logger,client:this.adapterRef.instance}),this.recordManager.record.on("media-recording-stopped",e=>{this.safeEmit("@media-recording-stopped");})),this.recordManager.formatMedia||(this.recordManager.formatMedia=new d.FormatMedia({adapterRef:this.adapterRef}));const r=[];if(this.adapterRef.localStream&&r.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),"all"===t&&this.adapterRef.remoteStreamMap)for(var s in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[s];r.push(e.mediaHelper.audio.audioStream);}const a=await this.recordManager.formatMedia.formatAudio(r),o=await this.recordManager.formatMedia.formatVideo(t,i),n=[];if(n.push(a,o),0!==n.length)return this.recordManager.record.start({uid:"",type:(null==i?void 0:i.recordType)||"video",recordName:null==i?void 0:i.recordName,reset:!0,stream:n});this.logger.log("没有没发现要录制的媒体流");}stopMediaRecording(e){if(!this.recordManager.record)throw new m.default({code:p.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.stop({})}cleanMediaRecording(){if(!this.recordManager.record)throw new m.default({code:p.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.clean()}downloadMediaRecording(){if(!this.recordManager.record)throw new m.default({code:p.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.download()}async destroy(){const e=await this.operationQueue.enqueue({caller:this,method:"destroy",options:null});this.logger&&this.logger.warn("清除 Client 实例中"),this._reset(),this.destroyed=!0,this.logger&&this.logger.warn("已清除 Client 实例"),e();}}t.Client=S;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ENV=t.LBS_BUILD_CONFIG=t.Config=void 0,t.Config={lbsUrl:"https://wecan-lbs.netease.im/api/v1/web_domains",checkSumUrl:"https://nrtc.netease.im/demo/getChecksum.action",createChannelUrl:"https://nrtc.netease.im/nrtc/createChannel.action",getChannelInfoUrl:"https://nrtc.netease.im/nrtc/getChannelInfos.action",roomsTaskUrl:"https://roomserver.netease.im/v2/sdk/rooms/",getCloudProxyInfoUrl:"https://ap-prd-jd.netease.im/v1/g2/getCloudProxyInfo"},t.LBS_BUILD_CONFIG={lbs:["wecan-lbs.netease.im","wecan-lbs.yunxinvcloud.com"],nrtc:["nrtc.netease.im","wecan-gw.yunxinvcloud.com"],call:["roomserver.netease.im","wecan-sdk.yunxinvcloud.com"],tracking:["statistic.live.126.net","apm.yunxinhi.com"]},t.ENV="production";},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.logHelper=void 0;t.logHelper=class{constructor(e){if(e.maxLogsLines&&"number"==typeof e.maxLogsLines&&!isNaN(e.maxLogsLines)?this.maxLogsLines=e.maxLogsLines:this.maxLogsLines=5e3,e.logFilename&&(e.logFilename=e.logFilename+".txt"),this.useTimestamps=e.useTimestamps||!1,this.useLocalStorage=e.useLocalStorage||!1,this.autoTrim=!0,this.maxLines=e.maxLogsLines||5e3,this.tailNumLines=100,this.logFilename=e.logFilename||"nimWebRtcLog.txt",this.maxDepth=5,this.depth=0,this.parentSizes=[0],this.currentResult="",this.startTime=new Date,this.output="",this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.output=i.log;var r=new Date(i.startTime),s=new Date(i.lastLog);this.output+="\n---- Session end: "+i.lastLog+" ----\n",this.output+=this.formatSessionDuration(r.getTime(),s.getTime()),this.output+="\n\n";}}this.output+="---- Session started: "+this.startTime+" ----\n\n";}getLog(){var e=new Date;if(this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.startTime=new Date(i.startTime),this.output=i.log,e=new Date(i.lastLog);}}return this.output+"\n---- Log retrieved: "+e+" ----\n"+this.formatSessionDuration(this.startTime.getTime(),e.getTime())}tail(e){e=e||this.tailNumLines;return this.trimLog(this.getLog(),e)}search(e){for(var t=this.output.split("\n"),i=new RegExp(e),r=[],s=0;s<t.length;s++){var a="["+s+"] ";t[s].match(i)&&r.push(a+t[s]);}var o=r.join("\n");return 0==o.length&&(o='Nothing found for "'+e+'".'),o}getSlice(e,t){return this.output.split("\n").slice(e,e+t).join("\n")}downloadLog(){var e=this.getLog(),t=new Blob([e],{type:"data:text/plain;charset=utf-8"}),i=document.createElement("a");i.href=window.URL.createObjectURL(t),i.target="_blank",i.download=this.logFilename,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(i.href);}clear(){var e=new Date;if(this.output="---- Log cleared: "+e+" ----\n",this.useLocalStorage){var t={startTime:this.startTime,log:this.output,lastLog:e},i=JSON.stringify(t);window.localStorage.setItem("nimWebRtcLog",i);}}log(e){var t=this.determineType(e);if(null!=t){var i=this.formatType(t,e);if(this.useTimestamps){var r=new Date;this.output+=this.formatTimestamp(r);}if(this.output+=i+"\n",this.autoTrim&&(this.output=this.trimLog(this.output,this.maxLines)),this.useLocalStorage){var s=new Date,a={startTime:this.startTime,log:this.output,lastLog:s},o=JSON.stringify(a);window.localStorage.setItem("nimWebRtcLog",o);}}this.depth=0,this.parentSizes=[0],this.currentResult="";}determineType(e){if(null!=e){var t,i=typeof e;if("object"==i)t=null==e.length?"function"==typeof e.getTime?"Date":"function"==typeof e.test?"RegExp":"Object":"Array";else t=i;return t}return "null"}formatType(e,t){if(this.maxDepth&&this.depth>=this.maxDepth)return "... (max-depth reached)";switch(e){case"Object":this.currentResult+="{\n",this.depth++,this.parentSizes.push(this.objectSize(t));var i=0;for(var r in t){this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+=r+": ";var s=this.determineType(t[r]);(a=this.formatType(s,t[r]))?("function"!==s&&(this.currentResult+=a),i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"),i++;}if(this.depth--,this.parentSizes.pop(),this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+="}",0==this.depth)return this.currentResult;break;case"Array":this.currentResult+="[",this.depth++,this.parentSizes.push(t.length);for(i=0;i<t.length;i++){var a;"Object"!=(s=this.determineType(t[i]))&&"Array"!=s||(this.currentResult+="\n"+this.indentsForDepth(this.depth)),(a=this.formatType(s,t[i]))?(this.currentResult+=a,i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),"Array"==s&&(this.currentResult+="\n")):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),("Object"!=s||i==this.parentSizes[this.depth]-1)&&(this.currentResult+="\n"));}if(this.depth--,this.parentSizes.pop(),this.currentResult+="]",0==this.depth)return this.currentResult;break;case"function":var o=(t+="").split("\n");for(i=0;i<o.length;i++)o[i].match(/\}/)&&this.depth--,this.currentResult+=this.indentsForDepth(this.depth),o[i].match(/\{/)&&this.depth++,this.currentResult+=o[i]+"\n";return this.currentResult;case"RegExp":return "/"+t.source+"/";case"Date":case"string":return this.depth>0||0==t.length?'"'+t+'"':t;case"boolean":return t?"true":"false";case"number":return t+""}}indentsForDepth(e){for(var t="",i=0;i<e;i++)t+="\t";return t}trimLog(e,t){var i=e.split("\n");return i.length>t&&(i=i.slice(i.length-t)),i.join("\n")}lines(){return this.output.split("\n").length}formatSessionDuration(e,t){var i=t-e,r=Math.floor(i/1e3/60/60),s=("0"+r).slice(-2);i-=1e3*r*60*60;var a=Math.floor(i/1e3/60),o=("0"+a).slice(-2);i-=1e3*a*60;var n=Math.floor(i/1e3);return i-=1e3*n,"---- Session duration: "+s+":"+o+":"+("0"+n).slice(-2)+" ----"}formatTimestamp(e){var t=e.getFullYear(),i=e.getDate();return "["+t+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+i+" "+Number(e.getHours())+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)+"]: "}objectSize(e){var t,i=0;for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&i++;return i}};},function(e,t){var i,r;i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var t=[],r=0;r<e.length;r+=3)for(var s=e[r]<<16|e[r+1]<<8|e[r+2],a=0;a<4;a++)8*r+6*a<=8*e.length?t.push(i.charAt(s>>>6*(3-a)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],r=0,s=0;r<e.length;s=++r%4)0!=s&&t.push((i.indexOf(e.charAt(r-1))&Math.pow(2,-2*s+8)-1)<<2*s|i.indexOf(e.charAt(r))>>>6-2*s);return t}},e.exports=r;},function(e,t){function i(e){return !!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}
    /*!
     * Determine if an object is a Buffer
     *
     * @author   Feross Aboukhadijeh <https://feross.org>
     * @license  MIT
     */
    e.exports=function(e){return null!=e&&(i(e)||function(e){return "function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}(e)||!!e._isBuffer)};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormatMedia=void 0;const s=i(10),a=r(i(12)),o=r(i(13)),n=i(123);class d extends s.EventEmitter{constructor(e){super(),this.adapterRef=e.adapterRef,this.logger=e.adapterRef.logger,this.audioContext=null,this.destination=null,this.audioStreams=[],this.canvas=null,this.canvasContext=null,this.canvasTimer=null;}async formatAudio(e){this.logger.log("formatAudio() [混音: ]",e);try{return this.audioContext||(this.audioContext=new window.AudioContext),this.destination=this.audioContext.createMediaStreamDestination(),await this.initAudioIn(e),this.destination.stream}catch(e){return this.logger.error("formatAudio() 异常: ",e.name,e.message),Promise.reject(new o.default({code:a.default.RECORDING_NOT_SUPPORT,message:e.message||"formatAudio() 浏览器不支持"}))}}initAudioIn(e){if(this.audioContext&&this.destination){for(var t=0;t<e.length;t++){const i=e[t].getAudioTracks()[0];if("live"!==(null==i?void 0:i.readyState))continue;const r=this.audioContext.createMediaStreamSource(e[t]);r.connect(this.destination),this.audioStreams.push(r);}this.logger.log(`initAudioIn() [初始化音频 state: ${this.audioContext.state}]`),"running"!==this.audioContext.state&&this.audioContext.resume().then(()=>{this.audioContext&&this.logger.log(`initAudioIn(): [audioContext 状态变更成功 state: ${this.audioContext.state}]`);}).catch(e=>{this.logger.warn(`initAudioIn(): [audioContext 状态变更发生错误, errorName: ${e.name}, erroMessage: ${e.message}]`),this.audioContext&&this.audioContext.resume();});}else this.logger.error("initAudioIn:参数不够");}async updateStream(e){this.logger.log("updateStream() [更新混频的音频数据: ]",e),this.audioStreams.forEach(e=>{e.disconnect(0);}),this.audioStreams.length=0,this.initAudioIn(e);}stopFormatAudio(){this.logger.log("stopFormatAudio() [结束混音]"),this.audioStreams.forEach(e=>{e.disconnect(0);}),this.audioContext&&this.audioContext.close(),this.audioContext=null,this.destination=null;}async formatVideo(e,t){this.logger.log("formatVideo() 混频 recorder: ",e,"recordConfig: ",t);let i=640,r=360;const s=(null==t?void 0:t.recordVideoFrame)||15;switch(null==t?void 0:t.recordVideoQuality){case 360:i=640,r=360;break;case 480:i=640,r=480;break;case 720:i=1280,r=720;}this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=n.get2DContext(this.canvas)),this.canvas.width=i,this.canvas.height=r,this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null);const a=Math.floor(i/2),o=Math.floor(r/2),d=Math.floor(i/3),c=Math.floor(r/3);return this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r)),this.canvasTimer&&clearInterval(this.canvasTimer),this.canvasTimer=setInterval(()=>{var s,n,l;this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r));let u=[];if("video"===(null==t?void 0:t.recordType)&&((null===(s=this.adapterRef.localStream)||void 0===s?void 0:s._play.video.dom)?u.push(this.adapterRef.localStream._play.video.dom):u.push(document.createElement("video")),(null===(n=this.adapterRef.localStream)||void 0===n?void 0:n._play.screen.dom)&&u.push(null===(l=this.adapterRef.localStream)||void 0===l?void 0:l._play.screen.dom),"all"===e&&this.adapterRef.remoteStreamMap))for(var h in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[h];e._play.video.dom&&u.push(e._play.video.dom),e._play.screen.dom&&u.push(e._play.screen.dom);}switch(u.length>9&&(u=u.filter(e=>4===e.readyState)),u.length){case 0:break;case 1:this.drawSingleVideo(u[0],0,0,i,r);break;case 2:this.drawSingleVideo(u[0],0,0,a,r),this.drawSingleVideo(u[1],a,0,a,r);break;case 3:case 4:this.drawSingleVideo(u[0],0,0,a,o),this.drawSingleVideo(u[1],a,0,a,o),this.drawSingleVideo(u[2],0,o,a,o),this.drawSingleVideo(u[3],a,o,a,o);break;default:this.drawSingleVideo(u[0],0,0,d,c),this.drawSingleVideo(u[1],d,0,d,c),this.drawSingleVideo(u[2],2*d,0,d,c),this.drawSingleVideo(u[3],0,c,d,c),this.drawSingleVideo(u[4],d,c,d,c),this.drawSingleVideo(u[5],2*d,c,d,c),this.drawSingleVideo(u[6],0,2*c,d,c),this.drawSingleVideo(u[7],d,2*c,d,c),this.drawSingleVideo(u[8],2*d,2*c,d,c);}},Math.floor(1e3/s)),this.canvas.captureStream()}drawSingleVideo(e,t,i,r,s){var a;if(!e)return;const o=Math.min(r/e.videoWidth,s/e.videoHeight);let n=e.videoWidth*o,d=e.videoHeight*o,c=t+(r-n)/2,l=i+(s-d)/2;null===(a=this.canvasContext)||void 0===a||a.drawImage(e,c,l,n,d);}async stopFormatVideo(){this.logger.log("stopFormatAudio() [结束混频]"),this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null),this.canvasContext=this.canvas=null;}destroy(){this.logger.log("destroy()"),this.stopFormatAudio(),this.stopFormatVideo();}}t.FormatMedia=d;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.OperationQueue=void 0;t.OperationQueue=class{constructor(e){this.cnt=0,this.current=null,this.history=null,this.queue=[],this.logger=e.getChild(()=>{let e="oper";return this.current?e+=` ${this.current.args.method}#${this.current.id}`:this.history&&(e+=` ${this.history.args.method}#${this.history.id} FINISHED`),this.queue.forEach(t=>{e+=`|${t.args.method}#${t.id}`;}),e}),setInterval(()=>{if(this.current&&Date.now()-this.current.enqueueTs>5e3){if(this.queue.length){const e=this.queue[0];this.logger.error(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}。即将进行下一个操作：${e.args.method}#${e.id}`);}else this.logger.log(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}`);this.current.status="timeout",this.history=this.current,this.current=null,this.fire("timer");}},5e3);}enqueue(e){return new Promise((t,i)=>{this.queue.push({id:++this.cnt,enqueueTs:Date.now(),args:e,resolve:t,reject:i,status:"pending"}),this.current?this.logger.log(`操作等位中，目前有其他操作。前面还有${this.queue.length}位：${e.method}#${this.cnt}。`):this.fire("instant");})}fire(e){var t;if(!this.current){const i=this.queue.shift();if(i){if(null===(t=i.args.caller)||void 0===t?void 0:t.destroyed)return this.logger.error(`无法执行操作：${i.args.method}: 对象已被销毁，请重新创建对象`),void this.fire("functionEnd");this.history=this.current,this.current=i,this.current.status="live","instant"===e?this.logger.log("开始执行操作："+i.args.method):this.logger.log(`开始执行队列中的操作：${i.args.method}#${i.id}，等待时间：${Date.now()-i.enqueueTs}ms。`),i.startTs=Date.now(),i.resolve(()=>{this.current===i?(this.current.status="finished",this.history=this.current,this.current=null,this.logger.log(`执行操作结束：${i.args.method}。花费 ${i.startTs?Date.now()-i.startTs:null}ms`),this.fire("functionEnd")):"timeout"===i.status?this.logger.log(`执行操作结束：${i.args.method}。花费 ${i.startTs?Date.now()-i.startTs:null}ms。该操作超时，但未阻塞执行队列。`):this.logger.error(`操作收到多次返回：${i.args.method}#${i.id}。花费 ${i.startTs?Date.now()-i.startTs:null}ms`);});}}}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Base=void 0;const s=i(148),a=i(214),o=i(216),n=i(246),d=i(4),c=i(175),l=i(248),u=i(270),h=i(64),p=r(i(12)),m=r(i(13)),f=r(i(198)),g=i(71),v=i(69),y=i(149),S=i(294),_=i(68),R=i(70),b=i(57);let T=0;class E extends _.RTCEventEmitter{constructor(e){super(),this.transportRebuildCnt=0,this.timeLast=Date.now(),this._params={appkey:"",mode:"rtc"},this.isReport="boolean"!=typeof e.report||e.report,this.clientId=T++,this.adapterRef={datareportCache:[],channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},apiEvents:{},requestId:{},instance:this,preferRemb:!1,deviceId:""};const t=d.getParameters().forceLogLevel;-1!==t?f.default.setLogLevel(t):!0===e.debug?f.default.setLogLevel(R.loglevels.DEBUG):!1===e.debug&&d.getParameters().logLevel<=R.loglevels.WARNING&&f.default.setLogLevel(R.loglevels.WARNING),this.logger=new v.Logger({tagGen:()=>{let e="client"+(this.clientId||"");const t=this.getUid();return t&&(e+="#"+t),"CONNECTED"!==this.adapterRef.connectState.curState&&(e+=" "+this.adapterRef.connectState.curState),this.destroyed&&(e+=" DESTROYED"),e}}),this.adapterRef.logger=this.logger,this.recordManager={record:null,formatMedia:null},this._reset(),this.adapterRef.encryption=new s.Encryption(this.adapterRef),e.debug&&(d.getParameters().debugG2=!0),this.sdkRef=e.ref;}_reset(){this.sdkRef=null,this.adapterRef={datareportCache:[],audioAsl:{enabled:"unknown",aslActiveNum:-1},uid2SscrList:{},netStatusTimer:null,networkQuality:{},_statsReport:null,_meetings:null,_enableRts:!1,state:void 0,mediaCapability:void 0,nim:void 0,instance:this,lbsManager:void 0,channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},memberMap:{},apiEvents:{},transportStats:{txRtt:-1,rxRtt:-1,NetworkType:"unknown",OutgoingAvailableBandwidth:-1},sessionStats:void 0,remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{},remoteStreamMap:{},localStream:null,localAudioStats:{},localAudioSlaveStats:{},localVideoStats:[],localScreenStats:[],logger:this.logger,logStorage:void 0,channelStatus:"init",_signalling:null,_rtsTransport:null,connectState:{prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},_mediasoup:null,mediaHelpers:{},netStatusList:[],requestId:{},deviceId:"",preferRemb:!1,nomalizedPlaybackVolume:1,userPriority:{priority:100,preemtiveMode:!1},proxyServer:{enable:!1,type:3},encryption:void 0,isAudioBanned:!1,isVideoBanned:!1,permKeyInfo:void 0},this.adapterRef.mediaCapability=new a.MediaCapability(this.adapterRef),this.adapterRef.encryption=new s.Encryption(this.adapterRef),this._resetState(),this.adapterRef.lbsManager=new S.LBSManager(this),this._destroyModule();}_getSupportedCodecs(){return g.getSupportedCodecs(...arguments)}initMode(){this.adapterRef._meetings||(this.adapterRef._meetings=new n.Meeting({sdkRef:this.sdkRef,adapterRef:this.adapterRef})),this.adapterRef._signalling||(this.adapterRef._signalling=new u.Signalling({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._mediasoup||(this.adapterRef._mediasoup=new o.Mediasoup({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._statsReport||(this.adapterRef._statsReport=new l.StatsReport({sdkRef:this.sdkRef,adapterRef:this.adapterRef,isReport:this.isReport}));}_destroyModule(){this.adapterRef._meetings&&(this.adapterRef._meetings.destroy(),this.adapterRef._meetings=null),this.adapterRef._signalling&&(this.adapterRef._signalling.destroy(),this.adapterRef._signalling=null),this.adapterRef._rtsTransport&&(this.adapterRef._rtsTransport.destroy(),this.adapterRef._rtsTransport=null),this.adapterRef._mediasoup&&(this.adapterRef._mediasoup.destroy(),this.adapterRef._mediasoup=null),this.adapterRef._statsReport&&(this.adapterRef._statsReport.destroy(),this.adapterRef._statsReport=null),this.recordManager.formatMedia&&(this.recordManager.formatMedia.destroy(),this.recordManager.formatMedia=null),this.recordManager.record&&(this.recordManager.record.destroy(),this.recordManager.record=null);}_resetState(){this._params.neRtcServerAddresses={},this.adapterRef.channelStatus="init",this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},this.adapterRef.networkQuality={},this.adapterRef.localStream=null,this.adapterRef.memberMap={},this.adapterRef.remoteStreamMap={},this.adapterRef.netStatusList=[],this.adapterRef.netStatusTimer&&(clearInterval(this.adapterRef.netStatusTimer),this.adapterRef.netStatusTimer=null),this.adapterRef.uid2SscrList={},this.adapterRef.proxyServer={enable:!1,type:3},this.adapterRef.state={lastDeviceStatus:{audio:{type:null,device:null},video:{type:null,device:null}},audioDeviceHasOpened:!1,videoDeviceHasOpened:!1,chromeScreenShareOpened:!1,startSessionTime:0,endSessionTime:0,startPubVideoTime:0,startPubScreenTime:0,getChannelInfoTime:0,signalEstablishTime:0,signalOpenTime:0,signalJoinResTime:0,signalJoinSuccessTime:0,signalAudioAddedTime:0,signalAudioSubscribedTime:0,signalVideoAddedTime:0,signalVideoSubscribedTime:0,iceRecvConnectedTime:0,domVideoAppendTime:0,videoFirstIframeTime:0,videoResizeTime:0},Object.assign(this.adapterRef,{transportStats:{NetworkType:"unknown",OutgoingAvailableBandwidth:0,txRtt:0,rxRtt:0},sessionStats:{Duration:0,RecvBitrate:0,RecvBytes:0,SendBitrate:0,SendBytes:0,UserCount:0},localAudioStats:[],localAudioSlaveStats:[],localVideoStats:[],localScreenStats:[],remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{}});}setSessionConfig(e={}){this.adapterRef.channelInfo||(this.adapterRef.channelInfo={}),this.adapterRef.channelInfo.sessionConfig||(this.adapterRef.channelInfo.sessionConfig={}),this.adapterRef.channelInfo.sessionConfig=Object.assign(this.adapterRef.channelInfo.sessionConfig,e);}resetChannel(){this.adapterRef.networkQuality={},this.adapterRef.netStatusList=[];for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active&&(t.active=!1,t.stop(),t.clearRemotePubStatus(),this.adapterRef.instance.safeEmit("peer-leave",{uid:e}));}this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this.adapterRef._mediasoup&&this.adapterRef._mediasoup.destroy();}async startSession(e=0){0===e?this.logger.log("开始音视频会话"):this.logger.log(`开始音视频会话：第${e}次`);let{wssArr:t,cid:i}=this.adapterRef.channelInfo;if(!t||0===t.length)throw this.logger.error("没有找到服务器地址 : "+JSON.stringify(this.adapterRef.channelInfo)),this.adapterRef.channelStatus="leave",new m.default({code:p.default.JOIN_FAILED,message:"没有找到媒体服务器地址"});if(!i)throw this.logger.error("服务器没有分配cid"),new m.default({code:p.default.JOIN_FAILED,message:"服务器没有分配cid"});if(this.logger.log(`开始连接服务器: ${this.adapterRef.channelInfo.wssArrIndex}, url: ${t[this.adapterRef.channelInfo.wssArrIndex]}`),this.adapterRef.channelInfo.wssArrIndex>=t.length)throw this.logger.error("所有的服务器地址都连接失败"),new m.default({code:p.default.NETWORK_ERROR,message:"所有的服务器地址都连接失败"});if(!this.adapterRef._signalling)throw new m.default({code:p.default.UNKNOWN_TYPE_ERROR,message:"startSession: 信令模块缺失"});try{await this.adapterRef._signalling.init(!1,!1);}catch(e){throw this.adapterRef.channelStatus="leave",e}const r=t[this.adapterRef.channelInfo.wssArrIndex];t.splice(this.adapterRef.channelInfo.wssArrIndex,1),t.unshift(r),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef._statsReport&&this.adapterRef._statsReport.start();}stopSession(){this.logger.log("开始清除音视频会话"),this._destroyModule();const e=d.getParameters().localStreams.filter(e=>e.client===this&&!e.destroyed);e.length&&(d.getParameters().keepLocalstreamOnLeave?this.logger.log("当前模式下离开频道不会销毁localStream"):(this.logger.log(`即将销毁${e.length}个localStream`),e.forEach(e=>{e.destroy();}))),Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{e.destroy();}),this.adapterRef.remoteStreamMap={},this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this._resetState();}async clearMember(e){var t;this.logger.log(e+"离开房间");const i=this.adapterRef.remoteStreamMap[e];if(null==i?void 0:i.active){for(let e of h.MediaTypeList)i.pubStatus[e].producerId&&this.adapterRef.instance.safeEmit("stream-removed",{stream:i,mediaType:e,reason:"onPeerLeave"});delete this.adapterRef.remoteStreamMap[e],delete this.adapterRef.memberMap[e],delete this.adapterRef.remoteAudioStats[e],delete this.adapterRef.remoteAudioSlaveStats[e],delete this.adapterRef.remoteVideoStats[e],delete this.adapterRef.remoteScreenStats[e];for(let e of h.MediaTypeList)i.pubStatus[e].consumerId&&await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.destroyConsumer(i.pubStatus[e].consumerId,i,e));i.active=!1,i.destroy();}this.adapterRef.netStatusList=this.adapterRef.netStatusList.filter((t,i,r)=>t.uid!==e),this.logger.log(e+" 离开房间 通知用户"),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-peer-leave",{uid:e}):this.adapterRef.instance.safeEmit("peer-leave",{uid:e});}setStartSessionTime(){this.adapterRef.state.startSessionTime=Date.now();const e=b.generateUUID(),t=this.adapterRef.channelInfo.channelName||"",i=this.adapterRef.channelInfo.uid||0,r=Date.now(),s=y(e+t+i+r+"");this.adapterRef.deviceId=b.randomString(s,16);}setEndSessionTime(){if(!this.adapterRef.state.startSessionTime)return void this.logger.log("AbstractAdapter: setEndSessionTime: startSessionTime为空");this.adapterRef.state.endSessionTime=Date.now();const e=this.adapterRef.state.endSessionTime-this.adapterRef.state.startSessionTime;this.adapterRef.instance.safeEmit("@sessionDuration",e),this.adapterRef.state.startSessionTime=0,this.adapterRef.state.endSessionTime=0;}async reBuildRecvTransport(){if(this.transportRebuildCnt++,this.transportRebuildCnt>=d.getParameters().maxTransportRebuildCnt)return void this.logger.error("reBuildRecvTransport 达到最大重连次数："+this.transportRebuildCnt);if(this.logger.warn("下行通道异常，重新建立 #"+this.transportRebuildCnt),!this.adapterRef._mediasoup)return;this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-start"),this.adapterRef._mediasoup._recvTransport&&(this.adapterRef._mediasoup._recvTransport.close(),this.adapterRef._mediasoup.getIceStatus("recv"),this.adapterRef._mediasoup._recvTransport=null),this.adapterRef._mediasoup.init(),this.logger.log("下行通道异常, remoteStreamMap",Object.keys(this.adapterRef.remoteStreamMap)),this.logger.log("this._eventQueue: ",this.adapterRef._mediasoup._eventQueue);let e=!1;for(const t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];if(i){i.pubStatus.audio.consumerStatus="init",i.pubStatus.video.consumerStatus="init",i.pubStatus.screen.consumerStatus="init",i.pubStatus.audio.consumerId="",i.pubStatus.video.consumerId="",i.pubStatus.screen.consumerId="",this.logger.log("重连逻辑订阅 start：",i.stringStreamID);try{await this.doSubscribe(i);}catch(t){this.logger.error("重连逻辑订阅 error: ",t,t.name,t.message),e=!0,this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-error");break}this.logger.log("重连逻辑订阅 over: ",i.stringStreamID);}}e||this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-success");}async rtsRequestKeyFrame(e){this.logger.log("请求关键帧: ",e.pubStatus.video.consumerId),this.adapterRef._signalling&&await this.adapterRef._signalling.rtsRequestKeyFrame(e.pubStatus.video.consumerId);}apiFrequencyControl(e){const{name:t,code:i,param:r}=e;if(!t)return;this.adapterRef.apiEvent[t]||(this.adapterRef.apiEvent[t]=[],this.adapterRef.apiEvents[t]=[],this.adapterRef.requestId[t]=0);let s=this.adapterRef.channelInfo.clientNtpTime-this.adapterRef.channelInfo.T4;s>0||(s=0);let a=Date.now()+s;if(a<=this.timeLast&&(a=this.timeLast+1),this.timeLast=a,this.adapterRef.apiEvent[t].length<10)this.adapterRef.apiEvent[t].push({cid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid,code:i,name:t,time:a,param:r,request_id:this.adapterRef.requestId[t]++});else {if(!this.adapterRef.apiEvent||!this.adapterRef.apiEvent[t]||!this.adapterRef.apiEvent[t].length)return;this.adapterRef.apiEvent[t][0].time,Date.now()-this.adapterRef.apiEvent[t][0].time<1e4?this.adapterRef.requestId[t]++:(this.adapterRef.apiEvents[t]=this.adapterRef.apiEvents[t].concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[]);}}apiEventReport(e,t){if(!e)return;let i=new c.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef});i[e](Object.assign({uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid,time:Date.now()},t)),this.adapterRef.channelInfo.cid&&this.adapterRef.channelInfo.uid?i.send():(this.adapterRef.datareportCache.push({func:e,datareport:i}),this.adapterRef.datareportCache.length>20&&this.adapterRef.datareportCache.shift());}getUidAndKindBySsrc(e){var t,i;const r=["high","low"];for(let s of h.MediaTypeList)for(let a of r)if((null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.senderEncodingParameter[s][a])||void 0===i?void 0:i.ssrc)===e)return {uid:0,kind:s,streamType:a};for(let t in this.adapterRef.uid2SscrList){if(this.adapterRef.uid2SscrList[t].audio.ssrc==e)return {uid:t,kind:"audio",streamType:"high"};if(this.adapterRef.uid2SscrList[t].audioSlave.ssrc==e)return {uid:t,kind:"audioSlave",streamType:"high"};if(this.adapterRef.uid2SscrList[t].video&&this.adapterRef.uid2SscrList[t].video.ssrc==e)return {uid:t,kind:"video",streamType:"high"};if(this.adapterRef.uid2SscrList[t].screen&&this.adapterRef.uid2SscrList[t].screen.ssrc==e)return {uid:t,kind:"screen",streamType:"high"}}return {uid:0,kind:"",streamType:"high"}}getSsrcByUidAndKind(e,t){return this.adapterRef.uid2SscrList[e]&&this.adapterRef.uid2SscrList[e][t]}addSsrc(e,t,i){this.adapterRef.uid2SscrList[e]||(this.adapterRef.uid2SscrList[e]={audio:{ssrc:0},audioSlave:{ssrc:0},video:{ssrc:0},screen:{ssrc:0}}),this.adapterRef.uid2SscrList[e][t]?this.adapterRef.uid2SscrList[e][t].ssrc=i:this.adapterRef.uid2SscrList[e][t]={ssrc:i};}removeSsrc(e,t){this.adapterRef.uid2SscrList[e]&&(t?this.adapterRef.uid2SscrList[e][t]&&(this.adapterRef.uid2SscrList[e][t].ssrc=0):delete this.adapterRef.uid2SscrList[e]);}isPublished(e){return e&&this.adapterRef.localStream===e&&(e.audio&&e.pubStatus.audio.audio||e.video&&e.pubStatus.video.video||e.screen&&e.pubStatus.screen.screen)}getPeer(e){return this.adapterRef._mediasoup?"send"==e?this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport.handler._pc:"recv"==e?this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport.handler._pc:null:null}destroy(){this.logger.log("base: destroy!"),this._reset();}}t.Base=E;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MediaCapability=void 0;const r=i(215),s=i(71),a=i(4);t.MediaCapability=class{constructor(e){this.logger=e.logger.getChild(()=>{let t="codec"+this.room.videoCodecType.join(",");return this.supportedCodecSend&&2===this.supportedCodecSend.length&&this.supportedCodecRecv&&2===this.supportedCodecRecv.length||(t+=`/${this.supportedCodecSend}/${this.supportedCodecRecv}`),e.mediaCapability!==this&&(t+=" DETACHED"),t}),this.supportedCodecRecv=null,this.supportedCodecSend=null,this.preferredCodecSend={video:["H264","VP8"],screen:["H264","VP8"]},this.room={videoCodecType:[]};}async detect(){const e=Date.now();let t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},i=await s.getSupportedCodecs("send")||{video:[],audio:["OPUS"]};if(a.getParameters().h264Wait){if(-1===t.video.indexOf("H264"))for(this.logger.warn(`当前浏览器不支持H264解码。这可能会触发频道内编码协商。最多等待 ${a.getParameters().h264Wait} 毫秒以避免编码器尚未加载。`);Date.now()-e<a.getParameters().h264Wait;){if(t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},-1!==t.video.indexOf("H264")){this.logger.log(`H264解码器加载完成！用时 ${Date.now()-e} 毫秒`);break}await new Promise(e=>{setTimeout(e,100);});}-1===t.video.indexOf("H264")&&this.logger.warn("H264解码器加载失败！");}if(this.supportedCodecRecv=t.video,this.supportedCodecSend=i.video,a.getParameters().disableH264Send){let e=this.supportedCodecSend.indexOf("H264");-1!==e&&(this.logger.log("根据私有化参数设置，忽略H264发送支持"),this.supportedCodecSend.splice(e,1));}if(a.getParameters().disableVP8Send){let e=this.supportedCodecSend.indexOf("VP8");-1!==e&&(this.logger.log("根据私有化参数设置，忽略VP8发送支持"),this.supportedCodecSend.splice(e,1));}this.logger.log("detect supportedCodecRecv",JSON.stringify(this.supportedCodecRecv),"supportedCodecSend",JSON.stringify(this.supportedCodecSend),"Preferred codec:",JSON.stringify(this.preferredCodecSend));}getCodecCapability(){if(this.supportedCodecRecv&&this.supportedCodecSend){const e=[];for(let t of s.VideoCodecList)this.supportedCodecRecv.indexOf(t)>-1&&this.supportedCodecSend.indexOf(t)>-1&&e.push(t);return e}return this.logger.error("getCodecCapability: call detect first"),[]}stringify(){let e={256:[]};for(let t of this.getCodecCapability())r.VideoCodecStr2Int[t]>-1?e[256].push(r.VideoCodecStr2Int[t]):this.logger.error("MediaCapability:Unknown VideoCodecStr2Int",t);0===e[256].length&&this.logger.warn("MediaCapability:No Local Suitable codec available");return JSON.stringify(e)}getCodecSend(e,t){var i,r;let s={codecName:null},o={codecName:null};for(let n=0;n<this.preferredCodecSend[e].length;n++){const d=this.preferredCodecSend[e][n];if(t.codecs||!t.codecs.length)for(let e=0;e<t.codecs.length;e++){const n=t.codecs[e];a.getParameters().disableH264Send&&(null===(i=n.mimeType)||void 0===i?void 0:i.toLowerCase().indexOf("h264"))>-1||(a.getParameters().disableVP8Send&&(null===(r=n.mimeType)||void 0===r?void 0:r.toLowerCase().indexOf("vp8"))>-1||n.mimeType&&n.mimeType.toLowerCase().indexOf(d.toLowerCase())>-1&&(this.room.videoCodecType.indexOf(d)>-1?s.codecName||(s={codecParam:n,codecName:d}):o.codecName||(o={codecParam:n,codecName:d})));}}return s.codecName?(this.logger.log("MediaCapability：发送的Codec为:",s.codecName,JSON.stringify(s.codecParam)),s):(this.logger.warn("MediaCapability：未找到合适的发送Codec。发送的Codec使用:",o.codecName,o.codecParam),o)}parseRoom(e){if(!e.mediaCapabilitySet)return;const t=JSON.parse(e.mediaCapabilitySet);if(t[256]){const i=this.room.videoCodecType;this.room.videoCodecType=[];for(const i of t[256]){let t=r.VideoCodecInt2Str[i];t?this.room.videoCodecType.push(t):this.logger.error("Unknown Video Codec Type",i,e);}i.length?this.logger.log("Room videoCodecType发生变更。new:",this.room.videoCodecType,"old:",i):this.logger.log("Room videoCodecType:",JSON.stringify(this.room.videoCodecType));}}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoCodecStr2Int=t.VideoCodecInt2Str=t.SignalChannelMode=void 0,function(e){e[e.CHANNEL_MODE_P2P=1]="CHANNEL_MODE_P2P",e[e.CHANNEL_MODE_MEETING=2]="CHANNEL_MODE_MEETING",e[e.CHANNEL_MODE_1V1=3]="CHANNEL_MODE_1V1";}(t.SignalChannelMode||(t.SignalChannelMode={}));t.VideoCodecStr2Int={H264:0,H265:1,VP8:2,NEVC:3};t.VideoCodecInt2Str={0:"H264",1:"H265",2:"VP8",3:"NEVC"};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mediasoup=void 0;const n=i(10),d=i(64),c=o(i(12)),l=o(i(13)),u=a(i(24)),h=i(217),p=a(i(166)),m=i(4),f=i(234),g=i(24),v=i(119),y=i(143),S=i(142);class _ extends n.EventEmitter{constructor(e){super(),this._consumers={},this._timeout=6e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._audioSlaveProducer=null,this._audioSlaveProducerId=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._webcamProducerCodec=null,this._screenProducerCodec=null,this._sendTransport=null,this._recvTransport=null,this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer=null,this._eventQueue=[],this._protoo=null,this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},audioSlave:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this.unsupportedProducers={},this.iceStatusHistory={send:{promises:[],status:{ts:0,info:""}},recv:{promises:[],status:{ts:0,info:""}}},this.adapterRef=e.adapterRef,this.logger=e.logger,this.loggerSend=e.logger.getChild(()=>{var e;let t="MediaSend";if(this._sendTransport)if(null===(e=this._sendTransport._handler)||void 0===e?void 0:e._pc){const e=this._sendTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState);}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this.loggerRecv=e.logger.getChild(()=>{var e;let t="MediaRecv";if(this._recvTransport)if(null===(e=this._recvTransport._handler)||void 0===e?void 0:e._pc){const e=this._recvTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState);}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this._reset();}get consumers(){return this._consumers}_reset(){this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._micProducer=null,this._audioSlaveProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._consumers={},this._sendTransportTimeoutTimer&&clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._sendTransport&&(this._sendTransport.close(),this.getIceStatus("send")),this._sendTransport=null,this._recvTransport&&(this._recvTransport.close(),this.getIceStatus("recv")),this._recvTransport=null,this.resetConsumeRequestStatus();}async init(){if(this.logger.log("init() 初始化 devices、transport"),this.adapterRef._enableRts)return;this._mediasoupDevice||(this._mediasoupDevice=new p.Device,this._mediasoupDevice&&await this._mediasoupDevice.load({routerRtpCapabilities:this._edgeRtpCapabilities}));let e=[],t="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach(t=>{e.push({urls:"turn:"+t+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+t+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken});}),u.IS_FIREFOX||(t="relay")),e.length&&this.logger.log("iceTransportPolicy ",t," iceServers ",v.JSONBigStringify(e)),!this._sendTransport&&this._mediasoupDevice&&(this._sendTransport=this._mediasoupDevice.createSendTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),this.senderEncodingParameter={ssrcList:[],audioSlave:{high:null,low:null},audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this._sendTransport.on("connectionstatechange",this._sendTransportConnectionstatechange.bind(this,this._sendTransport)),this._sendTransport.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("send");})),!this._recvTransport){const i=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,iceTransportPolicy:t,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=i,i.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,i)),i.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("recv");});}let i=setInterval(()=>{const e=Date.now();e-this.iceStatusHistory.send.status.ts>1500&&this.getIceStatus("send"),e-this.iceStatusHistory.recv.status.ts>1500&&this.getIceStatus("recv"),this._mediasoupDevice||clearInterval(i);},1e3);this.emit("transportReady");}async _sendTransportConnectionstatechange(e,t){if(this._sendTransport===e)if(this.loggerSend.log(`send connection #${e._handler._pc.pcid} state  changed to ${t}`),this.emit("upstream-state-change",{connectionState:t}),"failed"===t)try{this._sendTransport&&(this._sendTransportTimeoutTimer||(this._sendTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout();},this._timeout))),this._sendTransportConnectTimeout();}catch(e){this.loggerSend.error("reconnectSendTransportConnect() | failed:",e.name,e.message);}else "connected"===t&&this._sendTransportTimeoutTimer&&(clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null);else this.loggerSend.error("_sendTransportConnectionstatechange: 出现了_sendTransport绑定不一致的状况。");}async _recvTransportConnectionstatechange(e,t){if(this._recvTransport===e)if(this.loggerRecv.log(`recv connection ${e._handler._pc.pcid} state changed to ${t}`),this.emit("downstream-state-change",{connectionState:t}),"failed"===t){try{this._recvTransport&&(this._recvTransportTimeoutTimer||(this._recvTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout();},this._timeout)));}catch(e){this.loggerRecv.error("reconnectRecvTransportConnect() | failed:",e.name,e.message);}this._recvTransportConnectTimeout();}else "connected"===t&&this._recvTransportTimeoutTimer&&(clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null);else this.loggerRecv.error("_recvTransportConnectionstatechange：出现了_recvTransport绑定不一致的状况。");}async _sendTransportConnectTimeout(){this.loggerSend.warn("媒体上行传输通道连接失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerSend.log("媒体上行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"sendPeerIceFailed",ext:""}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体上行传输通道建立失败, 此时sdk正在重连, 不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pushStreamException",value:"send transport connection failed"})));}async _recvTransportConnectTimeout(){this.loggerRecv.warn("媒体下行传输通道建立失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerRecv.error("媒体下行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"recvPeerIceFailed",ext:""}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体下行传输通道建立失败，此时sdk正在重连，不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pullStreamException",value:"receive transport connection failed"})));}async _reconnectTransportConnectTimeout(){this.loggerRecv.error("媒体传输通道一直重连失败，主动退出房间"),this.adapterRef.instance.safeEmit("error","MEDIA_TRANSPORT_DISCONNECT"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.MEDIA_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave();}async createProduce(e,t){var i,r,s,a,o;if(e.logger.log("发布音视频: ",e.getId(),t),!this._sendTransport)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 发送端 transport 未找到 1"});if(0===this._sendTransport.listenerCount("produce")&&this._sendTransport.on("produce",async({kind:t,rtpParameters:i,appData:r,localDtlsParameters:s,offer:a},o,n)=>{if(this.loggerSend.log(`produce 反馈 [kind= ${t}, appData= ${v.JSONBigStringify(r)}]`),!this._sendTransport)return;const d="screenShare"==r.mediaType?"screen":r.mediaType;let u=!1;("video"===d&&this.adapterRef.channelInfo.videoLow||"screen"===d&&this.adapterRef.channelInfo.screenLow)&&(u=!0);const h=a.sdp.match(/a=ice-ufrag:([0-9a-zA-Z#=+-_\/\\\\]+)/);h||this.adapterRef.logger.error("找不到 iceUfragRegLocal: ",a.sdp);try{let n=i;const p=n.codecs[0];m.getParameters().h264ProfileLevel&&m.getParameters().h264ProfileLevelSignal&&"video/H264"===p.mimeType&&p.parameters&&p.parameters["profile-level-id"]!==m.getParameters().h264ProfileLevelSignal&&(n=JSON.parse(JSON.stringify(i)),this.logger.warn(`信令消息修改profile-level-id, ${n.codecs[0].parameters["profile-level-id"]} => ${m.getParameters().h264ProfileLevelSignal}`),n.codecs[0].parameters["profile-level-id"]="42e01f"),this.adapterRef.preferRemb&&(this.logger.log("使用REMB作为带宽估计方式"),S.filterTransportCCFromRtpParameters(n));let f=Object.assign({requestId:""+Math.ceil(1e9*Math.random()),kind:t,rtpParameters:n,iceUfrag:h[1],externData:{producerInfo:{mediaType:"audioSlave"===r.mediaType?"subAudio":r.mediaType,subStream:"screenShare"===r.mediaType||"audioSlave"===r.mediaType,simulcastEnable:u,spatialLayerCount:u?2:1,mute:e.muteStatus[d].send||!1}},appData:{enableTcpCandidate:!0}},r);"screen"===d?f.deviceId="screen-share-default":"video"===d&&(e.mediaHelper.video.videoSource?f.deviceId="video-external-default":f.deviceId="video-default");let g=this.senderEncodingParameter[d].high,y=this.senderEncodingParameter[d].low,_=a.sdp.indexOf(r.deviceId),R=a.sdp.indexOf(r.deviceIdLow);if(!g){if(i.encodings&&(g=i.encodings[0],g&&this.senderEncodingParameter.ssrcList.indexOf(g.ssrc)>-1&&(g=null),i.encodings[1]&&(y=i.encodings[1],y&&this.senderEncodingParameter.ssrcList.indexOf(y.ssrc)>-1&&(g=null))),!g&&r.deviceId&&_>-1){const e=a.sdp.substring(_).match(/a=ssrc-group:FID (\d+) (\d+)/);if(e&&(g={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),g&&this.senderEncodingParameter.ssrcList.indexOf(g.ssrc)>-1&&(g=null),!y&&r.deviceIdLow&&R>-1){const e=a.sdp.substring(R).match(/a=ssrc-group:FID (\d+) (\d+)/);e&&(y={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),y&&this.senderEncodingParameter.ssrcList.indexOf(y.ssrc)>-1&&(y=null);}}g||(this.loggerSend.log("使用sdp中第一个ssrc"),g={ssrc:parseInt(a.sdp.match(/a=ssrc:(\d+)/)[1]),dtx:!1}),this.senderEncodingParameter[d].high=g,this.senderEncodingParameter.ssrcList.push(g.ssrc),y?(this.senderEncodingParameter[d].low=y,this.senderEncodingParameter.ssrcList.push(y.ssrc)):this.senderEncodingParameter[d].low=null;}i.encodings=[this.senderEncodingParameter[d].high],this.senderEncodingParameter[d].low&&i.encodings.unshift(this.senderEncodingParameter[d].low),"video"!==r.mediaType&&"screenShare"!==r.mediaType||(f.mediaProfile=[],y&&f.mediaProfile.push({ssrc:y.ssrc,res:"160*160",fps:"1",spatialLayer:0,maxBitrate:100}),f.mediaProfile.push({ssrc:g.ssrc,res:"640*480",fps:"15",spatialLayer:f.mediaProfile.length,maxBitrate:1e3}));for(let e=f.rtpParameters.codecs.length-1;e>=0;e--)"audio/red"===f.rtpParameters.codecs[e].mimeType&&f.rtpParameters.codecs.splice(e,1);if(void 0===s?f.transportId=this._sendTransport.id:f.dtlsParameters=s,!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: _protoo 未找到"});let b=await this.adapterRef._signalling._protoo.request("Produce",f);const{code:T,transportId:E,iceParameters:A,iceCandidates:w,turnParameters:I,dtlsParameters:C,producerId:O,errMsg:k}=b;if(void 0!==E&&(this._sendTransport._id=E),200===T?this.loggerSend.log(`produce请求反馈结果, code: ${T}, kind: ${t}, producerId: ${O}`):this.loggerSend.error(`produce请求反馈错误, code: ${T}, kind: ${t}, producerId: ${O},  errMsg: ${k}, 请求：${v.JSONBigStringify(f)}, 返回：${v.JSONBigStringify(f)}`),I){let e=[];e.push({urls:"turn:"+I.ip+":"+I.port+"?transport=udp",credential:I.password,username:I.username},{urls:"turn:"+I.ip+":"+I.port+"?transport=tcp",credential:I.password,username:I.username}),await this._sendTransport.updateIceServers({iceServers:e});}let P={codecParam:null,codecName:null};if("audio"===r.mediaType?this._micProducerId=O:"audioSlave"===r.mediaType?this._audioSlaveProducerId=O:"video"===r.mediaType?(this._webcamProducerId=O,P=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video),this._webcamProducerCodec=P.codecName):"screenShare"===r.mediaType&&(this._screenProducerId=O,P=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video),this._screenProducerCodec=P.codecName),A&&(this._sendTransportIceParameters=A),!this.adapterRef.localStream)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 未找到 localStream"});let x=[];if("audio"===r.mediaType||"audioSlave"===r.mediaType)x.push(Object.assign({},m.getParameters().codecOptions.audio));else if("video"===r.mediaType){if(i.encodings.length>=2){const e={};m.getParameters().videoLowStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().videoLowStartBitrate),m.getParameters().videoLowMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().videoLowMinBitrate),x.push(e);}const e={};m.getParameters().videoHighStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().videoHighStartBitrate),m.getParameters().videoHighMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().videoHighMinBitrate),x.push(e);}else if("screenShare"===r.mediaType){if(i.encodings.length>=2){const e={};m.getParameters().screenLowStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().screenLowStartBitrate),m.getParameters().screenLowMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().screenLowMinBitrate),x.push(e);}const e={};m.getParameters().screenHighStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().screenHighStartBitrate),m.getParameters().screenHighMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().screenHighMinBitrate),x.push(e);}this.logger.log(`codecOptions for producer ${r.mediaType}: ${v.JSONBigStringify(x)}`);let M=w;this.adapterRef.channelInfo.iceProtocol&&w&&(this.logger.warn("Produce iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),M=w.filter(e=>e.protocol==this.adapterRef.channelInfo.iceProtocol)),await this._sendTransport.fillRemoteRecvSdp({kind:t,appData:r,iceParameters:A,iceCandidates:M,dtlsParameters:C,sctpParameters:void 0,sendingRtpParameters:i,codecOptions:x,offer:a,codec:P.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),"video"!==d&&"screen"!==d||(this.adapterRef.localStream.applyEncoderConfig(d,"high"),i.encodings.length>=2&&this.adapterRef.localStream.applyEncoderConfig(d,"low")),o({id:O});}catch(e){n(e);}}),"audio"===t||"all"===t)if(this._micProducer)this.loggerSend.log("音频已经publish，跳过");else {const t=e.mediaHelper.audio.audioStream.getAudioTracks()[0];t&&(!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.pubAudioRight)?(this.loggerSend.error("permKey权限控制你没有权利发布audio"),this.adapterRef.instance.safeEmit("error","no-publish-audio-permission")):(this.loggerSend.log("发布音频流 audioTrack: ",t.id,t.label),e.pubStatus.audio.audio=!0,this._micProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:null,mediaType:"audio"}}),this.watchProducerState(this._micProducer,"_micProducer"),this.adapterRef.encryption.encodedInsertableStreams&&this._micProducer._rtpSender&&this.enableSendTransform(this._micProducer._rtpSender,"audio","high")));}if("audioSlave"===t||"all"===t)if(this._audioSlaveProducer)this.loggerSend.log("音频辅流已经publish，忽略");else {const t=e.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0];t&&(!1===(null===(r=this.adapterRef.permKeyInfo)||void 0===r?void 0:r.pubAudioRight)?(this.loggerSend.error("permKey权限控制你没有权利发布audio slave"),this.adapterRef.instance.safeEmit("error","no-publish-audio-slave-permission")):(this.loggerSend.log("发布音频辅流 audioSlaveTrack: ",t.id,t.label),e.pubStatus.audioSlave.audio=!0,this._audioSlaveProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:null,mediaType:"audioSlave"}}),this.watchProducerState(this._audioSlaveProducer,"_audioSlaveProducer")));}if("video"===t||"all"===t)if(this._webcamProducer)this.loggerSend.log("视频已经publish，跳过");else if(e.mediaHelper.video.videoStream.getVideoTracks().length)if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.pubVideoRight))this.loggerSend.error("permKey权限控制你没有权利发布video"),this.adapterRef.instance.safeEmit("error","no-publish-video-permission");else {let t=null;this.adapterRef.channelInfo.videoLow?(e.mediaHelper.video.low||(e.mediaHelper.video.low=new f.VideoTrackLow({logger:this.logger,mediaType:"video"})),t=e.mediaHelper.video.low.track):(e.mediaHelper.video.low&&e.mediaHelper.video.low.bindSender(null,null),this.senderEncodingParameter.video.low=null);const i=e.mediaHelper.video.videoStream.getVideoTracks()[0];this.loggerSend.log("发布视频 videoTrack: ",i.id,i.label),e.pubStatus.video.video=!0;const r=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video);this._webcamProducer=await this._sendTransport.produce({track:i,trackLow:t,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:i.id,deviceIdLow:(null==t?void 0:t.id)||null,mediaType:"video"}}),this._webcamProducer._rtpSender&&e.mediaHelper.video.low&&(e.mediaHelper.video.low.bindSender(this._webcamProducer._rtpSender,this._webcamProducer._rtpSenderLow||null),g.IS_SAFARI&&g.SAFARI_MAJOR_VERSION&&g.SAFARI_MAJOR_VERSION<14&&(null===(a=e._play.video.dom)||void 0===a?void 0:a.srcObject)&&(this.logger.log("尝试重置本地视图的SrcObject"),e._play.video.dom.srcObject=e._play.video.dom.srcObject)),this.watchProducerState(this._webcamProducer,"_webcamProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._webcamProducer._rtpSender&&this.enableSendTransform(this._webcamProducer._rtpSender,"video","high"),this._webcamProducer._rtpSenderLow&&this.enableSendTransform(this._webcamProducer._rtpSenderLow,"video","low")),this.adapterRef.state.startPubVideoTime||(this.adapterRef.state.startPubVideoTime=Date.now());}if("screen"===t||"all"===t)if(this._screenProducer)this.loggerSend.log("屏幕共享已经publish，跳过");else if(e.mediaHelper.screen.screenVideoStream.getVideoTracks().length)if(!1===(null===(o=this.adapterRef.permKeyInfo)||void 0===o?void 0:o.pubVideoRight))this.loggerSend.error("permKey权限控制你没有权利发布screen"),this.adapterRef.instance.safeEmit("error","no-publish-screen-permission");else {let t=null;this.adapterRef.channelInfo.screenLow?(e.mediaHelper.screen.low||(e.mediaHelper.screen.low=new f.VideoTrackLow({logger:e.logger,mediaType:"screen"})),t=e.mediaHelper.screen.low.track):(e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(null,null),this.senderEncodingParameter.screen.low=null);const i=e.mediaHelper.screen.screenVideoStream.getVideoTracks()[0];this.loggerSend.log("发布屏幕共享 screenTrack: ",i.id,i.label),e.pubStatus.screen.screen=!0;const r=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video);this._screenProducer=await this._sendTransport.produce({track:i,trackLow:t,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:i.id,deviceIdLow:(null==t?void 0:t.id)||null,mediaType:"screenShare"}}),this._screenProducer._rtpSender&&e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(this._screenProducer._rtpSender,this._screenProducer._rtpSenderLow||null),this.watchProducerState(this._screenProducer,"_screenProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._screenProducer._rtpSender&&this.enableSendTransform(this._screenProducer._rtpSender,"screen","high"),this._screenProducer._rtpSenderLow&&this.enableSendTransform(this._screenProducer._rtpSenderLow,"screen","low")),this.adapterRef.state.startPubScreenTime||(this.adapterRef.state.startPubScreenTime=Date.now());}}enableSendTransform(e,t,i){var r;const s=null===(r=this._sendTransport)||void 0===r?void 0:r.send.find(t=>t.sender===e);if(s)if(s.encodedStreams)this.loggerRecv.log(`发送端自定义加密，复用之前的通道。 ${s.mediaType} ${s.streamType}`);else {const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleUpstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`发送端自定义加密，成功启动。 ${s.mediaType} ${s.streamType}`);}else this.loggerRecv.error("enableSendTransform() 未找到匹配的Sender",t,i);}enableRecvTransform(e,t,i){var r;const s=null===(r=this._recvTransport)||void 0===r?void 0:r.recv.find(t=>t.receiver===e);if(s)if(s.encodedStreams)this.loggerRecv.log(`接收端自定义解密，复用之前的通道。uid:${s.uid}, mediaType: ${s.mediaType}`);else {const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleDownstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`接收端自定义解密，成功启动。uid:${s.uid}, mediaType: ${s.mediaType}`);}else this.loggerRecv.error("enableRecvTransform() 未找到匹配的Receiver",t,i);}watchProducerState(e,t){var i;if(null===(i=e.rtpSender)||void 0===i?void 0:i.transport){const i=e.rtpSender.transport;switch(i.state){case"failed":this.logger.error(`Producer state ${t} ${i.state}`);break;case"connected":case"new":case"connecting":default:this.logger.log(`Producer state ${t} ${i.state}`),e.rtpSender.transport.addEventListener("statechange",()=>{switch(i.state){case"failed":this.logger.error(`Producer state changed: ${t} ${i.state}`);break;case"connected":case"new":case"connecting":this.logger.log(`Producer state changed: ${t} ${i.state}`);}});}}else this.logger.log("Producer state: transport is null");}async destroyProduce(e){var t;let i=null,r=null;if(!this.adapterRef.localStream)throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:`destroyProduce.${e}: 未找到 localStream`});"audio"===e?(i=this._micProducer,r=this._micProducerId,this._micProducer=this._micProducerId=null,this.adapterRef.localStream.pubStatus.audio.audio=!1):"audioSlave"===e?(i=this._audioSlaveProducer,r=this._audioSlaveProducerId,this._audioSlaveProducer=this._audioSlaveProducerId=null,this.adapterRef.localStream.pubStatus.audioSlave.audio=!1):"video"===e?(i=this._webcamProducer,r=this._webcamProducerId,this._webcamProducer=this._webcamProducerId=null,this.adapterRef.localStream.pubStatus.video.video=!1):"screen"===e&&(i=this._screenProducer,r=this._screenProducerId,this._screenProducer=this._screenProducerId=null,this.adapterRef.localStream.pubStatus.screen.screen=!1);try{if(this.loggerSend.log(`停止发布 destroyProduce ${e} producerId=`,r),!i)return;i.close(),(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)?this.adapterRef._signalling._protoo.request("CloseProducer",{requestId:""+Math.ceil(1e9*Math.random()),producerId:r}).catch(e=>{this.logger.error("CloseProducer Failed: ",e.name,e.message);}):this.logger.warn("destroyProduce: 当前信令中断, 不发信令包",e,r);}catch(e){this.loggerSend.error("destroyProduce failed: ",e.name,e.message);}}async createConsumer(e,t,i,r,s=0){this.adapterRef.instance.safeEmit("@pairing-createConsumer-start");let a=!1;if(this._eventQueue.forEach(t=>{if(t.id===r)return this.loggerRecv.log(`[subscribe] 已经在订阅任务队列中，忽略该次请求, uid: ${e}, mediaType: ${i}, producerId: ${r}`),void(a=!0)}),!a)return new Promise((a,o)=>{this._eventQueue.push({uid:e,kind:t,id:r,mediaType:i,preferredSpatialLayer:s,resolve:a,reject:o}),this._eventQueue.length>1||(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0]));})}async setConsumerPreferredLayer(e,t,i){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"setConsumerPreferredLayer: _protoo 未找到"});this.loggerSend.log("setConsumerPreferredLayer() [切换大小流]layer: ",t,1===t?"大流":"小流",i);return await this.adapterRef._signalling._protoo.request("SetConsumerPreferredLayer",{requestId:""+Math.ceil(1e9*Math.random()),uid:new y.SimpleBig(e.streamID),producerId:e.pubStatus[i].producerId,consumerId:e.pubStatus[i].consumerId,spatialLayer:t})}async resetConsumeRequestStatus(){const e=this._eventQueue;this._eventQueue=[];for(let t=0;t<e.length;t++){const i=e[t];this.loggerRecv.log(`resetConsumeRequestStatus：uid ${i.uid}, uid ${i.uid}, kind ${i.kind}, id ${i.id}`),i.reject("resetConsumeRequestStatus");}}removeUselessConsumeRequest(e){const{producerId:t,uid:i}=e;if(t||i)for(let e=1;e<this._eventQueue.length;e++){const r=this._eventQueue[e];r.id!==t&&r.uid!==i||(this.loggerRecv.log(`removeUselessConsumeRequest：uid ${r.uid}, uid ${r.uid}, kind ${r.kind}, id ${r.id}`),this._eventQueue.splice(e,1),e++);}}checkConsumerList(e){return this._eventQueue.shift(),e.resolve(null),this.loggerRecv.log("查看事件队列, _eventQueue: ",this._eventQueue.length),this._eventQueue.forEach(e=>{this.loggerRecv.log(`consumerList, uid: ${e.uid}, kind: ${e.kind}, mediaType: ${e.mediaType}, id: ${e.id}`);}),this._eventQueue.length>0&&(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0])),"checkConsumerList"}async _createConsumer(e){var t,i;const{uid:r,kind:s,mediaType:a,id:o,preferredSpatialLayer:n=0}=e,d="screenShare"===a?"screen":a;if("audio"===d?this.loggerRecv.log(`[Subscribe] 开始订阅 ${r} 的 ${d} 媒体: ${o}`):this.loggerRecv.log(`[Subscribe] 开始订阅 ${r} 的 ${d} 媒体: ${o} preferredSpatialLayer: ${n} 大小流: `,1===n?"大流":"小流"),!o)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);if(this.unsupportedProducers[o])return this.loggerRecv.warn("[Subscribe] createConsumer: 跳过不支持的Producer",o,v.JSONBigStringify(this.unsupportedProducers[o])),this.checkConsumerList(e);const u=this.adapterRef.remoteStreamMap[r];if(!u||!u.pubStatus[d][d]||!u.pubStatus[d].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if(u.pubStatus[d].consumerId){this.loggerRecv.log("[Subscribe] 已经订阅过");let t=!0;if(u.Play&&(t=u._play.isPlaying(d)),t)return this.loggerRecv.log("[Subscribe] 当前播放正常，直接返回"),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if("start"!==u.pubStatus[d].stopconsumerStatus){this.loggerRecv.log("[Subscribe] 先停止之前的订阅");try{if(u.pubStatus[d].stopconsumerStatus="start",!this.adapterRef._mediasoup)return this.checkConsumerList(e);await this.destroyConsumer(u.pubStatus.audio.consumerId,null,null),this.adapterRef.instance.removeSsrc(u.getId(),d),u.pubStatus[d].consumerId="",u.stop(d),u.pubStatus[d].stopconsumerStatus="end";}catch(e){this.loggerRecv.error("[Subscribe] 停止之前的订阅出现错误: ",e.name,e.message);}}}let p=null;if("audio"!==d&&"audioSlave"!==d||(p={opusStereo:1}),this._mediasoupDevice&&this._mediasoupDevice.loaded||(this.loggerRecv.warn("[Subscribe] createConsumer：Waiting for Transport Ready"),await h.waitForEvent(this,"transportReady",3e3)),!this._recvTransport)throw this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),e.resolve(null),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createConsumer: 接收端 transport 未找到"});this.loggerRecv.log(`[Subscribe] prepareLocalSdp [kind: ${s}, mediaTypeShort: ${d}, uid: ${r}]`),this._recvTransport.id===this.adapterRef.channelInfo.uid&&(this.loggerRecv.log("[Subscribe] transporth还没有协商, 需要dtls消息"),this._recvTransport._handler._transportReady=!1);const f=await this._recvTransport.prepareLocalSdp(s,this._edgeRtpCapabilities,r);this.adapterRef&&"DISCONNECTING"!=this.adapterRef.connectState.curState&&"DISCONNECTED"!=this.adapterRef.connectState.curState||this.checkConsumerList(e),this.loggerRecv.log("[Subscribe] 获取本地sdp, mid =",f.mid);let{rtpCapabilities:g,offer:S}=f,_=f.mid;const R=f.dtlsParameters;_="number"==typeof _&&_<0?void 0:""+_;const b=S.sdp.match(/a=ice-ufrag:([0-9a-zA-Z=#+-_\/\\\\]+)/);if(!b)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: iceUfragRegRemote 为空"});let T={requestId:""+Math.ceil(1e9*Math.random()),kind:s,rtpCapabilities:g,uid:new y.SimpleBig(r),producerId:o,preferredSpatialLayer:n,mid:_,pause:!1,iceUfrag:b[1],audioAslFlag:"yes"===this.adapterRef.audioAsl.enabled&&m.getParameters().audioAslFlag,appData:{enableTcpCandidate:!0}};if(void 0===R?T.transportId=this._recvTransport.id:T.dtlsParameters=R,this.loggerRecv.log(`[Subscribe] 发送consume请求, uid: ${r}, kind: ${s}, mediaTypeShort: ${d}, producerId: ${T.producerId}, transportId: ${T.transportId}, requestId: ${T.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw e.resolve(null),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: _protoo 未找到"});const E=this.adapterRef._signalling._protoo;let A=null;try{A=await this.adapterRef._signalling._protoo.request("Consume",T);}catch(e){throw "request timeout"===e.message&&this.adapterRef._signalling._protoo===E?(this.logger.error(`[Subscribe] Consume消息Timeout, 尝试信令重连: ${e.name}/${e.message}, 当前的连接状态: ${this.adapterRef.connectState.curState}, 原始请求: `,v.JSONBigStringify(T)),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"consumeRequestTimeout",ext:""}),this.adapterRef._signalling._reconnection()):this.logger.error(`[Subscribe] Consume消息错误: ${e.name}/${e.message}, 当前的连接状态：${this.adapterRef.connectState.curState}, 原始请求：`,v.JSONBigStringify(T)),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: Consume 消息错误:"+e.message})}let{transportId:w,iceParameters:I,iceCandidates:C,dtlsParameters:O,probeSSrc:k,rtpParameters:P,turnParameters:x,producerId:M,consumerId:D,code:N,errMsg:L}=A;if(this.loggerRecv.log(`[Subscribe] consume反馈结果 code: ${N} uid: ${r}, mid: ${P&&P.mid}, kind: ${s}, producerId: ${M}, consumerId: ${D}, transportId: ${w}, requestId: ${A.requestId}, errMsg: ${L}`),!this._recvTransport)return this.loggerRecv.error("[Subscribe] transport undefined, 直接返回"),this.checkConsumerList(e);if(200!==N&&!(null===(i=null===(t=this._recvTransport)||void 0===t?void 0:t._handler)||void 0===i?void 0:i.remoteSdp))return this._recvTransport.recoverLocalSdp(r,"0",s),this.loggerRecv.log("[Subscribe] consume, 此外没有remoteSdp, 忽略改次失败的consume"),this.checkConsumerList(e);if(x){let e=[];e.push({urls:"turn:"+x.ip+":"+x.port+"?transport=udp",credential:x.password,username:x.username},{urls:"turn:"+x.ip+":"+x.port+"?transport=tcp",credential:x.password,username:x.username}),await this._recvTransport.updateIceServers({iceServers:e});}const F=A.uid;P&&P.encodings&&P.encodings.length&&P.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(r,d,P.encodings[0].ssrc),void 0!==w&&(this._recvTransport._id=w),void 0!==k&&(this._probeSSrc=k),I&&(this._recvTransportIceParameters=I),P&&null!=P.mid&&(P.mid=P.mid+"");let V=C;this.adapterRef.channelInfo.iceProtocol&&C&&(this.logger.warn("Consume iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),V=C.filter(e=>e.protocol==this.adapterRef.channelInfo.iceProtocol));const B=await this._recvTransport.consume({id:D||M||o,producerId:M||o,kind:s,mediaType:d,uid:r||F,rtpParameters:P,codecOptions:p,appData:{peerId:F,remoteUid:r,mid:_},offer:S,iceParameters:I,iceCandidates:V,dtlsParameters:O,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this.adapterRef.encryption.encodedInsertableStreams&&B.rtpReceiver&&this.enableRecvTransform(B.rtpReceiver,r,d),this._consumers[B.id]=B,B.on("transportclose",()=>{this._consumers&&delete this._consumers[B.id];}),this.loggerRecv.log("[Subscribe] 订阅consume完成 peerId =",F),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${d}_sub`,oper:"1",value:v.JSONBigStringify({remoteUid:r,result:N,reason:L||"",preferredSpatialLayer:n,consumerId:D||"",producerId:M||o},null," ")}),u&&u.pubStatus[d].producerId){if(u.subStatus[d]=!0,u.pubStatus[d][d]=!0,u.pubStatus[d].consumerId=D,u.pubStatus[d].producerId=M,u.getMuteStatus(d).muted){this.loggerRecv.log(`[Subscribe] 远端流处于mute状态：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(u.getMuteStatus(d))}`);const e=u.getMuteStatus(d);e.send&&this.loggerRecv.log(`[Subscribe] 远端流把自己mute了：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(e)}`),e.recv&&(this.loggerRecv.log(`[Subscribe] 本端把远端流mute了：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(e)}`),B.track.enabled=!1);}else B.track.enabled=!0;u.mediaHelper.updateStream(d,B.track),this.adapterRef.instance.safeEmit("@pairing-createConsumer-success"),"audio"===d?this.adapterRef.state.signalAudioSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalAudioSubscribedTime=Date.now()):"video"===d&&this.adapterRef.state.signalVideoSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalVideoSubscribedTime=Date.now()),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:u,mediaType:d});}else this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.loggerRecv.log("[Subscribe] 该次consume状态错误: ",v.JSONBigStringify(u.pubStatus,null,""));return this.checkConsumerList(e)}async _createConsumerRts(e){const{uid:t,kind:i,id:r,mediaType:s,preferredSpatialLayer:a=0}=e,o="screenShare"===s?"screen":s;if(this.loggerRecv.log(`开始订阅 ${t} 的 ${o} 媒体: ${r} 大小流: ${a}`),!this.adapterRef._rtsTransport)return;if(!(this.adapterRef._signalling&&this.adapterRef._signalling._protoo&&this.adapterRef._signalling._protoo.request))return;if("audio"!==o&&"video"!==o&&"screen"!==o)return;if(!r)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);let n=this.adapterRef.remoteStreamMap[t];if(!n||!n.pubStatus[o][o]||!n.pubStatus[o].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);if(n.pubStatus[o].consumerId)return this.loggerRecv.log("已经订阅过，返回"),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);const d={requestId:""+Math.ceil(1e9*Math.random()),transportId:this.adapterRef._rtsTransport.transportId,uid:t,producerId:r,preferredSpatialLayer:a,pause:!1,rtsCapabilities:{codecs:[{kind:o,codec:"video"==o||"screen"==o?"h264":"opus",payloadType:"video"==o||"screen"==o?2:1}]}};if(this.loggerRecv.log("发送consume请求 =",v.JSONBigStringify(d)),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw e.resolve(null),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumerRts: _protoo 未找到 2"});const u=await this.adapterRef._signalling._protoo.request("WsConsume",d);this.loggerRecv.log("consume反馈结果 =",v.JSONBigStringify(u));let{transportId:h,rtpParameters:p,producerId:m,consumerId:f,code:g,errMsg:y}=u;try{const r=u.uid;return 200===g&&this.adapterRef.remoteStreamMap[t]?(this._consumers[f]={producerId:m,close:function(){return Promise.resolve()}},this.loggerRecv.log("订阅consume完成 peerId =",r),n=this.adapterRef.remoteStreamMap[t],n&&n.pubStatus[o].producerId?(n.subStatus[o]=!0,n.pubStatus[o][o]=!0,n.pubStatus[o].consumerId=f,n.pubStatus[o].producerId=m,this.adapterRef.instance.safeEmit("@pairing-createConsumer-success")):(this.loggerRecv.log("该次consume状态错误： ",v.JSONBigStringify(n.pubStatus,null,"")),this.adapterRef.instance.safeEmit("@pairing-createConsumer-error")),this.checkConsumerList(e)):(this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败, errcode: ${g}, reason: ${y} ，做容错处理: 重新建立下行连接`),this._eventQueue.length=0,void(this._recvTransport=null))}catch(e){return this.adapterRef&&this.loggerRecv.error('"newConsumer" request failed:',e.name,e.message,e),this.loggerRecv.error(`订阅 ${t} 的 ${o} 媒体失败，做容错处理: 重新建立下行连接`),this.adapterRef.instance.reBuildRecvTransport()}}async destroyConsumer(e,t,i){var r,s;if(e)try{const a=this._consumers[e];if(!a)return void this.loggerRecv.log("跳过停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID);this.loggerRecv.log("停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID),delete this._consumers[e];try{await(null===(s=null===(r=this.adapterRef._signalling)||void 0===r?void 0:r._protoo)||void 0===s?void 0:s.request("CloseConsumer",{requestId:""+Math.ceil(1e9*Math.random()),consumerId:e,producerId:a.producerId})),await a.close(),t&&i&&this.adapterRef.instance.safeEmit("@stream-unsubscribed",{stream:t,mediaType:i}),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${i}_sub`,oper:"0",value:v.JSONBigStringify({remoteUid:null==t?void 0:t.stringStreamID,consumerId:e||""},null," ")});}catch(e){this.logger.error("CloseConsumer失败",e.name,e.message,e);}}catch(e){this.loggerRecv.error("destroyConsumer() | failed:",e.name,e.message,e.stack);}}async closeTransport(e){var t,i;if(e&&e.id)try{this.logger.log(`closeTransport() [停止通道 transportId= ${e.id}]`);const r=await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("CloseTransport",{requestId:""+Math.ceil(1e9*Math.random()),transportId:e.id}));this.logger.log(`closeTransport() [停止通道反馈结果 result=${v.JSONBigStringify(r,null," ")}]`),e.close();}catch(e){this.logger.error("closeTransport() | failed:",e.name,e.message);}}async muteAudio(){var e,t,i,r;this.loggerSend.log("mute音频"),null===(e=this._micProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._micProducer)||void 0===r?void 0:r.id,mute:!0}}}));}catch(e){this.loggerSend.error("muteAudio() | failed:",e.name,e.message,e);}}async unmuteAudio(){var e,t,i,r;this.loggerSend.log("unmute音频"),null===(e=this._micProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._micProducer)||void 0===r?void 0:r.id,mute:!1}}}));}catch(e){return this.loggerSend.error("unmuteAudio() | failed: ",e.name,e.message),Promise.reject(e)}}async muteAudioSlave(){var e,t,i,r;this.loggerSend.log("mute音频辅流"),null===(e=this._audioSlaveProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._audioSlaveProducer)||void 0===r?void 0:r.id,mute:!0}}}));}catch(e){this.loggerSend.error("muteAudioSlave() | failed:",e.name,e.message);}}async unmuteAudioSlave(){var e,t,i,r;this.loggerSend.log("unmute音频辅流"),null===(e=this._audioSlaveProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._audioSlaveProducer)||void 0===r?void 0:r.id,mute:!1}}}));}catch(e){return this.loggerSend.error("unmuteAudioSlave() | failed: ",e.name,e.message),Promise.reject(e)}}async muteVideo(){var e,t,i,r;this.loggerSend.log("mute视频"),null===(e=this._webcamProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._webcamProducer)||void 0===r?void 0:r.id,mute:!0}}}));}catch(e){this.loggerSend.error("muteVideo() | failed:",e.name,e.message);}}async unmuteVideo(){var e,t,i,r;this.loggerSend.log("unmute视频"),null===(e=this._webcamProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._webcamProducer)||void 0===r?void 0:r.id,mute:!1}}}));}catch(e){this.loggerSend.error("unmuteVideo() | failed:",e.name,e.message);}}async muteScreen(){var e,t,i,r;this.loggerSend.log("mute屏幕共享"),null===(e=this._screenProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._screenProducer)||void 0===r?void 0:r.id,mute:!0}}}));}catch(e){this.loggerSend.error("muteScreen() | failed: ",e.name,e.message);}}async unmuteScreen(){var e,t,i,r;this.loggerSend.log("unmute屏幕共享"),null===(e=this._screenProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._screenProducer)||void 0===r?void 0:r.id,mute:!1}}}));}catch(e){this.loggerSend.error("unmuteScreen() | failed:",e.name,e.message);}}async updateUserRole(e){var t,i;this.loggerSend.log("updateUserRole() 更新用户角色为"+e);try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"UserRole",cid:this.adapterRef.channelInfo.cid,uid:new y.SimpleBig(this.adapterRef.channelInfo.uid),data:{userRole:e}}}));}catch(e){throw this.loggerSend.error("updateUserRole() failed:",e.name,e.message),e}}async getIceStatus(e="send"){var t,i,r,s;const a=Date.now(),o={ts:Date.now(),direction:e,iceConnectionState:"uninit",info:"",stuckTime:-1,elapse:-1};let n;if(n="send"===e?null===(i=null===(t=this._sendTransport)||void 0===t?void 0:t._handler)||void 0===i?void 0:i._pc:null===(s=null===(r=this._recvTransport)||void 0===r?void 0:r._handler)||void 0===s?void 0:s._pc,n){if(o.info+="#"+n.pcid,o.iceConnectionState=n.iceConnectionState,o.info+="|iceConnectoinState "+n.iceConnectionState,n.iceStartedAt&&(o.elapse=a-n.iceStartedAt),this.iceStatusHistory[e].promises[0]&&(this.iceStatusHistory[e].promises[0](null),this.iceStatusHistory[e].promises=[]),"checking"===n.iceConnectionState){if(n.iceStartedAt||(n.iceStartedAt=a),await new Promise(t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,3e3);}),"checking"!==n.iceConnectionState)return o;o.elapse=Date.now()-n.iceStartedAt;}"connected"!==n.iceConnectionState&&"completed"!==n.iceConnectionState||(n.iceConnectedAt||(n.iceConnectedAt=a),await new Promise(t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,100);}));let t=null;try{let i=Date.now(),r=null;if("send"===e){let e=n.getSenders()[0];(null==e?void 0:e.track)&&(r=e.track);}else {let e=n.getReceivers()[0];(null==e?void 0:e.track)&&(r=e.track);}let s=n.getStats(r);o.stuckTime=Date.now()-i,t=await s;}catch(e){}const i=[],r=[];let s=Date.now();t&&t.forEach((e,t)=>{i.push(e),"transport"===e.type&&r.push(e);}),r.length||(o.info+="|no transport stats"),r.forEach(e=>{const t=i.find(t=>t.id===e.selectedCandidatePairId);if(t){const e=i.find(e=>e.id===t.localCandidateId);e?(o.info+=`|local:${e.protocol} `,o.info+=`${e.address||"NOADDRESS"}:${e.port||"NOPORT"} ${e.candidateType} ${e.networkType||""}`,o.networkType=e.networkType,o.protocol=e.protocol,o.relayProtocol=e.relayProtocol,o.ip=e.ip,o.address=e.address):o.info+="|无法找到localCandidate "+t.localCandidateId;const r=i.find(e=>e.id===t.remoteCandidateId);r?(o.info+=`|remote:${r.protocol} `,o.info+=`${r.address||"NOADDRESS"}:${r.port||"NOPORT"} ${r.candidateType}`):o.info+="|无法找到remoteCandidate "+t.remoteCandidateId;}else o.info+="无法找到candidatePair "+e.selectedCandidatePairId;}),o.stuckTime+=Date.now()-s;}else o.info="no_pc_"+e;if(this.iceStatusHistory[e].status.info!==o.info&&"new"!==o.iceConnectionState&&this._mediasoupDevice){const t={new:1,checking:2,connected:3,completed:4,failed:-1,disconnected:-2,closed:-3},i=t[o.iceConnectionState||0]||0;i>0?(this.adapterRef.logger.log("iceConnectionStateChanged",e,o.info),i===t.connected&&"recv"===e&&this.adapterRef.state.iceRecvConnectedTime<this.adapterRef.state.signalJoinResTime&&(this.adapterRef.state.iceRecvConnectedTime=Date.now())):this.adapterRef.logger.warn("iceConnectionStateChanged",e,o.info),this.adapterRef.instance.apiFrequencyControl({name:"_iceStateChange_"+e,code:i,param:v.JSONBigStringify(o)}),this.adapterRef.instance.safeEmit("@ice-change",o);}return this.iceStatusHistory[e].status=o,o}getReceivers(e={}){const t=[];for(let i in this.adapterRef.remoteStreamMap){const r=this.adapterRef.remoteStreamMap[i];e.uid&&e.uid.toString()!==i||d.MediaTypeList.forEach(s=>{if(e.mediaType&&e.mediaType!==s)return;if(!r.active||!r.pubStatus[s].consumerId)return;const a=this._consumers[r.pubStatus[s].consumerId];a&&t.push({uid:i,mediaType:s,remoteStream:r,consumer:a});});}return t}destroy(){this.logger.log("清除 meidasoup"),this._reset();}}t.Mediasoup=_;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.waitForEvent=void 0,t.waitForEvent=async function(e,t,i){return new Promise((r,s)=>{let a;const o=e=>{a&&clearTimeout(a),r(e);};i&&(a=setTimeout(()=>{e.removeListener(t,o),s(`timed out after ${i}ms:${t}`);},i)),e.once(t,o);})};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome74=void 0;const n=a(i(126)),d=o(i(12)),c=o(i(13)),l=i(71),u=i(4),h=i(56),p=a(i(127)),m=a(i(72)),f=i(141),g=a(i(151)),v=i(152),y=a(i(153)),S=i(142),_="Chrome_",R={OS:1024,MIS:1024};let b=0;class T extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={};}static createFactory(){return ()=>new T}get name(){return "Chrome74"}get remoteSdp(){return this._remoteSdp}close(){if(h.Logger.debug(_,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close();}catch(e){}}async getNativeRtpCapabilities(){h.Logger.debug(_,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close();}catch(e){}const i=n.parse(t.sdp);return g.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close();}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.Logger.debug(_,"getNativeSctpCapabilities()"),{numStreams:R}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(_,"run()"),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(_,"iceServers: ",a);const u={iceServers:a||[],iceTransportPolicy:o||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=b++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.warn("onicecandidateerror: ",e);};}async updateIceServers(e){h.Logger.debug(_,"updateIceServers(): ");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t);}async restartIce(e){if(h.Logger.debug(_,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),e.sdp=n.write(t),h.Logger.debug(_,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription() [answer]"),await this._pc.setRemoteDescription(i);}else {const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(_,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(t);}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(_,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&i.forEach((e,t)=>{e.rid="r"+t;});const o=m.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(_,"audioSender 更新 track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"audioSlave"===a.mediaType&&this._pc.audioSlaveSender?(h.Logger.debug(_,"audioSlaveSender 更新 track: ",this._pc.audioSlaveSender.track,"=>",e),this._pc.audioSlaveSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(_,"videoSender 更新 track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(_,"videoSenderLow 更新 track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(_,"screenSender 更新 track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(_,"screenSenderLow 更新 track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"audioSlave"!==a.mediaType||this._pc.audioSlaveSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSlaveSender=u.sender:this._pc.audioSender=u.sender),h.Logger.debug(_,`send() | [transceivers: ${this._pc.getTransceivers().length}]`);let v=await this._pc.createOffer(),R=n.parse(v.sdp);a.preferRemb&&S.filterTransportCCFromSdp(R);let b,T,E=void 0;const A=R.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(b=i,!1):!t||r.sender.track.id!==t.id||(T=i,!1)))});b||(b=A.pop()),t&&!T&&(T=A.pop()),this._transportReady||(E=await this._setupTransport({localDtlsRole:"server",localSdpObject:R}));let w=null==b?void 0:b.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.send: localId 未找到"});let I=null;if(T&&(I=""+T.mid),o.mid=w,o.rtcp.cname=g.getCname({offerMediaObject:b}),i)if(1===i.length){let e=y.getRtpEncodings({offerMediaObject:b});Object.assign(e[0],i[0]),o.encodings=e;}else o.encodings=i;else o.encodings=[],T&&(o.encodings=o.encodings.concat(y.getRtpEncodings({offerMediaObject:T}))),o.encodings=o.encodings.concat(y.getRtpEncodings({offerMediaObject:b}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||"video/h264"===o.codecs[0].mimeType.toLowerCase())&&R.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),v.sdp=n.write(R),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,p),{localId:w,localIdLow:I,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:E,offer:v}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:p}){h.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const f=m.clone(this._sendingRemoteRtpParametersByKind[e]);f.codecs=l.reduceCodecs(f.codecs,p);let g=n.parse(this._pc.localDescription.sdp);const y=this._remoteSdp.getNextMediaSectionIdx();let S=g.media[y.idx],R=null;a.encodings&&a.encodings.length>1&&(R=g.media[y.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[S,R],reuseMid:y.reuseMid,offerRtpParameters:a,answerRtpParameters:f,codecOptions:o,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(_,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000";}b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),b.sdp=b.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60");}h.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),u.getParameters().enableUdpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(b);}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(_,`stopSending() [kind: ${t}, localId: ${e}]`);const i=this._mapMidTransceiver.get(e);"audio"===t?this._pc.audioSender.replaceTrack(null):"audioSlave"===t?this._pc.audioSlaveSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):null==i||i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),r.sdp=n.write(s),h.Logger.debug(_,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r);}catch(e){h.Logger.debug(_,"setLocalDescription error: ",e.message);}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a);}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(_,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(_,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t));}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(_,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e),r=null==i?void 0:i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t;}),await(null==i?void 0:i.sender.setParameters(r));}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(_,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)return;const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t);}),await i.sender.setParameters(r);}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(_,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(_,"recoverTransceiver() transceiver undefined");}async prepareLocalSdp(e,t){h.Logger.debug(_,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;if(-1===i)h.Logger.debug(_,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));else if(!r){r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=n.parse(r.sdp);i=e.media[e.media.length-1].mid;}const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return -1===i&&(i=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:d=-1,remoteUid:c,extendedRtpCapabilities:l,appData:p}){this._assertRecvDirection(),h.Logger.debug(_,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${c}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let m=o&&o.mid||p.mid;if(h.Logger.debug(_,"[Subscribe] receive() mid: "+m),null==o?void 0:o.mid)this._remoteSdp.receive({mid:m,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else {h.Logger.debug(_,"[Subscribe] receive() 容错流程");const e=[];l.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i);}});const t={mid:m,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:m},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+m);}n.sdp=n.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),n.sdp.indexOf("a=fmtp:111")&&(n.sdp=n.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const f={type:"answer",sdp:this._remoteSdp.getSdp()};f.sdp.indexOf("a=fmtp:111")&&(f.sdp=f.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),u.getParameters().enableUdpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(_,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(n),h.Logger.debug(_,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(f);const g=this._pc.getTransceivers().find(e=>e.mid===m);return this._mapMidTransceiver.set(m,g),{localId:m,track:g.receiver.track,rtpReceiver:g.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(_,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.stopReceiving: RTCRtpTransceiver 未找到"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;h.Logger.debug(_,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"stopReceiving() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(r);}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Chrome74=T;},function(e,t,i){var r=function(e){return String(Number(e))===e?Number(e):e},s=function(e,t,i){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var a=e.push?{}:s?t[e.name]:t;!function(e,t,i,s){if(s&&!i)t[s]=r(e[1]);else for(var a=0;a<i.length;a+=1)null!=e[a+1]&&(t[i[a]]=r(e[a+1]));}(i.match(e.reg),a,e.names,e.name),e.push&&t[e.push].push(a);},a=i(169),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach((function(e){var t=e[0],o=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var n=0;n<(a[t]||[]).length;n+=1){var d=a[t][n];if(d.reg.test(o))return s(d,r,o)}})),t.media=i,t};var n=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(n,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),s=0;s<i.length;s+=3)t.push({component:i[s],ip:i[s+1],port:i[s+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(n,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return "~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))};},function(e,t,i){var r=i(169),s=/%[sdv%]/g,a=function(e){var t=1,i=arguments,r=i.length;return e.replace(s,(function(e){if(t>=r)return e;var s=i[t];switch(t+=1,e){case"%%":return "%";case"%s":return String(s);case"%d":return Number(s);case"%v":return ""}}))},o=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var o=t.names[s];t.name?r.push(i[t.name][o]):r.push(i[t.names[s]]);}else r.push(i[t.name]);return a.apply(null,r)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="");}));var i=t.outerOrder||n,s=t.innerOrder||d,a=[];return i.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(o(t,i,e));}));}));})),e.media.forEach((function(e){a.push(o("m",r.m[0],e)),s.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(o(t,i,e));}));}));}));})),a.join("\r\n")+"\r\n"};},function(e,t,i){const r=i(222)("h264-profile-level-id");r.log=console.info.bind(console);t.ProfileConstrainedBaseline=1,t.ProfileBaseline=2,t.ProfileMain=3,t.ProfileConstrainedHigh=4,t.ProfileHigh=5;t.Level1_b=0,t.Level1=10,t.Level1_1=11,t.Level1_2=12,t.Level1_3=13,t.Level2=20,t.Level2_1=21,t.Level2_2=22,t.Level3=30,t.Level3_1=31,t.Level3_2=32,t.Level4=40,t.Level4_1=41,t.Level4_2=42,t.Level5=50,t.Level5_1=51,t.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t;}}t.ProfileLevelId=s;const a=new s(1,31);class o{constructor(e){this._mask=~c("x",e),this._maskedValue=c("1",e);}isMatch(e){return this._maskedValue===(e&this._mask)}}class n{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i;}}const d=[new n(66,new o("x1xx0000"),1),new n(77,new o("1xxx0000"),1),new n(88,new o("11xx0000"),1),new n(66,new o("x0xx0000"),2),new n(88,new o("10xx0000"),2),new n(77,new o("0x0x0000"),3),new n(100,new o("00000000"),5),new n(100,new o("00001100"),4)];function c(e,t){return (t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function l(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}t.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const t=parseInt(e,16);if(0===t)return null;const i=255&t,a=t>>8&255,o=t>>16&255;let n;switch(i){case 11:n=0!=(16&a)?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:n=i;break;default:return r("parseProfileLevelId() | unrecognized level_idc:%s",i),null}for(const e of d)if(o===e.profile_idc&&e.profile_iop.isMatch(a))return new s(e.profile,n);return r("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},t.profileLevelIdToString=function(e){if(0==e.level)switch(e.profile){case 1:return "42f00b";case 2:return "42100b";case 3:return "4d100b";default:return r("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let t;switch(e.profile){case 1:t="42e0";break;case 2:t="4200";break;case 3:t="4d00";break;case 4:t="640c";break;case 5:t="6400";break;default:return r("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let i=e.level.toString(16);return 1===i.length&&(i="0"+i),`${t}${i}`},t.parseSdpProfileLevelId=function(e={}){const i=e["profile-level-id"];return i?t.parseProfileLevelId(i):a},t.isSameProfile=function(e={},i={}){const r=t.parseSdpProfileLevelId(e),s=t.parseSdpProfileLevelId(i);return Boolean(r&&s&&r.profile===s.profile)},t.generateProfileLevelIdForAnswer=function(e={},i={}){if(!e["profile-level-id"]&&!i["profile-level-id"])return r("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const a=t.parseSdpProfileLevelId(e),o=t.parseSdpProfileLevelId(i);if(!a)throw new TypeError("invalid local_profile_level_id");if(!o)throw new TypeError("invalid remote_profile_level_id");if(a.profile!==o.profile)throw new TypeError("H264 Profile mismatch");const n=l(e)&&l(i),d=a.level,c=o.level,u=function(e,t){return 0===e?10!==t&&0!==t:0===t?10!==e:e<t}(h=d,p=c)?h:p;var h,p;const m=n?d:u;return r("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",a.profile,m),t.profileLevelIdToString(new s(a.profile,m))};},function(e,t,i){(function(r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(s=r));}),t.splice(s,0,i);},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug");}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug");}catch(e){}!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return !0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return !1;return "undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return ()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."));}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=i(223)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return "[UnexpectedJSONParseError]: "+e.message}};}).call(this,i(66));},function(e,t,i){e.exports=function(e){function t(e){let i,s,a,o=null;function n(...e){if(!n.enabled)return;const r=n,s=Number(new Date),a=s-(i||s);r.diff=a,r.prev=i,r.curr=s,i=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(i,s)=>{if("%%"===i)return "%";o++;const a=t.formatters[s];if("function"==typeof a){const t=e[o];i=a.call(r,t),e.splice(o,1),o--;}return i}),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e);}return n.namespace=e,n.useColors=t.useColors(),n.color=t.selectColor(e),n.extend=r,n.destroy=t.destroy,Object.defineProperty(n,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(s!==t.namespaces&&(s=t.namespaces,a=t.enabled(e)),a),set:e=>{o=e;}}),"function"==typeof t.init&&t.init(n),n}function r(e,i){const r=t(this.namespace+(void 0===i?":":i)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let i;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(i=0;i<s;i++)r[i]&&("-"===(e=r[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")));},t.enabled=function(e){if("*"===e[e.length-1])return !0;let i,r;for(i=0,r=t.skips.length;i<r;i++)if(t.skips[i].test(e))return !1;for(i=0,r=t.names.length;i<r;i++)if(t.names[i].test(e))return !0;return !1},t.humanize=i(224),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");},Object.keys(e).forEach(i=>{t[i]=e[i];}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t};},function(e,t){var i=1e3,r=6e4,s=60*r,a=24*s;function o(e,t,i,r){var s=t>=1.5*i;return Math.round(e/i)+" "+r+(s?"s":"")}e.exports=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var o=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*a;case"hours":case"hour":case"hrs":case"hr":case"h":return o*s;case"minutes":case"minute":case"mins":case"min":case"m":return o*r;case"seconds":case"second":case"secs":case"sec":case"s":return o*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=a)return o(e,t,a,"day");if(t>=s)return o(e,t,s,"hour");if(t>=r)return o(e,t,r,"minute");if(t>=i)return o(e,t,i,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=a)return Math.round(e/a)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=r)return Math.round(e/r)+"m";if(t>=i)return Math.round(e/i)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OfferMediaSection=t.AnswerMediaSection=t.MediaSection=void 0;const o=a(i(72));class n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:r=!1}){if(this._mediaObject={},this._planB=r,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t);}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination";}i&&this.setDtlsRole(i.role);}get mid(){return String(this._mediaObject.mid)}get type(){return String(this._mediaObject.type)}get closed(){return 0===this._mediaObject.port}set mid(e){this._mediaObject.mid=e;}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password;}disable(){delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids;}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed;}}t.MediaSection=n;t.AnswerMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,offerMediaObject:n,offerRtpParameters:c,answerRtpParameters:l,codecOptions:u,extmapAllowMixed:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(n.mid),this._mediaObject.type=n.type,this._mediaObject.protocol=n.protocol,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),n.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i=o.clone(e.parameters,{});if(u){const{opusStereo:t,opusFec:r,opusDtx:s,opusMaxPlaybackRate:a,opusPtime:o,videoGoogleStartBitrate:n,videoGoogleMaxBitrate:d,videoGoogleMinBitrate:l}=u,h=c.codecs.find(t=>t.payloadType===e.payloadType);switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(h.parameters["sprop-stereo"]=t?1:0,i.stereo=t?1:0),void 0!==r&&(h.parameters.useinbandfec=r?1:0,i.useinbandfec=r?1:0),void 0!==s&&(h.parameters.usedtx=s?1:0,i.usedtx=s?1:0),void 0!==a&&(i.maxplaybackrate=a),void 0!==o&&(h.parameters.ptime=o,i.ptime=o);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==n&&(i["x-google-start-bitrate"]=n),void 0!==d&&(i["x-google-max-bitrate"]=d),void 0!==l&&(i["x-google-min-bitrate"]=l);}}const r={payload:e.payloadType,config:""};for(const e of Object.keys(i))r.config&&(r.config+=";"),r.config+=`${e}=${i[e]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter});}this._mediaObject.payloads=l.codecs.map(e=>e.payloadType).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions){(n.ext||[]).some(t=>t.uri===e.uri)&&this._mediaObject.ext.push({uri:e.uri,value:e.id});}if(h&&"extmap-allow-mixed"===n.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),n.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:n.simulcast.list1},this._mediaObject.rids=[];for(const e of n.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"});}else if(n.simulcast_03){this._mediaObject.simulcast_03={value:n.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of n.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"});}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof n.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):n.sctpmap&&(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize});}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";}}};function d(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}t.OfferMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,mid:o,kind:n,offerRtpParameters:c,streamId:l,trackId:u,oldDataChannelSpec:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=n,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=r?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),n){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${u}`);for(const e of c.codecs){const t={payload:e.payloadType||e.localPayloadType||125,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i={payload:e.payloadType||e.localPayloadType||125,config:""},r=e.parameters||e.localParameters||{};for(const e of Object.keys(r))i.config&&(i.config+=";"),i.config+=`${e}=${r[e]}`;i.config&&this._mediaObject.fmtp.push(i);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter});}this._mediaObject.payloads=c.codecs.map(e=>e.payloadType||e.localPayloadType||125).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,i=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${u}`}),i&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${l||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`}));break}case"application":h?(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize);}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";}}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){const r=e.encodings[0],s=r.ssrc,a=r.rtx&&r.rtx.ssrc?r.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${a}`}));}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],i=t.ssrc,r=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(e=>e.id!==i&&e.id!==r),r&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(e=>e.ssrcs!==`${i} ${r}`));}};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox60=void 0;const n=a(i(126)),d=o(i(12)),c=o(i(13)),l=i(71),u=i(4),h=i(56),p=a(i(127)),m=a(i(72)),f=i(141),g=a(i(151)),v=i(152),y=a(i(153)),S=i(142),_="Firefox_",R={OS:1024,MIS:1024};let b=0;class T extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={},this.signalingState="stable";}static createFactory(){return ()=>new T}get name(){return "Firefox60"}get remoteSdp(){return this._remoteSdp}close(){if(h.Logger.debug(_,"close()"),this._pc)try{this._pc.oniceconnectionstatechange=null,this._pc.close();}catch(e){}}async getNativeRtpCapabilities(){h.Logger.debug(_,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close();}catch(e){}const i=n.parse(t.sdp);return g.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close();}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.Logger.debug(_,"getNativeSctpCapabilities()"),{numStreams:R}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(_,"run()",l),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(_,"iceServers: %o",a);const u={iceServers:a||[],iceTransportPolicy:o||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=b++,this._pc.oniceconnectionstatechange=()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.debug("onicecandidateerror: ",e);};}async updateIceServers(e){h.Logger.debug(_,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t);}async restartIce(e){if(h.Logger.debug(_,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),e.sdp=n.write(t),h.Logger.debug(_,"restartIce() | calling pc.setLocalDescription()"),this.signalingState="have-local-offer",await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(i);}else {const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(_,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),this.signalingState="have-local-offer",await this._pc.setLocalDescription(t);}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(_,`[Produce] send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&(i.forEach((e,t)=>{e.rid="r"+t;}),i.reverse());const o=m.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(_,"[Produce] audioSender更新track: ",this._pc.audioSender),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(_,"[Produce] videoSender更新track: ",this._pc.videoSender),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(_,"[Produce] videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(_,"[Produce] screenSender更新track: ",this._pc.screenSender),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(_,"[Produce] screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSender=u.sender),h.Logger.debug(_,"[Produce] send() | [transceivers:%d]",this._pc.getTransceivers().length);let v=await this._pc.createOffer();v.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(v.sdp=v.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let R=n.parse(v.sdp);a.preferRemb&&S.filterTransportCCFromSdp(R);let b,T,E=void 0;const A=R.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(b=i,!1):!t||r.sender.track.id!==t.id||(T=i,!1)))});b||(b=A.pop()),t&&!T&&(T=A.pop()),this._transportReady||(E=await this._setupTransport({localDtlsRole:"server",localSdpObject:R}));let w=null==b?void 0:b.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.send: localId 未找到"});let I=null;if(T&&(I=""+T.mid),o.mid=w,o.rtcp.cname=g.getCname({offerMediaObject:b}),i)if(1===i.length){let e=y.getRtpEncodings({offerMediaObject:b});Object.assign(e[0],i[0]),o.encodings=e;}else o.encodings=i.reverse();else o.encodings=[],T&&(o.encodings=o.encodings.concat(y.getRtpEncodings({offerMediaObject:T}))),o.encodings=o.encodings.concat(y.getRtpEncodings({offerMediaObject:b}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||o.codecs[0].mimeType.toLowerCase()),R.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),v.sdp=n.write(R),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,p),{localId:w,localIdLow:I,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:E,offer:v}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:u}){h.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const p=m.clone(this._sendingRemoteRtpParametersByKind[e]);p.codecs=l.reduceCodecs(p.codecs,u);let f=n.parse(this._pc.localDescription.sdp);const g=this._remoteSdp.getNextMediaSectionIdx();let y=f.media[g.idx],S=null;a.encodings&&a.encodings.length>1&&(S=f.media[g.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[y,S],reuseMid:g.reuseMid,offerRtpParameters:a,answerRtpParameters:p,codecOptions:o,extmapAllowMixed:!0});const R={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(_,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000";}R.sdp.indexOf("a=fmtp:111")&&(R.sdp=R.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),R.sdp=R.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60");}h.Logger.debug(_,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(R);}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(_,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopSending: RTCRtpTransceiver 未找到"});"audio"===t?this._pc.audioSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):(i.sender.replaceTrack(null),this._pc.removeTrack(i.sender),this._remoteSdp.disableMediaSection(i.mid));const r=await this._pc.createOffer();r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),r.sdp=n.write(s),h.Logger.debug(_,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r);}catch(e){h.Logger.debug(_,"setLocalDescription error = %o",e);}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(_,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e);}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(_,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(_,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t));}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(_,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e),r=null==i?void 0:i.sender.getParameters();t=r.encodings.length-1-t,r.encodings.forEach((e,i)=>{e.active=i>=t;}),await(null==i?void 0:i.sender.setParameters(r));}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(_,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t);}),await i.sender.setParameters(r);}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(_,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(_,"recoverTransceiver() transceiver undefined");}async prepareLocalSdp(e,t){h.Logger.debug(_,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;if(-1===i)h.Logger.debug(_,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"));else if(!r){r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=n.parse(r.sdp);i=e.media[e.media.length-1].mid;}const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return -1===i&&(i=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:d=-1,remoteUid:c,extendedRtpCapabilities:l,appData:p}){this._assertRecvDirection(),h.Logger.debug(_,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${c}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let m=o&&o.mid||p.mid;if(h.Logger.debug(_,"[Subscribe] receive() mid: "+m),o.mid)this._remoteSdp.receive({mid:m,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else {h.Logger.debug(_,"[Subscribe] receive() 容错流程");const e=[];l.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i);}});const t={mid:m,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:m},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+m);}const f={type:"answer",sdp:this._remoteSdp.getSdp()};f.sdp.indexOf("a=fmtp:111")&&(f.sdp=f.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),u.getParameters().enableUdpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(_,"[Subscribe] receive() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(n);}catch(e){if("InvalidModificationError"!==e.name)throw e;await this._pc.createOffer();await this._pc.setLocalDescription(n);}h.Logger.debug(_,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(f);const g=this._pc.getTransceivers().find(e=>e.mid===m);return g.isUseless=!o.mid,this._mapMidTransceiver.set(m,g),{localId:m,track:g.receiver.track,rtpReceiver:g.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(_,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopReceiving: RTCRtpTransceiver 未找到"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Firefox60=T;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari12=void 0;const n=a(i(126)),d=o(i(12)),c=o(i(13)),l=i(71),u=i(228),h=i(4),p=i(56),m=a(i(127)),f=a(i(72)),g=i(141),v=a(i(151)),y=i(152),S=a(i(153)),_=i(142),R="Safari_",b={OS:1024,MIS:1024};let T=0;class E extends g.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={};}static createFactory(){return ()=>new E}get name(){return "Safari12"}get remoteSdp(){return this._remoteSdp}close(){if(p.Logger.debug(R,"close()"),this._pc)try{this._pc.close();}catch(e){}}async getNativeRtpCapabilities(){p.Logger.debug(R,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close();}catch(e){}const i=n.parse(t.sdp);return v.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close();}catch(e){}throw t}}async getNativeSctpCapabilities(){return p.Logger.debug(R,"getNativeSctpCapabilities()"),{numStreams:b}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){p.Logger.debug(R,"run()"),this._direction=e,this._appData=l,this._sendingRtpParametersByKind={audio:m.getSendingRtpParameters("audio",c),video:m.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:m.getSendingRemoteRtpParameters("audio",c),video:m.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection(Object.assign({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},n),d),this._pc.pcid=T++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");}};}async updateIceServers(e){p.Logger.debug(R,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t);}async restartIce(e){if(p.Logger.debug(R,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),e.sdp=n.write(t),p.Logger.debug(R,"restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i);}else {const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();p.Logger.debug(R,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t);}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),p.Logger.debug(R,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`);const o=f.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},h={};const m=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(p.Logger.warn(R,"audioSender更新track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(p.Logger.warn(R,"videoSender更新track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(p.Logger.debug(R,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(p.Logger.warn(R,"screenSender更新track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(p.Logger.debug(R,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(m.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[m],sendEncodings:i}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=u.sender),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender):this._pc.videoSender=u.sender:this._pc.audioSender=u.sender,p.Logger.debug(R,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let g=await this._pc.createOffer(),y=n.parse(g.sdp);a.preferRemb&&_.filterTransportCCFromSdp(y);let b,T,E=void 0;const A=y.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(b=i,!1):!t||r.sender.track.id!==t.id||(T=i,!1)))});b||(b=A.pop()),t&&!T&&(T=A.pop()),this._transportReady||(E=await this._setupTransport({localDtlsRole:"server",localSdpObject:y}));let w=null==b?void 0:b.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.send: localId 未找到"});let I=null;if(T&&(I=""+T.mid),o.mid=w,p.Logger.debug(R,"要检查M行: ",b),o.rtcp.cname=v.getCname({offerMediaObject:b}),i)if(1===i.length){let e=S.getRtpEncodings({offerMediaObject:b});Object.assign(e[0],i[0]),o.encodings=e;}else o.encodings=i;else o.encodings=[],T&&(o.encodings=o.encodings.concat(S.getRtpEncodings({offerMediaObject:T}))),o.encodings=o.encodings.concat(S.getRtpEncodings({offerMediaObject:b}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||"video/h264"===o.codecs[0].mimeType.toLowerCase())&&y.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),g.sdp=n.write(y),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,h),{localId:w,localIdLow:I,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:h.sender||null,dtlsParameters:E,offer:g}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:h}){let m=n.parse(d.sdp);m.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),d.sdp=n.write(m),p.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new y.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const g=f.clone(this._sendingRemoteRtpParametersByKind[e]);g.codecs=l.reduceCodecs(g.codecs,h);let v=n.parse(this._pc.localDescription.sdp);const S=this._remoteSdp.getNextMediaSectionIdx();let _=v.media[S.idx],b=null;a.encodings&&a.encodings.length>1&&(b=v.media[S.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[_,b],reuseMid:S.reuseMid,offerRtpParameters:a,answerRtpParameters:g,codecOptions:o,extmapAllowMixed:!0});const T={type:"answer",sdp:this._remoteSdp.getSdp()};if(p.Logger.debug(R,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000";}T.sdp.indexOf("a=fmtp:111")&&(T.sdp=T.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),T.sdp=T.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60");}u.canShimVideoOrientation(d,T)&&u.shimVideoOrientation(d,T),p.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer:%o]",T.sdp),await this._pc.setRemoteDescription(T);}async stopSending(e,t){this._assertSendDirection(),p.Logger.debug(R,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);"audio"===t?(this._pc.audioSender.replaceTrack(null),p.Logger.debug(R,"删除发送的audio track: ",this._pc.audioSender)):"video"===t?(this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null),this._pc.videoSender.replaceTrack(null),p.Logger.debug(R,"删除发送的video track: ",this._pc.videoSender)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null),p.Logger.debug(R,"删除发送的screen track: ",this._pc.screenSender)):null==i||i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)));}),r.sdp=n.write(s),p.Logger.debug(R,"stopSending() | calling pc.setLocalDescription() [offer:%o]",r.sdp),await this._pc.setLocalDescription(r);const a={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a);}async replaceTrack(e,t){this._assertSendDirection(),t?p.Logger.debug(R,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):p.Logger.debug(R,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t));}async setMaxSpatialLayer(e,t){this._assertSendDirection(),p.Logger.debug(R,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.setMaxSpatialLayer: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t;}),await i.sender.setParameters(r);}async setRtpEncodingParameters(e,t){this._assertSendDirection(),p.Logger.debug(R,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t);}),await i.sender.setParameters(r);}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){p.Logger.debug(R,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:p.Logger.debug(R,"recoverTransceiver() transceiver undefined");}async prepareLocalSdp(e,t){p.Logger.debug(R,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=null,s=null;if(-1===i)p.Logger.debug(R,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");else if(this._pc.localDescription)r={type:this._pc.localDescription.type,sdp:this._pc.localDescription.sdp};else if(!this._pc.localDescription){r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=n.parse(r.sdp);i=e.media[e.media.length-1].mid;}const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=v.extractRtpCapabilities({sdpObject:a});return -1===i&&(i=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:m,appData:f}){this._assertRecvDirection(),p.Logger.debug(R,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${u}]`),this._remoteSdp||(this._remoteSdp=new y.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let g=o&&o.mid||f.mid;if(p.Logger.debug(R,"receive() mid: "+g),o.mid)this._remoteSdp.receive({mid:g,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else {p.Logger.debug(R,"[Subscribe] receive() 容错流程");const e=[];m.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i);}});const t={mid:g,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:g},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+g);}let v={type:"answer",sdp:this._remoteSdp.getSdp()};v.sdp.indexOf("a=fmtp:111")&&(v.sdp=v.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),h.getParameters().enableUdpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),p.Logger.debug(R,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(n),p.Logger.debug(R,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(v);const S=this._pc.getTransceivers().find(e=>e.mid===g);if(!S)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.receive: RTCRtpTransceiver 未找到"});return this._mapMidTransceiver.set(g,S),{localId:g,track:S.receiver.track,rtpReceiver:S.receiver}}async stopReceiving(e){this._assertRecvDirection(),p.Logger.debug(R,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.stopReceiving: RTCRtpTransceiver 未找到"});p.Logger.debug(R,"transceiver: ",t),t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;p.Logger.debug(R,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"stopReceiving() | calling pc.setRemoteDescription() [answer:%o]",r.sdp),await this._pc.setRemoteDescription(r);}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=v.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Safari12=E;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimVideoOrientation=t.canShimVideoOrientation=void 0;const o=i(4),n=a(i(24)),d=i(118),c="a=extmap:4 ";t.canShimVideoOrientation=function(e,t){if("never"===o.getParameters().shimVideoOrientation)return !1;if("ios151"===o.getParameters().shimVideoOrientation){if(!n.IS_IOS)return !1;if(n.IS_SAFARI){if(parseFloat(d.getBrowserInfo().browserVersion)<15.1)return !1}else {if(!n.IS_WECHAT)return !1;if(!navigator.userAgent.match(/OS 15_[1-9]/))return !1}}if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return !1;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);return !!(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1]))},t.shimVideoOrientation=function(e,t){if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);if(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1])){const e=i[1];console.log(`shimVideoOrientation for ${d.getBrowserInfo().browserName} ${d.getBrowserInfo().browserVersion} ${e}`),t.sdp=t.sdp.split(c).join(e+"\r\n"+c);}else console.error("Failed to shimVideoOrientation",i,e.sdp.indexOf(c),i&&t.sdp.indexOf(i[1]));};},function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function o(e){try{d(r.next(e));}catch(e){a(e);}}function n(e){try{d(r.throw(e));}catch(e){a(e);}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t);}))).then(o,n);}d((r=r.apply(e,t||[])).next());}))};Object.defineProperty(t,"__esModule",{value:!0});t.AwaitQueue=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t;}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0;}}push(e,t){return r(this,void 0,void 0,(function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if("function"!=typeof e)throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t});}catch(e){}return new Promise((i,r)=>{const s={task:e,name:t,resolve:i,reject:r,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),1===this.pendingTasks.length&&this.next();})}))}stop(){if(!this.closed){for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0;}}dump(){const e=new Date;return this.pendingTasks.map(t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0}))}next(){return r(this,void 0,void 0,(function*(){const e=this.pendingTasks[0];e&&(yield this.executeTask(e),this.pendingTasks.shift(),this.next());}))}executeTask(e){return r(this,void 0,void 0,(function*(){if(!e.stopped){e.executedAt=new Date;try{const t=yield e.task();if(e.stopped)return;e.resolve(t);}catch(t){if(e.stopped)return;e.reject(t);}}}))}};},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||r(t,e,i);};Object.defineProperty(t,"__esModule",{value:!0}),s(i(171),t),s(i(167),t),s(i(125),t),s(i(141),t),s(i(172),t),s(i(231),t),s(i(232),t),s(i(170),t);},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const r=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");t.parse=function(e){const t=r.exec(e||"");return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoTrackLow=void 0;const r=i(235),s=i(173),a=i(73),o=i(4),n=i(123),d=i(243),c=i(24);t.VideoTrackLow=class{constructor(e){var t;this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.context=n.get2DContext(this.canvas),this.timer=null,this.lastDrawAt=0,this.lastState="clear",this.high={sender:null,track:null,stream:new MediaStream,videoDom:r.getAutoplayVideo(),width:0,height:0},this.sender=null,this.emptyTrackInfo={track:null,count:0,visible:"unknown"},this.mediaType=e.mediaType,"video"===this.mediaType?(this.WIDTH_MAX=o.getParameters().videoLowMaxWidth,this.HEIGHT_MAX=o.getParameters().videoLowMaxHeight,this.FRAME_RATE=o.getParameters().videoLowFramerate):(this.WIDTH_MAX=o.getParameters().screenLowMaxWidth,this.HEIGHT_MAX=o.getParameters().screenLowMaxHeight,this.FRAME_RATE=o.getParameters().screenLowFramerate),this.stream=this.canvas.captureStream?this.canvas.captureStream(this.FRAME_RATE):null,this.track=(null===(t=this.stream)||void 0===t?void 0:t.getTracks()[0])||null,a.watchTrack(this.track),this.logger=e.logger.getChild(()=>{let e=`low_${this.mediaType} ${this.width}x${this.height}`;return this.high.sender?this.high.sender.track?"live"!==this.high.sender.track.readyState?e+=" HIGH_STATE_"+this.high.sender.track.readyState:(this.high.sender&&this.high.sender.track!==this.high.track&&(e+=" MISMATCH"),this.high.sender.track.enabled||(e+=" muted"),e+=` 【${this.high.sender.track.label}】`):e+=" NO_HIGH_TRACK":e+=" NO_HIGH_SENDER",this.track?"live"!==this.track.readyState&&(e+=" LOW_STATE_"+this.track.readyState):e+=" NO_LOW_TRACK",e}),this.track?this.context?this.timer=s.getRTCTimer().setInterval(()=>{this.drawOneFrame();},1e3/this.FRAME_RATE):(this.logger.error("CanvasContext无法顺利启动"),this.stream=null,this.track=null):this.logger.error("当前浏览器不支持CanvasTrack");}_correctSize(){if(this.high.sender&&this._bindTrack(this.high.sender.track),this.high.width!==this.high.videoDom.videoWidth||this.high.height!==this.high.videoDom.videoHeight){const e=this.high.videoDom.videoWidth/this.high.videoDom.videoHeight;let t=this.width,i=this.height;const r=e>1?this.WIDTH_MAX:this.HEIGHT_MAX,s=e>1?this.HEIGHT_MAX:this.WIDTH_MAX;e>r/s?(i=Math.floor(this.high.videoDom.videoHeight/this.high.videoDom.videoWidth*r),i>0?t=r:(t=0,i=0)):(i=s,t=Math.floor(this.high.videoDom.videoWidth/this.high.videoDom.videoHeight*s),t>0?i=s:(t=0,i=0)),this.logger.log(`High resize ${this.high.width}x${this.high.height}=>${this.high.videoDom.videoWidth}x${this.high.videoDom.videoHeight}, low: ${this.width}x${this.height}=>${t}x${i}`),this.high.width=this.high.videoDom.videoWidth,this.high.height=this.high.videoDom.videoHeight,this.width=t,this.height=i,this.canvas.width=this.width,this.canvas.height=this.height;}}destroy(){var e;this.timer&&(s.getRTCTimer().clearInterval(this.timer),this.timer=null),null===(e=this.track)||void 0===e||e.stop(),this.stream=null;}drawOneFrame(){var e,t,i,r;if(this.context)if(this._correctSize(),!0===(null===(e=this.high.track)||void 0===e?void 0:e.enabled)&&!1===(null===(t=this.track)||void 0===t?void 0:t.enabled)&&(this.logger.log("恢复小流mute状态"),this.track.enabled=!0),this.track){if("live"!==this.track.readyState)this.logger.error("小流 Track 已停止");else if(!1===(null===(i=this.high.track)||void 0===i?void 0:i.enabled)){if("frame"===this.lastState||"clear"===this.lastState){this.logger.log("track处在mute状态");let e="black";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.fillRect(0,0,this.width,this.height);}}else if(this.high.videoDom.paused){if("frame"===this.lastState||"clear"===this.lastState){let e="paused";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.high.videoDom.play().catch(e=>{});}("all"===o.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===o.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank();}else if("live"===(null===(r=this.high.track)||void 0===r?void 0:r.readyState)){if("frame"!==this.lastState){let e="frame";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e;}const e=this.high.track.canvas;e?this.context.drawImage(e,0,0,this.width,this.height):this.context.drawImage(this.high.videoDom,0,0,this.width,this.height),this.lastDrawAt=Date.now(),("all"===o.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===o.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank();}else if("frame"===this.lastState){let e="clear";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.clearRect(0,0,this.width,this.height);}}else this.logger.error("无法获取小流 Track");}_checkCanvasBlank(){var e,t;if((null===(e=this.high.sender)||void 0===e?void 0:e.track)&&(null===(t=this.sender)||void 0===t?void 0:t.track)&&(this.high.sender.track!==this.emptyTrackInfo.track&&(this.emptyTrackInfo={track:this.high.sender.track,count:0,visible:"unknown"}),"unknown"===this.emptyTrackInfo.visible)){if(this.high.videoDom.paused||4!==this.high.videoDom.readyState)this.emptyTrackInfo.count++;else {d.isCanvasBlank(this.canvas)?this.emptyTrackInfo.count++:(this.emptyTrackInfo.visible="yes",this.logger.log("_checkCanvasBlank: 小流画面可见",this.emptyTrackInfo.count),this.sender.track!==this.track&&(this.logger.warn("小流切换至低分辨率模式"),this.sender.replaceTrack(this.track)));}this.emptyTrackInfo.count>30&&(this.emptyTrackInfo.visible="no",this.sender.track!==this.high.sender.track?(this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，小流切换至相同分辨率模式"),this.sender.replaceTrack(this.high.sender.track)):this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，继续使用相同分辨率模式"));}}_bindTrack(e){var t;this.high.track!==e&&(this.high.track&&this.high.stream.removeTrack(this.high.track),e&&this.high.stream.addTrack(e),this.high.track=e,this.high.videoDom.srcObject=this.high.stream,this.high.videoDom.play().catch(e=>{}),(null===(t=this.sender)||void 0===t?void 0:t.track)&&("no"===this.emptyTrackInfo.visible?(this.logger.warn("小流正在使用相同分辨率模式"),this.sender.replaceTrack(e)):this.sender.track!==this.track&&(this.logger.warn("小流正在使用低分辨率模式"),this.sender.replaceTrack(this.track))));}bindSender(e,t){this.high.sender=e,this.sender=t,e?this._bindTrack(e.track):this._bindTrack(null);}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getAutoplayVideo=void 0;let r=0;t.getAutoplayVideo=function(){const e=document.createElement("video");return e.style.position="absolute",e.setAttribute("x-webkit-airplay","x-webkit-airplay"),e.setAttribute("playsinline","playsinline"),e.setAttribute("webkit-playsinline","webkit-playsinline"),e.preload="auto",e.className="nertc-video-id-"+r++,e.autoplay=!0,e.muted=!0,e};},function(e,t,i){e.exports="setInterval(() => {\n  self.postMessage('RTCTimer')\n}, 8)\n";},function(e,t,i){e.exports="const SMOOTHING_FACTOR = 0.8\nconst MINIMUM_VALUE = 0.00001\nregisterProcessor(\n  'vumeter',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      this._leftVolume = 0\n      this._rightVolume = 0\n      this._updateIntervalInMS = 25\n      this._nextUpdateFrame = this._updateIntervalInMS\n      this.port.onmessage = (event) => {\n        if (event.data.updateIntervalInMS) this._updateIntervalInMS = event.data.updateIntervalInMS\n      }\n    }\n\n    get intervalInFrames() {\n      return (this._updateIntervalInMS / 1000) * sampleRate\n    }\n\n    process(inputs, outputs, parameters) {\n      const input = inputs[0]\n\n      // Note that the input will be down-mixed to mono; however, if no inputs are\n      // connected then zero channels will be passed in.\n      if (input.length > 0) {\n        const samplesLeft = input[0]\n        const samplesRight = input[1]\n\n        let sum = 0\n        let rms = 0\n        // Calculated the squared-sum.\n        if (samplesLeft && samplesLeft.length) {\n          for (let i = 0; i < samplesLeft.length; ++i) {\n            sum += samplesLeft[i] * samplesLeft[i]\n          }\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesLeft.length)\n          this._leftVolume = Math.max(rms, this._leftVolume * SMOOTHING_FACTOR)\n          if (this._leftVolume < 1e-10) {\n            this._leftVolume = 0\n          }\n        }\n        if (samplesRight) {\n          sum = 0\n          rms = 0\n          // Calculated the squared-sum.\n          for (let j = 0; j < samplesRight.length; ++j) sum += samplesRight[j] * samplesRight[j]\n\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesRight.length)\n          this._rightVolume = Math.max(rms, this._rightVolume * SMOOTHING_FACTOR)\n          if (this._rightVolume < 1e-10) {\n            this._rightVolume = 0\n          }\n        }\n\n        // Update and sync the volume property with the main thread.\n        this._nextUpdateFrame -= samplesLeft.length\n        if (this._nextUpdateFrame < 0) {\n          this._nextUpdateFrame += this.intervalInFrames\n          let volume = Math.max(this._leftVolume, this._rightVolume)\n          if (!(volume > -1)) {\n            if (this._leftVolume > -1) {\n              volume = this._leftVolume\n            } else if (this._rightVolume > -1) {\n              volume = this._rightVolume\n            }\n          }\n          if (samplesRight) {\n            this.port.postMessage({\n              left: this._leftVolume,\n              right: this._rightVolume,\n              volume: volume\n            })\n          } else {\n            this.port.postMessage({\n              volume: volume\n            })\n          }\n        }\n      }\n\n      return true\n    }\n  }\n)\n";},function(e,t,i){e.exports=";(function () {\n  const intervalIds = {}\n  const timeoutIds = {}\n\n  // 监听message 开始执行定时器或者销毁\n  self.onmessage = function onMsgFunc(e) {\n    switch (e.data.command) {\n      case 'interval:start': // 开启定时器\n        const intervalId = setInterval(function () {\n          postMessage({\n            message: 'interval:tick',\n            id: e.data.id\n          })\n        }, e.data.interval)\n\n        postMessage({\n          message: 'interval:started',\n          id: e.data.id\n        })\n\n        intervalIds[e.data.id] = intervalId\n        break\n      case 'interval:clear': // 销毁\n        clearInterval(intervalIds[e.data.id])\n\n        postMessage({\n          message: 'interval:cleared',\n          id: e.data.id\n        })\n\n        delete intervalIds[e.data.id]\n        break\n\n      case 'timeout:start': // 开启定时器\n        const timeoutId = this.setTimeout(function () {\n          postMessage({\n            message: 'timeout:tick',\n            id: e.data.id\n          })\n        }, e.data.timeout)\n\n        postMessage({\n          message: 'timeout:started',\n          id: e.data.id\n        })\n\n        timeoutIds[e.data.id] = timeoutId\n        break\n      case 'timeout:clear': // 销毁\n        clearTimeout(timeoutIds[e.data.id])\n\n        postMessage({\n          message: 'timeout:cleared',\n          id: e.data.id\n        })\n\n        delete timeoutIds[e.data.id]\n        break\n    }\n  }\n})()\n";},function(e,t,i){e.exports="/**\n * 模拟一个AI Worklet\n * 其实是个Delay\n */\nregisterProcessor(\n  'audioAIProcessor',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      // 尚未接入AI，以延迟1秒为例\n      this.inputSamplesHistory = []\n      this.delayMs = 3000\n    }\n\n    process(inputs, outputs, parameters) {\n      const now = Date.now()\n      const input = inputs[0].map((channel) => {\n        return channel.slice(0)\n      })\n      const output = outputs[0]\n      this.inputSamplesHistory.push({\n        input,\n        ms: now\n      })\n      const firstItem = this.inputSamplesHistory[0]\n      if (firstItem) {\n        if (now - firstItem.ms > this.delayMs) {\n          this.inputSamplesHistory.shift()\n          output.forEach((channel, index) => {\n            for (let i = 0; i < channel.length; i++) {\n              if (firstItem.input[index] && firstItem.input[index][i]) {\n                channel[i] = firstItem.input[index][i]\n              }\n            }\n          })\n        }\n      }\n      return true\n    }\n  }\n)\n";},function(e,t,i){e.exports="/* eslint-disable */\nregisterProcessor(\n  'audioWorkletAgentProcessor',\n  class extends AudioWorkletProcessor {\n    // Float32Array[][][]\n    constructor() {\n      super()\n      this.inputDataSeq = []\n      this.bufferDrop = 0\n      this.bufferDropSum = 0\n      this.bufferDropTime = 0\n      this.port.onmessage = (event) => {\n        if (event.data.type === 'outputData') {\n          this.inputDataSeq.push(event.data.data)\n          this.bufferDrop++\n        }\n      }\n    }\n\n    process(inputs, outputs, parameters) {\n      this.port.postMessage({\n        type: 'rawinputs',\n        inputs\n      })\n\n      const inputData = this.inputDataSeq.shift()\n      if (inputData && outputs[0] && !this.bufferDropSum) {\n        if (outputs[0][1]) {\n          outputs[0][1].set(inputData[0])\n        }\n        outputs[0][0].set(inputData[0])\n      }\n      if (this.bufferDrop > 200) {\n        this.bufferDropSum += this.bufferDrop\n        this.bufferDropTime = currentTime\n      }\n      this.bufferDrop = 0\n      if (this.bufferDropTime && currentTime - this.bufferDropTime > 0.3) {\n        this.inputDataSeq = []\n        this.port.postMessage({\n          type: 'bufferDrop',\n          cnt: this.bufferDropSum\n        })\n        this.bufferDropTime = 0\n        this.bufferDropSum = 0\n      }\n      return true\n    }\n  }\n)\n";},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimCanvas=t.canShimCanvas=void 0;const o=i(4),n=i(140),d=a(i(24));t.canShimCanvas=function(){let e=!1;if("never"===o.getParameters().shimCanvas)e=!1;else if("always"===o.getParameters().shimCanvas)e=!0;else if("ios151"===o.getParameters().shimCanvas)return !!(d.IS_IOS&&navigator.userAgent.indexOf(" OS 15_1")>-1);return e},t.shimCanvas=function(e){let t=new n.RTCCanvas("canvas");const i=document.createElement("video");let r=t._canvas,s=e.getSettings().frameRate||15,a=t._ctx;const o=new MediaStream([e]);if(i.srcObject=o,i.setAttribute("playsinline","playsinline"),i.setAttribute("muted","muted"),i.setAttribute("autoplay","autoplay"),i.className="nertc-ios-shim",i.style.display="none",i.onresize=()=>{i.videoWidth&&i.videoHeight&&t.setSize(i.videoWidth,i.videoHeight);},a){const o=r.captureStream(s).getVideoTracks()[0];Object.defineProperty(o,"enabled",{get:()=>e.enabled,set(t){console.warn("Delegate cameraTrack enabled",t),e.enabled=t;}});const n=setInterval(()=>{i.paused?i.play():"ended"===o.readyState?("live"===e.readyState&&(console.warn("canvasTrack已停止，回收videoTrack中"),e.stop()),clearInterval(n),document.body.removeChild(i)):a.drawImage(i,0,0);},1e3/s);return document.body.appendChild(i),t.destroy(),o}throw new Error("Ctx not supported")};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.syncTrackState=void 0;const r=new(i(69).Logger)({tagGen:()=>"syncTrackState"}),s=[];setInterval(()=>{for(let e=s.length-1;e>=0;e--){const t=s[e];if("ended"===t.srcTrack.readyState)return "live"===t.destTrack.readyState&&(r.log(`同步MediaStreamTrack关闭状态。【${t.srcTrack.label}】=>【${t.destTrack.label}】`),t.destTrack.stop()),void s.splice(e,1);if("bidirectional"===t.direction&&"ended"===t.destTrack.readyState)return "live"===t.srcTrack.readyState&&(r.warn(`同步MediaStreamTrack关闭状态。【${t.destTrack.label}】=>【${t.srcTrack.label}】`),t.srcTrack.stop()),void s.splice(e,1);t.srcTrack.enabled!==t.enabled&&(t.enabled=t.srcTrack.enabled,t.srcTrack.enabled!==t.destTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.destTrack.enabled=t.srcTrack.enabled)),"bidirectional"===t.direction&&t.destTrack.enabled!==t.enabled&&(t.enabled=t.destTrack.enabled,t.destTrack.enabled!==t.srcTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.srcTrack.enabled=t.destTrack.enabled));}},1e3);t.syncTrackState=function(e,t,i){s.push({srcTrack:e,destTrack:t,direction:i,enabled:e.enabled});};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isCanvasBlank=void 0;let r=null;t.isCanvasBlank=function(e){r||(r=document.createElement("canvas")),r.width=e.width,r.height=e.height;let t=e.toDataURL()===r.toDataURL();return t&&console.error("result",t,e),t};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const r=i(143),s=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;let a,o;const n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};let d;function c(e){return s.lastIndex=0,s.test(e)?`"${e.replace(s,e=>{const t=n[e];return "string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})}"`:`"${e}"`}t.stringify=function(e,t,i){let s;if(a="",o="","number"==typeof i)for(s=0;s<i;s+=1)o+=" ";else "string"==typeof i&&(o=i);if(d=t,t&&"function"!=typeof t&&!Array.isArray(t))throw new Error("JSON.stringify");return function e(t,i){let s,n,l,u;const h=a;let p,m=i[t];const f=null!=m&&m instanceof r.SimpleBig;switch(m&&"object"==typeof m&&"function"==typeof m.toJSON&&(m=m.toJSON(t)),"function"==typeof d&&(m=d.call(i,t,m)),typeof m){case"string":return c(m);case"number":return isFinite(m)?String(m):"null";case"boolean":case"bigint":return String(m);case"object":if(f)return m.toString();if(!m)return "null";if(a+=o,p=[],"[object Array]"===Object.prototype.toString.apply(m)){for(u=m.length,s=0;s<u;s+=1)p[s]=e(s,m)||"null";return l=0===p.length?"[]":a?`[\n${a}${p.join(",\n"+a)}\n${h}]`:`[${p.join(",")}]`,a=h,l}if(Array.isArray(d))for(u=d.length,s=0;s<u;s+=1)"string"==typeof d[s]&&(n=d[s],l=e(n,m),l&&p.push(c(n)+(a?": ":":")+l));else Object.keys(m).forEach(t=>{const i=e(t,m);i&&p.push(c(t)+(a?": ":":")+i);});return l=0===p.length?"{}":a?`{\n${a}${p.join(",\n"+a)}\n${h}}`:`{${p.join(",")}}`,a=h,l;default:return "null"}}("",{"":e})};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.JSONParse=void 0;const r=/(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])/,s=/(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)/;t.JSONParse=function(e){const t={strict:!1,storeAsString:!0,alwaysParseAsBig:!1,useNativeBigInt:!0,protoAction:"error",constructorAction:"error"};if(null!=e){if(!0===e.strict&&(t.strict=!0),!0===e.storeAsString&&(t.storeAsString=!0),t.alwaysParseAsBig=!0===e.alwaysParseAsBig&&e.alwaysParseAsBig,t.useNativeBigInt=!0===e.useNativeBigInt&&e.useNativeBigInt,void 0!==e.constructorAction){if("error"!==e.constructorAction&&"ignore"!==e.constructorAction&&"preserve"!==e.constructorAction)throw new Error('Incorrect value for constructorAction option, must be "error", "ignore" or undefined but passed '+e.constructorAction);t.constructorAction=e.constructorAction;}if(void 0!==e.protoAction){if("error"!==e.protoAction&&"ignore"!==e.protoAction&&"preserve"!==e.protoAction)throw new Error('Incorrect value for protoAction option, must be "error", "ignore" or undefined but passed '+e.protoAction);t.protoAction=e.protoAction;}}let i,a;const o={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};let n;const d=function(e){throw {name:"SyntaxError",message:e,at:i,text:n}},c=function(e){return e&&e!==a&&d(`Expected '${e}' instead of '${a}'`),a=n.charAt(i),i+=1,a},l=function(){let e,i="";for("-"===a&&(i="-",c("-"));a>="0"&&a<="9";)i+=a,c();if("."===a)for(i+=".";c()&&a>="0"&&a<="9";)i+=a;if("e"===a||"E"===a)for(i+=a,c(),"-"!==a&&"+"!==a||(i+=a,c());a>="0"&&a<="9";)i+=a,c();if(e=+i,isFinite(e))return i.length>15?t.storeAsString?i:t.useNativeBigInt?BigInt(i):null:t.alwaysParseAsBig?t.useNativeBigInt?BigInt(e):null:e;d("Bad number");};function u(){let e,t,r,s="";if('"'===a){let d=i;for(;c();){if('"'===a)return i-1>d&&(s+=n.substring(d,i-1)),c(),s;if("\\"===a){if(i-1>d&&(s+=n.substring(d,i-1)),c(),"u"===a){for(r=0,t=0;t<4&&(e=parseInt(c(),16),isFinite(e));t+=1)r=16*r+e;s+=String.fromCharCode(r);}else {if("string"!=typeof o[a])break;s+=o[a];}d=i;}}}d("Bad string");}const h=function(){for(;a&&a<=" ";)c();};function p(){switch(h(),a){case"{":return m();case"[":return function(){const e=[];if("["===a){if(c("["),h(),"]"===a)return c("]"),e;for(;a;){if(e.push(p()),h(),"]"===a)return c("]"),e;c(","),h();}}d("Bad array");}();case'"':return u();case"-":return l();default:return a>="0"&&a<="9"?l():function(){switch(a){case"t":return c("t"),c("r"),c("u"),c("e"),!0;case"f":return c("f"),c("a"),c("l"),c("s"),c("e"),!1;case"n":return c("n"),c("u"),c("l"),c("l"),null}d(`Unexpected '${a}'`);}()}}const m=function(){let e;const i=Object.create(null);if("{"===a){if(c("{"),h(),"}"===a)return c("}"),i;for(;a;){if(e=u(),h(),c(":"),!0===t.strict&&Object.hasOwnProperty.call(i,e)&&d(`Duplicate key "${e}"`),!0===r.test(e)?"error"===t.protoAction?d("Object contains forbidden prototype property"):"ignore"===t.protoAction?p():i[e]=p():!0===s.test(e)?"error"===t.constructorAction?d("Object contains forbidden constructor property"):"ignore"===t.constructorAction?p():i[e]=p():i[e]=p(),h(),"}"===a)return c("}"),i;c(","),h();}}d("Bad object");};return function(e,t){let r;return n=""+e,i=0,a=" ",r=p(),h(),a&&d("Syntax error"),"function"==typeof t?function e(i,r){let s;const a=i[r];return a&&"object"==typeof a&&Object.keys(a).forEach(t=>{s=e(a,t),void 0!==s?a[t]=s:delete a[t];}),t.call(i,r,a)}({"":r},""):r}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Meeting=void 0;const s=i(10),a=i(62),o=i(149),n=r(i(12)),d=r(i(13)),c=i(119),l=i(143);class u extends s.EventEmitter{constructor(e){super(),this.info={turn:!0,relay:!1,forward:!1,secure:!0},this._reset(),this.adapterRef=e.adapterRef,this.sdkRef=e.sdkRef,this.logger=e.adapterRef.logger.getChild(()=>{var t,i,r;let s="meeting";return this.info.secure||(s+=" INSECURE"),this.info.forward&&(s+=" FORWARD"),this.info.turn||(s+=" NOTURN"),(null===(r=null===(i=null===(t=e.adapterRef.instance)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)&&(s+=" PRIVATE"),e.adapterRef._meetings!==this&&(s+=" DETACHED"),s});}_reset(){}async getCloudProxyInfo(e){const{appkey:t,channelName:i,uid:r,token:s=""}=e;this.adapterRef.logger.log("getCloudProxyInfo() url: ",a.getCloudProxyInfoUrl);let u=a.getCloudProxyInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer&&(u=this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer,this.adapterRef.logger.log("getCloudProxyInfo() 私有化配置cloudProxyServer: ",u));let h=Date.parse(new Date)/1e3;try{const e=await this.adapterRef.lbsManager.ajax({url:u,type:"POST",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new l.SimpleBig(r),appkey:t,channelName:i,secureType:s?"1":"2",osType:"4",version:a.SDK_VERSION+".0"||!1,curtime:""+h,checksum:o(t+"."+r+"."+h),proxy:"1",needIPV6:"0"}});if(this.adapterRef.logger.log("getCloudProxyInfo() 获取到云代理服务相关信息: ",c.JSONBigStringify(e,null," ")),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:200===e.code?0:-1,param:{channelName:i,uid:r,appkey:t,token:s,reason:e.code}}),200===e.code){this.adapterRef.channelStatus="join";const{wsProxyArray:t,mediaProxyArray:i,mediaProxyToken:s,cname:a,curTime:o}=e;this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() webSocketProxyServer: ",this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer),this.adapterRef.proxyServer.wsProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer]):this.adapterRef.proxyServer.wsProxyArray=t,this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() mediaProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer),this.adapterRef.proxyServer.mediaProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer],this.adapterRef.proxyServer.mediaProxyToken="netease",this.adapterRef.proxyServer.credential="netease"):(this.adapterRef.proxyServer.mediaProxyArray=i,this.adapterRef.proxyServer.mediaProxyToken=s,this.adapterRef.proxyServer.credential=r+"/"+o);}else this.adapterRef.logger.log("getCloudProxyInfo() 云代理服务相关信息获取失败, 回滚");}catch(t){throw this.adapterRef.logger.log("getCloudProxyInfo() 网络请求异常:",t.name,t.message,t),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiFrequencyControl({name:"startProxyServer",code:-1,param:Object.assign(Object.assign({},e),{reason:t.message})}),new d.default({code:n.default.NETWORK_REQUEST_ERROR,message:t.message})}}async joinChannel(e){try{this.adapterRef.proxyServer.enable&&await this.getCloudProxyInfo(e);}catch(e){throw e}const{appkey:t,channelName:i,uid:r,wssArr:s=null,sessionMode:u="meeting",joinChannelRecordConfig:h,joinChannelLiveConfig:p,token:m="",permKey:f="",getChanneInfoResponse:g}=e;let v=Date.now(),y=+new Date,S=a.getChannelInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.channelServer&&(S=this.adapterRef.instance._params.neRtcServerAddresses.channelServer,this.logger.log("jion() 私有化配置的 getChannelInfoUrl: ",S)),Object.assign(this.adapterRef.channelInfo,{uid:r,sessionMode:u,appkey:t});try{let _=g;_||(_=await this.adapterRef.lbsManager.ajax({url:S,type:"POST",contentType:"application/x-www-form-urlencoded",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new l.SimpleBig(r),appkey:t,permKeySecret:f,channelName:i,secureType:m?"1":"2",osType:"4",mode:2,netType:"0",version:a.SDK_VERSION+".0"||!1,curtime:y,checksum:m||o(t+"."+r+"."+y),webrtc:1,nrtcg2:1,t1:v}}),this.adapterRef.state.getChannelInfoTime=Date.now());let R=!("0"==r||"0"!=r&&!r);if(this.info.secure=!!m,"string"==typeof _?(this.logger.warn("join() 返回值类型为string，应为object。尝试进行强制类型转换。",_),_=c.JSONBigParse(_)):this.logger.log("join() 获取到房间信息:",c.JSONBigStringify(_,null," ")),200===_.code){this.adapterRef.channelStatus="join";const{ips:a,time:o}=_;a&&a.uid||this.logger.warn("join 加入频道时服务端未返回uid");const n=_.config&&_.config.quality_level_limit||16;this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now();let d=a.webrtcarray&&a.webrtcarray.length&&a.webrtcarray[0];if(d&&this.adapterRef.proxyServer.wsProxyArray){const e=a.turnaddrs&&a.turnaddrs.length&&a.turnaddrs[0][0];let t=e.split(":").length>1?e.split(":")[1]:"",i=d.split("/").length>1?d.split("/")[1]:"";this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer&&(t=i.split(":")[1]),i&&t?this.adapterRef.proxyServer.wsProxyArray=this.adapterRef.proxyServer.wsProxyArray.map(e=>e+"/"+i.split(":")[0]+":"+t):this.adapterRef.logger.log(`join 云代理无法获取到代理信息, serverurl: ${i}, port: ${t}`);}Object.assign(this.adapterRef.channelInfo,{cid:+_.cid,permKey:f,token:_.token,turnToken:a.token,channelName:i,wssArr:s||this.adapterRef.proxyServer.enable&&this.adapterRef.proxyServer.wsProxyArray||a.webrtcarray||[],relayaddrs:this.adapterRef.proxyServer.mediaProxyArray||a.relayaddrs||null,relaytoken:this.adapterRef.proxyServer.mediaProxyToken||a.relaytoken||null,wssArrIndex:0,maxVideoQuality:n,netDetect:!1},{uid:R?r:a.uid,sessionMode:u,appkey:t}),e.uid=e.uid?e.uid:this.adapterRef.channelInfo.uid,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.token=_.token,this.adapterRef.channelInfo.T4=Date.now();let c=this.adapterRef.channelInfo.T4-o.t1-(o.t3-o.t2);return this.adapterRef.channelInfo.clientNtpTime=o.t3+Math.round(c/2),this.adapterRef.instance.setSessionConfig(Object.assign({maxVideoQuality:n},p,h)),this.info.relay=a.relayaddrs&&a.relayaddrs.length>0,this.info.turn=a.turnaddrs&&a.turnaddrs.length>0,this.adapterRef.instance.startSession()}{const e=_.desc&&""!==_.desc?"join() "+_.desc:"join() 服务器不允许加入房间, code "+_.code;return this.logger.error(e),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:h.recordAudio,v_record:h.recordVideo,record_type:h.recordType,host_speaker:h.isHostSpeaker,result:_.code,permKey:this.adapterRef.channelInfo.permKey,serverIp:_.ips&&_.ips.turnaddrs&&_.ips.turnaddrs.length&&_.ips.turnaddrs[0],desc:e}),Promise.reject(new d.default({code:n.default.SERVER_AUTH_ERROR,extraCode:_.code,message:e}))}}catch(e){throw this.logger.log("joing() 获取到房间信息错误:",e.name,e.message),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:h.recordAudio,v_record:h.recordVideo,record_type:h.recordType,host_speaker:h.isHostSpeaker,result:-1,desc:`join() 内部错误: ${e.name}, ${e.message}`,serverIp:""}),new d.default({code:e.getCode&&e.getCode()||n.default.JOIN_FAILED,message:e.getCode&&e.getMessage()||`join() 内部错误: ${e.name}, ${e.message}`})}}leaveChannel(){return this.adapterRef._signalling?this.adapterRef._signalling.doSendLogout().then(()=>(this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.stopSession())):Promise.resolve()}async addTasks(e){const{rtmpTasks:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("addTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks`;for(let e=0;e<t.length;e++){t[e].hostUid=new l.SimpleBig(this.adapterRef.channelInfo.uid),t[e].version=1,this.logger.log("addTasks() rtmpTask: ",c.JSONBigStringify(t[e]));const r=t[e].layout;r.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new l.SimpleBig(e.uid));});try{const s=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:t[e].hostUid,layout:r,config:t[e].config,extraInfo:t[e].extraInfo||""}});if(200!==s.code)return this.logger.error(`addTasks() 添加第 ${e} 个推流任务失败: `,s),Promise.reject(new d.default({code:n.default.ADD_TASK_FAILED_ERROR,extraCode:s.code,message:"addTasks() 添加推流任务失败: "+s.code}));this.logger.log(`addTasks() 添加第 ${e} 个推流任务完成`);}catch(e){return this.logger.error("addTasks: ",e.name,e.message),Promise.reject(new d.default({code:n.default.ADD_TASK_FAILED_ERROR,message:"addTasks() 内部错误: $e.message}"}))}}}async deleteTasks(e){const{taskIds:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("deleteTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks/delete`;for(let e=0;e<t.length;e++){this.logger.log("deleteTasks() taskId: ",t[e]);try{const r=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{taskId:t[e]}});return 200===r.code?(this.logger.log("删除推流任务完成"),Promise.resolve()):(this.logger.log("删除推流任务请求失败:",c.JSONBigStringify(r)),Promise.reject(new d.default({code:n.default.DELETE_TASK_FAILED_ERROR,extraCode:r.code,message:"deleteTasks() 删除推流任务失败: "+r.code})))}catch(e){return this.logger.error("deleteTasks发生错误: ",e.name,e.message),Promise.reject(new d.default({code:n.default.DELETE_TASK_FAILED_ERROR,message:"deleteTasks() 内部错误: $e.message}"}))}}}async updateTasks(e){const{rtmpTasks:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("updateTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/task/update`;for(let e=0;e<t.length;e++){const r=t[e].layout;r.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new l.SimpleBig(e.uid));});try{const s=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:new l.SimpleBig(this.adapterRef.channelInfo.uid),layout:r,config:t[e].config}});return 200===s.code?(this.logger.log("updateTasks() 更新推流任务完成"),Promise.resolve()):(this.logger.log("() 更新推流任务失败：",c.JSONBigStringify(s)),Promise.reject(new d.default({code:n.default.UPDATE_TASKS_FAILED_ERROR,extraCode:s.code,message:"updateTasks() 更新推流任务失败: "+s.code})))}catch(e){return this.logger.error("updateTasks 发生错误: ",e.name,e.message),Promise.reject(new d.default({code:n.default.UPDATE_TASKS_FAILED_ERROR,message:"updateTasks() 内部错误: $e.message}"}))}}}destroy(){this.logger.log("清除 meeting"),this._reset();}}t.Meeting=u;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.processManager=void 0;const r=i(57),s=i(4);t.processManager=new class{constructor(){this.id=new Date;const e=`${r.generateUUID().substr(0,4)}-${(new Date).toISOString().replace(/[^\d]/g,"")}`;if(this.processId="proc-"+e,!s.getParameters().reportPageBrowserId)return this.pageId="",void(this.browserId="");try{let t=sessionStorage.getItem("NERTC_PAGEID");t||(t="page-"+e,sessionStorage.setItem("NERTC_PAGEID",t)),this.pageId=t;}catch(e){this.pageId="";}try{let t=sessionStorage.getItem("NERTC_BROWSERID");t||(t="brow-"+e,localStorage.setItem("NERTC_BROWSERID",t)),this.browserId=t;}catch(e){this.browserId="";}}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReport=void 0;const s=i(10),a=i(62),o=r(i(249)),n=r(i(250)),d=i(266),c=i(4),l=i(118),u=i(268),h=i(175),p=Date.now();class m extends s.EventEmitter{constructor(e){var t,i;super(),this._reset(),this.heartbeat_=-1,this.wsTransport_=null,this.sdkRef=e.sdkRef,this.adapterRef=e.adapterRef,this.isReport=e.isReport,this.appKey=this.adapterRef.instance._params.appkey||this.adapterRef.channelInfo&&this.adapterRef.channelInfo.appKey||"",this.reportData={appkey:this.appKey,cid:(null===(t=this.adapterRef)||void 0===t?void 0:t.channelInfo.cid)||0,uid:""+(null===(i=this.adapterRef)||void 0===i?void 0:i.channelInfo.uid)||"0",browser:l.getBrowserInfo().browserName,platform:l.getOSInfo().osName,timestamp:0,local:{},remote:{}},this.stats=new d.GetStats({adapterRef:this.adapterRef});}_reset(){this.stats&&this.stats.destroy(),this.stats=null,this.stopHeartbeat();}stop(){this.stats&&this.stats.stop();}start(){var e,t,i;this.reportData.uid=""+(null===(e=this.adapterRef)||void 0===e?void 0:e.channelInfo.uid)||"0",this.reportData.cid=null===(t=this.adapterRef)||void 0===t?void 0:t.channelInfo.cid;let r=null===(i=this.adapterRef)||void 0===i?void 0:i.deviceId,s=u(`0${p}${a.SDK_VERSION}webwebrtc${r}40f5a1a1871e46089e1e5139a779dd77`),o=`${this.adapterRef.instance._params.neRtcServerAddresses.statisticsWebSocketServer||"wss://statistic.live.126.net/lps-websocket/websocket/collect"}?deviceId=${r}&isTest=0&sdkVer=${a.SDK_VERSION}&sdktype=webrtc&timestamp=${p}&platform=web&checkSum=${s}`,d=window;this.wsTransport_=d.wsTransport=new n.default({url:o,adapterRef:this.adapterRef}),this.wsTransport_.init(),this.startHeartbeat();}startHeartbeat(){-1===this.heartbeat_&&(this.adapterRef.logger.log("startHeartbeat..."),this.heartbeat_=o.default.setInterval(this.doHeartbeat.bind(this),c.getParameters().doHeartbeatInterval));}stopHeartbeat(){-1!==this.heartbeat_&&(o.default.clearInterval(this.heartbeat_),this.heartbeat_=-1);}async doHeartbeat(){var e;try{let t=await(null===(e=this.stats)||void 0===e?void 0:e.getAllStats());this.isReport&&(null==t?void 0:t.times)%2==0&&(this.reportData.local=null==t?void 0:t.local,this.reportData.remote=null==t?void 0:t.remote,this.reportData.timestamp=(new Date).getTime(),this.wsTransport_.sendPB(this.reportData)),(null==t?void 0:t.times)%60==0&&this.sendDataReportHeartbeat();}catch(e){this.adapterRef.logger.warn("数据上报出现异常: ",e.message);}}sendDataReportHeartbeat(){var e;let t=new h.DataReport({adapterRef:this.adapterRef});t.setHeartbeat({name:"setHeartbeat",uid:""+(null===(e=this.adapterRef)||void 0===e?void 0:e.channelInfo.uid)||"0",cid:""+this.adapterRef.channelInfo.cid}),t.send();}destroy(){this.sendDataReportHeartbeat(),this.stop(),this._reset(),this.isReport&&this.wsTransport_&&this.wsTransport_.close();}}t.StatsReport=m;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(57);const s=new class{constructor(){this.intervalMap_=new Map;}setInterval(e,t,i=!0){const s=r.generateUUID();let a=Date.now(),o=a;this.intervalMap_.set(s,{rafId:null,timeoutId:null,onVisibilityChange:null});const n=()=>{if(i&&document.hidden){e();const i=setTimeout(n,t);this.setTimeoutId(s,i),a=Date.now(),o=a;}else {o=Date.now(),o-a>=t&&(a=o,e());const i=requestAnimationFrame(n);this.setRafId(s,i);}},d=requestAnimationFrame(n);if(this.setRafId(s,d),i){const e=()=>{if(document.hidden){const e=Date.now()-a;if(e>=t)n();else {const i=setTimeout(n,t-e);this.setTimeoutId(s,i);}}};document.addEventListener("visibilitychange",e),this.setOnVisibilityChange(s,e);}return s}clearInterval(e){if(this.intervalMap_.has(e)){const{rafId:t,timeoutId:i,onVisibilityChange:r}=this.intervalMap_.get(e);cancelAnimationFrame(t),clearTimeout(i),document.removeEventListener("visibilitychange",r),this.intervalMap_.delete(e);}}setTimeoutId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t;}}setRafId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t;}}setOnVisibilityChange(e,t){if(this.intervalMap_.has(e)){this.intervalMap_.get(e).onVisibilityChange=t;}}};t.default=s;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=i(10),n=a(i(176)),d=i(57),c=i(265);let l=new Uint8Array(1);l[0]=10;const u=l;t.default=class{constructor(e){this.lastLogTime=0,this.cachedLogs=[],this.textEncoder=new TextEncoder,this.url_=e.url,this.socket_=null,this.isConnected_=!1,this.isConnecting_=!1,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.reconnectionTimer_=-1,this.reconnectionCount_=0,this.emitter_=new o.EventEmitter,this.adapterRef=e.adapterRef,this.logger=this.adapterRef.logger.getChild(()=>"wsTransport");}init(){this.logger.log("connect to url: "+this.url_),this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this);}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{};}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1;const t=e.target.url;this.logger.log(`websocket[${t}] is connected`),this.urlSetting&&(this.logger.debug(`markFinish success seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.startPingPong();}onclose(e){const t=e.target.url,i=e.target===this.socket_;this.logger.log(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),this.socket_&&e.target===this.socket_&&(this.isConnected_=!1,e.wasClean&&1e3===e.code?this.close():(this.logger.warn(`onclose code:${e.code} reason:${e.reason}`),this.socket_.onclose=()=>{},this.socket_.close(4001),this.socket_=null,this.reconnect()));}onerror(e){const t=e.target.url;this.logger.warn(`websocket[${t}] error observed`),this.urlSetting&&(this.logger.debug(`markFinish fail seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.isConnected_?e.target===this.socket_&&(this.isConnected_=!1,this.socket_=null,this.reconnect()):this.reconnect(),this.isConnecting_=!1,this.isConnected_=!1;}onmessage(e){if(this.isConnected_&&e&&e.data){11===JSON.parse(e.data).action&&this.emit(11,e),this.clearReconnectionTimer();}}isConnected(){return this.isConnected_}sendPB(e){var t;if(this.isConnected_){const i=this.createPBMessage(e);1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(i);}}sendPing(e){var t;this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(e);}sendLog(e){var t,i;const r=Math.max(this.lastLogTime+1,Date.now());this.lastLogTime=r;try{this.cachedLogs.length&&this.cachedLogs[this.cachedLogs.length-1].data[0].replace("[NERTC","[缓存][NERTC");}catch(e){}if(this.cachedLogs.push({time:r,data:e}),this.cachedLogs.length>50&&this.cachedLogs.shift(),this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&(null===(i=this.adapterRef.channelInfo)||void 0===i?void 0:i.cid)){const e=this.cachedLogs;this.cachedLogs=[];for(let t of e){const e=Object.assign({uid:this.adapterRef.channelInfo.uid,cid:this.adapterRef.channelInfo.cid},t);try{const t=this.textEncoder.encode(JSON.stringify(e));let i=[5,1,1,1,2,0,0,0],r=Uint8Array.from(i.concat(Array.from(t)));this.socket_.send(r);}catch(e){}}}}createPBMessage(e){let t=n.Root.fromJSON(c).lookupType("WebrtcStats"),i=t.create(e),r=t.encode(i).finish();return Uint8Array.from([4,1,1,1,3,0,0,0].concat(Array.from(r)))}async startPingPong(){try{if(-1!==this.pingPongTimeoutId_)return;await this.ping(),this.pingPongTimeoutId_=setTimeout(()=>{this.pingPongTimeoutId_=-1,this.startPingPong();},1e4);}catch(e){this.logger.log("ping-pong failed, start reconnection"),this.clearSocket(),this.reconnect();}}stopPingPong(){this.logger.log("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1;}ping(){return new Promise((e,t)=>{if(-1!==this.pingTimeoutId_)return e();this.sendPing(u),this.once(11,()=>{clearTimeout(this.pingTimeoutId_),this.pingTimeoutId_=-1,e();}),this.pingTimeoutId_=setTimeout(()=>{this.pingTimeoutId_=-1,t();},1e4);})}reconnect(){var e,t,i;if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.logger.log("websocket is reconnecting");if(this.isConnecting_=!0,this.reconnectionCount_++,null===(i=null===(t=null===(e=this.adapterRef.instance)||void 0===e?void 0:e._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return void this.logger.log("WebSocket不启用备用线路：当前为私有化配置");{const e=this.adapterRef.lbsManager.getURLSettings(this.url_),t=e[this.reconnectionCount_%e.length];t.url!==this.url_&&(this.logger.warn(`${t.seqId} WebSocket切换备用线路 ${this.url_} => ${t.url}`),this.url_=t.url,this.urlSetting=t);}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);const r=d.getReconnectionTimeout(this.reconnectionCount_);this.reconnectionTimer_=setTimeout(()=>{this.isConnecting_=!1,this.clearReconnectionTimer(),this.socket_&&this.unbindSocket(this.socket_),this.socket_=null,this.reconnect();},r);}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1);}once(e,t,i){this.emitter_.once(e,t,i);}emit(e,t,i){this.emitter_.emit(e,t,i);}clearSocket(){this.socket_&&this.unbindSocket(this.socket_),this.isConnected_=!1,this.isConnecting_=!1,this.socket_=null;}close(){var e;this.logger.log("close websocket"),this.clearReconnectionTimer(),this.stopPingPong(),null===(e=this.socket_)||void 0===e||e.close(),this.clearSocket();}};},function(e,t,i){var r=e.exports=i(252);r.build="light",r.load=function(e,t,i){return "function"==typeof t?(i=t,t=new r.Root):t||(t=new r.Root),t.load(e,i)},r.loadSync=function(e,t){return t||(t=new r.Root),t.loadSync(e)},r.encoder=i(181),r.decoder=i(186),r.verifier=i(187),r.converter=i(188),r.ReflectionObject=i(120),r.Namespace=i(129),r.Root=i(190),r.Enum=i(59),r.Type=i(182),r.Field=i(121),r.OneOf=i(144),r.MapField=i(183),r.Service=i(184),r.Method=i(185),r.Message=i(156),r.wrappers=i(189),r.types=i(130),r.util=i(25),r.ReflectionObject._configure(r.Root),r.Namespace._configure(r.Type,r.Service,r.Enum),r.Root._configure(r.Type),r.Field._configure(r.Type);},function(e,t,i){var r=t;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader);}r.build="minimal",r.Writer=i(154),r.BufferWriter=i(259),r.Reader=i(155),r.BufferReader=i(260),r.util=i(58),r.rpc=i(179),r.roots=i(180),r.configure=s,s();},function(e,t,i){var r=t;r.length=function(e){var t=e.length;if(!t)return 0;for(var i=0;--t%4>1&&"="===e.charAt(t);)++i;return Math.ceil(3*e.length)/4-i};for(var s=new Array(64),a=new Array(123),o=0;o<64;)a[s[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;r.encode=function(e,t,i){for(var r,a=null,o=[],n=0,d=0;t<i;){var c=e[t++];switch(d){case 0:o[n++]=s[c>>2],r=(3&c)<<4,d=1;break;case 1:o[n++]=s[r|c>>4],r=(15&c)<<2,d=2;break;case 2:o[n++]=s[r|c>>6],o[n++]=s[63&c],d=0;}n>8191&&((a||(a=[])).push(String.fromCharCode.apply(String,o)),n=0);}return d&&(o[n++]=s[r],o[n++]=61,1===d&&(o[n++]=61)),a?(n&&a.push(String.fromCharCode.apply(String,o.slice(0,n))),a.join("")):String.fromCharCode.apply(String,o.slice(0,n))};r.decode=function(e,t,i){for(var r,s=i,o=0,n=0;n<e.length;){var d=e.charCodeAt(n++);if(61===d&&o>1)break;if(void 0===(d=a[d]))throw Error("invalid encoding");switch(o){case 0:r=d,o=1;break;case 1:t[i++]=r<<2|(48&d)>>4,r=d,o=2;break;case 2:t[i++]=(15&r)<<4|(60&d)>>2,r=d,o=3;break;case 3:t[i++]=(3&r)<<6|d,o=0;}}if(1===o)throw Error("invalid encoding");return i-s},r.test=function(e){return /^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)};},function(e,t,i){function r(){this._listeners={};}e.exports=r,r.prototype.on=function(e,t,i){return (this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this},r.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var i=this._listeners[e],r=0;r<i.length;)i[r].fn===t?i.splice(r,1):++r;return this},r.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,i);}return this};},function(e,t,i){function r(e){return "undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),r=128===i[3];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3];}function a(e,r,s){t[0]=e,r[s]=i[3],r[s+1]=i[2],r[s+2]=i[1],r[s+3]=i[0];}function o(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],t[0]}function n(e,r){return i[3]=e[r],i[2]=e[r+1],i[1]=e[r+2],i[0]=e[r+3],t[0]}e.writeFloatLE=r?s:a,e.writeFloatBE=r?a:s,e.readFloatLE=r?o:n,e.readFloatBE=r?n:o;}():function(){function t(e,t,i,r){var s=t<0?1:0;if(s&&(t=-t),0===t)e(1/t>0?0:2147483648,i,r);else if(isNaN(t))e(2143289344,i,r);else if(t>34028234663852886e22)e((s<<31|2139095040)>>>0,i,r);else if(t<11754943508222875e-54)e((s<<31|Math.round(t/1401298464324817e-60))>>>0,i,r);else {var a=Math.floor(Math.log(t)/Math.LN2);e((s<<31|a+127<<23|8388607&Math.round(t*Math.pow(2,-a)*8388608))>>>0,i,r);}}function i(e,t,i){var r=e(t,i),s=2*(r>>31)+1,a=r>>>23&255,o=8388607&r;return 255===a?o?NaN:s*(1/0):0===a?1401298464324817e-60*s*o:s*Math.pow(2,a-150)*(o+8388608)}e.writeFloatLE=t.bind(null,s),e.writeFloatBE=t.bind(null,a),e.readFloatLE=i.bind(null,o),e.readFloatBE=i.bind(null,n);}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),r=128===i[7];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7];}function a(e,r,s){t[0]=e,r[s]=i[7],r[s+1]=i[6],r[s+2]=i[5],r[s+3]=i[4],r[s+4]=i[3],r[s+5]=i[2],r[s+6]=i[1],r[s+7]=i[0];}function o(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],i[4]=e[r+4],i[5]=e[r+5],i[6]=e[r+6],i[7]=e[r+7],t[0]}function n(e,r){return i[7]=e[r],i[6]=e[r+1],i[5]=e[r+2],i[4]=e[r+3],i[3]=e[r+4],i[2]=e[r+5],i[1]=e[r+6],i[0]=e[r+7],t[0]}e.writeDoubleLE=r?s:a,e.writeDoubleBE=r?a:s,e.readDoubleLE=r?o:n,e.readDoubleBE=r?n:o;}():function(){function t(e,t,i,r,s,a){var o=r<0?1:0;if(o&&(r=-r),0===r)e(0,s,a+t),e(1/r>0?0:2147483648,s,a+i);else if(isNaN(r))e(0,s,a+t),e(2146959360,s,a+i);else if(r>17976931348623157e292)e(0,s,a+t),e((o<<31|2146435072)>>>0,s,a+i);else {var n;if(r<22250738585072014e-324)e((n=r/5e-324)>>>0,s,a+t),e((o<<31|n/4294967296)>>>0,s,a+i);else {var d=Math.floor(Math.log(r)/Math.LN2);1024===d&&(d=1023),e(4503599627370496*(n=r*Math.pow(2,-d))>>>0,s,a+t),e((o<<31|d+1023<<20|1048576*n&1048575)>>>0,s,a+i);}}}function i(e,t,i,r,s){var a=e(r,s+t),o=e(r,s+i),n=2*(o>>31)+1,d=o>>>20&2047,c=4294967296*(1048575&o)+a;return 2047===d?c?NaN:n*(1/0):0===d?5e-324*n*c:n*Math.pow(2,d-1075)*(c+4503599627370496)}e.writeDoubleLE=t.bind(null,s,0,4),e.writeDoubleBE=t.bind(null,a,4,0),e.readDoubleLE=i.bind(null,o,0,4),e.readDoubleBE=i.bind(null,n,4,0);}(),e}function s(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24;}function a(e,t,i){t[i]=e>>>24,t[i+1]=e>>>16&255,t[i+2]=e>>>8&255,t[i+3]=255&e;}function o(e,t){return (e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function n(e,t){return (e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=r(r);},function(e,t,i){var r=t;r.length=function(e){for(var t=0,i=0,r=0;r<e.length;++r)(i=e.charCodeAt(r))<128?t+=1:i<2048?t+=2:55296==(64512&i)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},r.read=function(e,t,i){if(i-t<1)return "";for(var r,s=null,a=[],o=0;t<i;)(r=e[t++])<128?a[o++]=r:r>191&&r<224?a[o++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,a[o++]=55296+(r>>10),a[o++]=56320+(1023&r)):a[o++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,a)),o=0);return s?(o&&s.push(String.fromCharCode.apply(String,a.slice(0,o))),s.join("")):String.fromCharCode.apply(String,a.slice(0,o))},r.write=function(e,t,i){for(var r,s,a=i,o=0;o<e.length;++o)(r=e.charCodeAt(o))<128?t[i++]=r:r<2048?(t[i++]=r>>6|192,t[i++]=63&r|128):55296==(64512&r)&&56320==(64512&(s=e.charCodeAt(o+1)))?(r=65536+((1023&r)<<10)+(1023&s),++o,t[i++]=r>>18|240,t[i++]=r>>12&63|128,t[i++]=r>>6&63|128,t[i++]=63&r|128):(t[i++]=r>>12|224,t[i++]=r>>6&63|128,t[i++]=63&r|128);return i-a};},function(e,t,i){e.exports=function(e,t,i){var r=i||8192,s=r>>>1,a=null,o=r;return function(i){if(i<1||i>s)return e(i);o+i>r&&(a=e(r),o=0);var n=t.call(a,o,o+=i);return 7&o&&(o=1+(7|o)),n}};},function(e,t,i){e.exports=s;var r=i(58);function s(e,t){this.lo=e>>>0,this.hi=t>>>0;}var a=s.zero=new s(0,0);a.toNumber=function(){return 0},a.zzEncode=a.zzDecode=function(){return this},a.length=function(){return 1};var o=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(e){if(0===e)return a;var t=e<0;t&&(e=-e);var i=e>>>0,r=(e-i)/4294967296>>>0;return t&&(r=~r>>>0,i=~i>>>0,++i>4294967295&&(i=0,++r>4294967295&&(r=0))),new s(i,r)},s.from=function(e){if("number"==typeof e)return s.fromNumber(e);if(r.isString(e)){if(!r.Long)return s.fromNumber(parseInt(e,10));e=r.Long.fromString(e);}return e.low||e.high?new s(e.low>>>0,e.high>>>0):a},s.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,i=~this.hi>>>0;return t||(i=i+1>>>0),-(t+4294967296*i)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(e){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var n=String.prototype.charCodeAt;s.fromHash=function(e){return e===o?a:new s((n.call(e,0)|n.call(e,1)<<8|n.call(e,2)<<16|n.call(e,3)<<24)>>>0,(n.call(e,4)|n.call(e,5)<<8|n.call(e,6)<<16|n.call(e,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},s.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},s.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:i<128?9:10};},function(e,t,i){e.exports=a;var r=i(154);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(58);function a(){r.call(this);}function o(e,t,i){e.length<40?s.utf8.write(e,t,i):t.utf8Write?t.utf8Write(e,i):t.write(e,i);}a._configure=function(){a.alloc=s._Buffer_allocUnsafe,a.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(e,t,i){t.set(e,i);}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var r=0;r<e.length;)t[i++]=e[r++];};},a.prototype.bytes=function(e){s.isString(e)&&(e=s._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(a.writeBytesBuffer,t,e),this},a.prototype.string=function(e){var t=s.Buffer.byteLength(e);return this.uint32(t),t&&this._push(o,t,e),this},a._configure();},function(e,t,i){e.exports=a;var r=i(155);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(58);function a(e){r.call(this,e);}a._configure=function(){s.Buffer&&(a.prototype._slice=s.Buffer.prototype.slice);},a.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},a._configure();},function(e,t,i){e.exports=s;var r=i(58);function s(e,t,i){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(i);}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,i,s,a,o){if(!a)throw TypeError("request must be specified");var n=this;if(!o)return r.asPromise(e,n,t,i,s,a);if(n.rpcImpl)try{return n.rpcImpl(t,i[n.requestDelimited?"encodeDelimited":"encode"](a).finish(),(function(e,i){if(e)return n.emit("error",e,t),o(e);if(null!==i){if(!(i instanceof s))try{i=s[n.responseDelimited?"decodeDelimited":"decode"](i);}catch(e){return n.emit("error",e,t),o(e)}return n.emit("data",i,t),o(null,i)}n.end(!0);}))}catch(e){return n.emit("error",e,t),void setTimeout((function(){o(e);}),0)}else setTimeout((function(){o(Error("already ended"));}),0);},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};},function(e,t,i){function r(e,t){"string"==typeof e&&(t=e,e=void 0);var i=[];function s(e){if("string"!=typeof e){var t=a();if(r.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var o=Object.keys(e),n=new Array(o.length+1),d=new Array(o.length),c=0;c<o.length;)n[c]=o[c],d[c]=e[o[c++]];return n[c]=t,Function.apply(null,n).apply(null,d)}return Function(t)()}for(var l=new Array(arguments.length-1),u=0;u<l.length;)l[u]=arguments[++u];if(u=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var i=l[u++];switch(t){case"d":case"f":return String(Number(i));case"i":return String(Math.floor(i));case"j":return JSON.stringify(i);case"s":return String(i)}return "%"})),u!==l.length)throw Error("parameter count mismatch");return i.push(e),s}function a(r){return "function "+(r||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+i.join("\n  ")+"\n}"}return s.toString=a,s}e.exports=r,r.verbose=!1;},function(e,t,i){e.exports=a;var r=i(177),s=i(178)("fs");function a(e,t,i){return "function"==typeof t?(i=t,t={}):t||(t={}),i?!t.xhr&&s&&s.readFile?s.readFile(e,(function(r,s){return r&&"undefined"!=typeof XMLHttpRequest?a.xhr(e,t,i):r?i(r):i(null,t.binary?s:s.toString("utf8"))})):a.xhr(e,t,i):r(a,this,e,t)}a.xhr=function(e,t,i){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(0!==r.status&&200!==r.status)return i(Error("status "+r.status));if(t.binary){var e=r.response;if(!e){e=[];for(var s=0;s<r.responseText.length;++s)e.push(255&r.responseText.charCodeAt(s));}return i(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return i(null,r.responseText)}},t.binary&&("overrideMimeType"in r&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.responseType="arraybuffer"),r.open("GET",e),r.send();};},function(e,t,i){var r=t,s=r.isAbsolute=function(e){return /^(?:\/|\w+:)/.test(e)},a=r.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),i=s(e),r="";i&&(r=t.shift()+"/");for(var a=0;a<t.length;)".."===t[a]?a>0&&".."!==t[a-1]?t.splice(--a,2):i?t.splice(a,1):++a:"."===t[a]?t.splice(a,1):++a;return r+t.join("/")};r.resolve=function(e,t,i){return i||(t=a(t)),s(t)?t:(i||(e=a(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?a(e+"/"+t):t)};},function(e,t,i){var r=i(176),s=(r.roots.default||(r.roots.default=new r.Root)).addJSON({WebrtcStats:{fields:{local:{type:"local_obj",id:1},remote:{type:"remote_obj",id:2},timestamp:{type:"int64",id:3},appkey:{type:"string",id:4},cid:{type:"int64",id:5},uid:{type:"string",id:6},browser:{type:"string",id:7},platform:{type:"string",id:8},sdkVersion:{type:"string",id:9}},nested:{local_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4},bwe:{rule:"repeated",type:"bwe_obj",id:5}},nested:{audio_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},audioSlave_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},video_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},screen_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},bwe_obj:{fields:{googActualEncBitrate:{type:"int64",id:1},googAvailableSendBandwidth:{type:"int64",id:2},googRetransmitBitrate:{type:"int64",id:3},googAvailableReceiveBandwidth:{type:"int64",id:4},googTargetEncBitrate:{type:"int64",id:5},googBucketDelay:{type:"int64",id:6},googTransmitBitrate:{type:"int64",id:7}}}}},remote_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4}},nested:{audio_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},audioSlave_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},video_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}},screen_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}}}}}}});e.exports=s;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GetStats=void 0;const o=i(267),n=a(i(24));t.GetStats=class{constructor(e){this.times=0,this.tmp={bytesSent:0,bytesReceived:0},this.adapterRef=e.adapterRef,this.browser="chrome",this.audioLevel=[],this._reset(),this.formativeStatsReport=new o.FormativeStatsReport({adapterRef:this.adapterRef});}_reset(){this.times=0,this.browser="chrome",n.IS_CHROME_ONLY&&n.CHROME_MAJOR_VERSION&&n.CHROME_MAJOR_VERSION>=72||n.IS_ANDROID?this.browser="chrome":n.IS_ANY_SAFARI&&n.SAFARI_MAJOR_VERSION&&n.SAFARI_MAJOR_VERSION>=12||n.IS_ANY_SAFARI&&n.IS_WECHAT?this.browser="safari":n.IS_FIREFOX&&n.FIREFOX_MAJOR_VERSION&&n.FIREFOX_MAJOR_VERSION>=60&&(this.browser="firefox"),this.audioLevel=[],this.formativeStatsReport&&this.formativeStatsReport.destroy(),this.formativeStatsReport=null;}async getAllStats(){var e,t,i,r,s,a,o,n,d,c,l,u;try{let l=null===(r=null===(i=null===(t=null===(e=null==this?void 0:this.adapterRef)||void 0===e?void 0:e._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i?void 0:i._handler)||void 0===r?void 0:r._pc,h=null===(n=null===(o=null===(a=null===(s=null==this?void 0:this.adapterRef)||void 0===s?void 0:s._mediasoup)||void 0===a?void 0:a._recvTransport)||void 0===o?void 0:o._handler)||void 0===n?void 0:n._pc;if(!l&&!h)return;this.audioLevel.length=0,this.adapterRef.remoteAudioStats={},this.adapterRef.remoteAudioSlaveStats={},this.adapterRef.remoteVideoStats={},this.adapterRef.remoteScreenStats={},this.tmp={bytesSent:0,bytesReceived:0},this.times=(this.times||0)+1;let p={local:l?await this.getLocalStats(l):null,remote:h?await this.getRemoteStats(h):null,times:this.times};return this.audioLevel.sort((u="level",function(e,t){var i=e[u],r=t[u];return 0===r||r?0===i||i?r-i:1:-1})),this.audioLevel.length>0&&this.audioLevel[0].level>0&&(null===(d=null==this?void 0:this.adapterRef)||void 0===d||d.instance.safeEmit("active-speaker",this.audioLevel[0]),null===(c=null==this?void 0:this.adapterRef)||void 0===c||c.instance.safeEmit("volume-indicator",this.audioLevel)),p}catch(e){null===(l=this.adapterRef)||void 0===l||l.logger.warn("数据汇集出现异常: ",e.message);}}async getLocalStats(e){return !e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"send")}async getRemoteStats(e){return !e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"recv")}async chrome(e,t){const i=await(()=>new Promise((i,r)=>{e.getStats(r=>{let s={};r.result().forEach((function(e){const t={};e.names().forEach((function(i){t[i]=e.stat(i);})),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,s[t.id]=t;})),e.lastStats=e.lastStats||{},s=this.formatChromeNonStandardStats(e,s,t),i(s);});}))(),r=await(async()=>{if(!e.getTransceivers)return {};let i={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];if("sendonly"===a.direction){if(a.sender&&a.sender.track&&a.sender.getStats)if(s=await a.sender.getStats(),s=this.formatChromeStandardizedStats(s,t),s.video_ssrc&&i.video_ssrc){if(i.video_ssrc.push(s.video_ssrc[0]),i.video_ssrc.length>1){"low"===(i.video_ssrc[0]||{}).streamType&&([i.video_ssrc[0],i.video_ssrc[1]]=[i.video_ssrc[1],i.video_ssrc[0]]);}}else if(s.screen_ssrc&&i.screen_ssrc){if(i.screen_ssrc.push(s.screen_ssrc[0]),i.screen_ssrc.length>1){"low"===(i.screen_ssrc[0]||{}).streamType&&([i.screen_ssrc[0],i.screen_ssrc[1]]=[i.screen_ssrc[1],i.screen_ssrc[0]]);}}else Object.assign(i,s);}else "recvonly"===a.direction&&a.receiver&&a.receiver.track&&a.receiver.getStats&&(s=await a.receiver.getStats(),s=this.formatChromeStandardizedStats(s,t),s.audio_ssrc&&i.audio_ssrc?i.audio_ssrc.push(s.audio_ssrc[0]):s.audioSlave_ssrc&&i.audioSlave_ssrc?i.audioSlave_ssrc.push(s.audioSlave_ssrc[0]):s.video_ssrc&&i.video_ssrc?i.video_ssrc.push(s.video_ssrc[0]):s.screen_ssrc&&i.screen_ssrc?i.screen_ssrc.push(s.screen_ssrc[0]):Object.assign(i,s));}return i})(),s={};return i&&r?Object.keys(i).forEach(e=>{const t=i[e],a=r[e];if(s[e]=[],a)for(let i=0;i<t.length;i++)a[i]&&s[e].push(Object.assign(t[i],a[i]));else s[e]=t;}):i?Object.assign(s,i):r&&Object.assign(s,r),s}formatChromeNonStandardStats(e,t,i){function r(e){if(!e)return 16;let t;return t=new Map([["speech_low_quality",16],["speech_standard",32],["music_standard",48],["standard_stereo",48],["high_quality",48],["high_quality_stereo",48]]).get(e),t}const s=[],a=[],o=[],n=[],d=[];Object.values(t).forEach(t=>{var c,l,u,h,p,m,f,g,v,y,S,_,R,b,T,E,A,w,I,C,O,k,P,x,M,D,N,L,F;if(t.id.includes("Conn-")&&"true"===t.googActiveConnection&&(null===(c=this.formativeStatsReport)||void 0===c||c.formatTransportData(t,i)),t.id.includes("Cand-")&&t.networkType)this.adapterRef.transportStats.NetworkType=t.networkType||"";else if("bweforvideo"===t.id&&"send"===i)t=function(e){const t={googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1};return Object.keys(e).map(i=>{t[i]&&(e[i]=parseInt(e[i])/1024);}),e}(t),this.adapterRef.transportStats.OutgoingAvailableBandwidth=t.googAvailableSendBandwidth,d.push({googActualEncBitrate:parseInt(t.googActualEncBitrate)||0,googAvailableSendBandwidth:parseInt(t.googAvailableSendBandwidth)||0,googRetransmitBitrate:parseInt(t.googRetransmitBitrate)||0,googAvailableReceiveBandwidth:parseInt(t.googAvailableReceiveBandwidth)||0,googTargetEncBitrate:parseInt(t.googTargetEncBitrate)||0,googTransmitBitrate:parseInt(t.googTransmitBitrate)||0,googBucketDelay:parseInt(t.googBucketDelay)||0});else if(/^ssrc_/i.test(t.id)){const d=null===(l=null==this?void 0:this.adapterRef)||void 0===l?void 0:l.instance.getUidAndKindBySsrc(parseInt(t.ssrc)),c=null==d?void 0:d.uid,V=null==d?void 0:d.streamType;let B="";B=(null==d?void 0:d.kind)?d.kind:"screen"===t.googContentType?"screen":t.mediaType;let U={};if("send"===i){if("audio"===t.mediaType){void 0!==t.audioInputLevel&&(U.audioInputLevel=parseInt(t.audioInputLevel)),U.totalAudioEnergy=parseInt(t.totalAudioEnergy),U.totalSamplesDuration=parseInt(t.totalSamplesDuration),U.bytesSent=parseInt(t.bytesSent),U.packetsSent=parseInt(t.packetsSent),U.packetsLost=parseInt(t.packetsLost),U.rtt=parseInt(t.googRtt),U.jitterReceived=parseInt(t.googJitterReceived),void 0!==t.googEchoCancellationReturnLoss&&(U.echoReturnLoss=t.googEchoCancellationReturnLoss),void 0!==t.googEchoCancellationReturnLossEnhancement&&(U.echoReturnLossEnhancement=t.googEchoCancellationReturnLossEnhancement),null===(u=this.formativeStatsReport)||void 0===u||u.formatSendData(U,B);const i={CodecType:"Opus",rtt:U.rtt||0,MuteState:(null===(f=null===(m=null===(p=null===(h=null==this?void 0:this.adapterRef)||void 0===h?void 0:h.localStream)||void 0===p?void 0:p.muteStatus)||void 0===m?void 0:m.audio)||void 0===f?void 0:f.send)||!1,RecordingLevel:U.audioInputLevel||0,SamplingRate:r(null===(v=null===(g=null==this?void 0:this.adapterRef)||void 0===g?void 0:g.localStream)||void 0===v?void 0:v.audioProfile),SendBitrate:U.bitsSentPerSecond||0,SendLevel:U.audioInputLevel||0};"audio"===B?(s.push(U),(null===(y=e.audioSender)||void 0===y?void 0:y.track)?this.adapterRef.localAudioStats[0]=i:this.adapterRef.localAudioStats=[]):"audioSlave"===B&&(a.push(U),(null===(S=e.audioSlaveSender)||void 0===S?void 0:S.track)?this.adapterRef.localAudioSlaveStats[0]=i:this.adapterRef.localAudioSlaveStats=[]);}else if("video"===t.mediaType){U.bytesSent=parseInt(t.bytesSent),U.packetsSent=parseInt(t.packetsSent),U.packetsLost=parseInt(t.packetsLost),U.firCount=parseInt(t.googFirsReceived),U.pliCount=parseInt(t.googPlisReceived),U.nackCount=parseInt(t.googNacksReceived),void 0!==t.framesEncoded&&(U.framesEncoded=parseInt(t.framesEncoded)),U.avgEncodeMs=parseInt(t.googAvgEncodeMs),U.encodeUsagePercent=parseInt(t.googEncodeUsagePercent),U.frameRateInput=parseInt(t.googFrameRateInput),U.frameRateSent=parseInt(t.googFrameRateSent),U.frameWidthInput=parseInt(t.googFrameWidthInput),U.frameWidthSent=parseInt(t.googFrameWidthSent),U.frameHeightInput=parseInt(t.googFrameHeightInput),U.frameHeightSent=parseInt(t.googFrameHeightSent),void 0!==t.hugeFramesSent&&(U.hugeFramesSent=parseInt(t.hugeFramesSent)),U.qpSum=parseInt(t.qpSum),U.qualityLimitationReason=function(e){return e.googBandwidthLimitedResolution?1:e.googCpuLimitedResolution?2:e.googHasEnteredLowResolution?3:0}(t),U.qualityLimitationResolutionChanges=parseInt(t.googAdaptationChanges),U.rtt=parseInt(t.googRtt),U.streamType=V,"high"===V&&(null===(_=this.formativeStatsReport)||void 0===_||_.formatSendData(U,B));const i={LayerType:1,CodecName:t.googCodecName||"h264",CodecImplementationName:t.codecImplementationName||"",CaptureFrameRate:U.frameRateInput||0,CaptureResolutionHeight:U.frameHeightInput||0,CaptureResolutionWidth:U.frameWidthInput||0,EncodeDelay:U.avgEncodeMs||0,MuteState:(null===(T=null===(b=null===(R=this.adapterRef.localStream)||void 0===R?void 0:R.muteStatus)||void 0===b?void 0:b.video)||void 0===T?void 0:T.send)||!1,SendBitrate:U.bitsSentPerSecond||0,SendFrameRate:U.frameRateSent||0,SendResolutionHeight:U.frameHeightSent||0,SendResolutionWidth:U.frameWidthSent||0,TargetSendBitrate:U.bitsSentPerSecond||0,TotalDuration:void 0!==(null===(E=null==this?void 0:this.adapterRef)||void 0===E?void 0:E.state.startPubVideoTime)?(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3:0,TotalFreezeTime:U.totalFreezeTime||0};"video"===B?(o.push(U),(null===(A=e.videoSender)||void 0===A?void 0:A.track)?"high"===V&&(this.adapterRef.localVideoStats[0]=i):this.adapterRef.localVideoStats=[]):"screen"===B&&((null===(w=e.screenSender)||void 0===w?void 0:w.track)?"high"===V&&(i.MuteState=(null===(O=null===(C=null===(I=this.adapterRef.localStream)||void 0===I?void 0:I.muteStatus)||void 0===C?void 0:C.screen)||void 0===O?void 0:O.send)||!1,i.TotalDuration=void 0!==(null===(k=null==this?void 0:this.adapterRef)||void 0===k?void 0:k.state.startPubScreenTime)?(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3:0,i.LayerType=2,this.adapterRef.localScreenStats[0]=i):this.adapterRef.localScreenStats=[],n.push(U));}}else if("recv"===i){if(!c)return {};if(null===(P=this.formativeStatsReport)||void 0===P||P.clearFirstRecvData(c),U.remoteuid=c,"audio"===t.mediaType){U.audioOutputLevel=parseInt(t.audioOutputLevel),U.totalAudioEnergy=parseInt(t.totalAudioEnergy),U.totalSamplesDuration=parseInt(t.totalSamplesDuration),U.bytesReceived=parseInt(t.bytesReceived),U.packetsReceived=parseInt(t.packetsReceived),U.packetsLost=parseInt(t.packetsLost),U.decodingPLC=parseInt(t.googDecodingPLC),U.decodingPLCCNG=parseInt(t.googDecodingPLCCNG),U.decodingNormal=parseInt(t.googDecodingNormal),U.decodingMuted=parseInt(t.googDecodingMuted),U.decodingCNG=parseInt(t.googDecodingCNG),U.decodingCTN=parseInt(t.googDecodingCTN),U.currentDelayMs=parseInt(t.googCurrentDelayMs),U.preferredJitterBufferMs=parseInt(t.googPreferredJitterBufferMs),U.jitterBufferMs=parseInt(t.googJitterBufferMs),U.jitter=parseInt(t.googJitterReceived),U.preemptiveExpandRate=parseInt(t.googPreemptiveExpandRate),U.speechExpandRate=parseInt(t.googSpeechExpandRate),U.secondaryDecodedRate=parseInt(t.googSecondaryDecodedRate),U.secondaryDiscardedRate=parseInt(t.googSecondaryDiscardedRate),null===(x=this.formativeStatsReport)||void 0===x||x.formatRecvData(U,B);const e=null===(M=null==this?void 0:this.adapterRef)||void 0===M?void 0:M.remoteStreamMap[t.remoteuid],i=e&&(e.muteStatus.audioSlave.send||e.muteStatus.audioSlave.recv)||!1,r={CodecType:"Opus",End2EndDelay:(parseInt(t.googCurrentDelayMs)||0)+(parseInt(t.googJitterBufferMs)||0),MuteState:i,PacketLossRate:U.packetsLostRate||0,RecvBitrate:U.bitsReceivedPerSecond||0,RecvLevel:U.audioOutputLevel||0,TotalFreezeTime:U.totalFreezeTime||0,TotalPlayDuration:parseInt(t.totalSamplesDuration)||0,TransportDelay:parseInt(t.googCurrentDelayMs)||0};"audio"===B?(U.remoteuid&&(this.adapterRef.remoteAudioStats[U.remoteuid]=r),s.push(U)):"audioSlave"===B&&(U.remoteuid&&(this.adapterRef.remoteAudioSlaveStats[U.remoteuid]=r),a.push(U));}else if("video"===t.mediaType){U.bytesReceived=parseInt(t.bytesReceived),U.bitsReceivedPerSecond=0,U.packetsReceived=parseInt(t.packetsReceived),U.packetsLost=parseInt(t.packetsLost),U.firCount=parseInt(t.googFirsSent),U.pliCount=parseInt(t.googPlisSent),U.nackCount=parseInt(t.googNacksSent),U.framesDecoded=parseInt(t.framesDecoded),U.decodeMs=parseInt(t.googDecodeMs),U.frameRateDecoded=parseInt(t.googFrameRateDecoded),U.frameRateOutput=parseInt(t.googFrameRateOutput),U.frameRateReceived=parseInt(t.googFrameRateReceived),U.frameWidthReceived=parseInt(t.googFrameWidthReceived),U.frameHeightReceived=parseInt(t.googFrameHeightReceived),U.currentDelayMs=parseInt(t.googCurrentDelayMs),void 0!==t.googJitterBufferMs&&(U.jitterBufferDelay=parseInt(t.googJitterBufferMs)),null===(D=this.formativeStatsReport)||void 0===D||D.formatRecvData(U,B);const e=null===(N=null==this?void 0:this.adapterRef)||void 0===N?void 0:N.remoteStreamMap[U.remoteuid];let i=e&&e.Play&&(null===(L=null==e?void 0:e.Play)||void 0===L?void 0:L.video.dom),r=e&&(e.muteStatus.video.send||e.muteStatus.video.recv)||!1;"screen"===B&&(i=e&&e.Play&&(null===(F=null==e?void 0:e.Play)||void 0===F?void 0:F.screen.dom),r=e&&(e.muteStatus.screen.send||e.muteStatus.screen.recv)||!1);const s={LayerType:1,CodecName:t.googCodecName,End2EndDelay:(parseInt(t.googCurrentDelayMs)||0)+(parseInt(t.googJitterBufferMs)||0)+(parseInt(t.googRenderDelayMs)||0),MuteState:r,PacketLossRate:U.packetsLostRate||0,RecvBitrate:U.bitsReceivedPerSecond||0,RecvResolutionHeight:U.frameHeightReceived||0,RecvResolutionWidth:U.frameWidthReceived||0,RenderFrameRate:U.frameRateOutput||0,RenderResolutionHeight:i?i.videoHeight:0,RenderResolutionWidth:i?i.videoWidth:0,TotalFreezeTime:t.totalFreezeTime||0,TotalPlayDuration:i&&i.played&&i.played.length?i.played.end(0):0,TransportDelay:parseInt(t.googCurrentDelayMs)||0};"video"===B?(this.adapterRef.remoteVideoStats[U.remoteuid]=s,o.push(U)):"screen"===B&&(s.LayerType=2,this.adapterRef.remoteScreenStats[U.remoteuid]=s,n.push(U));}}}});const c={};if(s.length&&(c.audio_ssrc=s),a.length&&(c.audioSlave_ssrc=a),o.length){if(o.length>1){"low"===(o[0]||{}).streamType&&([o[0],o[1]]=[o[1],o[0]]);}c.video_ssrc=o;}if(n.length){if(n.length>1){"low"===(n[0]||{}).streamType&&([n[0],n[1]]=[n[1],n[0]]);}c.screen_ssrc=n;}return d.length&&(c.bwe=d),c}formatChromeStandardizedStats(e,t){var i,r;const s={},a={};let o=0;e.forEach(e=>{var i;"media-source"==e.type?"audio"===e.kind?(s.audioInputLevel=Math.round(32768*e.audioLevel),s.totalAudioEnergy=Math.round(e.totalAudioEnergy),s.totalSamplesDuration=Math.round(e.totalSamplesDuration),void 0!==e.echoReturnLoss&&(s.echoReturnLoss=e.echoReturnLoss.toString()),void 0!==e.echoReturnLossEnhancement&&(s.echoReturnLossEnhancement=e.echoReturnLossEnhancement.toString())):"video"===e.kind&&(a.frameRateInput=e.framesPerSecond,a.frameWidthInput=e.width,a.frameHeightInput=e.height):"outbound-rtp"==e.type?(o=e.ssrc,"audio"===e.kind?(void 0!==e.targetBitrate&&(s.targetBitrate=Math.round(e.targetBitrate/1e3)),s.bytesSent=e.headerBytesSent+e.bytesSent,s.packetsSent=e.packetsSent,void 0!==e.nackCount&&(s.nackCount=e.nackCount),s.active=e.active?1:0):"video"===e.kind&&(a.active=e.active?1:0,a.bytesSent=e.headerBytesSent+e.bytesSent,a.firCount=e.firCount,a.nackCount=e.nackCount,a.pliCount=e.pliCount,void 0!==e.framesEncoded&&(a.framesEncoded=e.framesEncoded),void 0!==e.framesSent&&(a.framesSent=e.framesSent),void 0!==e.hugeFramesSent&&(a.hugeFramesSent=e.hugeFramesSent),a.packetsSent=e.packetsSent,a.qpSum=e.qpSum,a.qualityLimitationReason="bandwidth"===(i=e.qualityLimitationReason)?1:"cpu"===i?2:"other"===i?3:0,a.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges,void 0!==e.targetBitrate&&(a.targetBitrate=Math.round(e.targetBitrate/1e3)),void 0!==e.framesPerSecond&&(a.frameRateSent=e.framesPerSecond),void 0!==e.frameWidth&&(a.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(a.frameHeightSent=e.frameHeight))):"remote-inbound-rtp"==e.type?"audio"===e.kind?(void 0!==e.fractionLost&&(s.fractionLost=e.fractionLost),s.jitterReceived=Math.round(1e3*e.jitter),s.packetsLost=e.packetsLost,s.rtt=Math.round(1e3*e.roundTripTime)):"video"===e.kind&&(void 0!==e.fractionLost&&(a.fractionLost=e.fractionLost),a.jitter=Math.round(1e3*e.jitter),a.packetsLost=e.packetsLost,a.rtt=Math.round(1e3*e.roundTripTime)):"inbound-rtp"==e.type?(o=e.ssrc,"audio"===e.kind?(void 0!==e.audioLevel&&(s.audioOutputLevel=Math.round(32768*e.audioLevel)),void 0!==e.totalAudioEnergy&&(s.totalAudioEnergy=Math.round(e.totalAudioEnergy)),void 0!==e.totalSamplesReceived&&(s.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3)),s.bytesReceived=e.headerBytesReceived+e.bytesReceived,void 0!==e.concealedSamples&&(s.concealedSamples=e.concealedSamples),s.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp||0,s.jitter=Math.round(1e3*e.jitter),void 0!==e.jitterBufferDelay&&(s.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)),s.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp,void 0!==e.nackCount&&(s.nackCount=e.nackCount),void 0!==e.silentConcealedSamples&&(s.silentConcealedSamples=e.silentConcealedSamples),s.packetsLost=e.packetsLost,s.packetsReceived=e.packetsReceived):"video"===e.kind&&(a.bytesReceived=e.bytesReceived+e.headerBytesReceived,a.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp||0,a.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp||0,a.firCount=e.firCount,a.nackCount=e.nackCount,a.pliCount=e.pliCount,a.framesDecoded=e.framesDecoded,void 0!==e.framesDropped&&(a.framesDropped=e.framesDropped),void 0!==e.framesReceived&&(a.framesReceived=e.framesReceived),a.packetsReceived=e.packetsReceived,a.packetsLost=e.packetsLost,void 0!==e.pauseCount&&(a.pauseCount=e.pauseCount),void 0!==e.totalPausesDuration&&(a.totalPausesDuration=e.totalPausesDuration),void 0!==e.freezeCount&&(a.freezeCount=e.freezeCount),void 0!==e.totalFreezesDuration&&(a.totalFreezesDuration=e.totalFreezesDuration),void 0!==e.framesPerSecond&&(a.frameRateReceived=e.framesPerSecond),void 0!==e.frameWidth&&(a.frameWidthReceived=e.frameWidth),void 0!==e.frameHeight&&(a.frameHeightReceived=e.frameHeight),a.powerEfficientDecoder=e.powerEfficientDecoder?1:0,void 0!==e.jitterBufferDelay&&(a.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)))):"remote-outbound-rtp"==e.type?"audio"===e.kind?(void 0!==e.jitter&&(s.jitter=Math.round(1e3*e.jitter)),void 0!==e.roundTripTime&&(s.rtt=Math.round(1e3*e.roundTripTime))):e.kind:"track"==e.type&&"recv"===t&&"audio"===e.kind&&void 0!==e.audioLevel&&(s.audioOutputLevel=Math.round(32768*e.audioLevel));});const n=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i.instance.getUidAndKindBySsrc(o);let d=null==n?void 0:n.kind;"{}"!==JSON.stringify(a)&&"send"===t&&(a.streamType=(null==n?void 0:n.streamType)||"high");const c={};if("recv"===t)if("{}"!==JSON.stringify(a))a.remoteuid=null==n?void 0:n.uid;else if("{}"!==JSON.stringify(s)&&(s.remoteuid=null==n?void 0:n.uid,s.audioOutputLevel)){const e=null===(r=null==this?void 0:this.adapterRef)||void 0===r?void 0:r.remoteStreamMap[s.remoteuid],t=d&&(null==e?void 0:e.isPlaying(d))||!1;this.audioLevel.push({uid:s.remoteuid,level:t&&+s.audioOutputLevel||0,type:d});}return (null==d?void 0:d.includes("audio"))?c[d+"_ssrc"]=[s]:"video"!==d&&"screen"!==d||(c[d+"_ssrc"]=[a]),c}async safari(e,t){var i,r;if(!e.getTransceivers)return {};let s={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const a=e.getTransceivers();for(let e=0;e<a.length;e++){let o=null;const n=a[e];if("sendonly"===n.direction){if(n.sender&&n.sender.getStats)if(o=await n.sender.getStats(),o=this.formatSafariStandardizedStats(o,t,(null===(i=n.sender.track)||void 0===i?void 0:i.kind)||""),o.video_ssrc&&s.video_ssrc){if(s.video_ssrc.push(o.video_ssrc[0]),s.video_ssrc.length>1){"low"===(s.video_ssrc[0]||{}).streamType&&([s.video_ssrc[0],s.video_ssrc[1]]=[s.video_ssrc[1],s.video_ssrc[0]]);}}else if(o.screen_ssrc&&s.screen_ssrc){if(s.screen_ssrc.push(o.screen_ssrc[0]),s.screen_ssrc.length>1){"low"===(s.screen_ssrc[0]||{}).streamType&&([s.screen_ssrc[0],s.screen_ssrc[1]]=[s.screen_ssrc[1],s.screen_ssrc[0]]);}}else Object.assign(s,o);}else "recvonly"===n.direction&&n.receiver&&n.receiver.getStats&&(o=await n.receiver.getStats(),o=this.formatSafariStandardizedStats(o,t,(null===(r=n.receiver.track)||void 0===r?void 0:r.kind)||""),o.audio_ssrc&&s.audio_ssrc?s.audio_ssrc.push(o.audio_ssrc[0]):o.audioSlave_ssrc&&s.audioSlave_ssrc?s.audioSlave_ssrc.push(o.audioSlave_ssrc[0]):o.video_ssrc&&s.video_ssrc?s.video_ssrc.push(o.video_ssrc[0]):o.screen_ssrc&&s.screen_ssrc?s.screen_ssrc.push(o.screen_ssrc[0]):Object.assign(s,o));}return s}formatSafariStandardizedStats(e,t,i){var r,s,a,o,n,d,c;const l={},u={};let h=0;e.forEach(e=>{"track"==e.type?"audio"===e.kind||"audio"===i?(l.active=e.ended?0:1,void 0!==e.audioLevel&&(l.audioOutputLevel=Math.round(32768*e.audioLevel))):"video"!==e.kind&&"video"!==i||(u.active=e.ended?0:1,"send"===t?(u.frameWidthInput=e.width||e.frameWidth,u.frameHeightInput=e.height||e.frameHeight,void 0!==e.framesSent&&(u.framesSent=e.framesSent)):"recv"===t&&(u.frameWidthReceived=e.width||e.frameWidth,u.frameHeightReceived=e.height||e.frameHeight,void 0!==e.framesDecoded&&(u.framesDecoded=e.framesDecoded),void 0!==e.framesReceived&&(u.framesReceived=e.framesReceived),void 0!==e.framesDropped&&(u.framesDropped=e.framesDropped))):"outbound-rtp"==e.type?(h=e.ssrc,"audio"===e.kind||"audio"===e.mediaType||"audio"===i?(l.bytesSent=(e.headerBytesSent||0)+e.bytesSent,l.packetsSent=e.packetsSent,void 0!==e.nackCount&&(l.nackCount=e.nackCount)):"video"!==e.kind&&"video"!==e.mediaType&&"video"!==i||(u.bytesSent=(e.headerBytesSent||0)+e.bytesSent,u.firCount=e.firCount,u.nackCount=e.nackCount,u.pliCount=e.pliCount,u.framesEncoded=e.framesEncoded,void 0!==e.hugeFramesSent&&(u.hugeFramesSent=e.hugeFramesSent),u.packetsSent=e.packetsSent,u.qpSum=e.qpSum,void 0!==e.qualityLimitationResolutionChanges&&(u.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges),void 0!==e.totalEncodeTime&&(u.avgEncodeMs=Math.round(1e3*e.totalEncodeTime/e.framesEncoded)),void 0!==e.framesPerSecond&&(u.frameRateSent=e.framesPerSecond),void 0!==e.frameWidth&&(u.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(u.frameHeightSent=e.frameHeight))):"remote-inbound-rtp"==e.type?"audio"===e.kind?(void 0!==e.jitter&&(l.jitterReceived=Math.round(1e3*e.jitter)),void 0!==e.packetsLost&&(l.packetsLost=e.packetsLost),l.rtt=Math.round(1e3*e.roundTripTime)):"video"===e.kind&&(void 0!==e.jitter&&(u.jitter=Math.round(1e3*e.jitter)),void 0!==e.packetsLost&&(u.packetsLost=e.packetsLost),u.rtt=Math.round(1e3*e.roundTripTime)):"inbound-rtp"==e.type?(h=e.ssrc,"audio"===e.kind||"audio"===e.mediaType||"audio"===i?(void 0!==e.audioLevel&&(l.audioOutputLevel=Math.round(32768*e.audioLevel)),void 0!==e.totalAudioEnergy&&(l.totalAudioEnergy=Math.round(e.totalAudioEnergy)),void 0!==e.totalSamplesReceived&&(l.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3)),l.bytesReceived=(e.headerBytesReceived||0)+e.bytesReceived,void 0!==e.concealedSamples&&(l.concealedSamples=e.concealedSamples),void 0!==e.estimatedPlayoutTimestamp&&(l.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.jitter&&(l.jitter=Math.round(1e3*e.jitter)),void 0!==e.jitterBufferDelay&&(l.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)),void 0!==e.lastPacketReceivedTimestamp&&(l.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp),void 0!==e.nackCount&&(l.nackCount=e.nackCount),void 0!==e.silentConcealedSamples&&(l.silentConcealedSamples=e.silentConcealedSamples),l.packetsLost=e.packetsLost,l.packetsReceived=e.packetsReceived,void 0!==e.jitter&&(l.jitter=Math.round(1e3*e.jitter))):"video"!==e.kind&&"video"!==e.mediaType&&"video"!==i||(u.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),void 0!==e.estimatedPlayoutTimestamp&&(u.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.lastPacketReceivedTimestamp&&(u.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp),u.firCount=e.firCount,u.nackCount=e.nackCount,u.pliCount=e.pliCount,void 0!==e.framesDecoded&&(u.framesDecoded=e.framesDecoded),void 0!==e.framesDropped&&(u.framesDropped=e.framesDropped),void 0!==e.framesReceived&&(u.framesReceived=e.framesReceived),u.packetsReceived=e.packetsReceived,u.packetsLost=e.packetsLost,void 0!==e.framesPerSecond&&(u.frameRateReceived=e.framesPerSecond),void 0!==e.frameWidth&&(u.frameWidthReceived=e.frameWidth),void 0!==e.frameHeight&&(u.frameHeightReceived=e.frameHeight),void 0!==e.jitter&&(u.jitter=Math.round(1e3*e.jitter)),void 0!==e.jitterBufferDelay&&(u.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)))):"remote-outbound-rtp"==e.type&&("audio"===e.kind?(void 0!==e.jitter&&(l.jitter=Math.round(1e3*e.jitter)),void 0!==e.roundTripTime&&(l.rtt=Math.round(1e3*e.roundTripTime))):e.kind);});const p=null===(r=null==this?void 0:this.adapterRef)||void 0===r?void 0:r.instance.getUidAndKindBySsrc(h);let m=null==p?void 0:p.kind;"{}"!==JSON.stringify(u)&&"send"===t&&(u.streamType=(null==p?void 0:p.streamType)||"high");const f={};if("recv"===t)if(null===(s=this.formativeStatsReport)||void 0===s||s.clearFirstRecvData(null==p?void 0:p.uid),"{}"!==JSON.stringify(u))u.remoteuid=null==p?void 0:p.uid,null===(a=this.formativeStatsReport)||void 0===a||a.formatRecvData(u,m);else if("{}"!==JSON.stringify(l)&&(l.remoteuid=null==p?void 0:p.uid,null===(o=this.formativeStatsReport)||void 0===o||o.formatRecvData(l,m),l.audioOutputLevel)){const e=null===(n=null==this?void 0:this.adapterRef)||void 0===n?void 0:n.remoteStreamMap[l.remoteuid],t=m&&(null==e?void 0:e.isPlaying(m))||!1;this.audioLevel.push({uid:l.remoteuid,level:t&&+l.audioOutputLevel||0,type:m});}return (null==m?void 0:m.includes("audio"))?("send"===t&&(null===(d=this.formativeStatsReport)||void 0===d||d.formatSendData(l,m)),"number"==typeof l.active&&(f[m+"_ssrc"]=[l])):"video"!==m&&"screen"!==m||("high"===(null==p?void 0:p.streamType)&&"send"===t&&(null===(c=this.formativeStatsReport)||void 0===c||c.formatSendData(u,m)),"number"==typeof u.active&&(f[m+"_ssrc"]=[u])),f}async firefox(e,t){if(!e.getTransceivers)return {};let i={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?a.sender&&a.sender.getStats&&(s=await a.sender.getStats(),s=this.formatFirefoxStandardizedStats(s,t),Object.assign(i,s)):"recvonly"===a.direction&&a.receiver&&a.receiver.getStats&&(s=await a.receiver.getStats(),s=this.formatFirefoxStandardizedStats(s,t),s.audio_ssrc&&i.audio_ssrc?i.audio_ssrc.push(s.audio_ssrc[0]):s.audioSlave_ssrc&&i.audioSlave_ssrc?i.audioSlave_ssrc.push(s.audioSlave_ssrc[0]):s.video_ssrc&&i.video_ssrc?i.video_ssrc.push(s.video_ssrc[0]):s.screen_ssrc&&i.screen_ssrc?i.screen_ssrc.push(s.screen_ssrc[0]):Object.assign(i,s));}return i}formatFirefoxStandardizedStats(e,t){var i,r,s,a,o,n,d;const c={},l={};let u=0;e.forEach(e=>{"outbound-rtp"==e.type?(u=e.ssrc,"audio"===e.kind?(c.bytesSent=(e.headerBytesSent||0)+e.bytesSent,c.packetsSent=e.packetsSent,c.nackCount=e.nackCount):"video"===e.kind&&(l.bytesSent=(e.headerBytesSent||0)+e.bytesSent,l.firCount=e.firCount,l.nackCount=e.nackCount,l.pliCount=e.pliCount,void 0!==e.hugeFramesSent&&(l.hugeFramesSent=e.hugeFramesSent),l.packetsSent=e.packetsSent,l.qpSum=e.qpSum,void 0!==e.framesEncoded&&(l.framesEncoded=e.framesEncoded),void 0!==e.framesSent&&(l.framesSent=e.framesSent),void 0!==e.totalEncodeTime&&void 0!==e.framesEncoded&&(l.avgEncodeMs=Math.round(1e3*e.totalEncodeTime/e.framesEncoded)),void 0!==e.framesPerSecond&&(l.frameRateSent=e.framesPerSecond),void 0!==e.frameWidth&&(l.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(l.frameHeightSent=e.frameHeight))):"remote-inbound-rtp"==e.type?"video"===e.kind&&(l.fractionLost=e.fractionLost,l.jitter=Math.round(1e3*e.jitter),l.packetsLost=e.packetsLost,l.rtt=Math.round(1e3*e.roundTripTime)):"inbound-rtp"==e.type&&(u=e.ssrc,"audio"===e.kind?(void 0!==e.audioLevel&&(c.audioOutputLevel=Math.round(32768*e.audioLevel)),void 0!==e.insertedSamplesForDeceleration&&(c.preemptiveExpandRate=parseInt(e.insertedSamplesForDeceleration)),void 0!==e.removedSamplesForAcceleration&&(c.speechExpandRate=parseInt(e.removedSamplesForAcceleration)),c.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),c.concealedSamples=e.concealedSamples,c.jitter=Math.round(1e3*e.jitter),c.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount),c.silentConcealedSamples=e.silentConcealedSamples,c.packetsLost=e.packetsLost,c.packetsReceived=e.packetsReceived,void 0!==e.totalSamplesReceived&&(c.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3)),void 0!==e.totalAudioEnergy&&(c.totalAudioEnergy=Math.round(e.totalAudioEnergy)),void 0!==e.totalSamplesReceived&&(c.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3))):"video"===e.kind&&(l.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),l.firCount=e.firCount,l.nackCount=e.nackCount,l.pliCount=e.pliCount,l.framesDecoded=e.framesDecoded,l.framesDropped=e.framesReceived-e.framesDecoded,l.framesReceived=e.framesReceived,l.packetsReceived=e.packetsReceived,l.packetsLost=e.packetsLost,l.frameRateReceived=e.framesPerSecond||0,l.frameWidthReceived=e.frameWidth,l.frameHeightReceived=e.frameHeight,l.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount),void 0!==e.estimatedPlayoutTimestamp&&(l.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.lastPacketReceivedTimestamp&&(l.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp)));});const h=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i.instance.getUidAndKindBySsrc(u);let p=null==h?void 0:h.kind;"{}"!==JSON.stringify(l)&&"send"===t&&(l.streamType=(null==h?void 0:h.streamType)||"high");const m={};if("recv"===t)if(null===(r=this.formativeStatsReport)||void 0===r||r.clearFirstRecvData(null==h?void 0:h.uid),"{}"!==JSON.stringify(l))l.remoteuid=null==h?void 0:h.uid,null===(s=this.formativeStatsReport)||void 0===s||s.formatRecvData(l,p);else if("{}"!==JSON.stringify(c)&&(c.remoteuid=null==h?void 0:h.uid,null===(a=this.formativeStatsReport)||void 0===a||a.formatRecvData(c,p),c.audioOutputLevel)){const e=null===(o=null==this?void 0:this.adapterRef)||void 0===o?void 0:o.remoteStreamMap[c.remoteuid],t=p&&(null==e?void 0:e.isPlaying(p))||!1;this.audioLevel.push({uid:c.remoteuid,level:t&&+c.audioOutputLevel||0,type:p});}return (null==p?void 0:p.includes("audio"))?("send"===t&&(null===(n=this.formativeStatsReport)||void 0===n||n.formatSendData(c,p)),m[p+"_ssrc"]=[c]):"video"!==p&&"screen"!==p||("high"===(null==h?void 0:h.streamType)&&"send"===t&&(null===(d=this.formativeStatsReport)||void 0===d||d.formatSendData(l,p)),m[p+"_ssrc"]=[l]),m}stop(){this._reset();}destroy(){this._reset();}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.FormativeStatsReport=void 0;t.FormativeStatsReport=class{constructor(e){this.adapterRef=e.adapterRef,this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{}};}_reset(){this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{}};}clearFirstRecvData(e){const t=this.adapterRef.remoteStreamMap[e],i=this.firstData.recvFirstData[e];t&&i&&(""===t.pubStatus.audio.consumerId&&(i.recvFirstAudioFrame=i.recvFirstAudioPackage=!1,this.statsCatch.downAudioCache[e]=null),""===t.pubStatus.audioSlave.consumerId&&(this.statsCatch.downAudioSlaveCache[e]=null),""===t.pubStatus.video.consumerId&&(i.recvFirstVideoFrame=i.recvFirstVideoPackage=!1,this.statsCatch.downVideoCache[e]=null),""===t.pubStatus.screen.consumerId&&(i.recvFirstScreenFrame=i.recvFirstScreenPackage=!1,this.statsCatch.downScreenCache[e]=null));}formatTransportData(e,t){let i;"send"===t?(this.adapterRef.transportStats.rxRtt=e.googRtt-0,this.adapterRef.transportStats.txRtt=e.googRtt-0,this.adapterRef.sessionStats.SendBytes=e.bytesSent-0,this.statsCatch.upTransportCache&&(i=this.statsCatch.upTransportCache),this.statsCatch.upTransportCache=e,i&&(this.adapterRef.sessionStats.SendBitrate=Math.round(8*(e.bytesSent-i.bytesSent)/1e3))):(this.adapterRef.sessionStats.RecvBytes=e.bytesReceived-0,this.statsCatch.downTransportCache&&(i=this.statsCatch.downTransportCache),this.statsCatch.downTransportCache=e,i&&(this.adapterRef.sessionStats.RecvBitrate=Math.round(8*(e.bytesReceived-i.bytesReceived)/1e3)));}formatSendData(e,t){var i,r,s,a,o,n,d,c;let l;if("audio"===t){if(!(null===(r=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._micProducer))return this.firstData.sendFirstAudioPackage=!1,void(this.statsCatch.upAudioCache={});e.packetsSent>0&&!this.firstData.sendFirstAudioPackage&&(this.firstData.sendFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:0})),this.statsCatch.upAudioCache&&(l=this.statsCatch.upAudioCache),this.statsCatch.upAudioCache=e;}else if("audioSlave"===t){if(!(null===(a=null===(s=null==this?void 0:this.adapterRef)||void 0===s?void 0:s._mediasoup)||void 0===a?void 0:a._audioSlaveProducer))return void(this.statsCatch.upAudioSlaveCache={});this.statsCatch.upAudioSlaveCache&&(l=this.statsCatch.upAudioSlaveCache),this.statsCatch.upAudioSlaveCache=e,this.dispatchExceptionEventSendAudio(l,e);}else if("video"===t){if(!(null===(n=null===(o=null==this?void 0:this.adapterRef)||void 0===o?void 0:o._mediasoup)||void 0===n?void 0:n._webcamProducer))return this.firstData.sendFirstVideoPackage=!1,void(this.statsCatch.upVideoCache={});e.packetsSent>0&&!this.firstData.sendFirstVideoPackage&&(this.firstData.sendFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:1})),this.statsCatch.upVideoCache&&(l=this.statsCatch.upVideoCache),this.statsCatch.upVideoCache=e,this.dispatchExceptionEventSendVideo(l,e);}else if("screen"===t){if(!(null===(c=null===(d=null==this?void 0:this.adapterRef)||void 0===d?void 0:d._mediasoup)||void 0===c?void 0:c._screenProducer))return this.firstData.sendFirstScreenPackage=!1,void(this.statsCatch.upScreenCache={});e.packetsSent>0&&!this.firstData.sendFirstScreenPackage&&(this.firstData.sendFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:2})),this.statsCatch.upScreenCache&&(l=this.statsCatch.upScreenCache),this.statsCatch.upScreenCache=e;}if(e.bitsSentPerSecond=Math.round(8*(e.bytesSent-(l.bytesSent||0))/1e3),e.packetsSentPerSecond=e.packetsSent-(l.packetsSent||0),void 0!==e.packetsLost&&(e.packetsLostRate=this.getPacketLossRate(l,e,!0)),e.streamType){e.framesEncoded>=l.framesEncoded?e.framesEncodedPerSecond=e.framesEncoded-l.framesEncoded:e.framesEncodedPerSecond=0,e.qpPercentage=this.getQpPercentage(l,e),e.frameRateSent||(e.frameRateSent=e.framesSent-l.framesSent);let i={freezeTime:0,totalFreezeTime:0};"video"===t?i=this.getLocalVideoFreezeStats(e):"screen"===t&&(i=this.getLocalScreenFreezeStats(e)),e.freezeTime=i.freezeTime,e.totalFreezeTime=i.totalFreezeTime;}}formatRecvData(e,t){let i;const r=e.remoteuid||0;if(this.clearFirstRecvData(r),this.firstData.recvFirstData[r]||(this.firstData.recvFirstData[r]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1}),"audio"===t?(!this.firstData.recvFirstData[r].recvFirstAudioPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:0,pull_uid:r})),e.decodingNormal&&e.decodingNormal>0&&!this.firstData.recvFirstData[r].recvFirstAudioFrame&&(this.firstData.recvFirstData[r].recvFirstAudioFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:0,pull_uid:r})),this.statsCatch.downAudioCache&&(i=this.statsCatch.downAudioCache[r]),this.statsCatch.downAudioCache[r]=e,this.dispatchExceptionEventRecvAudio(i,e,r)):"audioSlave"===t?(this.statsCatch.downAudioSlaveCache&&(i=this.statsCatch.downAudioSlaveCache[r]),this.statsCatch.downAudioSlaveCache[r]=e):"video"===t?(!this.firstData.recvFirstData[r].recvFirstVideoPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:1,pull_uid:r})),!this.firstData.recvFirstData[r].recvFirstVideoFrame&&e.framesDecoded>0&&(this.firstData.recvFirstData[r].recvFirstVideoFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:1,pull_uid:r})),this.statsCatch.downVideoCache&&(i=this.statsCatch.downVideoCache[r]),this.statsCatch.downVideoCache[r]=e,this.dispatchExceptionEventRecvVideo(i,e,r)):"screen"===t&&(!this.firstData.recvFirstData[r].recvFirstScreenPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:2,pull_uid:r})),!this.firstData.recvFirstData[r].recvFirstScreenFrame&&e.framesDecoded>0&&(this.firstData.recvFirstData[r].recvFirstScreenFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:2,pull_uid:r})),this.statsCatch.downScreenCache&&(i=this.statsCatch.downScreenCache[r]),this.statsCatch.downScreenCache[r]=e,this.dispatchExceptionEventRecvScreen(i,e,r)),!i||e.bytesReceived<i.bytesReceived)return;let s={freezeTime:0,totalFreezeTime:0};e.bitsReceivedPerSecond=Math.round(8*(e.bytesReceived-i.bytesReceived)/1e3),e.packetsReceivedPerSecond=e.packetsReceived-i.packetsReceived,void 0!==e.packetsLost&&(e.packetsLostRate=this.getPacketLossRate(i,e)),"video"===t||"screen"===t?(e.frameRateReceived||(e.frameRateReceived=e.framesReceived-i.framesReceived),e.frameRateDecoded||(e.frameRateDecoded=e.framesDecoded-i.framesDecoded),"video"===t?s=this.getRemoteVideoFreezeStats(i,e,r):"screen"===t&&(s=this.getRemoteScreenFreezeStats(i,e,r))):e.decodingCTN&&(s=this.getRemoteAudioFreezeStats(i,e,r)),e.freezeTime=s.freezeTime,e.totalFreezeTime=s.totalFreezeTime;}getQpPercentage(e,t){if(!(e&&e.framesEncoded&&e.qpSum&&t&&t.framesEncoded&&t.qpSum))return 0;const i=t.qpSum-e.qpSum,r=t.framesEncoded-e.framesEncoded;return i<=0||r<=0?0:i>r?100:Math.round(i/r*100)}getPacketLossRate(e,t,i=!1){if(!e||!t)return 0;const r=parseInt(e.packetsLost)||0,s=parseInt(t.packetsLost)||0;if(s<=r)return 0;const a=i?e.packetsSent:e.packetsReceived,o=i?t.packetsSent:t.packetsReceived,n=parseInt(a||"")||0,d=parseInt(o||"")||0;if(d<=n)return 0;return i?Math.round((s-r)/(d-n)*100):Math.round((s-r)/(s-r+(d-n))*100)}getLocalVideoFreezeStats(e){let t=0;if(!e||!e.frameRateSent)return {totalFreezeTime:t,freezeTime:0};let i=0,r=parseInt(e.frameRateSent);if(r<=0)return {totalFreezeTime:2e3,freezeTime:6};if(r>15)return {totalFreezeTime:0,freezeTime:0};i=Math.abs(15-r),t=parseInt(2e3*i);let s=0;t<300?(t=0,s=0):s=t>1500?6:parseInt(t/300);return {totalFreezeTime:t,freezeTime:s}}getLocalScreenFreezeStats(e){let t=0;if(!e||!e.frameRateSent)return {totalFreezeTime:t,freezeTime:0};let i=parseInt(e.framesEncoded)||0,r=parseInt(e.framesSent)||0;if(i<=0||r<=0)return {totalFreezeTime:2e3,freezeTime:6};let s=Math.abs(i-r);t=parseInt(2e3*(s/i));let a=0;t<300?(t=0,a=0):a=t>1500?6:parseInt(t/300);return {totalFreezeTime:t,freezeTime:a}}getRemoteAudioFreezeStats(e,t,i){if(!e||!t)return {totalFreezeTime:0,freezeTime:0};let r=parseInt(e.decodingPLC)+parseInt(e.decodingCNG)+parseInt(e.decodingPLCCNG),s=parseInt(e.decodingCTN),a=parseInt(e.decodingPLC)+parseInt(e.decodingCNG)+parseInt(e.decodingPLCCNG),o=parseInt(t.decodingCTN);if(o<=r)return {totalFreezeTime:0,freezeTime:0};let n=(a-r)/(o-s);return {totalFreezeTime:parseInt(1e3*n),freezeTime:10*n>1?parseInt(10*n):n>0?1:0}}getRemoteVideoFreezeStats(e,t,i){let r=0;if(!t||0==t.framesDecoded)return {totalFreezeTime:r,freezeTime:0};if(t&&t.framesDecoded&&0==t.frameRateDecoded)return {totalFreezeTime:2e3,freezeTime:6};let s=parseInt(t.frameRateReceived)||0,a=parseInt(t.frameRateDecoded);if(s<=0||a<=0)return {totalFreezeTime:2e3,freezeTime:6};let o=0;if(s>15)return {totalFreezeTime:0,freezeTime:0};o=Math.abs(15-s),r=parseInt(2e3*(o/15)),r>2e3&&(r=2e3);let n=0;r<300?(r=0,n=0):n=r>1500?6:parseInt(r/300);return {totalFreezeTime:r,freezeTime:n}}getRemoteScreenFreezeStats(e,t,i){let r=0;if(!t)return {totalFreezeTime:r,freezeTime:0};let s=parseInt(t.frameRateReceived),a=parseInt(t.frameRateDecoded);if(s<=0||a<=0)return {totalFreezeTime:2e3,freezeTime:6};let o=Math.abs(a-s);r=parseInt(2e3*(o/s))||0;let n=0;r<300?(r=0,n=0):n=r>1500?6:parseInt(r/300);return {totalFreezeTime:r,freezeTime:n}}dispatchExceptionEventSendAudio(e,t){var i,r,s,a;if(!e||!t)return;const o=null===(i=this.adapterRef.localStream)||void 0===i?void 0:i.muteStatus.audio.send,n=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.pubStatus.audio.audio;if(!0===o||!1===n)return;0===t.audioInputLevel&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_INPUT_LEVEL_TOO_LOW",code:2001,uid:(null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid)||0}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"SEND_AUDIO_BITRATE_TOO_LOW",code:2003,uid:(null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid)||0});}dispatchExceptionEventSendVideo(e,t){var i,r,s,a;if(!e||!t)return;const o=null===(i=this.adapterRef.localStream)||void 0===i?void 0:i.muteStatus.video.send,n=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.pubStatus.video.video;if(!0===o||!1===n)return;t.frameRateInput&&parseInt(t.frameRateInput)>5&&parseInt(t.frameRateSent)<=1&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_SENT_TOO_LOW",code:1002,uid:(null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid)||0}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_VIDEO_BITRATE_TOO_LOW",code:1003,uid:(null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid)||0});}dispatchExceptionEventRecvAudio(e,t,i){if(!e||!t||!t.googDecodingNormal)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.audio.send||r.muteStatus.audio.recv);if(r&&s)return;if(!r||!r.Play||!r.Play.audio.dom||!r.Play.audio.dom.srcObject||r.Play.audio.dom.muted)return;let a=parseInt(t.bytesReceived)-parseInt(e.bytesReceived),o=parseInt(t.decodingNormal)-parseInt(e.decodingNormal);if(a>0&&0===o&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_AUDIO_DECODE_FAILED",code:2005,uid:i}),a>0&&o>0&&0==+(t.audioOutputLevel||t.audioLevel)){const e=r&&r.Play&&r.Play.audio.dom&&r.Play.audio.dom.volume;e&&e>0&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_OUTPUT_LEVEL_TOO_LOW",code:2002,uid:i});}}dispatchExceptionEventRecvVideo(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.video.send||r.muteStatus.video.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.frameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_VIDEO_DECODE_FAILED",code:1005,uid:i});}dispatchExceptionEventRecvScreen(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.screen.send||r.muteStatus.screen.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.frameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_SCREEN_DECODE_FAILED",code:1005,uid:i});}destroy(){this._reset();}};},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
    /*
     * [js-sha1]{@link https://github.com/emn178/js-sha1}
     *
     * @version 0.6.0
     * @author Chen, Yi-Cyuan [emn178@gmail.com]
     * @copyright Chen, Yi-Cyuan 2014-2017
     * @license MIT
     */!function(){var root="object"==typeof window?window:{},NODE_JS=!root.JS_SHA1_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS&&(root=global);var COMMON_JS=!root.JS_SHA1_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(269),HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[],createOutputMethod=function(e){return function(t){return new Sha1(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Sha1},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var i=OUTPUT_TYPES[t];e[i]=createOutputMethod(i);}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("sha1").update(e,"utf8").digest("hex");if(e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(void 0===e.length)return method(e);return crypto.createHash("sha1").update(new Buffer(e)).digest("hex")};return nodeMethod};function Sha1(e){e?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0;}Sha1.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===root.ArrayBuffer&&(e=new Uint8Array(e));for(var i,r,s=0,a=e.length||0,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(r=this.start;s<a&&r<64;++s)o[r>>2]|=e[s]<<SHIFT[3&r++];else for(r=this.start;s<a&&r<64;++s)(i=e.charCodeAt(s))<128?o[r>>2]|=i<<SHIFT[3&r++]:i<2048?(o[r>>2]|=(192|i>>6)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]):i<55296||i>=57344?(o[r>>2]|=(224|i>>12)<<SHIFT[3&r++],o[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++s)),o[r>>2]|=(240|i>>18)<<SHIFT[3&r++],o[r>>2]|=(128|i>>12&63)<<SHIFT[3&r++],o[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=o[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r;}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=EXTRA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash();}},Sha1.prototype.hash=function(){var e,t,i=this.h0,r=this.h1,s=this.h2,a=this.h3,o=this.h4,n=this.blocks;for(e=16;e<80;++e)t=n[e-3]^n[e-8]^n[e-14]^n[e-16],n[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r&s|~r&a)+o+1518500249+n[e]<<0)<<5|o>>>27)+(i&(r=r<<30|r>>>2)|~i&s)+a+1518500249+n[e+1]<<0)<<5|a>>>27)+(o&(i=i<<30|i>>>2)|~o&r)+s+1518500249+n[e+2]<<0)<<5|s>>>27)+(a&(o=o<<30|o>>>2)|~a&i)+r+1518500249+n[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|~s&o)+i+1518500249+n[e+4]<<0,s=s<<30|s>>>2;for(;e<40;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r^s^a)+o+1859775393+n[e]<<0)<<5|o>>>27)+(i^(r=r<<30|r>>>2)^s)+a+1859775393+n[e+1]<<0)<<5|a>>>27)+(o^(i=i<<30|i>>>2)^r)+s+1859775393+n[e+2]<<0)<<5|s>>>27)+(a^(o=o<<30|o>>>2)^i)+r+1859775393+n[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^o)+i+1859775393+n[e+4]<<0,s=s<<30|s>>>2;for(;e<60;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r&s|r&a|s&a)+o-1894007588+n[e]<<0)<<5|o>>>27)+(i&(r=r<<30|r>>>2)|i&s|r&s)+a-1894007588+n[e+1]<<0)<<5|a>>>27)+(o&(i=i<<30|i>>>2)|o&r|i&r)+s-1894007588+n[e+2]<<0)<<5|s>>>27)+(a&(o=o<<30|o>>>2)|a&i|o&i)+r-1894007588+n[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|s&o|a&o)+i-1894007588+n[e+4]<<0,s=s<<30|s>>>2;for(;e<80;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r^s^a)+o-899497514+n[e]<<0)<<5|o>>>27)+(i^(r=r<<30|r>>>2)^s)+a-899497514+n[e+1]<<0)<<5|a>>>27)+(o^(i=i<<30|i>>>2)^r)+s-899497514+n[e+2]<<0)<<5|s>>>27)+(a^(o=o<<30|o>>>2)^i)+r-899497514+n[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^o)+i-899497514+n[e+4]<<0,s=s<<30|s>>>2;this.h0=this.h0+i<<0,this.h1=this.h1+r<<0,this.h2=this.h2+s<<0,this.h3=this.h3+a<<0,this.h4=this.h4+o<<0;},Sha1.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return [e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var exports=createMethod();COMMON_JS?module.exports=exports:(root.sha1=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)));}();}).call(this,__webpack_require__(66),__webpack_require__(67));},function(e,t){(function(t){e.exports=t;}).call(this,{});},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Signalling=void 0;const s=i(10),a=i(271),o=i(62),n=i(64),d=i(284),c=r(i(12)),l=r(i(13)),u=i(73),h=i(118),p=i(148),m=i(4),f=i(286),g=i(143),v=i(287);class y extends s.EventEmitter{constructor(e){super(),this._reconnectionTimer=null,this._protoo=null,this._url=null,this._resolve=null,this._reject=null,this.consumers={},this.keepAliveTimer=null,this._reconnectionTimeout=3e4,this.reconnectionControl={current:null,next:null,copynext:null,blocker:null,pausers:[],resumers:[]},this.autoMask={timer:null,data:[]},this.logger=e.logger.getChild(()=>{var t;let i="signal";return this._protoo?(this._protoo.id&&(i+="#"+this._protoo.id+"_"+(null===(t=this._protoo._transport)||void 0===t?void 0:t.wsid)),this._protoo.connected||(i+="!connected")):i+=" PROTOO_UNINIT",e.adapterRef._signalling!==this&&(i+=" DETACHED"),i}),this._reset(),this.adapterRef=e.adapterRef,this.browserDevice=h.getOSInfo().osName+"-"+h.getBrowserInfo().browserName+"-"+h.getBrowserInfo().browserVersion;}async _reset(){this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._destroyProtoo(),this.reconnectionControl.current=null,this.reconnectionControl.next=null,this.reconnectionControl.copynext=null,this._reconnectionTimeout=3e4,this._resolve=null,this._reject=null;}init(e,t){return this._reconnectionTimer?Promise.resolve():new Promise((i,r)=>{e||(this._resolve=i),e||(this._reject=r);const s=this.reconnectionControl.next||{timeout:t?m.getParameters().reconnectionFirstTimeout:0,url:this.adapterRef.channelInfo.wssArr[0],serverIndex:0,times:t?1:0,isJoinRetry:e,isReconnection:t};this.adapterRef.channelInfo.wssArrIndex=s.serverIndex,e?t?this.adapterRef.logger.error(`Signalling 开始尝试第 ${s.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${s.times}/${m.getParameters().reconnectionMaxRetry} 次重连，退避时间：${s.timeout}毫秒，服务器地址：${s.url}`):this.adapterRef.logger.error(`Join: 正在尝试第 ${s.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${s.times}/${m.getParameters().joinMaxRetry} 次重连，退避时间：${s.timeout}毫秒，服务器地址：${s.url}`):this.adapterRef.logger.log(`Join: 正在尝试第 ${s.serverIndex+1} / ${this.adapterRef.channelInfo.wssArr.length} 个服务器的第 ${s.times} / ${m.getParameters().joinMaxRetry} 次连接`),this.reconnectionControl.current=s,this.reconnectionControl.next=null,this._init(s.url);let a=Object.assign({},s);s.times?a.serverIndex++:(a.times=1,a.serverIndex=1),a.serverIndex>=this.adapterRef.channelInfo.wssArr.length&&(a.times++,a.serverIndex=0),e?a.timeout=m.getParameters().joinFirstTimeout+2e3*(a.times-1):t&&(a.timeout=m.getParameters().reconnectionFirstTimeout+2e3*(a.times-1)),a.timeout=2e3*a.times,a.isJoinRetry=e,a.isReconnection=t,a.url=this.adapterRef.channelInfo.wssArr[a.serverIndex],this.reconnectionControl.next=this.reconnectionControl.copynext=a,this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=setTimeout(()=>{this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._destroyProtoo(),t?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),this._reconnection()):this._connection();},a.timeout);})}async _connection(){this._destroyProtoo();const e=this.reconnectionControl.current,t=this.reconnectionControl.next;t?!e||t.times<=m.getParameters().joinMaxRetry?this.init(!0,!1):(this.adapterRef.logger.error("join() 所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server connection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.SIGNAL_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR"),this._reject&&this._reject(new l.default({code:c.default.NETWORK_ERROR,message:"join() 所有的服务器地址都连接失败"}))):this.adapterRef.logger.error("Join结束");}async _reconnection(){if(!this._reconnectionTimer){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.reconnect=!0,this.adapterRef.connectState.prevState!==this.adapterRef.connectState.curState&&this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-start"),this._destroyProtoo(),"CONNECTED"===this.adapterRef.connectState.prevState&&(this.adapterRef.netStatusList.forEach(e=>{e.uplinkNetworkQuality=0,e.downlinkNetworkQuality=0;}),this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)),this.reconnectionControl.pausers.length&&(this.logger.log("重连过程暂停"),this.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-start"})),this.reconnectionControl.pausers=[],await new Promise(e=>{this.reconnectionControl.blocker=e;}));for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t._play&&(this.logger.warn("Destroy Remote Player",e),t._play.destroy());}this.reconnectionControl.next&&this.reconnectionControl.next.times>m.getParameters().reconnectionMaxRetry?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-skip"),this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server reconnection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.SIGNAL_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR")):this.init(!0,!0);}}_init(e){-1===e.indexOf("?")&&(e+="?"),this.logger.log("Signalling: init url=",e),this.adapterRef.channelInfo._protooUrl=e,this._url=`${-1===e.indexOf("://")?"wss://":""}${e}&cid=${this.adapterRef.channelInfo.cid}&uid=${this.adapterRef.channelInfo.uid}&deviceid=${this.adapterRef.deviceId}`,this.logger.log("连接的url: ",this._url);const t=new v.WebSocketTransport(this._url,{retry:{retries:0,factor:2,minTimeout:1e3,maxTimeout:2e3,forever:!1,maxRetryTime:2e3}});this._protoo=new v.Peer(t),this.adapterRef.state.signalEstablishTime=Date.now(),this._bindEvent();}_bindEvent(){var e,t,i,r,s;null===(e=this._protoo)||void 0===e||e.on("open",this.join.bind(this)),null===(t=this._protoo)||void 0===t||t.on("failed",this._handleFailed.bind(this)),null===(i=this._protoo)||void 0===i||i.on("notification",this._handleMessage.bind(this)),null===(r=this._protoo)||void 0===r||r.on("close",this._handleClose.bind(this)),null===(s=this._protoo)||void 0===s||s.on("disconnected",this._handleDisconnected.bind(this,this._protoo));}_destroyProtoo(){var e;if(this._protoo){this.logger.debug(`信令通道#${this._protoo.id}_${null===(e=this._protoo._transport)||void 0===e?void 0:e.wsid} 被主动关闭。`),this._protoo.removeAllListeners();try{this._protoo&&this._protoo.close();}catch(e){}this._protoo=null;}}async _handleMessage(e){var t,i,r,s,o,n,d;switch(e.method){case"OnPeerJoin":{const{requestId:t,externData:i}=e.data;this.logger.log("收到OnPeerJoin成员加入消息 uid =",i.uid);let r=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=r.toString());let s=this.adapterRef.remoteStreamMap[r];s?s.active=!0:(s=new a.RemoteStream({uid:r,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[r]=s,this.adapterRef.memberMap[r]=r),this.adapterRef.instance._roleInfo.audienceList[r]=!1,this.adapterRef.instance.safeEmit("peer-online",{uid:r}),i.customData&&this.adapterRef.instance.safeEmit("custom-data",{uid:r,customData:i.customData});break}case"OnPeerLeave":{const{requestId:t,externData:i}=e.data;this.logger.log("OnPeerLeave externData =",i),i.userList&&i.userList.forEach(e=>{var t;let i=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(i=i.toString()),null===(t=this.adapterRef._mediasoup)||void 0===t||t.removeUselessConsumeRequest({uid:i}),this.adapterRef.instance.clearMember(i),this.adapterRef.instance.removeSsrc(i),delete this.adapterRef.instance._roleInfo.audienceList[i];});break}case"OnNewProducer":{const{requestId:r,externData:s}=e.data;this.logger.log("收到OnNewProducer发布消息 externData =",JSON.stringify(s.producerInfo));let o,{uid:n,producerId:d,mediaType:c,mute:l,simulcastEnable:u}=s.producerInfo;switch("string"===this.adapterRef.channelInfo.uidType&&(n=n.toString()),c){case"video":o="video";break;case"screenShare":o="screen";break;case"audio":o="audio";break;case"subAudio":o="audioSlave";break;default:return void this.logger.warn(`OnNewProducer 不支持的媒体类型:${c}, uid ${n}`)}let h=this.adapterRef.remoteStreamMap[n];h?h.active=!0:(h=new a.RemoteStream({uid:n,audio:"audio"===o,audioSlave:"audioSlave"===o,video:"video"===o,screen:"screen"===o,client:this.adapterRef.instance,platformType:s.platformType}),this.adapterRef.remoteStreamMap[n]=h,this.adapterRef.memberMap[n]=n),h.muteStatus[o].send=s.producerInfo.mute,h.pubStatus[o].consumerId?null===(t=this.adapterRef._mediasoup)||void 0===t||t.destroyConsumer(h.pubStatus[o].consumerId,h,o):null===(i=this.adapterRef._mediasoup)||void 0===i||i.removeUselessConsumeRequest({producerId:h.pubStatus[o].producerId,uid:n}),h[o]=!0,h.pubStatus[o][o]=!0,h.pubStatus[o].producerId=d,h.pubStatus[o].mute=l,h.pubStatus[o].simulcastEnable=u,h.pubStatus[o].consumerId="",this.adapterRef._enableRts&&this.adapterRef._rtsTransport?this.adapterRef.instance.emit("rts-stream-added",{stream:h,kind:c}):this.adapterRef.instance.safeEmit("stream-added",{stream:h,mediaType:o}),l&&("audioSlave"===o?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:h.getId()}):this.adapterRef.instance.safeEmit("mute-"+o,{uid:h.getId()}));break}case"OnProducerClose":{const{requestId:t,code:i,errMsg:a,externData:o}=e.data;let{uid:n,producerId:d,mediaType:c,cid:l}=o;"string"===this.adapterRef.channelInfo.uidType&&(n=n.toString());let h,p=this.adapterRef.remoteStreamMap[n];if(!p)return void this.logger.warn(`收到OnProducerClose消息，但是当前没有该Producer： code = ${i}, errMsg = ${a}, uid = ${n}, mediaType = ${c}, producerId: ${d}`);switch(this.logger.log(`收到OnProducerClose消息 code = ${i}, errMsg = ${a}, uid = ${n}, mediaType = ${c}, producerId: ${d}`),c){case"video":h="video";break;case"screenShare":h="screen";break;case"audio":h="audio";break;case"subAudio":h="audioSlave";break;default:return void this.logger.warn(`OnProducerClose 不支持的媒体类型 ${c} ${n}`)}if(p.pubStatus[h].producerId!==d)return void this.logger.log("该 producerId 已经无效，不处理");null===(r=this.adapterRef._mediasoup)||void 0===r||r.removeUselessConsumeRequest({producerId:d,uid:n}),p.pubStatus[h].consumerId&&(null===(s=this.adapterRef._mediasoup)||void 0===s||s.destroyConsumer(p.pubStatus[h].consumerId,p,h),p.pubStatus[h].consumerId=""),this.adapterRef.instance.removeSsrc(n,h),p.subStatus[h]=!1,p.pubStatus[h][h]=!1,p[h]=!1,p.pubStatus[h].consumerId="",p.pubStatus[h].producerId="","audio"===h?(p.mediaHelper.audio.micTrack=null,u.emptyStreamWith(p.mediaHelper.audio.audioStream,null)):"audioSlave"===h?(p.mediaHelper.screenAudio.screenAudioTrack=null,u.emptyStreamWith(p.mediaHelper.screenAudio.screenAudioStream,null)):"video"===h?(p.mediaHelper.video.cameraTrack=null,u.emptyStreamWith(p.mediaHelper.video.videoStream,null)):"screen"===h&&(p.mediaHelper.screen.screenVideoTrack=null,u.emptyStreamWith(p.mediaHelper.screen.screenVideoStream,null)),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-stream-removed",{stream:p}):this.adapterRef.instance.safeEmit("stream-removed",{stream:p,mediaType:h});break}case"OnConsumerClose":{const{requestId:t,code:i,errMsg:r,consumerId:s,producerId:a}=e.data;this.logger.log(`chence OnConsumerClose code = ${i} errMsg = ${r} producerId = ${a}`);const o=this.consumers[s];if(!o)break;o.close();break}case"consumerPaused":{const{consumerId:t}=e.data;if(!this.consumers[t])break;break}case"consumerResumed":case"consumerScore":break;case"OnTransportClose":{const{requestId:t,code:i,errMsg:r,transportId:s}=e.data;this.logger.warn(`chence OnTransportClose: code = ${i}, errMsg = ${r}, transportId = ${s}`),(null===(o=this.adapterRef._mediasoup)||void 0===o?void 0:o._sendTransport)||(null===(n=this.adapterRef._mediasoup)||void 0===n?void 0:n._recvTransport)?(this.logger.warn("服务器媒体进程crash，上行媒体和下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnTransportClose",ext:""}),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnSignalRestart":{const{requestId:t,code:i,errMsg:r}=e.data;this.logger.warn(`chence OnSignalRestart code = ${i} errMsg = ${r}`),this.logger.warn("服务器信令进程crash，重连"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnSignalRestart",ext:""}),(null===(d=this._protoo)||void 0===d?void 0:d.connected)&&"CONNECTED"===this.adapterRef.connectState.curState||this._reconnection();break}case"OnPermKeyTimeout":this.adapterRef.instance.safeEmit("permkey-will-expire");break;case"OnPeerClose":this.logger.warn("相同UID在其他地方登录，您被提出房间"),this.adapterRef.instance.safeEmit("uid-duplicate"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.UID_DUPLICATE,this.adapterRef.instance.leave();break;case"OnKickOff":{let{msg:t,reason:i}=e.data.externData;this._handleKickedNotify(i);break}case"OnUserData":{let{type:t,data:i}=e.data.externData;if("StreamStatus"===t)this._handleStreamStatusNotify(i);else if("NetStatus"===t)this._handleNetStatusNotify(i);else if("Mute"===t)this.logger.log("mute变更: ",JSON.stringify(i,null,"")),this._handleMuteNotify(i);else if("UserRole"===t)this.logger.log("UserRole变更: ",JSON.stringify(i,null,"")),this._handleUserRoleNotify(e.data.externData);else if("RtmpTaskStatus"===t)this.logger.log("RtmpTaskStatus变更: ",JSON.stringify(i,null,"")),this.adapterRef.instance.safeEmit("rtmp-state",i);else if("AutoMaskUid"===t){const e=i;this.logger.log("收到打码通知：",e.maskUid,"时长",e.duration,"秒"),e.maskUid&&e.duration&&(e.targetEndMs=Date.now()+1e3*e.duration,this.autoMask.data.push(e),this.updateMaskStatus());}else if("MediaCapability"===t){if(this.logger.warn("MediaCapability房间能力变更: ",JSON.stringify(i,null,"")),this.adapterRef.mediaCapability.parseRoom(i),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),this.adapterRef._mediasoup&&this.adapterRef.mediaCapability.room.videoCodecType&&this.adapterRef.localStream){const e=this.adapterRef.mediaCapability.getCodecSend("video",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),t=this.adapterRef.mediaCapability.getCodecSend("screen",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),i=this.adapterRef._mediasoup._webcamProducerCodec&&this.adapterRef._mediasoup._webcamProducerCodec!==e.codecName;i&&this.logger.warn("将视频的Codec切走：",this.adapterRef._mediasoup._webcamProducerCodec,"=>",e.codecName);const r=this.adapterRef._mediasoup._screenProducerCodec&&this.adapterRef._mediasoup._screenProducerCodec!==e.codecName;r&&this.logger.error("将辅流的Codec切走：",this.adapterRef._mediasoup._screenProducerCodec,"=>",t.codecName),i||r?this._protoo&&this._protoo._transport&&this._protoo._transport._ws&&this._protoo._transport._ws.close():this.logger.log("Codec保持不动。video:",this.adapterRef._mediasoup._webcamProducerCodec,", screen:",this.adapterRef._mediasoup._screenProducerCodec);}}else if("Ability"===t)this._handleAbility(e.data.externData.data);else if("ChangeRight"===t){let e=i.uid;if(1===i.audioRight?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"audio",state:!0,duration:i.audioDuration})):2===i.audioRight&&(this.adapterRef.isAudioBanned=!1,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"audio",state:!1,duration:i.audioDuration})),1===i.videoRight?(this.adapterRef.isVideoBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"video",state:!0,duration:i.videoDuration})):2===i.videoRight&&(this.adapterRef.isVideoBanned=!1,this.adapterRef.isVideoBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"video",state:!1,duration:i.videoDuration})),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),this.adapterRef.isAudioBanned&&!this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),this.adapterRef.isAudioBanned||this.adapterRef.isVideoBanned||this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),!this.adapterRef.localStream)return}else this.logger.error(`收到OnUserData通知消息 type = ${t}, data: `,i);}}}_handleFailed(){this.logger.log("Signalling:_handleFailed");}_handleClose(){}_handleDisconnected(e){var t,i,r,s;this.logger.log("Signalling:_handleDisconnected"),!this._reconnectionTimer||"connectioning"!==this.adapterRef.channelStatus&&"join"!==this.adapterRef.channelStatus?(this.logger.warn(`信令通道#${e.id}_${null===(s=e._transport)||void 0===s?void 0:s.wsid} 收到关闭信号，即将开始重连过程。`),this.adapterRef.channelStatus="connectioning",this._reconnection()):e.closed?this.logger.warn(`信令通道#${e.id}_${null===(t=e._transport)||void 0===t?void 0:t.wsid} 在建立过程中被关闭。当前正在重连中，等待下次重连过程。`):this.logger.warn(`信令通道#${e.id}_${null===(i=e._transport)||void 0===i?void 0:i.wsid} 在建立过程中被关闭。信令通道会自动重试。连接地址：${null===(r=e._transport)||void 0===r?void 0:r._url}`),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"websocketDisconnect",ext:""});}async join(){var e,t;let i;this.adapterRef.state.signalOpenTime=Date.now(),i=!!this.adapterRef.encryption.encryptionSecret&&"none"!==this.adapterRef.encryption.encryptionMode;const r={method:"Join",permKeySecret:this.adapterRef.channelInfo.permKey,requestId:""+Math.ceil(1e9*Math.random()),supportStdRed:!0,supportTurn:!this.adapterRef.proxyServer.enable,externData:{userName:""+this.adapterRef.channelInfo.uid,token:this.adapterRef.channelInfo.token,cname:""+this.adapterRef.channelInfo.channelName,subType:"select",role:"part",version:"2.0",sessionMode:"meeting",engineVersion:o.ENGINE_VERSION,userRole:this.adapterRef.instance._roleInfo.userRole,userType:3,platformType:16,rtmp:{support:this.adapterRef.channelInfo.sessionConfig.liveEnable},record:{host:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,supportVideo:this.adapterRef.channelInfo.sessionConfig.recordVideo,supportAuido:this.adapterRef.channelInfo.sessionConfig.recordAudio,recordType:this.adapterRef.channelInfo.sessionConfig.recordType-0},mediaCapabilitySet:this.adapterRef.mediaCapability.stringify(),browser:{name:h.getBrowserInfo().browserName,version:""+h.getBrowserInfo().browserVersion},customData:this.adapterRef.channelInfo.customData||"",gmEnable:i,gmMode:p.encryptionModeToInt(this.adapterRef.encryption.encryptionMode),gmKey:this.adapterRef.encryption.encryptionSecret,customEncryption:!m.getParameters().forceCustomEncryptionOff&&this.adapterRef.encryption.encodedInsertableStreams,userPriority:this.adapterRef.userPriority}};this.logger.log("Signalling: socket连接成功，开始发送Join请求"),null===(e=this._protoo)||void 0===e||e.clear();try{let e=null,i=this._protoo;try{e=await(null===(t=this._protoo)||void 0===t?void 0:t.request("Join",r)),this.adapterRef.state.signalJoinResTime=Date.now();}catch(e){if(i!==this._protoo)return void this.logger.warn(`Login 过期的信令通道消息：【${e.name}】`,e.message);throw this.logger.warn("Login request error: ",e.message),new l.default({code:c.default.LOGIN_REQUEST_ERROR,message:e.message})}if(this.logger.log("Signalling:Join请求收到response"),200!=e.code){let t="Unknown Error";return e.externData?t=e.externData.errMsg:e.errMsg&&(t=e.errMsg),this.logger.error(`Signalling: 加入房间失败, code = ${e.code}, reason = ${t}`),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),void this._joinFailed(e.code,t)}let s=this.adapterRef.channelInfo.uid;if(e.PermKey&&(this.adapterRef.permKeyInfo=e.PermKey),1===e.externData.audioRight?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:s,mediaType:"audio",state:!0})):this.adapterRef.isAudioBanned=!1,1===e.externData.videoRight?(this.adapterRef.isVideoBanned=!0,this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:s,mediaType:"audio",state:!0})):this.adapterRef.isVideoBanned=!1,this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!!this.adapterRef.isAudioBanned,isVideoBanned:!!this.adapterRef.isVideoBanned}),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.logger.warn("服务器禁止发送音频流"),this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null),this.reconnectionControl.next=null,this.logger.log("Signalling: 加入房间成功"),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTED","no"===m.getParameters().forceBWE?e.preferRemb?(this.logger.log("服务端配置bwe：上行使用remb"),this.adapterRef.preferRemb=!0):(this.logger.log("服务端配置bwe：上行使用transport-cc"),this.adapterRef.preferRemb=!1):(this.adapterRef.preferRemb||e.preferRemb)&&"transport-cc"===m.getParameters().forceBWE?(this.logger.warn("强行使用transport-cc。忽略服务端配置bwe：preferRemb: "+e.preferRemb),this.adapterRef.preferRemb=!1):"remb"===m.getParameters().forceBWE&&(this.logger.warn("强行使用REMB。忽略服务端配置bwe：preferRemb: "+e.preferRemb),this.adapterRef.preferRemb=!0),this.adapterRef.audioAsl.enabled=e.supportWebAsl?"yes":"no",this.adapterRef.audioAsl.aslActiveNum=e.aslActiveNum,e.supportWebAsl?e.aslActiveNum?this.logger.log("aslActiveNum数量： "+e.aslActiveNum):this.logger.warn("服务端支持ASL但没有返回ASL数量"):this.logger.log("服务端未开启ASL"),this.adapterRef.instance.safeEmit("aslStatus",{enabled:!!e.supportWebAsl,aslActiveNum:e.aslActiveNum}),"connectioning"===this.adapterRef.channelStatus){if(this.adapterRef.connectState.reconnect=!0,this.logger.log("Signalling: 重连成功, 清除之前的媒体的通道"),this.adapterRef.channelStatus="join",this.adapterRef.instance.apiEventReport("setRelogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,reason:1,server_ip:this.adapterRef.channelInfo._protooUrl}),this.adapterRef.instance.resetChannel(),!this.adapterRef._mediasoup)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 1"});this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init(),this.adapterRef.localStream?this.adapterRef.localStream.audio||this.adapterRef.localStream.video||this.adapterRef.localStream.screen||this.adapterRef.localStream.screenAudio||m.getParameters().allowEmptyMedia||this.adapterRef.localStream.audioSlave?(this.logger.log(`重连成功，重新publish本端流: audio ${this.adapterRef.localStream.hasAudio()}, video ${this.adapterRef.localStream.hasVideo()}, screen ${this.adapterRef.localStream.hasScreen()}, audioSlave ${this.adapterRef.localStream.hasAudioSlave()}`),this.adapterRef.instance.doPublish(this.adapterRef.localStream)):this.logger.log("重连成功，当前没有媒体流，无需发布"):this.logger.log("重连成功，当前在未发布状态，无需发布");}else {this.adapterRef.connectState.reconnect=!1;const t=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2,i=Date.now();if(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime=i,this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:t.startWssTime-t.startJoinTime,time_elapsed:i-t.startJoinTime,model:this.browserDevice}),!this.adapterRef._mediasoup)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 2"});this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init();}this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef._enableRts&&(await this.createRTSTransport(),this.adapterRef.instance.emit("connected")),this.logger.log("Signalling: 查看房间其他人的发布信息: "+JSON.stringify(e.externData.userList));const o=[];if(void 0!==e.externData&&e.externData.userList&&e.externData.userList.length){let t=this;for(const i of e.externData.userList){let e=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=e.toString());let r=this.adapterRef.remoteStreamMap[e];if(r?(r.active=!0,this.adapterRef.memberMap[e]=""+e,o.push({eventName:"peer-online",eventData:{uid:e}})):(r=new a.RemoteStream({uid:e,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[e]=r,this.adapterRef.memberMap[e]=""+e,o.push({eventName:"peer-online",eventData:{uid:e}})),i.customData&&o.push({eventName:"custom-data",eventData:{uid:e,customData:i.customData}}),i.producerInfoList)for(const s of i.producerInfoList){const{mediaType:i,producerId:a,mute:n,simulcastEnable:d}=s;let c;switch(i){case"video":c="video";break;case"screenShare":c="screen";break;case"audio":c="audio";break;case"subAudio":c="audioSlave";break;default:this.logger.warn(`join: 不支持的媒体类型 ${i} ${e}`);continue}r[c]=!0,r.pubStatus[c][c]=!0,r.pubStatus[c].producerId=a,r.pubStatus[c].mute=n,r.muteStatus[c].send=n,r.pubStatus[c].simulcastEnable=d,t.logger.log(`Signalling: 通知 ${r.getId()} 发布信息: ${JSON.stringify(r.pubStatus,null,"")}`),t.adapterRef._enableRts&&t.adapterRef._rtsTransport?o.push({eventName:"rts-stream-added",eventData:{stream:r,kind:c}}):(r.pubStatus.audio.audio||r.pubStatus.video.video||r.pubStatus.screen.screen||r.pubStatus.audioSlave.audioSlave)&&o.push({eventName:"stream-added",eventData:{stream:r,mediaType:c}}),n&&("audioSlave"===c?o.push({eventName:"mute-audio-slave",eventData:{uid:r.getId()}}):o.push({eventName:"mute-"+c,eventData:{uid:r.getId()}}));}}for(let e in this.adapterRef.remoteStreamMap){this.adapterRef.remoteStreamMap[e].active||(this.logger.warn("重连期间远端流停止发布："+e),delete this.adapterRef.remoteStreamMap[e]);}}const n=this.adapterRef.instance;setTimeout(()=>{for(let e=0;e<o.length;e++){const t=o[e].eventName,i=o[e].eventData;n&&("stream-added"===t&&("audio"===i.mediaType?n.adapterRef.state.signalAudioAddedTime<n.adapterRef.state.signalOpenTime&&(n.adapterRef.state.signalAudioAddedTime=Date.now()):"video"===i.mediaType&&n.adapterRef.state.signalVideoAddedTime<n.adapterRef.state.signalOpenTime&&(n.adapterRef.state.signalVideoAddedTime=Date.now())),n.safeEmit(t,i));}},0),this.adapterRef.state.signalJoinSuccessTime=Date.now(),this._resolve?(this.logger.log("加入房间成功, 反馈通知"),this._resolve(e),this._resolve=null,this._reject=null):(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-success"),this.reconnectionControl.resumers.length&&(this.reconnectionControl.resumers.forEach(e=>e({reason:"reconnection-success"})),this.reconnectionControl.resumers=[])),this.doSendKeepAliveTask();}catch(e){this.logger.error("Signalling: 登录流程内部错误: ",e.message),this._joinFailed(-1,e.message||"LOGIN_ERROR");}}_joinFailed(e,t){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.channelStatus="init",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),4009===e&&this.adapterRef.instance.safeEmit("crypt-error",{cryptType:this.adapterRef.encryption.encryptionMode});const i=Date.now(),r=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;if(this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:e,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:r.startWssTime-r.startJoinTime,time_elapsed:i-r.startJoinTime,model:this.browserDevice,desc:t||""}),this._reject)this.logger.error("加入房间失败, 反馈通知"),this._reject(new l.default({code:c.default.SERVER_AUTH_ERROR,extraCode:e,message:t||"join failed"})),this._resolve=null,this._reject=null,this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.adapterRef.channelStatus="leave",this.adapterRef.instance.stopSession();else {switch(t){case"room not found":this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t,"，这通常是因为房间内其他人都已离开，房间关闭引起的");break;default:this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t);}this.adapterRef.instance.safeEmit("error","RELOGIN_ERROR"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.LOGIN_FAILED,this.adapterRef.instance.leave();}}doSendKeepAliveTask(){this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.keepAliveTimer=setInterval(()=>{this.doSendKeepAlive();},6e3);}async doSendKeepAlive(){var e,t;if(!(null===(e=this._protoo)||void 0===e?void 0:e.connected))return;this._protoo.id,null===(t=this._protoo._transport)||void 0===t||t.wsid;try{await this._protoo.request("Heartbeat");}catch(e){this.logger.error("信令包保活失败, reanson: "+e.message);}}async createRTSTransport(){if(this.logger.log("createRTSTransport()"),!this._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createRTSTransport: _protoo 未找到"});if(!this._url)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createRTSTransport: _url 未找到"});try{const e=await this._protoo.request("CreateWsTrasnport");this.logger.warn("CreateWsTrasnport response: ",JSON.stringify(e,null,""));const{code:t,errMsg:i,transportId:r,wsPort:s="6666"}=e;200==t?(this.adapterRef._rtsTransport&&(this.logger.log("CreateWsTrasnport: 需要更新"),this.adapterRef._rtsTransport.destroy()),this.logger.log("CreateWsTrasnport: 开始创建"),this.adapterRef._rtsTransport=new f.RTSTransport({url:this._url.replace(/:\d+/,":"+s)+"&transportId="+r,transportId:r,port:s,adapterRef:this.adapterRef})):this.logger.error(`createWsTrasnport failed, code: ${t}, reason: ${i}`);}catch(e){throw this.logger.error("createRTSTransport failed:",e.name,e.message),e}}async rtsRequestKeyFrame(e){if(this.logger.log("rtsRequestKeyFrame(): ",e),!this._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"rtsRequestKeyFrame: _protoo 未找到"});if(!e)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"rtsRequestKeyFrame: consumerId 未找到"});try{const t=await this._protoo.request("RequestKeyFrame",{consumerId:e});this.logger.warn("rtsRequestKeyFrame response: ",t);let{code:i,errMsg:r}=t;200==i?this.logger.log("RTS 关键帧请求完成"):this.logger.error(`RTS 关键帧请求失败, code: ${i}, reason: ${r}`);}catch(e){throw this.logger.error("rtsRequestKeyFrame failed:",e),e}}async updatePermKey(e){var t;if(this.logger.log("updatePermKey newwork isConnect: ",null===(t=this._protoo)||void 0===t?void 0:t.connected),!this._protoo||!this._protoo.connected)return;const i=await this._protoo.request("PermKeyUpdate",{requestId:""+Math.ceil(1e9*Math.random()),permKeySecret:e});200!==i.code?new l.default({code:c.default.UPDATE_PERMKEY_ERROR,extraCode:i.code,message:"update permkey 认证错误"}):this.adapterRef.permKeyInfo=i.PermKey;}updateMaskStatus(){var e,t,i;let r=Date.now();for(let i=this.autoMask.data.length-1;i>=0;i--){let s=this.autoMask.data[i];if(r>=s.targetEndMs){if(this.adapterRef.channelInfo.uid===s.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户去除打码",s.maskUid),null===(e=this.adapterRef.localStream._play)||void 0===e||e.disableMask();else {const e=this.adapterRef.remoteStreamMap[s.maskUid];e&&(null===(t=e._play)||void 0===t?void 0:t.mask.enabled)&&(this.logger.log("updateMaskStatus 远端用户去除打码",s.maskUid),e._play.disableMask());}this.autoMask.data.splice(i,1);}}let s=Number.MAX_SAFE_INTEGER;for(let e=0;e<this.autoMask.data.length;e++){let t=this.autoMask.data[e];s=Math.min(s,t.targetEndMs);if(this.adapterRef.channelInfo.uid==t.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户增加打码",t.maskUid),null===(i=this.adapterRef.localStream._play)||void 0===i||i.enableMask();else {const e=this.adapterRef.remoteStreamMap[t.maskUid];e?e._play&&!e._play.mask.enabled&&(this.logger.log("updateMaskStatus 远端用户增加打码",t.maskUid,"打码时长",t.duration,"秒"),e._play.enableMask()):this.logger.log("updateMaskStatus 远端用户不在频道中",t.maskUid,"打码时长",t.duration,"秒");}}this.autoMask.timer&&clearTimeout(this.autoMask.timer),this.autoMask.timer=setTimeout(()=>{this.updateMaskStatus();},s-r);}async doSendLogout(){if(this.logger.log("doSendLogout() begin"),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),!this._protoo||!this._protoo.connected)return;let e={requestId:""+Math.ceil(1e9*Math.random()),externData:{reason:0}};this._protoo.notify("Leave",e),this.logger.log("doSendLogout() success");}_handleStreamStatusNotify(e){}_handleNetStatusNotify(e){const t=e.netStatusList;let i=d.parseBase64(t).toString(),r=[],s=i.substr(2,2)+i.substr(0,2);s=parseInt(s,16),i=i.substr(4);for(let e=0;e<s;e++){let e=i.substr(0,16);e=a(e);const t=i.substr(16,2),s=i.substr(18,2);let o=0;if("00"!=i.substr(20,2)){const e=i.substr(22,2);o=parseInt(e,16),i.substr(24,o),o++;}const d={uid:"string"===this.adapterRef.channelInfo.uidType?g.SimpleBig.fromHex(e).toString():parseInt(e,16),downlinkNetworkQuality:parseInt(t,16),uplinkNetworkQuality:parseInt(s,16),receiveTs:Date.now()};r.push(d),i=i.substr(22+o);}function a(e){let t=[];for(var i=e.length;i>=1;i-=2)t.push(e[i-2],e[i-1]);return t.join("")}let o=!0,n=[];r=r.filter(e=>0!=e.uid),this.adapterRef.netStatusList.map(e=>{o=!0,r.map(t=>{e.uid!=t.uid&&0!=t.uid||(o=!1);}),o&&n.push(e);});let c=n.concat(r);c=c.filter(e=>this.adapterRef.memberMap[e.uid]||e.uid==this.adapterRef.channelInfo.uid),this.adapterRef.netStatusList=c,this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList);}_handleMuteNotify(e){const t=e.producerId,i=e.mute;Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{n.MediaTypeList.forEach(r=>{e.pubStatus[r].producerId===t&&(e.muteStatus[r].send=i,i?"audioSlave"===r?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("mute-"+r,{uid:e.getId()}):"audioSlave"===r?this.adapterRef.instance.safeEmit("unmute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("unmute-"+r,{uid:e.getId()}));});});}_handleUserRoleNotify(e){let t=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=t.toString());const i=e.data&&e.data.userRole;if(this.logger.warn(`用户${t}角色变为${i?"观众":"主播"}`),t&&1===i&&(this.adapterRef.instance.clearMember(t),this.adapterRef.instance.removeSsrc(t),this.adapterRef.instance._roleInfo.audienceList[t]=!0),t&&0===i){this.adapterRef.instance.safeEmit("peer-online",{uid:t});let i=this.adapterRef.remoteStreamMap[t];i?i.active=!0:(i=new a.RemoteStream({uid:t,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:e.platformType}),this.adapterRef.remoteStreamMap[t]=i,this.adapterRef.memberMap[t]=t),this.adapterRef.instance._roleInfo.audienceList[t]=!1;}}_handleAbility(e){this.adapterRef.instance.safeEmit("warning",{code:e.code,msg:e.msg});}_handleKickedNotify(e,t=this.adapterRef.channelInfo.uid){"string"===this.adapterRef.channelInfo.uidType&&(t=t.toString()),1==e?(this.logger.warn("房间被关闭"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.CHANNEL_CLOSED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("channel-closed",{})):2==e?(this.logger.warn(t+"被提出房间"),t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.CLIENT_BANNED,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("client-banned",{uid:t})):5==e&&(this.logger.warn(t+" permKey 超时被提出房间"),t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.PERMKEY_TIMEOUT,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("permkey-timeout",{uid:t}));}destroy(){this.logger.log("清除 Signalling"),this._destroyProtoo(),this._reset();}}t.Signalling=y;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteStream=void 0;const s=i(122),a=i(146),o=i(191),n=i(4),d=i(193),c=i(150),l=i(64),u=r(i(12)),h=r(i(13)),p=i(65),m=i(68),f=i(63);let g=0;class v extends m.RTCEventEmitter{constructor(e){if(super(),this.audioLevelHelper=null,this.platformType=l.PlatformType.unknown,this.isRemote=!0,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.active=!0,this.destroyed=!1,this.spatialPosition={x:0,y:0},this.remoteStreamId=g++,this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.platformType=e.platformType,this.logger=e.client.adapterRef.logger.getChild(()=>{let t="remote#"+this.stringStreamID;return l.PlatformTypeMap[this.platformType]&&(t+=" "+l.PlatformTypeMap[this.platformType]),t+=this.remoteStreamId,this.pubStatus.audio.consumerId?t+="M":this.pubStatus.audio.producerId&&(t+="m"),this.pubStatus.video.consumerId?t+="C":this.pubStatus.video.producerId&&(t+="c"),this.pubStatus.screen.consumerId?t+="S":this.pubStatus.screen.producerId&&(t+="s"),e.client.adapterRef.remoteStreamMap[this.streamID]!==this&&(t+=" DETACHED"),t}),"string"==typeof e.uid)e.client.adapterRef.channelInfo.uidType="string";else {if("number"!=typeof e.uid)throw this.logger.error("remoteSteram: uid参数格式非法"),new h.default({code:u.default.STREAM_UID_ERROR,message:"remoteSteram: uid参数格式非法"});if(e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw this.logger.error("remoteSteram: uid超出number类型精度"),new h.default({code:u.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数"})}this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:s.STREAM_TYPE.HIGH,screen:s.STREAM_TYPE.HIGH}},this.renderMode={remote:{video:{},screen:{}}},this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioSlave=e.audioSlave||!1,this.video=e.video||!1,this.screen=e.screen||!1,this.client=e.client,this.mediaHelper=new o.MediaHelper({stream:this}),this._play=new d.Play({stream:this}),this._record=new c.Record({logger:this.logger,client:this.client}),"never"!==n.getParameters().enableAlerter&&a.alerter.watchRemoteStream(this),this.client.apiFrequencyControl({name:"createRemoteStream",code:0,param:{streamID:this.stringStreamID,isRemote:!0,clientUid:this.client.adapterRef.channelInfo.uid||""}});}_reset(){this.audio=!1,this.audioSlave=!1,this.video=!1,this.screen=!1,this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:s.STREAM_TYPE.HIGH,screen:s.STREAM_TYPE.HIGH}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.renderMode={remote:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null;}get Play(){return this._play}get Record(){return this._record}getId(){return "string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}doSetSubscribeConfig(e){const t=Object.assign({},this.subConf);t.highOrLow=Object.assign({},this.subConf.highOrLow);for(let t of l.MediaTypeListAudio){const i=e[t];"boolean"==typeof i&&(this.subConf[t]=i);}for(let t of l.MediaTypeListVideo){const i=e[t];e.highOrLow&&(this.subConf.highOrLow[t]=e.highOrLow),"high"===i||"low"===i?(this.subConf[t]=!0,this.subConf.highOrLow[t]=s.STREAM_TYPE["high"===i?"HIGH":"LOW"]):"boolean"==typeof i&&(this.subConf[t]=i);}this.pubStatus.audio.audio&&this.subConf.audio?(this.subConf.audio=!0,this.audio=!0):this.subConf.audio=!1,this.pubStatus.audioSlave.audioSlave&&this.subConf.audioSlave?(this.subConf.audioSlave=!0,this.audioSlave=!0):this.subConf.audioSlave=!1,this.pubStatus.video.video&&this.subConf.video?(this.subConf.video=!0,this.video=!0):this.subConf.video=!1,this.pubStatus.screen.screen&&this.subConf.screen?(this.subConf.screen=!0,this.screen=!0):this.subConf.screen=!1;let i="doSetSubscribeConfig",r=!1;for(let e of l.MediaTypeList)i+=` ${e}:${t[e]}`,t[e]!==this.subConf[e]&&(i+="=>"+this.subConf[e],r=!0),"video"!==e&&"screen"!==e||(i+=" "+s.STREAM_TYPE_REV[t.highOrLow[e]],t.highOrLow[e]!==this.subConf.highOrLow[e]&&(i+="=>"+s.STREAM_TYPE_REV[this.subConf.highOrLow[e]],r=!0));r||(i+="【Unchanged】"),this.logger.log(i);}setSubscribeConfig(e){if(this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则：${JSON.stringify(e)}`),this.doSetSubscribeConfig(e),this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则结果：${JSON.stringify(this.subConf)}`),this.client.apiFrequencyControl({name:"setSubscribeConfig",code:0,param:{streamID:this.stringStreamID,isRemote:!0,conf:Object.assign({},this.subConf)}}),this.pubStatus.screen.screen){const e={uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,subscribe:this.subConf.screen};this.client.apiFrequencyControl({name:"subscribeRemoteSubStreamVideo",code:0,param:JSON.stringify(e,null," ")});}}getAudioStream(){return this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({isRemote:!0,streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream}getAudioTrack(){return this.mediaHelper.audio.audioStream.getAudioTracks()[0]||null}getVideoTrack(){return this.mediaHelper.video.videoStream.getVideoTracks()[0]||null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}async play(e,t={}){if((t.video||t.screen)&&!e)throw this.logger.warn(`play() remoteStream ${this.getId()} 播放视频没有指定div标签`),new h.default({code:u.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});if(p.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!0),p.isExistOptions({tag:"Stream.playOptions.audioSlave",value:t.audioSlave}).result||(t.audioSlave=!0),p.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),p.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`play() uid ${this.stringStreamID} 播放, playOptions:${JSON.stringify(t)}`),t.audio&&this._play&&this.mediaHelper.audio.audioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频播放。");else {this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频`);try{await this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,t.muted);}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e);}}if(t.audioSlave&&this._play&&this.mediaHelper.screenAudio.screenAudioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频辅流播放。");else {this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频辅流`);try{await this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,t.muted);}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e);}}let i;if(i="string"==typeof e?document.getElementById(e):e||null,i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 主流 远端`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,i),"width"in this.renderMode.remote.video&&this._play.setRender("video",this.renderMode.remote.video);}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e);}}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 辅流 远端`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.remote.screen&&this._play.setRender("screen",this.renderMode.remote.screen);}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e);}}}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!0},null," ")});}async resume(){f.tryResumeAudioContext()&&this.logger.log("正在尝试恢复AudioContext自动播放受限"),this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume()),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")});}setRemoteRenderMode(e,t){if(!e||!Number.isInteger(e.width)||!Number.isInteger(e.width))throw this.logger.warn("setRemoteRenderMode 参数宽高错误"),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,isRemote:!0,mediaType:t},e)}),new h.default({code:u.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.client&&this._play&&(this.logger.log(`uid ${this.stringStreamID} 设置远端视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setRender("video",e),this.renderMode.remote.video=e),t&&"screen"!==t||(this.renderMode.remote.screen=e,this._play&&this._play.setRender("screen",e)),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:0,param:Object.assign(Object.assign({},e),{mediaType:t,isRemote:!0,streamID:this.stringStreamID})}));}stop(e){this.logger.log(`stop() uid ${this.stringStreamID}, 停止播放 ${e||"音视频流"}`),this._play&&(l.MediaTypeList.forEach(t=>{e&&t!==e||this._play.stopPlayStream(t);}),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}));}isPlaying(e){if(this._play){if(l.MediaTypeList.indexOf(e)>-1)return this._play.isPlaying(e);throw this.logger.warn("isPlaying() unknown type"),new h.default({code:u.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: false`),!1}canPlay(e){return -1===l.MediaTypeList.indexOf(e)?null:this._play.canPlay(e)}async unmuteAudio(){var e;let t,i;if(this.muteStatus.audio.recv||(t=u.default.STREAM_NOT_MUTE_AUDIO_YET,i="remoteStream.unmuteAudio: 当前没有mute音频, 不支持unmute"),this._play.audio.dom&&(null===(e=this.mediaHelper.audio.audioStream)||void 0===e?void 0:e.active)||(t=u.default.STREAM_UNMUTE_AUDIO_WITHOUT_STREAM,i="remoteStream.unmuteAudio: 没有音频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudio",code:t?-1:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:i||""},null," ")}),t)throw this.logger.error(i),new h.default({code:t,message:i});try{this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID),this.muteStatus.audio.recv=!1,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,!1);}catch(e){this.logger.error("unmuteAudio() 异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e},null," ")});}}async muteAudio(){var e,t,i,r,s,a;if(this.logger.log("禁用音频轨道: ",this.stringStreamID),!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.audio)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(a=null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.audio)||void 0===s?void 0:s.audioStream)||void 0===a?void 0:a.active))throw this.logger.log("muteAudio() 之前没有播放过音频, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_AUDIO_ERROR,message:"remoteStream.muteAudio: 之前没有播放过音频, 不支持muteAudio"});try{this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audio"),this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")});}catch(e){this.logger.error("API调用失败: Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")});}}async unmuteAudioSlave(){var e;let t,i;if(this.muteStatus.audioSlave.recv||(t=u.default.STREAM_NOT_MUTE_AUDIO_SLAVE_YET,i="remoteStream.unmuteAudioSlave: 当前没有mute音频辅流, 不支持unmute"),this._play.audioSlave.dom&&(null===(e=this.mediaHelper.screenAudio.screenAudioStream)||void 0===e?void 0:e.active)||(t=u.default.STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM,i="remoteStream.unmuteAudioSlave: 没有音频辅流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:i||""},null," ")}),t)throw this.logger.error(i),new h.default({code:t,message:i});try{this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!1,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,!1);}catch(e){this.logger.error("Stream:unmuteAudioSlave 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")});}}async muteAudioSlave(){var e,t,i,r,s,a;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.audioSlave)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(a=null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.screenAudio)||void 0===s?void 0:s.screenAudioStream)||void 0===a?void 0:a.active))throw this.logger.error("muteAudioSlave() 之前没有播放过音频辅流, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_AUDIO_SLAVE_ERROR,message:"remoteStream.muteAudioSlave: 之前没有播放过音频辅流, 不支持mute"});try{this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!0,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audioSlave"),this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")});}catch(e){this.logger.error("Stream:muteAudioSlave 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e},null," ")});}}hasAudio(){return this.mediaHelper.audio.audioStream.getAudioTracks().length>0}hasAudioSlave(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}getAudioLevel(e="audio"){const t=this.mediaHelper.getOrCreateAudioPipeline(e);if(t){if(!t.audioLevelNode){const t=f.getAudioContext();if(t&&t.audioWorklet&&t.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),"suspended"===(null==t?void 0:t.state)){const e=new h.default({code:u.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: AudioContext is Suspended"});return this.client.safeEmit("notAllowedError",e),this.safeEmit("notAllowedError",e),0}this.client.apiFrequencyControl({name:"getAudioLevel",code:0,param:{mediaType:e,isRemote:!0,streamID:this.stringStreamID}});}const i=t.getAudioLevel();return i?i.volume:(this.logger.log("getAudioLevel() 正在加载音频模块"),0)}return 0}setAudioVolume(e=100){var t;let i,r;(!Number.isInteger(e)||e<0||e>100)&&(i=u.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.audio&&this._play&&this._play.audio&&this._play.audio.dom||(r="setAudioVolume() 没有音频流，请检查是否有订阅播放过音频",i=u.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*e,normalizedVolume:s,reason:r}}),i)throw this.logger.error(r),new h.default({code:i,message:r});this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),null===(t=this._play)||void 0===t||t.setPlayVolume("audio",s);}setAudioSlaveVolume(e=100){var t;let i,r;Number.isInteger(e)?e<0?e=0:e>100&&(e=100):(i=u.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioSlaveVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.audio&&this._play&&this._play.audioSlave&&this._play.audioSlave.dom||(r="setAudioSlaveVolume() 没有音频流，请检查是否有订阅播放过音频辅流",i=u.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*e,normalizedVolume:s,reason:r||""}}),i)throw this.logger.error(r),new h.default({code:i,message:r});this.logger.log(`setAudioSlaveVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),null===(t=this._play)||void 0===t||t.setPlayVolume("audioSlave",s);}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e);}catch(e){throw t&&setTimeout(()=>{t(e);},0),this.logger.error("设置输出设备失败",e.name,e.message),new h.default({code:u.default.SET_AUDIO_OUTPUT_ERROR,message:e.message||"系统内部错误"})}t&&setTimeout(t,0);}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!0},null," ")});}async unmuteVideo(){let e,t;if(this.muteStatus.video.recv||(e=u.default.STREAM_NOT_MUTE_VIDEO_YET,t="remoteStream.unmuteVideo: 当前没有mute视频, 不支持unmute"),this.mediaHelper.video.cameraTrack||(e=u.default.STREAM_UNMUTE_VIDEO_WITHOUT_STREAM,t="remoteStream.unmuteVideo: 没有视频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteVideo",code:e?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:t||""},null," ")}),e)throw this.logger.error(t),new h.default({code:e,message:t});try{this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!1,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0);}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")});}}async muteVideo(){var e,t,i,r,s;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.video)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.video)||void 0===s?void 0:s.cameraTrack))throw this.logger.log("muteVideo() 之前没有播放过视频, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_VIDEO_ERROR,message:"remoteStream.muteVideo: 之前没有播放过视频, 不支持mute"});try{this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!0,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")});}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")});}}async unmuteScreen(){let e,t;if(this.muteStatus.screen.recv||(e=u.default.STREAM_NOT_MUTE_SCREEN_YET,t="remoteStream.unmuteScreen: 当前没有mute屏幕共享, 不支持unmute"),this.mediaHelper.screen.screenVideoTrack||(e=u.default.STREAM_UNMUTE_SCREEN_WITHOUT_STREAM,t="remoteStream.unmuteScreen: 没有屏幕共享流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteScreen",code:e?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:t||""},null," ")}),e)throw this.logger.error(t),new h.default({code:e,message:t});try{this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的屏幕共享轨道`),this.muteStatus.screen.recv=!1,this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")});}catch(e){this.logger.error("unmuteScreen() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")});}}async muteScreen(){var e,t,i,r;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.screen)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(r=this.mediaHelper)||void 0===r?void 0:r.screen.screenVideoTrack))throw this.logger.log("muteScreen() 之前没有播放过屏幕共享, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_SCREEN_ERROR,message:"remoteStream.muteScreen: 之前没有播放过屏幕共享, 不支持mute"});try{this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的屏幕共享轨道`),this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.recv=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")});}catch(e){this.logger.error("muteScreen() 异常: ",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")});}}hasVideo(){this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length;}hasScreen(){this.mediaHelper.screen.screenVideoStream.getVideoTracks().length;}async takeSnapshot(e){var t,i,r,s;let a,o;const n=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(n||d?(await this._play.takeSnapshot(e,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign(Object.assign({},e),{streamID:this.stringStreamID,isRemote:!0})})):(o="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",a=u.default.STREAM_TAKE_SNAPSHOT_ERROR),a)throw this.logger.error(o),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},e),{reason:o}),null," ")}),new h.default({code:a,message:o})}takeSnapshotBase64(e){var t,i,r,s;let a,o;const n=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(n||d){let t=this._play.takeSnapshot(e,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!0},e)}),t}if(o="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",a=u.default.STREAM_TAKE_SNAPSHOT_ERROR,a)throw this.logger.error(o),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},e),{reason:o}),null," ")}),new h.default({code:a,message:o})}getCurrentFrameData(e={mediaType:"video"}){return this._play.getCurrentFrameData(e)}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":t.push(this.mediaHelper.audio.audioStream);}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new h.default({code:u.default.RECORDING_ERROR,message:"remoteStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流");}stopMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.playMediaRecording: 录制未开始"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.listMediaRecording: 录制未开始"});const t=this._record.getRecordStatus();return "init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.downloadMediaRecording: 录制未开始"});return this._record.download()}clearRemotePubStatus(){for(let e of l.MediaTypeList)this[e]=!1,this.pubStatus[e][e]=!1,this.pubStatus[e].producerId="",this.pubStatus[e].consumerId="",this.pubStatus[e].consumerStatus="init",this.pubStatus[e].stopconsumerStatus="init";}setCanvasWatermarkConfigs(e){if(this._play){let t="screen"===e.mediaType?this._play.screen.canvasWatermark:this._play.video.canvasWatermark;if(!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new h.default({code:u.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new h.default({code:u.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});t.checkWatermarkParams(e),t.updateWatermarks(e);Object.assign({uid:this.stringStreamID},e);this.client.apiFrequencyControl({name:"setRemoteCanvasWatermarkConfigs",code:0,param:{isRemote:!0,streamID:this.stringStreamID,mediaType:e.mediaType}});}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化");}getMuteStatus(e){return "audio"===e?{send:this.muteStatus.audio.send,recv:this.muteStatus.audio.recv,muted:this.muteStatus.audio.send||this.muteStatus.audio.recv}:"video"===e?{send:this.muteStatus.video.send,recv:this.muteStatus.video.recv,muted:this.muteStatus.video.send||this.muteStatus.video.recv}:{send:this.muteStatus.screen.send,recv:this.muteStatus.screen.recv,muted:this.muteStatus.screen.send||this.muteStatus.screen.recv}}getAdapterRef(){return this.client.adapterRef.remoteStreamMap[this.streamID]===this?this.client.adapterRef:null}getNativeDom(e){var t;const i=this[e],r=null===(t=this._play[e])||void 0===t?void 0:t.dom;return i&&r||this.logger.warn("No remote "+e),r}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!0}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset());}}t.RemoteStream=v;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.pcCloneTrack=void 0,t.pcCloneTrack=function(e){const t=new RTCPeerConnection,i=new RTCPeerConnection;window.pcLocal=t,window.pcRemote=i,t.onicecandidate=e=>{e.candidate&&i.addIceCandidate(e.candidate);},t.onnegotiationneeded=async e=>{const r=await t.createOffer();await t.setLocalDescription(r),await i.setRemoteDescription(r);const s=await i.createAnswer();await i.setLocalDescription(s),await t.setRemoteDescription(s);};const r=t.addTransceiver("video",{direction:"recvonly"});return i.addTrack(e),e.addEventListener("neTrackEnded",()=>{i.close(),r.receiver.track.stop();}),r.receiver.track};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.preProcessingPureColor=t.preProcessingCopy=t.preProcessingSyncState=t.disablePreProcessing=t.canDisablePreProcessing=t.enablePreProcessing=void 0;const r=i(73),s=i(173),a=i(140);function o(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled);}function n(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled),i.canvasCtx.drawImage(i.videoElem,0,0);}t.enablePreProcessing=async function(e,t,i){let d;if(i||(i=e[t].captureConfig.high.frameRate),d="video"===t?e.video.cameraTrack||e.video.videoSource:e.screen.screenVideoTrack||e.screen.screenVideoSource,!d)return void e.logger.warn("enablePreProcessing：当前没有视频输入 "+t);let c,l=e[t].preProcessing;if(!l){e.logger.log("enablePreProcessing:初始化 mediaType "+t);const i=document.createElement("video");let r=new a.RTCCanvas("canvas"),s=r._canvas,d=r._ctx;if(!d)throw new Error("无法创建canvasCtx 2d");const c=s.captureStream();i.onresize=()=>{r.setSize(i.videoWidth,i.videoHeight),i.play();};const u=c.getVideoTracks()[0];l={canvasTrack:u,canvasCtx:d,videoTrack:null,videoElem:i,canvasElem:s,handlers:[{name:"syncState",enabled:!0,func:o},{name:"copy",enabled:!0,func:n},{name:"mirror",enabled:!1,func:()=>{}},e.stream._play[t].encoderWatermark.handler],history:[],timer:null},e[t].preProcessing=l;}if(!l)return;"video"===t?r.emptyStreamWith(e.video.videoStream,l.canvasTrack):r.emptyStreamWith(e.screen.screenVideoStream,l.canvasTrack),l.videoElem.srcObject=new MediaStream([d]),l.videoTrack=d,e.stream.isRemote||(c=e.stream.getSender(t,"high")),c&&(c.replaceTrack(l.canvasTrack),e.logger.log(`enablePreProcessing ${t} 成功替换上行`));const u=async()=>{if(l)if(l.videoElem.videoWidth&&l.videoElem.videoHeight&&(l.videoElem.videoWidth===l.canvasElem.width&&l.videoElem.videoHeight===l.canvasElem.height||(e.logger.warn(`前处理宽高变化 ${t} ${l.canvasElem.width}x${l.canvasElem.height} => ${l.videoElem.videoWidth}x${l.videoElem.videoHeight}`),l.canvasElem.width=l.videoElem.videoWidth,l.canvasElem.height=l.videoElem.videoHeight)),l.handlers.length){const i=Date.now(),r=[];for(let s of l.handlers)if(s&&s.enabled){const a=i;await s.func(e,t,l);const o=Date.now()-a;r.push({name:s.name,spent:o});}const s=Date.now();let a=0;for(;a<l.history.length&&s-l.history[a].endTs>5e3;a++);l.history.splice(0,a),l.history.push({startTs:i,endTs:s,handlerTs:r});}else n(e,t,l);};l.timer&&clearInterval(l.timer);const h=Math.floor(1e3/i);try{u();}catch(t){e.logger.error("drawFrame",t.name,t.message,t.stack);}l.timer=s.getRTCTimer().setInterval(u,h),e[t].preProcessingEnabled=!0,e.emit("preProcessChange",{mediaType:t,isOn:!0});},t.canDisablePreProcessing=function(e,t){const i=e[t].preProcessing;return !(!i||!i.timer)&&0===i.handlers.filter(e=>e&&e.enabled&&"syncState"!==e.name&&"copy"!==e.name).length},t.disablePreProcessing=async function(e,t="video",i=!1){e.logger.log("disablePreProcessing "+t);const a=e[t].preProcessing;if(!a)return void e.logger.warn(`disablePreProcessing ${t}:当前没有前处理配置`);let o,n;a.canvasCtx.clearRect(0,0,a.canvasElem.width,a.canvasElem.height),(null==a?void 0:a.timer)&&(s.getRTCTimer().clearInterval(a.timer),a.timer=null),"video"===t?(o=e.video.cameraTrack||e.video.videoSource,r.emptyStreamWith(e.video.videoStream,o)):(o=e.screen.screenVideoTrack||e.screen.screenVideoSource,r.emptyStreamWith(e.screen.screenVideoStream,o)),a.videoElem.srcObject&&(a.videoElem.srcObject=null),e.stream.isRemote||(n=e.stream.getSender(t,"high")),n&&("live"===(null==o?void 0:o.readyState)?(n.replaceTrack(o),e.logger.log(`disablePreProcessing ${t} 成功替换上行为【${o.label}】`)):(n.replaceTrack(null),e.logger.warn("disablePreProcessing 删除上行"))),i||(e[t].preProcessingEnabled=!1),e.emit("preProcessChange",{mediaType:t,isOn:!1});},t.preProcessingSyncState=o,t.preProcessingCopy=n,t.preProcessingPureColor=function(e,t,i){i.canvasCtx.fillStyle="green",i.canvasCtx.fillRect(0,0,i.canvasElem.width,i.canvasElem.height);};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPipeline=void 0;const r=i(275),s=i(74),a=i(276),o=i(277),n=i(192),d=i(279),c=i(280);let l=0;t.AudioPipeline=class{constructor(e){this.id=++l,this.inputs={local:{track:null,node:null,label:""},remote:{track:null,node:null,label:""}},this.audioLevelNode=null,this.stages=[],this.mixins={},this.output={track:null,stream:new MediaStream,destination:null,directOutput:!0},this.context=e.context,this.logger=e.logger.getChild(()=>{let e="AudioPipeline#"+this.id;this.inputs.local.track&&(e+=" LOCAL",this.inputs.local.track===this.output.track&&(e+=`[${this.inputs.local.label}]`)),this.inputs.remote.track&&(e+=" REMOTE",this.inputs.remote.track===this.output.track&&(e+=`[${this.inputs.remote.label}]`));let t="";for(let e in this.mixins)this.output.destination&&this.mixins[e].node.isConnectedTo(this.output.destination)&&(t+=" m"+e);t&&(e+=" "+t);for(let t in this.stages)this.stages[t].enabled&&(e+="/"+this.stages[t].type);return e}),this.stageInputVolume=new o.StageInputVolume(this.context),this.stageAIProcessing=new n.StageAIProcessing(this.context,this.logger),this.stageDelay=new d.StageDelay(this.context),this.stages=[this.stageInputVolume,this.stageAIProcessing,this.stageDelay],this.output.stream=e.outputStream,this.pluginList=[],this.logger.log("Audio Pipeline Init");}getMixin(e){return this.mixins[e]||(this.mixins[e]=new c.AudioMix(this)),this.mixins[e]}getEnabledStages(){return this.stages.filter(e=>e.enabled)}setInput(e,t,i){this.inputs[e].track=t,this.updateConnection();}getInputVolume(){return this.stageInputVolume.volume}setInputVolume(e){this.stageInputVolume.setVolume(e),this.stageInputVolume.isTransparent()?this.stageInputVolume.enabled&&(this.stageInputVolume.enabled=!1,this.updateConnection()):this.stageInputVolume.enabled||(this.stageInputVolume.enabled=!0,this.updateConnection());}setDelay(e){this.stageDelay.setDelay(e),this.stageDelay.isTransparent()?this.stageDelay.enabled&&(this.stageDelay.enabled=!1,this.updateConnection()):this.stageDelay.enabled||(this.stageDelay.enabled=!0,this.updateConnection());}getAudioLevel(){return this.audioLevelNode||(this.initAudioLevelNode(),this.updateConnection()),this.audioLevelNode?(this.audioLevelNode.audioNode&&!this.audioLevelNode.audioNode.port.onmessage&&(this.audioLevelNode.logger.warn("Rebinding Audio Worklet Node"),this.audioLevelNode.bindAudioWorkletNode(this.audioLevelNode.audioNode)),this.audioLevelNode.getAudioLevel()):0}initAudioLevelNode(){this.audioLevelNode?this.logger.log("initAudioLevelNode: audioLevelNode Already Inited"):(this.audioLevelNode=new r.AudioLevelNode({logger:this.logger,context:this.context}),this.updateConnection());}hasWorkingMixin(){for(let e in this.mixins)if("MIX_PLAYING"===this.mixins[e].mixAudioConf.state)return !0;return !1}updateConnection(){var e,t,i,r,o,n;const d=this.getInputsInfo();let c=null;switch(d.cnt){case 0:this.output.directOutput=!0,this.output.stream.getTracks().length&&(this.output.stream.getTracks().forEach(e=>{this.output.stream.removeTrack(e);}),this.logger.log("updateConnection:NoInput"),this.output.stream.dispatchEvent(new Event("neTrackUpdated")),this.output.track=null),this.audioLevelNode&&this.audioLevelNode.disconnectFromAll();break;case 1:if(this.getEnabledStages().length||this.hasWorkingMixin()){this.output.destination||(this.logger.log("updateConnection: Creating output destination"),this.output.destination=new s.NeAudioNode("destination",this.context.createMediaStreamDestination())),this.output.track=this.output.destination.audioNode.stream.getTracks()[0],this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(e=>{var t;this.logger.log(`updateConnection: Updating output track ${e.label} => ${null===(t=this.output.track)||void 0===t?void 0:t.label}`),this.output.stream.removeTrack(e);}),this.output.stream.addTrack(this.output.track),this.output.stream.dispatchEvent(new Event("neTrackUpdated")));let e=!1;for(let t in this.mixins){const i=this.mixins[t];"MIX_PLAYING"===i.mixAudioConf.state?(i.mixAudioConf.replace&&(e=!0),i.node.isConnectedTo(this.output.destination)||(this.logger.log(`connect ${t} to destination`),i.node.connect(this.output.destination))):i.node.isConnectedTo(this.output.destination)&&i.node.disconnect(this.output.destination);}if(this.stages){let t=this.output.destination;for(let s=this.stages.length-1;s>=0;s--){const a=this.stages[s];a.enabled&&a.node?(c||(c=a.node),e&&t===this.output.destination?a.node.isConnectedTo(t)&&a.node.disconnect(t):a.node.isConnectedTo(t)||(a.node.disconnectToAll(),a.node.connect(t)),t=a.node):a.enabled||(null===(i=a.node)||void 0===i||i.disconnectToAll(),null===(r=a.node)||void 0===r||r.disconnectFromAll());}d.singleInput&&(d.singleInput.track&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote)),e&&t===this.output.destination?(null===(o=d.singleInput.node)||void 0===o?void 0:o.isConnectedTo(t))&&(null===(n=d.singleInput.node)||void 0===n||n.disconnect(t)):d.singleInput.node&&!d.singleInput.node.isConnectedTo(t)&&(d.singleInput.node.disconnectToAll(),d.singleInput.node.connect(t)));}}else this.output.directOutput=!0,(null===(e=d.singleInput)||void 0===e?void 0:e.track)&&(this.output.track=d.singleInput.track,this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(e=>{this.output.stream.removeTrack(e);}),this.output.stream.addTrack(this.output.track),this.logger.log("updateConnection: DIRECT",this.output.track.label),this.output.stream.dispatchEvent(new Event("neTrackUpdated"))),this.audioLevelNode&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote),c=d.singleInput.node)),(null===(t=d.singleInput)||void 0===t?void 0:t.node)&&d.singleInput.node.disconnectToAll();}this.audioLevelNode&&c&&(c.isConnectedTo(this.audioLevelNode)||(this.audioLevelNode.disconnectFromAll(),c.connect(this.audioLevelNode)));}getInputsInfo(){let e=0,t=null;return this.inputs.local.track&&(e++,t=this.inputs.local),this.inputs.remote.track&&(e++,t=this.inputs.remote),{cnt:e,singleInput:1===e?t:null}}registerPlugin(e,t,i){"AIDenoise"===e&&(this.stageAIProcessing.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"));}unregisterPlugin(e){const t=this.pluginList.indexOf(e);-1!==t&&(this.pluginList.splice(t,1),this.stageAIProcessing.unregisterAIDenoise());}hasPlugin(e){return -1!==this.pluginList.indexOf(e)}async enableAIdenoise(e=!0){this.logger.log("Enabling AI Denoise",e),this.stageAIProcessing.enabled=e,"UNINIT"===this.stageAIProcessing.state&&await this.stageAIProcessing.init(),this.updateConnection();}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevelNode=void 0;const r=i(128),s=i(74),a=i(63);let o="NOTREADY",n=null;class d extends s.NeAudioNodeNullable{constructor(e){super("AudioLevelNode",null),this.volume=0,this.volumeTs=Date.now(),this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.context=e.context,this.logger=e.logger.getChild(()=>{let e="AudioLevelNode#"+this.id;return e+="READY"!==o?" "+o:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e}),this.initAudioWorklet();}async initAudioWorklet(){if(this.logger.log("AudioLevelNode initAudioWorklet"),!this.context.audioWorklet)return void this.logger.error("该环境不支持音频处理");n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入音量模块"),n=this.context.audioWorklet.addModule(r.getBlobUrl("volumeProcessor")),await n,o="READY",this.logger.log("载入音量模块成功"));const e=new AudioWorkletNode(this.context,"vumeter");this.bindAudioWorkletNode(e);const t=a.getAudioLevelDestination();t&&e.connect(t),this.connectedFrom.forEach(e=>{e.connect(this);}),this.connectedTo.forEach(e=>{this.connect(e);});}bindAudioWorkletNode(e){this.audioNode=e,e.port.onmessage=t=>{var i,r;if(this.audioNode!==e)return;const s=Date.now(),a=Math.floor(s);if(t.data.volume>-1){if(this.volume=t.data.volume,this.volumeTs=s,t.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===a||this.left.history.unshift({sec:a,sum:0}),this.left.volume=t.data.left,this.left.history[0].sum+=t.data.left,this.left.history.length>2&&this.left.history.pop();else {const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}if(t.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===a||this.right.history.unshift({sec:a,sum:0}),this.right.volume=t.data.right,this.right.history[0].sum+=t.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(i=this.left)||void 0===i?void 0:i.history[1])&&(null===(r=this.right)||void 0===r?void 0:r.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}else {if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}));}}}else this.logger.error("Unsupported message",t.data);};}getAudioLevel(){var e,t;return Date.now()-this.volumeTs>1e3?{volume:0}:{volume:this.volume,left:null===(e=this.left)||void 0===e?void 0:e.volume,right:null===(t=this.right)||void 0===t?void 0:t.volume}}}t.AudioLevelNode=d;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getMediaStreamSourceNode=void 0;const r=i(74),s=[];t.getMediaStreamSourceNode=function(e,t,i){const a=s.find(i=>i.ctx===e&&i.track===t);if(a){if(i){if(!a.audioElem){const e=document.createElement("audio");e.muted=!0,e.volume=0,e.autoplay=!0,e.controls=!0,a.audioElem=e;}a.audioElem.srcObject=a.stream,a.audioElem.play().catch(e=>{});}return a.node}{const a=new MediaStream([t]),o=e.createMediaStreamSource(a),n=new r.NeAudioNode("MediaStreamSource",o);let d=null;i&&(d=document.createElement("audio"),d.muted=!0,d.volume=0,d.autoplay=!0,d.controls=!0,d.srcObject=a,d.play().catch(e=>{}));const c={track:t,stream:a,source:o,ctx:e,node:n,audioElem:d};return s.push(c),n}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageInputVolume=void 0;const r=i(158),s=i(74);class a extends r.StageBase{constructor(e){super(e),this.type="stageInputVolume",this.node=null,this.volume=1;}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("gain",this.context.createGain()),this.state="INITED");}isTransparent(){return Math.abs(this.volume-1)<.01}setVolume(e){"UNINIT"===this.state&&this.init(),this.node&&e<=this.node.audioNode.gain.maxValue&&e>=this.node.audioNode.gain.minValue&&(this.node.audioNode.gain.value=e,this.volume=e);}}t.StageInputVolume=a;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioWorkletAgent=void 0;const r=i(10),s=i(128),a=i(74);let o="NOTREADY",n=null;class d extends r.EventEmitter{constructor(e){super(),this.outputCnt=0,this.inputCnt=0,this.node=new a.NeAudioNodeNullable("AudioWorkletAgent",null),this.logger=e.logger.getChild(()=>{let e="AudioWorkletAgent";return "READY"!==o&&(e+=" "+o),e});const t=e.context;this.support={context:t};}async init(){this.support.audioWorkletNode?this.logger.error("Already Inited"):this.support.context.audioWorklet?(n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入 audioWorkletAgentProcessor 模块"),n=this.support.context.audioWorklet.addModule(s.getBlobUrl("audioWorkletAgentProcessor")),await n,o="READY",this.logger.log("载入 audioWorkletAgentProcessor 模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"audioWorkletAgentProcessor"),this.node.updateNode(this.support.audioWorkletNode),this.bindProcessorEvents()):this.logger.error("该环境不支持音频处理");}outputData(e){if(!this.support.audioWorkletNode)throw new Error("Destroyed");this.inputCnt++,this.support.audioWorkletNode.port.postMessage({type:"outputData",data:e});}bindProcessorEvents(){this.removeAllListeners("rawinputs"),this.support.audioWorkletNode.port.onmessage=e=>{this.emit("processor-message",e),"rawinputs"===e.data.type?this.handleTypeRawInputs(e):"bufferDrop"===e.data.type?this.logger.warn(`音频处理程序刚刚丢弃了${5*e.data.cnt}ms的处理数据`):console.error("Unknown message",e);};}handleTypeRawInputs(e){this.outputCnt++,this.emit("rawinputs",e.data);}}t.AudioWorkletAgent=d;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageDelay=void 0;const r=i(158),s=i(74);class a extends r.StageBase{constructor(e){super(e),this.type="stageDelay",this.node=null,this.delayTime=1;}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("delay",this.context.createDelay(10)),this.state="INITED",this.node.audioNode.delayTime.value=this.delayTime);}isTransparent(){return this.delayTime<.01}setDelay(e){"UNINIT"===this.state&&this.init(),this.node&&(this.delayTime=e,this.node.audioNode.delayTime.value=e);}}t.StageDelay=a;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioMix=void 0;const r=i(74),s=i(68),a=i(157);class o extends s.RTCEventEmitter{constructor(e){super(),this.pipeline=e,this.context=e.context;const t=new r.NeAudioNode("AudioMixingGain",this.context.createGain());this.node=t,this.mixAudioConf={audioFilePath:"",state:"MIX_UNSTART",buffer:null,cachedBuffers:{},audioSource:null,gainFilter:t,replace:!1,loopback:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.logger=e.logger.getChild(()=>"AudioMix "+this.mixAudioConf.state);}async startAudioMixing(e){if((null==e?void 0:e.audioFilePath)?this.logger.log("即将开始伴音:",JSON.stringify(e,null," ")):this.logger.error("startAudioMixing:未指定伴音文件"),Object.assign(this.mixAudioConf,e),this.mixAudioConf.audioFilePath){if(this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath])return this.mixAudioConf.buffer=this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath],this.logger.log("即将从缓存播放伴音",this.mixAudioConf.audioFilePath),this.startMix();{this.logger.log("即将加载云端音乐",this.mixAudioConf.audioFilePath),this.mixAudioConf.state="MIX_STARTING";const e=await this.loadAudioBuffer(this.mixAudioConf.audioFilePath);if("MIX_STARTING"===this.mixAudioConf.state)return this.mixAudioConf.buffer=e,this.startMix();this.logger.warn("startAudioMixing: 播放行为被覆盖");}}}stopAudioMixing(e=!1){return this.mixAudioConf.audioSource?(this.logger.log("即将停止混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource=null):this.logger.warn("stopAudioMixing:当前没有在混音"),this.mixAudioConf.startTime=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.playStartTime=0,e&&this.resetMixConf(),this.mixAudioConf.state="MIX_STOPED",this.pipeline.updateConnection(),this.logger.log("混音已停止"),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=null,this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state="MIX_PAUSED";let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(){let e,t=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.cycle=this.mixAudioConf.cycle-Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.mixAudioConf.setPlayStartTime),e=this.mixAudioConf.setPlayStartTime,this.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",this.mixAudioConf),this.logger.log("已经播放的时间: ",t),t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),e=t),this.logger.log("回复重置的时间点：",e),this.mixAudioConf.playStartTime=e,this.startMix()}setAudioMixingVolume(e){if(e<=255&&e>=0){const t=e/255;this.logger.log(`setAudioMixingVolume ${this.mixAudioConf.gainFilter.audioNode.gain.value} => ${t}`),this.mixAudioConf.gainFilter.audioNode.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.audioNode.gain.value;}else this.logger.error("setAudioMixingVolume: volume不在0~255范围内：",e);}getAudioMixingPlayedTime(){let e=Date.now();"MIX_PAUSED"==this.mixAudioConf.state&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return {totalTime:this.mixAudioConf.totalTime}}startMix(){if(this.logger.log("startMix: ",this.mixAudioConf),this.mixAudioConf.buffer){if(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=new r.NeAudioNode("AudioMixBufferSource",this.pipeline.context.createBufferSource()),this.mixAudioConf.audioSource.audioNode.buffer=this.mixAudioConf.buffer,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.onended=e=>{this.audioEnd(e);},this.mixAudioConf.totalTime=this.mixAudioConf.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.audioNode.gain.value=this.mixAudioConf.volume,this.mixAudioConf.loopback&&this.mixAudioConf.cycle>1){this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback;const e=this.mixAudioConf.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",e),this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime,e-1);}else this.mixAudioConf.loopback&&1==this.mixAudioConf.cycle?(this.mixAudioConf.audioSource.audioNode.loop=!1,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",this.mixAudioConf.loopback),this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state="MIX_PLAYING",this.mixAudioConf.startTime=Date.now(),this.pipeline.updateConnection(),Promise.resolve()}this.logger.error("startMix: 缺少 mixAudioConf.buffer");}audioEnd(e){return "MIX_PLAYING"!==this.mixAudioConf.state?void this.logger.error("audioEnd:状态不对"):this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.audioNode.loop&&this.mixAudioConf.cycle<=0?void this.logger.log("无限循环时，伴音播放完成event: ",e):(this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.audioNode.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),this.pipeline.updateConnection(),Promise.resolve())}async loadAudioBuffer(e){let t,i;this.mixAudioConf.cachedBuffers[e]?this.logger.warn(`loadAudioBuffer: 该文件已有缓存，长度：${this.mixAudioConf.cachedBuffers[e].duration} 秒。即将更新该文件地址：${e}`):this.logger.warn("loadAudioBuffer: 开始加载文件。地址："+e);try{t=await a.ajax({url:e,type:"GET",dataType:"arraybuffer"});}catch(e){throw this.logger.error("loadAudioBuffer 加载云端音乐失败: ",e),e}this.logger.log(`loadAudioBuffer 文件下载成功。大小：${Math.floor(t.byteLength/1024)} KB`);try{i=await this.pipeline.context.decodeAudioData(t);}catch(e){throw this.logger.log("loadAudioBuffer 解码失败:",e),e}return this.logger.log(`loadAudioBuffer 解码成功。长度：${i.duration} 秒。`),this.mixAudioConf.cachedBuffers[e]=i,i}resetMixConf(){this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource=null),this.mixAudioConf.audioFilePath="",this.mixAudioConf.buffer=null,this.mixAudioConf.state="MIX_UNSTART",this.mixAudioConf.replace=!1,this.mixAudioConf.cycle=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.startTime=0,this.mixAudioConf.totalTime=0,this.mixAudioConf.volume=1,this.mixAudioConf.playStartTime=0,this.mixAudioConf.setPlayStartTime=0,this.mixAudioConf.auidoMixingEnd=null,this.emit("audioFilePlaybackCompleted");}}t.AudioMix=o;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createCanvasWatermarkControl=t.CanvasWatermarkControl=void 0;const s=r(i(194)),a=i(10),o=i(65),n=i(195);class d extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{background:"rgba(128,128,128, 0.5)",overflow:"hidden","white-space":"break-spaces",position:"absolute",wordBreak:"break-all",color:"white",fontSize:"10pt"}},this.watermarks=[],this.div=null;}checkWatermarkParams(e){e.textWatermarks&&e.textWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n);}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n);}),e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};o.checkExists(a);const n={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1};o.checkValidInteger(n);const d={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0};o.isExistOptions(d).result&&o.checkValidFloat(d);});}updateWatermarks(e){this.clear(),this.watermarks=[];e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;"number"==typeof e.offsetX?t.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(t.left=e.offsetX),"number"==typeof e.offsetY?t.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(t.top=e.offsetY),0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&("number"==typeof e.wmWidth?t.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(t.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?t.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(t.height=e.wmHeight)),"number"==typeof e.wmHeight?t.height=e.wmHeight+"px":e.wmHeight&&"string"==typeof e.wmHeight&&(t.height=e.wmHeight),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),elem:null,style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,elem:null,style:t},this.watermarks.push(i);}),e.textWatermarks&&e.textWatermarks.forEach(e=>{let i=e.content||"";const r=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?r.color=n.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(r.color=e.fontColor),"number"==typeof e.fontSize?r.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(r.fontSize=e.fontSize),"number"==typeof e.offsetX?r.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(r.left=e.offsetX),"number"==typeof e.offsetY?r.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(r.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?r.background="":"number"==typeof e.wmColor?r.background=n.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(r.background=e.wmColor),e.wmWidth,"number"==typeof e.wmWidth?e.wmWidth>0&&(r.width=e.wmWidth+"px"):"string"==typeof e.wmWidth&&(r.width=e.wmWidth),e.wmHeight&&("number"==typeof e.wmHeight?(e.wmHeight>0&&(r.wmHeight=e.wmWidth+"px"),r.height=e.wmHeight+"px"):"string"==typeof e.wmHeight&&(r.height=e.wmHeight));const s={type:"text",content:i,loop:!1,elem:null,loopIndex:0,style:r};this.watermarks.push(s);}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.color=n.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.color=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize),"number"==typeof e.offsetX?i.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(i.left=e.offsetX),"number"==typeof e.offsetY?i.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(i.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?i.background="":"number"==typeof e.wmColor?i.background=n.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(i.background=e.wmColor),e.wmWidth&&("number"==typeof e.wmWidth?i.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(i.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?i.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(i.height=e.wmHeight));const r={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,elem:null,style:i};this.watermarks.push(r);}),this.div&&this.start(this.div);}start(e){this.clear(),this.div=e,this.watermarks.forEach(t=>{let i;switch(t.type){case"text":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-text",i.innerText=t.content||"",Object.assign(i.style,t.style);break;case"timestamp":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-timestamp",i.innerText="",Object.assign(i.style,t.style);break;case"image":!t.imageUrls&&t.content&&(t.imageUrls=[t.content]),i=document.createElement("div"),i.className="nim-watermark nim-watermark-image-container",t.imgElems=[],t.imageUrls&&t.imageUrls.length&&t.imageUrls.forEach((e,r)=>{const s=document.createElement("img");s.className="nim-watermark nim-watermark-image nim-watermark-image-"+r,s.src=e,s.style.width="100%",t.style.height&&(s.style.height="100%"),s.style.overflow="hidden",t.imgElems&&t.imgElems.push(s),i.appendChild(s),r>0&&(s.style.display="none");}),t.loopIndex=-1;const e=()=>{if(!t.interval&&t.imgElems&&t.loopIndex>=0)t.imgElems[t.loopIndex].style.display="";else {if(t.imgElems&&t.imgElems[t.loopIndex]&&(t.imgElems[t.loopIndex].style.display="none"),t.loopIndex++,t.imgElems&&t.loopIndex>=t.imgElems.length){if(!t.loop)return void(t.loopTimer&&clearInterval(t.loopTimer));t.loopIndex=0;}t.imgElems&&(t.imgElems[t.loopIndex].style.display="");}};e(),t.interval&&(t.loopTimer=setInterval(e,t.interval)),Object.assign(i.style,t.style);}t.elem=i,e.appendChild(t.elem);});}clear(){this.div&&this.watermarks.forEach(e=>{e.elem&&(e.elem.remove(),e.elem=null),e.loopTimer&&clearTimeout(e.loopTimer);});}}t.CanvasWatermarkControl=d;const c=new class{constructor(){this.controls=[],this.timer=setInterval(()=>{this.updateTimestamps();},1e3);}updateTimestamps(){this.controls.forEach(e=>{e.watermarks.filter(e=>"timestamp"===e.type).forEach(e=>{e.elem&&(e.elem.innerText=s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"));});});}};t.createCanvasWatermarkControl=function(e){const t=new d(e);return c.controls.push(t),t};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createEncoderWatermarkControl=t.EncoderWatermarkControl=void 0;const s=r(i(194)),a=i(10),o=i(65),n=i(4),d=i(195);class c extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{left:0,top:0,textWidth:0,textHeight:0,fontSize:"15pt",fontFamily:n.getParameters().encoderWatermarkFontFamily,fillStyle:"white",textBaseline:"hanging",bgWidth:-1,bgHeight:-1,bgFillStyle:"rgba(136, 136, 136, 0.5)"}},this.watermarks=[],this.handler={name:"watermark",enabled:!1,func:this.handleFrame.bind(this)};}handleFrame(e,t,i){this.watermarks.forEach(e=>{if("text"===e.type||"timestamp"===e.type){let t="";t="timestamp"===e.type?s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"):e.content||"",i.canvasCtx.font=`${e.style.fontSize} ${e.style.fontFamily}`,i.canvasCtx.textBaseline=e.style.textBaseline;e.content;-1===e.style.bgWidth&&-1===e.style.bgHeight&&(e.style.bgWidth=e.style.textWidth,e.style.bgHeight=e.style.textHeight),e.style.bgWidth&&e.style.bgHeight&&(i.canvasCtx.fillStyle=e.style.bgFillStyle,i.canvasCtx.fillRect(e.style.left,e.style.top,e.style.bgWidth,e.style.bgHeight)),i.canvasCtx.fillStyle=e.style.fillStyle,i.canvasCtx.fillText(t,e.style.left,e.style.top);}if("image"===e.type&&e.imgElems){let t=void 0;if(e.interval){if(e.startMs&&e.interval){const i=Date.now()-e.startMs,r=Math.floor(i/e.interval);for(let i=r;i<r+e.imgElems.length;i++){const r=e.imgElems[e.loop?i%e.imgElems.length:i];if(r&&r.complete&&r.naturalWidth&&r.naturalHeight){t=r;break}}}}else e.imgElems[0].complete&&e.imgElems[0].naturalWidth&&e.imgElems[0].naturalHeight&&(t=e.imgElems[0]);if(t){let r,s;e.style.bgWidth>0&&e.style.bgHeight>0?(r=e.style.bgWidth,s=e.style.bgHeight):(r=t.naturalWidth,s=t.naturalHeight),i.canvasCtx.drawImage(t,e.style.left,e.style.top,r,s);}}});}checkWatermarkParams(e){var t,i;const r={tag:"Stream.setEncoderWatermarkConfigs:watermarks.count",value:((null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||0)+(e.timestampWatermarks?1:0)+((null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)||0),max:n.getParameters().encoderWatermarkLimit};o.checkValidInteger(r),e.textWatermarks&&e.textWatermarks.forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1,max:128};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n);}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1,max:128};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n);}),e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};o.checkExists(a);const n={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1,max:10};o.checkValidInteger(n);const d={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0,max:30};o.isExistOptions(d).result&&o.checkValidFloat(d);});}updateWatermarks(e){this.watermarks=[];e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;if("number"==typeof e.offsetX?t.left=e.offsetX:e.offsetX,"number"==typeof e.offsetY?t.top=e.offsetY:e.offsetY,0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&"number"==typeof e.wmWidth&&(t.bgWidth=e.wmWidth),e.wmHeight&&"number"==typeof e.wmHeight&&(t.bgHeight=e.wmHeight),!1!==e.loop&&(e.loop=!0),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,style:t},i.startMs=Date.now(),i.imgElems=[],i.imageUrls)for(let e=0;e<i.imageUrls.length;e++){const t=new Image;t.src=i.imageUrls[e],i.imgElems.push(t);}this.watermarks.push(i);}),e.textWatermarks&&e.textWatermarks.forEach(e=>{let i=e.content||"";const r=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?r.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(r.fillStyle=e.fontColor),"number"==typeof e.fontSize?r.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(r.fontSize=e.fontSize);const s=d.measureText(e.content,r.fontSize,r.fontFamily);r.textWidth=s.width,r.textHeight=s.height,e.offsetX&&(r.left=e.offsetX),e.offsetY&&(r.top=e.offsetY),e.wmColor,e.wmWidth>=0&&(r.bgWidth=e.wmWidth),e.wmHeight>=0&&(r.bgHeight=e.wmHeight),"number"==typeof e.wmColor?r.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(r.bgFillStyle=e.wmColor);const a={type:"text",content:i,loop:!1,loopIndex:0,style:r};this.watermarks.push(a);}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.fillStyle=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize);const r=d.measureText("yyyy-mm-dd HH:MM:ss",i.fontSize,i.fontFamily);i.textWidth=r.width,i.textHeight=r.height,e.offsetX&&(i.left=e.offsetX),e.offsetY&&(i.top=e.offsetY),e.wmWidth>=0&&(i.bgWidth=e.wmWidth),e.wmHeight>=0&&(i.bgHeight=e.wmHeight),"number"==typeof e.wmColor?i.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"===e.wmColor&&(i.bgFillStyle=e.wmColor);const s={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,style:i};this.watermarks.push(s);});}}t.EncoderWatermarkControl=c,t.createEncoderWatermarkControl=function(e){return new c(e)};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.playMedia=void 0;const r=i(73);t.playMedia=function(e,t){return new Promise((i,s)=>{let a=setTimeout(()=>{a&&(a=null,i());},t);const o=e.play();r.printForLongPromise(o,"媒体标签仍在启动播放中"),o.then(()=>{a&&(clearTimeout(a),a=null,i());}),o.catch(e=>{a&&(clearTimeout(a),a=null,s(e));});})};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parseBase64=void 0;const r=i(285);let s;t.parseBase64=function(e){var t=e.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(!s){s=[];for(var a=0;a<i.length;a++)s[i.charCodeAt(a)]=a;}var o=i.charAt(64);if(o){var n=e.indexOf(o);-1!==n&&(t=n);}return function(e,t,i){for(var s=[],a=0,o=0;o<t;o++)if(o%4){var n=i[e.charCodeAt(o-1)]<<o%4*2,d=i[e.charCodeAt(o)]>>>6-o%4*2,c=n|d;s[a>>>2]|=c<<24-a%4*8,a++;}return new r.WordArray(s,a)}(e,t,s)};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.WordArray=t.Hex=void 0,t.Hex={stringify(e){for(var t=e.words,i=e.sigBytes,r=[],s=0;s<i;s++){var a=t[s>>>2]>>>24-s%4*8&255;r.push((a>>>4).toString(16)),r.push((15&a).toString(16));}return r.join("")}};t.WordArray=class{constructor(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length;}toString(e){return (e||t.Hex).stringify(this)}concat(e){var t=this.words,i=e.words,r=this.sigBytes,s=e.sigBytes;if(this.clamp(),r%4)for(var a=0;a<s;a++){var o=i[a>>>2]>>>24-a%4*8&255;t[r+a>>>2]|=o<<24-(r+a)%4*8;}else for(var n=0;n<s;n+=4)t[r+n>>>2]=i[n>>>2];return this.sigBytes+=s,this}clamp(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4);}};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RTSTransport=void 0;const s=i(10),a=r(i(12)),o=r(i(13));class n extends s.EventEmitter{constructor(e){super(),this._reset(),this.adapterRef=e.adapterRef,this._url=e.url,this._port=e.port,this._transportId=e.transportId,this._ws=null,this.initSocket();}get transportId(){return this._transportId}_reset(){this._url="",this._port=0,this._ws=null;}initSocket(){if(this.adapterRef.logger.log("RTSTransport建立连接, url: ",this._url),!this._url)throw new o.default({code:a.default.NETWORK_ERROR,message:"initSocket: RTSTransport 的 url 未找到"});this._ws=new WebSocket(this._url,["protoo"]),this._ws.binaryType="arraybuffer";const e=this._ws;e.onopen=this._onOpen.bind(this),e.onmessage=this._onMessage.bind(this),e.onclose=this._onClose.bind(this),e.onerror=this._onError.bind(this);}_onOpen(e){this.adapterRef.logger.log("RTSTransport:_onOpen"),this.emit("open",e);}_onMessage(e){this.adapterRef.instance.emit("rts-stream-data",e);}_onClose(e){this.adapterRef.logger.log("RTSTransport:onClose <- ",e),this.emit("close",e);}_onError(e){this.adapterRef.logger.log("RTSTransport:onError <- ",e),this.emit("error",e);}send(e){this._ws&&this._ws.readyState===WebSocket.OPEN?this._ws.send(JSON.stringify(e)):this.adapterRef.logger.log("RTSTransport:send: 当前不能发送，等待ws连接成功之后发送");}_close(){this.adapterRef.logger.log("RTSTransport:close"),this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null);}destroy(){this.adapterRef.logger.log("WSTransport:destroy"),this._close(),this._url=null;}}t.RTSTransport=n;},function(e,t,i){var r=i(288),s=i(290);t.Peer=r,t.WebSocketTransport=s;},function(e,t,i){var r=a(i(60)),s=a(i(61));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(145),n=i(196),d=i(197),c=i(4).getParameters,l=new o("Peer"),u=0;e.exports=class extends n{constructor(e){super(l),l.debug("constructor()"),this._closed=!1,this.id=u++,this._transport=e,this._connected=!1,this._data={createTs:Date.now()},this._sents=new Map,this._notificationId=0,this._handleTransport();}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){l.debug("close()"),this._closed=!0,this._connected=!1,this._notificationId=0,this._transport.close(),this._transport=null;var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close();}}catch(e){t=!0,i=e;}finally{try{!e&&s.return&&s.return();}finally{if(t)throw i}}this._sents.clear();}}clear(){var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close();}}catch(e){t=!0,i=e;}finally{try{!e&&s.return&&s.return();}finally{if(t)throw i}}this._sents.clear();}request(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return (0, s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createRequest(e,i),"Heartbeat"!=e&&t._logger.debug("request() [method: "+e+", id: "+a.id+"]"),r.next=4,t._transport.send(a);case 4:return r.abrupt("return",new Promise((function(e,i){var r=c().protooMessageTimeout,s={id:a.id,method:a.method,startTs:Date.now(),resolve:function(i){t._sents.delete(a.id)&&(t._closed||(clearTimeout(s.timer),e(i)));},reject:function(e){t._sents.delete(a.id)&&(clearTimeout(s.timer),i(e));},timer:setTimeout((function(){t._sents.delete(a.id)&&i(new Error("request timeout"));}),r),close:function(){var e=new Error;e.name="peer closed",s.method&&(e.message="向edge的 "+s.method+" 请求被取消：连接 #"+t.id+" 已被关闭。连接建立时间："+(t._data.openTs-t._data.createTs)+"ms, 请求时间："+(Date.now()-s.startTs)+"ms"),i(e);}};t._sents.set(a.id,s);})));case 5:case"end":return r.stop()}}),s,t)})))()}notify(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return (0, s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createNotification(e,i),t._logger.debug("notify() [method:%s]",e),r.next=4,t._transport.send(a);case 4:case"end":return r.stop()}}),s,t)})))()}_handleTransport(){var e=this;if(this._transport.closed)return this._closed=!0,void setTimeout((function(){e._closed||(e._connected=!1,e.safeEmit("close"));}));this._transport.on("open",(function(){e._closed||(l.debug('emit "open"'),e._connected=!0,e._data.openTs=Date.now(),e.safeEmit("open"));})),this._transport.on("disconnected",(function(){e._closed||(l.debug('emit "disconnected"'),e._connected=!1,e.safeEmit("disconnected"));})),this._transport.on("failed",(function(t){e._closed||(l.debug('emit "failed" [currentAttempt:%s]',t),e._connected=!1,e.safeEmit("failed",t));})),this._transport.on("close",(function(){e._closed||(e._closed=!0,l.debug('emit "close"'),e._connected=!1,e.safeEmit("close"));})),this._transport.on("message",(function(t){t.request?e._handleRequest(t):t.response?e._handleResponse(t):t.notification&&e._handleNotification(t);}));}_handleRequest(e){var t=this;try{this.emit("request",e,(function(i){var r=d.createSuccessResponse(e,i);t._transport.send(r).catch((function(){}));}),(function(i,r){i instanceof Error?(i=500,r=String(i)):"number"==typeof i&&r instanceof Error&&(r=String(r));var s=d.createErrorResponse(e,i,r);t._transport.send(s).catch((function(){}));}));}catch(t){var i=d.createErrorResponse(e,500,String(t));this._transport.send(i).catch((function(){}));}}_handleResponse(e){var t=this._sents.get(e.id);if(t)if(e.ok)t.resolve(e.data);else {var i=new Error(e.errorReason);i.code=e.errorCode,t.reject(i);}else l.error("received response does not match any sent request",e.id,JSON.stringify(e));}_handleNotification(e){if(this._handleNotification>e.id)l.warn("忽略重复的通知消息: ",JSON.stringify(e,null," "));else {this._notificationId=e.id;var t=d.createSuccessResponse(e,{});this._transport.send(t).catch((function(){})),this.safeEmit("notification",e);}}};},function(e,t,i){t.generateRandomNumber=function(){return Math.round(1e7*Math.random())};},function(e,t,i){var r=a(i(60)),s=a(i(61));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(291),n=i(145),d=i(196),c=i(197),l=i(119).JSONBigStringify,u={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},h=new n("WebSocketTransport"),p=0;e.exports=class extends d{constructor(e,t){super(h),h.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this.wsid=0,this.skipReconnection=!1,this._runWebSocket();}get closed(){return this._closed}close(){if(!this._closed){h.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close();}catch(e){h.error("close() | error closing the WebSocket: %o",e);}}}send(e){var t=this;return (0, s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!t._closed){i.next=2;break}throw new Error("transport closed");case 2:i.prev=2,t._ws.send(l(e)),i.next=10;break;case 6:throw i.prev=6,i.t0=i.catch(2),h.warn("send() failed:",i.t0.name,i.t0.message),i.t0;case 10:case"end":return i.stop()}}),i,t,[[2,6]])})))()}_runWebSocket(){var e=this,t=o.operation(this._options.retry||u),i=!1;t.attempt((function(r){e._closed?t.stop():(h.debug("_runWebSocket() [currentAttempt:%s]",r),e._ws=new WebSocket(e._url,["protoo"]),p++,e.wsid=p,e._ws.onopen=function(){e._closed||(i=!0,e.safeEmit("open"));},e._ws.onclose=function(s){if(!e._closed)if(h.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',s.wasClean,s.code,s.reason),i){if(t.stop(),e.safeEmit("disconnected"),e._closed||e.skipReconnection)return;e._runWebSocket();}else e.safeEmit("failed",r),e._closed||t.retry(!0)||(e._closed=!0,e.safeEmit("close"));},e._ws.onerror=function(){e._closed||h.error('WebSocket "error" event');},e._ws.onmessage=function(t){if(!e._closed){var i=c.parse(t.data);i&&(0!==e.listenerCount("message")?e.safeEmit("message",i):h.error('no listeners for WebSocket "message" event, ignoring received message'));}});}));}};},function(e,t,i){e.exports=i(292);},function(e,t,i){var r=i(293);t.operation=function(e){var i=t.timeouts(e);return new r(i,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return [].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,r=Math.round(i*t.minTimeout*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},t.wrap=function(e,i,r){if(i instanceof Array&&(r=i,i=null),!r)for(var s in r=[],e)"function"==typeof e[s]&&r.push(s);for(var a=0;a<r.length;a++){var o=r[a],n=e[o];e[o]=function(r){var s=t.operation(i),a=Array.prototype.slice.call(arguments,1),o=a.pop();a.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),o.apply(this,arguments));})),s.attempt((function(){r.apply(e,a);}));}.bind(e,n),e[o].options=i;}};},function(e,t){function i(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0));}e.exports=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts;},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null;},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return !1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(void 0===i){if(!this._cachedTimeouts)return !1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),i=this._timeouts.shift();}var r=this,s=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts);}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts);}),i);return this._options.unref&&s.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){i._operationTimeoutCb();}),i._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts);},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e);},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e);},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,i=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,o=(e[a]||0)+1;e[a]=o,o>=i&&(t=s,i=o);}return t};},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LBSManager=void 0;const s=i(62),a=i(157),o=r(i(12)),n=r(i(13)),d=i(57),c=i(4),l=i(119);var u;!function(e){e[e.UNKNOWN_ERROR=99999]="UNKNOWN_ERROR",e[e.TIMEOUT=70100]="TIMEOUT",e[e.JSON_ERROR=70101]="JSON_ERROR",e[e.FORMAT_ERROR=70102]="FORMAT_ERROR";}(u||(u={}));t.LBSManager=class{constructor(e){this.urlBackupMap={},this.requestCnt=0,this.localStorageKey="LBS_CONFIG",this.builtinConfig=s.LBS_BUILD_CONFIG,this.updateTimer=null,this.lastUpdateStartAt=0,this.lastUpdate=null,this.tagToMainDomain={},this.lbsState="uninit",this.lbsStateWillChangeTimer=null,this.client=e,this.logger=e.logger.getChild(()=>{let e="LBSManager "+this.lbsState;return this.client.adapterRef.lbsManager!==this&&(e+="DETACHED"),e}),window.addEventListener("online",()=>{"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.adapterRef.lbsManager===this&&(this.logger.log("侦测到网络连接恢复，尝试更新LBS配置"),this.startUpdate("online"));});}async startUpdate(e){var t,i,r;if(!this.client._params.appkey)return void this.logger.error("无法更新域名配置：缺少appkey");if(null===(r=null===(i=null===(t=this.client)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)return void this.logger.log("忽略更新LBS配置请求：当前为私有化配置");const a=Date.now(),o=a-this.lastUpdateStartAt;if(o<3e3)return void this.logger.log(`startUpdate 忽略更新请求 ${e}: 上次更新于 ${o} 毫秒前`);this.lastUpdateStartAt=a,this.logger.log("startUpdate: 开始更新LBS配置。原因："+e);let n=null;try{n=await this.ajax({url:`${s.lbsUrl}?reason=${e}&sdkVersion=${encodeURIComponent(s.SDK_VERSION)}&appKey=${encodeURIComponent(this.client._params.appkey)}&business=rtc&clientType=16`,type:"GET",header:{}});}catch(e){this.logger.error("LBS更新失败！",e);}if(this.getReportField("lbs").forEach(e=>{this.client.apiEventReport("setRequestLbs",e);}),n&&n.nrtc&&n.call&&n.tracking)return n.ttl&&(this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.logger.log("LBS已到过期时间，正在回滚至内建设置"),this.loadBuiltinConfig("expire");},1e3*n.ttl)),this.lastUpdate={activeFrom:Date.now(),res:n},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.nrtc,n.nrtc,"nrtc","lbs"),this.addUrlBackup(this.tagToMainDomain.call,n.call,"call","lbs"),this.addUrlBackup(this.tagToMainDomain.tracking,n.tracking,"tracking","lbs"),this.lbsState="remote",this.logger.log(`成功加载远端配置。过期时间：${n.ttl}秒后。preloadTimeSec:${n.preloadTimeSec}：`),this.client.safeEmit("@lbs-config-update",{reason:e}),this.saveConfig(n),n;this.logger.error("startUpdate更新失败：无效的 LBS 返回",n);}async loadBuiltinConfig(e){"uninit"!==this.lbsState&&this.handleLbsStateWillChange(e);for(let e in this.builtinConfig)this.builtinConfig[e].length&&(this.addUrlBackup(this.builtinConfig[e][0],this.builtinConfig[e],e,"builtin"),this.tagToMainDomain[e]=this.builtinConfig[e][0]);this.lbsState="builtin",this.client.safeEmit("@lbs-config-update",{reason:e}),"oninit"!==e&&this.logger.log(`成功加载内建配置 ${e}。`);}handleLbsStateWillChange(e){this.lbsStateWillChangeTimer&&clearTimeout(this.lbsStateWillChangeTimer);const t={lbsState:this.lbsState,settings:this.getSettings()};this.lbsStateWillChangeTimer=setTimeout(()=>{const i={lbsState:this.lbsState,settings:this.getSettings()};"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.apiFrequencyControl({name:"_lbsStateChange",code:0,param:{reason:e,before:t,after:i}});},0);}getSettings(){const e=Object.keys(this.urlBackupMap),t={};return e.forEach(e=>{t[e]=this.urlBackupMap[e].map(e=>{const t=e.lastRequest?{status:e.lastRequest.status,rtt:e.lastRequest.rtt}:void 0;return {domain:e.domain,successCount:e.successCount,failCount:e.failCount,lastResult:t}});}),t}getReportField(e){const t=[];for(let i in this.urlBackupMap)for(let r=0;r<this.urlBackupMap[i].length;r++){const s=this.urlBackupMap[i][r];s.tag===e&&t.push(s);}let i=[],r=0;return t.forEach(t=>{if(t.lastRequest&&"inprogress"!==t.lastRequest.status){if(t.lastRequest.requestId>r&&(r=t.lastRequest.requestId,i=[]),t.lastRequest.requestId!==r)return;"lbs"===e?i.push({app_key:this.client._params.appkey,request_id:t.lastRequest.uuid,err_code:t.lastRequest.errCode,err_msg:t.lastRequest.errMsg,rtt:t.lastRequest.rtt,time:t.lastRequest.finishiedAt}):"nrtc"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1}):"call"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt}):i.push({domain:t.domain,requestId:t.lastRequest.uuid,addr:"",type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt});}}),i}saveConfig(e){if(!this.client._params.appkey)return void this.logger.error("saveConfig: 缺少appkey");const t={ts:Date.now(),appKey:this.client._params.appkey,sdkVersion:s.SDK_VERSION,sdkBuild:s.BUILD,config:e};try{localStorage.setItem(this.localStorageKey,l.JSONBigStringify(t));}catch(e){this.logger.error("saveConfig：无法存储LBS设置",e.name,e.message);}}loadLocalConfig(e){var t,i;if(!this.client._params.appkey)return this.logger.error("loadLocalConfig: 缺少appkey"),{reason:"appkeyNotFound",config:null};if(null===(i=null===(t=this.client._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return this.logger.log("忽略 loadLocalConfig 请求：当前为私有化配置"),{reason:"privilization",config:null};let r=null;try{const e=window.localStorage.getItem(this.localStorageKey);if(!e)return this.logger.log("本地未发现LBS配置"),{reason:"configNotFound",config:null};r=l.JSONBigParse(e);}catch(e){this.logger.error("无法读取本地配置：",e.name,e.message);}if(!r)return {reason:"configError",config:null};const a=Date.now(),o=r.ts+1e3*r.config.ttl-a;return o<0?(this.logger.log(`LBS不使用本地配置：ttl已过期${Math.floor(-o/1e3)} 秒。`),{reason:"expire",config:null}):r.sdkVersion!==s.SDK_VERSION||r.sdkBuild!==s.BUILD?(this.logger.warn(`LBS不使用本地配置：版本不匹配。${r.sdkVersion}/${r.sdkBuild} ${s.SDK_VERSION}/${s.BUILD}。`),{reason:"version",config:null}):r.appKey!==this.client._params.appkey?(this.logger.warn(`LBS不使用本地配置：appKey不匹配。${r.appKey} ${this.client._params.appkey}。`),{reason:"appkey",config:null}):(this.lastUpdate={activeFrom:r.ts,res:r.config},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.call,r.config.call,"call","localstorage"),this.addUrlBackup(this.tagToMainDomain.nrtc,r.config.nrtc,"nrtc","localstorage"),this.addUrlBackup(this.tagToMainDomain.tracking,r.config.tracking,"tracking","localstorage"),this.lbsState="local",this.logger.log(`成功加载本地配置。过期时间：${Math.floor(o/1e3)} 秒后。`),this.client.safeEmit("@lbs-config-update",{reason:e}),{reason:"success",config:r})}addUrlBackup(e,t,i,r){const s=this.urlBackupMap[e]||[];this.urlBackupMap[e]=[];const a=this.urlBackupMap[e],o=Date.now();t.forEach(t=>{let n=s.find(i=>i.domain===t&&i.mainDomain===e);n?(n.updatedAt=o,n.tag=i,n.source=r):n={id:a.length,domain:t,mainDomain:e,successCount:0,failCount:0,updatedAt:o,tag:i,source:r},a.push(n);});}getURLSettings(e){const t=/(\/\/)([^\/]+)(\/)/,i=e.match(t);let r="";r=i?i[2]:e,this.urlBackupMap[r]||this.addUrlBackup(r,[r],"extra","extra");const s=this.requestCnt++;return this.urlBackupMap[r].map((i,r)=>{const a=e.replace(t,`$1${i.domain}$3`);return {seqId:`${s}_${r}`,state:"uninit",requestId:s,url:a,item:i}})}markSuccess(e,t){var i;"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="success",this.logger.debug(`markFinish success seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`)),e.item.successCount++,e.state="success";const r=this.urlBackupMap[e.item.mainDomain];if(r&&"fail"===(null===(i=r[0].lastRequest)||void 0===i?void 0:i.status)){const t=r.findIndex(t=>t===e.item);t>-1&&(this.logger.warn(`主备域名互换。${r[0].domain} => ${e.item.domain}`),this.handleLbsStateWillChange("domainDown:"+r[0].domain),r.splice(t,1),r.unshift(e.item));}}markFail(e,t,i,r){"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="fail",t.errCode=i,t.errMsg=r,this.logger.debug(`markFinish fail seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`,i,r)),e.item.failCount++,e.state="fail",this.logger.error("markFail：",e.item.domain,i,r);}isAllRequestsFinished(e){for(let t in e){const i=e[t];if("uninit"===i.state||"sent"===i.state)return !1}return !0}ajax(e){if(c.getParameters().disableLBSService)return this.logger.log("disableLBSService:",e.url),a.ajax(e);const t=this.getURLSettings(e.url);let i=!1;return new Promise((r,s)=>{const h=(e,a,d)=>{var c,h,p,m,f,g,v;if(e.status>=400){if(this.markFail(d,a,e.status,"string"==typeof e.response?e.response:l.JSONBigStringify(e.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${d.url} 】【备 ${t[1].url} 】`,e.status),t[1].fire();else if(this.isAllRequestsFinished(t))return s(new n.default({code:o.default.LBS_REQUEST_ERROR,message:"LBS: 网络请求错误"}))}else if("json"!==e.responseType||e.response)if(500===(null===(c=e.response)||void 0===c?void 0:c.code)){if(this.markFail(d,a,u.UNKNOWN_ERROR,l.JSONBigStringify(e.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${d.url} 】【备 ${t[1].url} 】`,e.response),t[1].fire();else if(this.isAllRequestsFinished(t)){var y=e.response;r(y);}}else if("lbs"!==d.item.tag||(null===(p=null===(h=e.response)||void 0===h?void 0:h.call)||void 0===p?void 0:p.length)&&(null===(f=null===(m=e.response)||void 0===m?void 0:m.nrtc)||void 0===f?void 0:f.length)&&(null===(v=null===(g=e.response)||void 0===g?void 0:g.tracking)||void 0===v?void 0:v.length)){if(this.markSuccess(d,a),t.forEach(e=>{e.timer&&(clearTimeout(e.timer),e.timer=void 0),e.fire=void 0;}),i)return void this.logger.log(`${d.url} 已忽略返回值：${e.status}`);i=!0;y=e.response;r(y);}else {if(this.markFail(d,a,u.FORMAT_ERROR,l.JSONBigStringify(e.response)),!(t[1]&&t[1].fire&&t[1].timer))return r(e.response);this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${d.url} 】【备 ${t[1].url} 】`,"FORMAT_ERROR"),t[1].fire();}else if(this.markFail(d,a,u.JSON_ERROR,"JSON_ERROR"),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${d.url} 】【备 ${t[1].url} 】`,e),t[1].fire();else if(this.isAllRequestsFinished(t))return s(new n.default({code:o.default.LBS_JSON_ERROR,message:"LBS: 结果json解析错误"}))},p=(e,r,a,d)=>{if(this.markFail(a,r,u.UNKNOWN_ERROR,`${d.type||l.JSONBigStringify(d)}:${a.url}`),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${a.url} 】【备 ${t[1].url} 】`,d),t[1].fire();else if(this.isAllRequestsFinished(t))return i=!0,s(new n.default({code:o.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(onerror)"}))},m=(e,r,a,d)=>{if(this.markFail(a,r,u.TIMEOUT,"TIMEOUT"),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求超时，启用备用线路 【主 ${a.url}】【备 ${t[1].url}】`,d),t[1].fire();else if(this.isAllRequestsFinished(t))return i=!0,s(new n.default({code:o.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(ontimeout)"}))};t.forEach((t,i)=>{t.fire=()=>{t.fire=void 0,t.timer&&(clearTimeout(t.timer),t.timer=void 0),t.state="sent";const i={status:"inprogress",startAt:Date.now(),requestId:t.requestId,seqId:t.seqId,uuid:"",finishiedAt:0,errCode:0,errMsg:"",rtt:-1};t.item.lastRequest=i,((t,i)=>{const r=new XMLHttpRequest;t.xhr=r,r.open(e.type||"GET",i.url,!0),r.responseType=e.dataType||"json";const s=e.contentType||"application/json;charset=UTF-8";if(r.setRequestHeader("Content-Type",s),e.header&&Object.keys(e.header).map(t=>{e.header&&e.header[t]&&r.setRequestHeader(t,e.header[t]);}),"lbs"===i.item.tag){const e=d.generateUUID();i.item.lastRequest&&(i.item.lastRequest.uuid=e),r.setRequestHeader("X-Request-Id",e);}r.onload=h.bind(r,r,t,i),r.onerror=p.bind(r,r,t,i),r.ontimeout=m.bind(r,r,t,i),s.indexOf("x-www-form-urlencoded")>=0?e.data?r.send(a.getFormData(e.data)):r.send():e.data?r.send(l.JSONBigStringify(e.data)):r.send();})(i,t);},i&&(t.timer=setTimeout(()=>{t.fire&&(this.logger.warn("主线路请求超时，发起备用线路请求："+t.url),t.fire());},c.getParameters().fireBackupDelay*i));}),t[0].fire&&t[0].fire();})}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialManager=void 0;const r=i(117);t.SpatialManager=class{constructor(e){this.elem=document.createElement("audio"),this.fakeElem=document.createElement("audio"),this.data={},this.context=e.context,this.client=e.client,this.options=e.options,this.logger=e.client.adapterRef.logger.getChild(()=>"spatial");try{this.destination=new MediaStreamAudioDestinationNode(this.context);}catch(e){if("TypeError"!==e.name)throw e;this.destination=this.context.createMediaStreamDestination();}this.elem.setAttribute("playsinline","playsinline"),this.elem.setAttribute("autoplay","autoplay"),this.elem.className="nertc-panner-manager",this.elem.srcObject=this.destination.stream,this.fakeElem.muted=!0,this.fakeElem.volume=0,this.fakeElem.autoplay=!0,this.fakeElem.controls=!0;}getUserData(e){const t=""+e;""+parseInt(t)!==t&&this.logger.warn("getUserData:异常的uid：",e);let i=this.data[t];return i||(i={position:{x:0,y:0}},this.data[t]=i),i}shouldSubscribe(e){const t=this.getUserData(e);return Math.abs(t.position.x)<=64&&Math.abs(t.position.y)<=64}async updatePosition(e,t){const i=this.getUserData(e),r=this.client.adapterRef.remoteStreamMap[e];if(r){const s=this.client.getSubStatus(r,"all");if(this.shouldSubscribe(e))if(s.subscribable)this.logger.log(`[remote#${e} status:${s.status}]界内，【即将订阅】: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doSubscribe(r),this.updatePosition(e,i.position);else {if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界内，即将更新remoteStream位置: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y);}else if("subscribed"===s.status)this.logger.log(`[remote#${e} status:${s.status}]界外，【即将取消订阅】:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doUnsubscribe(r),this.updatePosition(e,i.position);else {if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界外，即将更新remoteStream位置:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y);}}else this.logger.log(`updatePosition: 更新未到的stream: ${e} ( ${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y;}init(){this.client.addListener("@stream-added",e=>{const t=this.getUserData(e.stream.getId());e.stream.setSubscribeConfig(this.options.subConfig),this.updatePosition(e.stream.getId(),t.position);}),this.client.addListener("@stream-unsubscribed",e=>{const t=this.getUserData(e.stream.getId());this.updatePosition(e.stream.getId(),t.position);}),this.client.addListener("@stream-subscribed",async e=>{this.logger.log("Subscribed to",e.stream.streamID,e.mediaType);const t=this.getUserData(e.stream.getId());"audio"===e.mediaType&&(t.audioNodes&&(t.audioNodes.pannerNode.disconnect(),t.audioNodes.source.disconnect(),t.audioNodes.gainNode.disconnect()),t.audioNodes={source:this.context.createMediaStreamSource(e.stream.mediaHelper.audio.audioStream),gainNode:this.context.createGain(),pannerNode:new PannerNode(this.context,{panningModel:"HRTF",distanceModel:"linear",rolloffFactor:1,coneInnerAngle:360,positionX:t.position.x,positionY:t.position.y,positionZ:0,maxDistance:100})},t.audioNodes.source.connect(t.audioNodes.gainNode),t.audioNodes.gainNode.connect(t.audioNodes.pannerNode),t.audioNodes.pannerNode.connect(this.destination),this.fakeElem.srcObject=e.stream.mediaHelper.audio.audioStream,this.fakeElem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.fakeElem.play();}));}),this.logger.log("Connected",e.stream.getId,e.stream.mediaHelper.audio.audioStream.getAudioTracks()[0])),this.updatePosition(e.stream.getId(),t.position);});}play(){this.elem.controls=!0,"suspended"===this.context.state&&r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(new Error("恢复AudioContext")),r.Device.once("user-gesture-fired",()=>{this.context.resume();})),this.elem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.elem.play();}));});}};},function(module,exports,__webpack_require__){var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStream=void 0;const videoQuality_1=__webpack_require__(122),alerter_1=__webpack_require__(146),audioLevel_1=__webpack_require__(174),media_1=__webpack_require__(191),parameters_1=__webpack_require__(4),play_1=__webpack_require__(193),record_1=__webpack_require__(150),video_post_processing_1=__importDefault(__webpack_require__(297)),advanced_beauty_1=__importDefault(__webpack_require__(320)),basic_beauty_1=__importDefault(__webpack_require__(321)),virtual_background_1=__importDefault(__webpack_require__(322)),plugin_1=__webpack_require__(323),plugin_list_1=__webpack_require__(201),param_1=__webpack_require__(65),types_1=__webpack_require__(64),errorCode_1=__importDefault(__webpack_require__(12)),rtcError_1=__importDefault(__webpack_require__(13)),gum_1=__webpack_require__(73),param_2=__webpack_require__(65),applyResolution_1=__webpack_require__(324),env=__importStar(__webpack_require__(24)),RTCEventEmitter_1=__webpack_require__(68),utils_1=__webpack_require__(57),webAudio_1=__webpack_require__(63),StageAIProcessing_1=__webpack_require__(192),wasmDetect_1=__webpack_require__(325);let localStreamCnt=0;class LocalStream extends RTCEventEmitter_1.RTCEventEmitter{constructor(e){if(super(),this.safariVideoSizeChange=!1,this._advancedBeautyProcessor=null,this.videoPostProcessTags={isBeautyTrack:!1,isBodySegmentTrack:!1,isAdvBeautyTrack:!1},this.replaceTags={videoPost:!1,waterMark:!1,isMuted:!1},this.audioLevelHelper=null,this.audioLevelHelperSlave=null,this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.state="UNINIT",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.isRemote=!1,this.active=!0,this.destroyed=!1,this.canvasWatermarkOptions=null,this.encoderWatermarkOptions=null,this.supportWasm=!0,this.supportAIDenoise=!0,this.basicBeautyStaticRes=e=>{this.logger.log("config basic beauty static resources."),this.WebGLSupportError(),basic_beauty_1.default.configStaticRes(e);},this.advBeautyStaticRes=e=>{this.logger.log("config advanced beauty static resources."),this.WebGLSupportError(),advanced_beauty_1.default.configStaticRes(e);},this.setAdvBeautyEffect=(...e)=>{this.logger.log("set advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.setAdvEffect(...e));},this.presetAdvBeautyEffect=(...e)=>{this.logger.log("preset advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.presetAdvEffect(...e));},this.localStreamId=localStreamCnt++,this.logger=e.client.adapterRef.logger.getChild(()=>{let e=this.localStreamId?"local"+this.localStreamId:"localStream";if(this.mediaHelper){let t="";this.mediaHelper.audio.micTrack&&(t+="m"),this.mediaHelper.video.cameraTrack&&(t+="c"),this.mediaHelper.screen.screenVideoTrack&&(t+="s"),this.mediaHelper.screenAudio.screenAudioTrack&&(t+="t"),t&&(e+=" "+t);}return "INITED"!==this.state&&(e+=" "+this.state),"INITED"===this.state&&this.client&&this.client.adapterRef.localStream!==this&&(e+=" DETACHED"),this.destroyed&&(e+=" DESTROYED"),e}),e.uid)if("string"==typeof e.uid){if(this.logger.log("createStream: uid是string类型"),e.client.adapterRef.channelInfo.uidType="string",!/^\d+(\.\d+)?$/.test(e.uid))throw this.logger.log("join(): uid不是数字字符串格式"),new rtcError_1.default({code:errorCode_1.default.JOIN_UID_TYPE_ERROR,message:"createStream: uid不是数字字符串格式"})}else {if("number"!=typeof e.uid)throw this.logger.error("createStream: uid参数格式非法"),new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"createStream: uid参数格式非法"});if(this.logger.log("createStream: uid是number类型"),e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数"})}else e.uid="local_"+this.localStreamId;this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioProcessing=e.audioProcessing||null,this.microphoneId=e.microphoneId||"",this.cameraId=e.cameraId||"",this.video=e.video||!1,this.screen=e.screen||!1,this.screenAudio=e.screenAudio||!1,this.audioSlave=this.screenAudio,this.sourceId=e.sourceId||"",this.facingMode=e.facingMode||"",this.client=e.client,this.audioSource=e.audioSource||null,this.videoSource=e.videoSource||null,this.screenAudioSource=e.screenAudioSource||null,this.screenVideoSource=e.screenVideoSource||null,this._segmentProcessor=null,this._cameraTrack=null,this._transformedTrack=null,this.mediaHelper=new media_1.MediaHelper({stream:this}),this._play=new play_1.Play({stream:this}),this._record=new record_1.Record({logger:this.logger,client:this.client}),this.client._params&&"live"===this.client._params.mode?this.audioProfile="music_standard":this.audioProfile="speech_low_quality","never"!==parameters_1.getParameters().enableAlerter&&alerter_1.alerter.watchLocalStream(this),this.logger.log("创建本地Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:e.audio,video:e.video})),this.client.apiFrequencyControl({name:"createLocalStream",code:0,param:{streamID:this.stringStreamID,videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,video:this.video,screen:this.screen,screenProfile:this.screenProfile}}),this.supportWasm=wasmDetect_1.webassemblySupported(),this.videoPostProcess=new video_post_processing_1.default(this.logger),this.basicBeauty=new basic_beauty_1.default(this.videoPostProcess),this.virtualBackground=new virtual_background_1.default(this.videoPostProcess),this.advancedBeauty=new advanced_beauty_1.default(this.videoPostProcess),env.IS_ANY_SAFARI&&this.videoPostProcess.on("safariVideoSizeChange",()=>{this.safariVideoSizeChange=!0,this.loseContext();}),this.videoPostProcess.on("contextLost",()=>{this.suspendVideoPostProcess(),this.safariVideoSizeChange?setTimeout(()=>{this.restoreContext();},0):this.emit("video-post-context-lost");}),this.videoPostProcess.on("contextRestored",e=>{this.resumeVideoPostProcess(),this.safariVideoSizeChange?this.safariVideoSizeChange=!1:(this.emit("video-post-context-restored",e),this.logger.log("webgl context restored, try to reinitialize webgl pipeline."));}),this.videoPostProcess.on("beautyResComplete",e=>{this.emit("basic-beauty-res-complete",e);}),this.videoPostProcess.on("advBeautyResComplete",e=>{this.emit("adv-beauty-res-complete",e);}),this.videoPostProcess.on("taskSwitch",e=>{if(this.replaceTags.videoPost=e,this.replaceCanvas(),e&&env.IS_ANY_SAFARI){const e=parseFloat(env.SAFARI_VERSION||"0");e<15.4&&this.logger.warn("It is detected that you are using safari and the version is lower than 15.4. For a better experience, it is recommended to use version 15.4 and above."),15.3===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause memory leaks (Safari kernel bug: capturing video streams from WebGL will cause memory leaks)."),15===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause the page to crash (Safari kernel bug: WebGL rendering WebCam will cause the page to crash).");}}),env.IS_ANY_SAFARI&&env.SAFARI_MAJOR_VERSION<15&&document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.replaceTags.videoPost&&this.logger.warn("In the current version of Safari, the page with the video post-processing function is restored from the background, the sending frame rate will slowly return to the normal frame rate from a lower value.");}),this.mediaHelper.on("preProcessChange",e=>{"video"===e.mediaType&&(this.replaceTags.waterMark=e.isOn,this.replaceCanvas());});}getAdapterRef(){return this.client.adapterRef.localStream===this?this.client.adapterRef:null}_reset(){this.streamID="",this.stringStreamID="",this.state="UNINIT",this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.audioProfile="speech_low_quality",this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.audio=!1,this.microphoneId="",this.video=!1,this.cameraId="",this.screen=!1,this.screenAudio=!1,this.audioSlave=!1,this.sourceId="",this.facingMode="",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.renderMode={local:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null,this.audioLevelHelper&&this.audioLevelHelper.destroy(),this.audioLevelHelper=null,this.audioLevelHelperSlave&&this.audioLevelHelperSlave.destroy(),this.audioLevelHelperSlave=null;}get segmentProcessor(){return this._segmentProcessor}get Play(){return this._play}get Record(){return this._record}getId(){return "string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}getAudioStream(){return this.mediaHelper?(this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream):null}async init(){const e=await this.client.operationQueue.enqueue({caller:this,method:"init",options:null}),t=()=>{e();const t={audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio};(this.audio||this.screenAudio)&&(t.audioProfile=this.audioProfile,t.audioProcessing=this.audioProcessing),this.video&&(t.videoProfile=this.mediaHelper.video.captureConfig.high,t.videoEncoder=this.mediaHelper.video.encoderConfig.high),this.screen&&(t.screenProfile=this.mediaHelper.screen.captureConfig.high,t.screenEncoder=this.mediaHelper.screen.encoderConfig.high),this.client.apiFrequencyControl({name:"init",code:0,param:Object.assign({streamID:this.stringStreamID},t)}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())});};let i=null;this.state="INITING",this.logger.log("init() 初始化音视频流对象"),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.videoProfile&&(this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate);try{this.audio&&await this.mediaHelper.getStream({audio:this.audio,audioDeviceId:this.microphoneId,audioSource:this.audioSource});}catch(e){this.logger.log("init() 打开mic失败: "+e.message),i=e,this.audio=!1;}try{this.video&&(await this.mediaHelper.getStream({video:this.video,videoSource:this.videoSource,videoDeviceId:this.cameraId,facingMode:this.facingMode}),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"));}catch(e){this.logger.log("init() 打开camera失败: "+e.message),i=e,this.video=!1;}try{if(this.screen){const e={sourceId:this.sourceId,screen:this.screen,screenVideoSource:this.screenVideoSource,screenAudio:this.screenAudio,screenAudioSource:this.screenAudioSource};await this.mediaHelper.getStream(e),this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen");}}catch(e){this.logger.log("init() 打开screen失败: "+e.message),i=e,this.screen=!0;}if(this.audio||this.video||this.screen||this.audioSlave)this.state="INITED";else {if(i)throw this.state="UNINIT",this.logger.error("localStream.init失败:",i.name,i.message,i),t(),i;if(!parameters_1.getParameters().allowEmptyMedia)throw this.state="UNINIT",this.logger.warn("init() localStream不允许初始化时无任何音视频"),t(),new rtcError_1.default({code:errorCode_1.default.STREAM_PROFILE_ERROR,message:"init() localStream不允许初始化时无任何音视频"});this.logger.log("init() 当前模式下localStream允许初始化时无任何音视频"),this.state="INITED";}t();}getAudioTrack(e="audio"){if(this.mediaHelper)return "audio"===e?this.mediaHelper.getAudioInputTracks()[0]:"audioSlave"===e?this.mediaHelper.getAudioSlaveInputTracks()[0]:null}getVideoTrack(e="video"){if(this.mediaHelper)return "video"===e?this.mediaHelper.video.cameraTrack||this.mediaHelper.video.videoSource:"screen"===e?this.mediaHelper.screen.screenVideoTrack||this.mediaHelper.screen.screenVideoSource:null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}async play(e,t={}){if((t.video||t.screen)&&!e)throw this.logger.warn(`play() localStream ${this.getId()} 播放视频没有指定div标签`),new rtcError_1.default({code:errorCode_1.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});param_2.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!1),t.audio&&!t.audioType&&(t.audioType="mixing"),param_2.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),param_2.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`play() uid: ${this.stringStreamID}, playOptions: ${JSON.stringify(t)}`),t.audio&&this._play&&this.mediaHelper.getAudioInputTracks().length>0&&(this.logger.log(`play() uid ${this.stringStreamID} 开始播放本地音频: `,t.audioType),"voice"===t.audioType?this._play.playAudioStream("audio",this.mediaHelper.audio.micStream,t.muted):"music"===t.audioType?this._play.playAudioStream("audio",this.mediaHelper.audio.musicStream,t.muted):"mixing"===t.audioType&&this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,t.muted));let i=null;if("string"==typeof e?i=document.getElementById(e):e&&(i=e),i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 主流 本地`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,i),"width"in this.renderMode.local.video&&this._play.setRender("video",this.renderMode.local.video);}catch(e){throw this.logger.log("play() 视频播放异常: ",e),e}await this.resumeVideoPostProcess();}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 辅流 本地`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.local.screen&&this._play.setRender("screen",this.renderMode.local.screen);}catch(e){throw this.logger.log("play() 屏幕共享播放异常: ",e),e}}}if(t.audio){const e={enable:!0};this.client.apiFrequencyControl({name:"enableEarback",code:0,param:JSON.stringify(e,null," ")});}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!1},null," ")});}async resume(){this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume()),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")});}setLocalRenderMode(e,t){if(!e||!param_1.isNumber(e.width)||!param_1.isNumber(e.height)||e.width<0||e.height<0)throw this.logger.warn("setLocalRenderMode() 参数宽高参数错误"),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,mediaType:t},e)}),new rtcError_1.default({code:errorCode_1.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.logger.log(`setLocalRenderMode() uid ${this.stringStreamID} 设置本地视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setRender("video",e),this.renderMode.local.video=e,this.replaceCanvas()),t&&"screen"!==t||(this.renderMode.local.screen=e,this._play&&this._play.setRender("screen",e)),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:0,param:Object.assign({streamID:this.stringStreamID,mediaType:t},e)});}stop(e){this.logger.log(`stop() uid ${this.stringStreamID} 停止播放 ${e||"音视频流"}`),this._play&&(types_1.MediaTypeList.forEach(t=>{e&&t!==e||this._play.stopPlayStream(t);}),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}));}isPlaying(e){if(this._play){if(types_1.MediaTypeList.indexOf(e)>-1)return this._play.isPlaying(e);throw this.logger.warn("isPlaying() unknown type"),new rtcError_1.default({code:errorCode_1.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: false`),!1}canPlay(e){return -1===types_1.MediaTypeList.indexOf(e)?null:this._play.canPlay(e)}async open(e){var t,i,r,s;let{type:a,deviceId:o,sourceId:n,facingMode:d,screenAudio:c,audioSource:l,videoSource:u,screenAudioSource:h,screenVideoSource:p}=e;const m=await this.client.operationQueue.enqueue({caller:this,method:"open",options:e}),f=t=>{m();const i=utils_1.makePrintable(Object.assign({},e,t.param),1);this.client.apiFrequencyControl({name:"open",code:t.code,param:Object.assign({streamID:this.stringStreamID},i)}),this.client.apiFrequencyControl({name:"_trackSettings",code:t.code,param:JSON.stringify(this.mediaHelper.getTrackSettings())});};try{switch(this.getAdapterRef()||(this.logger.log("open(): 绑定 localStream ",a),this.client.bindLocalStream(this)),a){case"audio":if(this.logger.log("open(): 开启 "+(l?l.label:"mic设备")),this.mediaHelper.audio.micTrack||this.mediaHelper.audio.audioSource)return this.logger.warn("open(): 请先关闭麦克风"),f({code:-1,param:{reason:"重复打开麦克风",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_MIC_ERROR,message:"open() 重复打开麦克风"}));if(this.audio=!0,this.mediaHelper){const e={audio:!0,audioDeviceId:o,audioSource:l};await this.mediaHelper.getStream(e),this.audioLevelHelper&&this.mediaHelper.audio.audioStream&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),o&&(this.microphoneId=o),this.audioSource=l||null,"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.createProduce(this,"audio")));}break;case"screenAudio":if(!h)return void this.logger.warn("open(): 不允许单独开启屏幕共享音频功能。");if(this.logger.log("open(): 开启自定义屏幕共享音频 "+h.label),this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource)return this.logger.warn("请先关闭屏幕共享音频"),f({code:-1,param:{reason:"请先关闭屏幕共享音频",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复打开屏幕共享音频"}));if(this.screenAudio=!0,this.mediaHelper){const e={screenAudio:!0,screenAudioSource:h};await this.mediaHelper.getStream(e),this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.createProduce(this,"audioSlave")));}break;case"video":case"screen":if(this.logger.log(`开启${"video"===a?"camera":"screen"}设备`),this[a]){const e="video"===a;return this.logger.warn("open() 请先关闭"+(e?"摄像头":"屏幕共享")),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"open() 重复打开"+(e?"摄像头":"屏幕共享"),type:a},null," ")}),f({code:-1,param:{reason:"open() 重复打开"+(e?"摄像头":"屏幕共享"),type:a}}),Promise.reject(new rtcError_1.default({code:e?errorCode_1.default.REPEAT_OPEN_CAMERA_ERROR:errorCode_1.default.REPEAT_OPEN_SCREEN_ERROR,message:"open() 重复打开"+(e?"摄像头":"屏幕共享")}))}if(e.screenAudio&&(this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource))return this.logger.warn("open() 重复开启屏幕共享音频"),f({code:-1,param:{reason:"open() 重复开启屏幕共享音频",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复开启屏幕共享音频"}));this[a]=!0;const c={videoDeviceId:o,sourceId:n,videoSource:u,screenAudioSource:h,screenVideoSource:p,facingMode:d};c[a]=!0,"screen"===a&&e.screenAudio&&(c.screenAudio=!0,this.screenAudio=!0),await this.mediaHelper.getStream(c),this.videoSource=u||null,this.screenAudio&&this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"video"===a&&this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),"screen"===a&&this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen"),o&&"video"===a&&(this.cameraId=o),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中, 无需发布。",c):(this.logger.log("Stream.open:开始发布",c),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.createProduce(this,a)),e.screenAudio&&await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.createProduce(this,"audioSlave")));break;default:throw this.logger.warn("open() 非法参数"),new rtcError_1.default({code:errorCode_1.default.STREAM_OPTN_NO_TYPE_ERROR,message:"open() type 参数类型非法"})}f({code:0,param:{type:a}});}catch(t){throw ["audio","video","screen"].indexOf(a)>-1&&(this[a]=!1,"screen"===a&&e.screenAudio&&(this.screenAudio=!1)),this.logger.log(a+" 开启失败: ",t.name,t.message),f({code:-1,param:{type:a,reason:t.message}}),new rtcError_1.default({code:errorCode_1.default.MEDIA_DEVICE_ERROR,message:`${t.name} ${t.message}`})}}async switchScreenStream(e){var t;let i=null,r=!1,s=null,a="";if("video"===(null===(t=e.screenVideoSource)||void 0===t?void 0:t.kind))i=e.screenVideoSource,r=!0;else {i=(await this.mediaHelper.getScreenSource({screen:this.screen})).getVideoTracks()[0];}i?(s=await this.replaceTrack({mediaType:"screen",track:i,external:r}),s?(this.client.adapterRef.logger.log(`switchScreenStream: 已从 ${s.external?"自定义辅流":"屏幕共享"} 切换到 ${r?"自定义辅流":"屏幕共享"}`),s.external||s.oldTrack.stop()):(a="当前没有screen流",this.client.adapterRef.logger.error(`switchScreenStream: 无法切换到${r?"自定义辅流":"屏幕共享"}: ${a}`))):(a="无法获得新的screenVideoTrack",this.client.adapterRef.logger.error("switchScreenStream: ",a)),this.client.adapterRef.instance.apiEventReport("setFunction",{name:"switch_to_custom_screen",oper:"1",param:a||"success"}),this.client.apiFrequencyControl({name:"switchScreenStream",code:a?-1:0,param:JSON.stringify({external:r,reason:a},null," ")});}async close(e){var t,i,r,s;e||(e={type:"all"});const a=await this.client.operationQueue.enqueue({caller:this,method:"close",options:e});let o,n,d=e.type;switch(d){case"audio":if(this.logger.log("close() 关闭mic设备"),!this.audio){o=errorCode_1.default.STREAM_CLOSE_AUDIO_ERROR,n="close() 没有开启过麦克风";break}this.audio=!1,this.mediaHelper.stopStream("audio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("close() 关闭音频，保留发布：",d):(this.logger.log("close() 停止发布音频"),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.destroyProduce("audio"))):this.logger.log("close() 未发布音频，无需停止发布"),this.audioSource=null;break;case"screenAudio":if(this.logger.log("close() 关闭屏幕共享音频"),!this.screenAudio){o=errorCode_1.default.STREAM_CLOSE_AUDIO_SLAVE_ERROR,n="close() 没有开启过屏幕共享音频";break}this.screenAudio=!1,this.mediaHelper.stopStream("screenAudio"),this.getAdapterRef()?(this.logger.log("close() 停止发布音频辅流"),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.destroyProduce("audioSlave"))):this.logger.log("close() 未发布音频，无需停止发布");break;case"video":if(this.logger.log("close() 关闭camera设备"),!this.video){o=errorCode_1.default.STREAM_CLOSE_CAMERA_ERROR,n="close() 没有开启过摄像头";break}await this.suspendVideoPostProcess(),this._transformedTrack&&this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.video=!1,this.mediaHelper.stopStream("video"),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("video",!0),null==this||this._play.stopPlayStream("video"),this.getAdapterRef()?(this.logger.log("close() 停止发布视频"),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.destroyProduce("video"))):this.logger.log("close() 未发布视频，无需停止发布"),this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1),this.videoSource=null;break;case"screen":if(this.logger.log("close() 关闭屏幕共享"),!this.screen){o=errorCode_1.default.STREAM_CLOSE_SCREEN_ERROR,n="close() 没有开启过屏幕共享";break}this.screen=!1,this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("screen",!0),this.mediaHelper.stopStream("screen"),null==this||this._play.stopPlayStream("screen"),this.getAdapterRef()?(this.logger.log("Stream.close: 停止发布辅流"),await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.destroyProduce("screen"))):this.logger.log("Stream.close: 未发布辅流，无需停止发布");break;case"all":this.logger.log(`Stream.close:关闭所有设备: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`),this.audio&&await this.close({type:"audio"}),this.video&&await this.close({type:"video"}),this.screen&&await this.close({type:"screen"}),this.screenAudio&&await this.close({type:"screenAudio"}),this.logger.log(`Stream.close:关闭所有设备成功: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`);break;default:o=errorCode_1.default.STREAM_CLOSE_ARGUMENT_ERROR,n="close() Unknown Type";}if(o)throw this.logger.error(n),this.client.apiFrequencyControl({name:"close",code:-1,param:JSON.stringify({reason:n,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,type:e.type},null," ")}),a(),new rtcError_1.default({code:o,message:n});return a(),void this.client.apiFrequencyControl({name:"close",code:0,param:JSON.stringify({reason:o,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio,type:e.type},null," ")})}async unmuteAudio(){var e,t;this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!0;}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!0;}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=1),this.muteStatus.audio.send=!1,this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")});}catch(e){this.logger.error("unmuteAudio() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")});}}async muteAudio(){var e,t;this.logger.log("muteAudio() 禁用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!1;}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!1;}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=0),this.muteStatus.audio.send=!0,this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")});}catch(e){this.logger.error("muteAudio() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")});}}async unmuteAudioSlave(){var e;this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach(e=>{e.enabled=!0;}),this.muteStatus.audioSlave.send=!1,this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")});}catch(e){this.logger.error("unmuteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")});}}async muteAudioSlave(){var e;this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach(e=>{e.enabled=!1;}),this.muteStatus.audioSlave.send=!0,this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")});}catch(e){this.logger.error("muteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")});}}hasAudio(){return this.mediaHelper.getAudioInputTracks().length>0}hasAudioSlave(){return this.mediaHelper.getAudioSlaveInputTracks().length>0}getAudioLevel(e="audio"){var t,i;if("audio"===e){if(!this.audioLevelHelper&&this.mediaHelper.audio.audioStream.getAudioTracks().length){const e=webAudio_1.getAudioContext();e&&e.audioWorklet&&e.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),this.audioLevelHelper=new audioLevel_1.AudioLevel({stream:this.mediaHelper.audio.audioStream,logger:this.logger});}return (null===(t=this.audioLevelHelper)||void 0===t?void 0:t.getAudioLevel())||0}return !this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.audioLevelHelperSlave=new audioLevel_1.AudioLevel({stream:this.mediaHelper.screenAudio.screenAudioStream,logger:this.logger})),(null===(i=this.audioLevelHelperSlave)||void 0===i?void 0:i.getAudioLevel())||0}getAudioSlaveLevel(){return this.mediaHelper.getGain()}setAudioProfile(e){this.logger.log("setAudioProfile() 设置音频属性: ",e),this.audioProfile=e,this.client.apiFrequencyControl({name:"setAudioProfile",code:0,param:{streamID:this.stringStreamID,profile:e}});}setAudioVolume(e=100){var t;let i,r;(!Number.isInteger(e)||e<0||e>100)&&(i=errorCode_1.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),this.audio?null===(t=this._play)||void 0===t||t.setPlayVolume("audio",s):(r="setAudioVolume() 没有音频流，请检查是否有发布过音频",i=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!1,volume:2.55*e,normalizedVolume:s,reason:r}}),i)throw this.logger.error(r),new rtcError_1.default({code:i,message:r})}setCaptureVolume(e,t){let i,r;if(Number.isInteger(e)?(e<0||e>100)&&(i=errorCode_1.default.STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR,r="setCaptureVolume() volume 应该为 0 - 100 的整数"):(i=errorCode_1.default.SET_CAPTURE_VOLUME_ARGUMENTS_ERROR,r="setCaptureVolume() volume 应该为 0 - 100 的整数"),this.client.apiFrequencyControl({name:"setCaptureVolume",code:i?-1:0,param:JSON.stringify({streamID:this.stringStreamID,audioType:t,volume:e},null," ")}),i)throw this.logger.error(r),new rtcError_1.default({code:i,message:r});this.logger.log(`setCaptureVolume() 调节${this.stringStreamID}的音量大小: ${e}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setGain(e/100,t);}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e);}catch(e){throw t&&setTimeout(()=>{t(e);},0),this.logger.error("设置输出设备失败",e.name,e.message),new rtcError_1.default({code:errorCode_1.default.SET_AUDIO_OUTPUT_ERROR,message:e.message||"系统内部错误"})}t&&setTimeout(t,0);}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!1},null," ")});}async switchDevice(e,t){this.logger.log(`switchDevice() 切换媒体输入设备: ${e}, deviceId: ${t}`);let i,r,s={};if(this.inSwitchDevice[e]?(r="switchDevice() 正在切换中, 重复切换 "+e,i=errorCode_1.default.SWITCH_DEVICE_REPEAT_ERROR):this.inSwitchDevice[e]=!0,"audio"===e){const a=this.mediaHelper.audio.micTrack;if("live"===(null==a?void 0:a.readyState)&&(null==a?void 0:a.getSettings().deviceId)===t)return void this.logger.warn("switchDevice() 切换相同的麦克风设备，不处理");if(this.hasAudio()?this.audioSource&&(r="switchDevice() 自定义音频输入不支持，无法切换",i=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_AUDIO):(r="switchDevice() 当前没有开启音频输入设备，无法切换",i=errorCode_1.default.SWITCH_DEVICE_NO_MIC_ERROR),i)throw this.logger.error(r),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:r,type:e,deviceId:t,streamID:this.stringStreamID}}),new rtcError_1.default({code:i,message:r});this.mediaHelper.audio.micConstraint&&this.mediaHelper.audio.micConstraint.audio?this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}:this.mediaHelper.audio.micConstraint?(this.mediaHelper.audio.micConstraint.audio={},this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}):this.mediaHelper.audio.micConstraint={audio:{deviceId:{exact:t}}},s=this.mediaHelper.audio.micConstraint,this.microphoneId=t;}else {if("video"!==e)return this.logger.error("switchDevice() type参数错误: "+e),Promise.reject(new rtcError_1.default({code:errorCode_1.default.SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR,message:"switchDevice() type参数错误: "+e}));{const a=this.mediaHelper.video.cameraTrack;if(await this.suspendVideoPostProcess(),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),"live"===(null==a?void 0:a.readyState)&&(null==a?void 0:a.getSettings().deviceId)===t)return this.logger.log("switchDevice() 切换相同的摄像头设备，不处理"),void(this.inSwitchDevice[e]=!1);if(this.hasVideo()?this.videoSource&&(r="switchDevice() 自定义视频输入不支持切换",i=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_VIDEO):(r="switchDevice() 当前没有开启视频输入设备，无法切换",i=errorCode_1.default.SWITCH_DEVICE_NO_CAMERA_ERROR),i)return this.logger.error(r),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:r,type:e,deviceId:t,streamID:this.stringStreamID}}),Promise.reject(new rtcError_1.default({code:i,message:r}));this.mediaHelper.video.cameraConstraint&&this.mediaHelper.video.cameraConstraint.video&&(this.mediaHelper.video.cameraConstraint.video.deviceId={exact:t},s=this.mediaHelper.video.cameraConstraint),this.cameraId=t,this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1);}}try{const i=this.mediaHelper.video.preProcessingEnabled;i&&this.mediaHelper.disablePreProcessing("video"),await this.mediaHelper.getSecondStream(s),this.inSwitchDevice[e]=!1,i&&this.mediaHelper.enablePreProcessing("video"),"video"===e&&await this.resumeVideoPostProcess(),this.client.apiFrequencyControl({name:"switchDevice",code:0,param:{type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),this._play.resume();}catch(i){throw this.logger.error("switchDevice() 异常：",i.name,i.message,i),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:i.message,type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),new rtcError_1.default({code:i.code||errorCode_1.default.UNKNOWN_TYPE_ERROR,message:i.message||i.name})}}async unmuteVideo(){var e,t;this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!1),this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!0),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!0),env.IS_SAFARI){const e=null===(t=this._play)||void 0===t?void 0:t.video.containerDom;e&&(e.style.backgroundColor="");}this.muteStatus.video.send=!1,this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!1;}catch(e){this.logger.error("unmuteVideo() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")});}}async muteVideo(){var e,t;this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!0),env.IS_SAFARI){const t=null===(e=this._play)||void 0===e?void 0:e.video.dom;t&&(t.style.backgroundColor="black");}this.getAdapterRef()&&await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.muteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!1),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!1),this.muteStatus.video.send=!0,this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!0;}catch(e){this.logger.error("muteVideo() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")}),this.replaceTags.isMuted=!1;}}async unmuteScreen(){var e;this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteScreen()),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!0),this.muteStatus.screen.send=!1,this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")});}catch(e){this.logger.error("unmuteScreen() 异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")});}}async muteScreen(){var e;this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的辅流轨道`);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteScreen()),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!1),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.send=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")});}catch(e){this.logger.error("muteScreen() ",e.message),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")});}}hasVideo(){return this.logger.log("hasVideo()"),this.mediaHelper.video.videoStream.getVideoTracks().length>0}async setVideoProfile(e){e.resolution>-1&&(this.videoProfile.resolution=e.resolution),e.frameRate>-1&&(this.videoProfile.frameRate=e.frameRate),this.mediaHelper.video.captureConfig.high=this.mediaHelper.convert(this.videoProfile),this.mediaHelper.video.encoderConfig.high.maxBitrate=this.getVideoBW(this.videoProfile)||this.mediaHelper.video.encoderConfig.high.maxBitrate,this.logger.log(`setVideoProfile() options: ${JSON.stringify(e)}, 视频采集参数: ${JSON.stringify(this.mediaHelper.video.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.video.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate;let t=this.mediaHelper.video.cameraTrack;if(this.videoPostProcess.hasAnyTask&&(this.logger.log("setVideoProfile() 侦测到美颜在开启状态"),t=this.videoPostProcess.sourceTrack),t)try{this.logger.log(`setVideoProfile() 尝试动态修改分辨率【${t.label}】`),await applyResolution_1.applyResolution({track:t,targetWidth:this.mediaHelper.video.captureConfig.high.width,targetHeight:this.mediaHelper.video.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const e=t.getSettings();e.width&&e.height&&(this.mediaHelper.video.cameraConstraint.video.width=e.width,this.mediaHelper.video.cameraConstraint.video.height=e.height);}catch(e){this.logger.error("setVideoProfile() 无法设置动态分辨率:",e.name,e.message);}const i=this.getSender("video","high");if(i){const e=i.getParameters(),t=e.encodings&&e.encodings[0];if((null==t?void 0:t.maxBitrate)!==this.mediaHelper.video.encoderConfig.high.maxBitrate){this.logger.log(`setVideoProfile() 调整上行码率 ${t.maxBitrate} => ${this.mediaHelper.video.encoderConfig.high.maxBitrate}`),t.maxBitrate=this.mediaHelper.video.encoderConfig.high.maxBitrate;try{i.setParameters(e);}catch(e){this.logger.warn("setVideoProfile() 无法调整上行码率: ",e.name,e.message);}}}this.client.apiFrequencyControl({name:"setVideoProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)}),this.replaceCanvas();}setVideoEncoderConfiguration(e){if(e.mediaType=e.mediaType||"video",e.streamType=e.streamType||"high",this.logger.log("setVideoEncoderConfiguration() 自定义视频编码配置: ",e),this.mediaHelper[e.mediaType].encoderConfig[e.streamType]){if(e.maxBitrate){const t=1e3*e.maxBitrate;this.logger.log(`setVideoEncoderConfiguration() 设置maxBitrate ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate} => ${t}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate=t;}else this.logger.log("setVideoEncoderConfiguration:未设定maxBitrate。保留目前的值: ",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate);"string"==typeof e.contentHint?(this.logger.log(`setVideoEncoderConfiguration: 应用 contentHint ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint} => ${e.contentHint}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint=e.contentHint):this.logger.log("setVideoEncoderConfiguration: 未设定 contentHint。保留目前的值：",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint);}else this.logger.warn("setVideoEncoderConfiguration() 无法识别的媒体类型：",e.mediaType,e.streamType);this.getSender(e.mediaType,e.streamType)&&this.applyEncoderConfig(e.mediaType,e.streamType),this.client.apiFrequencyControl({name:"setVideoEncoderConfiguration",code:0,param:{streamID:this.stringStreamID,options:e}});}async replaceTrack(e){let t,i=!1,r=!1,s="video";if("screen"===e.mediaType)r=this.mediaHelper.screen.preProcessingEnabled,s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("screen"),this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint));else if("video"===e.mediaType){const r=this.mediaHelper.video.preProcessingEnabled;s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("video"),this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("replaceTrack() 应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"));}if(!t)return this.logger.error(`replaceTrack() ${e.mediaType} 当前没有可替换的流`),null;if(this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track),r)this.mediaHelper.enablePreProcessing(s);else {const t=this.getSender(e.mediaType,"high");t&&(t.replaceTrack(e.track),this.logger.log(`replaceTrack() ${e.mediaType} 成功替换上行`));}return this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}hasScreen(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0}setScreenProfile(e){e.frameRate>-1&&(this.screenProfile.frameRate=e.frameRate),e.resolution>-1&&(this.screenProfile.resolution=e.resolution),this.mediaHelper.screen.captureConfig.high=this.mediaHelper.convert(this.screenProfile),this.mediaHelper.screen.encoderConfig.high.maxBitrate=this.getVideoBW(this.screenProfile),this.logger.log(`setScreenProfile() profile: ${JSON.stringify(e)}, 屏幕共享采集参数: ${JSON.stringify(this.mediaHelper.screen.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.screen.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.screenQuality=e,this.mediaHelper.screen.screenVideoTrack&&applyResolution_1.applyResolution({track:this.mediaHelper.screen.screenVideoTrack,targetWidth:this.mediaHelper.screen.captureConfig.high.width,targetHeight:this.mediaHelper.screen.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const t=this.getSender("screen","high");if(t){const e=t.getParameters(),i=e.encodings&&e.encodings[0];if((null==i?void 0:i.maxBitrate)!==this.mediaHelper.screen.encoderConfig.high.maxBitrate){this.logger.log(`setScreenProfile() 调整上行码率 ${i.maxBitrate} => ${this.mediaHelper.screen.encoderConfig.high.maxBitrate}`),i.maxBitrate=this.mediaHelper.screen.encoderConfig.high.maxBitrate;try{t.setParameters(e);}catch(e){this.logger.error("setScreenProfile() 无法调整上行码率",e.name,e.message);}}}this.client.apiFrequencyControl({name:"setScreenProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)});}getSender(e,t){var i,r,s;const a=null===(s=null===(r=null===(i=this.getAdapterRef())||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._sendTransport)||void 0===s?void 0:s.handler._pc;let o=null;return a&&("audio"===e&&(o="high"===t?a.audioSender:null),"video"===e?o="high"===t?a.videoSender:a.videoSenderLow:"screen"===e?o="high"===t?a.screenSender:a.screenSenderLow:"audioSlave"===e&&(o=a.audioSlaveSender)),o||null}applyEncoderConfig(e,t){let i=this.mediaHelper[e].encoderConfig[t].maxBitrate;if(!i)return;let r=this.getSender(e,t);if(!r)return void this.logger.error("localStream.applyEncoderConfig: cannot find sender for ",e,t);let s=this.mediaHelper[e].encoderConfig[t].contentHint;"string"==typeof s&&r.track&&r.track.contentHint!==s&&(this.logger.log(`applyEncoderConfig 应用 contentHint：${e} ${t} ${r.track.contentHint} => ${s}`),r.track.contentHint=s);const a=r.getParameters();let o=void 0;a.encodings&&a.encodings.length?(o=a.encodings[0].maxBitrate,a.encodings[0].maxBitrate=i):a.encodings=[{maxBitrate:i}],r.setParameters(a).then(()=>{this.logger.log(`最大编码码率：${e} ${t} ${o?o+"=>":""}${i}`);}).catch(r=>{this.logger.error(`应用最大编码码率失败：${e} ${t} ${i}`,a,r.name,r.message);});}getVideoBW(e){return e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?14e4:22e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?5e5:75e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?113e4:171e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?208e4:315e4:(this.logger.warn("发现不支持的 NERTC_VIDEO_QUALITY "+e.resolution),8e5)}async takeSnapshot(e){var t,i,r,s;let a,o;const n=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(n||d?(this.logger.log("takeSnapshot() options: "+JSON.stringify(e)),await this._play.takeSnapshot(e,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)})):(o="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",a=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR),a)throw this.logger.error(o),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:o}),null," ")}),new rtcError_1.default({code:a,message:o})}takeSnapshotBase64(e){var t,i,r,s;let a,o;const n=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(n||d){let t=this._play.takeSnapshot(e,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)}),t}if(o="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",a=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR,a)throw this.logger.error(o),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:o}),null," ")}),new rtcError_1.default({code:a,message:o})}getCurrentFrameData(e={mediaType:"video"}){return this._play.getCurrentFrameData(e)}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":if(t.push(this.mediaHelper.audio.audioStream),this.client.adapterRef.remoteStreamMap)for(var i in this.client.adapterRef.remoteStreamMap){const e=this.client.adapterRef.remoteStreamMap[i];t.push(e.mediaHelper.audio.audioStream);}}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_ERROR,message:"localStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流");}stopMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.playMediaRecording: 录制未开始"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.listMediaRecording: 录制未开始"});const t=this._record.getRecordStatus();return "init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.downloadMediaRecording: 录制未开始"});return this._record.download()}startAudioMixing(e){return this.logger.log("startAudioMixing() 开始伴音"),this.mediaHelper.startAudioMixing(e)}stopAudioMixing(){return this.logger.log("stopAudioMixing() 停止伴音"),this.mediaHelper.stopAudioMixing()}pauseAudioMixing(){return this.logger.log("pauseAudioMixing() 暂停伴音"),this.mediaHelper.pauseAudioMixing()}resumeAudioMixing(){return this.logger.log("resumeAudioMixing() 恢复伴音"),this.mediaHelper.resumeAudioMixing()}adjustAudioMixingVolume(e){return this.logger.log("adjustAudioMixingVolume() 调节伴音音量: ",e),this.mediaHelper.setAudioMixingVolume(e)}getAudioMixingDuration(){return this.logger.log("getAudioMixingDuration() 获取伴音总时长"),this.mediaHelper.getAudioMixingTotalTime()}getAudioMixingCurrentPosition(){return this.mediaHelper.getAudioMixingPlayedTime()}setAudioMixingPosition(e){return this.logger.log("setAudioMixingPosition() 设置伴音音频文件的播放位置: ",e),this.mediaHelper.setAudioMixingPlayTime(e)}async playEffect(e){return this.logger.log("playEffect() 开始播放音效: ",JSON.stringify(e,null," ")),this.mediaHelper.playEffect(e)}async stopEffect(e){return this.logger.log("stopEffect() 停止播放音效: ",e),this.mediaHelper.stopEffect(e)}async pauseEffect(e){return this.logger.log("pauseEffect() 暂停播放音效：",e),this.mediaHelper.pauseEffect(e)}async resumeEffect(e){return this.logger.log("resumeEffect() 恢复播放音效文件: ",e),this.mediaHelper.resumeEffect(e)}async setVolumeOfEffect(e,t){return this.logger.log(`setVolumeOfEffect() 调节 ${e} 音效文件音量为: ${t}`),this.mediaHelper.setVolumeOfEffect(e,t)}async preloadEffect(e,t){return this.logger.log(`preloadEffect() 预加载 ${e} 音效文件地址: ${t}`),this.mediaHelper.preloadEffect(e,t)}async unloadEffect(e){return this.logger.log("unloadEffect() 释放指定音效文件 "+e),this.mediaHelper.unloadEffect(e)}getEffectsVolume(){return this.logger.log("getEffectsVolume() 获取所有音效文件播放音量"),this.mediaHelper.getEffectsVolume()}setEffectsVolume(e){return this.logger.log("setEffectsVolume() 设置所有音效文件播放音量:",e),this.mediaHelper.setEffectsVolume(e)}async stopAllEffects(){return this.logger.log("stopAllEffects() 停止播放所有音效文件"),this.mediaHelper.stopAllEffects()}async pauseAllEffects(){return this.logger.log("pauseAllEffects() 暂停播放所有音效文件"),this.mediaHelper.pauseAllEffects()}async resumeAllEffects(){return this.logger.log("resumeAllEffects() 恢复播放所有音效文件"),this.mediaHelper.resumeAllEffects()}getAudioEffectsDuration(e){return this.logger.log("getAudioEffectsDuration() 获取音效总时长"),this.mediaHelper.getAudioEffectsTotalTime(e)}getAudioEffectsCurrentPosition(e){return this.mediaHelper.getAudioEffectsPlayedTime(e)}setCanvasWatermarkConfigs(e){if(this._play){let t="screen"===e.mediaType?this._play.screen.canvasWatermark:this._play.video.canvasWatermark;if(!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});t.checkWatermarkParams(e),t.updateWatermarks(e),this.canvasWatermarkOptions=e,this.client.apiFrequencyControl({name:"setLocalCanvasWatermarkConfigs",code:0,param:{streamID:this.stringStreamID,isRemote:!1,mediaType:e.mediaType}});}else this.logger.error("setCanvasWatermarkConfigs: 播放器未初始化");}setEncoderWatermarkConfigs(e){var t,i;if(this._play&&this._play){const r=e.mediaType||"video",s=this._play[r].encoderWatermark;if(!s)return void this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化",e.mediaType);(null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||e.timestampWatermarks||(null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)?(s.handler.enabled=!0,this.mediaHelper[r].preProcessingEnabled||this.mediaHelper.enablePreProcessing(r)):(s.handler.enabled=!1,this.mediaHelper.canDisablePreProcessing(r)&&this.mediaHelper.disablePreProcessing(r));const a={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>a.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${a.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>a.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${a.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});s.checkWatermarkParams(e),s.updateWatermarks(e),this.encoderWatermarkOptions=e,this.client.apiFrequencyControl({name:"setEncoderWatermarkConfigs",code:0,param:JSON.stringify(e,null,2)});}else this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化");}getMuteStatus(e){return "audio"===e?{muted:this.muteStatus.audio.send}:"video"===e?{muted:this.muteStatus.video.send}:{muted:this.muteStatus.screen.send}}WebGLSupportError(){if(0===this.videoPostProcess.availableCode)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:"当前环境不支持 WebGL"})}setBeautyEffectOptions(e){if(this.logger.log("set basic beauty parameters:",e),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");for(const t in e)try{e[t]=Math.min(Math.max(parseFloat(e[t]+""),0),1);}catch(i){e[t]=0,this.logger.error("setBeautyEffectOptions:"+i.message);}this.lastEffects=Object.assign(Object.assign({},this.lastEffects),e),this.basicBeauty.setBeautyOptions(e);}}async setBeautyEffect(e,t=!1){if(this.logger.log((e?"start":"close")+" basic beauty."),this.WebGLSupportError(),e&&this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);const i=this.basicBeauty;if(!t){if(e&&i.isEnable)return this.logger.warn("basic beauty is already opened");if(!e&&!i.isEnable)return this.logger.warn("basic beauty is already closed")}if(this.videoPostProcessTags.isBeautyTrack=e,this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let r=0;try{this._transformedTrack=await i.setBeauty(e,this._cameraTrack),await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1});}catch(e){r=-1,this.logger.error("setBeautyEffect:"+e.message);}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),e&&0===r){let e;e=this.lastEffects?this.lastEffects:{brightnessLevel:0,rednessLevel:0,smoothnessLevel:0},i.setBeautyOptions(e);}t||this.client.apiFrequencyControl({name:"setBeautyEffect",code:r,param:{streamID:this.stringStreamID,isRemote:!1,isEnable:e}});}else this.logger.log("setBeautyEffect:video track not ready.");}setFilter(e,t){if(this.logger.log("set beauty filter parameters:"+JSON.stringify([e,t])),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");try{void 0!==t&&(t=Math.min(Math.max(parseFloat(t+""),0),1));}catch(e){t=void 0,this.logger.error("setFilter:"+e.message);}this.lastFilter=e,this.basicBeauty.setFilter(e,t);}}async enableBodySegment(){if(this.logger.log("start virtual background."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);if(!this.videoPostProcess.getPlugin("VirtualBackground"))throw this.logger.error("virtual background plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"virtual background plugin is not register"});if(this._segmentProcessor)return this.logger.warn("virtual background is already opened.");this._segmentProcessor=this.virtualBackground,this._segmentProcessor.init(),this._segmentProcessor.once("segment-load",async()=>{var e;let t=0;try{await this._startBodySegment();}catch(i){null===(e=this._segmentProcessor)||void 0===e||e.destroy(),this._segmentProcessor=null,t=-1,this.logger.error("enableBodySegment:"+i.message);}this.client.apiFrequencyControl({name:"enableBodySegment",code:t,param:{streamID:this.stringStreamID}});}),env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when background-segmentation is enabled.");}async disableBodySegment(){if(this.logger.log("close virtual background."),this.WebGLSupportError(),this._segmentProcessor){let e=0;try{await this._cancelBodySegment(),this._segmentProcessor.destroy(),this._segmentProcessor=null;}catch(t){e=-1,this.logger.error("disableBodySegment:"+t.message);}this.client.apiFrequencyControl({name:"disableBodySegment",code:e,param:{streamID:this.stringStreamID}});}else this.logger.warn("virtual background is already closed.");}async _startBodySegment(){this.videoPostProcess.availableCode<2||this._segmentProcessor&&(await this.transformTrack(!0,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!0);}async _cancelBodySegment(){this.videoPostProcess.availableCode<1||this._segmentProcessor&&(await this.transformTrack(!1,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!1);}setBackground(e){this.logger.log("set virtual background parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.virtualBackground.isEnable||this.logger.warn("virtual background is not opened."),this.virtualBackground.setVirtualBackGround(e));}setBackGround(e){this.setBackground(e);}async enableAdvancedBeauty(e){if(this.logger.log("start advanced beauty."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);if(!this.videoPostProcess.getPlugin("AdvancedBeauty"))throw this.logger.error("advanced beauty plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"advanced beauty plugin is not register"});if(this._advancedBeautyProcessor)return this.logger.warn("advanced beauty is already opened.");this._advancedBeautyProcessor=this.advancedBeauty,this._advancedBeautyProcessor.init(e),this._advancedBeautyProcessor.once("facePoints-load",async()=>{var e;let t=0;try{await this._startAdvancedBeauty();}catch(i){null===(e=this._advancedBeautyProcessor)||void 0===e||e.destroy(),this._advancedBeautyProcessor=null,t=-1,this.logger.error("enableAdvancedBeauty:"+i.message);}this.client.apiFrequencyControl({name:"enableAdvancedBeauty",code:t,param:{streamID:this.stringStreamID}});}),env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when advanced-beauty is enabled.");}async disableAdvancedBeauty(){if(this.logger.log("close advanced beauty."),this.WebGLSupportError(),this._advancedBeautyProcessor){let e=0;try{await this._cancelAdvancedBeauty(),this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null;}catch(t){e=-1,this.logger.error("disableAdvancedBeauty:"+t.message);}this.client.apiFrequencyControl({name:"disableAdvancedBeauty",code:e,param:{streamID:this.stringStreamID}});}else this.logger.warn("advanced beauty is already closed.");}async _startAdvancedBeauty(){this.videoPostProcess.availableCode<2||this._advancedBeautyProcessor&&(await this.transformTrack(!0,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!0);}async _cancelAdvancedBeauty(){this.videoPostProcess.availableCode<1||this._advancedBeautyProcessor&&(await this.transformTrack(!1,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!1);}async enableAIDenoise(){if(!this.supportAIDenoise)return this.logger.warn("Unsupport ai denoise. Please check your plugin version"),!1;let e;if(this.logger.log("start ai denoise."),this.mediaHelper.audio.stageAIProcessing){if(e=this.mediaHelper.audio.stageAIProcessing,e.enabled&&"INITED"===e.state)return this.logger.warn("ai denoise is already opened."),!0}else {const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e;}if(!e.hasPlugin("AIDenoise"))throw this.logger.error("AIDenoise plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"AIDenoise plugin is not register"});return e.enabled=!0,"UNINIT"===e.state&&await e.init(),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio(),this.client.apiFrequencyControl({name:"enableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!0}async disableAIDenoise(){this.logger.log("close ai denoise.");const e=this.mediaHelper.audio.stageAIProcessing;return e?e.enabled?(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),this.client.apiFrequencyControl({name:"disableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!1):(this.logger.warn("ai denoise is already closed."),!0):(this.logger.warn("disableAIDenoise: ai denoise is not created"),!0)}async replacePluginTrack(e){if(this.videoPostProcess.availableCode<1)return;let t,i=!1;if("screen"===e.mediaType?(this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint))):"video"===e.mediaType&&(this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint))),!t)return this.logger.error(`replaceTrack ${e.mediaType} 当前没有可替换的流`),null;this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track);const r=this.getSender(e.mediaType,"high");return r&&(r.replaceTrack(e.track),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行`)),this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}async transformTrack(e,t){if(!(this.videoPostProcess.availableCode<1)&&t)if(this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let i=null;try{this._transformedTrack=await t.setTrack(e,this._cameraTrack),this._transformedTrack&&await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1});}catch(e){i=e;}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),i)throw i}else this.logger.log("transformTrack:video track not ready.");}async registerPlugin(options){if(this.logger.log("register plugin:"+options.key),!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});if(this.videoPostProcess.getPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`);const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing&&stageAIProcessing.hasPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),!1;let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",()=>{if(this.logger.log(`plugin ${options.key} loaded`),-1!==plugin_list_1.videoPlugins.indexOf(options.key))this.WebGLSupportError(),this.videoPostProcess.registerPlugin(options.key,plugin);else {if(-1===plugin_list_1.audioPlugins.indexOf(options.key))throw new Error("unsupport plugin "+options.key);if("AIDenoise"===options.key){let e;if(this.mediaHelper.audio.stageAIProcessing)e=this.mediaHelper.audio.stageAIProcessing;else {const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e;}e.registerPlugin(options.key,plugin,options.wasmUrl);}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}});}),plugin.once("plugin-load-error",()=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}});}),plugin.once("error",e=>{"AIDenoise"==options.key&&(this.supportAIDenoise=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${e}。`}});});}catch(e){throw this.emit("plugin-load-error",{key:options.key,msg:e}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:e}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:e.message})}}async unregisterPlugin(e){if(this.logger.log("unRegister plugin:"+e),-1===plugin_list_1.audioPlugins.indexOf(e))this.WebGLSupportError(),this.videoPostProcess&&("VirtualBackground"===e&&this._segmentProcessor?await this.disableBodySegment():"AdvancedBeauty"===e&&this._advancedBeautyProcessor&&await this.disableAdvancedBeauty(),this.videoPostProcess.unregisterPlugin(e));else if("AIDenoise"===e){const e=this.mediaHelper.audio.stageAIProcessing;e&&(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),e.unregisterAIDenoise(),this.mediaHelper.audio.stageAIProcessing=null);}}async suspendVideoPostProcess(){if(this.videoPostProcess.availableCode<1)return;const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!1,!0),this.videoPostProcessTags.isBeautyTrack=!0),t&&(await this._cancelBodySegment(),this.videoPostProcessTags.isBodySegmentTrack=!0),i&&(await this._cancelAdvancedBeauty(),this.videoPostProcessTags.isAdvBeautyTrack=!0);}async resumeVideoPostProcess(){if(!(this.videoPostProcess.availableCode<1))try{const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!0,!0),this.lastEffects&&this.setBeautyEffectOptions(this.lastEffects),this.lastFilter&&this.setFilter(this.lastFilter)),t&&await this._startBodySegment(),i&&await this._startAdvancedBeauty();}catch(e){this.logger.log("开启失败: "+e);}}async replaceCanvas(){var e,t;if(this.videoPostProcess.availableCode<1)return;if(!this._play)return;if(!env.IS_ANY_SAFARI)return;if(env.SAFARI_VERSION&&parseFloat(env.SAFARI_VERSION)>15.2)return;const i=null===(e=this._play.video.dom)||void 0===e?void 0:e.querySelector("video"),r=this._play.video.containerDom;if(i&&r){const e=this.videoPostProcess.filters,s=this.videoPostProcess.video,a=this.replaceTags.videoPost,o=this.replaceTags.waterMark;if(a){const t=e.canvas;if(t.style.height="0px",t.style.width="0px",document.body.appendChild(t),env.SAFARI_MAJOR_VERSION<14&&s&&(s.style.height="0px",s.style.width="0px",document.body.appendChild(s)),o||e.canvas.parentElement===r)o&&(i.style.display="");else {const t=e.canvas;i.style.display="none",t.style.position="absolute";const s=r.getBoundingClientRect(),a=s.width/s.height,o=t.width/t.height,{width:n,height:d,cut:c}=this.renderMode.local.video,l=n/d;if(c)if(l>o){t.style.width="100%",t.style.left="0px";const e=s.width/o/s.height;t.style.height=100*e+"%",t.style.top=50*-(e-1)+"%";}else {t.style.height="100%",t.style.top="0px";const e=s.height*o/s.width;t.style.width=100*e+"%",t.style.left=50*-(e-1)+"%";}else if(a>o){t.style.height="100%",t.style.top="0px";const e=s.height*o/s.width;t.style.width=100*e+"%",t.style.left=50*(1-e)+"%";}else {t.style.width="100%",t.style.left="0px";const e=s.width/o/s.height;t.style.height=100*e+"%",t.style.top=50*(1-e)+"%";}r.appendChild(e.canvas);}}else i.style.display="",null===(t=e.canvas.parentNode)||void 0===t||t.removeChild(e.canvas);}}loseContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.loseContext();}catch(e){}}restoreContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.restoreContext();}catch(e){}}getNativeDom(e){const t=this[e],i=this._play[e].dom;return t&&i||this.logger.warn("No local "+e),i}async destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!1}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset(),this.destroyed=!0,this.lastEffects=null,this.lastFilter=null,this._segmentProcessor&&(this._segmentProcessor.destroy(),this._segmentProcessor=null),this._advancedBeautyProcessor&&(this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null),this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.videoPostProcess.destroy());}}exports.LocalStream=LocalStream;},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}});}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i];}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t});}:function(e,t){e.default=t;}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(10),d=a(i(24)),c=o(i(298)),l=i(299);class u extends n.EventEmitter{constructor(e){super(),this.pluginModules={VirtualBackground:null,AdvancedBeauty:null},this.isAlive=!0,this.filters=null,this.video=null,this.frameRate=15,this.timerId=-1,this.taskSet=new Set,this.taskSnapshot=new Set,this.readyTaskSet=new Set(["BasicBeauty"]),this.sourceMap=null,this.maskData=null,this.advBeautyData=[],this.sourceTrack=null,this.trackInstance=null,this.videoSizeTag="",this.frameCount=[0,0],this.update=(e=!0)=>{if(this.availableCode<2)return;if(d.IS_ANY_SAFARI&&"hidden"===document.visibilityState)return;const t=this.filters;if(!this.taskSet.size)return t?t.update(!1):c.default.clearTimeout(this.timerId);if(e&&(this.frameCount[0]+=1),this.taskReady){let e=!1,i=!1;if(this.taskSet.has("VirtualBackground")&&(t.virtualBackground.setMaskMap(this.maskData),this.maskData=null,e=!0,i=!0),this.taskSet.has("AdvancedBeauty")?(t.advBeauty.setAdvData(this.advBeautyData),this.advBeautyData=[],e=!0):i=!1,this.taskSnapshot=new Set(this.taskSet),this.readyTaskSet.clear(),this.readyTaskSet.add("BasicBeauty"),this.frameCount[1]=this.frameCount[0],e?(t.update(!1),this.sourceMap=t.normal.getImageData(t.srcMap)):t.update(!0),this.taskSet.has("VirtualBackground")){const e=this.pluginModules.VirtualBackground;if(e){const{width:r,height:s}=t.canvas;r>16&&s>16?e.process(i?this.sourceMap.slice():this.sourceMap,r,s,e=>{const t=(e.data||e).length;this.maskData=this.taskSet.has("VirtualBackground")&&t>0?e:null,this.readyTaskSet.add("VirtualBackground"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1));},d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104):this.readyTaskSet.add("VirtualBackground");}}if(this.taskSet.has("AdvancedBeauty")){const e=this.pluginModules.AdvancedBeauty;if(e){const{width:i,height:r}=t.canvas;e.process(this.sourceMap,i,r,e=>{this.advBeautyData=this.taskSet.has("AdvancedBeauty")?e:[],this.readyTaskSet.add("AdvancedBeauty"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1));},d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104);}}}},this.setTaskAndTrack=(e,t,i)=>new Promise((r,s)=>{if(this.availableCode<1)return s(this.glErrorTip);if(t){if(this.hasTask(e))return r(this.track);this.createTrack(i).then(t=>{this.addTask(e),setTimeout(()=>{r(this.track);},t);}).catch(e=>{s(e);});}else {if(!this.hasTask(e))return r(this.track);this.removeTask(e),r(this.track);}}),this.logger=e;try{this.filters=new l.Filters;const e=this.filters.canvas;e.addEventListener("webglcontextlost",e=>{e.preventDefault(),this.emit("contextLost");},!1),e.addEventListener("webglcontextrestored",e=>{var t;e.preventDefault();let i=!0;this.filters=(null===(t=this.filters)||void 0===t?void 0:t.clone())||null,this.filters||(i=!1),this.emit("contextRestored",i);},!1);}catch(e){}}registerPlugin(e,t){this.pluginModules[e]=t;}getPlugin(e){return this.pluginModules[e]}unregisterPlugin(e){this.pluginModules[e]=null;}get availableCode(){return this.isAlive?this.filters&&this.filters.gl?this.filters.gl.isContextLost()?1:2:0:-1}get glErrorTip(){switch(this.availableCode){case-1:return "localStream is already destroyed.";case 0:return "the current environment does not support webgl.";case 1:return "webgl context has been lost."}return ""}get taskReady(){for(const e of this.taskSnapshot)if(!this.readyTaskSet.has(e))return !1;return !0}addTask(e){this.taskSet.has(e)||(this.taskSet.add(e),this.logger.log(`task ${e} is added.`),this.update(),1===this.taskSet.size&&(this.updateTimer(),this.emit("taskSwitch",!0)));}removeTask(e){var t;this.taskSet.delete(e),this.logger.log(`task ${e} is removed.`),0===this.taskSet.size&&(c.default.clearTimeout(this.timerId),this.timerId=-1,this.sourceMap=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.emit("taskSwitch",!1)),this.update(),this.taskSnapshot.delete(e);}hasTask(e){return this.taskSet.has(e)}get hasAnyTask(){return this.taskSet.size>0}videoSizeChange(e,t){if(d.IS_ANY_SAFARI&&this.filters){const i=`${e}-${t}`;this.videoSizeTag!==i&&(this.videoSizeTag=i,this.emit("safariVideoSizeChange"));}}createTrack(e){return new Promise((t,i)=>{var r,s;if(this.trackInstance&&this.trackInstance===e)return this.logger.log("VideoPostProcess track transform unnecessary"),t(0);this.logger.log("VideoPostProcess track transform");const a=e.getSettings();this.frameRate=a.frameRate||15,this.frameRate>30&&(this.logger.warn("In chrome, webgl drawing video which framerate greater than 30fps may cause memory leak."),this.frameRate=30),this.sourceTrack=e,this.trackInstance&&(this.trackInstance.stop(),this.trackInstance=null),a.width&&a.height&&(null===(r=this.filters)||void 0===r||r.setSize(a.width,a.height),this.videoSizeTag||(this.videoSizeTag=`${a.width}-${a.height}`));const o=(null===(s=this.filters)||void 0===s?void 0:s.canvas).captureStream(this.frameRate);this.trackInstance=o.getVideoTracks()[0],this.video=this.video||document.createElement("video");const n=new MediaStream([this.sourceTrack]);this.video.srcObject=n;const d=e=>{var t;const{videoWidth:i,videoHeight:r}=e;null===(t=this.filters)||void 0===t||t.setSize(i,r),this.videoSizeChange(i,r);};this.video.onloadedmetadata=()=>{this.video.play().then(()=>{this.filters.mapSource=this.video,d(this.video),t(0);}).catch(e=>{i(e);});},this.video.onresize=()=>{d(this.video);};})}get track(){return this.taskSet.size?(this.logger.log("return video post procss track."),this.trackInstance):(this.logger.log("return origin track."),this.sourceTrack)}updateTimer(){c.default.clearTimeout(this.timerId),this.timerId=c.default.setTimeout(()=>{this.updateTimer(),this.update();},1e3/(1.1*this.frameRate),null);}destroy(){var e,t,i;this.isAlive=!1,c.default.clearTimeout(this.timerId),this.removeAllListeners(),this.taskSet.clear(),this.readyTaskSet.clear(),this.taskSnapshot.clear(),null===(e=this.sourceTrack)||void 0===e||e.stop(),this.sourceTrack=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.video=null,null===(i=this.filters)||void 0===i||i.destroy(),this.filters=null,this.sourceMap=null,this.maskData=null,this.advBeautyData=null,this.pluginModules=null,this.frameCount=[0,0];}}t.default=u;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(128);const s=new class{constructor(){this.id=0,this.callbacks={},this.worker=null;}getWorker(){return this.worker||(this.worker=new Worker(r.getBlobUrl("webWorkerTimer")),this.worker.onmessage=e=>{switch(e.data.message){case"interval:tick":case"timeout:tick":{const t=this.callbacks[e.data.id];t&&t.fn&&t.fn.apply(t.context);break}case"interval:cleared":case"timeout:cleared":delete this.callbacks[e.data.id];}}),this.worker}setInterval(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"interval:start",interval:t,id:r}),r}setTimeout(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"timeout:start",timeout:t,id:r}),r}clearInterval(e){this.getWorker().postMessage({command:"interval:clear",id:e});}clearTimeout(e){this.getWorker().postMessage({command:"timeout:clear",id:e});}};t.default=s;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filters=void 0;const r=i(159),s=i(300),a=i(116),o=i(199),n=i(309),d=i(313),c=i(314),l=i(315),u=i(316);class h{constructor(e){this._alive=!0,this.time=-1,this.lastTimer=performance.now(),this.webglLostContext=null,this._renderer=new s.Renderer({canvas:e,antialias:!0}),this.map=a.createTexture(this._renderer.gl,null);const t=this._renderer.gl;this.webglLostContext=t.getExtension("WEBGL_lose_context");const{posArray:i,uvArray:h,advBeautyIndicesArray:p,advBeautyPosArray:m,advBeautyZindexArray:f,advFaceMaskUVArray:g,advEyeTeethPosArray:v,advEyeTeethIndicesArray:y,advEyeTeethZindexArray:S,advEyeTeethUVArray:_}=l.typedArray,R=r.createAttributeBuffer(t,"position",i,2),b=r.createAttributeBuffer(t,"uv",h,2),T=r.createAttributeBuffer(t,"position",m,2),E=r.createAttributeBuffer(t,"zIndex",f,1),A=r.createAttributeBuffer(t,"indices",p,1,"ELEMENT_ARRAY_BUFFER"),w=r.createAttributeBuffer(t,"uv",g,2),I=r.createAttributeBuffer(t,"tPosition",v,2),C=r.createAttributeBuffer(t,"indices",y,1,"ELEMENT_ARRAY_BUFFER"),O=r.createAttributeBuffer(t,"zIndex",S,1),k=r.createAttributeBuffer(t,"uv",_,2);this.advBeauty=new o.AdvBeautyFilter(this._renderer,this.map,T,E,A,w,R,b,I,C,O,k),this.beauty=new n.BeautyFilter(this._renderer,this.map,R,b),this.lut=new d.LutFilter(this._renderer,this.map,R,b),this.normal=new c.NormalFilter(this._renderer,this.map,R,b),this.virtualBackground=new u.VirtualBackFilter(this._renderer,this.map,R,b);}clone(){var e;try{const t=new h(this._renderer.canvas);t.mapSource=(null===(e=this.srcMap)||void 0===e?void 0:e.source)||null,this.advBeauty.remove(),t.advBeauty.presetAdvEffect(Object.assign({},this.advBeauty.params));const i=this.virtualBackground.lastSetInfo;return "bk"===i.type?t.virtualBackground.setBackground(i.value):"blur"===i.type&&t.virtualBackground.setBlurIntensity(i.value),t}catch(e){return null}}get filters(){return [this.advBeauty,this.beauty,this.lut,this.virtualBackground,this.normal]}get canvas(){return this._renderer.canvas}get gl(){return this._renderer.gl}get srcMap(){return this.map}set mapSource(e){const t=this.map;t&&(t.source=e,t.refresh());}get isAlive(){return this._alive}setSize(e,t){this._renderer.setSize(e,t),this.filters.forEach(e=>{e.updateSize();});}render(){const e=this.filters;e[0].map=this.map,e[0].render(),e[1].faceMask=e[0].faceMask,e[1].featureParas=e[0].featureParas;for(let t=1;t<e.length;t++)e[t].map=e[t-1].output,e[t].render();}update(e=!0){var t;if(this._alive){if(this.time<0)this.time=0,this.lastTimer=performance.now();else {const e=performance.now(),t=Math.min(e-this.lastTimer,100);this.lastTimer=e,this.time+=t/1e3;}e&&(null===(t=this.map)||void 0===t||t.refresh()),this.render();}}destroy(){this._alive=!1,this.time=-1;const e=this._renderer.gl;this.filters.forEach(e=>{e.destroy();}),null==e||e.deleteTexture(this.map.glTexture);}}t.Filters=h;},function(e,t,i){var r=this&&this.__rest||function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]]);}return i};Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;const s=i(123);t.Renderer=class{constructor(e){this._gl=null,this._pixelRatio=1,this._viewport={x:0,y:0,width:640,height:480};const t=Object.assign({preserveDrawingBuffer:!0,powerPreference:"high-performance"},e),{canvas:i=document.createElement("canvas"),width:a=640,height:o=480}=t,n=r(t,["canvas","width","height"]);this._canvas=i,this._gl=s.getWebGLContext(i,n);const d=this.setSize(a,o);this.setViewport(0,0,d.width,d.height);}get canvas(){return this._canvas}get gl(){return this._gl}getPixelRatio(){var e;return null!==(e=this._pixelRatio)&&void 0!==e?e:1}setPixelRatio(e){const t=this.getPixelRatio();if(t===e)return;const i=this.getSize();i.width/=t,i.height/=t,this._pixelRatio=e,this.setSize(i.width,i.height);}getSize(){return {width:this.canvas.width,height:this.canvas.height}}setSize(e,t,i=!1){const r=this.canvas,s=this.getPixelRatio();return r.width=e*s,i&&(r.style.width=e+"px"),r.height=t*s,i&&(r.style.height=t+"px"),this.getSize()}getViewport(){return this._viewport}setViewport(e,t,i,r){var s;this._viewport={x:e,y:t,width:i,height:r},null===(s=this.gl)||void 0===s||s.viewport(e,t,i,r);}resize(e,t,i,r){const s=this.setSize(e,t);i&&this.setPixelRatio(i),r?this.setViewport(r.x,r.y,r.width,r.height):this.setViewport(0,0,s.width,s.height);}render(e){if(!this.gl)return;const t=this.gl;t.enable(t.CULL_FACE),e.render();}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultShader=void 0,t.defaultShader={vShader:"\n    attribute vec4 position;\n    void main() {\n        gl_Position = position;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createShader=void 0,t.createShader=function(e,t,i){const r=e.createShader({VERTEX:e.VERTEX_SHADER,FRAGMENT:e.FRAGMENT_SHADER}[i]);if(!r)return console.error(i+"Shader was not created successfully."),null;if(e.shaderSource(r,t),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;const s=t.split("\n").map((e,t)=>`${t+1}${e}`).join("\n");return console.error(`${e.getShaderInfoLog(r)}\n%cshader source code\n${s}\n`,"color: #008040"),e.deleteShader(r),null};},function(e,t,i){function r(e,t,i,r,s,a){var o;if(i===e.FLOAT)return r?i=>e.uniform1fv(t,i):i=>e.uniform1f(t,i);const n={[e.FLOAT_VEC2]:i=>e.uniform2fv(t,i),[e.FLOAT_VEC3]:i=>e.uniform3fv(t,i),[e.FLOAT_VEC4]:i=>e.uniform4fv(t,i)}[i];if(n)return n;if(i===e.INT||i===e.BOOL)return r?i=>e.uniform1iv(t,i):i=>e.uniform1i(t,i);const d={[e.BOOL_VEC2]:e.INT_VEC2,[e.BOOL_VEC3]:e.INT_VEC3,[e.BOOL_VEC4]:e.INT_VEC4},c={[e.INT_VEC2]:i=>e.uniform2iv(t,i),[e.INT_VEC3]:i=>e.uniform3iv(t,i),[e.INT_VEC4]:i=>e.uniform4iv(t,i)}[null!==(o=d[i])&&void 0!==o?o:i];if(c)return c;const l={[e.FLOAT_MAT2]:i=>e.uniformMatrix2fv(t,!1,i),[e.FLOAT_MAT3]:i=>e.uniformMatrix3fv(t,!1,i),[e.FLOAT_MAT4]:i=>e.uniformMatrix4fv(t,!1,i)}[i];if(l)return l;if(i===e.SAMPLER_2D||i===e.SAMPLER_CUBE){const o=i===e.SAMPLER_2D?e.TEXTURE_2D:e.TEXTURE_CUBE_MAP;if(r){const i=[];for(let e=0;e<s;e++)i.push(a.value++);return r=>{e.uniform1iv(t,i),r.forEach((t,r)=>{var s;e.activeTexture(e.TEXTURE0+i[r]),e.bindTexture(o,null!==(s=null==t?void 0:t.glTexture)&&void 0!==s?s:null);});}}{const i=a.value++;return r=>{var s;e.uniform1i(t,i),e.activeTexture(e.TEXTURE0+i),e.bindTexture(o,null!==(s=null==r?void 0:r.glTexture)&&void 0!==s?s:null);}}}return ()=>{console.warn("no matching uniform setter.");}}Object.defineProperty(t,"__esModule",{value:!0}),t.parseUniforms=void 0,t.parseUniforms=function(e,t){const i={value:0},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),a={};for(let o=0;o<s;o++){const s=e.getActiveUniform(t,o);if(s){const o=s.size>1,n=o?s.name.replace("[0]",""):s.name,d=s.type,c=e.getUniformLocation(t,n);if(null!==c){const t=r(e,c,d,o,s.size,i);a[n]={type:d,size:s.size,value:null,setter:e=>{void 0!==e?a[n].value=e:t(a[n].value);}};}else console.warn(`uniform:[${n}] is null.`);}}return a};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyEyeShader=void 0,t.advBeautyEyeShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform vec2 eyeCenter;\n    uniform vec2 rdDir;\n    uniform float rdIntensity;\n    uniform float lgIntensity;\n    uniform float intensRatio;\n    uniform float range;\n\n    varying vec2 vuv;\n\n    mat3 scaleByNormal(vec2 normal, float k, float refx, float refy){\n        float a = 1.0 + (k - 1.0) * normal.x * normal.x;\n        float b = (k - 1.0) * normal.x * normal.y;\n        float c = 1.0 + (k - 1.0) * normal.y * normal.y;\n        return mat3(\n            a, b, 0.0,\n            b, c, 0.0,\n            (1.0 - a) * refx - b * refy, (1.0 - c) * refy - b * refx, 1.0\n        );\n    }\n\n    vec2 lgEye(vec2 uv, vec2 center, float range, float strength, float powRatio) {\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        vec2 dir = normalize(uv - center);\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        float newDist = dist * scale;\n        return center + newDist * dir;\n    }\n\n    vec2 rdEye(vec2 uv, vec2 center, float range, float strength, float powRatio){\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        return (scaleByNormal(rdDir, scale, center.x, center.y) * vec3(uv, 1.0)).xy;\n    }\n\n    void main() {\n        vec2 uv = vuv;\n        if(intensRatio > 0.0){\n            if(rdIntensity > 0.0){\n                float maxRdIntens = mix(1.0, 0.5, lgIntensity);\n                float rdIntens = mix(0.0, maxRdIntens, rdIntensity * intensRatio);\n                uv = lgEye(uv, eyeCenter, range * 2.0, rdIntens, 0.075);\n                uv = rdEye(uv, eyeCenter, range * 2.0, rdIntens, 0.1);\n            }\n            if(lgIntensity > 0.0){\n                float lgIntens = lgIntensity * intensRatio;\n                uv = lgEye(uv, eyeCenter, range * 2.5, lgIntens, 0.1);\n                uv = rdEye(uv, eyeCenter, range * 2.5, lgIntens, 0.05);\n            }\n        }\n        gl_FragColor = texture2D(map, uv);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyShader=void 0,t.advBeautyShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n    attribute vec2 tPosition;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = position;\n        vec2 ntPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n            ntPos = npos(ntPos);\n        }\n        vec2 ndcPos = ndcpos(ntPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n\n        vuv = nPos;\n        vuv.y = 1.0 - vuv.y;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform float showWire;\n    uniform vec2 size;\n    uniform sampler2D map;\n    uniform sampler2D wireMap;\n    uniform sampler2D eyeTeethMaskMap;\n    uniform sampler2D teethLut;\n    uniform float eyeIntensity;\n    uniform float teethIntensity;\n    varying vec2 vuv;\n\n    vec3 lut64(vec3 color, sampler2D lut){\n        float blue = color.b * 63.0;\n\n        vec2 q1;\n        float fb = floor(blue);\n        q1.y = floor(fb * 0.125);\n        q1.x = fb - (q1.y * 8.0);\n\n        vec2 q2;\n        float cb = ceil(blue);\n        q2.y = floor(cb * 0.125);\n        q2.x = cb - (q2.y * 8.0);\n\n        vec2 t = 0.123 * color.rg + vec2(0.000976563);\n        vec2 t1 = q1 * 0.125 + t;\n        vec3 p1 = texture2D(lut, t1).rgb;\n\n        vec2 t2 = q2 * 0.125 + t;\n        vec3 p2 = texture2D(lut, t2).rgb;\n\n        return mix(p1, p2, fract(blue));\n    }\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        if(eyeIntensity > 0.0 || teethIntensity > 0.0){\n            vec4 eyeTeethMask = texture2D(eyeTeethMaskMap, vuv);\n            float teethInten = eyeTeethMask.r > 0.0 ? teethIntensity * eyeTeethMask.a : 0.0;\n            float eyeInten = eyeTeethMask.g > 0.0 ? eyeIntensity * eyeTeethMask.a : 0.0;\n            if(teethInten>0.0){\n                color.rgb = mix(color.rgb, lut64(color.rgb, teethLut), teethInten);\n            }\n            if(eyeInten>0.0){\n                vec2 step1 = vec2(size.x / 640.0 / size.x, 0.0);\n                vec2 step2 = vec2(0.0, size.y / 480.0 /size.y);\n                vec3 sumColor = vec3(0.0, 0.0, 0.0);\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 2.0 * step2).rgb;\n\n                sumColor = sumColor * 0.04;\n                sumColor = clamp(sumColor + (color.rgb - sumColor) * 2.0, 0.0, 1.0);\n                sumColor = max(color.rgb, sumColor);\n                color.rgb = mix(color.rgb, sumColor, eyeInten);\n                eyeInten = 1.0 + eyeInten * 0.25;\n                color.rgb = (color.rgb - vec3(0.5)) * eyeInten + vec3(0.5);\n            }\n        }\n        if(showWire > 0.5){\n            vec4 wire = texture2D(wireMap, vuv);\n            gl_FragColor = mix(color, wire, wire.a);\n        }else{\n            gl_FragColor = color;\n        }\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyWireShader=void 0,t.advBeautyWireShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = npos(position);\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, 0.0, 1.0);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n    void main() {\n        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advFaceMaskShader=void 0,t.advFaceMaskShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 tPosition;\n    attribute vec2 uv;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n        }\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform int index;\n    varying vec2 vuv;\n\n    void main() {\n      vec4 color = index == 0 ? vec4(0.0) : texture2D(map, vuv);\n      vec4 mask = texture2D(maskMap, vuv);\n      float a = 1.0 - (1.0 - color.a) * (1.0 - mask.a);\n      vec3 rgb = max(color.rgb, mask.rgb);\n      gl_FragColor = vec4(rgb, a);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.handlers=t.preHandle=t.Matrix3x3=t.Vector2=void 0;class r{constructor(e,t){this.value=[0,0],this.value=[e,t];}get x(){return this.value[0]}set x(e){this.value[0]=e;}get y(){return this.value[1]}set y(e){this.value[1]=e;}get lengthPow2(){return Math.pow(this.x,2)+Math.pow(this.y,2)}get length(){return Math.sqrt(this.lengthPow2)}static getVec(e,t){const i=2*t;if(i<0)throw new Error("index out range");const s=i+1;if(s>=e.length)throw new Error("index out range");return new r(e[i],e[s])}static setPoint(e,t,i){const r=2*t;if(r<0)throw new Error("index out range");const s=r+1;if(s>=e.length)throw new Error("index out range");e[r]=i.value[0],e[s]=i.value[1];}static normalize(e){const t=Math.sqrt(e.value[0]*e.value[0]+e.value[1]*e.value[1]);return new r(e.value[0]/t,e.value[1]/t)}static add(e,t){return new r(e.value[0]+t.value[0],e.value[1]+t.value[1])}static sub(e,t){return new r(e.value[0]-t.value[0],e.value[1]-t.value[1])}static scale(e,t){return new r(e.value[0]*t,e.value[1]*t)}static scaleByAxis(e,t,i){return new r(e.x*t,e.y*i)}static disPow2(e,t){const i=e.value,r=t.value,s=i[0]-r[0],a=i[1]-r[1];return s*s+a*a}static dis(e,t){return Math.sqrt(r.disPow2(e,t))}static lerp(e,t,i){if(!e||!t)return e||t;const s=e.value,a=t.value;return new r(s[0]+(a[0]-s[0])*i,s[1]+(a[1]-s[1])*i)}static intersectPoint(e,t,i,s){const a=e.value,o=t.value,n=i.value,d=s.value,c=n[0]-d[0],l=a[0]-o[0],u=n[1]-d[1],h=a[1]-o[1],p=l*u-h*c;if(0==p)return null;const m=a[0]*o[1]-a[1]*o[0],f=n[0]*d[1]-n[1]*d[0];return new r((m*c-l*f)/p,(m*u-h*f)/p)}static center(...e){const t=e.length;if(!t)return new r(0,0);if(1===t)return new r(...e[0].value);if(2===t)return new r((e[0].value[0]+e[1].value[0])/2,(e[0].value[1]+e[1].value[1])/2);let i=0,s=0,a=0;for(let r=t-1,o=0;o<t;r=o,o++){const t=e[r].value,n=e[o].value,d=t[0]*n[1]-n[0]*t[1];i+=d,s+=(n[0]+t[0])*d,a+=(n[1]+t[1])*d;}let o=0,n=0;return 0!=i&&(o=s/(3*i),n=a/(3*i)),new r(o,n)}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t){return e.x*t.y-t.x*e.y}static angle(e,t){const i=r.normalize(e),s=r.normalize(t);return Math.acos(Math.min(1,Math.max(-1,r.dot(i,s))))}static fromToAngle(e,t){return r.cross(e,t)<0?-r.angle(e,t):r.angle(e,t)}}t.Vector2=r;class s{constructor(e,t,i,r,s,a,o,n,d){this.matrix=[[e,t,i],[r,s,a],[o,n,d]];}get a(){return this.matrix[0][0]}set a(e){this.matrix[0][0]=e;}get b(){return this.matrix[1][0]}set b(e){this.matrix[1][0]=e;}get c(){return this.matrix[0][1]}set c(e){this.matrix[0][1]=e;}get d(){return this.matrix[1][1]}set d(e){this.matrix[1][1]=e;}get e(){return this.matrix[0][2]}set e(e){this.matrix[0][2]=e;}get f(){return this.matrix[1][2]}set f(e){this.matrix[1][2]=e;}get transpose(){let e=this.matrix;return new s(e[0][0],e[1][0],e[2][0],e[0][1],e[1][1],e[2][1],e[0][2],e[1][2],e[2][2])}multiplyPoint(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1]+this.matrix[0][2],a=t*this.matrix[1][0]+i*this.matrix[1][1]+this.matrix[1][2],o=t*this.matrix[2][0]+i*this.matrix[2][1]+this.matrix[2][2];return new r(s/o,a/o)}multiplyVector(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1],a=t*this.matrix[1][0]+i*this.matrix[1][1];return new r(s,a)}static identity(){return new s(1,0,0,0,1,0,0,0,1)}static rotate(e,t,i){let r=Math.cos(e),a=Math.sin(e),o=s.identity();return o.matrix[0][0]=r,o.matrix[0][1]=-a,o.matrix[1][0]=a,o.matrix[1][1]=r,o.matrix[0][2]=t*(1-r)+i*a,o.matrix[1][2]=i*(1-r)-t*a,o}static scaleByNormal(e,t,i,a){e=r.normalize(e);let o=1+(t-1)*Math.pow(e.x,2),n=(t-1)*e.x*e.y,d=1+(t-1)*Math.pow(e.y,2);return new s(o,n,(1-o)*i-n*a,n,d,(1-d)*a-n*i,0,0,1)}}t.Matrix3x3=s;let a,o,n=!0;t.preHandle=e=>{a=r.getVec(e,74),o=r.getVec(e,77);},t.handlers={eyeAngle:(e,t)=>{const i=.06*(t-.5)*Math.PI,n=s.rotate(i,a.x,a.y);[52,53,54,55,56,57,72,73].forEach(t=>{const i=n.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i);});const d=s.rotate(-i,o.x,o.y);[58,59,60,61,62,63,75,76].forEach(t=>{const i=d.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i);});},openCanthus:(e,t)=>{t*=.05;const i=r.getVec(e,43),s=r.getVec(e,46);let a=r.getVec(e,55),o=r.getVec(e,58);const n=r.intersectPoint(i,s,a,o)||i;a=r.lerp(a,n,t),o=r.lerp(o,n,t),r.setPoint(e,55,a),r.setPoint(e,58,o),[54,56,59,63].forEach(i=>{let s=r.getVec(e,i);s=r.lerp(s,i<57?a:o,.05*t),r.setPoint(e,i,s);});},eyeDistance:(e,t)=>{t=.1*(t-.5);const i=r.getVec(e,43),s=r.scale(r.sub(a,i),t),n=r.scale(r.sub(o,i),t);[52,53,54,55,56,57,72,73,74].forEach(t=>{const i=r.add(r.getVec(e,t),s);r.setPoint(e,t,i);}),[58,59,60,61,62,63,75,76,77].forEach(t=>{const i=r.add(r.getVec(e,t),n);r.setPoint(e,t,i);}),a=r.getVec(e,74),o=r.getVec(e,77);},roundedEye:(e,t)=>(n=!1,a=r.center(...[52,53,54,55,56,57,72,73].map(t=>r.getVec(e,t))),o=r.center(...[58,59,60,61,62,63,75,76].map(t=>r.getVec(e,t))),{lEyeCenter:a,rEyeCenter:o}),enlargeEye:(e,t)=>(n?(a=r.center(...[52,53,54,55,56,57,72,73].map(t=>r.getVec(e,t))),o=r.center(...[58,59,60,61,62,63,75,76].map(t=>r.getVec(e,t)))):n=!0,{lEyeCenter:a,rEyeCenter:o}),shrinkNose:(e,t)=>{t*=.15;const i=r.getVec(e,46);[80,81,82,83].forEach(s=>{r.setPoint(e,s,r.lerp(r.getVec(e,s),i,t));});const s=r.getVec(e,49);[47,51].forEach(i=>{r.setPoint(e,i,r.lerp(r.getVec(e,i),s,t));});},lengthenNose:(e,t)=>{t=.25*(t-.5);const i=[80,81,82,83,47,51],s=r.getVec(e,46),a=[];i.forEach(t=>{a.push(r.sub(r.getVec(e,t),s));});const o=r.getVec(e,49),n=r.lerp(o,r.getVec(e,87),t);r.setPoint(e,49,n);const d=r.sub(n,o),c=r.add(s,d);r.setPoint(e,46,c),a.forEach((t,s)=>{const a=r.add(c,t);r.setPoint(e,i[s],a);});},shrinkMouth:(e,t)=>{const i=1+.25*(t-=.65),s=1+.2*t,a=[1,.7,.2,0,.2,.7,1,.66,.33,0,.33,.66],o=[1,.66,0,.66,1,.66,0,.66],n=[84,85,86,87,88,89,90,91,92,93,94,95],d=[96,97,98,99,100,101,102,103],c=[],l=[];n.forEach(t=>{c.push(r.getVec(e,t));}),d.forEach(t=>{l.push(r.getVec(e,t));});const u=r.center(...c);c.forEach((t,o)=>{const d=a[o],c=i*d+s*(1-d);r.setPoint(e,n[o],r.add(u,r.scale(r.sub(t,u),c)));}),l.forEach((t,a)=>{const n=o[a],c=i*n+s*(1-n);r.setPoint(e,d[a],r.add(u,r.scale(r.sub(t,u),c)));});},widenMouth:(e,t)=>{t-=.5,t*=t<0?.3:.2;const i=r.getVec(e,90),a=r.getVec(e,84),o=r.getVec(e,87),n=r.getVec(e,93),d=r.intersectPoint(i,a,o,n)||r.center(o,n),c=s.scaleByNormal(r.sub(d,a),t+1,d.x,d.y),l=s.scaleByNormal(r.sub(d,i),t+1,d.x,d.y);[84,96,85,95,97,103,86,94].forEach(t=>{r.setPoint(e,t,c.multiplyPoint(r.getVec(e,t)));}),[90,100,89,91,99,101,88,92].forEach(t=>{r.setPoint(e,t,l.multiplyPoint(r.getVec(e,t)));});},mouthCorners:(e,t)=>{const i=.06*(t-.5)*Math.PI,a=r.center(...[84,85,86,87,88,89,90,91,92,93,94,95].map(t=>r.getVec(e,t)));let o=s.rotate(i,a.value[0],a.value[1]),n=s.rotate(.66*i,a.value[0],a.value[1]),d=s.rotate(.33*i,a.value[0],a.value[1]),c=s.rotate(.1*i,a.value[0],a.value[1]),l=[o,n,c,d,n,o,n,n];[84,85,86,94,95,96,97,103].forEach((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s);}),o=s.rotate(-i,a.value[0],a.value[1]),n=s.rotate(.66*-i,a.value[0],a.value[1]),d=s.rotate(.33*-i,a.value[0],a.value[1]),c=s.rotate(.1*-i,a.value[0],a.value[1]),l=[o,n,c,d,n,o,n,n],[90,89,88,92,91,100,99,101].forEach((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s);});},adjustPhiltrum:(e,t)=>{t=.25*(t-.5);const i=r.getVec(e,87),s=r.scale(r.sub(r.getVec(e,49),i),t);for(let t=84;t<104;t++)r.setPoint(e,t,r.add(r.getVec(e,t),s));},shrinkUnderjaw:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,16),o=r.getVec(e,49),n=r.getVec(e,0),d=r.getVec(e,32),c=[[6,26],[8,24],[10,22],[12,20],[14,18]],l=[],u=[],h=[];c.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);l.push([i,s]),u.push(r.intersectPoint(i,o,n,a)),h.push(r.intersectPoint(s,o,d,a));});const p=[.33,.66,1,.66,.33];l.forEach((t,a)=>{const o=r.lerp(t[0],u[a],i*p[a]),n=r.lerp(t[1],h[a],s*p[a]);r.setPoint(e,c[a][0],o),r.setPoint(e,c[a][1],n);});},shrinkCheekbone:(e,t)=>{const i=t*=.08,s=t,a=r.getVec(e,43),o=r.getVec(e,49),n=[[0,32],[2,30],[4,28],[6,26],[8,24]],d=[],c=[];n.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);d.push([i,s]),c.push(r.intersectPoint(i,s,a,o));});const l=[.33,.66,.33,.22,.11];d.forEach((t,a)=>{const o=r.lerp(t[0],c[a],i*l[a]),d=r.lerp(t[1],c[a],s*l[a]);r.setPoint(e,n[a][0],o),r.setPoint(e,n[a][1],d);});},lengthenJaw:(e,t)=>{t=.1*(.5-t);const i=r.getVec(e,16),s=r.sub(r.getVec(e,49),i),a=[.5,.5];[12,20,14,16,18].forEach((i,o)=>{r.setPoint(e,i,r.add(r.getVec(e,i),r.scale(s,t*(a[o]||1))));});},narrowedFace:(e,t)=>{const i=t*=.05,s=t,a=r.getVec(e,43),o=r.getVec(e,16),n=[.33,.66,1];[[106,111],[0,32],[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]].forEach((t,d)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,o);const h=n[d]||1;c=r.lerp(c,u,i*h),l=r.lerp(l,u,s*h),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l);});},shrinkFace:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,43),o=r.getVec(e,16);let n=[[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],d=[.1,.325,.55,.775,1,.9,.8,.7];n.forEach((t,n)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,o);c=r.lerp(c,u,i*d[n]),l=r.lerp(l,u,s*d[n]),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l);});const c=r.getVec(e,93);n=[[14,18],[12,20]],d=[.4,.2],n.forEach((t,a)=>{let o=r.getVec(e,t[0]),n=r.getVec(e,t[1]);o=r.lerp(o,c,i*d[a]),n=r.lerp(n,c,s*d[a]),r.setPoint(e,t[0],o),r.setPoint(e,t[1],n);}),r.setPoint(e,16,r.lerp(r.getVec(e,16),c,.6*Math.max(i,s)));},vShapedFace:(e,t)=>{const i=t*=.2,s=t,a=r.getVec(e,16),o=r.getVec(e,2),n=r.getVec(e,30),d=[[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],c=[],l=[],u=[];d.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);c.push([i,s]),l.push(r.intersectPoint(i,s,o,a)),u.push(r.intersectPoint(s,i,n,a));});const h=[.33,.66];c.forEach((t,a)=>{const o=r.lerp(t[0],l[a],i*(h[a]||1)),n=r.lerp(t[1],u[a],s*(h[a]||1));r.setPoint(e,d[a][0],o),r.setPoint(e,d[a][1],n);});},minifyFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),s=r.getVec(e,49),a=r.getVec(e,2),o=r.getVec(e,30),n=r.lerp(r.intersectPoint(i,s,a,o),i,t);let d=[.1,.25,.4,.55,.7,.85];[4,6,8,10,12,14,84,85,86,94,95,96,97,103,47,80,82].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a);}),[28,26,24,22,20,18,88,89,90,91,92,99,100,101,51,81,83].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a);}),d=[1],[16,93,102,98,87,49,46].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a);});},shortenFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),a=r.getVec(e,49),o=r.center(i,a)||r.getVec(e,45),n=s.scaleByNormal(r.sub(i,a),1-t,o.x,o.y);for(let t=4;t<30;t+=2)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=80;t<84;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=46;t<52;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=84;t<104;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));},whitenTeeth:(e,t)=>{let i=r.dis(r.getVec(e,98),r.getVec(e,102))/(r.dis(r.getVec(e,96),r.getVec(e,100))||1);return t*Math.max(0,Math.min(1,Math.pow(5*i,2)))}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BeautyFilter=void 0;const r=i(131),s=i(132),a=i(116),o=i(133),n=i(310),d=i(311),c=i(312),l=i(200),u=i(134),h={};class p extends u.Filter{constructor(e,t,i,r){super(e,t,i,r),this._smooth=0,this._whiten=0,this._redden=0,this._faceMask=null,this._featureParas={forehead:0,eyeRim:0,noseLine:0},this.featureEnable=!1,this.whitenMap=a.createTexture(e.gl,null,{flipY:!1}),this.reddenMap=a.createTexture(e.gl,null,{flipY:!1});const{programs:s,framebuffers:o}=this.initProgramsBuffers();this.programs=s,this.framebuffers=o,this.initUniforms();}initProgramsBuffers(){const e=this.renderer.gl,t=this.renderer.getSize(),i={},a={},u={blurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},blurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},highPass:{vShader:o.baseTextureShader.vShader,fShader:c.beautyHighPassShader.fShader,size:t},hBlurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},hBlurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},beauty:{vShader:o.baseTextureShader.vShader,fShader:n.beautyShader.fShader,size:t},whiten:{vShader:o.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t},redden:{vShader:o.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t}};for(const t in u){const{vShader:o,fShader:n,size:d}=u[t],c=new s.Program(e);c.setShader(o,"VERTEX"),c.setShader(n,"FRAGMENT"),c.setAttributeBuffer(this.posBuffer),c.setAttributeBuffer(this.uvBuffer),i[t]=c;const l=r.createFrameBuffer(e,d.width,d.height);a[t]=l;}return {programs:i,framebuffers:a}}initUniforms(){const e=this.programs,t=this.framebuffers,i=this.map,{width:r,height:s}=this.renderer.getSize(),a=[r,s],o=[r>>1,s>>1];e.blurX.setUniform("map",i),e.blurX.setUniform("size",o),e.blurY.setUniform("map",t.blurX.targetTexture),e.blurY.setUniform("size",o),e.blurY.setUniform("isVertical",1),e.highPass.setUniform("map",i),e.highPass.setUniform("blurMap",t.blurY.targetTexture),e.hBlurX.setUniform("map",t.highPass.targetTexture),e.hBlurX.setUniform("size",a),e.hBlurY.setUniform("map",t.hBlurX.targetTexture),e.hBlurY.setUniform("size",a),e.hBlurY.setUniform("isVertical",1),e.beauty.setUniform("size",a),e.beauty.setUniform("map",i),e.beauty.setUniform("blurMap",t.blurY.targetTexture),e.beauty.setUniform("highPassMap",t.hBlurY.targetTexture),e.beauty.setUniform("intensity",0);const n=this.featureParas;for(const t in n)e.beauty.setUniform(t+"Inten",this._featureParas[t]);e.whiten.setUniform("map",i),e.whiten.setUniform("lut",this.whitenMap),e.whiten.setUniform("intensity",0),e.redden.setUniform("map",i),e.redden.setUniform("lut",this.reddenMap),e.redden.setUniform("intensity",0);}get map(){return super.map}set map(e){e!==this._map&&(this._map=e,["blurX","highPass","beauty"].forEach(e=>{this.programs[e].setUniform("map",this._map);}),this.mapChange());}setLutsSrc(e,t){const{whiten:i,redden:r}=e;let s=2;const o=[],n=()=>{s-=1,s<=0&&(null==t||t(o));};if(h.whiten){this.whitenMap.source=h.whiten,this.whitenMap.refresh();const e=this._whiten;this._whiten=0,this.whiten=e,n();}else a.retryLoadImage(i,3,e=>{h.whiten=e,this.whitenMap.source=e,this.whitenMap.refresh();const t=this._whiten;this._whiten=0,this.whiten=t,n();},()=>{o.push(i),n();});if(h.redden){this.reddenMap.source=h.redden,this.reddenMap.refresh();const e=this._redden;this._redden=0,this.redden=e,n();}else a.retryLoadImage(r,3,e=>{h.redden=e,this.reddenMap.source=e,this.reddenMap.refresh();const t=this._redden;this._redden=0,this.redden=t,n();},()=>{o.push(r),n();});}get smoothOut(){return this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:this.map}get whitenOut(){return this.whiten?this.framebuffers.whiten.targetTexture:this.smoothOut}mapChange(){this.programs.whiten.setUniform("map",this.smoothOut),this.programs.redden.setUniform("map",this.whitenOut);}get smooth(){return this._smooth}set smooth(e){this._smooth!==e&&(this._smooth=e,this.programs.beauty.setUniform("intensity",this._smooth),this.mapChange());}get whiten(){return this._whiten}set whiten(e){this._whiten!==e&&(this._whiten=e,this.programs.whiten.setUniform("intensity",this.whitenMap&&this.whitenMap.source?this._whiten:0),this.mapChange());}get redden(){return this._redden}set redden(e){this._redden!==e&&(this._redden=e,this.programs.redden.setUniform("intensity",this.reddenMap&&this.reddenMap.source?this._redden:0));}set faceMask(e){this._faceMask!==e&&(this.programs.beauty.setUniform("maskMap",e),this.programs.beauty.setUniform("hasMask",e?1:0),this._faceMask=e);}set featureParas(e){let t=0;for(const i in e){const r=e[i];t+=r,this._featureParas[i]!==r&&(this.programs.beauty.setUniform(i+"Inten",r),this._featureParas[i]=r);}this.featureEnable=t>0,this.mapChange();}get output(){return this.redden?this.framebuffers.redden.targetTexture:this.whiten?this.framebuffers.whiten.targetTexture:this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[e.width,e.height],i=[e.width>>1,e.height>>1];["blurX","blurY"].forEach(e=>{const t=this.framebuffers[e];t.targetTexture.opts.width=i[0],t.targetTexture.opts.height=i[1],t.targetTexture.refresh();this.programs[e].setUniform("size",i);}),["highPass","hBlurX","hBlurY","beauty","whiten","redden"].forEach(e=>{const i=this.framebuffers[e];if(i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),["highPass","whiten","redden"].indexOf(e)<0){this.programs[e].setUniform("size",t);}});}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=this.programs,s=this.framebuffers;(this.smooth||this.featureEnable)&&(e.setViewport(0,0,t>>1,i>>1),s.blurX.bind(),e.render(r.blurX),s.blurY.bind(),e.render(r.blurY),e.setViewport(0,0,t,i),s.highPass.bind(),e.render(r.highPass),s.hBlurX.bind(),e.render(r.hBlurX),s.hBlurY.bind(),e.render(r.hBlurY),s.beauty.bind(),e.render(r.beauty)),this.whiten&&(s.whiten.bind(),e.render(r.whiten)),this.redden&&(s.redden.bind(),e.render(r.redden));}destroy(){super.destroy();const e=this.renderer.gl;null==e||e.deleteTexture(this.whitenMap.glTexture),null==e||e.deleteTexture(this.reddenMap.glTexture);}}t.BeautyFilter=p;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyShader=void 0,t.beautyShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform vec2 size;\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n    uniform sampler2D highPassMap;\n    uniform sampler2D maskMap;\n    uniform int hasMask;\n\n    // 磨皮度\n    uniform float intensity;\n    uniform float foreheadInten;\n    uniform float eyeRimInten;\n    uniform float noseLineInten;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 originColor = texture2D(map, vuv);\n        float _intensity = intensity;\n        if(hasMask > 0){\n            vec4 mask = texture2D(maskMap, vuv);\n            float intens = max(max(mask.r * noseLineInten, mask.g * foreheadInten), mask.b * eyeRimInten);\n            if(intens > 0.0){\n              _intensity = mix(_intensity, 1.5, intens);\n            }else{\n              _intensity *= mask.a;\n            }\n        }\n        if(_intensity > 0.0){\n            vec2 stepOffset = 0.5 / size;\n            float uOffsetX = stepOffset.x;\n            float uOffsetY = stepOffset.y;\n            float strength = _intensity * 1.0;\n\n            vec4 meanColor = texture2D(blurMap, vuv);\n            vec4 varColor = texture2D(highPassMap, vuv);\n\n            float value = clamp((min(originColor.r, meanColor.r - 0.1) - 0.2) * 4.0, 0.0, 1.0);\n            float meanValue = (varColor.r + varColor.g + varColor.b) / 3.0;\n            float currentIntensity = (1.0 - meanValue / (meanValue + 0.1)) * value * strength;\n            vec3 resultColor = mix(originColor.rgb, meanColor.rgb, currentIntensity);\n            float sum = 0.25*originColor.g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x-uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x+uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y-uOffsetY)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y-uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y-uOffsetY)).g;\n\n            float hPass = originColor.g - sum + 0.5;\n            float flag = step(0.5, hPass);\n            vec3 color = mix(max(vec3(0.0), (2.0*hPass + resultColor - 1.0)), min(vec3(1.0), (resultColor + 2.0*hPass - 1.0)), flag);\n\n            gl_FragColor = vec4(mix(resultColor.rgb, color.rgb, _intensity), 1.0);\n        }else{\n            gl_FragColor = originColor;\n        }\n    }"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyBlurShader=void 0,t.beautyBlurShader={vShader:"\n    uniform vec2 size;\n    uniform float isVertical;\n\n    attribute vec4 position;\n    attribute vec2 uv;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n        // 偏移步距\n        vec2 stepOffset = 1.0 / size;\n        if(isVertical> 0.5){\n            stepOffset.x = 0.0;\n        }else{\n            stepOffset.y = 0.0;\n        }\n\n        vTextureShift1 = vec4(uv - stepOffset, uv + stepOffset);\n\t\tvTextureShift2 = vec4(uv- 2.0 * stepOffset, uv + 2.0 * stepOffset);\n\t\tvTextureShift3 = vec4(uv - 3.0 * stepOffset, uv + 3.0 * stepOffset);\n\t\tvTextureShift4 = vec4(uv - 4.0 * stepOffset, uv + 4.0 * stepOffset);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n\n        vec3 sum = color.rgb;\n        sum += texture2D(map, vTextureShift1.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift1.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift2.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift2.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift3.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift3.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift4.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift4.zw).rgb;\n\n        gl_FragColor = vec4(sum * 0.1111, 1.0);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyHighPassShader=void 0,t.beautyHighPassShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        vec4 blurColor = texture2D(blurMap, vuv);\n        vec3 diffColor = (color.rgb - blurColor.rgb) * 6.0;\n        diffColor = diffColor * diffColor;\n        diffColor = min(diffColor, 1.0);\n        gl_FragColor = vec4(diffColor, 1.0);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LutFilter=void 0;const r=i(131),s=i(132),a=i(116),o=i(133),n=i(200),d=i(134),c={};class l extends d.Filter{constructor(e,t,i,r){super(e,t,i,r),this.lutImgs={},this.curLutName=null,this.lutMap=a.createTexture(e.gl,null,{flipY:!1});const{program:s,framebuffer:o}=this.initProgramBuffer();this.programs.main=s,this.framebuffers.main=o;}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=new s.Program(e);i.setShader(o.baseTextureShader.vShader,"VERTEX"),i.setShader(n.lutShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const a=r.createFrameBuffer(e,t.width,t.height);return i.setUniform("map",this.map),i.setUniform("lut",this.lutMap),i.setUniform("intensity",0),{program:i,framebuffer:a}}getLutImg(e){var t;return e&&null!==(t=this.lutImgs[e])&&void 0!==t?t:null}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map));}setLutsSrc(e,t){let i=Object.keys(e).length;const r=[],s=()=>{i-=1,i<=0&&(null==t||t(r));};for(const t in e){const{src:i,intensity:o=.5}=e[t];this.lutImgs[t]={img:null,intensity:o},c[t]?(this.lutImgs[t].img=c[t],t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s()):a.retryLoadImage(i,3,e=>{c[t]=e,this.lutImgs[t].img=e,t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s();},()=>{r.push(i),s();});}}get output(){return this.intensity?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.main;t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh();}setlut(e,t){if(e!==this.curLutName){this.curLutName=e;const t=this.getLutImg(this.curLutName);t&&(this.lutMap.source=t.img,this.lutMap.refresh());}t=null!=t?t:this.intensity,this.intensity=t;}get intensity(){const e=this.getLutImg(this.curLutName);return e?e.intensity:0}set intensity(e){const t=this.getLutImg(this.curLutName);t?(t.intensity=e,t.img?this.programs.main.setUniform("intensity",this.intensity):this.programs.main.setUniform("intensity",0)):this.programs.main.setUniform("intensity",0);}render(){this.intensity&&(this.framebuffers.main.bind(),this.renderer.render(this.programs.main));}destroy(){var e;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.lutMap.glTexture);}}t.LutFilter=l;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NormalFilter=void 0;const r=i(131),s=i(132),a=i(133),o=i(134);class n extends o.Filter{constructor(e,t,i,r){super(e,t,i,r),this._srcMap=null,this.pixels=null,this.initProgram();}initProgram(){const e=this.renderer.gl;let t=this.renderer.getSize();const i=new s.Program(e);i.setShader(a.baseTextureShader.vShader,"VERTEX"),i.setShader(a.baseTextureShader.yFlipFShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const o=r.createFrameBuffer(e,t.width,t.height);i.setUniform("map",this._srcMap),this.programs.imgData=i,this.framebuffers.imgData=o;const n=new s.Program(e);n.setShader(a.baseTextureShader.vShader,"VERTEX"),n.setShader(a.baseTextureShader.fShader,"FRAGMENT"),n.setAttributeBuffer(this.posBuffer),n.setAttributeBuffer(this.uvBuffer),n.setUniform("map",this._map),this.programs.main=n;}getImageData(e){e!==this._srcMap&&(this._srcMap=e,this.programs.imgData.setUniform("map",this._srcMap)),this._srcMap&&this._srcMap.refresh();const t=this.renderer,{width:i,height:r}=t.getSize(),s=t.gl;return this.framebuffers.imgData.bind(),t.render(this.programs.imgData),this.pixels&&this.pixels.length===i*r*4||(this.pixels=new Uint8Array(i*r*4)),s.readPixels(0,0,i,r,s.RGBA,s.UNSIGNED_BYTE,this.pixels),this.framebuffers.imgData.bind(!0),this.pixels}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map));}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.imgData;t&&(t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh());}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=e.gl;e.setViewport(0,0,t,i),r.bindFramebuffer(r.FRAMEBUFFER,null),e.render(this.programs.main);}}t.NormalFilter=n;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.typedArray=void 0,t.typedArray={posArray:new Int8Array([-1,1,-1,-1,1,1,1,-1]),uvArray:new Uint8Array([0,1,0,0,1,1,1,0]),advBeautyPosArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0,0);return e.push(0,0,0,1,1,1,1,0),e})()),advBeautyZindexArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0);return e.push(-1,-1,-1,-1),e})()),advBeautyIndicesArray:new Uint16Array([145,146,147,145,147,148,0,2,52,52,2,57,57,2,4,57,4,73,73,4,80,73,80,56,56,80,55,55,80,43,67,55,43,67,54,55,66,54,67,66,72,54,65,72,66,65,53,72,64,53,65,64,52,53,33,52,64,0,52,33,33,64,34,34,64,65,34,65,35,35,65,66,35,66,36,36,66,67,36,67,37,53,52,57,53,57,73,53,73,72,72,73,56,72,56,54,54,56,55,37,67,43,37,43,38,38,43,68,68,43,58,58,43,81,43,46,81,81,46,83,46,51,83,46,49,51,46,47,49,46,82,47,80,82,46,43,80,46,43,55,80,67,55,43,38,68,39,39,68,69,39,69,40,40,69,70,40,70,41,41,70,71,41,71,42,32,61,30,30,61,62,30,62,28,62,76,28,76,81,28,63,81,76,58,81,63,43,81,58,43,58,68,68,58,59,68,59,69,69,59,75,69,75,70,70,75,60,70,60,71,71,60,61,71,61,42,42,61,32,59,58,63,59,63,76,59,76,75,75,76,62,75,62,60,60,62,61,4,82,80,4,6,82,6,8,82,82,8,84,8,10,84,84,10,12,84,12,95,95,12,14,95,14,94,94,14,93,93,14,16,93,16,18,93,18,92,92,18,20,92,20,91,91,20,90,90,20,22,90,22,24,90,24,83,83,24,26,83,26,28,83,28,81,106,0,33,106,33,34,107,106,34,107,34,35,108,107,35,108,35,36,109,108,36,109,36,37,110,109,37,116,110,37,116,37,38,115,116,38,114,115,38,114,38,39,113,114,39,113,39,40,112,113,40,112,40,41,111,112,41,111,41,42,111,42,32,82,84,47,47,84,85,47,85,86,47,86,49,49,86,87,49,87,88,49,88,51,51,88,89,51,89,90,83,51,90,85,84,96,85,96,97,85,97,86,86,97,87,87,97,98,87,98,99,87,99,88,88,99,89,89,99,100,89,100,90,100,91,90,101,91,100,101,92,91,102,92,101,102,93,92,102,94,93,103,94,102,103,95,94,96,95,103,84,95,96,96,103,97,97,103,102,97,102,98,98,102,99,99,102,101,99,101,100,0,117,118,0,118,2,2,118,119,2,119,4,4,119,120,4,120,6,6,120,121,6,121,8,8,121,122,8,122,10,10,122,123,10,123,12,12,123,124,12,124,14,14,124,125,14,125,16,16,125,126,16,126,18,18,126,127,18,127,20,20,127,128,20,128,22,22,128,129,22,129,24,24,129,130,24,130,26,26,130,131,26,131,28,28,131,132,28,132,30,30,132,133,30,133,32,106,134,117,106,117,0,107,135,134,107,134,106,108,136,135,108,135,107,109,137,136,109,136,108,110,138,137,110,137,109,116,144,138,116,138,110,115,143,144,115,144,116,114,142,143,114,143,115,113,141,142,113,142,114,112,140,141,112,141,113,111,139,140,111,140,112,32,133,139,32,139,111]),advFaceMaskUVArray:new Float32Array([.30859375,.58203125,.30859375,.5546875,.310546875,.52734375,.3125,.5,.314453125,.47265625,.318359375,.4453125,.322265625,.41796875,.330078125,.392578125,.337890625,.369140625,.349609375,.34765625,.365234375,.328125,.380859375,.310546875,.400390625,.296875,.419921875,.28515625,.44140625,.27734375,.46484375,.271484375,.486328125,.26953125,.509765625,.271484375,.533203125,.275390625,.5546875,.283203125,.578125,.29296875,.59765625,.306640625,.6171875,.32421875,.634765625,.341796875,.650390625,.36328125,.662109375,.388671875,.669921875,.4140625,.67578125,.44140625,.6796875,.46875,.68359375,.49609375,.685546875,.525390625,.6875,.552734375,.6875,.580078125,.33984375,.634765625,.36328125,.66796875,.392578125,.673828125,.421875,.671875,.451171875,.6640625,.521484375,.666015625,.55078125,.671875,.58203125,.673828125,.611328125,.666015625,.63671875,.634765625,.486328125,.60546875,.484375,.568359375,.482421875,.533203125,.482421875,.498046875,.443359375,.47265625,.462890625,.46875,.484375,.46484375,.505859375,.470703125,.52734375,.474609375,.369140625,.599609375,.384765625,.611328125,.421875,.611328125,.4375,.59765625,.419921875,.591796875,.384765625,.591796875,.537109375,.59765625,.552734375,.611328125,.591796875,.611328125,.607421875,.59765625,.591796875,.591796875,.5546875,.591796875,.36328125,.646484375,.392578125,.650390625,.421875,.6484375,.451171875,.642578125,.521484375,.642578125,.55078125,.6484375,.580078125,.6484375,.611328125,.64453125,.40234375,.615234375,.400390625,.58984375,.40234375,.6015625,.57421875,.615234375,.57421875,.58984375,.572265625,.6015625,.4609375,.6015625,.51171875,.6015625,.443359375,.521484375,.5234375,.5234375,.431640625,.490234375,.537109375,.4921875,.416015625,.392578125,.44140625,.41796875,.470703125,.427734375,.486328125,.427734375,.5,.4296875,.53125,.419921875,.55859375,.39453125,.537109375,.375,.51171875,.36328125,.484375,.361328125,.4609375,.36328125,.4375,.375,.421875,.392578125,.453125,.408203125,.484375,.412109375,.51953125,.41015625,.552734375,.39453125,.51953125,.388671875,.484375,.38671875,.453125,.38671875,.40234375,.599609375,.57421875,.599609375,.3046875,.634765625,.31640625,.685546875,.341796875,.734375,.380859375,.7734375,.431640625,.802734375,.6875,.638671875,.671875,.693359375,.642578125,.7421875,.599609375,.78125,.546875,.806640625,.48828125,.81640625,.25390625,.576171875,.2578125,.50390625,.26171875,.43359375,.271484375,.36328125,.29296875,.298828125,.328125,.24609375,.373046875,.205078125,.427734375,.1796875,.486328125,.169921875,.546875,.177734375,.60546875,.19921875,.65625,.240234375,.69921875,.291015625,.724609375,.357421875,.736328125,.427734375,.744140625,.501953125,.74609375,.57421875,.25,.64453125,.263671875,.7109375,.296875,.7734375,.34765625,.82421875,.4140625,.86328125,.74609375,.650390625,.7265625,.720703125,.689453125,.783203125,.6328125,.833984375,.564453125,.8671875,.48828125,.880859375,0,0,0,0,0,0,0,0]),advEyeTeethPosArray:new Int16Array(48),advEyeTeethZindexArray:new Int16Array(24),advEyeTeethUVArray:new Float32Array([.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.067,.28,.267,.389,.512,.364,.754,.389,.933,.29,.76,.159,.497,.112,.243,.156]),advEyeTeethIndicesArray:new Uint16Array([1,0,7,1,7,6,1,6,2,2,6,5,2,5,3,3,5,4,11,12,13,11,13,14,11,14,10,10,14,15,10,15,9,9,15,8,16,23,17,17,23,22,17,22,18,18,22,19,19,22,21,19,21,20]),advForeheadPosArray:new Int16Array(98),advForeheadZindexArray:new Int16Array(49),advForeheadUVArray:new Float32Array([.12,.564,.181,.619,.26,.628,.341,.616,.41,.592,.597,.592,.666,.616,.747,.628,.827,.619,.887,.564,.051,.638,.101,.753,.154,.853,.236,.933,.355,.955,.504,.956,.652,.955,.771,.933,.853,.853,.907,.753,.956,.638,.155,.266,.281,.306,.441,.371,.598,.395,.694,.334,.763,.247,.134,.379,.242,.427,.401,.49,.604,.522,.749,.455,.87,.3,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11]),advForeheadIndicesArray:new Uint16Array([18,0,1,11,18,1,11,1,2,12,11,2,12,2,3,13,12,3,13,3,4,14,13,4,14,4,15,15,4,5,16,15,5,17,16,5,17,5,6,17,6,18,18,6,7,19,18,7,19,7,8,20,19,8,20,8,9,27,21,28,28,21,22,29,28,22,29,22,23,30,29,23,30,23,24,31,30,24,31,24,25,32,31,25,32,25,26])};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualBackFilter=void 0;const r=i(131),s=i(317),a=i(132),o=i(116),n=i(133),d=i(318),c=i(319),l=i(134);class u extends l.Filter{constructor(e,t,i,r){super(e,t,i,r),this.intensity=.1,this.lastSetInfo={},this.sourceMap=t,this.maskMap=o.createTexture(e.gl,null),this.bkColor=new s.GlColor("#e7ad3c"),this.bkMap=o.createTexture(e.gl,null),this.initProgramBuffer();}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=[o.toNthPower(t.width),o.toNthPower(t.height)],s=new a.Program(e);s.setShader(n.baseTextureShader.vShader,"VERTEX"),s.setShader(n.baseTextureShader.fShader,"FRAGMENT"),s.setAttributeBuffer(this.posBuffer),s.setAttributeBuffer(this.uvBuffer);const l=r.createFrameBuffer(e,i[0],i[1],!0);s.setUniform("map",this.sourceMap),this.programs.mip=s,this.framebuffers.mip=l;const u=new a.Program(e);u.setShader(n.baseTextureShader.vShader,"VERTEX"),u.setShader(d.mipMapBlurShader.fShader,"FRAGMENT"),u.setAttributeBuffer(this.posBuffer),u.setAttributeBuffer(this.uvBuffer);const h=r.createFrameBuffer(e,t.width,t.height);u.setUniform("map",l.targetTexture),u.setUniform("radius",.25*Math.max(t.width,t.height)),u.setUniform("intensity",.1),this.programs.blur=u,this.framebuffers.blur=h;const p=new a.Program(e);p.setShader(n.baseTextureShader.vShader,"VERTEX"),p.setShader(c.virtualBackShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.posBuffer),p.setAttributeBuffer(this.uvBuffer);const m=r.createFrameBuffer(e,t.width,t.height);p.setUniform("map",this.map),p.setUniform("maskMap",this.maskMap),p.setUniform("backColor",this.bkColor.value),p.setUniform("backMap",this.bkMap),p.setUniform("size",[t.width,t.height]),p.setUniform("bkSize",[0,0]),p.setUniform("backType",0),p.setUniform("emptyFrame",0),this.programs.main=p,this.framebuffers.main=m;}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map));}set emptyFrame(e){this.programs.main.setUniform("emptyFrame",e?1:0);}setMaskMap(e){const t=this.maskMap;t&&(t.source=e,t.refresh());}setBkColor(e){this.bkColor.setValue(e||"#e7ad3c"),this.programs.main.setUniform("backColor",this.bkColor.value);}getBkInfo(){const e=this.bkMap,t=e?e.source:null,i={type:"color",size:[0,0]};return t&&("videoWidth"in t?(i.type="video",i.size=[t.videoWidth,t.videoHeight]):t instanceof Image&&(i.type="image",i.size=[t.naturalWidth,t.naturalHeight])),i}setBkMap(e){const t=this.bkMap;t&&(e instanceof Image||null===e?(t.source=e,t.refresh()):"readyState"in e&&(e.readyState<2?setTimeout(()=>{this.setBkMap(e);},16.7):(t.source=e,t.refresh())));}setBackground(e){const t=typeof e;"string"===t||null===e?(this.setBkColor(e),this.setBkMap(null)):"object"===t&&(this.setBkColor(null),this.setBkMap(e));const i=this.getBkInfo();this.programs.main.setUniform("backType","color"===i.type?0:1),"color"!==i.type&&(this.programs.main.setUniform("backMap",this.bkMap),this.programs.main.setUniform("bkSize",i.size)),this.lastSetInfo={type:"bk",value:e};}setBlurIntensity(e){const t=this.renderer.getSize();e=Math.max(.1,Math.min(1,e)),this.programs.blur.setUniform("intensity",e),this.programs.main.setUniform("backMap",this.framebuffers.blur.targetTexture),this.programs.main.setUniform("bkSize",[t.width,t.height]),this.programs.main.setUniform("backType",1),this.lastSetInfo={type:"blur",value:e};}get output(){return this.maskMap&&this.maskMap.source?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[o.toNthPower(e.width),o.toNthPower(e.height)];["blur","main"].forEach(t=>{const i=this.framebuffers[t];i.targetTexture.opts.width=e.width,i.targetTexture.opts.height=e.height,i.targetTexture.refresh();});const i=this.framebuffers.mip;i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),this.programs.main.setUniform("size",[e.width,e.height]),this.programs.blur.setUniform("radius",.25*Math.max(e.width,e.height)),this.programs.main.getUniform("backMap").value===i.targetTexture&&this.programs.main.setUniform("bkSize",t);}render(){var e;if(this.maskMap&&this.maskMap.source){const t=this.renderer;if(this.programs.main.getUniform("backMap").value===this.framebuffers.blur.targetTexture){const e=t.getSize(),i=this.framebuffers.mip.targetTexture;t.setViewport(0,0,i.opts.width,i.opts.height),this.framebuffers.mip.bind(),this.programs.mip.render(),this.framebuffers.mip.targetTexture.updateMipMap(),t.setViewport(0,0,e.width,e.height),this.framebuffers.blur.bind(),this.programs.blur.render();}else {"video"===this.getBkInfo().type&&(null===(e=this.bkMap)||void 0===e||e.refresh());}this.framebuffers.main.bind(),this.programs.main.render();}}destroy(){var e,t;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.maskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.bkMap.glTexture);}}t.VirtualBackFilter=u;},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.GlColor=void 0;t.GlColor=class{constructor(e){this._color=[1,1,1,1],this.convert(e);}convert(e){if("string"==typeof e){if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/i.test(e)){if(4===e.length){let t="#";for(let i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t;}const t=[];for(let i=1;i<7;i+=2)t.push(parseInt("0x"+e.slice(i,i+2)));return void this.convert(t)}console.error(`color:[${e}] format is error.`);}else this._color=e.map((e,t)=>t<3?Math.min(Math.max(Number(e),0),255)/255:Math.min(Math.max(Number(Number(null!=e?e:1)),0),1));}get value(){return this._color}setValue(e){this.convert(e);}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.mipMapBlurShader=void 0,t.mipMapBlurShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform float intensity;\n    uniform float radius;\n    varying vec2 vuv;\n\n    float weight(float t, float log2radius, float gamma)\n    {\n        return exp(-gamma*pow(log2radius-t,2.));\n    }\n\n    vec3 sample_blured(vec2 uv, float radius, float gamma)\n    {\n        vec3 pix = vec3(0.);\n        float norm = 0.;\n        for(float i = 0.; i < 10.; i += 0.5)\n        {\n            float k = weight(i, log2(radius), gamma);\n            pix += k * texture2D(map, uv, i).rgb;\n            norm += k;\n        }\n        return pix*pow(norm,-0.95);\n    }\n\n    void main() {\n        gl_FragColor = vec4(sample_blured(vuv, mix(8.0, radius, intensity), intensity), 1.0);\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.virtualBackShader=void 0,t.virtualBackShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform sampler2D backMap;\n    uniform vec3 backColor;\n    uniform vec2 size;\n    uniform vec2 bkSize;\n    uniform int backType;\n    uniform int emptyFrame;\n\n    varying vec2 vuv;\n\n    void main() {\n        if(emptyFrame > 0){\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }else{\n            vec3 color = texture2D(map, vuv).rgb;\n            float alpha = texture2D(maskMap, vuv).a;\n\n            vec3 bk = backColor;\n            // 背景图\n            if(backType == 1){\n                float ratio = size.x / size.y;\n                float bkRatio = bkSize.x / bkSize.y;\n                vec2 suv = vuv;\n                if(ratio > bkRatio){\n                    suv.y = (suv.y - 0.5) * bkRatio / ratio + 0.5;\n                }else{\n                    suv.x = (suv.x - 0.5) * ratio / bkRatio + 0.5;\n                }\n                bk = texture2D(backMap, suv).rgb;\n            }\n\n            gl_FragColor = vec4(mix(bk, color, alpha), 1.0);\n        }\n    }\n"};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(10),s=i(199);class a extends r.EventEmitter{constructor(e){var t;super(),this.setAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log(`set advbeauty effect：[${e[0]}, ${e[1]}]`),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.setAdvEffect(...e));},this.presetAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log("preset advbeauty effect："+JSON.stringify(e[0])),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.presetAdvEffect(...e));},this.videPostProcess=e,null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.on("advBeautyResComplete",e=>{this.videPostProcess.emit("advBeautyResComplete",e);});}get advancedBeautyProcess(){const e=this.videPostProcess.getPlugin("AdvancedBeauty");return e||this.logger.error("Can not get AdvancedBeauty plugin"),e}init(e){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.on("facePoints-load",()=>{this.emit("facePoints-load"),this.advancedBeautyProcess.setFaceSize(Math.min(5,Math.max(1,e||1)));}),this.advancedBeautyProcess.init());}destroy(){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.removeAllListeners(),this.advancedBeautyProcess.destroy());}get logger(){return this.videPostProcess.logger}setTrack(e,t){var i;return e&&a.configStaticRes(s.resSet,null===(i=this.videPostProcess.filters)||void 0===i?void 0:i.advBeauty),new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("AdvancedBeauty",e,t).then(t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.advBeauty.setAdvData([]),i(t);}).catch(e=>{r(e);});})}get isEnable(){return this.videPostProcess.hasTask("AdvancedBeauty")}}t.default=a,a.configStaticRes=(e,t)=>{s.AdvBeautyFilter.configStaticRes(e,t);};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r={beauty:{whiten:"https://yx-web-nosdn.netease.im/common/cab8e4f0696d3d8e29ee10d6dccc1204/meibai.png",redden:"https://yx-web-nosdn.netease.im/common/c614e2af82da88807067926d7ff3be3d/hongrun.png"},filters:{ziran:{src:"https://yx-web-nosdn.netease.im/common/c89328281947fceabdc71d5fa08b2345/ziran.png",intensity:1},baixi:{src:"https://yx-web-nosdn.netease.im/common/3a22a55384b0bd5b07fca3509bfc981a/baixi.png",intensity:.5},fennen:{src:"https://yx-web-nosdn.netease.im/common/db5befdae1f46dad2e5a6d702bad19ea/fennen.png",intensity:.5},weimei:{src:"https://yx-web-nosdn.netease.im/common/cf8bfec70d7998bb0033757276c6559a/weimei.png",intensity:.5},langman:{src:"https://yx-web-nosdn.netease.im/common/1c50a14532bfa3ad503a82ddd13f0ec8/langman.png",intensity:.5},rixi:{src:"https://yx-web-nosdn.netease.im/common/c414819383913b5db0d9b686276e3d57/rixi.png",intensity:.5},landiao:{src:"https://yx-web-nosdn.netease.im/common/4c77522852dc14448603be21abc571c8/landiao.png",intensity:.5},qingliang:{src:"https://yx-web-nosdn.netease.im/common/1150e94f831d24148239001588a7ca7d/qingliang.png",intensity:.5},huaijiu:{src:"https://yx-web-nosdn.netease.im/common/6a38caeab164d1b5cc086391d6a11a74/huaijiu.png",intensity:.5},qingcheng:{src:"https://yx-web-nosdn.netease.im/common/3b3332c5ae4306312b6f3c4c552a464a/qingcheng.png",intensity:1},wuhou:{src:"https://yx-web-nosdn.netease.im/common/200fc7a12177774f4eb23f55d72643ee/wuhou.png",intensity:1},zhigan:{src:"https://yx-web-nosdn.netease.im/common/848bd44506cf8e10ecabf564e3d74809/zhigan.png",intensity:1},mopian:{src:"https://yx-web-nosdn.netease.im/common/c454efa119520f0793ce51327951ed0a/mopian.png",intensity:1},dianying:{src:"https://yx-web-nosdn.netease.im/common/3a6a22adad29c5844fc829f4f889a79f/dianying.png",intensity:1},heibai:{src:"https://yx-web-nosdn.netease.im/common/941270f2948218ea19f2d79db5e7d349/heibai.png",intensity:1}}},s=new Set;t.default=class{constructor(e){this.lutLoaded=!1,this.videPostProcess=e,this.videPostProcess.on("contextLost",()=>{this.lutLoaded=!1;}),s.add(this);}startLut(){if(this.lutLoaded)return;const e=this.videPostProcess.filters;if(!e)return;let t=2;const i=[],s=()=>{t-=1,t<=0&&this.videPostProcess.emit("beautyResComplete",i);};e.beauty.setLutsSrc(r.beauty,e=>{i.push(...e),s();}),e.lut.setLutsSrc(r.filters,e=>{i.push(...e),s();}),this.lutLoaded=!0;}setFilter(e,t){var i;null===(i=this.videPostProcess.filters)||void 0===i||i.lut.setlut(e,t);}setBeauty(e,t){return e&&this.startLut(),new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("BasicBeauty",e,t).then(t=>{if(!e){const e=this.videPostProcess.filters;if(!e)return;e.beauty.whiten=0,e.beauty.redden=0,e.beauty.smooth=0,e.lut.setlut(null);}i(t);}).catch(e=>{r(e);});})}setBeautyOptions(e){const t=this.videPostProcess.filters;t&&("smoothnessLevel"in e&&(t.beauty.smooth=e.smoothnessLevel),"brightnessLevel"in e&&(t.beauty.whiten=e.brightnessLevel),"rednessLevel"in e&&(t.beauty.redden=e.rednessLevel));}get isEnable(){return this.videPostProcess.hasTask("BasicBeauty")}static configStaticRes(e){let t=!1;e.beauty&&(r.beauty=Object.assign({},e.beauty),t=!0),e.filters&&(r.filters=Object.assign({},e.filters),t=!0),t&&s.forEach(e=>{try{e.lutLoaded=!1,e.startLut();}catch(e){}});}};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(10),s=i(116);class a extends r.EventEmitter{constructor(e){super(),this.bgOption={type:"color",color:"#e7ad3c"},this.videPostProcess=e;}get segmentProcess(){return this.videPostProcess.getPlugin("VirtualBackground")}init(){this.segmentProcess.on("segment-load",()=>{this.emit("segment-load");}),this.segmentProcess.init();}destroy(){this.segmentProcess.removeAllListeners(),this.segmentProcess.destroy();}setVirtualBackGround(e){this.bgOption=e;switch(t){case"image":const{source:t}=e;if("object"==typeof t)this.setBackGround(t);else if("string"==typeof t)if(t.includes("data:image")){const e=new Image;e.onload=()=>{this.setBackGround(e);},e.src=t;}else if(t.includes("http"))s.loadImage(t,e=>{this.setBackGround(e);});else {const e=new Image;e.onload=()=>{this.setBackGround(e);},e.src=t;}break;case"color":this.setBackGround(e.color);break;case"blur":this.setBlurIntensity(e.level/10);}}setTrack(e,t){return new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("VirtualBackground",e,t).then(t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.virtualBackground.setMaskMap(null),i(t);}).catch(e=>{r(e);});})}setBackGround(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBackground(e);}setBlurIntensity(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBlurIntensity(e);}get isEnable(){return this.videPostProcess.hasTask("VirtualBackground")}set emptyFrame(e){this.videPostProcess.filters.virtualBackground.emptyFrame=e;}}t.default=a;},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loadPlugin=void 0;const s=r(i(201));t.loadPlugin=function(e,t){return new Promise((i,r)=>{-1==s.default.indexOf(e)&&r("unsupport plugin "+e);const a=document.createElement("script");a.defer=!0,a.src=t,document.body.appendChild(a),a.onload=function(){i();},a.onerror=function(e){r(`Load plugin ${t} error`);};})};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.applyResolution=void 0,t.applyResolution=async function(e){const{track:t,targetWidth:i,targetHeight:r,keepAspectRatio:s,logger:a}=e,o=t.getSettings();if(o.width&&o.height)if(o.width!==i||o.height!==r){let e;s?(e={aspectRatio:o.width/o.height},o.width/o.height>=i/r?e.width=i:e.height=r):e={width:i,height:r},await t.applyConstraints(e),await new Promise(e=>{setTimeout(e,100);});const n=t.getSettings();o.width!==n.width||o.height!==n.height?a.log(`applyResolution 成功修改分辨率 保留长宽比：${s} ${o.width}x${o.height} => ${n.width}x${n.height} (constraints: ${JSON.stringify(e)})【${t.label}】`):a.warn(`applyResolution 无法修改分辨率为${i}x${r}，目前的分辨率：${o.width}x${o.height} (constraints: ${JSON.stringify(e)})【${t.label}】`);}else a.log(`applyResolution 无需修改分辨率 ${o.width}x${o.height} 【${t.label}】`);else a.log(`applyResolution 摄像头不支持动态修改分辨率 【${t.label}】`);};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.webassemblySupported=void 0,t.webassemblySupported=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return !1}return !1};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.serverError=t.clientNotYetPublished=t.STREAM_HAS_NO_MEDIA_ATTRIBUTES=t.clientNotYetUninitialized=t.invalidArguments=t.ok=void 0,t.ok={name:"OK",code:200,desc:"success"},t.invalidArguments={name:"invalid arguments",code:1,desc:"请检查参数的有效性"},t.clientNotYetUninitialized={name:"client not yet uninitialized",code:2,desc:"请先调用createClient创建Client"},t.STREAM_HAS_NO_MEDIA_ATTRIBUTES={name:"STREAM_HAS_NO_MEDIA_ATTRIBUTES",code:10,desc:"stream不合法，没有audio、video或者screen属性"},t.clientNotYetPublished={name:"client not yet published",code:11,desc:"请先publish"},t.serverError={name:"server error code",code:414,desc:""};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LIVE_STREAM_AUDIO_CODEC_PROFILE=t.LIVE_STREAM_AUDIO_SAMPLE_RATE=void 0,t.LIVE_STREAM_AUDIO_SAMPLE_RATE={SAMPLE_RATE_32000:32e3,SAMPLE_RATE_44100:44100,SAMPLE_RATE_48000:48e3},t.LIVE_STREAM_AUDIO_CODEC_PROFILE={LC_AAC:0,HE_AAC:1};},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NETWORK_STATUS=void 0,t.NETWORK_STATUS={0:"UNKNOWN",1:"EXCELLENT",2:"GOOD",3:"POOR",4:"BAD",5:"VERYBAD",6:"DOWN"};}])}));
    });

    var NERTC$1 = unwrapExports(NERTC);
    NERTC.NERTC;

    var SIGNAL_NULL = {
        code: '101',
        message: 'signal is null',
    };
    var CHANNELINFO_NULL = {
        code: '102',
        message: 'channelInfo is null',
    };
    var NOT_CALLING = {
        code: '103',
        message: 'not calling',
    };
    var NOT_BE_CALL = {
        code: '104',
        message: 'not be call',
    };
    var CALL_BUSY = {
        code: '105',
        message: 'be call busy',
    };
    var NOT_IN_CALL = {
        code: '106',
        message: 'not in call',
    };
    var CALLID_NOT_MATCH = {
        code: '106',
        message: 'callId not match',
    };

    // export type SignalControllerR
    var SignalControllerCallingStatus;
    (function (SignalControllerCallingStatus) {
        SignalControllerCallingStatus[SignalControllerCallingStatus["idle"] = 0] = "idle";
        SignalControllerCallingStatus[SignalControllerCallingStatus["calling"] = 1] = "calling";
        SignalControllerCallingStatus[SignalControllerCallingStatus["called"] = 2] = "called";
        SignalControllerCallingStatus[SignalControllerCallingStatus["inCall"] = 3] = "inCall";
    })(SignalControllerCallingStatus || (SignalControllerCallingStatus = {}));

    var loglevel = createCommonjsModule(function (module) {
    /*
    * loglevel - https://github.com/pimterry/loglevel
    *
    * Copyright (c) 2013 Tim Perry
    * Licensed under the MIT license.
    */
    (function (root, definition) {
        if (module.exports) {
            module.exports = definition();
        } else {
            root.log = definition();
        }
    }(commonjsGlobal, function () {

        // Slightly dubious tricks to cut down minimized file size
        var noop = function() {};
        var undefinedType = "undefined";
        var isIE = (typeof window !== undefinedType) && (typeof window.navigator !== undefinedType) && (
            /Trident\/|MSIE /.test(window.navigator.userAgent)
        );

        var logMethods = [
            "trace",
            "debug",
            "info",
            "warn",
            "error"
        ];

        // Cross-browser bind equivalent that works at least back to IE6
        function bindMethod(obj, methodName) {
            var method = obj[methodName];
            if (typeof method.bind === 'function') {
                return method.bind(obj);
            } else {
                try {
                    return Function.prototype.bind.call(method, obj);
                } catch (e) {
                    // Missing bind shim or IE8 + Modernizr, fallback to wrapping
                    return function() {
                        return Function.prototype.apply.apply(method, [obj, arguments]);
                    };
                }
            }
        }

        // Trace() doesn't print the message in IE, so for that case we need to wrap it
        function traceForIE() {
            if (console.log) {
                if (console.log.apply) {
                    console.log.apply(console, arguments);
                } else {
                    // In old IE, native console methods themselves don't have apply().
                    Function.prototype.apply.apply(console.log, [console, arguments]);
                }
            }
            if (console.trace) console.trace();
        }

        // Build the best logging method possible for this env
        // Wherever possible we want to bind, not wrap, to preserve stack traces
        function realMethod(methodName) {
            if (methodName === 'debug') {
                methodName = 'log';
            }

            if (typeof console === undefinedType) {
                return false; // No method possible, for now - fixed later by enableLoggingWhenConsoleArrives
            } else if (methodName === 'trace' && isIE) {
                return traceForIE;
            } else if (console[methodName] !== undefined) {
                return bindMethod(console, methodName);
            } else if (console.log !== undefined) {
                return bindMethod(console, 'log');
            } else {
                return noop;
            }
        }

        // These private functions always need `this` to be set properly

        function replaceLoggingMethods(level, loggerName) {
            /*jshint validthis:true */
            for (var i = 0; i < logMethods.length; i++) {
                var methodName = logMethods[i];
                this[methodName] = (i < level) ?
                    noop :
                    this.methodFactory(methodName, level, loggerName);
            }

            // Define log.log as an alias for log.debug
            this.log = this.debug;
        }

        // In old IE versions, the console isn't present until you first open it.
        // We build realMethod() replacements here that regenerate logging methods
        function enableLoggingWhenConsoleArrives(methodName, level, loggerName) {
            return function () {
                if (typeof console !== undefinedType) {
                    replaceLoggingMethods.call(this, level, loggerName);
                    this[methodName].apply(this, arguments);
                }
            };
        }

        // By default, we use closely bound real methods wherever possible, and
        // otherwise we wait for a console to appear, and then try again.
        function defaultMethodFactory(methodName, level, loggerName) {
            /*jshint validthis:true */
            return realMethod(methodName) ||
                   enableLoggingWhenConsoleArrives.apply(this, arguments);
        }

        function Logger(name, defaultLevel, factory) {
          var self = this;
          var currentLevel;
          defaultLevel = defaultLevel == null ? "WARN" : defaultLevel;

          var storageKey = "loglevel";
          if (typeof name === "string") {
            storageKey += ":" + name;
          } else if (typeof name === "symbol") {
            storageKey = undefined;
          }

          function persistLevelIfPossible(levelNum) {
              var levelName = (logMethods[levelNum] || 'silent').toUpperCase();

              if (typeof window === undefinedType || !storageKey) return;

              // Use localStorage if available
              try {
                  window.localStorage[storageKey] = levelName;
                  return;
              } catch (ignore) {}

              // Use session cookie as fallback
              try {
                  window.document.cookie =
                    encodeURIComponent(storageKey) + "=" + levelName + ";";
              } catch (ignore) {}
          }

          function getPersistedLevel() {
              var storedLevel;

              if (typeof window === undefinedType || !storageKey) return;

              try {
                  storedLevel = window.localStorage[storageKey];
              } catch (ignore) {}

              // Fallback to cookies if local storage gives us nothing
              if (typeof storedLevel === undefinedType) {
                  try {
                      var cookie = window.document.cookie;
                      var location = cookie.indexOf(
                          encodeURIComponent(storageKey) + "=");
                      if (location !== -1) {
                          storedLevel = /^([^;]+)/.exec(cookie.slice(location))[1];
                      }
                  } catch (ignore) {}
              }

              // If the stored level is not valid, treat it as if nothing was stored.
              if (self.levels[storedLevel] === undefined) {
                  storedLevel = undefined;
              }

              return storedLevel;
          }

          function clearPersistedLevel() {
              if (typeof window === undefinedType || !storageKey) return;

              // Use localStorage if available
              try {
                  window.localStorage.removeItem(storageKey);
                  return;
              } catch (ignore) {}

              // Use session cookie as fallback
              try {
                  window.document.cookie =
                    encodeURIComponent(storageKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
              } catch (ignore) {}
          }

          /*
           *
           * Public logger API - see https://github.com/pimterry/loglevel for details
           *
           */

          self.name = name;

          self.levels = { "TRACE": 0, "DEBUG": 1, "INFO": 2, "WARN": 3,
              "ERROR": 4, "SILENT": 5};

          self.methodFactory = factory || defaultMethodFactory;

          self.getLevel = function () {
              return currentLevel;
          };

          self.setLevel = function (level, persist) {
              if (typeof level === "string" && self.levels[level.toUpperCase()] !== undefined) {
                  level = self.levels[level.toUpperCase()];
              }
              if (typeof level === "number" && level >= 0 && level <= self.levels.SILENT) {
                  currentLevel = level;
                  if (persist !== false) {  // defaults to true
                      persistLevelIfPossible(level);
                  }
                  replaceLoggingMethods.call(self, level, name);
                  if (typeof console === undefinedType && level < self.levels.SILENT) {
                      return "No console available for logging";
                  }
              } else {
                  throw "log.setLevel() called with invalid level: " + level;
              }
          };

          self.setDefaultLevel = function (level) {
              defaultLevel = level;
              if (!getPersistedLevel()) {
                  self.setLevel(level, false);
              }
          };

          self.resetLevel = function () {
              self.setLevel(defaultLevel, false);
              clearPersistedLevel();
          };

          self.enableAll = function(persist) {
              self.setLevel(self.levels.TRACE, persist);
          };

          self.disableAll = function(persist) {
              self.setLevel(self.levels.SILENT, persist);
          };

          // Initialize with the right level
          var initialLevel = getPersistedLevel();
          if (initialLevel == null) {
              initialLevel = defaultLevel;
          }
          self.setLevel(initialLevel, false);
        }

        /*
         *
         * Top-level API
         *
         */

        var defaultLogger = new Logger();

        var _loggersByName = {};
        defaultLogger.getLogger = function getLogger(name) {
            if ((typeof name !== "symbol" && typeof name !== "string") || name === "") {
              throw new TypeError("You must supply a name when creating a logger.");
            }

            var logger = _loggersByName[name];
            if (!logger) {
              logger = _loggersByName[name] = new Logger(
                name, defaultLogger.getLevel(), defaultLogger.methodFactory);
            }
            return logger;
        };

        // Grab the current global log variable in case of overwrite
        var _log = (typeof window !== undefinedType) ? window.log : undefined;
        defaultLogger.noConflict = function() {
            if (typeof window !== undefinedType &&
                   window.log === defaultLogger) {
                window.log = _log;
            }

            return defaultLogger;
        };

        defaultLogger.getLoggers = function getLoggers() {
            return _loggersByName;
        };

        // ES6 default export, for compatibility
        defaultLogger['default'] = defaultLogger;

        return defaultLogger;
    }));
    });

    var c=function(n){var t=void 0===n?{appName:"",version:"",storeWindow:!1}:n,r=t.level,o=t.appName,a=void 0===o?"":o,c=t.version,l=void 0===c?"":c,u=t.storeWindow,i=void 0!==u&&u,s=function(){var e=new Date,n=e.getFullYear(),t=e.getMonth()+1,r=e.getDate(),o=e.getHours()<10?"0".concat(e.getHours()):e.getHours(),a=e.getMinutes()<10?"0".concat(e.getMinutes()):e.getMinutes(),c=e.getSeconds()<10?"0".concat(e.getSeconds()):e.getSeconds();return "".concat(n,"-").concat(t,"-").concat(r," ").concat(o,":").concat(a,":").concat(c)},f=new Proxy(loglevel,{get:function(e,n){if(n in e){var t=e[n];if(!["log","info","warn","error","trace","debug"].includes(n))return t;var r=function(){try{var e=navigator.userAgent.toLocaleLowerCase().match(/(msie|firefox|chrome|opera|version).*?([\d.]+)/)||[];return {browser:e[1].replace(/version/,"safari"),ver:e[2]}}catch(e){return null}}(),o="";return o=r?"[ ".concat(a," ").concat(l," ").concat(r.browser,":").concat(r.ver," ").concat(s()," ]"):"[ ".concat(a," ").concat(l," ").concat(s()," ]"),t.bind(null,o)}}});return r&&f.setLevel(r),i&&(window.__LOGGER__=f),f};

    var eventemitter3 = createCommonjsModule(function (module) {

    var has = Object.prototype.hasOwnProperty
      , prefix = '~';

    /**
     * Constructor to create a storage for our `EE` objects.
     * An `Events` instance is a plain object whose properties are event names.
     *
     * @constructor
     * @private
     */
    function Events() {}

    //
    // We try to not inherit from `Object.prototype`. In some engines creating an
    // instance in this way is faster than calling `Object.create(null)` directly.
    // If `Object.create(null)` is not supported we prefix the event names with a
    // character to make sure that the built-in object properties are not
    // overridden or used as an attack vector.
    //
    if (Object.create) {
      Events.prototype = Object.create(null);

      //
      // This hack is needed because the `__proto__` property is still inherited in
      // some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
      //
      if (!new Events().__proto__) prefix = false;
    }

    /**
     * Representation of a single event listener.
     *
     * @param {Function} fn The listener function.
     * @param {*} context The context to invoke the listener with.
     * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
     * @constructor
     * @private
     */
    function EE(fn, context, once) {
      this.fn = fn;
      this.context = context;
      this.once = once || false;
    }

    /**
     * Add a listener for a given event.
     *
     * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
     * @param {(String|Symbol)} event The event name.
     * @param {Function} fn The listener function.
     * @param {*} context The context to invoke the listener with.
     * @param {Boolean} once Specify if the listener is a one-time listener.
     * @returns {EventEmitter}
     * @private
     */
    function addListener(emitter, event, fn, context, once) {
      if (typeof fn !== 'function') {
        throw new TypeError('The listener must be a function');
      }

      var listener = new EE(fn, context || emitter, once)
        , evt = prefix ? prefix + event : event;

      if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;
      else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);
      else emitter._events[evt] = [emitter._events[evt], listener];

      return emitter;
    }

    /**
     * Clear event by name.
     *
     * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
     * @param {(String|Symbol)} evt The Event name.
     * @private
     */
    function clearEvent(emitter, evt) {
      if (--emitter._eventsCount === 0) emitter._events = new Events();
      else delete emitter._events[evt];
    }

    /**
     * Minimal `EventEmitter` interface that is molded against the Node.js
     * `EventEmitter` interface.
     *
     * @constructor
     * @public
     */
    function EventEmitter() {
      this._events = new Events();
      this._eventsCount = 0;
    }

    /**
     * Return an array listing the events for which the emitter has registered
     * listeners.
     *
     * @returns {Array}
     * @public
     */
    EventEmitter.prototype.eventNames = function eventNames() {
      var names = []
        , events
        , name;

      if (this._eventsCount === 0) return names;

      for (name in (events = this._events)) {
        if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);
      }

      if (Object.getOwnPropertySymbols) {
        return names.concat(Object.getOwnPropertySymbols(events));
      }

      return names;
    };

    /**
     * Return the listeners registered for a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @returns {Array} The registered listeners.
     * @public
     */
    EventEmitter.prototype.listeners = function listeners(event) {
      var evt = prefix ? prefix + event : event
        , handlers = this._events[evt];

      if (!handlers) return [];
      if (handlers.fn) return [handlers.fn];

      for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {
        ee[i] = handlers[i].fn;
      }

      return ee;
    };

    /**
     * Return the number of listeners listening to a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @returns {Number} The number of listeners.
     * @public
     */
    EventEmitter.prototype.listenerCount = function listenerCount(event) {
      var evt = prefix ? prefix + event : event
        , listeners = this._events[evt];

      if (!listeners) return 0;
      if (listeners.fn) return 1;
      return listeners.length;
    };

    /**
     * Calls each of the listeners registered for a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @returns {Boolean} `true` if the event had listeners, else `false`.
     * @public
     */
    EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {
      var evt = prefix ? prefix + event : event;

      if (!this._events[evt]) return false;

      var listeners = this._events[evt]
        , len = arguments.length
        , args
        , i;

      if (listeners.fn) {
        if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);

        switch (len) {
          case 1: return listeners.fn.call(listeners.context), true;
          case 2: return listeners.fn.call(listeners.context, a1), true;
          case 3: return listeners.fn.call(listeners.context, a1, a2), true;
          case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;
          case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;
          case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;
        }

        for (i = 1, args = new Array(len -1); i < len; i++) {
          args[i - 1] = arguments[i];
        }

        listeners.fn.apply(listeners.context, args);
      } else {
        var length = listeners.length
          , j;

        for (i = 0; i < length; i++) {
          if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);

          switch (len) {
            case 1: listeners[i].fn.call(listeners[i].context); break;
            case 2: listeners[i].fn.call(listeners[i].context, a1); break;
            case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;
            case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;
            default:
              if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {
                args[j - 1] = arguments[j];
              }

              listeners[i].fn.apply(listeners[i].context, args);
          }
        }
      }

      return true;
    };

    /**
     * Add a listener for a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @param {Function} fn The listener function.
     * @param {*} [context=this] The context to invoke the listener with.
     * @returns {EventEmitter} `this`.
     * @public
     */
    EventEmitter.prototype.on = function on(event, fn, context) {
      return addListener(this, event, fn, context, false);
    };

    /**
     * Add a one-time listener for a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @param {Function} fn The listener function.
     * @param {*} [context=this] The context to invoke the listener with.
     * @returns {EventEmitter} `this`.
     * @public
     */
    EventEmitter.prototype.once = function once(event, fn, context) {
      return addListener(this, event, fn, context, true);
    };

    /**
     * Remove the listeners of a given event.
     *
     * @param {(String|Symbol)} event The event name.
     * @param {Function} fn Only remove the listeners that match this function.
     * @param {*} context Only remove the listeners that have this context.
     * @param {Boolean} once Only remove one-time listeners.
     * @returns {EventEmitter} `this`.
     * @public
     */
    EventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {
      var evt = prefix ? prefix + event : event;

      if (!this._events[evt]) return this;
      if (!fn) {
        clearEvent(this, evt);
        return this;
      }

      var listeners = this._events[evt];

      if (listeners.fn) {
        if (
          listeners.fn === fn &&
          (!once || listeners.once) &&
          (!context || listeners.context === context)
        ) {
          clearEvent(this, evt);
        }
      } else {
        for (var i = 0, events = [], length = listeners.length; i < length; i++) {
          if (
            listeners[i].fn !== fn ||
            (once && !listeners[i].once) ||
            (context && listeners[i].context !== context)
          ) {
            events.push(listeners[i]);
          }
        }

        //
        // Reset the array, or remove it completely if we have no more listeners.
        //
        if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;
        else clearEvent(this, evt);
      }

      return this;
    };

    /**
     * Remove all listeners, or those of the specified event.
     *
     * @param {(String|Symbol)} [event] The event name.
     * @returns {EventEmitter} `this`.
     * @public
     */
    EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {
      var evt;

      if (event) {
        evt = prefix ? prefix + event : event;
        if (this._events[evt]) clearEvent(this, evt);
      } else {
        this._events = new Events();
        this._eventsCount = 0;
      }

      return this;
    };

    //
    // Alias methods names because people roll like that.
    //
    EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
    EventEmitter.prototype.addListener = EventEmitter.prototype.on;

    //
    // Expose the prefix.
    //
    EventEmitter.prefixed = prefix;

    //
    // Allow `EventEmitter` to be imported as module namespace.
    //
    EventEmitter.EventEmitter = EventEmitter;

    //
    // Expose the module.
    //
    {
      module.exports = EventEmitter;
    }
    });

    function uuidv4() {
        if (typeof crypto !== 'undefined' &&
            typeof crypto.randomUUID === 'function') {
            return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (Math.random() * 16) | 0, v = c == 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
        });
    }
    function formatMembers(members) {
        var AvSignalMemberInfo = {
            1: 'accid',
            2: 'uid',
            3: 'createTime',
            4: 'expireTime',
            5: 'web_uid',
        };
        var parseAvSignalMember = function (member) {
            var memberParsed = {};
            Object.keys(member).forEach(function (key) {
                memberParsed[AvSignalMemberInfo[key]] = member[key];
            });
            return memberParsed;
        };
        if (typeof members === 'string') {
            members = JSON.parse(members).map(function (member) {
                return parseAvSignalMember(member);
            });
        }
        return members;
    }
    var TAG_NAME$2 = 'SignalController';
    var SignalController = /** @class */ (function (_super) {
        __extends(SignalController, _super);
        /**
         *
         * @param im im实例对象
         * @param kitName 上层kit名称
         * @param version 上层kit版本
         * @param debug 是否开启debug，输出日志
         */
        function SignalController(_a) {
            var nim = _a.nim, _b = _a.enableAutoJoinSignalChannel, enableAutoJoinSignalChannel = _b === void 0 ? false : _b, kitName = _a.kitName, kitVersion = _a.kitVersion, _c = _a.debug, debug = _c === void 0 ? true : _c, uid = _a.uid;
            var _this = _super.call(this) || this;
            _this.callStatus = SignalControllerCallingStatus.idle; // 通话状态
            _this.costTime = {
                create: 0,
                join: 0,
                invite: 0,
                cost: 0,
                accept: 0,
            };
            _this._version = '0.0.0';
            _this._offlineEnabled = true;
            if (debug) {
                _this._logger = c({
                    appName: kitName,
                    version: kitVersion,
                    level: 'trace',
                });
            }
            _this._signal = nim;
            _this._enableAutoJoinSignalChannel = enableAutoJoinSignalChannel;
            _this._uid = uid;
            _this._version = kitVersion;
            // 增加监听
            _this._addSignaladdEventListener();
            // 获取离线消息
            _this._signal.signalingSync();
            // 增加信令保活机制
            setInterval(function () {
                var _a;
                var channelId = (_a = _this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelId;
                if (channelId) {
                    _this._signal.signalingDelay({
                        channelId: channelId,
                    });
                }
            }, 2 * 60 * 1000);
            return _this;
        }
        SignalController.prototype.call = function (params) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var _c, error_1;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'call', params);
                            // 埋点
                            this.costTime.cost = Date.now();
                            if (!this._signal) {
                                throw SIGNAL_NULL;
                            }
                            if (this.callStatus !== SignalControllerCallingStatus.idle) {
                                throw CALL_BUSY;
                            }
                            _d.label = 1;
                        case 1:
                            _d.trys.push([1, 3, , 4]);
                            this._offlineEnabled = (_b = params.enableOffline) !== null && _b !== void 0 ? _b : true;
                            _c = this;
                            return [4 /*yield*/, this._signalCallEx(params)];
                        case 2:
                            _c._channelInfo = _d.sent();
                            return [2 /*return*/, this._channelInfo];
                        case 3:
                            error_1 = _d.sent();
                            throw error_1;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 接受呼叫
         * @param params
         */
        SignalController.prototype.accept = function (opt) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var _d, channelId, requestId, callerId, attachExt, error_2;
                return __generator(this, function (_e) {
                    switch (_e.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'accept', opt);
                            _e.label = 1;
                        case 1:
                            _e.trys.push([1, 3, , 4]);
                            if (!this._channelInfo) {
                                throw CHANNELINFO_NULL;
                            }
                            if (this.callStatus !== SignalControllerCallingStatus.called) {
                                throw NOT_BE_CALL;
                            }
                            if ((opt === null || opt === void 0 ? void 0 : opt.callId) && ((_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.attachExt.callId) !== opt.callId) {
                                throw CALLID_NOT_MATCH;
                            }
                            this._offlineEnabled = (_c = opt === null || opt === void 0 ? void 0 : opt.enableOffline) !== null && _c !== void 0 ? _c : true;
                            _d = this._channelInfo, channelId = _d.channelId, requestId = _d.requestId, callerId = _d.callerId, attachExt = _d.attachExt;
                            return [4 /*yield*/, this._signalAccept({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: callerId,
                                    attachExt: attachExt,
                                    nertcJoinRoomQueryParamMap: opt === null || opt === void 0 ? void 0 : opt.nertcJoinRoomQueryParamMap,
                                })];
                        case 2:
                            _e.sent();
                            return [2 /*return*/, this._channelInfo];
                        case 3:
                            error_2 = _e.sent();
                            throw error_2;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype.cancel = function (opt) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var _d, channelId, requestId, calleeId, attachExt, error_3;
                return __generator(this, function (_e) {
                    switch (_e.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'cancel', opt);
                            _e.label = 1;
                        case 1:
                            _e.trys.push([1, 3, , 4]);
                            if (!this._channelInfo) {
                                throw CHANNELINFO_NULL;
                            }
                            if (this.callStatus !== SignalControllerCallingStatus.calling) {
                                throw NOT_CALLING;
                            }
                            if ((opt === null || opt === void 0 ? void 0 : opt.callId) && ((_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.attachExt.callId) !== opt.callId) {
                                throw CALLID_NOT_MATCH;
                            }
                            this._offlineEnabled = (_c = opt === null || opt === void 0 ? void 0 : opt.enableOffline) !== null && _c !== void 0 ? _c : true;
                            _d = this._channelInfo, channelId = _d.channelId, requestId = _d.requestId, calleeId = _d.calleeId, attachExt = _d.attachExt;
                            return [4 /*yield*/, this._signalCancel({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: calleeId,
                                    attachExt: attachExt,
                                })];
                        case 2:
                            _e.sent();
                            return [3 /*break*/, 4];
                        case 3:
                            error_3 = _e.sent();
                            throw error_3;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype.reject = function (opt) {
            var _a, _b, _c, _d;
            return __awaiter(this, void 0, void 0, function () {
                var _e, channelId, attachExt, callerId, requestId, error_4;
                return __generator(this, function (_f) {
                    switch (_f.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'reject', opt);
                            _f.label = 1;
                        case 1:
                            _f.trys.push([1, 3, , 4]);
                            if (this.callStatus !== SignalControllerCallingStatus.called) {
                                throw NOT_BE_CALL;
                            }
                            if ((opt === null || opt === void 0 ? void 0 : opt.callId) && ((_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.attachExt.callId) !== opt.callId) {
                                throw CALLID_NOT_MATCH;
                            }
                            if (!this._channelInfo) {
                                throw CHANNELINFO_NULL;
                            }
                            this._offlineEnabled = (_c = opt === null || opt === void 0 ? void 0 : opt.enableOffline) !== null && _c !== void 0 ? _c : true;
                            _e = this._channelInfo, channelId = _e.channelId, attachExt = _e.attachExt, callerId = _e.callerId, requestId = _e.requestId;
                            attachExt.reason = (_d = opt === null || opt === void 0 ? void 0 : opt.reason) !== null && _d !== void 0 ? _d : 0;
                            return [4 /*yield*/, this._signalReject({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: callerId,
                                    attachExt: attachExt,
                                })];
                        case 2:
                            _f.sent();
                            return [3 /*break*/, 4];
                        case 3:
                            error_4 = _f.sent();
                            throw error_4;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 挂断，同时挂断其他人
         */
        SignalController.prototype.hangup = function (opt) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var error_5;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'hangup', opt);
                            _d.label = 1;
                        case 1:
                            _d.trys.push([1, 3, , 4]);
                            if (this.callStatus !== SignalControllerCallingStatus.inCall) {
                                throw NOT_IN_CALL;
                            }
                            if ((opt === null || opt === void 0 ? void 0 : opt.callId) && ((_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.attachExt.callId) !== opt.callId) {
                                throw CALLID_NOT_MATCH;
                            }
                            this._offlineEnabled = (_c = opt === null || opt === void 0 ? void 0 : opt.enableOffline) !== null && _c !== void 0 ? _c : true;
                            return [4 /*yield*/, this._signalClose()];
                        case 2:
                            _d.sent();
                            this.emit('afterSignalHangup');
                            return [3 /*break*/, 4];
                        case 3:
                            error_5 = _d.sent();
                            throw error_5;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 发送信息
         */
        SignalController.prototype.control = function (opt) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var error_6;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'control', opt);
                            _d.label = 1;
                        case 1:
                            _d.trys.push([1, 3, , 4]);
                            if (!this._channelInfo) {
                                throw CHANNELINFO_NULL;
                            }
                            if ((opt === null || opt === void 0 ? void 0 : opt.callId) && this._channelInfo.attachExt.callId !== opt.callId) {
                                throw CALLID_NOT_MATCH;
                            }
                            return [4 /*yield*/, this._signal.signalingControl({
                                    channelId: this._channelInfo.channelId,
                                    account: '',
                                    attachExt: JSON.stringify(__assign(__assign({}, this._channelInfo.attachExt), opt === null || opt === void 0 ? void 0 : opt.ext)),
                                })
                                // 日志
                            ];
                        case 2:
                            _d.sent();
                            // 日志
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'control success');
                            return [3 /*break*/, 4];
                        case 3:
                            error_6 = _d.sent();
                            // 日志
                            (_c = this._logger) === null || _c === void 0 ? void 0 : _c.error(TAG_NAME$2, 'control fail', error_6);
                            throw error_6;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype.reconnect = function () {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'reconnect');
            // 获取离线消息
            this._signal.signalingSync();
        };
        SignalController.prototype.resetState = function () {
            this._channelInfo = undefined;
            this.callStatus = SignalControllerCallingStatus.idle;
            this._callTimer && clearTimeout(this._callTimer);
            this._rejectTimer && clearTimeout(this._rejectTimer);
            // 埋点统计
            this.costTime = {
                create: 0,
                join: 0,
                invite: 0,
                accept: 0,
                cost: 0,
            };
        };
        SignalController.prototype.destroy = function () {
            var _a, _b, _c, _d;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.info(TAG_NAME$2, 'destroy');
            this.resetState();
            (_b = this._signal) === null || _b === void 0 ? void 0 : _b.off('signalingNotify');
            (_c = this._signal) === null || _c === void 0 ? void 0 : _c.off('signalingMutilClientSyncNotify');
            (_d = this._signal) === null || _d === void 0 ? void 0 : _d.off('signalingUnreadMessageSyncNotify');
        };
        SignalController.prototype._signalCallEx = function (params) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var attachExt, signalingCallExParams, channelInfo, error_7;
                var _this = this;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 2, , 3]);
                            attachExt = {
                                callId: params.callId || uuidv4(),
                                channelName: params.nertcChannelName || "".concat(uuidv4()),
                                rtcTokenTtl: params.nertcTokenTtl || 500,
                                version: this._version,
                                callType: 0,
                                global_extra: params.globalExtraCopy,
                                extraInfo: params.extraInfo,
                                _attachment: params.extraInfo,
                                reason: 0,
                            };
                            signalingCallExParams = {
                                uid: this._uid,
                                offlineEnabled: this._offlineEnabled,
                                account: params.accId,
                                channelName: params.signalChannelName,
                                type: params.callType,
                                requestId: uuidv4(),
                                attachExt: JSON.stringify(attachExt),
                                nertcChannelName: attachExt.channelName,
                                nertcTokenTtl: params.nertcTokenTtl,
                                nertcJoinRoomQueryParamMap: params.nertcJoinRoomQueryParamMap,
                                pushInfo: params.signalPushConfig || {
                                    pushTitle: '邀请通知',
                                    pushContent: '你收到了邀请',
                                    pushPayload: '{}',
                                    needPush: true,
                                    needBadge: true,
                                },
                            };
                            // 埋点
                            this.costTime.invite = Date.now();
                            return [4 /*yield*/, this._signal.signalingCallEx(signalingCallExParams)];
                        case 1:
                            channelInfo = (_c.sent());
                            // 补充channelInfo信息
                            this.costTime.invite = Date.now() - this.costTime.invite;
                            channelInfo.calleeId = signalingCallExParams.account;
                            channelInfo.requestId = signalingCallExParams.requestId;
                            channelInfo.members = formatMembers(channelInfo.members);
                            channelInfo.attachExt = attachExt;
                            this.callStatus = SignalControllerCallingStatus.calling;
                            // 埋点
                            this.costTime.cost = Date.now() - this.costTime.cost;
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, 'signalingCallEx success', channelInfo);
                            this.emit('afterSignalCallEx', channelInfo);
                            // 超时取消
                            if (this.callTimeout) {
                                this._callTimer = setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {
                                    var _a, channelId, requestId, calleeId, attachExt_1, error_8;
                                    var _b, _c;
                                    return __generator(this, function (_d) {
                                        switch (_d.label) {
                                            case 0:
                                                if (!(this.callStatus === SignalControllerCallingStatus.calling &&
                                                    this._channelInfo)) return [3 /*break*/, 4];
                                                this._channelInfo.attachExt.reason = 2;
                                                _a = this._channelInfo, channelId = _a.channelId, requestId = _a.requestId, calleeId = _a.calleeId, attachExt_1 = _a.attachExt;
                                                _d.label = 1;
                                            case 1:
                                                _d.trys.push([1, 3, , 4]);
                                                return [4 /*yield*/, this._signalCancel({
                                                        channelId: channelId,
                                                        requestId: requestId,
                                                        account: calleeId,
                                                        attachExt: attachExt_1,
                                                    })
                                                    // 日志
                                                ];
                                            case 2:
                                                _d.sent();
                                                // 日志
                                                (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'signalInvite timeout cancel success', this.callTimeout);
                                                return [3 /*break*/, 4];
                                            case 3:
                                                error_8 = _d.sent();
                                                // 日志
                                                (_c = this._logger) === null || _c === void 0 ? void 0 : _c.error(TAG_NAME$2, 'signalInvite timeout cancel fail', error_8, this.callTimeout);
                                                return [3 /*break*/, 4];
                                            case 4: return [2 /*return*/];
                                        }
                                    });
                                }); }, this.callTimeout);
                            }
                            return [2 /*return*/, channelInfo];
                        case 2:
                            error_7 = _c.sent();
                            // 日志
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'signalingCallEx fail', error_7);
                            throw error_7;
                        case 3: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype._addSignaladdEventListener = function () {
            var _this = this;
            var _a;
            var handleSignalEvent = function (event) { return __awaiter(_this, void 0, void 0, function () {
                var _a, _b;
                return __generator(this, function (_c) {
                    this._batchMarkEvent([event]);
                    // 当本端已经建立信令连接后，不是本个信令房间内的消息不处理
                    if (event.eventType !== 'INVITE' &&
                        event.channelId !== ((_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelId)) {
                        return [2 /*return*/];
                    }
                    // 日志
                    (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'handleSignalEvent', event.eventType, event);
                    switch (event.eventType) {
                        case 'ROOM_JOIN':
                            this._signalRoomJoinHandler(event);
                            break;
                        case 'ROOM_CLOSE':
                            this._roomCloseHandler(event);
                            break;
                        case 'LEAVE':
                            // this.signalLeaveHandler(event)
                            break;
                        case 'INVITE':
                            this._inviteHandler(event);
                            break;
                        case 'CANCEL_INVITE':
                            this._cancelInviteHandler(event);
                            break;
                        case 'REJECT':
                            this._rejectHandler(event);
                            break;
                        case 'ACCEPT':
                            this._acceptHandler(event);
                            break;
                        case 'CONTROL':
                            this._controlHandler(event);
                            break;
                    }
                    return [2 /*return*/];
                });
            }); };
            (_a = this._signal) === null || _a === void 0 ? void 0 : _a.on('signalingNotify', handleSignalEvent);
            // 在线多端同步通知
            this._signal.on('signalingMutilClientSyncNotify', function (event) { return __awaiter(_this, void 0, void 0, function () {
                var _a, _b;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, 'signalingMutilClientSyncNotify', event);
                            return [4 /*yield*/, this._batchMarkEvent([event])];
                        case 1:
                            _c.sent();
                            if (((_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.channelId) === event.channelId) {
                                switch (event.eventType) {
                                    // 拒绝邀请
                                    // 接收邀请
                                    case 'ACCEPT':
                                        this.emit('whenSignalAcceptOtherClient');
                                        this.resetState();
                                        break;
                                    case 'REJECT':
                                        this.emit('whenSignalRejectOtherClient');
                                        this.resetState();
                                        break;
                                }
                            }
                            return [2 /*return*/];
                    }
                });
            }); });
            // 离线通知，调用signalingSync后触发
            this._signal.on('signalingUnreadMessageSyncNotify', function (data) { return __awaiter(_this, void 0, void 0, function () {
                var validMessages, validMessages_1, validMessages_1_1, validMessage, e_1_1;
                var e_1, _a;
                var _b;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            // 日志
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'signalingUnreadMessageSyncNotify', data);
                            return [4 /*yield*/, this._batchMarkEvent(data)
                                // 过滤掉无效的离线消息
                            ];
                        case 1:
                            _c.sent();
                            validMessages = data.filter(function (item) { return !item.channelInValid; });
                            _c.label = 2;
                        case 2:
                            _c.trys.push([2, 7, 8, 9]);
                            validMessages_1 = __values(validMessages), validMessages_1_1 = validMessages_1.next();
                            _c.label = 3;
                        case 3:
                            if (!!validMessages_1_1.done) return [3 /*break*/, 6];
                            validMessage = validMessages_1_1.value;
                            return [4 /*yield*/, handleSignalEvent(validMessage)];
                        case 4:
                            _c.sent();
                            _c.label = 5;
                        case 5:
                            validMessages_1_1 = validMessages_1.next();
                            return [3 /*break*/, 3];
                        case 6: return [3 /*break*/, 9];
                        case 7:
                            e_1_1 = _c.sent();
                            e_1 = { error: e_1_1 };
                            return [3 /*break*/, 9];
                        case 8:
                            try {
                                if (validMessages_1_1 && !validMessages_1_1.done && (_a = validMessages_1.return)) _a.call(validMessages_1);
                            }
                            finally { if (e_1) throw e_1.error; }
                            return [7 /*endfinally*/];
                        case 9: return [2 /*return*/];
                    }
                });
            }); });
        };
        SignalController.prototype._inviteHandler = function (event) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var channelId, requestId, account, attachExt, _b, _c;
                var _this = this;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            if (event.channelInValid) {
                                return [2 /*return*/];
                            }
                            channelId = event.channelId;
                            requestId = event.requestId;
                            account = event.from;
                            try {
                                attachExt = JSON.parse(event.attachExt);
                            }
                            catch (error) {
                                // 日志
                                (_a = this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$2, 'inviteHandler parse attachExt fail', error);
                                throw error;
                            }
                            if (!(this.callStatus !== SignalControllerCallingStatus.idle)) return [3 /*break*/, 2];
                            attachExt.reason = 3;
                            return [4 /*yield*/, this._signalReject({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: account,
                                    attachExt: attachExt,
                                })];
                        case 1:
                            _d.sent();
                            return [2 /*return*/];
                        case 2:
                            if (!this._enableAutoJoinSignalChannel) return [3 /*break*/, 4];
                            _b = this;
                            return [4 /*yield*/, this._signal.signalingJoin({
                                    channelId: event.channelId,
                                    // uid: this._uid,
                                    // nertcChannelName: attachExt.channelName,
                                    nertcTokenTtl: attachExt.rtcTokenTtl,
                                    offlineEnabled: this._offlineEnabled,
                                    attachExt: event.attachExt,
                                })];
                        case 3:
                            _b._channelInfo = (_d.sent());
                            return [3 /*break*/, 6];
                        case 4:
                            _c = this;
                            return [4 /*yield*/, this._signal.signalingGetChannelInfo({
                                    channelName: event.channelName,
                                })];
                        case 5:
                            _c._channelInfo = (_d.sent());
                            _d.label = 6;
                        case 6:
                            this._channelInfo.callerId = account;
                            this._channelInfo.requestId = requestId;
                            this._channelInfo.attachExt = attachExt;
                            this.callStatus = SignalControllerCallingStatus.called;
                            this.emit('whenSignalInvite', this._channelInfo);
                            if (this.rejectTimeout) {
                                this._rejectTimer = setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {
                                    var error_9;
                                    var _a, _b;
                                    return __generator(this, function (_c) {
                                        switch (_c.label) {
                                            case 0:
                                                if (!(this.callStatus === SignalControllerCallingStatus.called)) return [3 /*break*/, 4];
                                                attachExt.reason = 2;
                                                _c.label = 1;
                                            case 1:
                                                _c.trys.push([1, 3, , 4]);
                                                return [4 /*yield*/, this._signalReject({
                                                        channelId: channelId,
                                                        requestId: requestId,
                                                        account: account,
                                                        attachExt: attachExt,
                                                    })];
                                            case 2:
                                                _c.sent();
                                                (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, 'inviteHandler reject timeout cancel success', this.rejectTimeout);
                                                return [3 /*break*/, 4];
                                            case 3:
                                                error_9 = _c.sent();
                                                (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'inviteHandler reject timeout cancel fail: ', error_9, this.rejectTimeout);
                                                return [3 /*break*/, 4];
                                            case 4: return [2 /*return*/];
                                        }
                                    });
                                }); }, this.rejectTimeout);
                            }
                            return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype._signalRoomJoinHandler = function (event) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var channelInfo;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0: return [4 /*yield*/, this._signal.signalingGetChannelInfo({
                                channelName: (_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelName,
                            })];
                        case 1:
                            channelInfo = (_b.sent());
                            this._channelInfo = __assign(__assign({}, this._channelInfo), channelInfo);
                            this.emit('whenSignalRoomJoin', this._channelInfo);
                            return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype._roomCloseHandler = function (event) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_b) {
                    // 如果是channelId不对应，则不处理
                    if (event.channelId !== ((_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelId)) {
                        return [2 /*return*/];
                    }
                    this.emit('whenSignalRoomClose');
                    this.resetState();
                    return [2 /*return*/];
                });
            });
        };
        SignalController.prototype._cancelInviteHandler = function (event) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var attachExt;
                return __generator(this, function (_b) {
                    try {
                        attachExt = JSON.parse(event.attachExt);
                    }
                    catch (error) {
                        (_a = this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$2, 'inviteHandler:', 'parse attachExt error:', error);
                        throw error;
                    }
                    this.emit('whenSignalCancel', attachExt);
                    this.resetState();
                    return [2 /*return*/];
                });
            });
        };
        SignalController.prototype._rejectHandler = function (event) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var from, calleeId, attachExt, reason;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            from = event.from;
                            calleeId = (_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.calleeId;
                            if (!(calleeId === from)) return [3 /*break*/, 5];
                            attachExt = void 0;
                            try {
                                attachExt = JSON.parse(event.attachExt);
                            }
                            catch (error) {
                                (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'inviteHandler:', 'parse attachExt error:', error);
                                throw error;
                            }
                            reason = attachExt.reason;
                            if (!(reason === 3)) return [3 /*break*/, 2];
                            return [4 /*yield*/, this._sendMessage(calleeId, 'busy')];
                        case 1:
                            _c.sent();
                            return [3 /*break*/, 4];
                        case 2: return [4 /*yield*/, this._sendMessage(calleeId, 'rejected')];
                        case 3:
                            _c.sent();
                            _c.label = 4;
                        case 4:
                            this.emit('whenSignalReject', attachExt);
                            this._signalClose();
                            _c.label = 5;
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype._acceptHandler = function (event) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var channelInfo, error_10;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            this.callStatus = SignalControllerCallingStatus.inCall;
                            this._callTimer && clearTimeout(this._callTimer);
                            _d.label = 1;
                        case 1:
                            _d.trys.push([1, 3, , 4]);
                            return [4 /*yield*/, this._signal.signalingGetChannelInfo({
                                    channelName: (_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelName,
                                })];
                        case 2:
                            channelInfo = (_d.sent());
                            this._channelInfo = __assign(__assign({}, this._channelInfo), channelInfo);
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'acceptHandler from signal success:', event);
                            this.emit('whenSignalAccept', this._channelInfo);
                            return [3 /*break*/, 4];
                        case 3:
                            error_10 = _d.sent();
                            (_c = this._logger) === null || _c === void 0 ? void 0 : _c.error(TAG_NAME$2, 'acceptHandler error:', error_10);
                            throw error_10;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        SignalController.prototype._controlHandler = function (event) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var attachExt;
                return __generator(this, function (_d) {
                    try {
                        attachExt = void 0;
                        try {
                            attachExt = JSON.parse(event.attachExt);
                        }
                        catch (error) {
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$2, 'inviteHandler:', 'parse attachExt error:', error);
                            throw error;
                        }
                        (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'controlHandler from signal success:', event);
                        this.emit('whenSignalControl', attachExt);
                    }
                    catch (error) {
                        (_c = this._logger) === null || _c === void 0 ? void 0 : _c.error(TAG_NAME$2, 'controlHandler error:', error);
                        throw error;
                    }
                    return [2 /*return*/];
                });
            });
        };
        /**
         * 接收呼叫
         */
        SignalController.prototype._signalAccept = function (params) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var channelId, requestId, account, attachExt, channelInfo, error_11;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 5, , 6]);
                            // 埋点
                            this.costTime.accept = Date.now();
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, '_signalAccept:', this._enableAutoJoinSignalChannel, this._channelInfo, params === null || params === void 0 ? void 0 : params.nertcJoinRoomQueryParamMap);
                            channelId = params.channelId, requestId = params.requestId, account = params.account, attachExt = params.attachExt;
                            if (!!this._enableAutoJoinSignalChannel) return [3 /*break*/, 2];
                            return [4 /*yield*/, this._signal.signalingJoinAndAccept({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: account,
                                    offlineEnabled: this._offlineEnabled,
                                    attachExt: JSON.stringify(attachExt),
                                    uid: this._uid,
                                    nertcChannelName: attachExt.channelName,
                                    nertcTokenTtl: attachExt.rtcTokenTtl,
                                    nertcJoinRoomQueryParamMap: params === null || params === void 0 ? void 0 : params.nertcJoinRoomQueryParamMap,
                                })];
                        case 1:
                            channelInfo = (_c.sent());
                            channelInfo.members = formatMembers(channelInfo.members);
                            this._channelInfo = __assign(__assign({}, this._channelInfo), channelInfo);
                            return [3 /*break*/, 4];
                        case 2: return [4 /*yield*/, this._signal.signalingAccept({
                                channelId: channelId,
                                requestId: requestId,
                                account: account,
                                offlineEnabled: this._offlineEnabled,
                                attachExt: JSON.stringify(attachExt),
                            })];
                        case 3:
                            _c.sent();
                            _c.label = 4;
                        case 4:
                            // 埋点
                            this.costTime.accept = Date.now() - this.costTime.accept;
                            this.callStatus = SignalControllerCallingStatus.inCall;
                            this._channelInfo && this.emit('afterSignalAccept', this._channelInfo);
                            this._rejectTimer && clearTimeout(this._rejectTimer);
                            return [3 /*break*/, 6];
                        case 5:
                            error_11 = _c.sent();
                            // 这里不做处理，由 rejectTimer 事件处理
                            // this._signalClose()
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'acceptSignal fail:', error_11);
                            throw error_11;
                        case 6: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 取消呼叫中的信令
         */
        SignalController.prototype._signalCancel = function (params) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var channelId, requestId, account, attachExt, reason, error_12;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            channelId = params.channelId, requestId = params.requestId, account = params.account, attachExt = params.attachExt;
                            reason = attachExt.reason;
                            _c.label = 1;
                        case 1:
                            _c.trys.push([1, 3, 4, 5]);
                            return [4 /*yield*/, this._signal.signalingCancel({
                                    channelId: channelId,
                                    requestId: requestId,
                                    account: account,
                                    offlineEnabled: this._offlineEnabled,
                                    attachExt: JSON.stringify(attachExt),
                                })];
                        case 2:
                            _c.sent();
                            if (reason === 2) {
                                this._sendMessage(account, 'timeout');
                            }
                            else {
                                this._sendMessage(account, 'canceled');
                            }
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, 'signalCancel success');
                            return [3 /*break*/, 5];
                        case 3:
                            error_12 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'signalCancel failed:', error_12);
                            throw error_12;
                        case 4:
                            this.emit('afterSignalCancel', { reason: reason });
                            this._signalClose();
                            this._callTimer && clearTimeout(this._callTimer);
                            return [7 /*endfinally*/];
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 拒绝通话，可能通过占线、超时、主动等方式触发
         */
        SignalController.prototype._signalReject = function (opt) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var reason, error_13;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            reason = opt.attachExt.reason;
                            _c.label = 1;
                        case 1:
                            _c.trys.push([1, 3, 4, 5]);
                            return [4 /*yield*/, this._signal.signalingReject(__assign(__assign({}, opt), { attachExt: JSON.stringify(opt.attachExt), offlineEnabled: this._offlineEnabled }))];
                        case 2:
                            _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, 'rejectReject success');
                            return [3 /*break*/, 5];
                        case 3:
                            error_13 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$2, 'rejectReject failed:', error_13);
                            throw error_13;
                        case 4:
                            if (reason !== 3) {
                                this.emit('afterSignalReject', { reason: reason });
                                this.resetState();
                            }
                            return [7 /*endfinally*/];
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 关闭信令房间
         */
        SignalController.prototype._signalClose = function () {
            var _a, _b, _c, _d;
            return __awaiter(this, void 0, void 0, function () {
                var channelId, attachExt, error_14;
                return __generator(this, function (_e) {
                    switch (_e.label) {
                        case 0:
                            _e.trys.push([0, 2, 3, 4]);
                            channelId = (_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.channelId;
                            attachExt = (_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.attachExt;
                            return [4 /*yield*/, this._signal.signalingClose({
                                    channelId: channelId,
                                    offlineEnabled: this._offlineEnabled,
                                    attachExt: JSON.stringify(attachExt),
                                })];
                        case 1:
                            _e.sent();
                            (_c = this._logger) === null || _c === void 0 ? void 0 : _c.log('signalClose success');
                            return [3 /*break*/, 4];
                        case 2:
                            error_14 = _e.sent();
                            // 这里忽略关闭房间的错误
                            (_d = this._logger) === null || _d === void 0 ? void 0 : _d.warn(TAG_NAME$2, 'signalClose fail but resolve:', this._channelInfo, error_14);
                            return [3 /*break*/, 4];
                        case 3:
                            this.resetState();
                            return [7 /*endfinally*/];
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 批量标记消息已读
         * @param events
         */
        SignalController.prototype._batchMarkEvent = function (events) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var msgids, e_2;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 2, , 3]);
                            msgids = events.map(function (item) { return item.msgid + ''; });
                            return [4 /*yield*/, this._signal.signalingMarkMsgRead({
                                    msgid: msgids,
                                })];
                        case 1:
                            _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$2, '在线 signalingMarkMsgRead success');
                            return [3 /*break*/, 3];
                        case 2:
                            e_2 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.warn(TAG_NAME$2, '在线 signalingMarkMsgRead fail: ', e_2);
                            return [3 /*break*/, 3];
                        case 3: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 单人通话下，需要通知服务端退出的情况
         * @param userId IM的account账号
         * @param status
         */
        SignalController.prototype._sendMessage = function (userId, status) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var statusMap, attach;
                var _this = this;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            statusMap = {
                                canceled: 2,
                                rejected: 3,
                                timeout: 4,
                                busy: 5,
                            };
                            attach = {
                                type: (_a = this._channelInfo) === null || _a === void 0 ? void 0 : _a.type,
                                channelId: (_b = this._channelInfo) === null || _b === void 0 ? void 0 : _b.channelId,
                                status: statusMap[status],
                                durations: [],
                            };
                            return [4 /*yield*/, new Promise(function (resolve, reject) {
                                    _this._signal.sendG2Msg({
                                        attach: attach,
                                        scene: 'p2p',
                                        to: userId,
                                        done: function (error) {
                                            var _a, _b;
                                            if (error) {
                                                (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$2, 'sendMessage fail:', attach, error);
                                                return reject(error);
                                            }
                                            (_b = _this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$2, 'sendMessage success', attach, userId);
                                            _this.emit('afterMessageSend', {
                                                account: userId,
                                                attach: attach,
                                            });
                                            resolve();
                                        },
                                    });
                                })];
                        case 1: return [2 /*return*/, _c.sent()];
                    }
                });
            });
        };
        return SignalController;
    }(eventemitter3));

    var bind = function bind(fn, thisArg) {
      return function wrap() {
        var args = new Array(arguments.length);
        for (var i = 0; i < args.length; i++) {
          args[i] = arguments[i];
        }
        return fn.apply(thisArg, args);
      };
    };

    // utils is a library of generic helper functions non-specific to axios

    var toString = Object.prototype.toString;

    // eslint-disable-next-line func-names
    var kindOf = (function(cache) {
      // eslint-disable-next-line func-names
      return function(thing) {
        var str = toString.call(thing);
        return cache[str] || (cache[str] = str.slice(8, -1).toLowerCase());
      };
    })(Object.create(null));

    function kindOfTest(type) {
      type = type.toLowerCase();
      return function isKindOf(thing) {
        return kindOf(thing) === type;
      };
    }

    /**
     * Determine if a value is an Array
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is an Array, otherwise false
     */
    function isArray(val) {
      return Array.isArray(val);
    }

    /**
     * Determine if a value is undefined
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if the value is undefined, otherwise false
     */
    function isUndefined(val) {
      return typeof val === 'undefined';
    }

    /**
     * Determine if a value is a Buffer
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Buffer, otherwise false
     */
    function isBuffer(val) {
      return val !== null && !isUndefined(val) && val.constructor !== null && !isUndefined(val.constructor)
        && typeof val.constructor.isBuffer === 'function' && val.constructor.isBuffer(val);
    }

    /**
     * Determine if a value is an ArrayBuffer
     *
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is an ArrayBuffer, otherwise false
     */
    var isArrayBuffer = kindOfTest('ArrayBuffer');


    /**
     * Determine if a value is a view on an ArrayBuffer
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a view on an ArrayBuffer, otherwise false
     */
    function isArrayBufferView(val) {
      var result;
      if ((typeof ArrayBuffer !== 'undefined') && (ArrayBuffer.isView)) {
        result = ArrayBuffer.isView(val);
      } else {
        result = (val) && (val.buffer) && (isArrayBuffer(val.buffer));
      }
      return result;
    }

    /**
     * Determine if a value is a String
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a String, otherwise false
     */
    function isString(val) {
      return typeof val === 'string';
    }

    /**
     * Determine if a value is a Number
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Number, otherwise false
     */
    function isNumber(val) {
      return typeof val === 'number';
    }

    /**
     * Determine if a value is an Object
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is an Object, otherwise false
     */
    function isObject(val) {
      return val !== null && typeof val === 'object';
    }

    /**
     * Determine if a value is a plain Object
     *
     * @param {Object} val The value to test
     * @return {boolean} True if value is a plain Object, otherwise false
     */
    function isPlainObject(val) {
      if (kindOf(val) !== 'object') {
        return false;
      }

      var prototype = Object.getPrototypeOf(val);
      return prototype === null || prototype === Object.prototype;
    }

    /**
     * Determine if a value is a Date
     *
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Date, otherwise false
     */
    var isDate = kindOfTest('Date');

    /**
     * Determine if a value is a File
     *
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a File, otherwise false
     */
    var isFile = kindOfTest('File');

    /**
     * Determine if a value is a Blob
     *
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Blob, otherwise false
     */
    var isBlob = kindOfTest('Blob');

    /**
     * Determine if a value is a FileList
     *
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a File, otherwise false
     */
    var isFileList = kindOfTest('FileList');

    /**
     * Determine if a value is a Function
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Function, otherwise false
     */
    function isFunction(val) {
      return toString.call(val) === '[object Function]';
    }

    /**
     * Determine if a value is a Stream
     *
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a Stream, otherwise false
     */
    function isStream(val) {
      return isObject(val) && isFunction(val.pipe);
    }

    /**
     * Determine if a value is a FormData
     *
     * @param {Object} thing The value to test
     * @returns {boolean} True if value is an FormData, otherwise false
     */
    function isFormData(thing) {
      var pattern = '[object FormData]';
      return thing && (
        (typeof FormData === 'function' && thing instanceof FormData) ||
        toString.call(thing) === pattern ||
        (isFunction(thing.toString) && thing.toString() === pattern)
      );
    }

    /**
     * Determine if a value is a URLSearchParams object
     * @function
     * @param {Object} val The value to test
     * @returns {boolean} True if value is a URLSearchParams object, otherwise false
     */
    var isURLSearchParams = kindOfTest('URLSearchParams');

    /**
     * Trim excess whitespace off the beginning and end of a string
     *
     * @param {String} str The String to trim
     * @returns {String} The String freed of excess whitespace
     */
    function trim(str) {
      return str.trim ? str.trim() : str.replace(/^\s+|\s+$/g, '');
    }

    /**
     * Determine if we're running in a standard browser environment
     *
     * This allows axios to run in a web worker, and react-native.
     * Both environments support XMLHttpRequest, but not fully standard globals.
     *
     * web workers:
     *  typeof window -> undefined
     *  typeof document -> undefined
     *
     * react-native:
     *  navigator.product -> 'ReactNative'
     * nativescript
     *  navigator.product -> 'NativeScript' or 'NS'
     */
    function isStandardBrowserEnv() {
      if (typeof navigator !== 'undefined' && (navigator.product === 'ReactNative' ||
                                               navigator.product === 'NativeScript' ||
                                               navigator.product === 'NS')) {
        return false;
      }
      return (
        typeof window !== 'undefined' &&
        typeof document !== 'undefined'
      );
    }

    /**
     * Iterate over an Array or an Object invoking a function for each item.
     *
     * If `obj` is an Array callback will be called passing
     * the value, index, and complete array for each item.
     *
     * If 'obj' is an Object callback will be called passing
     * the value, key, and complete object for each property.
     *
     * @param {Object|Array} obj The object to iterate
     * @param {Function} fn The callback to invoke for each item
     */
    function forEach(obj, fn) {
      // Don't bother if no value provided
      if (obj === null || typeof obj === 'undefined') {
        return;
      }

      // Force an array if not already something iterable
      if (typeof obj !== 'object') {
        /*eslint no-param-reassign:0*/
        obj = [obj];
      }

      if (isArray(obj)) {
        // Iterate over array values
        for (var i = 0, l = obj.length; i < l; i++) {
          fn.call(null, obj[i], i, obj);
        }
      } else {
        // Iterate over object keys
        for (var key in obj) {
          if (Object.prototype.hasOwnProperty.call(obj, key)) {
            fn.call(null, obj[key], key, obj);
          }
        }
      }
    }

    /**
     * Accepts varargs expecting each argument to be an object, then
     * immutably merges the properties of each object and returns result.
     *
     * When multiple objects contain the same key the later object in
     * the arguments list will take precedence.
     *
     * Example:
     *
     * ```js
     * var result = merge({foo: 123}, {foo: 456});
     * console.log(result.foo); // outputs 456
     * ```
     *
     * @param {Object} obj1 Object to merge
     * @returns {Object} Result of all merge properties
     */
    function merge(/* obj1, obj2, obj3, ... */) {
      var result = {};
      function assignValue(val, key) {
        if (isPlainObject(result[key]) && isPlainObject(val)) {
          result[key] = merge(result[key], val);
        } else if (isPlainObject(val)) {
          result[key] = merge({}, val);
        } else if (isArray(val)) {
          result[key] = val.slice();
        } else {
          result[key] = val;
        }
      }

      for (var i = 0, l = arguments.length; i < l; i++) {
        forEach(arguments[i], assignValue);
      }
      return result;
    }

    /**
     * Extends object a by mutably adding to it the properties of object b.
     *
     * @param {Object} a The object to be extended
     * @param {Object} b The object to copy properties from
     * @param {Object} thisArg The object to bind function to
     * @return {Object} The resulting value of object a
     */
    function extend(a, b, thisArg) {
      forEach(b, function assignValue(val, key) {
        if (thisArg && typeof val === 'function') {
          a[key] = bind(val, thisArg);
        } else {
          a[key] = val;
        }
      });
      return a;
    }

    /**
     * Remove byte order marker. This catches EF BB BF (the UTF-8 BOM)
     *
     * @param {string} content with BOM
     * @return {string} content value without BOM
     */
    function stripBOM(content) {
      if (content.charCodeAt(0) === 0xFEFF) {
        content = content.slice(1);
      }
      return content;
    }

    /**
     * Inherit the prototype methods from one constructor into another
     * @param {function} constructor
     * @param {function} superConstructor
     * @param {object} [props]
     * @param {object} [descriptors]
     */

    function inherits(constructor, superConstructor, props, descriptors) {
      constructor.prototype = Object.create(superConstructor.prototype, descriptors);
      constructor.prototype.constructor = constructor;
      props && Object.assign(constructor.prototype, props);
    }

    /**
     * Resolve object with deep prototype chain to a flat object
     * @param {Object} sourceObj source object
     * @param {Object} [destObj]
     * @param {Function} [filter]
     * @returns {Object}
     */

    function toFlatObject(sourceObj, destObj, filter) {
      var props;
      var i;
      var prop;
      var merged = {};

      destObj = destObj || {};

      do {
        props = Object.getOwnPropertyNames(sourceObj);
        i = props.length;
        while (i-- > 0) {
          prop = props[i];
          if (!merged[prop]) {
            destObj[prop] = sourceObj[prop];
            merged[prop] = true;
          }
        }
        sourceObj = Object.getPrototypeOf(sourceObj);
      } while (sourceObj && (!filter || filter(sourceObj, destObj)) && sourceObj !== Object.prototype);

      return destObj;
    }

    /*
     * determines whether a string ends with the characters of a specified string
     * @param {String} str
     * @param {String} searchString
     * @param {Number} [position= 0]
     * @returns {boolean}
     */
    function endsWith(str, searchString, position) {
      str = String(str);
      if (position === undefined || position > str.length) {
        position = str.length;
      }
      position -= searchString.length;
      var lastIndex = str.indexOf(searchString, position);
      return lastIndex !== -1 && lastIndex === position;
    }


    /**
     * Returns new array from array like object
     * @param {*} [thing]
     * @returns {Array}
     */
    function toArray(thing) {
      if (!thing) return null;
      var i = thing.length;
      if (isUndefined(i)) return null;
      var arr = new Array(i);
      while (i-- > 0) {
        arr[i] = thing[i];
      }
      return arr;
    }

    // eslint-disable-next-line func-names
    var isTypedArray = (function(TypedArray) {
      // eslint-disable-next-line func-names
      return function(thing) {
        return TypedArray && thing instanceof TypedArray;
      };
    })(typeof Uint8Array !== 'undefined' && Object.getPrototypeOf(Uint8Array));

    var utils = {
      isArray: isArray,
      isArrayBuffer: isArrayBuffer,
      isBuffer: isBuffer,
      isFormData: isFormData,
      isArrayBufferView: isArrayBufferView,
      isString: isString,
      isNumber: isNumber,
      isObject: isObject,
      isPlainObject: isPlainObject,
      isUndefined: isUndefined,
      isDate: isDate,
      isFile: isFile,
      isBlob: isBlob,
      isFunction: isFunction,
      isStream: isStream,
      isURLSearchParams: isURLSearchParams,
      isStandardBrowserEnv: isStandardBrowserEnv,
      forEach: forEach,
      merge: merge,
      extend: extend,
      trim: trim,
      stripBOM: stripBOM,
      inherits: inherits,
      toFlatObject: toFlatObject,
      kindOf: kindOf,
      kindOfTest: kindOfTest,
      endsWith: endsWith,
      toArray: toArray,
      isTypedArray: isTypedArray,
      isFileList: isFileList
    };

    function encode(val) {
      return encodeURIComponent(val).
        replace(/%3A/gi, ':').
        replace(/%24/g, '$').
        replace(/%2C/gi, ',').
        replace(/%20/g, '+').
        replace(/%5B/gi, '[').
        replace(/%5D/gi, ']');
    }

    /**
     * Build a URL by appending params to the end
     *
     * @param {string} url The base of the url (e.g., http://www.google.com)
     * @param {object} [params] The params to be appended
     * @returns {string} The formatted url
     */
    var buildURL = function buildURL(url, params, paramsSerializer) {
      /*eslint no-param-reassign:0*/
      if (!params) {
        return url;
      }

      var serializedParams;
      if (paramsSerializer) {
        serializedParams = paramsSerializer(params);
      } else if (utils.isURLSearchParams(params)) {
        serializedParams = params.toString();
      } else {
        var parts = [];

        utils.forEach(params, function serialize(val, key) {
          if (val === null || typeof val === 'undefined') {
            return;
          }

          if (utils.isArray(val)) {
            key = key + '[]';
          } else {
            val = [val];
          }

          utils.forEach(val, function parseValue(v) {
            if (utils.isDate(v)) {
              v = v.toISOString();
            } else if (utils.isObject(v)) {
              v = JSON.stringify(v);
            }
            parts.push(encode(key) + '=' + encode(v));
          });
        });

        serializedParams = parts.join('&');
      }

      if (serializedParams) {
        var hashmarkIndex = url.indexOf('#');
        if (hashmarkIndex !== -1) {
          url = url.slice(0, hashmarkIndex);
        }

        url += (url.indexOf('?') === -1 ? '?' : '&') + serializedParams;
      }

      return url;
    };

    function InterceptorManager() {
      this.handlers = [];
    }

    /**
     * Add a new interceptor to the stack
     *
     * @param {Function} fulfilled The function to handle `then` for a `Promise`
     * @param {Function} rejected The function to handle `reject` for a `Promise`
     *
     * @return {Number} An ID used to remove interceptor later
     */
    InterceptorManager.prototype.use = function use(fulfilled, rejected, options) {
      this.handlers.push({
        fulfilled: fulfilled,
        rejected: rejected,
        synchronous: options ? options.synchronous : false,
        runWhen: options ? options.runWhen : null
      });
      return this.handlers.length - 1;
    };

    /**
     * Remove an interceptor from the stack
     *
     * @param {Number} id The ID that was returned by `use`
     */
    InterceptorManager.prototype.eject = function eject(id) {
      if (this.handlers[id]) {
        this.handlers[id] = null;
      }
    };

    /**
     * Iterate over all the registered interceptors
     *
     * This method is particularly useful for skipping over any
     * interceptors that may have become `null` calling `eject`.
     *
     * @param {Function} fn The function to call for each interceptor
     */
    InterceptorManager.prototype.forEach = function forEach(fn) {
      utils.forEach(this.handlers, function forEachHandler(h) {
        if (h !== null) {
          fn(h);
        }
      });
    };

    var InterceptorManager_1 = InterceptorManager;

    var normalizeHeaderName = function normalizeHeaderName(headers, normalizedName) {
      utils.forEach(headers, function processHeader(value, name) {
        if (name !== normalizedName && name.toUpperCase() === normalizedName.toUpperCase()) {
          headers[normalizedName] = value;
          delete headers[name];
        }
      });
    };

    /**
     * Create an Error with the specified message, config, error code, request and response.
     *
     * @param {string} message The error message.
     * @param {string} [code] The error code (for example, 'ECONNABORTED').
     * @param {Object} [config] The config.
     * @param {Object} [request] The request.
     * @param {Object} [response] The response.
     * @returns {Error} The created error.
     */
    function AxiosError(message, code, config, request, response) {
      Error.call(this);
      this.message = message;
      this.name = 'AxiosError';
      code && (this.code = code);
      config && (this.config = config);
      request && (this.request = request);
      response && (this.response = response);
    }

    utils.inherits(AxiosError, Error, {
      toJSON: function toJSON() {
        return {
          // Standard
          message: this.message,
          name: this.name,
          // Microsoft
          description: this.description,
          number: this.number,
          // Mozilla
          fileName: this.fileName,
          lineNumber: this.lineNumber,
          columnNumber: this.columnNumber,
          stack: this.stack,
          // Axios
          config: this.config,
          code: this.code,
          status: this.response && this.response.status ? this.response.status : null
        };
      }
    });

    var prototype = AxiosError.prototype;
    var descriptors = {};

    [
      'ERR_BAD_OPTION_VALUE',
      'ERR_BAD_OPTION',
      'ECONNABORTED',
      'ETIMEDOUT',
      'ERR_NETWORK',
      'ERR_FR_TOO_MANY_REDIRECTS',
      'ERR_DEPRECATED',
      'ERR_BAD_RESPONSE',
      'ERR_BAD_REQUEST',
      'ERR_CANCELED'
    // eslint-disable-next-line func-names
    ].forEach(function(code) {
      descriptors[code] = {value: code};
    });

    Object.defineProperties(AxiosError, descriptors);
    Object.defineProperty(prototype, 'isAxiosError', {value: true});

    // eslint-disable-next-line func-names
    AxiosError.from = function(error, code, config, request, response, customProps) {
      var axiosError = Object.create(prototype);

      utils.toFlatObject(error, axiosError, function filter(obj) {
        return obj !== Error.prototype;
      });

      AxiosError.call(axiosError, error.message, code, config, request, response);

      axiosError.name = error.name;

      customProps && Object.assign(axiosError, customProps);

      return axiosError;
    };

    var AxiosError_1 = AxiosError;

    var transitional = {
      silentJSONParsing: true,
      forcedJSONParsing: true,
      clarifyTimeoutError: false
    };
    transitional.silentJSONParsing;
    transitional.forcedJSONParsing;
    transitional.clarifyTimeoutError;

    /**
     * Convert a data object to FormData
     * @param {Object} obj
     * @param {?Object} [formData]
     * @returns {Object}
     **/

    function toFormData(obj, formData) {
      // eslint-disable-next-line no-param-reassign
      formData = formData || new FormData();

      var stack = [];

      function convertValue(value) {
        if (value === null) return '';

        if (utils.isDate(value)) {
          return value.toISOString();
        }

        if (utils.isArrayBuffer(value) || utils.isTypedArray(value)) {
          return typeof Blob === 'function' ? new Blob([value]) : Buffer.from(value);
        }

        return value;
      }

      function build(data, parentKey) {
        if (utils.isPlainObject(data) || utils.isArray(data)) {
          if (stack.indexOf(data) !== -1) {
            throw Error('Circular reference detected in ' + parentKey);
          }

          stack.push(data);

          utils.forEach(data, function each(value, key) {
            if (utils.isUndefined(value)) return;
            var fullKey = parentKey ? parentKey + '.' + key : key;
            var arr;

            if (value && !parentKey && typeof value === 'object') {
              if (utils.endsWith(key, '{}')) {
                // eslint-disable-next-line no-param-reassign
                value = JSON.stringify(value);
              } else if (utils.endsWith(key, '[]') && (arr = utils.toArray(value))) {
                // eslint-disable-next-line func-names
                arr.forEach(function(el) {
                  !utils.isUndefined(el) && formData.append(fullKey, convertValue(el));
                });
                return;
              }
            }

            build(value, fullKey);
          });

          stack.pop();
        } else {
          formData.append(parentKey, convertValue(data));
        }
      }

      build(obj);

      return formData;
    }

    var toFormData_1 = toFormData;

    /**
     * Resolve or reject a Promise based on response status.
     *
     * @param {Function} resolve A function that resolves the promise.
     * @param {Function} reject A function that rejects the promise.
     * @param {object} response The response.
     */
    var settle = function settle(resolve, reject, response) {
      var validateStatus = response.config.validateStatus;
      if (!response.status || !validateStatus || validateStatus(response.status)) {
        resolve(response);
      } else {
        reject(new AxiosError_1(
          'Request failed with status code ' + response.status,
          [AxiosError_1.ERR_BAD_REQUEST, AxiosError_1.ERR_BAD_RESPONSE][Math.floor(response.status / 100) - 4],
          response.config,
          response.request,
          response
        ));
      }
    };

    var cookies = (
      utils.isStandardBrowserEnv() ?

      // Standard browser envs support document.cookie
        (function standardBrowserEnv() {
          return {
            write: function write(name, value, expires, path, domain, secure) {
              var cookie = [];
              cookie.push(name + '=' + encodeURIComponent(value));

              if (utils.isNumber(expires)) {
                cookie.push('expires=' + new Date(expires).toGMTString());
              }

              if (utils.isString(path)) {
                cookie.push('path=' + path);
              }

              if (utils.isString(domain)) {
                cookie.push('domain=' + domain);
              }

              if (secure === true) {
                cookie.push('secure');
              }

              document.cookie = cookie.join('; ');
            },

            read: function read(name) {
              var match = document.cookie.match(new RegExp('(^|;\\s*)(' + name + ')=([^;]*)'));
              return (match ? decodeURIComponent(match[3]) : null);
            },

            remove: function remove(name) {
              this.write(name, '', Date.now() - 86400000);
            }
          };
        })() :

      // Non standard browser env (web workers, react-native) lack needed support.
        (function nonStandardBrowserEnv() {
          return {
            write: function write() {},
            read: function read() { return null; },
            remove: function remove() {}
          };
        })()
    );

    /**
     * Determines whether the specified URL is absolute
     *
     * @param {string} url The URL to test
     * @returns {boolean} True if the specified URL is absolute, otherwise false
     */
    var isAbsoluteURL = function isAbsoluteURL(url) {
      // A URL is considered absolute if it begins with "<scheme>://" or "//" (protocol-relative URL).
      // RFC 3986 defines scheme name as a sequence of characters beginning with a letter and followed
      // by any combination of letters, digits, plus, period, or hyphen.
      return /^([a-z][a-z\d+\-.]*:)?\/\//i.test(url);
    };

    /**
     * Creates a new URL by combining the specified URLs
     *
     * @param {string} baseURL The base URL
     * @param {string} relativeURL The relative URL
     * @returns {string} The combined URL
     */
    var combineURLs = function combineURLs(baseURL, relativeURL) {
      return relativeURL
        ? baseURL.replace(/\/+$/, '') + '/' + relativeURL.replace(/^\/+/, '')
        : baseURL;
    };

    /**
     * Creates a new URL by combining the baseURL with the requestedURL,
     * only when the requestedURL is not already an absolute URL.
     * If the requestURL is absolute, this function returns the requestedURL untouched.
     *
     * @param {string} baseURL The base URL
     * @param {string} requestedURL Absolute or relative URL to combine
     * @returns {string} The combined full path
     */
    var buildFullPath = function buildFullPath(baseURL, requestedURL) {
      if (baseURL && !isAbsoluteURL(requestedURL)) {
        return combineURLs(baseURL, requestedURL);
      }
      return requestedURL;
    };

    // Headers whose duplicates are ignored by node
    // c.f. https://nodejs.org/api/http.html#http_message_headers
    var ignoreDuplicateOf = [
      'age', 'authorization', 'content-length', 'content-type', 'etag',
      'expires', 'from', 'host', 'if-modified-since', 'if-unmodified-since',
      'last-modified', 'location', 'max-forwards', 'proxy-authorization',
      'referer', 'retry-after', 'user-agent'
    ];

    /**
     * Parse headers into an object
     *
     * ```
     * Date: Wed, 27 Aug 2014 08:58:49 GMT
     * Content-Type: application/json
     * Connection: keep-alive
     * Transfer-Encoding: chunked
     * ```
     *
     * @param {String} headers Headers needing to be parsed
     * @returns {Object} Headers parsed into an object
     */
    var parseHeaders = function parseHeaders(headers) {
      var parsed = {};
      var key;
      var val;
      var i;

      if (!headers) { return parsed; }

      utils.forEach(headers.split('\n'), function parser(line) {
        i = line.indexOf(':');
        key = utils.trim(line.substr(0, i)).toLowerCase();
        val = utils.trim(line.substr(i + 1));

        if (key) {
          if (parsed[key] && ignoreDuplicateOf.indexOf(key) >= 0) {
            return;
          }
          if (key === 'set-cookie') {
            parsed[key] = (parsed[key] ? parsed[key] : []).concat([val]);
          } else {
            parsed[key] = parsed[key] ? parsed[key] + ', ' + val : val;
          }
        }
      });

      return parsed;
    };

    var isURLSameOrigin = (
      utils.isStandardBrowserEnv() ?

      // Standard browser envs have full support of the APIs needed to test
      // whether the request URL is of the same origin as current location.
        (function standardBrowserEnv() {
          var msie = /(msie|trident)/i.test(navigator.userAgent);
          var urlParsingNode = document.createElement('a');
          var originURL;

          /**
        * Parse a URL to discover it's components
        *
        * @param {String} url The URL to be parsed
        * @returns {Object}
        */
          function resolveURL(url) {
            var href = url;

            if (msie) {
            // IE needs attribute set twice to normalize properties
              urlParsingNode.setAttribute('href', href);
              href = urlParsingNode.href;
            }

            urlParsingNode.setAttribute('href', href);

            // urlParsingNode provides the UrlUtils interface - http://url.spec.whatwg.org/#urlutils
            return {
              href: urlParsingNode.href,
              protocol: urlParsingNode.protocol ? urlParsingNode.protocol.replace(/:$/, '') : '',
              host: urlParsingNode.host,
              search: urlParsingNode.search ? urlParsingNode.search.replace(/^\?/, '') : '',
              hash: urlParsingNode.hash ? urlParsingNode.hash.replace(/^#/, '') : '',
              hostname: urlParsingNode.hostname,
              port: urlParsingNode.port,
              pathname: (urlParsingNode.pathname.charAt(0) === '/') ?
                urlParsingNode.pathname :
                '/' + urlParsingNode.pathname
            };
          }

          originURL = resolveURL(window.location.href);

          /**
        * Determine if a URL shares the same origin as the current location
        *
        * @param {String} requestURL The URL to test
        * @returns {boolean} True if URL shares the same origin, otherwise false
        */
          return function isURLSameOrigin(requestURL) {
            var parsed = (utils.isString(requestURL)) ? resolveURL(requestURL) : requestURL;
            return (parsed.protocol === originURL.protocol &&
                parsed.host === originURL.host);
          };
        })() :

      // Non standard browser envs (web workers, react-native) lack needed support.
        (function nonStandardBrowserEnv() {
          return function isURLSameOrigin() {
            return true;
          };
        })()
    );

    /**
     * A `CanceledError` is an object that is thrown when an operation is canceled.
     *
     * @class
     * @param {string=} message The message.
     */
    function CanceledError(message) {
      // eslint-disable-next-line no-eq-null,eqeqeq
      AxiosError_1.call(this, message == null ? 'canceled' : message, AxiosError_1.ERR_CANCELED);
      this.name = 'CanceledError';
    }

    utils.inherits(CanceledError, AxiosError_1, {
      __CANCEL__: true
    });

    var CanceledError_1 = CanceledError;

    var parseProtocol = function parseProtocol(url) {
      var match = /^([-+\w]{1,25})(:?\/\/|:)/.exec(url);
      return match && match[1] || '';
    };

    var xhr = function xhrAdapter(config) {
      return new Promise(function dispatchXhrRequest(resolve, reject) {
        var requestData = config.data;
        var requestHeaders = config.headers;
        var responseType = config.responseType;
        var onCanceled;
        function done() {
          if (config.cancelToken) {
            config.cancelToken.unsubscribe(onCanceled);
          }

          if (config.signal) {
            config.signal.removeEventListener('abort', onCanceled);
          }
        }

        if (utils.isFormData(requestData) && utils.isStandardBrowserEnv()) {
          delete requestHeaders['Content-Type']; // Let the browser set it
        }

        var request = new XMLHttpRequest();

        // HTTP basic authentication
        if (config.auth) {
          var username = config.auth.username || '';
          var password = config.auth.password ? unescape(encodeURIComponent(config.auth.password)) : '';
          requestHeaders.Authorization = 'Basic ' + btoa(username + ':' + password);
        }

        var fullPath = buildFullPath(config.baseURL, config.url);

        request.open(config.method.toUpperCase(), buildURL(fullPath, config.params, config.paramsSerializer), true);

        // Set the request timeout in MS
        request.timeout = config.timeout;

        function onloadend() {
          if (!request) {
            return;
          }
          // Prepare the response
          var responseHeaders = 'getAllResponseHeaders' in request ? parseHeaders(request.getAllResponseHeaders()) : null;
          var responseData = !responseType || responseType === 'text' ||  responseType === 'json' ?
            request.responseText : request.response;
          var response = {
            data: responseData,
            status: request.status,
            statusText: request.statusText,
            headers: responseHeaders,
            config: config,
            request: request
          };

          settle(function _resolve(value) {
            resolve(value);
            done();
          }, function _reject(err) {
            reject(err);
            done();
          }, response);

          // Clean up request
          request = null;
        }

        if ('onloadend' in request) {
          // Use onloadend if available
          request.onloadend = onloadend;
        } else {
          // Listen for ready state to emulate onloadend
          request.onreadystatechange = function handleLoad() {
            if (!request || request.readyState !== 4) {
              return;
            }

            // The request errored out and we didn't get a response, this will be
            // handled by onerror instead
            // With one exception: request that using file: protocol, most browsers
            // will return status as 0 even though it's a successful request
            if (request.status === 0 && !(request.responseURL && request.responseURL.indexOf('file:') === 0)) {
              return;
            }
            // readystate handler is calling before onerror or ontimeout handlers,
            // so we should call onloadend on the next 'tick'
            setTimeout(onloadend);
          };
        }

        // Handle browser request cancellation (as opposed to a manual cancellation)
        request.onabort = function handleAbort() {
          if (!request) {
            return;
          }

          reject(new AxiosError_1('Request aborted', AxiosError_1.ECONNABORTED, config, request));

          // Clean up request
          request = null;
        };

        // Handle low level network errors
        request.onerror = function handleError() {
          // Real errors are hidden from us by the browser
          // onerror should only fire if it's a network error
          reject(new AxiosError_1('Network Error', AxiosError_1.ERR_NETWORK, config, request, request));

          // Clean up request
          request = null;
        };

        // Handle timeout
        request.ontimeout = function handleTimeout() {
          var timeoutErrorMessage = config.timeout ? 'timeout of ' + config.timeout + 'ms exceeded' : 'timeout exceeded';
          var transitional$1 = config.transitional || transitional;
          if (config.timeoutErrorMessage) {
            timeoutErrorMessage = config.timeoutErrorMessage;
          }
          reject(new AxiosError_1(
            timeoutErrorMessage,
            transitional$1.clarifyTimeoutError ? AxiosError_1.ETIMEDOUT : AxiosError_1.ECONNABORTED,
            config,
            request));

          // Clean up request
          request = null;
        };

        // Add xsrf header
        // This is only done if running in a standard browser environment.
        // Specifically not if we're in a web worker, or react-native.
        if (utils.isStandardBrowserEnv()) {
          // Add xsrf header
          var xsrfValue = (config.withCredentials || isURLSameOrigin(fullPath)) && config.xsrfCookieName ?
            cookies.read(config.xsrfCookieName) :
            undefined;

          if (xsrfValue) {
            requestHeaders[config.xsrfHeaderName] = xsrfValue;
          }
        }

        // Add headers to the request
        if ('setRequestHeader' in request) {
          utils.forEach(requestHeaders, function setRequestHeader(val, key) {
            if (typeof requestData === 'undefined' && key.toLowerCase() === 'content-type') {
              // Remove Content-Type if data is undefined
              delete requestHeaders[key];
            } else {
              // Otherwise add header to the request
              request.setRequestHeader(key, val);
            }
          });
        }

        // Add withCredentials to request if needed
        if (!utils.isUndefined(config.withCredentials)) {
          request.withCredentials = !!config.withCredentials;
        }

        // Add responseType to request if needed
        if (responseType && responseType !== 'json') {
          request.responseType = config.responseType;
        }

        // Handle progress if needed
        if (typeof config.onDownloadProgress === 'function') {
          request.addEventListener('progress', config.onDownloadProgress);
        }

        // Not all browsers support upload events
        if (typeof config.onUploadProgress === 'function' && request.upload) {
          request.upload.addEventListener('progress', config.onUploadProgress);
        }

        if (config.cancelToken || config.signal) {
          // Handle cancellation
          // eslint-disable-next-line func-names
          onCanceled = function(cancel) {
            if (!request) {
              return;
            }
            reject(!cancel || (cancel && cancel.type) ? new CanceledError_1() : cancel);
            request.abort();
            request = null;
          };

          config.cancelToken && config.cancelToken.subscribe(onCanceled);
          if (config.signal) {
            config.signal.aborted ? onCanceled() : config.signal.addEventListener('abort', onCanceled);
          }
        }

        if (!requestData) {
          requestData = null;
        }

        var protocol = parseProtocol(fullPath);

        if (protocol && [ 'http', 'https', 'file' ].indexOf(protocol) === -1) {
          reject(new AxiosError_1('Unsupported protocol ' + protocol + ':', AxiosError_1.ERR_BAD_REQUEST, config));
          return;
        }


        // Send the request
        request.send(requestData);
      });
    };

    // eslint-disable-next-line strict
    var _null = null;

    var DEFAULT_CONTENT_TYPE = {
      'Content-Type': 'application/x-www-form-urlencoded'
    };

    function setContentTypeIfUnset(headers, value) {
      if (!utils.isUndefined(headers) && utils.isUndefined(headers['Content-Type'])) {
        headers['Content-Type'] = value;
      }
    }

    function getDefaultAdapter() {
      var adapter;
      if (typeof XMLHttpRequest !== 'undefined') {
        // For browsers use XHR adapter
        adapter = xhr;
      } else if (typeof process !== 'undefined' && Object.prototype.toString.call(process) === '[object process]') {
        // For node use HTTP adapter
        adapter = xhr;
      }
      return adapter;
    }

    function stringifySafely(rawValue, parser, encoder) {
      if (utils.isString(rawValue)) {
        try {
          (parser || JSON.parse)(rawValue);
          return utils.trim(rawValue);
        } catch (e) {
          if (e.name !== 'SyntaxError') {
            throw e;
          }
        }
      }

      return (encoder || JSON.stringify)(rawValue);
    }

    var defaults = {

      transitional: transitional,

      adapter: getDefaultAdapter(),

      transformRequest: [function transformRequest(data, headers) {
        normalizeHeaderName(headers, 'Accept');
        normalizeHeaderName(headers, 'Content-Type');

        if (utils.isFormData(data) ||
          utils.isArrayBuffer(data) ||
          utils.isBuffer(data) ||
          utils.isStream(data) ||
          utils.isFile(data) ||
          utils.isBlob(data)
        ) {
          return data;
        }
        if (utils.isArrayBufferView(data)) {
          return data.buffer;
        }
        if (utils.isURLSearchParams(data)) {
          setContentTypeIfUnset(headers, 'application/x-www-form-urlencoded;charset=utf-8');
          return data.toString();
        }

        var isObjectPayload = utils.isObject(data);
        var contentType = headers && headers['Content-Type'];

        var isFileList;

        if ((isFileList = utils.isFileList(data)) || (isObjectPayload && contentType === 'multipart/form-data')) {
          var _FormData = this.env && this.env.FormData;
          return toFormData_1(isFileList ? {'files[]': data} : data, _FormData && new _FormData());
        } else if (isObjectPayload || contentType === 'application/json') {
          setContentTypeIfUnset(headers, 'application/json');
          return stringifySafely(data);
        }

        return data;
      }],

      transformResponse: [function transformResponse(data) {
        var transitional = this.transitional || defaults.transitional;
        var silentJSONParsing = transitional && transitional.silentJSONParsing;
        var forcedJSONParsing = transitional && transitional.forcedJSONParsing;
        var strictJSONParsing = !silentJSONParsing && this.responseType === 'json';

        if (strictJSONParsing || (forcedJSONParsing && utils.isString(data) && data.length)) {
          try {
            return JSON.parse(data);
          } catch (e) {
            if (strictJSONParsing) {
              if (e.name === 'SyntaxError') {
                throw AxiosError_1.from(e, AxiosError_1.ERR_BAD_RESPONSE, this, null, this.response);
              }
              throw e;
            }
          }
        }

        return data;
      }],

      /**
       * A timeout in milliseconds to abort a request. If set to 0 (default) a
       * timeout is not created.
       */
      timeout: 0,

      xsrfCookieName: 'XSRF-TOKEN',
      xsrfHeaderName: 'X-XSRF-TOKEN',

      maxContentLength: -1,
      maxBodyLength: -1,

      env: {
        FormData: _null
      },

      validateStatus: function validateStatus(status) {
        return status >= 200 && status < 300;
      },

      headers: {
        common: {
          'Accept': 'application/json, text/plain, */*'
        }
      }
    };

    utils.forEach(['delete', 'get', 'head'], function forEachMethodNoData(method) {
      defaults.headers[method] = {};
    });

    utils.forEach(['post', 'put', 'patch'], function forEachMethodWithData(method) {
      defaults.headers[method] = utils.merge(DEFAULT_CONTENT_TYPE);
    });

    var defaults_1 = defaults;

    /**
     * Transform the data for a request or a response
     *
     * @param {Object|String} data The data to be transformed
     * @param {Array} headers The headers for the request or response
     * @param {Array|Function} fns A single function or Array of functions
     * @returns {*} The resulting transformed data
     */
    var transformData = function transformData(data, headers, fns) {
      var context = this || defaults_1;
      /*eslint no-param-reassign:0*/
      utils.forEach(fns, function transform(fn) {
        data = fn.call(context, data, headers);
      });

      return data;
    };

    var isCancel = function isCancel(value) {
      return !!(value && value.__CANCEL__);
    };

    /**
     * Throws a `CanceledError` if cancellation has been requested.
     */
    function throwIfCancellationRequested(config) {
      if (config.cancelToken) {
        config.cancelToken.throwIfRequested();
      }

      if (config.signal && config.signal.aborted) {
        throw new CanceledError_1();
      }
    }

    /**
     * Dispatch a request to the server using the configured adapter.
     *
     * @param {object} config The config that is to be used for the request
     * @returns {Promise} The Promise to be fulfilled
     */
    var dispatchRequest = function dispatchRequest(config) {
      throwIfCancellationRequested(config);

      // Ensure headers exist
      config.headers = config.headers || {};

      // Transform request data
      config.data = transformData.call(
        config,
        config.data,
        config.headers,
        config.transformRequest
      );

      // Flatten headers
      config.headers = utils.merge(
        config.headers.common || {},
        config.headers[config.method] || {},
        config.headers
      );

      utils.forEach(
        ['delete', 'get', 'head', 'post', 'put', 'patch', 'common'],
        function cleanHeaderConfig(method) {
          delete config.headers[method];
        }
      );

      var adapter = config.adapter || defaults_1.adapter;

      return adapter(config).then(function onAdapterResolution(response) {
        throwIfCancellationRequested(config);

        // Transform response data
        response.data = transformData.call(
          config,
          response.data,
          response.headers,
          config.transformResponse
        );

        return response;
      }, function onAdapterRejection(reason) {
        if (!isCancel(reason)) {
          throwIfCancellationRequested(config);

          // Transform response data
          if (reason && reason.response) {
            reason.response.data = transformData.call(
              config,
              reason.response.data,
              reason.response.headers,
              config.transformResponse
            );
          }
        }

        return Promise.reject(reason);
      });
    };

    /**
     * Config-specific merge-function which creates a new config-object
     * by merging two configuration objects together.
     *
     * @param {Object} config1
     * @param {Object} config2
     * @returns {Object} New object resulting from merging config2 to config1
     */
    var mergeConfig = function mergeConfig(config1, config2) {
      // eslint-disable-next-line no-param-reassign
      config2 = config2 || {};
      var config = {};

      function getMergedValue(target, source) {
        if (utils.isPlainObject(target) && utils.isPlainObject(source)) {
          return utils.merge(target, source);
        } else if (utils.isPlainObject(source)) {
          return utils.merge({}, source);
        } else if (utils.isArray(source)) {
          return source.slice();
        }
        return source;
      }

      // eslint-disable-next-line consistent-return
      function mergeDeepProperties(prop) {
        if (!utils.isUndefined(config2[prop])) {
          return getMergedValue(config1[prop], config2[prop]);
        } else if (!utils.isUndefined(config1[prop])) {
          return getMergedValue(undefined, config1[prop]);
        }
      }

      // eslint-disable-next-line consistent-return
      function valueFromConfig2(prop) {
        if (!utils.isUndefined(config2[prop])) {
          return getMergedValue(undefined, config2[prop]);
        }
      }

      // eslint-disable-next-line consistent-return
      function defaultToConfig2(prop) {
        if (!utils.isUndefined(config2[prop])) {
          return getMergedValue(undefined, config2[prop]);
        } else if (!utils.isUndefined(config1[prop])) {
          return getMergedValue(undefined, config1[prop]);
        }
      }

      // eslint-disable-next-line consistent-return
      function mergeDirectKeys(prop) {
        if (prop in config2) {
          return getMergedValue(config1[prop], config2[prop]);
        } else if (prop in config1) {
          return getMergedValue(undefined, config1[prop]);
        }
      }

      var mergeMap = {
        'url': valueFromConfig2,
        'method': valueFromConfig2,
        'data': valueFromConfig2,
        'baseURL': defaultToConfig2,
        'transformRequest': defaultToConfig2,
        'transformResponse': defaultToConfig2,
        'paramsSerializer': defaultToConfig2,
        'timeout': defaultToConfig2,
        'timeoutMessage': defaultToConfig2,
        'withCredentials': defaultToConfig2,
        'adapter': defaultToConfig2,
        'responseType': defaultToConfig2,
        'xsrfCookieName': defaultToConfig2,
        'xsrfHeaderName': defaultToConfig2,
        'onUploadProgress': defaultToConfig2,
        'onDownloadProgress': defaultToConfig2,
        'decompress': defaultToConfig2,
        'maxContentLength': defaultToConfig2,
        'maxBodyLength': defaultToConfig2,
        'beforeRedirect': defaultToConfig2,
        'transport': defaultToConfig2,
        'httpAgent': defaultToConfig2,
        'httpsAgent': defaultToConfig2,
        'cancelToken': defaultToConfig2,
        'socketPath': defaultToConfig2,
        'responseEncoding': defaultToConfig2,
        'validateStatus': mergeDirectKeys
      };

      utils.forEach(Object.keys(config1).concat(Object.keys(config2)), function computeConfigValue(prop) {
        var merge = mergeMap[prop] || mergeDeepProperties;
        var configValue = merge(prop);
        (utils.isUndefined(configValue) && merge !== mergeDirectKeys) || (config[prop] = configValue);
      });

      return config;
    };

    var data = {
      "version": "0.27.2"
    };

    var VERSION = data.version;


    var validators$1 = {};

    // eslint-disable-next-line func-names
    ['object', 'boolean', 'number', 'function', 'string', 'symbol'].forEach(function(type, i) {
      validators$1[type] = function validator(thing) {
        return typeof thing === type || 'a' + (i < 1 ? 'n ' : ' ') + type;
      };
    });

    var deprecatedWarnings = {};

    /**
     * Transitional option validator
     * @param {function|boolean?} validator - set to false if the transitional option has been removed
     * @param {string?} version - deprecated version / removed since version
     * @param {string?} message - some message with additional info
     * @returns {function}
     */
    validators$1.transitional = function transitional(validator, version, message) {
      function formatMessage(opt, desc) {
        return '[Axios v' + VERSION + '] Transitional option \'' + opt + '\'' + desc + (message ? '. ' + message : '');
      }

      // eslint-disable-next-line func-names
      return function(value, opt, opts) {
        if (validator === false) {
          throw new AxiosError_1(
            formatMessage(opt, ' has been removed' + (version ? ' in ' + version : '')),
            AxiosError_1.ERR_DEPRECATED
          );
        }

        if (version && !deprecatedWarnings[opt]) {
          deprecatedWarnings[opt] = true;
          // eslint-disable-next-line no-console
          console.warn(
            formatMessage(
              opt,
              ' has been deprecated since v' + version + ' and will be removed in the near future'
            )
          );
        }

        return validator ? validator(value, opt, opts) : true;
      };
    };

    /**
     * Assert object's properties type
     * @param {object} options
     * @param {object} schema
     * @param {boolean?} allowUnknown
     */

    function assertOptions(options, schema, allowUnknown) {
      if (typeof options !== 'object') {
        throw new AxiosError_1('options must be an object', AxiosError_1.ERR_BAD_OPTION_VALUE);
      }
      var keys = Object.keys(options);
      var i = keys.length;
      while (i-- > 0) {
        var opt = keys[i];
        var validator = schema[opt];
        if (validator) {
          var value = options[opt];
          var result = value === undefined || validator(value, opt, options);
          if (result !== true) {
            throw new AxiosError_1('option ' + opt + ' must be ' + result, AxiosError_1.ERR_BAD_OPTION_VALUE);
          }
          continue;
        }
        if (allowUnknown !== true) {
          throw new AxiosError_1('Unknown option ' + opt, AxiosError_1.ERR_BAD_OPTION);
        }
      }
    }

    var validator = {
      assertOptions: assertOptions,
      validators: validators$1
    };

    var validators = validator.validators;
    /**
     * Create a new instance of Axios
     *
     * @param {Object} instanceConfig The default config for the instance
     */
    function Axios(instanceConfig) {
      this.defaults = instanceConfig;
      this.interceptors = {
        request: new InterceptorManager_1(),
        response: new InterceptorManager_1()
      };
    }

    /**
     * Dispatch a request
     *
     * @param {Object} config The config specific for this request (merged with this.defaults)
     */
    Axios.prototype.request = function request(configOrUrl, config) {
      /*eslint no-param-reassign:0*/
      // Allow for axios('example/url'[, config]) a la fetch API
      if (typeof configOrUrl === 'string') {
        config = config || {};
        config.url = configOrUrl;
      } else {
        config = configOrUrl || {};
      }

      config = mergeConfig(this.defaults, config);

      // Set config.method
      if (config.method) {
        config.method = config.method.toLowerCase();
      } else if (this.defaults.method) {
        config.method = this.defaults.method.toLowerCase();
      } else {
        config.method = 'get';
      }

      var transitional = config.transitional;

      if (transitional !== undefined) {
        validator.assertOptions(transitional, {
          silentJSONParsing: validators.transitional(validators.boolean),
          forcedJSONParsing: validators.transitional(validators.boolean),
          clarifyTimeoutError: validators.transitional(validators.boolean)
        }, false);
      }

      // filter out skipped interceptors
      var requestInterceptorChain = [];
      var synchronousRequestInterceptors = true;
      this.interceptors.request.forEach(function unshiftRequestInterceptors(interceptor) {
        if (typeof interceptor.runWhen === 'function' && interceptor.runWhen(config) === false) {
          return;
        }

        synchronousRequestInterceptors = synchronousRequestInterceptors && interceptor.synchronous;

        requestInterceptorChain.unshift(interceptor.fulfilled, interceptor.rejected);
      });

      var responseInterceptorChain = [];
      this.interceptors.response.forEach(function pushResponseInterceptors(interceptor) {
        responseInterceptorChain.push(interceptor.fulfilled, interceptor.rejected);
      });

      var promise;

      if (!synchronousRequestInterceptors) {
        var chain = [dispatchRequest, undefined];

        Array.prototype.unshift.apply(chain, requestInterceptorChain);
        chain = chain.concat(responseInterceptorChain);

        promise = Promise.resolve(config);
        while (chain.length) {
          promise = promise.then(chain.shift(), chain.shift());
        }

        return promise;
      }


      var newConfig = config;
      while (requestInterceptorChain.length) {
        var onFulfilled = requestInterceptorChain.shift();
        var onRejected = requestInterceptorChain.shift();
        try {
          newConfig = onFulfilled(newConfig);
        } catch (error) {
          onRejected(error);
          break;
        }
      }

      try {
        promise = dispatchRequest(newConfig);
      } catch (error) {
        return Promise.reject(error);
      }

      while (responseInterceptorChain.length) {
        promise = promise.then(responseInterceptorChain.shift(), responseInterceptorChain.shift());
      }

      return promise;
    };

    Axios.prototype.getUri = function getUri(config) {
      config = mergeConfig(this.defaults, config);
      var fullPath = buildFullPath(config.baseURL, config.url);
      return buildURL(fullPath, config.params, config.paramsSerializer);
    };

    // Provide aliases for supported request methods
    utils.forEach(['delete', 'get', 'head', 'options'], function forEachMethodNoData(method) {
      /*eslint func-names:0*/
      Axios.prototype[method] = function(url, config) {
        return this.request(mergeConfig(config || {}, {
          method: method,
          url: url,
          data: (config || {}).data
        }));
      };
    });

    utils.forEach(['post', 'put', 'patch'], function forEachMethodWithData(method) {
      /*eslint func-names:0*/

      function generateHTTPMethod(isForm) {
        return function httpMethod(url, data, config) {
          return this.request(mergeConfig(config || {}, {
            method: method,
            headers: isForm ? {
              'Content-Type': 'multipart/form-data'
            } : {},
            url: url,
            data: data
          }));
        };
      }

      Axios.prototype[method] = generateHTTPMethod();

      Axios.prototype[method + 'Form'] = generateHTTPMethod(true);
    });

    var Axios_1 = Axios;

    /**
     * A `CancelToken` is an object that can be used to request cancellation of an operation.
     *
     * @class
     * @param {Function} executor The executor function.
     */
    function CancelToken(executor) {
      if (typeof executor !== 'function') {
        throw new TypeError('executor must be a function.');
      }

      var resolvePromise;

      this.promise = new Promise(function promiseExecutor(resolve) {
        resolvePromise = resolve;
      });

      var token = this;

      // eslint-disable-next-line func-names
      this.promise.then(function(cancel) {
        if (!token._listeners) return;

        var i;
        var l = token._listeners.length;

        for (i = 0; i < l; i++) {
          token._listeners[i](cancel);
        }
        token._listeners = null;
      });

      // eslint-disable-next-line func-names
      this.promise.then = function(onfulfilled) {
        var _resolve;
        // eslint-disable-next-line func-names
        var promise = new Promise(function(resolve) {
          token.subscribe(resolve);
          _resolve = resolve;
        }).then(onfulfilled);

        promise.cancel = function reject() {
          token.unsubscribe(_resolve);
        };

        return promise;
      };

      executor(function cancel(message) {
        if (token.reason) {
          // Cancellation has already been requested
          return;
        }

        token.reason = new CanceledError_1(message);
        resolvePromise(token.reason);
      });
    }

    /**
     * Throws a `CanceledError` if cancellation has been requested.
     */
    CancelToken.prototype.throwIfRequested = function throwIfRequested() {
      if (this.reason) {
        throw this.reason;
      }
    };

    /**
     * Subscribe to the cancel signal
     */

    CancelToken.prototype.subscribe = function subscribe(listener) {
      if (this.reason) {
        listener(this.reason);
        return;
      }

      if (this._listeners) {
        this._listeners.push(listener);
      } else {
        this._listeners = [listener];
      }
    };

    /**
     * Unsubscribe from the cancel signal
     */

    CancelToken.prototype.unsubscribe = function unsubscribe(listener) {
      if (!this._listeners) {
        return;
      }
      var index = this._listeners.indexOf(listener);
      if (index !== -1) {
        this._listeners.splice(index, 1);
      }
    };

    /**
     * Returns an object that contains a new `CancelToken` and a function that, when called,
     * cancels the `CancelToken`.
     */
    CancelToken.source = function source() {
      var cancel;
      var token = new CancelToken(function executor(c) {
        cancel = c;
      });
      return {
        token: token,
        cancel: cancel
      };
    };

    var CancelToken_1 = CancelToken;

    /**
     * Syntactic sugar for invoking a function and expanding an array for arguments.
     *
     * Common use case would be to use `Function.prototype.apply`.
     *
     *  ```js
     *  function f(x, y, z) {}
     *  var args = [1, 2, 3];
     *  f.apply(null, args);
     *  ```
     *
     * With `spread` this example can be re-written.
     *
     *  ```js
     *  spread(function(x, y, z) {})([1, 2, 3]);
     *  ```
     *
     * @param {Function} callback
     * @returns {Function}
     */
    var spread = function spread(callback) {
      return function wrap(arr) {
        return callback.apply(null, arr);
      };
    };

    /**
     * Determines whether the payload is an error thrown by Axios
     *
     * @param {*} payload The value to test
     * @returns {boolean} True if the payload is an error thrown by Axios, otherwise false
     */
    var isAxiosError = function isAxiosError(payload) {
      return utils.isObject(payload) && (payload.isAxiosError === true);
    };

    /**
     * Create an instance of Axios
     *
     * @param {Object} defaultConfig The default config for the instance
     * @return {Axios} A new instance of Axios
     */
    function createInstance(defaultConfig) {
      var context = new Axios_1(defaultConfig);
      var instance = bind(Axios_1.prototype.request, context);

      // Copy axios.prototype to instance
      utils.extend(instance, Axios_1.prototype, context);

      // Copy context to instance
      utils.extend(instance, context);

      // Factory for creating new instances
      instance.create = function create(instanceConfig) {
        return createInstance(mergeConfig(defaultConfig, instanceConfig));
      };

      return instance;
    }

    // Create the default instance to be exported
    var axios$1 = createInstance(defaults_1);

    // Expose Axios class to allow class inheritance
    axios$1.Axios = Axios_1;

    // Expose Cancel & CancelToken
    axios$1.CanceledError = CanceledError_1;
    axios$1.CancelToken = CancelToken_1;
    axios$1.isCancel = isCancel;
    axios$1.VERSION = data.version;
    axios$1.toFormData = toFormData_1;

    // Expose AxiosError class
    axios$1.AxiosError = AxiosError_1;

    // alias for CanceledError for backward compatibility
    axios$1.Cancel = axios$1.CanceledError;

    // Expose all/spread
    axios$1.all = function all(promises) {
      return Promise.all(promises);
    };
    axios$1.spread = spread;

    // Expose isAxiosError
    axios$1.isAxiosError = isAxiosError;

    var axios_1 = axios$1;

    // Allow use of default import syntax in TypeScript
    var default_1 = axios$1;
    axios_1.default = default_1;

    var axios = axios_1;

    var index_cjs = createCommonjsModule(function (module, exports) {

    Object.defineProperty(exports, '__esModule', { value: true });




    function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

    var axios__default = /*#__PURE__*/_interopDefaultLegacy(axios);
    var EventEmitter__default = /*#__PURE__*/_interopDefaultLegacy(eventemitter3);

    /******************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
    /* global Reflect, Promise, SuppressedError, Symbol */

    var extendStatics = function(d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };

    function __extends(d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    }

    var __assign = function() {
        __assign = Object.assign || function __assign(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };

    function __awaiter(thisArg, _arguments, P, generator) {
        function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
        return new (P || (P = Promise))(function (resolve, reject) {
            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
            function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
            function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
            step((generator = generator.apply(thisArg, _arguments || [])).next());
        });
    }

    function __generator(thisArg, body) {
        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
        return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
        function verb(n) { return function (v) { return step([n, v]); }; }
        function step(op) {
            if (f) throw new TypeError("Generator is already executing.");
            while (g && (g = 0, op[0] && (_ = 0)), _) try {
                if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
                if (y = 0, t) op = [op[0] & 2, t.value];
                switch (op[0]) {
                    case 0: case 1: t = op; break;
                    case 4: _.label++; return { value: op[1], done: false };
                    case 5: _.label++; y = op[1]; op = [0]; continue;
                    case 7: op = _.ops.pop(); _.trys.pop(); continue;
                    default:
                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                        if (t[2]) _.ops.pop();
                        _.trys.pop(); continue;
                }
                op = body.call(thisArg, _);
            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
        }
    }

    function __values(o) {
        var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
        if (m) return m.call(o);
        if (o && typeof o.length === "number") return {
            next: function () {
                if (o && i >= o.length) o = void 0;
                return { value: o && o[i++], done: !o };
            }
        };
        throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
    }

    function __read(o, n) {
        var m = typeof Symbol === "function" && o[Symbol.iterator];
        if (!m) return o;
        var i = m.call(o), r, ar = [], e;
        try {
            while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
        }
        catch (error) { e = { error: error }; }
        finally {
            try {
                if (r && !r.done && (m = i["return"])) m.call(i);
            }
            finally { if (e) throw e.error; }
        }
        return ar;
    }

    function __spreadArray(to, from, pack) {
        if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
                if (!ar) ar = Array.prototype.slice.call(from, 0, i);
                ar[i] = from[i];
            }
        }
        return to.concat(ar || Array.prototype.slice.call(from));
    }

    typeof SuppressedError === "function" ? SuppressedError : function (error, suppressed, message) {
        var e = new Error(message);
        return e.name = "SuppressedError", e.error = error, e.suppressed = suppressed, e;
    };

    var request$1 = function (_a) {
        var _b = _a.method, method = _b === void 0 ? 'POST' : _b, url = _a.url, data = _a.data, headers = _a.headers;
        return __awaiter(void 0, void 0, void 0, function () {
            var res, err_1;
            return __generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        _c.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, axios__default["default"]({
                                method: method,
                                url: url,
                                data: data,
                                headers: headers,
                            })];
                    case 1:
                        res = _c.sent();
                        if (res.data.code !== 200) {
                            return [2 /*return*/, Promise.reject(res.data)];
                        }
                        return [2 /*return*/, res.data];
                    case 2:
                        err_1 = _c.sent();
                        return [2 /*return*/, Promise.reject(err_1)];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    var webRequestHelper = request$1;

    var request = webRequestHelper;

    var Storage = /** @class */ (function () {
        function Storage(type, salt) {
            this.store = new Map();
            this.type = 'memory';
            this.salt = '__salt__';
            type && (this.type = type);
            salt && (this.salt = salt);
        }
        Storage.prototype.get = function (key) {
            var value;
            switch (this.type) {
                case 'memory':
                    return this.store.get(key);
                case 'localStorage':
                    value = localStorage.getItem("".concat(this.salt).concat(key));
                    if (value) {
                        return JSON.parse(value);
                    }
                    return value;
                case 'sessionStorage':
                    value = sessionStorage.getItem("".concat(this.salt).concat(key));
                    if (value) {
                        return JSON.parse(value);
                    }
                    return value;
            }
        };
        Storage.prototype.set = function (key, value) {
            switch (this.type) {
                case 'memory':
                    this.store.set(key, value);
                    break;
                case 'localStorage':
                    localStorage.setItem("".concat(this.salt).concat(key), JSON.stringify(value));
                    break;
                case 'sessionStorage':
                    sessionStorage.setItem("".concat(this.salt).concat(key), JSON.stringify(value));
                    break;
            }
        };
        Storage.prototype.remove = function (key) {
            switch (this.type) {
                case 'memory':
                    this.store.delete(key);
                    break;
                case 'localStorage':
                    localStorage.removeItem("".concat(this.salt).concat(key));
                    break;
                case 'sessionStorage':
                    sessionStorage.removeItem("".concat(this.salt).concat(key));
                    break;
            }
        };
        return Storage;
    }());
    var webStorage = Storage;

    var index = webStorage;

    var url$1 = "https://statistic.live.126.net/statics/report/xkit/action";
    var EventTracking = /** @class */ (function () {
        function EventTracking(_a) {
            var appKey = _a.appKey, version = _a.version, component = _a.component, nertcVersion = _a.nertcVersion, imVersion = _a.imVersion, _b = _a.platform, platform = _b === void 0 ? 'Web' : _b, _c = _a.channel, channel = _c === void 0 ? 'netease' : _c;
            this.platform = platform;
            this.appKey = appKey;
            this.version = version;
            this.component = component;
            this.nertcVersion = nertcVersion;
            this.imVersion = imVersion;
            this.channel = channel;
        }
        EventTracking.prototype.track = function (reportType, data) {
            return __awaiter(this, void 0, void 0, function () {
                var _a, appKey, version, component, nertcVersion, imVersion, platform, channel, timeStamp;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _a = this, appKey = _a.appKey, version = _a.version, component = _a.component, nertcVersion = _a.nertcVersion, imVersion = _a.imVersion, platform = _a.platform, channel = _a.channel;
                            timeStamp = Date.now();
                            _c.label = 1;
                        case 1:
                            _c.trys.push([1, 3, , 4]);
                            return [4 /*yield*/, request({
                                    method: 'POST',
                                    url: url$1,
                                    data: {
                                        appKey: appKey,
                                        version: version,
                                        component: component,
                                        timeStamp: timeStamp,
                                        nertcVersion: nertcVersion,
                                        imVersion: imVersion,
                                        platform: platform,
                                        reportType: reportType,
                                        data: data,
                                        channel: channel,
                                    },
                                })];
                        case 2:
                            _c.sent();
                            return [3 /*break*/, 4];
                        case 3:
                            _c.sent();
                            return [3 /*break*/, 4];
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        return EventTracking;
    }());
    var EventTracking$1 = EventTracking;

    /**
     * 判断元素是否可见
     * 融合了 IntersectionObserver 与 visibilityChange 事件
     */
    var VisibilityObserver = /** @class */ (function (_super) {
        __extends(VisibilityObserver, _super);
        // 入参说明参考：https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API
        function VisibilityObserver(options) {
            var _this = _super.call(this) || this;
            _this.visibilityState = document.visibilityState;
            _this.entries = [];
            _this._visibilitychange = function () {
                _this.visibilityState = document.visibilityState;
                _this._trigger();
            };
            _this.intersectionObserver = new IntersectionObserver(_this._intersectionObserverHandler.bind(_this), options);
            document.addEventListener('visibilitychange', _this._visibilitychange);
            return _this;
        }
        VisibilityObserver.prototype.observe = function (target) {
            return this.intersectionObserver.observe(target);
        };
        VisibilityObserver.prototype.unobserve = function (target) {
            return this.intersectionObserver.unobserve(target);
        };
        VisibilityObserver.prototype.destroy = function () {
            this.intersectionObserver.disconnect();
            document.removeEventListener('visibilitychange', this._visibilitychange);
            this.entries = [];
        };
        VisibilityObserver.prototype._intersectionObserverHandler = function (entries, observer) {
            this.entries = entries;
            this._trigger();
        };
        VisibilityObserver.prototype._trigger = function () {
            var _this = this;
            this.entries.forEach(function (item) {
                if (_this.visibilityState !== 'visible' || item.intersectionRatio <= 0) {
                    _this.emit('visibleChange', {
                        visible: false,
                        target: item.target,
                    });
                    return;
                }
                _this.emit('visibleChange', {
                    visible: true,
                    target: item.target,
                });
            });
        };
        return VisibilityObserver;
    }(EventEmitter__default["default"]));
    var VisibilityObserver$1 = VisibilityObserver;

    var commonjsGlobal$1 = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof commonjsGlobal !== 'undefined' ? commonjsGlobal : typeof self !== 'undefined' ? self : {};

    function createCommonjsModule(fn, module) {
    	return module = { exports: {} }, fn(module, module.exports), module.exports;
    }

    var loglevel = createCommonjsModule(function (module) {
    /*
    * loglevel - https://github.com/pimterry/loglevel
    *
    * Copyright (c) 2013 Tim Perry
    * Licensed under the MIT license.
    */
    (function (root, definition) {
        if (module.exports) {
            module.exports = definition();
        } else {
            root.log = definition();
        }
    }(commonjsGlobal$1, function () {

        // Slightly dubious tricks to cut down minimized file size
        var noop = function() {};
        var undefinedType = "undefined";
        var isIE = (typeof window !== undefinedType) && (typeof window.navigator !== undefinedType) && (
            /Trident\/|MSIE /.test(window.navigator.userAgent)
        );

        var logMethods = [
            "trace",
            "debug",
            "info",
            "warn",
            "error"
        ];

        // Cross-browser bind equivalent that works at least back to IE6
        function bindMethod(obj, methodName) {
            var method = obj[methodName];
            if (typeof method.bind === 'function') {
                return method.bind(obj);
            } else {
                try {
                    return Function.prototype.bind.call(method, obj);
                } catch (e) {
                    // Missing bind shim or IE8 + Modernizr, fallback to wrapping
                    return function() {
                        return Function.prototype.apply.apply(method, [obj, arguments]);
                    };
                }
            }
        }

        // Trace() doesn't print the message in IE, so for that case we need to wrap it
        function traceForIE() {
            if (console.log) {
                if (console.log.apply) {
                    console.log.apply(console, arguments);
                } else {
                    // In old IE, native console methods themselves don't have apply().
                    Function.prototype.apply.apply(console.log, [console, arguments]);
                }
            }
            if (console.trace) console.trace();
        }

        // Build the best logging method possible for this env
        // Wherever possible we want to bind, not wrap, to preserve stack traces
        function realMethod(methodName) {
            if (methodName === 'debug') {
                methodName = 'log';
            }

            if (typeof console === undefinedType) {
                return false; // No method possible, for now - fixed later by enableLoggingWhenConsoleArrives
            } else if (methodName === 'trace' && isIE) {
                return traceForIE;
            } else if (console[methodName] !== undefined) {
                return bindMethod(console, methodName);
            } else if (console.log !== undefined) {
                return bindMethod(console, 'log');
            } else {
                return noop;
            }
        }

        // These private functions always need `this` to be set properly

        function replaceLoggingMethods(level, loggerName) {
            /*jshint validthis:true */
            for (var i = 0; i < logMethods.length; i++) {
                var methodName = logMethods[i];
                this[methodName] = (i < level) ?
                    noop :
                    this.methodFactory(methodName, level, loggerName);
            }

            // Define log.log as an alias for log.debug
            this.log = this.debug;
        }

        // In old IE versions, the console isn't present until you first open it.
        // We build realMethod() replacements here that regenerate logging methods
        function enableLoggingWhenConsoleArrives(methodName, level, loggerName) {
            return function () {
                if (typeof console !== undefinedType) {
                    replaceLoggingMethods.call(this, level, loggerName);
                    this[methodName].apply(this, arguments);
                }
            };
        }

        // By default, we use closely bound real methods wherever possible, and
        // otherwise we wait for a console to appear, and then try again.
        function defaultMethodFactory(methodName, level, loggerName) {
            /*jshint validthis:true */
            return realMethod(methodName) ||
                   enableLoggingWhenConsoleArrives.apply(this, arguments);
        }

        function Logger(name, defaultLevel, factory) {
          var self = this;
          var currentLevel;
          defaultLevel = defaultLevel == null ? "WARN" : defaultLevel;

          var storageKey = "loglevel";
          if (typeof name === "string") {
            storageKey += ":" + name;
          } else if (typeof name === "symbol") {
            storageKey = undefined;
          }

          function persistLevelIfPossible(levelNum) {
              var levelName = (logMethods[levelNum] || 'silent').toUpperCase();

              if (typeof window === undefinedType || !storageKey) return;

              // Use localStorage if available
              try {
                  window.localStorage[storageKey] = levelName;
                  return;
              } catch (ignore) {}

              // Use session cookie as fallback
              try {
                  window.document.cookie =
                    encodeURIComponent(storageKey) + "=" + levelName + ";";
              } catch (ignore) {}
          }

          function getPersistedLevel() {
              var storedLevel;

              if (typeof window === undefinedType || !storageKey) return;

              try {
                  storedLevel = window.localStorage[storageKey];
              } catch (ignore) {}

              // Fallback to cookies if local storage gives us nothing
              if (typeof storedLevel === undefinedType) {
                  try {
                      var cookie = window.document.cookie;
                      var location = cookie.indexOf(
                          encodeURIComponent(storageKey) + "=");
                      if (location !== -1) {
                          storedLevel = /^([^;]+)/.exec(cookie.slice(location))[1];
                      }
                  } catch (ignore) {}
              }

              // If the stored level is not valid, treat it as if nothing was stored.
              if (self.levels[storedLevel] === undefined) {
                  storedLevel = undefined;
              }

              return storedLevel;
          }

          function clearPersistedLevel() {
              if (typeof window === undefinedType || !storageKey) return;

              // Use localStorage if available
              try {
                  window.localStorage.removeItem(storageKey);
                  return;
              } catch (ignore) {}

              // Use session cookie as fallback
              try {
                  window.document.cookie =
                    encodeURIComponent(storageKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
              } catch (ignore) {}
          }

          /*
           *
           * Public logger API - see https://github.com/pimterry/loglevel for details
           *
           */

          self.name = name;

          self.levels = { "TRACE": 0, "DEBUG": 1, "INFO": 2, "WARN": 3,
              "ERROR": 4, "SILENT": 5};

          self.methodFactory = factory || defaultMethodFactory;

          self.getLevel = function () {
              return currentLevel;
          };

          self.setLevel = function (level, persist) {
              if (typeof level === "string" && self.levels[level.toUpperCase()] !== undefined) {
                  level = self.levels[level.toUpperCase()];
              }
              if (typeof level === "number" && level >= 0 && level <= self.levels.SILENT) {
                  currentLevel = level;
                  if (persist !== false) {  // defaults to true
                      persistLevelIfPossible(level);
                  }
                  replaceLoggingMethods.call(self, level, name);
                  if (typeof console === undefinedType && level < self.levels.SILENT) {
                      return "No console available for logging";
                  }
              } else {
                  throw "log.setLevel() called with invalid level: " + level;
              }
          };

          self.setDefaultLevel = function (level) {
              defaultLevel = level;
              if (!getPersistedLevel()) {
                  self.setLevel(level, false);
              }
          };

          self.resetLevel = function () {
              self.setLevel(defaultLevel, false);
              clearPersistedLevel();
          };

          self.enableAll = function(persist) {
              self.setLevel(self.levels.TRACE, persist);
          };

          self.disableAll = function(persist) {
              self.setLevel(self.levels.SILENT, persist);
          };

          // Initialize with the right level
          var initialLevel = getPersistedLevel();
          if (initialLevel == null) {
              initialLevel = defaultLevel;
          }
          self.setLevel(initialLevel, false);
        }

        /*
         *
         * Top-level API
         *
         */

        var defaultLogger = new Logger();

        var _loggersByName = {};
        defaultLogger.getLogger = function getLogger(name) {
            if ((typeof name !== "symbol" && typeof name !== "string") || name === "") {
              throw new TypeError("You must supply a name when creating a logger.");
            }

            var logger = _loggersByName[name];
            if (!logger) {
              logger = _loggersByName[name] = new Logger(
                name, defaultLogger.getLevel(), defaultLogger.methodFactory);
            }
            return logger;
        };

        // Grab the current global log variable in case of overwrite
        var _log = (typeof window !== undefinedType) ? window.log : undefined;
        defaultLogger.noConflict = function() {
            if (typeof window !== undefinedType &&
                   window.log === defaultLogger) {
                window.log = _log;
            }

            return defaultLogger;
        };

        defaultLogger.getLoggers = function getLoggers() {
            return _loggersByName;
        };

        // ES6 default export, for compatibility
        defaultLogger['default'] = defaultLogger;

        return defaultLogger;
    }));
    });

    var log = loglevel;

    function createLoggerDecorator(MODULE_NAME, logger) {
        return function (__, propKey, descriptor) {
            var method = descriptor.value;
            descriptor.value = function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return __awaiter(this, void 0, void 0, function () {
                    var methodName, res, err_1;
                    return __generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                if (!logger) {
                                    // @ts-ignore
                                    logger = this.logger;
                                }
                                if (['log', 'error'].some(function (item) { return !logger[item]; })) {
                                    console.warn('loggerDecorator warning: your logger is not complete');
                                }
                                methodName = method.name || propKey || '';
                                _a.label = 1;
                            case 1:
                                _a.trys.push([1, 3, , 4]);
                                logger === null || logger === void 0 ? void 0 : logger.log.apply(logger, __spreadArray([MODULE_NAME, methodName], __read(args), false));
                                return [4 /*yield*/, method.apply(this, args)];
                            case 2:
                                res = _a.sent();
                                logger === null || logger === void 0 ? void 0 : logger.log(MODULE_NAME, "".concat(methodName, " success: "), res);
                                return [2 /*return*/, res];
                            case 3:
                                err_1 = _a.sent();
                                logger === null || logger === void 0 ? void 0 : logger.error(MODULE_NAME, "".concat(methodName, " failed: "), err_1);
                                throw err_1;
                            case 4: return [2 /*return*/];
                        }
                    });
                });
            };
        };
    }

    function sensitiveInfoFilter(content) {
        var regexs = [
            'scene/apps/[a-z0-9]{32}/',
            '"rtcKey":"[a-z0-9]{32}"',
            '"imKey":"[a-z0-9]{32}"',
            '"appkey":"[a-z0-9]{32}"',
            '"appkey": "[a-z0-9]{32}"',
            'appkey:"[a-z0-9]{32}"',
            'appkey: "[a-z0-9]{32}"',
            '"appkey":[a-z0-9]{32}',
            '"appkey": [a-z0-9]{32}',
            'appkey:[a-z0-9]{32}',
            'appkey: [a-z0-9]{32}',
        ];
        var templates = [
            'scene/apps/***/',
            '"rtcKey":"***"',
            '"imKey":"***"',
            '"appkey":"***"',
            '"appkey": "***"',
            'appkey:"***"',
            'appkey: "***"',
            '"appkey":***',
            '"appkey": ***',
            'appkey:***',
            'appkey: ***',
        ];
        regexs.forEach(function (regex, index) {
            var reg = new RegExp(regex, 'gi');
            content = content.replace(reg, templates[index]);
        });
        return content;
    }
    var logDebug = function (_a) {
        var _b = _a === void 0 ? {
            appName: '',
            version: '',
            storeWindow: false,
        } : _a, level = _b.level, _c = _b.appName, appName = _c === void 0 ? '' : _c; _b.version; var _e = _b.storeWindow, storeWindow = _e === void 0 ? false : _e;
        var genTime = function () {
            var now = new Date();
            var year = now.getFullYear();
            var month = now.getMonth() + 1;
            var day = now.getDate();
            var hour = now.getHours() < 10 ? "0".concat(now.getHours()) : now.getHours();
            var min = now.getMinutes() < 10 ? "0".concat(now.getMinutes()) : now.getMinutes();
            var s = now.getSeconds() < 10 ? "0".concat(now.getSeconds()) : now.getSeconds();
            var nowString = "".concat(year, "-").concat(month, "-").concat(day, " ").concat(hour, ":").concat(min, ":").concat(s);
            return nowString;
        };
        var genUserAgent = function () {
            try {
                var ua = navigator.userAgent.toLocaleLowerCase();
                var re = /(msie|firefox|chrome|opera|version).*?([\d.]+)/;
                var m = ua.match(re) || [];
                var browser = m[1].replace(/version/, 'safari');
                var ver = m[2];
                return {
                    browser: browser,
                    ver: ver,
                };
            }
            catch (error) {
                return null;
            }
        };
        var proxyLog = function () {
            var _log = new Proxy(log, {
                get: function (target, prop) {
                    var _a, _b;
                    if (!(prop in target)) {
                        return;
                    }
                    var func = target[prop];
                    if (!['log', 'info', 'warn', 'error', 'trace', 'debug'].includes(prop)) {
                        return func;
                    }
                    var prefix = genTime();
                    if (genUserAgent()) {
                        prefix += "[".concat((_a = genUserAgent()) === null || _a === void 0 ? void 0 : _a.browser, " ").concat((_b = genUserAgent()) === null || _b === void 0 ? void 0 : _b.ver, "]");
                    }
                    prefix +=
                        "[".concat({
                            log: 'L',
                            info: 'I',
                            warn: 'W',
                            error: 'E',
                            trace: 'E',
                            debug: 'D',
                        }[prop], "]") +
                            "[".concat(appName, "]") +
                            ':';
                    // eslint-disable-next-line @typescript-eslint/no-this-alias
                    var that = this;
                    return function () {
                        var args = [];
                        for (var _i = 0; _i < arguments.length; _i++) {
                            args[_i] = arguments[_i];
                        }
                        for (var i = 0; i < args.length; i++) {
                            if (typeof args[i] === 'object') {
                                try {
                                    args[i] = JSON.stringify(args[i]);
                                }
                                catch (_a) {
                                    console.warn('[日志打印对象无法序列化]', args[i]);
                                    args[i] = args[i];
                                }
                            }
                            if (typeof args[i] === 'string') {
                                args[i] = sensitiveInfoFilter(args[i]);
                            }
                        }
                        return func.apply(that, __spreadArray([prefix], __read(args), false));
                    };
                },
            });
            return _log;
        };
        var logger = proxyLog();
        if (level) {
            logger.setLevel(level);
        }
        if (storeWindow) {
            // @ts-ignore
            window.__LOGGER__ = logger;
        }
        return logger;
    };
    var logDebug$1 = logDebug;

    exports.EventPriority = void 0;
    (function (EventPriority) {
        EventPriority[EventPriority["LOW"] = 0] = "LOW";
        EventPriority[EventPriority["NORMAL"] = 1] = "NORMAL";
        EventPriority[EventPriority["HIGH"] = 2] = "HIGH";
    })(exports.EventPriority || (exports.EventPriority = {}));
    var ReportEvent = /** @class */ (function () {
        // private _report: XKitReporter
        function ReportEvent(options) {
            // static appInfo: AppInfo
            this.appKey = '';
            this.component = '';
            this.data = {};
            this.framework = '';
            this.version = '';
            this.startTime = 0;
            this.endTime = 0;
            this.duration = 0;
            this.data.startTime = new Date().getTime();
            this.data.timeStamp = this.data.startTime;
            this.eventId = options.eventId;
            this.priority = options.priority;
        }
        ReportEvent.prototype.end = function () {
            // 如果已经end过 不再end
            if (this.data.endTime && this.data.duration) {
                return;
            }
            this.data.endTime = this.data.endTime || new Date().getTime();
            this.data.duration =
                this.data.duration || this.data.endTime - this.data.startTime;
        };
        ReportEvent.prototype.setAppInfo = function (appInfo) {
            this.appKey = appInfo.appKey;
            this.component = appInfo.component;
            this.version = appInfo.version;
        };
        ReportEvent.prototype.endWith = function (data) {
            var code = data.code, msg = data.msg, requestId = data.requestId, serverCost = data.serverCost;
            this.data.code = code;
            this.data.message = msg;
            this.data.requestId = requestId;
            this.data.serverCost = serverCost;
            this.end();
        };
        ReportEvent.prototype.endWithSuccess = function (data) {
            if (data) {
                var requestId = data.requestId, serverCost = data.serverCost;
                this.data.requestId = requestId;
                this.data.serverCost = serverCost;
            }
            this.data.code = 0;
            this.data.message = 'success';
            this.end();
        };
        ReportEvent.prototype.endWithFailure = function (data) {
            if (data) {
                var requestId = data.requestId, serverCost = data.serverCost;
                this.data.requestId = requestId;
                this.data.serverCost = serverCost;
            }
            this.data.code = -1;
            this.data.message = 'failure';
            this.end();
        };
        ReportEvent.prototype.setParams = function (params) {
            this.data.params = __assign({}, params);
            return this;
        };
        ReportEvent.prototype.addParams = function (params) {
            this.data.params = __assign(__assign({}, this.data.params), params);
            return this;
        };
        ReportEvent.prototype.setData = function (data) {
            this.data = __assign(__assign({}, this.data), data);
        };
        ReportEvent.prototype.setUserId = function (userId) {
            this.data.userId = userId;
        };
        return ReportEvent;
    }());
    var EventStep = /** @class */ (function (_super) {
        __extends(EventStep, _super);
        function EventStep(options) {
            return _super.call(this, options) || this;
        }
        return EventStep;
    }(ReportEvent));
    var IntervalEvent = /** @class */ (function (_super) {
        __extends(IntervalEvent, _super);
        function IntervalEvent(options) {
            var _this = _super.call(this, options) || this;
            _this._stepMap = new Map();
            return _this;
        }
        IntervalEvent.prototype.beginStep = function (name) {
            if (this._stepMap.has(name)) {
                return this._stepMap[name];
            }
            var step = new EventStep({ eventId: name, priority: this.priority });
            step.setData({ step: name });
            this._stepMap.set(name, step);
            return step;
        };
        IntervalEvent.prototype.addStep = function (data) {
            this._stepMap.set(data.eventId, data);
        };
        IntervalEvent.prototype.removeStep = function (eventId) {
            this._stepMap.delete(eventId);
        };
        IntervalEvent.prototype.endWith = function (data) {
            _super.prototype.endWith.call(this, data);
            this.end();
        };
        IntervalEvent.prototype.endWithSuccess = function (data) {
            _super.prototype.endWithSuccess.call(this, data);
            this.end();
        };
        IntervalEvent.prototype.endWithFailure = function (data) {
            _super.prototype.endWithFailure.call(this, data);
            this.end();
        };
        IntervalEvent.prototype.end = function () {
            var e_1, _a;
            var steps = [];
            _super.prototype.end.call(this);
            try {
                for (var _b = __values(this._stepMap.values()), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var step = _c.value;
                    // step.end()
                    step.data.index = steps.length;
                    steps.push(step.data);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
            if (steps.length > 0) {
                this.data.steps = steps;
            }
        };
        return IntervalEvent;
    }(EventStep));

    /**
     * 异步频率控制
     * 一段时间内只请求一次，多余的用这一次执行的结果做为结果
     * @param fn
     * @param delay
     */
    var frequencyControl = function (fn, delay) {
        var queue = [];
        var last = 0;
        var timer;
        return function () {
            var _this = this;
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            return new Promise(function (resolve, reject) {
                queue.push({ resolve: resolve, reject: reject });
                var cur = Date.now();
                var consumer = function (success, res) {
                    while (queue.length) {
                        var _a = queue.shift(), resolve_1 = _a.resolve, reject_1 = _a.reject;
                        success ? resolve_1(res) : reject_1(res);
                    }
                };
                var excute = function () {
                    last = cur;
                    if (!queue.length)
                        return;
                    // @ts-ignore
                    fn.apply(_this, args).then(function (res) {
                        consumer(true, res);
                    }, function (err) {
                        consumer(false, err);
                    });
                };
                if (cur - last > delay) {
                    excute();
                }
                else {
                    clearTimeout(timer);
                    timer = setTimeout(function () {
                        excute();
                    }, delay);
                }
            });
        };
    };
    function getFileType(filename) {
        var fileMap = {
            img: /(png|gif|jpg)/i,
            pdf: /pdf$/i,
            word: /(doc|docx)$/i,
            excel: /(xls|xlsx)$/i,
            ppt: /(ppt|pptx)$/i,
            zip: /(zip|rar|7z)$/i,
            audio: /(mp3|wav|wmv)$/i,
            video: /(mp4|mkv|rmvb|wmv|avi|flv|mov)$/i,
        };
        return Object.keys(fileMap).find(function (type) { return fileMap[type].test(filename); }) || '';
    }
    /**
     * 解析输入的文件大小
     * @param size 文件大小，单位b
     * @param level 递归等级，对应fileSizeMap
     */
    var parseFileSize = function (size, level) {
        if (level === void 0) { level = 0; }
        var fileSizeMap = {
            0: 'B',
            1: 'KB',
            2: 'MB',
            3: 'GB',
            4: 'TB',
        };
        var handler = function (size, level) {
            if (level >= Object.keys(fileSizeMap).length) {
                return 'the file is too big';
            }
            if (size < 1024) {
                return "".concat(size).concat(fileSizeMap[level]);
            }
            return handler(Math.round(size / 1024), level + 1);
        };
        return handler(size, level);
    };
    var addUrlSearch = function (url, search) {
        var urlObj = new URL(url);
        urlObj.search += (urlObj.search.startsWith('?') ? '&' : '?') + search;
        return urlObj.href;
    };
    function debounce(fn, wait) {
        var timer = null;
        return function () {
            var _this = this;
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            if (timer) {
                clearTimeout(timer);
                timer = null;
            }
            timer = setTimeout(function () {
                // @ts-ignore
                fn.apply(_this, args);
            }, wait);
        };
    }
    function getOperatingSystem() {
        try {
            var userAgent = navigator.userAgent;
            if (userAgent.includes('Windows')) {
                return 'Windows';
            }
            else if (userAgent.includes('Mac OS')) {
                return 'Mac OS';
            }
            else if (userAgent.includes('Linux')) {
                return 'Linux';
            }
            else if (userAgent.includes('Android')) {
                return 'Android';
            }
            else if (userAgent.includes('iOS')) {
                return 'iOS';
            }
            else {
                return 'Unknown';
            }
        }
        catch (_a) {
            return 'Unknown';
        }
    }
    function getBrowserInfo() {
        var browserName = 'Unknown';
        var browserVersion = '';
        try {
            var userAgent = navigator.userAgent;
            // 判断是否为Chrome浏览器
            if (userAgent.indexOf('Chrome') !== -1) {
                browserName = 'Chrome';
                var start = userAgent.indexOf('Chrome') + 7;
                var end = userAgent.indexOf(' ', start);
                browserVersion = userAgent.substring(start, end);
            }
            // 判断是否为Firefox浏览器
            else if (userAgent.indexOf('Firefox') !== -1) {
                browserName = 'Firefox';
                var start = userAgent.indexOf('Firefox') + 8;
                browserVersion = userAgent.substring(start);
            }
            // 判断是否为Safari浏览器
            else if (userAgent.indexOf('Safari') !== -1) {
                browserName = 'Safari';
                var start = userAgent.indexOf('Version') + 8;
                var end = userAgent.indexOf(' ', start);
                browserVersion = userAgent.substring(start, end);
            }
            // 判断是否为Edge浏览器
            else if (userAgent.indexOf('Edg') !== -1) {
                browserName = 'Edge';
                var start = userAgent.indexOf('Edg') + 4;
                browserVersion = userAgent.substring(start);
            }
            // 判断是否为IE浏览器（IE11及以下版本）
            else if (userAgent.indexOf('MSIE') !== -1) {
                browserName = 'Internet Explorer';
                var start = userAgent.indexOf('MSIE') + 5;
                var end = userAgent.indexOf(';', start);
                browserVersion = userAgent.substring(start, end);
            }
        }
        catch (_a) { }
        return {
            name: browserName,
            version: browserVersion,
        };
    }

    var url = "https://statistic.live.126.net/statics/report/common/form";
    var HEADER_VALUE_SDK_TYPE = 'NEXKitStatistics';
    var HEADER_VALUE_REPORTER_VERSION = '1.0.0';
    var HEADER_VALUE_CONTENT_TYPE = 'application/json;charset=utf-8';
    var EVENT_REPORT_INTERVAL = 5000;
    var MAX_EVENT_CACHE_SIZE = 100;
    var LOW_PRIORITY_RETRY = 0;
    var NORMAL_PRIORITY_RETRY = 2;
    var HIGH_PRIORITY_RETRY = 5;
    var XKitReporter = /** @class */ (function () {
        function XKitReporter(options) {
            this._eventsCache = [];
            this._noReport = false; // 是否上报数据
            var browserInfo = getBrowserInfo();
            var appInfo = window.__XKitReporter__;
            var userAgent = '';
            try {
                userAgent = navigator.userAgent;
            }
            catch (_a) { }
            this.common = {
                imVersion: options.imVersion,
                nertcVersion: options.nertcVersion,
                platform: 'Web',
                osVer: browserInfo.version,
                userAgent: userAgent,
                manufacturer: '',
                model: browserInfo.name,
                packageId: (appInfo === null || appInfo === void 0 ? void 0 : appInfo.packageId) || '',
                appVer: (appInfo === null || appInfo === void 0 ? void 0 : appInfo.appVer) || '',
                appName: (appInfo === null || appInfo === void 0 ? void 0 : appInfo.appName) || '',
                deviceId: options.deviceId,
            };
            this._logger = logDebug$1({
                level: 'debug',
                appName: 'XKitReporter',
                version: '2.0.0',
            });
        }
        XKitReporter.prototype.setNoReport = function (noReport) {
            this._noReport = noReport;
        };
        XKitReporter.prototype.reportEvent = function (event, options) {
            // 如果禁止上包则返回
            if (this._noReport) {
                return;
            }
            if (this._eventsCache.length >= MAX_EVENT_CACHE_SIZE) {
                this._evictEvent(event);
            }
            else {
                this._eventsCache.push(event);
            }
            this._scheduleReportEventsTask(options === null || options === void 0 ? void 0 : options.immediate);
        };
        XKitReporter.prototype._evictEvent = function (event) {
            var index = this._eventsCache.findIndex(function (item) { return item.priority < event.priority; });
            this._eventsCache.push(event);
            if (index !== -1) {
                this._evictEvent(this._eventsCache[index]);
            }
            else {
                this._logger.debug('Full event cache, evict event:', event);
                this._eventsCache = this._eventsCache.filter(function (item) { return item !== event; });
            }
        };
        XKitReporter.prototype._scheduleReportEventsTask = function (immediate) {
            var _this = this;
            if (immediate === void 0) { immediate = false; }
            var execute = function () {
                var groupByAppKey = _this._eventsCache.reduce(function (acc, obj) {
                    var key = obj.appKey;
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(obj);
                    return acc;
                }, {});
                for (var appKey in groupByAppKey) {
                    _this._reportEventsToServer(appKey, groupByAppKey[appKey]);
                }
                _this._eventsCache = [];
            };
            if (immediate) {
                execute();
            }
            if (this._queueTimer) {
                return;
            }
            this._queueTimer = setInterval(function () {
                if (_this._eventsCache.length === 0) {
                    _this._queueTimer && clearInterval(_this._queueTimer);
                    _this._queueTimer = undefined;
                    return;
                }
                execute();
            }, EVENT_REPORT_INTERVAL);
        };
        XKitReporter.prototype._determineMaxRetry = function (events) {
            var e_1, _a;
            var retry = LOW_PRIORITY_RETRY;
            try {
                for (var events_1 = __values(events), events_1_1 = events_1.next(); !events_1_1.done; events_1_1 = events_1.next()) {
                    var event_1 = events_1_1.value;
                    if (event_1.priority === exports.EventPriority.HIGH) {
                        retry = HIGH_PRIORITY_RETRY;
                        break;
                    }
                    if (event_1.priority === exports.EventPriority.NORMAL) {
                        retry = NORMAL_PRIORITY_RETRY;
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (events_1_1 && !events_1_1.done && (_a = events_1.return)) _a.call(events_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
            return retry;
        };
        XKitReporter.prototype._reportEventsToServer = function (appKey, events) {
            var _this = this;
            var groupByEventId = events.reduce(function (acc, obj) {
                var key = obj.eventId;
                if (!acc[key]) {
                    acc[key] = [];
                }
                acc[key].push(__assign(__assign({}, obj.data), { appKey: obj.appKey, component: obj.component, version: obj.version, framework: obj.framework }));
                return acc;
            }, {});
            var maxRetry = this._determineMaxRetry(events);
            var retry = 0;
            var data = {
                common: this.common,
                event: groupByEventId,
            };
            var networkRequest = function () {
                request({
                    method: 'POST',
                    url: url,
                    headers: {
                        appkey: appKey,
                        sdktype: HEADER_VALUE_SDK_TYPE,
                        ver: HEADER_VALUE_REPORTER_VERSION,
                        'Content-Type': HEADER_VALUE_CONTENT_TYPE,
                    },
                    data: data,
                }).catch(function () {
                    if (retry <= maxRetry) {
                        setTimeout(networkRequest, 2000 * retry);
                    }
                    else {
                        _this._logger.debug("Failed to report events to server after ".concat(retry, " retries."), data);
                    }
                    retry++;
                });
            };
            networkRequest();
        };
        XKitReporter.setAppInfo = function (info) {
            try {
                window.__XKitReporter__ = {
                    packageId: info.packageId,
                    appName: info.appName,
                    appVer: info.appVer,
                };
            }
            catch (_a) { }
        };
        XKitReporter.getInstance = function (options) {
            if (!options) {
                if (!this.instance) {
                    throw new Error('XKitReporter not initialized');
                }
                return this.instance;
            }
            if (!this.instance) {
                this.instance = new XKitReporter(options);
            }
            return this.instance;
        };
        return XKitReporter;
    }());
    var XKitReporter$1 = XKitReporter;

    exports.EventStep = EventStep;
    exports.EventTracking = EventTracking$1;
    exports.IntervalEvent = IntervalEvent;
    exports.ReportEvent = ReportEvent;
    exports.Storage = index;
    exports.VisibilityObserver = VisibilityObserver$1;
    exports.XKitReporter = XKitReporter$1;
    exports.addUrlSearch = addUrlSearch;
    exports.createLoggerDecorator = createLoggerDecorator;
    exports.debounce = debounce;
    exports.frequencyControl = frequencyControl;
    exports.getBrowserInfo = getBrowserInfo;
    exports.getFileType = getFileType;
    exports.getOperatingSystem = getOperatingSystem;
    exports.logDebug = logDebug$1;
    exports.parseFileSize = parseFileSize;
    exports.request = request;
    });

    unwrapExports(index_cjs);
    index_cjs.EventPriority;
    index_cjs.EventStep;
    var index_cjs_3 = index_cjs.EventTracking;
    index_cjs.IntervalEvent;
    index_cjs.ReportEvent;
    index_cjs.Storage;
    index_cjs.VisibilityObserver;
    index_cjs.XKitReporter;
    index_cjs.addUrlSearch;
    index_cjs.createLoggerDecorator;
    index_cjs.debounce;
    index_cjs.frequencyControl;
    index_cjs.getBrowserInfo;
    index_cjs.getFileType;
    index_cjs.getOperatingSystem;
    index_cjs.logDebug;
    index_cjs.parseFileSize;
    index_cjs.request;

    var LOCALVIEW_NULL = {
        code: '201',
        message: 'localview is null',
    };
    var LOCALSTREAM_NULL = {
        code: '202',
        message: 'localstream is null',
    };
    var REMOTEVIEW_NULL = {
        code: '203',
        message: 'remoteview is null',
    };

    var VIDEO_QUALITY;
    (function (VIDEO_QUALITY) {
        VIDEO_QUALITY[VIDEO_QUALITY["VIDEO_QUALITY_1080p"] = NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_1080p] = "VIDEO_QUALITY_1080p";
        VIDEO_QUALITY[VIDEO_QUALITY["VIDEO_QUALITY_720p"] = NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_720p] = "VIDEO_QUALITY_720p";
        VIDEO_QUALITY[VIDEO_QUALITY["VIDEO_QUALITY_480p"] = NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_480p] = "VIDEO_QUALITY_480p";
        VIDEO_QUALITY[VIDEO_QUALITY["VIDEO_QUALITY_180p"] = NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_180p] = "VIDEO_QUALITY_180p";
    })(VIDEO_QUALITY || (VIDEO_QUALITY = {}));
    var VIDEO_FRAME_RATE;
    (function (VIDEO_FRAME_RATE) {
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_NORMAL"] = NERTC$1.VIDEO_FRAME_RATE
            .CHAT_VIDEO_FRAME_RATE_NORMAL] = "CHAT_VIDEO_FRAME_RATE_NORMAL";
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_5"] = NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5] = "CHAT_VIDEO_FRAME_RATE_5";
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_10"] = NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10] = "CHAT_VIDEO_FRAME_RATE_10";
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_15"] = NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15] = "CHAT_VIDEO_FRAME_RATE_15";
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_20"] = NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20] = "CHAT_VIDEO_FRAME_RATE_20";
        VIDEO_FRAME_RATE[VIDEO_FRAME_RATE["CHAT_VIDEO_FRAME_RATE_25"] = NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25] = "CHAT_VIDEO_FRAME_RATE_25";
    })(VIDEO_FRAME_RATE || (VIDEO_FRAME_RATE = {}));

    var TAG_NAME$1 = 'RTCController';
    var RTCController = /** @class */ (function (_super) {
        __extends(RTCController, _super);
        function RTCController(_a) {
            var appKey = _a.appKey, rtcConfig = _a.rtcConfig, kitName = _a.kitName, kitVersion = _a.kitVersion, _b = _a.debug, debug = _b === void 0 ? true : _b;
            var _this = _super.call(this) || this;
            _this.remoteStreams = [];
            _this._remoteViews = [];
            _this._rtcConfig = {
                videoResolution: VIDEO_QUALITY.VIDEO_QUALITY_720p,
                videoFrameRate: VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,
                audioQuality: 'speech_low_quality',
            };
            _this._inTheRoom = false;
            _this._rtcSDK = NERTC$1;
            _this.client = _this._rtcSDK.createClient({ appkey: appKey, debug: debug });
            if (debug) {
                _this._logger = c({
                    appName: kitName,
                    version: kitVersion,
                    level: 'trace',
                });
            }
            if (rtcConfig) {
                _this._rtcConfig = rtcConfig;
            }
            _this._addRtcEventListener();
            return _this;
        }
        RTCController.prototype.getChannelInfo = function () {
            return this.client.getChannelInfo();
        };
        RTCController.prototype.initLocalStream = function (options) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            if (this.localStream) {
                                return [2 /*return*/];
                            }
                            this.localStream = this._rtcSDK.createStream(__assign(__assign({}, this._rtcConfig.streamOptions), { uid: options.uid, audio: options.audio, video: options.video, screen: options.screen }));
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'localStream create success', this.localStream, options.audio, options.video);
                            // 设置本地视频质量
                            this.localStream.setVideoProfile({
                                resolution: this._rtcConfig.videoResolution || VIDEO_QUALITY.VIDEO_QUALITY_720p,
                                frameRate: this._rtcConfig.videoFrameRate ||
                                    VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL, //设置视频帧率
                            });
                            // 设置本地音频质量
                            this.localStream.setAudioProfile(this._rtcConfig.audioQuality || 'speech_low_quality');
                            return [4 /*yield*/, this.localStream.init()];
                        case 1:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.leaveRTCChannel = function () {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var _b, error_1;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 3, , 4]);
                            _b = this._inTheRoom;
                            if (!_b) return [3 /*break*/, 2];
                            return [4 /*yield*/, this.client.leave()];
                        case 1:
                            _b = (_c.sent());
                            _c.label = 2;
                        case 2:
                            this._inTheRoom = false;
                            this.resetState();
                            return [3 /*break*/, 4];
                        case 3:
                            error_1 = _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$1, 'leaveRTCChannel fail: ', error_1);
                            throw error_1;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.joinRTCChannel = function (options, getTokenCostTime) {
            var _a, _b, _c, _d, _e, _f, _g, _h;
            return __awaiter(this, void 0, void 0, function () {
                var tokenCostTime, token, _j, neRtcServerAddresses, res, error_2;
                return __generator(this, function (_k) {
                    switch (_k.label) {
                        case 0:
                            _k.trys.push([0, 5, , 6]);
                            if (this._inTheRoom) {
                                (_a = this._logger) === null || _a === void 0 ? void 0 : _a.warn(TAG_NAME$1, 'joinRTCChannel in the room');
                                return [2 /*return*/];
                            }
                            tokenCostTime = Date.now();
                            if (!((_b = options.token) !== null && _b !== void 0)) return [3 /*break*/, 1];
                            _j = _b;
                            return [3 /*break*/, 3];
                        case 1: return [4 /*yield*/, ((_d = (_c = this._rtcConfig).getToken) === null || _d === void 0 ? void 0 : _d.call(_c, options))];
                        case 2:
                            _j = (_k.sent());
                            _k.label = 3;
                        case 3:
                            token = _j;
                            tokenCostTime = Date.now() - tokenCostTime;
                            getTokenCostTime === null || getTokenCostTime === void 0 ? void 0 : getTokenCostTime(tokenCostTime);
                            neRtcServerAddresses = (_e = options.neRtcServerAddresses) !== null && _e !== void 0 ? _e : this._rtcConfig.neRtcServerAddresses;
                            (_f = this._logger) === null || _f === void 0 ? void 0 : _f.log(TAG_NAME$1, 'joinRTCChannel:', options, token, neRtcServerAddresses);
                            return [4 /*yield*/, this.client.join(__assign(__assign({}, options), { neRtcServerAddresses: neRtcServerAddresses, token: token }))];
                        case 4:
                            res = _k.sent();
                            this._inTheRoom = true;
                            (_g = this._logger) === null || _g === void 0 ? void 0 : _g.log(TAG_NAME$1, 'joinRTCChannel success: ', res);
                            return [3 /*break*/, 6];
                        case 5:
                            error_2 = _k.sent();
                            (_h = this._logger) === null || _h === void 0 ? void 0 : _h.error(TAG_NAME$1, 'joinRTCChannel fail: ', error_2);
                            throw error_2;
                        case 6: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.publishLocalStream = function () {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var error_3;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            _c.label = 1;
                        case 1:
                            _c.trys.push([1, 3, , 4]);
                            return [4 /*yield*/, this.client.publish(this.localStream)];
                        case 2:
                            _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'publishLocalStream success');
                            return [3 /*break*/, 4];
                        case 3:
                            error_3 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, 'publishLocalStream fail: ', error_3);
                            throw error_3;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.enableLocalVideo = function (enabled, deviceId) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var error_4;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 4, , 5]);
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            if (!this._localView) {
                                throw LOCALVIEW_NULL;
                            }
                            return [4 /*yield*/, this.localStream[enabled ? 'open' : 'close']({
                                    type: 'video',
                                    deviceId: deviceId,
                                })];
                        case 1:
                            _c.sent();
                            if (!enabled) return [3 /*break*/, 3];
                            return [4 /*yield*/, this._startStreamPreview(this.localStream, 'local', this._localView)];
                        case 2:
                            _c.sent();
                            _c.label = 3;
                        case 3:
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, '_enableLocalVideo success:', enabled, deviceId);
                            return [3 /*break*/, 5];
                        case 4:
                            error_4 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, '_enableLocalVideo fail:', enabled, deviceId, error_4);
                            throw error_4;
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.enableLocalAudio = function (enabled, deviceId) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var error_5;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 4, , 5]);
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            if (!this._localView) {
                                throw LOCALVIEW_NULL;
                            }
                            return [4 /*yield*/, this.localStream[enabled ? 'open' : 'close']({
                                    type: 'audio',
                                    deviceId: deviceId,
                                })];
                        case 1:
                            _c.sent();
                            if (!enabled) return [3 /*break*/, 3];
                            return [4 /*yield*/, this._startStreamPreview(this.localStream, 'local', this._localView)];
                        case 2:
                            _c.sent();
                            _c.label = 3;
                        case 3:
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, '_enableLocalVideo success:', enabled, deviceId);
                            return [3 /*break*/, 5];
                        case 4:
                            error_5 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, '_enableLocalVideo fail:', enabled, deviceId, error_5);
                            throw error_5;
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.muteLocalVideo = function (mute) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var error_6;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 2, , 3]);
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            return [4 /*yield*/, this.localStream[mute ? 'muteVideo' : 'unmuteVideo']()];
                        case 1:
                            _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'muteLocalVideo success: ', mute);
                            return [3 /*break*/, 3];
                        case 2:
                            error_6 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, 'muteLocalVideo fail: ', mute);
                            throw error_6;
                        case 3: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.muteLocalAudio = function (mute) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var error_7;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 2, , 3]);
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            return [4 /*yield*/, this.localStream[mute ? 'muteAudio' : 'unmuteAudio']()];
                        case 1:
                            _c.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'muteLocalAudio success: ', mute);
                            return [3 /*break*/, 3];
                        case 2:
                            error_7 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, 'muteLocalAudio fail: ', mute);
                            throw error_7;
                        case 3: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.playLocalStream = function (view) {
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            if (!this.localStream) {
                                throw LOCALSTREAM_NULL;
                            }
                            if (!this._localView) {
                                throw LOCALVIEW_NULL;
                            }
                            return [4 /*yield*/, this._startStreamPreview(this.localStream, 'local', view || this._localView)];
                        case 1:
                            _a.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.setLocalView = function (view) {
            this._localView = view;
        };
        RTCController.prototype.setRemoteView = function (view, uid) {
            var remoteView = this._remoteViews.find(function (item) { return item.uid === uid; });
            if (remoteView) {
                remoteView.view = view;
            }
            else {
                this._remoteViews.push({
                    view: view,
                    uid: uid,
                });
            }
        };
        RTCController.prototype.playRemoteStream = function (stream) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var dom, error_8;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            dom = this._remoteViews.find(function (item) { return item.uid === stream.getId(); });
                            if (!dom) {
                                throw REMOTEVIEW_NULL;
                            }
                            _b.label = 1;
                        case 1:
                            _b.trys.push([1, 3, , 4]);
                            return [4 /*yield*/, this._startStreamPreview(stream, 'remote', dom.view)];
                        case 2:
                            _b.sent();
                            return [3 /*break*/, 4];
                        case 3:
                            error_8 = _b.sent();
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.error(TAG_NAME$1, '_playRemoteStream fail: ', error_8);
                            throw error_8;
                        case 4: return [2 /*return*/];
                    }
                });
            });
        };
        RTCController.prototype.resetState = function () {
            var _a;
            (_a = this.localStream) === null || _a === void 0 ? void 0 : _a.destroy();
            this._localView = undefined;
            this.localStream = undefined;
            this._remoteViews = [];
            this.remoteStreams = [];
        };
        RTCController.prototype.destroy = function () {
            this.leaveRTCChannel();
            // this.resetState()
        };
        /**
         * 播放流
         * @param stream
         * @param type
         * @param view
         */
        RTCController.prototype._startStreamPreview = function (stream, type, view) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var params, error_9;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            _c.trys.push([0, 2, , 3]);
                            stream.stop();
                            return [4 /*yield*/, stream.play(view)];
                        case 1:
                            _c.sent();
                            params = {
                                // 设置视频窗口大小
                                width: view.clientWidth,
                                height: view.clientHeight,
                                cut: true, // 是否裁剪
                            };
                            stream[type === 'local' ? 'setLocalRenderMode' : 'setRemoteRenderMode'](params);
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, type === 'local'
                                ? 'setLocalRenderMode'
                                : 'setRemoteRenderMode' + ' success', { params: params, type: type });
                            return [3 /*break*/, 3];
                        case 2:
                            error_9 = _c.sent();
                            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.error(TAG_NAME$1, 'startStreamPreview fail: ', error_9);
                            throw error_9;
                        case 3: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 新增流，如果以存在，则更新流
         * @param stream
         */
        RTCController.prototype._addStream = function (stream) {
            var _a, _b;
            stream.setSubscribeConfig({
                audio: true,
                video: true,
            });
            // 发起订阅
            this.client.subscribe(stream);
            var uid = stream.getId();
            if (this.remoteStreams.some(function (item) { return item.getId() === uid; })) {
                (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'stream-added：订阅的流已存在，更新流');
                this._updateStream(stream);
            }
            else {
                (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME$1, 'stream-added：新增需要订阅的流');
                this.remoteStreams.push(stream);
            }
        };
        /**
         * 更新流
         * @param stream
         */
        RTCController.prototype._updateStream = function (stream) {
            var uid = stream.getId();
            this.remoteStreams = this.remoteStreams.map(function (item) {
                return item.getId() === uid ? stream : item;
            });
        };
        RTCController.prototype._addRtcEventListener = function () {
            return __awaiter(this, void 0, void 0, function () {
                var _this = this;
                return __generator(this, function (_a) {
                    this.client.on('peer-online', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'peer-online: ', evt);
                        _this.emit('peerOnline', evt.uid);
                    });
                    this.client.on('peer-leave', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'peer-leave: ', evt);
                        _this.emit('peerLeave', evt.uid);
                    });
                    this.client.on('stream-added', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'stream-added: ', evt);
                        _this._addStream(evt.stream);
                        _this.emit('streamAdd', evt.stream);
                    });
                    this.client.on('stream-removed', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'stream-removed: ', evt);
                        var stream = evt.stream;
                        stream.stop(evt.mediaType);
                        _this._updateStream(stream);
                    });
                    this.client.on('stream-subscribed', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'stream-subscribed: ', evt);
                        _this.emit('streamSubscribed', evt.stream);
                    });
                    this.client.on('mute-video', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'mute-video: ', evt);
                        var uid = evt.uid;
                        var stream = _this.remoteStreams.find(function (item) { return item.getId() === uid; });
                        stream === null || stream === void 0 ? void 0 : stream.stop('video');
                    });
                    this.client.on('unmute-video', function (evt) {
                        var _a, _b;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'unmute-video: ', evt);
                        var uid = evt.uid;
                        var view = (_b = _this._remoteViews.find(function (item) { return item.uid === uid; })) === null || _b === void 0 ? void 0 : _b.view;
                        var stream = _this.remoteStreams.find(function (item) { return item.getId() === uid; });
                        if (view && stream) {
                            _this._startStreamPreview(stream, 'remote', view);
                        }
                    });
                    this.client.on('mute-audio', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'mute-audio: ', evt);
                    });
                    this.client.on('unmute-audio', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'unmute-audio: ', evt);
                    });
                    this.client.on('error', function (evt) {
                        var _a;
                        (_a = _this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME$1, 'error: ', evt);
                        _this.emit('error', evt);
                    });
                    return [2 /*return*/];
                });
            });
        };
        return RTCController;
    }(eventemitter3));

    var name = "@xkit-yx/call-kit";
    var author = "";
    var description = "";
    var files = [
    	"dist",
    	"assets",
    	"miniprogram_dist"
    ];
    var keywords = [
    ];
    var license = "MIT";
    var miniprogram = "miniprogram_dist";
    var main = "dist/index.cjs.js";
    var module = "dist/index.esm.js";
    var typings = "dist/types/index.d.ts";
    var publishConfig = {
    	access: "public"
    };
    var scripts = {
    	dev: "rm -rf ./lib && rollup -c --environment DEV",
    	build: "rollup -c"
    };
    var version = "1.9.4";
    var dependencies = {
    	"@xkit-yx/utils": "^0.5.2",
    	eventemitter3: "^4.0.7",
    	"nertc-web-sdk": "^4.6.25",
    	"yunxin-log-debug": "^1.1.6"
    };
    var devDependencies = {
    	"@rollup/plugin-json": "^4.1.0",
    	"@rollup/plugin-node-resolve": "^10.0.0",
    	rollup: "^2.33.1",
    	"rollup-plugin-commonjs": "^10.1.0",
    	"rollup-plugin-terser": "^7.0.2",
    	"rollup-plugin-typescript2": "^0.31.2",
    	typescript: "^4.0.3"
    };
    var pkg = {
    	name: name,
    	author: author,
    	description: description,
    	files: files,
    	keywords: keywords,
    	license: license,
    	miniprogram: miniprogram,
    	main: main,
    	module: module,
    	typings: typings,
    	publishConfig: publishConfig,
    	scripts: scripts,
    	version: version,
    	dependencies: dependencies,
    	devDependencies: devDependencies
    };

    var TAG_NAME = 'NECall';
    var NECall = /** @class */ (function (_super) {
        __extends(NECall, _super);
        function NECall(params) {
            var _this = this;
            var _a, _b;
            var nim = params.nim, appKey = params.appKey, currentUserInfo = params.currentUserInfo, enableAutoJoinSignalChannel = params.enableAutoJoinSignalChannel, enableSwitchCallTypeConfirm = params.enableSwitchCallTypeConfirm, enableJoinRTCChannelWhenCall = params.enableJoinRTCChannelWhenCall, rtcConfig = params.rtcConfig, _c = params.debug, debug = _c === void 0 ? true : _c, _d = params.eventTracking, eventTracking = _d === void 0 ? true : _d;
            _this = _super.call(this) || this;
            _this.costTimeEventTracking = {
                needPush: false,
                isCaller: false,
                callId: '',
                userAccId: '',
                token: 0,
                wait: 0,
                rtcJoin: 0,
                rtcCid: '',
                rtcUid: '',
                rtcAudio: 0,
                rtcVideo: 0,
                userAction: 0,
                signalTimestamp: 0,
            };
            _this._userArr = [];
            _this._unusualTimeout = 15000;
            var kitName = 'NECall';
            var kitVersion = pkg.version;
            _this.signalController = new SignalController({
                nim: nim,
                kitName: kitName,
                enableAutoJoinSignalChannel: enableAutoJoinSignalChannel,
                kitVersion: kitVersion,
                uid: currentUserInfo.uid,
                debug: debug,
            });
            _this.rtcController = new RTCController({
                appKey: appKey,
                kitName: kitName,
                kitVersion: kitVersion,
                debug: debug,
                rtcConfig: rtcConfig,
            });
            _this._enableSwitchCallTypeConfirm = enableSwitchCallTypeConfirm !== null && enableSwitchCallTypeConfirm !== void 0 ? enableSwitchCallTypeConfirm : {
                video: false,
                audio: false,
            };
            _this._enableJoinRTCChannelWhenCall = enableJoinRTCChannelWhenCall !== null && enableJoinRTCChannelWhenCall !== void 0 ? enableJoinRTCChannelWhenCall : false;
            _this._currentUserInfo = currentUserInfo;
            _this._bindSignalControllerHooks();
            _this._handleRtcEvents();
            if (debug) {
                _this._logger = c({
                    appName: kitName,
                    version: kitVersion,
                    level: 'trace',
                });
            }
            _this.costTimeEventTracking.userAccId = currentUserInfo.accId;
            _this._eventTracking = eventTracking
                ? new index_cjs_3({
                    appKey: appKey,
                    version: kitVersion,
                    component: 'CallKit',
                    nertcVersion: NERTC$1.VERSION,
                })
                : undefined;
            (_a = _this._eventTracking) === null || _a === void 0 ? void 0 : _a.track('init', '');
            (_b = _this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME, 'init', params);
            return _this;
        }
        /**
         * 发起呼叫
         * @param params.accId 对方accId;
         * @param params.callType 呼叫类型;
         * @param params.callId 呼叫id;
         * @param params.signalChannelName 呼叫信道名称;
         * @param params.signalPushConfig 呼叫信道推送配置;
         * @param params.rtcChannelName rtc信道名称;
         * @param params.rtcTokenTtl rtcToken有效期;
         * @param params.enableOffline 是否允许离线;
         * @param params.extraInfo 附加信息;
         * @param params.globalExtraCopy 全局附加信息;
         * @returns
         */
        NECall.prototype.call = function (params) {
            var _a, _b, _c, _d;
            return __awaiter(this, void 0, void 0, function () {
                var nertcJoinRoomQueryParamMap, channelInfo, uid, res;
                var _this = this;
                return __generator(this, function (_e) {
                    switch (_e.label) {
                        case 0:
                            // 埋点数据
                            this.costTimeEventTracking.needPush = true;
                            this.costTimeEventTracking.isCaller = true;
                            this.costTimeEventTracking.signalTimestamp = Date.now();
                            this.costTimeEventTracking.wait = Date.now();
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'call', params);
                            nertcJoinRoomQueryParamMap = 
                            // @ts-ignore
                            this.rtcController.client.getParameter('getChannelInfo');
                            return [4 /*yield*/, this.signalController.call(__assign(__assign({}, params), { nertcJoinRoomQueryParamMap: nertcJoinRoomQueryParamMap }))];
                        case 1:
                            channelInfo = _e.sent();
                            this.costTimeEventTracking.callId = channelInfo.attachExt.callId;
                            uid = (_c = (_b = channelInfo.members.find(function (item) { return item.accid === _this._currentUserInfo.accId; })) === null || _b === void 0 ? void 0 : _b.uid) !== null && _c !== void 0 ? _c : '';
                            this._callType = params.callType;
                            this._callId = channelInfo.attachExt.callId;
                            res = {
                                callId: channelInfo.attachExt.callId,
                                uid: uid,
                            };
                            // 埋点数据
                            (_d = this._eventTracking) === null || _d === void 0 ? void 0 : _d.track('userAction', {
                                event_type: 'inviteSuccess',
                                callId: this.costTimeEventTracking.callId,
                                isCaller: this.costTimeEventTracking.isCaller,
                                userAccId: this.costTimeEventTracking.userAccId,
                                uid: this._currentUserInfo.uid,
                            });
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 接收呼叫
         * @param params.callId 呼叫id，非必填
         * @param params.enableOffline 是否接收离线消息;
         */
        NECall.prototype.accept = function (params) {
            var _a, _b, _c;
            return __awaiter(this, void 0, void 0, function () {
                var nertcJoinRoomQueryParamMap, channelInfo, uid, res;
                var _this = this;
                return __generator(this, function (_d) {
                    switch (_d.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'accept', params);
                            // 埋点数据
                            this.costTimeEventTracking.wait =
                                Date.now() - this.costTimeEventTracking.wait;
                            this.costTimeEventTracking.userAction = Date.now();
                            nertcJoinRoomQueryParamMap = 
                            // @ts-ignore
                            this.rtcController.client.getParameter('getChannelInfo');
                            return [4 /*yield*/, this.signalController.accept(__assign(__assign({}, params), { nertcJoinRoomQueryParamMap: nertcJoinRoomQueryParamMap }))];
                        case 1:
                            channelInfo = _d.sent();
                            uid = (_c = (_b = channelInfo.members.find(function (item) { return item.accid === _this._currentUserInfo.accId; })) === null || _b === void 0 ? void 0 : _b.uid) !== null && _c !== void 0 ? _c : '';
                            res = {
                                callId: channelInfo.attachExt.callId,
                                uid: uid,
                            };
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 拒绝呼叫，包含主叫取消，被叫拒绝（reason: 3，主叫接受到繁忙），通话中挂断。
         * @param params.callId 呼叫id
         * @param params.reason 拒绝原因
         * @param params.enableOffline 是否接收离线消息
         */
        NECall.prototype.hangup = function (params) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'hangup', params);
                            if (!(this.signalController.callStatus === 1)) return [3 /*break*/, 2];
                            return [4 /*yield*/, this.signalController.cancel(params)];
                        case 1:
                            _c.sent();
                            _c.label = 2;
                        case 2:
                            if (!(this.signalController.callStatus === 2)) return [3 /*break*/, 4];
                            return [4 /*yield*/, this.signalController.reject(params)];
                        case 3:
                            _c.sent();
                            _c.label = 4;
                        case 4:
                            if (!(this.signalController.callStatus === 3)) return [3 /*break*/, 6];
                            return [4 /*yield*/, this.signalController.hangup(params)];
                        case 5:
                            _c.sent();
                            _c.label = 6;
                        case 6:
                            // 埋点数据
                            (_b = this._eventTracking) === null || _b === void 0 ? void 0 : _b.track('userAction', {
                                event_type: 'hangup',
                                callId: this.costTimeEventTracking.callId,
                                isCaller: this.costTimeEventTracking.isCaller,
                                userAccId: this.costTimeEventTracking.userAccId,
                                uid: this._currentUserInfo.uid,
                            });
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 切换呼叫类型
         * @param params.callId 呼叫id
         * @param params.callType 呼叫类型
         * @param params.state  1: 邀请； 2：同意； 3：拒绝
         */
        NECall.prototype.switchCallType = function (params) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var needConfirm;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'switchCallType', params);
                            if (!(params.state === 1)) return [3 /*break*/, 2];
                            needConfirm = (params.callType === '1' && this._enableSwitchCallTypeConfirm.audio) ||
                                (params.callType === '2' && this._enableSwitchCallTypeConfirm.video);
                            if (!!needConfirm) return [3 /*break*/, 2];
                            this.emit('onSwtichCallType', {
                                callId: params.callId || this._callId,
                                callType: params.callType,
                                state: 2,
                            });
                            return [4 /*yield*/, this.signalController.control({
                                    callId: params.callId,
                                    ext: {
                                        cid: 2,
                                        type: Number(params.callType),
                                    },
                                })];
                        case 1:
                            _b.sent();
                            this._switchRTCCallType(params.callType);
                            _b.label = 2;
                        case 2:
                            if (params.state === 2) {
                                this.emit('onSwtichCallType', {
                                    callId: params.callId || this._callId,
                                    callType: params.callType,
                                    state: 2,
                                });
                                this._switchRTCCallType(params.callType);
                            }
                            return [4 /*yield*/, this.signalController.control({
                                    callId: params.callId,
                                    ext: {
                                        cid: 3,
                                        type: Number(params.callType),
                                        state: params.state,
                                    },
                                })];
                        case 3:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 设置本地视图
         * @param view 视图dom
         */
        NECall.prototype.setLocalView = function (view) {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'setLocalView', view);
            this.rtcController.setLocalView(view);
        };
        /**
         * 设置远端视图
         * @param view 视图dom
         * @param uid 远端用户accId
         */
        NECall.prototype.setRemoteView = function (view, accId) {
            var _a;
            var _b;
            // 日志
            (_b = this._logger) === null || _b === void 0 ? void 0 : _b.log(TAG_NAME, 'setRemoteView', view, accId);
            this._remoteViews = (_a = {}, _a[accId] = view, _a);
            var rtcUid = this.getUidByAccId(accId);
            rtcUid && this.rtcController.setRemoteView(view, rtcUid);
        };
        /**
         * 开关本地视频
         * @param enabled true: 开启； false: 关闭
         */
        NECall.prototype.enableLocalVideo = function (enabled) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'enableLocalVideo', enabled);
                            if (!enabled) return [3 /*break*/, 3];
                            return [4 /*yield*/, this.rtcController.enableLocalVideo(enabled)];
                        case 1:
                            _b.sent();
                            return [4 /*yield*/, this.rtcController.muteLocalVideo(!enabled)];
                        case 2:
                            _b.sent();
                            return [3 /*break*/, 6];
                        case 3: return [4 /*yield*/, this.rtcController.muteLocalVideo(!enabled)];
                        case 4:
                            _b.sent();
                            return [4 /*yield*/, this.rtcController.enableLocalVideo(enabled)];
                        case 5:
                            _b.sent();
                            _b.label = 6;
                        case 6: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 开关本地音频
         * @param enabled true: 开启； false: 关闭
         */
        NECall.prototype.enableLocalAudio = function (enabled) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'enableLocalAudio', enabled);
                            return [4 /*yield*/, this.rtcController.muteLocalAudio(!enabled)];
                        case 1:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 设置切换音视频的确认开关
         * @param params.audio true: 需要； false: 不需要
         * @param params.video true: 需要； false: 不需要
         */
        NECall.prototype.setEnableSwitchCallTypeConfirm = function (params) {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'setEnableSwitchCallTypeConfirm', params);
            var _b = params.video, video = _b === void 0 ? this._enableSwitchCallTypeConfirm.video : _b, _c = params.audio, audio = _c === void 0 ? this._enableSwitchCallTypeConfirm.audio : _c;
            this._enableSwitchCallTypeConfirm = { video: video, audio: audio };
        };
        /**
         * 设置提前加入RTC房间
         * @param enabled true: 开启； false: 关闭
         */
        NECall.prototype.setEnableJoinRTCChannelWhenCall = function (enabled) {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'setEnableJoinRTCChannelWhenCall', enabled);
            this._enableJoinRTCChannelWhenCall = enabled;
        };
        /**
         * 设置超时时间
         * @param params.callTimeout 超时取消，单位：毫秒
         * @param params.rejectTimeout 超时挂断时间，单位：毫秒
         */
        NECall.prototype.setTimeout = function (params) {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'setTimeout', params);
            params.callTimeout &&
                (this.signalController.callTimeout = params.callTimeout);
            params.rejectTimeout &&
                (this.signalController.rejectTimeout = params.rejectTimeout);
        };
        /**
         * 根据accId获取rtc uid
         * @param accId 用户 im 的 accId
         */
        NECall.prototype.getUidByAccId = function (accId) {
            var _a, _b;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'getUidByAccId', accId);
            return (_b = this._userArr.find(function (item) { return item.accId === accId; })) === null || _b === void 0 ? void 0 : _b.uid;
        };
        /**
         * 初始并播放本地视频
         * @param view 视图dom
         */
        NECall.prototype.initAndPlayLocalSteam = function (view) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            // 日志
                            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'initAndPlayLocalSteam', view);
                            return [4 /*yield*/, this.rtcController.initLocalStream({
                                    uid: this._currentUserInfo.uid,
                                    audio: true,
                                    video: this._callType === '2',
                                    screen: false,
                                })];
                        case 1:
                            _b.sent();
                            return [4 /*yield*/, this.rtcController.playLocalStream(view)];
                        case 2:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 重连，im 重连成功后调用
         */
        NECall.prototype.reconnect = function () {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'reconnect');
            // 获取离线消息
            this.signalController.reconnect();
        };
        /**
         * 销毁
         */
        NECall.prototype.destroy = function () {
            var _a;
            // 日志
            (_a = this._logger) === null || _a === void 0 ? void 0 : _a.log(TAG_NAME, 'destroy');
            this.rtcController.destroy();
            this.signalController.destroy();
        };
        NECall.prototype._switchRTCCallType = function (callType) {
            this._callType = callType;
            if (this.rtcController.localStream) {
                var hasVideo = this.rtcController.localStream.hasVideo();
                var hasAudio = this.rtcController.localStream.hasAudio();
                if ((callType === '2') !== hasVideo) {
                    this.enableLocalVideo(callType === '2');
                }
                !hasAudio && this.enableLocalAudio(true);
            }
        };
        NECall.prototype._rtcJoin = function (channelInfo) {
            var _a, _b;
            return __awaiter(this, void 0, void 0, function () {
                var remoteMembers, rtcChannelName;
                var _this = this;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            // 这里处理异常
                            this._unusualTimer = setTimeout(function () {
                                _this._handleCallEnd({ callId: _this._callId, reason: 8 });
                            }, this._unusualTimeout);
                            remoteMembers = channelInfo.members.filter(function (item) { return item.accid !== _this._currentUserInfo.accId; });
                            remoteMembers.forEach(function (member) {
                                var _a;
                                var view = (_a = _this._remoteViews) === null || _a === void 0 ? void 0 : _a[member.accid];
                                if (view) {
                                    _this.rtcController.setRemoteView(view, member.uid);
                                }
                            });
                            rtcChannelName = channelInfo.attachExt.channelName;
                            // 埋点
                            this.costTimeEventTracking.rtcJoin = Date.now();
                            return [4 /*yield*/, this.rtcController.joinRTCChannel({
                                    channelName: rtcChannelName,
                                    uid: this._currentUserInfo.uid,
                                    token: this._nertcToken,
                                    // @ts-ignore
                                    getChanneInfoResponse: channelInfo.nertcJoinRoomResponse,
                                }, function (tokenTime) {
                                    // 埋点
                                    _this.costTimeEventTracking.token = tokenTime;
                                })
                                // 埋点
                            ];
                        case 1:
                            _c.sent();
                            // 埋点
                            (_a = this._eventTracking) === null || _a === void 0 ? void 0 : _a.track('userAction', {
                                event_type: 'joinRtcResult',
                                callId: this.costTimeEventTracking.callId,
                                isCaller: this.costTimeEventTracking.isCaller,
                                userAccId: this.costTimeEventTracking.userAccId,
                                uid: this._currentUserInfo.uid,
                                cid: (_b = this.rtcController.client.getChannelInfo()) === null || _b === void 0 ? void 0 : _b.cid,
                            });
                            this.costTimeEventTracking.rtcJoin =
                                Date.now() - this.costTimeEventTracking.rtcJoin;
                            this.costTimeEventTracking.userAction =
                                Date.now() - this.costTimeEventTracking.userAction;
                            this.costTimeEventTracking.rtcVideo = Date.now();
                            return [4 /*yield*/, this.initAndPlayLocalSteam()];
                        case 2:
                            _c.sent();
                            return [4 /*yield*/, this.rtcController.publishLocalStream()];
                        case 3:
                            _c.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        NECall.prototype._handleClose = function () {
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4 /*yield*/, this.rtcController.leaveRTCChannel()];
                        case 1:
                            _a.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        NECall.prototype._handleCallEnd = function (callEndInfo) {
            this._unusualTimer && clearTimeout(this._unusualTimer);
            this._unusualTimer = undefined;
            this.signalController.callStatus === 3 && this.signalController.hangup();
            this._handleClose();
            this.emit('onCallEnd', callEndInfo);
        };
        NECall.prototype._syncCurrentUserInfoBySignalControllerMembers = function (members) {
            var _this = this;
            var member = members.find(function (member) { return member.accid === _this._currentUserInfo.accId; });
            if (member) {
                this._currentUserInfo.uid = member.uid;
            }
        };
        NECall.prototype._bindSignalControllerHooks = function () {
            var _this = this;
            this.signalController.on('afterSignalCallEx', function (value) { return __awaiter(_this, void 0, void 0, function () {
                var rtcChannelName;
                var _this = this;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            this._nertcToken = value.nertcToken;
                            this._syncCurrentUserInfoBySignalControllerMembers(value.members);
                            if (!this._enableJoinRTCChannelWhenCall) return [3 /*break*/, 2];
                            rtcChannelName = value.attachExt.channelName;
                            // 埋点
                            this.costTimeEventTracking.rtcJoin = Date.now();
                            return [4 /*yield*/, this.rtcController.joinRTCChannel({
                                    channelName: rtcChannelName,
                                    uid: this._currentUserInfo.uid,
                                    token: this._nertcToken,
                                    // @ts-ignore
                                    getChanneInfoResponse: value.nertcJoinRoomResponse,
                                }, function (tokenTime) {
                                    // 埋点
                                    _this.costTimeEventTracking.token = tokenTime;
                                })];
                        case 1:
                            _a.sent();
                            _a.label = 2;
                        case 2: return [2 /*return*/];
                    }
                });
            }); });
            this.signalController.on('afterSignalAccept', function (value) { return __awaiter(_this, void 0, void 0, function () {
                var _a;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            this._syncCurrentUserInfoBySignalControllerMembers(value.members);
                            this._nertcToken = value.nertcToken;
                            this._userArr = value.members.map(function (item) { return ({
                                accId: item.accid,
                                uid: item.uid,
                            }); });
                            // 埋点
                            (_a = this._eventTracking) === null || _a === void 0 ? void 0 : _a.track('userAction', {
                                event_type: 'acceptSuccess',
                                callId: this.costTimeEventTracking.callId,
                                isCaller: this.costTimeEventTracking.isCaller,
                                userAccId: this.costTimeEventTracking.userAccId,
                                uid: this._currentUserInfo.uid,
                            });
                            return [4 /*yield*/, this._rtcJoin(value)];
                        case 1:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            }); });
            this.signalController.on('afterSignalCancel', function (value) {
                _this._handleCallEnd({
                    callId: _this._callId,
                    reason: value.reason,
                    exReason: 0,
                });
            });
            this.signalController.on('afterSignalReject', function (value) {
                _this._handleCallEnd({
                    callId: _this._callId,
                    reason: value.reason,
                    exReason: 2,
                });
            });
            this.signalController.on('afterSignalHangup', function () {
                _this._handleCallEnd({ callId: _this._callId, reason: 0, exReason: 4 });
            });
            this.signalController.on('afterMessageSend', function (value) { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this.emit('onMessageSent', value);
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalReject', function (value) { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this._handleCallEnd({
                        callId: this._callId,
                        reason: value.reason,
                        exReason: 3,
                    });
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalAccept', function (value) { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            // 埋点
                            this.costTimeEventTracking.userAction = Date.now();
                            this.costTimeEventTracking.wait =
                                Date.now() - this.costTimeEventTracking.wait;
                            this._userArr = value.members.map(function (item) { return ({
                                accId: item.accid,
                                uid: item.uid,
                            }); });
                            return [4 /*yield*/, this._rtcJoin(value)];
                        case 1:
                            _a.sent();
                            return [2 /*return*/];
                    }
                });
            }); });
            this.signalController.on('whenSignalCancel', function (value) { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this._handleCallEnd({
                        callId: value.callId,
                        reason: 0,
                        exReason: 1,
                    });
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalInvite', function (value) { return __awaiter(_this, void 0, void 0, function () {
                var callerInfo, inviterInfo;
                var _a, _b, _c;
                return __generator(this, function (_d) {
                    // 埋点
                    this.costTimeEventTracking.needPush = true;
                    this.costTimeEventTracking.isCaller = false;
                    this.costTimeEventTracking.signalTimestamp = Date.now();
                    this.costTimeEventTracking.wait = Date.now();
                    this.costTimeEventTracking.callId = value.attachExt.callId;
                    this._callType = value.type;
                    this._syncCurrentUserInfoBySignalControllerMembers(value.members);
                    callerInfo = {
                        accId: value.callerId,
                        uid: (_a = value.members.find(function (item) { return item.accid === value.callerId; })) === null || _a === void 0 ? void 0 : _a.uid,
                    };
                    inviterInfo = {
                        callId: value.attachExt.callId,
                        callerInfo: callerInfo,
                        calleeInfo: this._currentUserInfo,
                        callType: value.type,
                        exraInfo: value.attachExt.extraInfo || ((_b = value.attachExt) === null || _b === void 0 ? void 0 : _b._attachment),
                    };
                    this._callId = inviterInfo.callId;
                    this.emit('onReceiveInvited', inviterInfo);
                    // 埋点
                    (_c = this._eventTracking) === null || _c === void 0 ? void 0 : _c.track('userAction', {
                        event_type: 'receiveInvite',
                        callId: this.costTimeEventTracking.callId,
                        isCaller: this.costTimeEventTracking.isCaller,
                        userAccId: this.costTimeEventTracking.userAccId,
                        uid: this._currentUserInfo.uid,
                    });
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalControl', function (value) { return __awaiter(_this, void 0, void 0, function () {
                var state, callType, needConfirm;
                var _a;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            if (!((value.cid === 3 || value.cid === 2) && value.type)) return [3 /*break*/, 4];
                            state = (_a = value.state) !== null && _a !== void 0 ? _a : 1;
                            callType = String(value.type);
                            if (callType === this._callType) {
                                return [2 /*return*/];
                            }
                            if (!(state === 1)) return [3 /*break*/, 3];
                            needConfirm = (callType === '1' && this._enableSwitchCallTypeConfirm.audio) ||
                                (callType === '2' && this._enableSwitchCallTypeConfirm.video);
                            if (!needConfirm) return [3 /*break*/, 1];
                            this.emit('onSwtichCallType', {
                                callId: this._callId,
                                callType: callType,
                                state: 1,
                            });
                            return [3 /*break*/, 3];
                        case 1:
                            this.emit('onSwtichCallType', {
                                callId: this._callId,
                                callType: callType,
                                state: 2,
                            });
                            this._switchRTCCallType(callType);
                            return [4 /*yield*/, this.signalController.control({
                                    callId: this._callId,
                                    ext: {
                                        cid: 3,
                                        type: Number(callType),
                                        state: 2,
                                    },
                                })];
                        case 2:
                            _b.sent();
                            _b.label = 3;
                        case 3:
                            if (state === 2) {
                                this.emit('onSwtichCallType', {
                                    callId: this._callId,
                                    callType: callType,
                                    state: 2,
                                });
                                this._switchRTCCallType(callType);
                            }
                            if (state === 3) {
                                this.emit('onSwtichCallType', {
                                    callId: this._callId,
                                    callType: callType,
                                    state: 3,
                                });
                            }
                            _b.label = 4;
                        case 4: return [2 /*return*/];
                    }
                });
            }); });
            this.signalController.on('whenSignalRoomClose', function () { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this._handleCallEnd({ callId: this._callId, reason: 0, exReason: 5 });
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalAcceptOtherClient', function () { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this._handleCallEnd({ callId: this._callId, reason: 9 });
                    return [2 /*return*/];
                });
            }); });
            this.signalController.on('whenSignalRejectOtherClient', function () { return __awaiter(_this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    this._handleCallEnd({ callId: this._callId, reason: 10 });
                    return [2 /*return*/];
                });
            }); });
        };
        NECall.prototype._handleRtcEvents = function () {
            var _this = this;
            this.rtcController.on('streamSubscribed', function (stream) {
                var _a, _b;
                _this.rtcController.playRemoteStream(stream);
                // 埋点
                _this.costTimeEventTracking.rtcVideo =
                    Date.now() - _this.costTimeEventTracking.rtcVideo;
                _this.costTimeEventTracking.rtcAudio = _this.costTimeEventTracking.rtcVideo;
                if (_this.costTimeEventTracking.needPush) {
                    var data = {
                        callId: _this.costTimeEventTracking.callId,
                        isCaller: _this.costTimeEventTracking.isCaller,
                        token: _this.costTimeEventTracking.token,
                        wait: _this.costTimeEventTracking.wait,
                        rtcJoin: _this.costTimeEventTracking.rtcJoin,
                        rtcVideo: _this.costTimeEventTracking.rtcVideo,
                        userAction: _this.costTimeEventTracking.userAction,
                        userAccId: _this.costTimeEventTracking.userAccId,
                        rtcAudio: _this.costTimeEventTracking.rtcAudio,
                        signalTimestamp: _this.costTimeEventTracking.signalTimestamp,
                        rtcCid: _this.rtcController.getChannelInfo().cid,
                        rtcUid: String(_this._currentUserInfo.uid),
                    };
                    if (_this.costTimeEventTracking.isCaller) {
                        data = __assign(__assign({}, data), { call: {
                                create: _this.signalController.costTime.create,
                                join: _this.signalController.costTime.join,
                                invite: _this.signalController.costTime.invite,
                                cost: _this.signalController.costTime.cost,
                            } });
                    }
                    else {
                        data = __assign(__assign({}, data), { accept: _this.signalController.costTime.accept });
                    }
                    (_a = _this._eventTracking) === null || _a === void 0 ? void 0 : _a.track('costTime', data);
                    _this.costTimeEventTracking.needPush = false;
                    // 日志
                    (_b = _this._logger) === null || _b === void 0 ? void 0 : _b.info('costTime', data);
                }
            });
            this.rtcController.on('peerOnline', function (stream) {
                _this._unusualTimer && clearTimeout(_this._unusualTimer);
                _this._unusualTimer = undefined;
                _this.emit('onCallConnected');
            });
            this.rtcController.on('peerLeave', function () {
                if (_this._unusualTimer)
                    return;
                _this._unusualTimer = setTimeout(function () {
                    _this._handleCallEnd({ callId: _this._callId, reason: 0 });
                }, _this._unusualTimeout);
            });
            this.rtcController.on('error', function () {
                if (_this._unusualTimer)
                    return;
                _this._unusualTimer = setTimeout(function () {
                    _this._handleCallEnd({ callId: _this._callId, reason: 11 });
                }, _this._unusualTimeout);
            });
        };
        return NECall;
    }(eventemitter3));

    var HttpRequestProxy;
    (function (HttpRequestProxy) {
        HttpRequestProxy["GET"] = "1";
        HttpRequestProxy["POST"] = "2";
        HttpRequestProxy["PUT"] = "3";
        HttpRequestProxy["DELETE"] = "4";
    })(HttpRequestProxy || (HttpRequestProxy = {}));
    var NEGroupCall = /** @class */ (function (_super) {
        __extends(NEGroupCall, _super);
        function NEGroupCall(param) {
            var _this = this;
            var nim = param.nim, currentUserInfo = param.currentUserInfo, appKey = param.appKey, rtcConfig = param.rtcConfig, debug = param.debug;
            _this = _super.call(this) || this;
            _this.callStatus = 0; // 0: 未呼叫 1: 被呼叫 2: 已接听
            _this._rtcViews = {}; // a
            _this._members = [];
            var kitName = 'NEGroupCall';
            var kitVersion = pkg.version;
            _this._log = debug
                ? c({ appName: kitName, version: kitVersion, level: 'trace' }).log
                : function () { return void 0; };
            _this.rtcController = new RTCController({
                appKey: appKey,
                kitName: kitName,
                kitVersion: kitVersion,
                debug: debug,
                rtcConfig: rtcConfig,
            });
            _this._baseUrl = "/scene/groupCall/".concat(appKey, "/call/");
            _this._nim = nim;
            _this._currentUserInfo = currentUserInfo;
            _this._handleRtcEvents();
            return _this;
        }
        /**
         * 用于接收im自定义消息
         * @param msg im onmsg 事件参数
         */
        NEGroupCall.prototype.receiveNimMsg = function (msg) {
            var _this = this;
            var data = JSON.parse(msg);
            this._log('receiveNimMsg', data);
            if (data.isFromCallKitServer) {
                if (this.callStatus !== 0 && data.callId !== this._callId) {
                    if (data.type === 1) {
                        this._busyReject({ callId: data.callId });
                    }
                }
                else {
                    if (data.type === 1) {
                        this._log('onReceiveInvited', data);
                        this._rejectTimer = setTimeout(function () {
                            _this._resetState();
                            _this.emit('onCallEnd');
                        }, 1000 * data.timeout);
                        this.callStatus = 1;
                        this._callId = data.callId;
                        // data.members = await this._queryMembers()
                        this._queryMembers().then(function (members) {
                            data.members = members;
                            _this._members = data.members;
                            _this.emit('onReceiveInvited', data);
                        });
                    }
                    else if (data.type === 2) {
                        this._log('onMembersChange', data);
                        var member = data.members.find(function (member) { return member.imAccid === _this._currentUserInfo.accId; });
                        if (member &&
                            ((this.callStatus === 1 &&
                                (member.state === 3 || member.state === 2)) ||
                                (this.callStatus === 2 && member.state === 3))) {
                            this._resetState();
                            this.emit('onCallEnd');
                        }
                        this._updateMembers(data.members);
                        this.emit('onMembersChange', this._members);
                    }
                    else if (data.type === 3) {
                        this.rtcController.leaveRTCChannel();
                        this._resetState();
                        this.emit('onCallEnd');
                    }
                }
                return true;
            }
            else {
                return false;
            }
        };
        /**
         * 发起群组呼叫
         * @param opt
         * @returns
         */
        NEGroupCall.prototype.groupCall = function (opt) {
            return __awaiter(this, void 0, void 0, function () {
                var url, res, _a;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            url = this._baseUrl;
                            if (opt.callId) {
                                url += opt.callId;
                            }
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.PUT, opt)];
                        case 1:
                            res = _b.sent();
                            this.callStatus = 2;
                            this._currentUserInfo.uid = res.callerUid;
                            this._rtcChannelName = res.rtcChannelName;
                            this._callId = res.callId;
                            _a = res;
                            return [4 /*yield*/, this._queryMembers()];
                        case 2:
                            _a.members = _b.sent();
                            this._members = res.members;
                            this.emit('onMembersChange', this._members);
                            this._log('groupCall success', res);
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 接收群组呼叫
         */
        NEGroupCall.prototype.groupAccept = function () {
            return __awaiter(this, void 0, void 0, function () {
                var url, res, member;
                var _this = this;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            url = this._baseUrl +
                                this._callId +
                                '/member/' +
                                this._currentUserInfo.accId +
                                '/state/' +
                                'accept';
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.POST, {})];
                        case 1:
                            res = _a.sent();
                            this.callStatus = 2;
                            res.members = this._sortMembers(res.members);
                            this._members = res.members;
                            this._rtcChannelName = res.rtcChannelName;
                            this._callId = res.callId;
                            member = res.members.find(function (item) { return item.imAccid === _this._currentUserInfo.accId; });
                            if (member) {
                                this._currentUserInfo.uid = member.rtcUid;
                            }
                            this._rejectTimer && clearTimeout(this._rejectTimer);
                            this._log('groupAccept success', res);
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 挂断群组通话
         */
        NEGroupCall.prototype.groupHangup = function () {
            return __awaiter(this, void 0, void 0, function () {
                var url, res;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            url = this._baseUrl +
                                this._callId +
                                '/member/' +
                                this._currentUserInfo.accId +
                                '/state/';
                            switch (this.callStatus) {
                                case 1:
                                    url += 'reject';
                                    break;
                                case 2:
                                    url += 'leave';
                                    break;
                            }
                            if (this.callStatus === 2) {
                                this.rtcController.leaveRTCChannel();
                            }
                            this._resetState();
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.POST, {})];
                        case 1:
                            res = _a.sent();
                            this._log('groupHangup success', res);
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 邀请参加群组呼叫
         */
        NEGroupCall.prototype.groupInvite = function (opt) {
            return __awaiter(this, void 0, void 0, function () {
                var url, _a;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            url = this._baseUrl + this._callId + '/member/invite';
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.POST, opt)];
                        case 1:
                            _b.sent();
                            _a = this;
                            return [4 /*yield*/, this._queryMembers()];
                        case 2:
                            _a._members = _b.sent();
                            this.emit('onMembersChange', this._members);
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 加入群组通话
         * @param params.callId 群组呼叫id
         * @param params.rtcUid 加入群组通话的用户uid
         */
        NEGroupCall.prototype.groupJoin = function (params) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var url, res, _b;
                var _this = this;
                return __generator(this, function (_c) {
                    switch (_c.label) {
                        case 0:
                            url = this._baseUrl + params.callId + '/member/join';
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.POST, params)];
                        case 1:
                            res = _c.sent();
                            this._currentUserInfo.uid = (_a = res.members.find(function (item) { return item.imAccid === _this._currentUserInfo.accId; })) === null || _a === void 0 ? void 0 : _a.rtcUid;
                            this._callId = params.callId;
                            this.callStatus = 2;
                            this._rtcChannelName = res.rtcChannelName;
                            _b = this;
                            return [4 /*yield*/, this._queryMembers()];
                        case 2:
                            _b._members = _c.sent();
                            this.emit('onMembersChange', this._members);
                            this._log('groupJoin', res);
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 查询通话信息
         * @param params.callId 通话id
         */
        NEGroupCall.prototype.groupQueryCallInfo = function (params) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var url, res;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            url = this._baseUrl + ((_a = params === null || params === void 0 ? void 0 : params.callId) !== null && _a !== void 0 ? _a : this._callId);
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.GET)];
                        case 1:
                            res = _b.sent();
                            this._log('groupQueryCallInfo', res);
                            return [2 /*return*/, res];
                    }
                });
            });
        };
        /**
         * 开关本地视频
         * @param enabled true开启，false关闭
         */
        NEGroupCall.prototype.enableLocalVideo = function (enabled) {
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            if (!enabled) return [3 /*break*/, 2];
                            return [4 /*yield*/, this.rtcController.enableLocalVideo(enabled)];
                        case 1:
                            _a.sent();
                            return [3 /*break*/, 5];
                        case 2: return [4 /*yield*/, this.rtcController.muteLocalVideo(!enabled)];
                        case 3:
                            _a.sent();
                            return [4 /*yield*/, this.rtcController.enableLocalVideo(enabled)];
                        case 4:
                            _a.sent();
                            _a.label = 5;
                        case 5: return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 开关本地音频
         * @param enabled true开启，false关闭
         */
        NEGroupCall.prototype.enableLocalAudio = function (enabled) {
            return __awaiter(this, void 0, void 0, function () {
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0: return [4 /*yield*/, this.rtcController.enableLocalAudio(enabled)];
                        case 1:
                            _a.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 设置用户视图
         * @param view 视频渲染容器
         * @param accId im id
         */
        NEGroupCall.prototype.setRtcView = function (view, accId) {
            var _a;
            // 更新用户视图
            if (this._rtcViews[accId] && view !== this._rtcViews[accId]) {
                var uid_1 = (_a = this._members.find(function (item) { return item.imAccid === accId; })) === null || _a === void 0 ? void 0 : _a.rtcUid;
                var stream = this.rtcController.remoteStreams.find(function (stream) { return stream.getId() === uid_1; });
                if (uid_1 && stream) {
                    this.rtcController.setRemoteView(view, uid_1);
                    this.rtcController.playRemoteStream(stream);
                }
            }
            this._rtcViews[accId] = view;
        };
        /**
         * 本端加入rtc房间，需要
         * @param opt video: 加入时是否开启视频
         */
        NEGroupCall.prototype.jionRtc = function (opt) {
            var _a;
            return __awaiter(this, void 0, void 0, function () {
                var localView;
                return __generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            if (!this._rtcChannelName) {
                                throw new Error('rtcChannelName is empty');
                            }
                            return [4 /*yield*/, this.rtcController.joinRTCChannel({
                                    channelName: this._rtcChannelName,
                                    uid: this._currentUserInfo.uid,
                                })];
                        case 1:
                            _b.sent();
                            localView = this._rtcViews[this._currentUserInfo.accId];
                            this.rtcController.setLocalView(localView);
                            return [4 /*yield*/, this.rtcController.initLocalStream({
                                    uid: this._currentUserInfo.uid,
                                    audio: true,
                                    video: (_a = opt === null || opt === void 0 ? void 0 : opt.video) !== null && _a !== void 0 ? _a : false,
                                    screen: false,
                                })];
                        case 2:
                            _b.sent();
                            return [4 /*yield*/, this.rtcController.playLocalStream()];
                        case 3:
                            _b.sent();
                            return [4 /*yield*/, this.rtcController.publishLocalStream()];
                        case 4:
                            _b.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        /**
         * 销毁实例
         */
        NEGroupCall.prototype.destroy = function () {
            this.rtcController.destroy();
            this._resetState();
        };
        NEGroupCall.prototype._resetState = function () {
            this.callStatus = 0;
            this._callId = undefined;
            this._rtcChannelName = undefined;
            this._rtcViews = {};
            this._members = [];
            this._rejectTimer && clearTimeout(this._rejectTimer);
        };
        NEGroupCall.prototype._busyReject = function (opt) {
            return __awaiter(this, void 0, void 0, function () {
                var url;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            url = this._baseUrl +
                                opt.callId +
                                '/member/' +
                                this._currentUserInfo.accId +
                                '/state/reject';
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.POST, { reason: 'busy' })];
                        case 1:
                            _a.sent();
                            return [2 /*return*/];
                    }
                });
            });
        };
        NEGroupCall.prototype._queryMembers = function () {
            return __awaiter(this, void 0, void 0, function () {
                var url, res;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            url = this._baseUrl + this._callId + '/members';
                            return [4 /*yield*/, this._nimHttpRequestProxy(url, HttpRequestProxy.GET)];
                        case 1:
                            res = _a.sent();
                            res.members = this._sortMembers(res.members);
                            return [2 /*return*/, res.members];
                    }
                });
            });
        };
        NEGroupCall.prototype._updateMembers = function (members) {
            var _this = this;
            members.forEach(function (member) {
                var index = _this._members.findIndex(function (item) { return item.imAccid === member.imAccid; });
                if (index !== -1) {
                    _this._members[index] = member;
                }
                else {
                    _this._members.push(member);
                }
            });
        };
        // 把自己放到第一位
        NEGroupCall.prototype._sortMembers = function (members) {
            var accId = this._currentUserInfo.accId;
            var index = members.findIndex(function (item) { return item.imAccid === accId; });
            if (index !== -1) {
                return members.splice(index, 1).concat(members);
            }
            return members;
        };
        NEGroupCall.prototype._handleRtcEvents = function () {
            var _this = this;
            this.rtcController.on('streamSubscribed', function (stream) {
                var _a;
                var uid = stream.getId();
                if (uid) {
                    var accId = (_a = _this._members.find(function (item) { return item.rtcUid === uid; })) === null || _a === void 0 ? void 0 : _a.imAccid;
                    if (accId) {
                        var view = _this._rtcViews[accId];
                        _this.rtcController.setRemoteView(view, uid);
                        _this.rtcController.playRemoteStream(stream);
                    }
                    else {
                        // 这里可能存在rtc通知到了，成员变更没到的情况，所以需要查询一下
                        _this._queryMembers().then(function (res) {
                            var _a;
                            _this._members = res;
                            var accId = (_a = _this._members.find(function (item) { return item.rtcUid === uid; })) === null || _a === void 0 ? void 0 : _a.imAccid;
                            if (accId) {
                                var view = _this._rtcViews[accId];
                                _this.rtcController.setRemoteView(view, uid);
                                _this.rtcController.playRemoteStream(stream);
                            }
                        });
                    }
                }
            });
            this.rtcController.on('error', function () {
                _this.rtcController.leaveRTCChannel();
                _this._resetState();
                _this.emit('onCallEnd');
            });
        };
        NEGroupCall.prototype._nimHttpRequestProxy = function (url, method, data) {
            var _this = this;
            this._log('nimHttpRequestProxy', url, data);
            return new Promise(function (resolve, reject) {
                _this._nim.httpRequestProxy({
                    header: JSON.stringify({
                        groupCallVer: '1.6.0',
                        user: _this._currentUserInfo.accId,
                    }),
                    method: method,
                    path: url,
                    body: data && JSON.stringify(data),
                    done: function (error, data) {
                        if (error) {
                            reject(error);
                        }
                        else {
                            try {
                                var res = JSON.parse(data.body);
                                if (res.code === 0) {
                                    resolve(res.data);
                                }
                                else {
                                    reject(res);
                                }
                            }
                            catch (error) {
                                reject(error);
                            }
                        }
                    },
                });
            });
        };
        return NEGroupCall;
    }(eventemitter3));

    exports.NECall = NECall;
    exports.NEGroupCall = NEGroupCall;

    Object.defineProperty(exports, '__esModule', { value: true });

}));
