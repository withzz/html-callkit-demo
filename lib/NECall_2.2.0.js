!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NECallSDK={})}(this,(function(exports){"use strict";var extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},extendStatics(e,t)};function __extends(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var __assign=function(){return __assign=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},__assign.apply(this,arguments)};function __decorate(e,t,i,r){var s,a=arguments.length,n=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(n=(a<3?s(n):a>3?s(t,i,n):s(t,i))||n);return a>3&&n&&Object.defineProperty(t,i,n),n}function __awaiter(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{d(r.next(e))}catch(e){a(e)}}function o(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}d((r=r.apply(e,t||[])).next())}))}function __generator(e,t){var i,r,s,a,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(d){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(n=0)),n;)try{if(i=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,r=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(s=n.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){n.label=o[1];break}if(6===o[0]&&n.label<s[1]){n.label=s[1],s=o;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(o);break}s[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],r=0}finally{i=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,d])}}}function __values(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function __read(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,s,a=i.call(e),n=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)n.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(i=a.return)&&i.call(a)}finally{if(s)throw s.error}}return n}function __spreadArray(e,t,i){if(i||2===arguments.length)for(var r,s=0,a=t.length;s<a;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var NERTC=createCommonjsModule((function(module,exports){var t;window,t=function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=209)}([function(e,t){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=i)},function(e,t,i){var r=i(32)("wks"),s=i(23),a=i(0).Symbol,n="function"==typeof a;(e.exports=function(e){return r[e]||(r[e]=n&&a[e]||(n?a:s)("Symbol."+e))}).store=r},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getParameters=void 0;const r=i(74);let s={tracks:{audio:[],video:[]},shimVideoOrientation:"never",shimCanvas:"ios151",clients:[],localStreams:[],debugG2:!1,passEnvCheck:!1,enableAlerter:"never",videoLowMaxWidth:320,videoLowMaxHeight:180,videoLowFramerate:15,videoLowCheckCanvasBlank:"ios",screenLowMaxWidth:320,screenLowMaxHeight:180,screenLowFramerate:15,controlOnPaused:!0,hideControlOnResume:!0,maxTransportRebuildCnt:Number.MAX_SAFE_INTEGER,logLevel:r.loglevels.INFO,forceLogLevel:-1,forceLogUpload:"default",forceGeofenceArea:"NONE",forceListenDeviceChange:!0,codecOptions:{audio:{opusStereo:!0,opusDtx:!0}},videoHighStartBitrate:1e3,videoHighMinBitrate:0,videoLowStartBitrate:500,videoLowMinBitrate:0,screenHighStartBitrate:2e3,screenHighMinBitrate:0,screenLowStartBitrate:500,screenLowMinBitrate:0,screenFocus:"no-focus-change",screenSurfaceSwitching:"default",screenDisplaySurface:"default",screenPreferCurrentTab:!1,screenSelfBrowserSurface:"default",allowEmptyMedia:!0,keepLocalstreamOnLeave:!1,joinFirstTimeout:2e3,joinMaxRetry:3,reconnectionFirstTimeout:2e3,reconnectionMaxRetry:3,signalProbeEnabled:!0,leaveOnUnload:!0,trustOnOnline:!0,trustOnOffline:!1,trustUnhandledrejection:!1,h264Wait:1e3,encoderWatermarkLimit:1,encoderWatermarkFontFamily:"Verdana",forceEncodedInsertableStreams:!1,forceCustomEncryptionOff:!1,h264StrictHigh:!1,disableH264Send:!1,disableVP8Send:!1,enableTcpCandidate:!0,enableUdpCandidate:!0,maxEventLoopLagWarning:3,enableCompatAudio:!1,audioInputcompatMode:"auto",fireBackupDelay:5e3,audioAslFlag:!0,keepAspectRatio:!1,disableLBSService:!1,lbsUseBuiltinOnly:!1,protooMessageTimeout:3e4,reuseMid:!0,playMediaTimeout:3e3,playMediaTimeoutForAutoplay:6e3,disableWebAudio:!1,disable2dContext:!1,disableWebGLContext:!1,disableAllReports:!1,reportPageBrowserId:!0,doHeartbeatInterval:1e3,deviceChangeInterval:0,h264ProfileLevel:"42e01f",h264ProfileLevelSignal:"42e01f",enableSdpRrtr:"chrome",forceBWE:"no",forceAGC:"no",forceANS:"no",forceAEC:"no",forceChannelCount:-1,forceLatency:-1,forceSampleRate:-1,revertSubstreamProduceType:!1,moreNotAllowedError:!1,replaceIdealConstraint:"safari16_screen",shimLocalCanvas:"safari",enableVSkip:!0,statsLogMaxCnt:3,showStatsLog:!1,chromeLegacyDefault:"unknown",audioLevelFittingAlgorithm:"log2",audioLevelRatioRemote:1,statsHistoryInterval:3e3,signalingMessageDelay:0,reconnectionWaitTimeout:5e3,activeSpeakerMin:10,audioPlayoutDelayHint:0,videoPlayoutDelayHint:0};try{if(location.search&&"function"==typeof URLSearchParams){const e=new URLSearchParams(location.search);let t;for(t in s){const i=s[t],r=e.get(t);if(r){let e=null;"string"==typeof i?e=r:"boolean"==typeof i?"true"!==r&&"false"!==r||(e="true"===r):"number"==typeof i&&(e=Number(r),Number(r)>Number.MIN_SAFE_INTEGER&&(e=Number(r))),null!==e&&i!==e&&(console.warn(`NERTC 通过URL改变了私有化变量：${t}:`,i,"=>",e),s[t]=e)}}}}catch(e){}t.getParameters=()=>s},function(e,t){var i=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=i)},function(e,t,i){var r=i(7);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,i){var r=i(6),s=i(22);e.exports=i(8)?function(e,t,i){return r.f(e,t,s(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var r=i(4),s=i(42),a=i(29),n=Object.defineProperty;t.f=i(8)?Object.defineProperty:function(e,t,i){if(r(e),t=a(t,!0),r(i),s)try{return n(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(21)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){var r=i(84),s=i(27);e.exports=function(e){return r(s(e))}},function(e,t,i){var r=Object.prototype.hasOwnProperty,s="~";function a(){}function n(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(s=!1)),o.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e,t){var i=s?s+e:e,r=this._events[i];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var a=0,n=r.length,o=new Array(n);a<n;a++)o[a]=r[a].fn;return o},o.prototype.emit=function(e,t,i,r,a,n){var o=s?s+e:e;if(!this._events[o])return!1;var d,c,l=this._events[o],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,r),!0;case 5:return l.fn.call(l.context,t,i,r,a),!0;case 6:return l.fn.call(l.context,t,i,r,a,n),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var h,p=l.length;for(c=0;c<p;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,i);break;case 4:l[c].fn.call(l[c].context,t,i,r);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d)}}return!0},o.prototype.on=function(e,t,i){var r=new n(t,i||this),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},o.prototype.once=function(e,t,i){var r=new n(t,i||this,!0),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},o.prototype.removeListener=function(e,t,i,r){var n=s?s+e:e;if(!this._events[n])return this;if(!t)return 0==--this._eventsCount?this._events=new a:delete this._events[n],this;var o=this._events[n];if(o.fn)o.fn!==t||r&&!o.once||i&&o.context!==i||(0==--this._eventsCount?this._events=new a:delete this._events[n]);else{for(var d=0,c=[],l=o.length;d<l;d++)(o[d].fn!==t||r&&!o[d].once||i&&o[d].context!==i)&&c.push(o[d]);c.length?this._events[n]=1===c.length?c[0]:c:0==--this._eventsCount?this._events=new a:delete this._events[n]}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&(0==--this._eventsCount?this._events=new a:delete this._events[t])):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prototype.setMaxListeners=function(){return this},o.prefixed=s,o.EventEmitter=o,e.exports=o},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.default={PAGE_UNLOAD:3e4,LOGIN_FAILED:30001,MEDIA_CONNECTION_DISCONNECTED:30204,SIGNAL_CONNECTION_DISCONNECTED:30205,CLIENT_BANNED:30206,CHANNEL_CLOSED:30207,UID_DUPLICATE:30209,PERMKEY_TIMEOUT:30902,AUTO_PLAY_NOT_ALLOWED:41030,INVALID_PARAMETER_ERROR:1e4,NOT_SUPPORT_ERROR:10001,NETWORK_ERROR:10002,NETWORK_REQUEST_ERROR:10003,INVALID_OPERATION_ERROR:10008,API_CALL_SEQUENCE_BEFORE_ERROR:10009,API_CALL_SEQUENCE_AFTER_ERROR:10010,LOCALSTREAM_NOT_FOUND_ERROR:10011,UNKNOWN_TYPE_ERROR:10012,LOGIN_REQUEST_ERROR:10017,RECONNECTING:10020,SERVER_UNKNOWN_ERROR:10099,JOIN_FAILED:10100,REPEAT_JOIN_ERROR:10101,USER_NOT_IN_CHANNEL_ERROR:10104,JOIN_PERMKEY_ERROR:10109,JOIN_WITHOUT_CHANNEL_NAME:10110,JOIN_RECORD_TYPE_ERROR:10111,JOIN_UID_TYPE_ERROR:10112,SERVER_AUTH_ERROR:10119,SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR:10121,TASKS_ROLE_ERROR:10131,ADD_TASK_PARAMETER_ERROR:10132,ADD_TASK_FAILED_ERROR:10133,DELETE_TASK_PARAMETER_ERROR:10134,DELETE_TASK_FAILED_ERROR:10135,UPDATE_TASK_PARAMETER_ERROR:10136,UPDATE_TASKS_FAILED_ERROR:10137,STREAM_UID_ERROR:10210,STREAM_PROFILE_ERROR:10211,MEDIA_DEVICE_ERROR:10212,STREAM_PLAY_ARGUMENT_ERROR:10215,STREAM_RENDER_ARGUMENT_ERROR:10216,STREAM_ISPLAYING_ARGUMENT_ERROR:10218,STREAM_OPTN_NO_TYPE_ERROR:10220,REPEAT_OPEN_MIC_ERROR:10221,REPEAT_OPEN_AUDIO_SLAVE_ERROR:10222,REPEAT_OPEN_CAMERA_ERROR:10223,REPEAT_OPEN_SCREEN_ERROR:10224,STREAM_CLOSE_ARGUMENT_ERROR:10228,STREAM_CLOSE_AUDIO_ERROR:10229,STREAM_CLOSE_AUDIO_SLAVE_ERROR:10230,STREAM_CLOSE_CAMERA_ERROR:10231,STREAM_CLOSE_SCREEN_ERROR:10232,STREAM_NOT_SUBSCRIBE_AUDIO:10240,STREAM_NOT_SUBSCRIBE_AUDIO_SLAVE:10241,STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR:10242,STREAM_TAKE_SNAPSHOT_ERROR:10247,STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR:10248,SET_AUDIO_VOLUME_ARGUMENTS_ERROR:10250,SET_AUDIO_VOLUME_ERROR:10251,SET_CAPTURE_VOLUME_ARGUMENTS_ERROR:10252,SET_AUDIO_OUTPUT_ERROR:10253,SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR:10254,SWITCH_DEVICE_REPEAT_ERROR:10255,SWITCH_DEVICE_NO_MIC_ERROR:10256,SWITCH_DEVICE_NO_SUPPORT_AUDIO:10257,SWITCH_DEVICE_NO_CAMERA_ERROR:10258,SWITCH_DEVICE_NO_SUPPORT_VIDEO:10259,STREAM_MUTE_AUDIO_ERROR:10265,STREAM_NOT_MUTE_AUDIO_YET:10266,STREAM_UNMUTE_AUDIO_WITHOUT_STREAM:10267,STREAM_MUTE_AUDIO_SLAVE_ERROR:10270,STREAM_NOT_MUTE_AUDIO_SLAVE_YET:10271,STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM:10272,STREAM_MUTE_VIDEO_ERROR:10275,STREAM_NOT_MUTE_VIDEO_YET:10276,STREAM_UNMUTE_VIDEO_WITHOUT_STREAM:10277,STREAM_MUTE_SCREEN_ERROR:10280,STREAM_NOT_MUTE_SCREEN_YET:10281,STREAM_UNMUTE_SCREEN_WITHOUT_STREAM:10282,PUBLISH_NO_STREAM:10350,PUBLISH_ROLE_ERROR:10351,PUBLISH_SERVER_ERROR:10355,SUBSCRIBE_SERVER_ERROR:10360,WEBGL_NOT_SUPPORT_ERROR:10401,WEBGL_LOSE_CONTEXT_ERROR:10402,WEBGL_RESTORED_FAILD_ERROR:10403,BASIC_BEAUTY_RES_ERROR:10404,ADV_BEAUTY_RES_ERROR:10405,PLUGIN_LOADED_ERROR:10406,PLUGIN_ERROR:10407,PLUGIN_REGISTER_ERROR:10408,PLUGIN_NOT_REGISTER:10409,AUDIO_MIX_NO_AUDIO:10420,AUDIO_MIX_FILE_ERROR:10421,AUDIO_MIX_NO_SUPPORT:10422,AUDIO_MIX_NOT_STATE_ERROR:10423,AUDIO_MIX_NOT_PAUSE:10424,AUDIO_MIX_VOLUME_ERROR:10425,AUDIO_MIX_PLAY_START_TIME_ERROR:10426,AUDIO_EFFECT_NO_SUPPORT:10430,AUDIO_EFFECT_FILE_ERROR:10431,AUDIO_EFFECT_NO_AUDIO:10432,AUDIO_EFFECT_NOT_STATE_ERROR:10433,AUDIO_EFFECT_FILE_LOST_ERROR:10434,AUDIO_EFFECT_NOT_PAUSE:10435,AUDIO_EFFECT_PLAY_ALREADY:10436,AUDIO_EFFECT_ERROR:10437,SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR:10445,UPDATE_PERMKEY_ERROR:10446,RECORDING_NOT_SUPPORT:10450,REPEAT_RECORDING_ERROR:10451,RECORDING_CACHE_ERROR:10452,RECORDING_ERROR:10453,RECORDING_NOT_START_ERROR:10454,WATERMARKS_EXCEEDED_ERROR:10460,LBS_REQUEST_ERROR:10461,LBS_JSON_ERROR:10462,CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR:10471,SET_ENCRYPTION_MODE_ERROR:10472,SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR:10473,ROLE_TYPE_ERROR:10477,GET_SYSTEM_STATS_NOT_SUPPORT_ERROR:10480,SET_CLIENT_ROLE_ERROR:10490,CLIENT_ALREADY_IN_CHANNEL_ERROR:10500}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(i(12));class a extends Error{constructor(e){let t=e.url?e.url:"https://doc.yunxin.163.com/nertc/api-refer/web/typedoc/Latest/zh/html/index.html#errorcode",i=e.advice?` advice: ${e.advice} `:"";super(e.message+` <${function(e){for(let t in s.default)if(s.default[t]===e)return t;return"UNKNOWN"}(e.code)} ${e.code.toString()}> `+i+t),this.code_=e.code||0,this.message_=e.message||null,this.advice_=e.advice||null,this.extraCode_=e.extraCode||null}get code(){return this.code_}get message(){return this.message_}get extraCode(){return this.extraCode_}get advice(){return this.advice_}getCode(){return this.code_}getMessage(){return this.message_}getProposal(){return this.advice_}getExtraCode(){return this.extraCode_}}t.default=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ELECTRON_VERSION=t.IS_ELECTRON=t.IS_UCBROWSER=t.IS_WX=t.IS_LINUX=t.MACOS_VERSION=t.IS_MAC=t.WIN_VERSION=t.IS_WIN=t.IPADQQB_VERSION=t.IS_IPADQQB=t.MACQQB_VERSION=t.IS_MACQQB=t.WQQB_VERSION=t.IS_WQQB=t.MQQB_VERSION=t.IS_MQQB=t.IS_X5MQQB=t.WECHAT_MAJOR_VERSION=t.WECHAT_VERSION=t.IS_WECHAT=t.IE_VERSION=t.IS_IE=t.IS_IE8=t.XWEB_VERSION=t.IS_XWEB=t.TBS_VERSION=t.IS_TBS=t.SOGOU_VERSION=t.IS_SOGOU=t.SOGOUM_VERSION=t.IS_SOGOUM=t.EDG_VERSION=t.EDG_MAJOR_VERSION=t.IS_EDG=t.EDGE_VERSION=t.IS_EDGE=t.FIREFOX_MAJOR_VERSION=t.FIREFOX_VERSION=t.IS_FIREFOX=t.ANDROID_VERSION=t.IS_ANDROID=t.IOS_MAJOR_VERSION=t.IOS_VERSION=t.IS_IOS=t.IS_IPOD=t.IS_IPHONE=t.IS_IPAD=t.USER_LANGUAGE=t.USER_AGENT=void 0,t.IS_EN=t.IS_ZH=t.IS_LOCAL=t.IS_IOS_SAFARI=t.IS_MAC_SAFARI=t.SAFARI_VERSION=t.SAFARI_MAJOR_VERSION=t.IS_ANY_SAFARI=t.IS_SAFARI=t.IOS_FIREFOX_MAJOR_VERSION=t.IOS_FIREFOX_VERSION=t.IS_IOS_FIREFOX=t.IOS_EDGE_MAJOR_VERSION=t.IOS_EDGE_VERSION=t.IS_IOS_EDGE=t.IOS_CHROME_MAJOR_VERSION=t.IOS_CHROME_VERSION=t.IS_IOS_CHROME=t.ANY_CHROME_MAJOR_VERSION=t.CHROME_VERSION=t.CHROME_MAJOR_VERSION=t.IS_CHROME=t.IS_CHROME_ONLY=t.VIVO_VERSION=t.IS_VIVOBROWSER=t.OPPO_VERSION=t.IS_OPPOBROWSER=t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER=t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER=t.MI_VERSION=t.IS_MIBROWSER=void 0,t.USER_AGENT=window.navigator&&window.navigator.userAgent||"",t.USER_LANGUAGE=window.navigator&&window.navigator.language,t.IS_IPAD=/iPad/i.test(t.USER_AGENT),t.IS_IPHONE=/iPhone/i.test(t.USER_AGENT)&&!t.IS_IPAD,t.IS_IPOD=/iPod/i.test(t.USER_AGENT),t.IS_IOS=t.IS_IPHONE||t.IS_IPAD||t.IS_IPOD,t.IOS_VERSION=t.IS_IOS&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IOS_MAJOR_VERSION=t.IOS_VERSION&&function(){const e=t.IOS_VERSION.match(/\d+.?\d/);return e&&e[0]?parseFloat(e[0]):null}(),t.IS_ANDROID=/Android/i.test(t.USER_AGENT),t.ANDROID_VERSION=t.IS_ANDROID&&function(){const e=t.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const i=e[1],r=e[2],s=e[3];return i&&r&&s?i+"."+r+"."+s:i&&r?i+"."+r:i||null}(),t.IS_FIREFOX=/Firefox/i.test(t.USER_AGENT),t.FIREFOX_VERSION=t.IS_FIREFOX&&function(){const e=navigator.userAgent.match(/Firefox\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.FIREFOX_MAJOR_VERSION=t.IS_FIREFOX&&function(){const e=t.USER_AGENT.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_EDGE=/Edge\//i.test(t.USER_AGENT),t.EDGE_VERSION=t.IS_EDGE&&function(){var e=t.USER_AGENT.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_EDG=/Edg\//i.test(t.USER_AGENT),t.EDG_MAJOR_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.EDG_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SOGOUM=/SogouMobileBrowser\//i.test(t.USER_AGENT),t.SOGOUM_VERSION=t.IS_SOGOUM&&function(){const e=t.USER_AGENT.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SOGOU=/MetaSr\s/i.test(t.USER_AGENT),t.SOGOU_VERSION=t.IS_SOGOU&&function(){const e=t.USER_AGENT.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_TBS=/TBS\/\d+/i.test(t.USER_AGENT),t.TBS_VERSION=t.IS_TBS&&function(){var e=t.USER_AGENT.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_XWEB=/XWEB\/\d+/i.test(t.USER_AGENT),t.XWEB_VERSION=t.IS_XWEB&&function(){var e=t.USER_AGENT.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_IE8=/MSIE\s8\.0/.test(t.USER_AGENT),t.IS_IE=/MSIE\/\d+/i.test(t.USER_AGENT),t.IE_VERSION=t.IS_IE&&function(){const e=/MSIE\s(\d+)\.\d/.exec(t.USER_AGENT);let i=e&&parseFloat(e[1]);return!i&&/Trident\/7.0/i.test(t.USER_AGENT)&&/rv:11.0/.test(t.USER_AGENT)&&(i=11),i}(),t.IS_WECHAT=/(micromessenger|webbrowser)/i.test(t.USER_AGENT),t.WECHAT_VERSION=t.IS_WECHAT&&function(){var e=navigator.userAgent.match(/MicroMessenger\/([\d.]+)/);if(e&&e[1])return e[1]}(),t.WECHAT_MAJOR_VERSION=t.IS_WECHAT&&function(){var e=t.USER_AGENT.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return parseFloat(e[1])}(),t.IS_X5MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&/COVC\/\d+/i.test(t.USER_AGENT),t.IS_MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&!/COVC\/\d+/i.test(t.USER_AGENT),t.MQQB_VERSION=(t.IS_MQQB||t.IS_X5MQQB)&&function(){const e=t.USER_AGENT.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WQQB=!t.IS_TBS&&/ QQBrowser\/\d+/i.test(t.USER_AGENT),t.WQQB_VERSION=t.IS_WQQB&&function(){const e=t.USER_AGENT.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MACQQB=!t.IS_TBS&&/QQBrowserLite\/\d+/i.test(t.USER_AGENT),t.MACQQB_VERSION=t.IS_MACQQB&&function(){const e=t.USER_AGENT.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_IPADQQB=!t.IS_TBS&&/MQBHD\/\d+/i.test(t.USER_AGENT),t.IPADQQB_VERSION=t.IS_IPADQQB&&function(){const e=t.USER_AGENT.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WIN=/Windows/i.test(t.USER_AGENT),t.WIN_VERSION=t.IS_WIN&&function(){const e=t.USER_AGENT.match(/Windows NT (\d+)(?:\.(\d+))?(?:\.(\d+))*/i),i=e&&e[1],r=e&&e[2];return i&&r?i+"."+r:i||null}(),t.IS_MAC=!t.IS_IOS&&/MAC OS X/i.test(t.USER_AGENT),t.MACOS_VERSION=t.IS_MAC&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IS_LINUX=!t.IS_ANDROID&&/Linux/i.test(t.USER_AGENT),t.IS_WX=/MicroMessenger/i.test(t.USER_AGENT),t.IS_UCBROWSER=/UCBrowser/i.test(t.USER_AGENT),t.IS_ELECTRON=/Electron/i.test(t.USER_AGENT),t.ELECTRON_VERSION=t.IS_ELECTRON&&function(){const e=t.USER_AGENT.match(/Electron\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MIBROWSER=/MiuiBrowser/i.test(t.USER_AGENT),t.MI_VERSION=t.IS_MIBROWSER&&function(){const e=t.USER_AGENT.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_HUAWEIBROWSER=/HuaweiBrowser/i.test(t.USER_AGENT),t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER&&function(){const e=t.USER_AGENT.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAMSUNGBROWSER=/SamsungBrowser/i.test(t.USER_AGENT),t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER&&function(){const e=t.USER_AGENT.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_OPPOBROWSER=/HeyTapBrowser/i.test(t.USER_AGENT),t.OPPO_VERSION=t.IS_OPPOBROWSER&&function(){const e=t.USER_AGENT.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_VIVOBROWSER=/VivoBrowser/i.test(t.USER_AGENT),t.VIVO_VERSION=t.IS_VIVOBROWSER&&function(){const e=t.USER_AGENT.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_CHROME_ONLY=/Chrome/i.test(t.USER_AGENT),t.IS_CHROME=!t.IS_EDGE&&!t.IS_SOGOU&&!t.IS_SOGOUM&&!t.IS_TBS&&!t.IS_XWEB&&!t.IS_EDG&&!t.IS_WQQB&&!t.IS_MIBROWSER&&!t.IS_HUAWEIBROWSER&&!t.IS_SAMSUNGBROWSER&&!t.IS_OPPOBROWSER&&!t.IS_VIVOBROWSER&&/Chrome/i.test(t.USER_AGENT),t.CHROME_MAJOR_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.CHROME_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.ANY_CHROME_MAJOR_VERSION=function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_CHROME=/CriOS/i.test(t.USER_AGENT),t.IOS_CHROME_VERSION=t.IS_IOS_CHROME&&function(){const e=t.USER_AGENT.match(/CriOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_CHROME_MAJOR_VERSION=t.IS_IOS_CHROME&&function(){const e=t.USER_AGENT.match(/CriOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_EDGE=/EdgiOS/i.test(t.USER_AGENT),t.IOS_EDGE_VERSION=t.IS_IOS_EDGE&&function(){const e=t.USER_AGENT.match(/EdgiOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_EDGE_MAJOR_VERSION=t.IS_IOS_EDGE&&function(){const e=t.USER_AGENT.match(/EdgiOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_IOS_FIREFOX=/FxiOS/i.test(t.USER_AGENT),t.IOS_FIREFOX_VERSION=t.IS_IOS_FIREFOX&&function(){const e=t.USER_AGENT.match(/FxiOS\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IOS_FIREFOX_MAJOR_VERSION=t.IS_IOS_FIREFOX&&function(){const e=t.USER_AGENT.match(/FxiOS\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SAFARI=!t.IS_CHROME_ONLY&&!t.IS_MQQB&&!t.IS_X5MQQB&&!t.IS_MACQQB&&!t.IS_IPADQQB&&/Safari/i.test(t.USER_AGENT),t.IS_ANY_SAFARI=t.IS_SAFARI||t.IS_IOS,t.SAFARI_MAJOR_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.SAFARI_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MAC_SAFARI=t.IS_SAFARI&&t.IS_MAC,t.IS_IOS_SAFARI=t.IS_SAFARI&&t.IS_IOS,t.IS_LOCAL="file:"===window.location.protocol||"localhost"===window.location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname),t.IS_ZH=/zh/i.test(t.USER_LANGUAGE),t.IS_EN=/en/i.test(t.USER_LANGUAGE)},function(e,t){e.exports=!0},function(e,t,i){var r=i(0),s=i(3),a=i(19),n=i(5),o=i(9),d=function(e,t,i){var c,l,u,h=e&d.F,p=e&d.G,m=e&d.S,f=e&d.P,g=e&d.B,v=e&d.W,_=p?s:s[t]||(s[t]={}),y=_.prototype,S=p?r:m?r[t]:(r[t]||{}).prototype;for(c in p&&(i=t),i)(l=!h&&S&&void 0!==S[c])&&o(_,c)||(u=l?S[c]:i[c],_[c]=p&&"function"!=typeof S[c]?i[c]:g&&l?a(u,r):v&&S[c]==u?function(e){var t=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,i)}return new e(t,i,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):f&&"function"==typeof u?a(Function.call,u):u,f&&((_.virtual||(_.virtual={}))[c]=u,e&d.R&&y&&!y[c]&&n(y,c,u)))};d.F=1,d.G=2,d.S=4,d.P=8,d.B=16,d.W=32,d.U=64,d.R=128,e.exports=d},function(e,t){e.exports={}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t,i){var r=i(20);e.exports=function(e,t,i){if(r(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){var i=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++i+r).toString(36))}},function(e,t,i){var r=i(6).f,s=i(9),a=i(1)("toStringTag");e.exports=function(e,t,i){e&&!s(e=i?e:e.prototype,a)&&r(e,a,{configurable:!0,value:t})}},function(e,t,i){var r,s,a=e.exports=i(63),n=i(183);a.codegen=i(273),a.fetch=i(274),a.path=i(275),a.fs=a.inquire("fs"),a.toArray=function(e){if(e){for(var t=Object.keys(e),i=new Array(t.length),r=0;r<t.length;)i[r]=e[t[r++]];return i}return[]},a.toObject=function(e){for(var t={},i=0;i<e.length;){var r=e[i++],s=e[i++];void 0!==s&&(t[r]=s)}return t};var o=/\\/g,d=/"/g;a.isReserved=function(e){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},a.safeProp=function(e){return!/^[$\w_]+$/.test(e)||a.isReserved(e)?'["'+e.replace(o,"\\\\").replace(d,'\\"')+'"]':"."+e},a.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var c=/_([a-z])/g;a.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(c,(function(e,t){return t.toUpperCase()}))},a.compareFieldsById=function(e,t){return e.id-t.id},a.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(a.decorateRoot.remove(e.$type),e.$type.name=t,a.decorateRoot.add(e.$type)),e.$type;r||(r=i(185));var s=new r(t||e.name);return a.decorateRoot.add(s),s.ctor=e,Object.defineProperty(e,"$type",{value:s,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:s,enumerable:!1}),s};var l=0;a.decorateEnum=function(e){if(e.$type)return e.$type;s||(s=i(64));var t=new s("Enum"+l++,e);return a.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},a.setProperty=function(e,t,i){if("object"!=typeof e)throw TypeError("dst must be an object");if(!t)throw TypeError("path must be specified");return function e(t,i,r){var s=i.shift();if(i.length>0)t[s]=e(t[s]||{},i,r);else{var a=t[s];a&&(r=[].concat(a).concat(r)),t[s]=r}return t}(e,t=t.split("."),i)},Object.defineProperty(a,"decorateRoot",{get:function(){return n.decorated||(n.decorated=new(i(193)))}})},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var r=i(7),s=i(0).document,a=r(s)&&r(s.createElement);e.exports=function(e){return a?s.createElement(e):{}}},function(e,t,i){var r=i(7);e.exports=function(e,t){if(!r(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!r(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t,i){var r=i(45),s=i(33);e.exports=Object.keys||function(e){return r(e,s)}},function(e,t,i){var r=i(32)("keys"),s=i(23);e.exports=function(e){return r[e]||(r[e]=s(e))}},function(e,t,i){var r=i(3),s=i(0),a=s["__core-js_shared__"]||(s["__core-js_shared__"]={});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:i(15)?"pure":"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){var r=i(20);function s(e){var t,i;this.promise=new e((function(e,r){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=r})),this.resolve=r(t),this.reject=r(i)}e.exports.f=function(e){return new s(e)}},function(e,t,i){t.f=i(1)},function(e,t,i){var r=i(0),s=i(3),a=i(15),n=i(35),o=i(6).f;e.exports=function(e){var t=s.Symbol||(s.Symbol=a?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||o(t,e,{value:n.f(e)})}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;const r=i(74),s=i(59),a=i(58),n=i(2),o="mediasoup-client";let d=[];function c(e){let t=window;if(t.logUpload&&!n.getParameters().disableAllReports)if(t.wsTransport)d.length&&(d.forEach((e=>{t.wsTransport&&t.wsTransport.sendLog(e.args)})),d=[]),t.wsTransport&&t.wsTransport.sendLog(e);else{let t=Date.now();try{d.length&&d[d.length-1].args[0].replace("[NERTC","[缓存][NERTC")}catch(e){}d.push({time:t,args:e})}}t.Logger={debug(e,...t){const i=e?`${o}:${e}`:""+o;t=Array.prototype.slice.call(arguments),this.formatArgs("DEBUG",t,i),n.getParameters().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,t),c(t)},warn(e,...t){const i=e?`${o}:${e}`:""+o;t=Array.prototype.slice.call(arguments),this.formatArgs("WARN",t,i),n.getParameters().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,t),c(t)},error(e,...t){const i=e?`${o}:${e}`:""+o;t=Array.prototype.slice.call(arguments),this.formatArgs("ERROR",t,i),n.getParameters().logLevel<=r.loglevels.ERROR&&console.error.apply(console,t),c(t)},formatArgs(e,t,i){let r=new Date,n=this.formatTimeUnit(""+(r.getMonth()+1))+"-"+this.formatTimeUnit(""+r.getDate())+" "+this.formatTimeUnit(""+r.getHours())+":"+this.formatTimeUnit(""+r.getMinutes())+":"+this.formatTimeUnit(""+r.getSeconds())+":"+this.formatTimeUnit(""+r.getMilliseconds(),3),o=`[NERTC:${e}:${a.updateLogIndex()} ${n} ${i.toUpperCase()}]  `;for(let e=t.length-1;e>=0;e--)t[e]=s.formatSingleArg(t[e]);return t.unshift(o),t},formatTimeUnit(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i}}},function(e,t){},function(e,t,i){var r=i(81)(!0);i(41)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,i=this._i;return i>=t.length?{value:void 0,done:!0}:(e=r(t,i),this._i+=e.length,{value:e,done:!1})}))},function(e,t,i){var r=i(15),s=i(16),a=i(43),n=i(5),o=i(17),d=i(82),c=i(24),l=i(87),u=i(1)("iterator"),h=!([].keys&&"next"in[].keys()),p=function(){return this};e.exports=function(e,t,i,m,f,g,v){d(i,t,m);var _,y,S,R=function(e){if(!h&&e in A)return A[e];switch(e){case"keys":case"values":return function(){return new i(this,e)}}return function(){return new i(this,e)}},b=t+" Iterator",E="values"==f,T=!1,A=e.prototype,w=A[u]||A["@@iterator"]||f&&A[f],I=w||R(f),C=f?E?R("entries"):I:void 0,O="Array"==t&&A.entries||w;if(O&&(S=l(O.call(new e)))!==Object.prototype&&S.next&&(c(S,b,!0),r||"function"==typeof S[u]||n(S,u,p)),E&&w&&"values"!==w.name&&(T=!0,I=function(){return w.call(this)}),r&&!v||!h&&!T&&A[u]||n(A,u,I),o[t]=I,o[b]=p,f)if(_={values:E?I:R("values"),keys:g?I:R("keys"),entries:C},v)for(y in _)y in A||a(A,y,_[y]);else s(s.P+s.F*(h||T),t,_);return _}},function(e,t,i){e.exports=!i(8)&&!i(21)((function(){return 7!=Object.defineProperty(i(28)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){e.exports=i(5)},function(e,t,i){var r=i(4),s=i(83),a=i(33),n=i(31)("IE_PROTO"),o=function(){},d=function(){var e,t=i(28)("iframe"),r=a.length;for(t.style.display="none",i(47).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),d=e.F;r--;)delete d.prototype[a[r]];return d()};e.exports=Object.create||function(e,t){var i;return null!==e?(o.prototype=r(e),i=new o,o.prototype=null,i[n]=e):i=d(),void 0===t?i:s(i,t)}},function(e,t,i){var r=i(9),s=i(10),a=i(85)(!1),n=i(31)("IE_PROTO");e.exports=function(e,t){var i,o=s(e),d=0,c=[];for(i in o)i!=n&&r(o,i)&&c.push(i);for(;t.length>d;)r(o,i=t[d++])&&(~a(c,i)||c.push(i));return c}},function(e,t,i){var r=i(26),s=Math.min;e.exports=function(e){return e>0?s(r(e),9007199254740991):0}},function(e,t,i){var r=i(0).document;e.exports=r&&r.documentElement},function(e,t,i){var r=i(27);e.exports=function(e){return Object(r(e))}},function(e,t,i){i(88);for(var r=i(0),s=i(5),a=i(17),n=i(1)("toStringTag"),o="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),d=0;d<o.length;d++){var c=o[d],l=r[c],u=l&&l.prototype;u&&!u[n]&&s(u,n,c),a[c]=a.Array}},function(e,t,i){var r=i(18),s=i(1)("toStringTag"),a="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),s))?i:a?r(t):"Object"==(n=r(t))&&"function"==typeof t.callee?"Arguments":n}},function(e,t,i){var r=i(4),s=i(20),a=i(1)("species");e.exports=function(e,t){var i,n=r(e).constructor;return void 0===n||null==(i=r(n)[a])?t:s(i)}},function(e,t,i){var r,s,a,n=i(19),o=i(97),d=i(47),c=i(28),l=i(0),u=l.process,h=l.setImmediate,p=l.clearImmediate,m=l.MessageChannel,f=l.Dispatch,g=0,v={},_=function(){var e=+this;if(v.hasOwnProperty(e)){var t=v[e];delete v[e],t()}},y=function(e){_.call(e.data)};h&&p||(h=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return v[++g]=function(){o("function"==typeof e?e:Function(e),t)},r(g),g},p=function(e){delete v[e]},"process"==i(18)(u)?r=function(e){u.nextTick(n(_,e,1))}:f&&f.now?r=function(e){f.now(n(_,e,1))}:m?(a=(s=new m).port2,s.port1.onmessage=y,r=n(a.postMessage,a,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*")},l.addEventListener("message",y,!1)):r="onreadystatechange"in c("script")?function(e){d.appendChild(c("script")).onreadystatechange=function(){d.removeChild(this),_.call(e)}}:function(e){setTimeout(n(_,e,1),0)}),e.exports={set:h,clear:p}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,i){var r=i(4),s=i(7),a=i(34);e.exports=function(e,t){if(r(e),s(t)&&t.constructor===e)return t;var i=a.f(e);return(0,i.resolve)(t),i.promise}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,i){var r=i(45),s=i(33).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,s)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SDK_VERSION=t.roomsTaskUrl=t.lbsUrl=t.TAGS_TO_MAIN_DOMAIN=t.LBS_REGION_CONFIG=t.getCloudProxyInfoUrl=t.getChannelInfoUrl=t.ENV=t.ENGINE_VERSION=t.createChannelUrl=t.checkSumUrl=t.BUILD=void 0,t.SDK_VERSION="5.5.10",t.ENGINE_VERSION="5.5.10",t.BUILD="v5.5.10-0-g10b9fe1c";const r=i(211);Object.defineProperty(t,"ENV",{enumerable:!0,get:function(){return r.ENV}}),Object.defineProperty(t,"LBS_REGION_CONFIG",{enumerable:!0,get:function(){return r.LBS_REGION_CONFIG}}),Object.defineProperty(t,"TAGS_TO_MAIN_DOMAIN",{enumerable:!0,get:function(){return r.TAGS_TO_MAIN_DOMAIN}});const s=r.Config.checkSumUrl;t.checkSumUrl=s;const a=r.Config.createChannelUrl;t.createChannelUrl=a;const n=r.Config.getChannelInfoUrl;t.getChannelInfoUrl=n;const o=r.Config.roomsTaskUrl;t.roomsTaskUrl=o;const d=r.Config.getCloudProxyInfoUrl;t.getCloudProxyInfoUrl=d;const c=r.Config.lbsUrl;t.lbsUrl=c},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getDefaultLogger=t.Logger=t.updateLogIndex=void 0;const r=i(2),s=i(74),a=i(212),n=i(120),o=i(59),d=i(57);let c=0,l=[];function u(){return c++,(""+c).padStart(4,"0")}t.updateLogIndex=u;class h{constructor(e){this.style="color:#1cb977;",this.options=e,this.api="log",this.tagGen=e.tagGen,e.isSavedLogs&&(this.logHelper=new a.logHelper(e)),this.supportedBrowsers=["Chrome","Safari","Firefox","Chrome Mobile","Electron"],this.cs=console}getChild(e){const t=Object.assign({},this.options),i=new h(t);return i.tagGen=e,i.parent=this,i}debug(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("DEBUG",[].slice.call(arguments,0));r.getParameters().logLevel<=s.loglevels.DEBUG&&this._log("debug",e),f(e)}log(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("LOG",[].slice.call(arguments,0));if(-1!==this.supportedBrowsers.indexOf(n.getBrowserInfo().browserName)&&"string"==typeof e[0]){e[0]="%c"+e[0],e.splice(1,0,this.style);for(let t=2;t<e.length&&"string"==typeof e[t];t++)e[0]+="%c"+e[t],e[t]=""}r.getParameters().logLevel<=s.loglevels.INFO&&this._log("log",e),f(e)}info(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("INFO",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(n.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.INFO&&this._log("info",e),f(e)}warn(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("WARN",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(n.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.WARNING&&this._log("warn",e),f(e)}error(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("ERROR",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(n.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.ERROR&&this._log("error",e),f(e)}_log(e,t){let i=this.options.logFunc,r=null;if(i&&(i[e]&&(r=i[e]),"function"==typeof r))r.apply(i,t);else if(this.cs[e])try{this.cs[e].apply?this.chrome(e,t):this.ie(e,t)}catch(e){}}chrome(e,t){n.getBrowserInfo().browserName,this.cs[e]?this.cs[e].apply(this.cs,t):this.cs.log?this.cs.log.apply(this.cs,t):this.ie(e,t)}ie(e,t){var i=this;t.forEach((function(t){i.cs[e](JSON.stringify(t,null,4))}))}formatArgs(e,t){var i=new Date,r=m(""+(i.getMonth()+1))+"-"+m(""+i.getDate())+" "+m(""+i.getHours())+":"+m(""+i.getMinutes())+":"+m(""+i.getSeconds())+":"+m(""+i.getMilliseconds(),3);let s=this,a="";for(let e=0;e<3&&(s.tagGen&&(a=`[${s.tagGen()}]`+a),s.parent);e++)s=s.parent;return a=`[NERTC:${e}:${u()} ${r}]${a}`,t.splice(0,0,a),t.forEach((function(e,i){e=o.formatSingleArg(e),t[i]="object"==typeof e?function e(t,i=[]){if(!(t=o.formatSingleArg(t))||"object"!=typeof t)return t;let r={};for(let s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||(t[s]&&"object"==typeof t[s]?-1!==i.indexOf(t[s])?r[s]="[Circular obj]":(i.push(t[s]),r[s]=e(t[s],i)):r[s]=t[s]);return r}(e):e})),t}}t.Logger=h;let p=null;t.getDefaultLogger=function(){return p||(p=new h({tagGen:()=>""+d.BUILD})),p};var m=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i};function f(e){let t=window;if(t.logUpload&&!r.getParameters().disableAllReports)if(t.wsTransport)l.length&&(l.forEach((e=>{t.wsTransport&&t.wsTransport.sendLog(e.args)})),l=[]),t.wsTransport&&t.wsTransport.sendLog(e);else{let t=Date.now();try{l.length&&l[l.length-1].args[0].replace("[NERTC","[缓存][NERTC")}catch(e){}l.push({time:t,args:e})}}},function(e,t,i){function r(e,t=1,i=1){return e<=1?i:r(e-1,i,t+i)}function s(e){if(window.RTCRtpSender&&e instanceof RTCRtpSender)return`[RTCRtpSender track: ${s(e.track)}]`;if(e instanceof MediaStreamTrack){const t=e;return`[MediaStreamTrack kind:${t.kind} label:${t.label} readyState:${t.readyState} id: ${t.id} enabled:${t.enabled} muted: ${t.muted}]`}if(e instanceof HTMLElement){const t=e;return`[${t.tagName}.${t.className} ${t.clientWidth}x${t.clientHeight}]`}if(e instanceof MediaStream){const t=e;return`[MediaStream active:${t.active} a:${t.getAudioTracks().length} v:${t.getVideoTracks().length}]`}return window.DOMException&&e instanceof DOMException?`[Error name:${e.name} code:${e.code} message:${e.message}]`:e}Object.defineProperty(t,"__esModule",{value:!0}),t.getDomInfo=t.makePrintable=t.formatSingleArg=t.deepCopy=t.randomString=t.randomId=t.generateUUID=t.getReconnectionTimeout=t.fibonacci=void 0,t.fibonacci=r,t.getReconnectionTimeout=function(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*r(t)},t.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},t.randomId=function(){return"xxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},t.randomString=(e,t)=>{if(!e||!t)return"";let i="";for(var r=t;r>0;--r)i+=e[Math.floor(Math.random()*e.length)];return i},t.deepCopy=function e(t){var i=Array.isArray(t)?[]:{};for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&null!==t[r]?i[r]=e(t[r]):i[r]=t[r]);return i},t.formatSingleArg=s,t.makePrintable=function e(t,i,r=[]){if("object"!=typeof t||!(null==t?void 0:t.hasOwnProperty))return t;var a=Array.isArray(t)?[]:{};for(var n in t)if(t.hasOwnProperty(n)){const o=s(t[n]);o&&("client"===n&&o.adapterRef||["adapterRef","sdkRef","logger","_events"].indexOf(n)>-1||(o&&"object"==typeof o?r.indexOf(o)>-1?a[n]="[Circular obj]":(r.push(a[n]),i>=1?a[n]=e(o,i-1,r):(null==o?void 0:o.toString)?a[n]=o.toString():a[n]=typeof o):a[n]=o))}return a},t.getDomInfo=function(e){if(!e)return""+e;let t=e.tagName;return e.id&&(t+="#"+e.id),e.className&&(t+="."+e.className),(e.offsetWidth||e.offsetHeight)&&(t+=` ${e.offsetWidth}x${e.offsetHeight}`),t}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.reduceCodecs=t.getSupportedCodecs=t.getCurrentProfileLevel=t.VideoCodecList=void 0;const n=i(2),o=i(14),d=i(58),c=a(i(14));function l(e){const t={video:[],audio:[]};return e.match(/ H264/i)&&t.video.push("H264"),e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ opus/i)&&t.audio.push("OPUS"),t}function u(e,t,i){const r={video:[],audio:[]};if(t&&t.codecs&&t.codecs.length)for(let i=0;i<t.codecs.length;i++){const s=t.codecs[i];"video/H264"==s.mimeType&&-1===r.video.indexOf("H264")&&("recv"===e&&s.sdpFmtpLine&&s.sdpFmtpLine.indexOf("profile-level-id")>-1?n.getParameters().h264StrictHigh?s.sdpFmtpLine.indexOf("profile-level-id=64")>-1&&r.video.push("H264"):r.video.push("H264"):-1===r.video.indexOf("H264")&&r.video.push("H264")),"video/VP8"==s.mimeType&&-1===r.video.indexOf("VP8")&&r.video.push("VP8")}if(i&&i.codecs&&i.codecs.length)for(let e=0;e<i.codecs.length;e++)"audio/opus"==i.codecs[e].mimeType&&r.audio.push("OPUS");return r}function h(e){if("undefined"!=typeof RTCRtpSender&&"function"==typeof RTCRtpSender.getCapabilities){const t=RTCRtpSender.getCapabilities("video");if(t)for(let i in t.codecs){const r=t.codecs[i];if("video/H264"===r.mimeType&&r.sdpFmtpLine&&r.sdpFmtpLine.indexOf(e)>-1)return!0}}return!1}t.VideoCodecList=["H264","VP8"],t.getSupportedCodecs=async function(e="recv",t=RTCPeerConnection){if("recv"===e){if(c.ANY_CHROME_MAJOR_VERSION&&c.ANY_CHROME_MAJOR_VERSION>=58&&c.ANY_CHROME_MAJOR_VERSION<69){const e=new t({}),i=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return e.close(),!!i.sdp&&l(i.sdp)}if("undefined"!=typeof RTCRtpReceiver&&RTCRtpReceiver.getCapabilities)return u(e,RTCRtpReceiver.getCapabilities("video"),RTCRtpReceiver.getCapabilities("audio"));{const e=new t({});e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const i=await e.createOffer({});return e.close(),!!i.sdp&&l(i.sdp)}}if("undefined"!=typeof RTCRtpSender&&RTCRtpSender.getCapabilities)return u(e,RTCRtpSender.getCapabilities("video"),RTCRtpSender.getCapabilities("audio"));{const e=new t({}),i=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});return e.close(),!!i.sdp&&l(i.sdp)}};let p="";t.getCurrentProfileLevel=function(){return p},t.reduceCodecs=function(e,i){const r=[];let s="";for(let a=0;a<e.length;a++){if(e[a].mimeType&&i&&t.VideoCodecList.indexOf(e[a].mimeType.split("/")[1])>-1&&e[a].mimeType!==i.mimeType){a++;continue}const c=e[a];c.mimeType&&0===c.mimeType.indexOf("video")&&("video/H264"===c.mimeType&&n.getParameters().h264ProfileLevel&&(95===o.CHROME_MAJOR_VERSION?d.getDefaultLogger().warn("当前浏览器版本无法修改H264 Profile Level："+n.getParameters().h264ProfileLevel):c.parameters["profile-level-id"]&&h(n.getParameters().h264ProfileLevel)&&(c.parameters["profile-level-id"]=n.getParameters().h264ProfileLevel)),s||(s=`${c.mimeType}/${c.parameters["profile-level-id"]}`)),r.push(e[a])}return s&&(p=s),r}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.generateRandomNumber=t.clone=void 0,t.clone=function(e,t={}){return void 0===e?t:JSON.parse(JSON.stringify(e))},t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){(function(e){var r=t;function s(e,t,i){for(var r=Object.keys(t),s=0;s<r.length;++s)void 0!==e[r[s]]&&i||(e[r[s]]=t[r[s]]);return e}function a(e){function t(e,i){if(!(this instanceof t))return new t(e,i);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&s(this,i)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}r.asPromise=i(180),r.base64=i(264),r.EventEmitter=i(265),r.float=i(266),r.inquire=i(181),r.utf8=i(267),r.pool=i(268),r.LongBits=i(269),r.isNode=Boolean(void 0!==e&&e&&e.process&&e.process.versions&&e.process.versions.node),r.global=r.isNode&&e||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},r.isString=function(e){return"string"==typeof e||e instanceof String},r.isObject=function(e){return e&&"object"==typeof e},r.isset=r.isSet=function(e,t){var i=e[t];return!(null==i||!e.hasOwnProperty(t))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},r.Buffer=function(){try{var e=r.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(e){return"number"==typeof e?r.Buffer?r._Buffer_allocUnsafe(e):new r.Array(e):r.Buffer?r._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(e){return e?r.LongBits.from(e).toHash():r.LongBits.zeroHash},r.longFromHash=function(e,t){var i=r.LongBits.fromHash(e);return r.Long?r.Long.fromBits(i.lo,i.hi,t):i.toNumber(Boolean(t))},r.merge=s,r.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},r.newError=a,r.ProtocolError=a("ProtocolError"),r.oneOfGetter=function(e){for(var t={},i=0;i<e.length;++i)t[e[i]]=1;return function(){for(var e=Object.keys(this),i=e.length-1;i>-1;--i)if(1===t[e[i]]&&void 0!==this[e[i]]&&null!==this[e[i]])return e[i]}},r.oneOfSetter=function(e){return function(t){for(var i=0;i<e.length;++i)e[i]!==t&&delete this[e[i]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var e=r.Buffer;e?(r._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,i){return new e(t,i)},r._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):r._Buffer_from=r._Buffer_allocUnsafe=null}}).call(this,i(62))},function(e,t,i){e.exports=n;var r=i(125);((n.prototype=Object.create(r.prototype)).constructor=n).className="Enum";var s=i(132),a=i(25);function n(e,t,i,s,a){if(r.call(this,e,i),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=s,this.comments=a||{},this.reserved=void 0,t)for(var n=Object.keys(t),o=0;o<n.length;++o)"number"==typeof t[n[o]]&&(this.valuesById[this.values[n[o]]=t[n[o]]]=n[o])}n.fromJSON=function(e,t){var i=new n(e,t.values,t.options,t.comment,t.comments);return i.reserved=t.reserved,i},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},n.prototype.add=function(e,t,i){if(!a.isString(e))throw TypeError("name must be a string");if(!a.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=i||null,this},n.prototype.remove=function(e){if(!a.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},n.prototype.isReservedId=function(e){return s.isReservedId(this.reserved,e)},n.prototype.isReservedName=function(e){return s.isReservedName(this.reserved,e)}},function(e,t,i){e.exports=i(77)},function(e,t,i){t.__esModule=!0;var r,s=(r=i(79))&&r.__esModule?r:{default:r};t.default=function(e){return function(){var t=e.apply(this,arguments);return new s.default((function(e,i){return function r(a,n){try{var o=t[a](n),d=o.value}catch(e){return void i(e)}if(!o.done)return s.default.resolve(d).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(d)}("next")}))}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebAudio=t.getAudioLevelDestination=t.getAudioContext=t.tryResumeAudioContext=void 0;const s=i(11),a=i(165),n=r(i(12)),o=r(i(13)),d=i(166),c=i(2),l=d.RtcSupport.checkWebAudio();let u;class h{constructor(e){this.id=e.id,this.label=e.label,this.audioNode=e.audioNode,this.gainNode=e.context.createGain(),this.type=e.type,this.audioNode.connect(this.gainNode)}connect(e){this.gainNode.connect(e)}disconnect(){try{this.audioNode.disconnect(this.gainNode)}catch(e){}this.gainNode.disconnect()}}function p(){return u?"suspended"===u.state&&(u.resume().catch((e=>{})),!0):null}function m(){return u?(p(),u):c.getParameters().disableWebAudio?null:l.WebAudio&&l.MediaStream?(u=new window.AudioContext,u):null}t.tryResumeAudioContext=p,t.getAudioContext=m;let f=null;t.getAudioLevelDestination=function(){if(!f){const e=m();e&&(f=e.createMediaStreamDestination())}return f};class g extends s.EventEmitter{constructor(e){super();const{logger:t,isAnalyze:i=!1,isRemote:r=!1}=e;this.support=l.WebAudio&&l.MediaStream,this.gain=1,this.logger=t,this.audioInArr=[],this.isAnalyze=i,this.isRemote=r||!1,this.instant=0,this.slow=0,this.clip=0,this.mediaHelper=e.mediaHelper,this.mixAudioConf={state:a.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.context=m(),this.context?(this.destination=this.createDestination(),this.musicDestination=this.createDestination(),this.analyzeDestination=this.createDestination()):(this.destination=null,this.musicDestination=null,this.analyzeDestination=null),this.support&&(this.resetMixConf(),this.init())}createDestination(){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"===e.name)return this.context.createMediaStreamDestination();throw e}}createSource(e){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioSourceNode(this.context,e)}catch(t){if("TypeError"===t.name)return this.context.createMediaStreamSource(e.mediaStream);throw t}}init(){this.isAnalyze&&this.initMonitor(),this.initWebAudio(),this.initAudioIn()}initMonitor(){var e=this;this.context?(this.script=this.context.createScriptProcessor(0,1,1)).onaudioprocess=function(t){var i,r=t.inputBuffer.getChannelData(0),s=0,a=0;for(i=0;i<r.length;++i)s+=Math.abs(r[i]),Math.abs(r[i])>.99&&(a+=1);e.instant=Math.sqrt(s/r.length),e.slow=.95*e.slow+.05*e.instant,e.clip=a/r.length;let n=t.inputBuffer,o=t.outputBuffer;o.copyToChannel&&o.copyToChannel(n.getChannelData(0),0,0)}:e.logger.error("initMonitor:参数不够")}initWebAudio(){this.context&&this.destination?(this.gainFilter=this.context.createGain(),this.gainFilter.gain.value=this.gain):this.logger.error("initMonitor:参数不够")}initAudioIn(){var e,t,i;const r=this;if(!r.context||!r.gainFilter||!r.destination)return this.logger.error("initAudioIn:参数不够"),null;let s=(null===(t=null===(e=this.mediaHelper.audio.stageAIProcessing)||void 0===e?void 0:e.node)||void 0===t?void 0:t.audioNode)||null,n=null===(i=this.mediaHelper.audio.stageAIProcessing)||void 0===i?void 0:i.enabled;if(s)if(n)s.connect(r.gainFilter);else try{s.disconnect(r.gainFilter)}catch(e){}for(var o=0;o<r.audioInArr.length;o++){const t=r.audioInArr[o];if(s)if(n){try{t.gainNode.disconnect(r.gainFilter)}catch(e){}t.connect(s)}else{try{t.gainNode.disconnect(s)}catch(e){}t.connect(r.gainFilter)}else"MIX_PLAYING"===this.mixAudioConf.state&&this.mixAudioConf.replace?this.logger.log("当前正在以Replace模式播放伴音，暂不接入"):t.connect(r.gainFilter)}r.mixAudioConf.state===a.AuidoMixingState.UNSTART&&(r.script&&r.analyzeDestination&&(r.gainFilter.connect(r.script),r.script.connect(r.analyzeDestination)),r.gainFilter.connect(r.destination)),this.logger.log("WebAudio: initAudioIn: 初始化音频 state: ",r.context.state),"running"!==r.context.state&&r.context.resume().then((()=>{this.context&&this.logger.log("WebAudio: addMs: 状态变更成功 state: ",this.context.state)})).catch((e=>{this.logger.log("WebAudio: addMs: 状态变更出错: ",e.name,e.message,e),this.context&&this.context.resume()}))}updateTracks(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];e.find((e=>e.track&&i&&e.track.id===i.id))||(this.logger.log("updateTracks，删除",i.label,i.id),this.audioInArr.splice(t,1),i.disconnect())}for(let t=e.length-1;t>=0;t--){const i=e[t];if(!this.audioInArr.find((e=>i.track&&i.track.id===e.id))&&i.track)if(this.context){const e=new MediaStream;e.addTrack(i.track);const t={context:this.context,id:i.track.id,label:i.track.label,audioNode:this.createSource({mediaStream:e}),type:i.type},r=new h(t);r.gainNode.gain.value=this.gain,this.audioInArr.push(r)}else this.logger.error("updateTracks：没有audioContext")}this.initAudioIn()}removeTrack(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];i.id===e.id&&(this.logger.log("removeTrack，删除track",e.id,e.label),this.audioInArr.splice(t,1),i.disconnect())}}setGain(e,t){for(let i=0;i<this.audioInArr.length;i++){const r=this.audioInArr[i];t&&t!==r.type||(this.logger.log("WebAudio.setGain",t,e,r.type,r.label,r.id),r.gainNode.gain.value=e)}t||(this.gain=e)}getGain(){if(this.gainFilter)return this.gain}getGainMin(){let e=1;for(let t=0;t<this.audioInArr.length;t++){const i=this.audioInArr[t];i.gainNode.gain.value<e&&(e=i.gainNode.gain.value)}return e}stop(){this.gainFilter&&(this.script?this.script.disconnect(0):this.gainFilter.disconnect(0),this.instant=0)}start(){this.gainFilter&&this.destination&&(this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination))}resetMixConf(){var e,t;if(null===(e=this.mixAudioConf.audioSource)||void 0===e||e.disconnect(0),null===(t=this.mixAudioConf.gainFilter)||void 0===t||t.disconnect(0),this.mixAudioConf.replace&&(this.logger.log("伴音停止了，恢复mic"),this.gainFilter&&this.destination)){for(var i=0;i<this.audioInArr.length;i++)this.audioInArr[i].gainNode.connect(this.gainFilter);this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination)}this.mixAudioConf={state:a.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.gainFilter&&1===this.gainFilter.gain.value&&this.emit("audioFilePlaybackCompleted")}startMix(e){if(!this.context||!this.destination||!this.gainFilter)return this.logger.error("startMix: 不支持伴音"),Promise.reject(new o.default({code:n.default.AUDIO_MIX_NO_SUPPORT,message:"startMix:不支持伴音"}));if(this.logger.log("开始混音: ",JSON.stringify(e)),this.mixAudioConf.audioSource=this.context.createBufferSource(),this.mixAudioConf.gainFilter=this.context.createGain(),this.mixAudioConf.audioSource.buffer=e.buffer,this.mixAudioConf.replace=e.replace,this.mixAudioConf.cycle=e.cycle,this.mixAudioConf.playStartTime=e.playStartTime,this.mixAudioConf.volume=e.volume?e.volume/255:1,this.mixAudioConf.auidoMixingEnd=e.auidoMixingEnd,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.gainFilter.connect(this.gainFilter),this.musicDestination&&this.mixAudioConf.gainFilter.connect(this.musicDestination),e.replace)for(var t=0;t<this.audioInArr.length;t++){const e=this.audioInArr[t];try{e.gainNode.disconnect(this.gainFilter),this.logger.log(`已断开音频：【${e.label}】`)}catch(t){"InvalidAccessError"===t.name?this.logger.log(`音频断开前未连接：【${e.label}】`):this.logger.error(`无法断开音频:【${e.label}】${t.name}`,t.message)}}if(this.mixAudioConf.audioSource.onended=e=>{this.audioEnd(e)},this.mixAudioConf.totalTime=e.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.gain.value=this.mixAudioConf.volume,e.loopback&&e.cycle>1){this.mixAudioConf.audioSource.loop=e.loopback;const t=e.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",t),this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime,t-1)}else e.loopback&&1==e.cycle?(this.mixAudioConf.audioSource.loop=!1,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",e.loopback),this.mixAudioConf.audioSource.loop=e.loopback,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state=a.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now(),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter)return void this.logger.error("pauseAudioMixing: 缺失audioSource/gainFilter");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state=a.AuidoMixingState.PAUSED;let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(e){return this.logger.log("恢复混音"),this.mixAudioConf.pauseTime=0,e.volume=255*this.mixAudioConf.volume,this.startMix(e)}stopAudioMixing(e=!0){return this.mixAudioConf.audioSource&&this.mixAudioConf.gainFilter?(this.logger.log("开始停止混音, isFinished: ",e),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.state=a.AuidoMixingState.STOPED,e&&this.resetMixConf(),this.logger.log("混音已停止"),Promise.resolve()):Promise.reject(new o.default({code:n.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"}))}audioEnd(e){if(this.mixAudioConf.state===a.AuidoMixingState.PLAYED){if(!(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.loop&&this.mixAudioConf.cycle<=0))return this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),Promise.resolve();this.logger.log("无限循环时, 伴音播放完成event: ",e)}else this.logger.error("audioEnd:参数不够")}setAudioMixingVolume(e){if(this.mixAudioConf.gainFilter)return this.mixAudioConf.gainFilter.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.gain.value,Promise.resolve();this.logger.error("setAudioMixingVolume: 参数缺失gainFilter")}setAudioMixingPlayTime(e){return this.mixAudioConf.state===a.AuidoMixingState.PLAYED&&(this.mixAudioConf.setPlayStartTime=e.playStartTime),e.volume=255*this.mixAudioConf.volume,this.startMix(e)}getAudioMixingPlayedTime(){let e=Date.now();this.mixAudioConf.state==a.AuidoMixingState.PAUSED&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}createAudioBufferSource(e){if(!this.context||!this.destination||!this.gainFilter)throw new o.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_createAudioBufferSource: 接口调用状态异常"});const t=this.context.createBufferSource();t.buffer=e;const i=this.context.createGain();return t.connect(i),{sourceNode:t,gainNode:i}}startAudioEffectMix(e){if(!this.context||!this.destination||!this.gainFilter)return Promise.reject(new o.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:d,cycle:c}=e;i&&t&&(this.logger.log("startAudioEffectMix: ",JSON.stringify(e)),i.connect(this.gainFilter),this.musicDestination&&i.connect(this.musicDestination),i.gain.value=d/100,c>1?(t.loop=!0,t.start(0,s,r)):(t.loop=!1,t.start(0,s)),this.mixAudioConf.state=a.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now())}stopAudioEffectMix(e){const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:a,cycle:d}=e;if(!i||!t)return Promise.reject(new o.default({code:n.default.AUDIO_EFFECT_NO_SUPPORT,message:"webAudio_startAudioEffectMix: 接口调用状态异常"}));this.logger.log("stopAudioEffectMix: ",JSON.stringify(e)),t.onended=null,t.disconnect(0),i.disconnect(0),t.stop()}destroy(){this.logger.log("AudioContext 清除"),this.instant=0,this.slow=0,this.clip=0,this.gainFilter&&this.gainFilter.disconnect(0),this.script&&this.script.disconnect(0);for(let e=0;e<this.audioInArr.length;e++)this.audioInArr[e]&&this.audioInArr[e].disconnect();this.audioInArr=[]}getVolumeData(){return this.instant.toFixed(2)}}t.WebAudio=g},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformType=t.PlatformTypeMap=t.MediaTypeList=t.MediaTypeListVideo=t.MediaTypeListAudio=void 0,t.MediaTypeListAudio=["audio","audioSlave"],t.MediaTypeListVideo=["video","screen"],t.MediaTypeList=["audio","video","screen","audioSlave"],t.PlatformTypeMap={"-1":"unknown",1:"aos",2:"ios",4:"pc",8:"winphone",9:"mac",16:"web"},function(e){e[e.unknown=-1]="unknown",e[e.aos=1]="aos",e[e.ios=2]="ios",e[e.pc=4]="pc",e[e.winphone=8]="winphone",e[e.mac=9]="mac",e[e.web=16]="web"}(t.PlatformType||(t.PlatformType={}))},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isNumber=t.isExistOptions=t.checkValidEnum=t.checkValidObject=t.checkValidString=t.checkValidInteger=t.checkValidFloat=t.checkValidBoolean=t.checkExists=t.isValidInteger=void 0;const o=n(i(12)),d=n(i(13)),c=a(i(14)),l=e=>Number.isInteger(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值 "+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值 "+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是整数",enMsg:"Parameter is not Number"};t.isValidInteger=l,t.checkValidInteger=e=>{const t=l(e);if(!t.result){let i=c.IS_ZH?`checkValidInteger: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidInteger: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.checkValidBoolean=e=>{const t=(e=>"boolean"!=typeof e.value?{result:!1,enMsg:"The parameter is not Boolean",zhMsg:"参数不是布尔类型"}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidBoolean: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidBoolean: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.checkValidString=e=>{const t=(e=>"string"!=typeof e.value?{result:!1,zhMsg:"参数不是字符串",enMsg:"The parameter is not String"}:"number"==typeof e.min&&e.value.length<e.min?{result:!1,zhMsg:"参数长度最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value.length>e.max?{result:!1,zhMsg:"参数长度大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidString: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidString: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.checkValidEnum=e=>{const t=(e=>-1===e.enums.indexOf(e.value)?{result:!1,zhMsg:`参数不符合枚举类型：${e.value}。有效的类型包括：${e.enums.join()}`,enMsg:`The param is not enum：${e.value}。Valid enums are：${e.enums.join()}`}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidEnum: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidEnum: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.checkValidObject=e=>{const t=(e=>"object"!=typeof e.value?{result:!1,zhMsg:"参数不是对象",enMsg:"The parameter is not Object"}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidObject: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidObject: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.checkValidFloat=e=>{const t=(e=>Number.isFinite(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是float类型",enMsg:"The parameter is not float"})(e);if(!t.result){let i=c.IS_ZH?`checkValidFloat: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidFloat: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}};const u=e=>void 0===e.value||null===e.value?{result:!1,zhMsg:"未填必选参数",enMsg:"Missing required parameters"}:{result:!0};t.isExistOptions=u,t.checkExists=e=>{const t=u(e);if(!t.result){let i=c.IS_ZH?`checkExists: 参数错误: ${e.tag}:${t.zhMsg}`:`checkExists: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:o.default.INVALID_PARAMETER_ERROR,message:i})}},t.isNumber=e=>!isNaN(parseFloat(e))&&"number"==typeof e},function(e,t,i){var r=i(223),s=i(224);t.write=s,t.parse=r.parse,t.parseParams=r.parseParams,t.parseFmtpConfig=r.parseFmtpConfig,t.parsePayloads=r.parsePayloads,t.parseRemoteCandidates=r.parseRemoteCandidates,t.parseImageAttributes=r.parseImageAttributes,t.parseSimulcastStreamList=r.parseSimulcastStreamList},function(e,t){var i,r,s=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function o(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a}catch(e){i=a}try{r="function"==typeof clearTimeout?clearTimeout:n}catch(e){r=n}}();var d,c=[],l=!1,u=-1;function h(){l&&d&&(l=!1,d.length?c=d.concat(c):u=-1,c.length&&p())}function p(){if(!l){var e=o(h);l=!0;for(var t=c.length;t;){for(d=c,c=[];++u<t;)d&&d[u].run();u=-1,t=c.length}d=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===n||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function f(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new m(e,t)),1!==c.length||l||o(p)},m.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=f,s.addListener=f,s.once=f,s.off=f,s.removeListener=f,s.removeAllListeners=f,s.emit=f,s.prependListener=f,s.prependOnceListener=f,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MEDIA_READYSTATE_REV=t.MEDIA_READYSTATE=t.STREAM_TYPE_REV=t.STREAM_TYPE=t.NERTC_VIDEO_QUALITY_REV=t.NERTC_VIDEO_QUALITY=t.NERTC_VIDEO_QUALITY_ENUM=t.NERTC_RECORD_VIDEO_FRAME_RATE=t.NERTC_RECORD_VIDEO_QUALITY=t.VIDEO_FRAME_RATE=t.VIDEO_FRAME_RATE_ENUM=void 0,function(e){e[e.CHAT_VIDEO_FRAME_RATE_NORMAL=0]="CHAT_VIDEO_FRAME_RATE_NORMAL",e[e.CHAT_VIDEO_FRAME_RATE_5=1]="CHAT_VIDEO_FRAME_RATE_5",e[e.CHAT_VIDEO_FRAME_RATE_10=2]="CHAT_VIDEO_FRAME_RATE_10",e[e.CHAT_VIDEO_FRAME_RATE_15=3]="CHAT_VIDEO_FRAME_RATE_15",e[e.CHAT_VIDEO_FRAME_RATE_20=4]="CHAT_VIDEO_FRAME_RATE_20",e[e.CHAT_VIDEO_FRAME_RATE_25=5]="CHAT_VIDEO_FRAME_RATE_25",e[e.CHAT_VIDEO_FRAME_RATE_30=6]="CHAT_VIDEO_FRAME_RATE_30"}(t.VIDEO_FRAME_RATE_ENUM||(t.VIDEO_FRAME_RATE_ENUM={})),t.VIDEO_FRAME_RATE={CHAT_VIDEO_FRAME_RATE_NORMAL:0,CHAT_VIDEO_FRAME_RATE_5:1,CHAT_VIDEO_FRAME_RATE_10:2,CHAT_VIDEO_FRAME_RATE_15:3,CHAT_VIDEO_FRAME_RATE_20:4,CHAT_VIDEO_FRAME_RATE_25:5,CHAT_VIDEO_FRAME_RATE_30:6},t.NERTC_RECORD_VIDEO_QUALITY={RECORD_VIDEO_QUALITY_360p:360,RECORD_VIDEO_QUALITY_480p:480,RECORD_VIDEO_QUALITY_720p:720},t.NERTC_RECORD_VIDEO_FRAME_RATE={RECORD_VIDEO_FRAME_RATE_15:15,RECORD_VIDEO_FRAME_RATE_30:30},function(e){e[e.VIDEO_QUALITY_180p=2]="VIDEO_QUALITY_180p",e[e.VIDEO_QUALITY_480p=4]="VIDEO_QUALITY_480p",e[e.VIDEO_QUALITY_720p=8]="VIDEO_QUALITY_720p",e[e.VIDEO_QUALITY_1080p=16]="VIDEO_QUALITY_1080p"}(t.NERTC_VIDEO_QUALITY_ENUM||(t.NERTC_VIDEO_QUALITY_ENUM={})),t.NERTC_VIDEO_QUALITY={VIDEO_QUALITY_180p:2,VIDEO_QUALITY_480p:4,VIDEO_QUALITY_720p:8,VIDEO_QUALITY_1080p:16},t.NERTC_VIDEO_QUALITY_REV={[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p]:"320x180",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p]:"640x480",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p]:"1280x720",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p]:"1920x1080"},t.STREAM_TYPE={HIGH:0,LOW:1},t.STREAM_TYPE_REV={0:"HIGH",1:"LOW"},t.MEDIA_READYSTATE={HAVE_NOTHING:0,HAVE_METADATA:1,HAVE_CURRENT_DATA:2,HAVE_FUTURE_DATA:3,HAVE_ENOUGH_DATA:4},t.MEDIA_READYSTATE_REV={0:"HAVE_NOTHING",1:"HAVE_METADATA",2:"HAVE_CURRENT_DATA",3:"HAVE_FUTURE_DATA",4:"HAVE_ENOUGH_DATA"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCEventEmitter=void 0;const r=i(11);class s extends r.EventEmitter{constructor(){super(),this._events||(this._events={})}safeEmit(e,...t){try{e.match(/^@/)||this.emit("@"+e,...t),this.emit(e,...t)}catch(t){(this.logger||console).error(`Error on event ${e}: ${t.name} ${t.message}`,t.stack)}}}t.RTCEventEmitter=s},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.loglevelMap=t.loglevels=void 0,function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(t.loglevels||(t.loglevels={})),t.loglevelMap={0:"DEBUG",1:"INFO",2:"WARNING",3:"ERROR",4:"NONE"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getStream=t.getScreenStream=t.emptyStreamWith=t.printVideoState=t.printForLongPromise=t.watchTrack=void 0;const r=i(176),s=i(149),a=i(119),n=i(2),o=i(67),d=i(252),c=i(253),l=i(58),u=i(72),h=i(177),p=new l.Logger({tagGen:()=>"GUM"});let m=0,f="getSettings"in MediaStreamTrack.prototype;t.getStream=async function(e,t){if(e.audio&&"object"==typeof e.audio){if(!e.audio.deviceId){const i=a.Device.deviceHistory.audioIn.find((e=>"default"===e.deviceId));i&&(t.log("getStream：音频使用默认设备"+i.label),e.audio.deviceId={exact:i.deviceId})}s.compatAudioInputList.enabled&&(t.log("兼容模式：constraint强制将channelCount设为2，echoCancellation设为false"),e.audio.channelCount=2,e.audio.echoCancellation=!1)}const i=++m;t.log("getLocalStream constraint: #"+i,JSON.stringify(e));try{const a=navigator.mediaDevices.getUserMedia(e);S(a,"仍在等待 getUserMedia 返回 #"+i);const l=await a;t.log("获取到媒体流: #"+i,l.id);const u=l.getTracks();for(let e=0;e<u.length;e++){const i=u[e];if(y(i),"video"===i.kind){if(d.canShimCanvas()){t.warn("使用canvas track取代videoTrack",i.label);const e=d.shimCanvas(i);y(e),l.removeTrack(i),l.addTrack(e)}}else if("audio"===i.kind&&s.compatAudioInputList.enabled){let e;e=f?i.getSettings?i.getSettings():{}:i.getConstraints?i.getConstraints():{},e.channelCount&&e.channelCount>=2?t.log("该设备支持兼容模式："+i.label,e):t.warn("该设备为单声道设备，强行开启兼容模式(右声道无声)："+i.label,e);const a=o.getAudioContext();if(a){const e=a.createChannelSplitter(2),o=a.createMediaStreamDestination(),d=new MediaStream([i]),u=a.createMediaStreamSource(d),h=new r.AudioLevel({stream:d,logger:t,sourceNode:u});let p=0;"left"===n.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用左声道"),p=0):"right"===n.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用右声道"),p=1):"auto"===n.getParameters().audioInputcompatMode&&(t.log("兼容模式：在左右声道间根据音量切换"),h.on("channel-state-change",(r=>{"leftLoud"===r.state&&1===p?(t.log("兼容模式切换至左声道：",i.label),e.disconnect(o),e.connect(o,0),p=0):"rightLoud"===r.state&&0===p&&(t.log("兼容模式切换至右声道：",i.label),e.disconnect(o),e.connect(o,1),p=1)}))),u.connect(e),e.connect(o,p);const m=o.stream.getTracks()[0];y(m),s.compatAudioInputList.compatTracks.push({source:i,dest:m}),c.syncTrackState(i,m,"bidirectional"),l.removeTrack(i),l.addTrack(m),t.log("getStream：启用兼容模式成功")}}}return l}catch(i){return t.error(`getUserMedia error: ${i.name} [${i.message}] constraint: ${JSON.stringify(e)}`),Promise.reject(i)}},t.getScreenStream=async function(e,t){var i;const r=++m;let s;h.patchScreenConstraints(e,t),t.log("getScreenStream constraint: #"+r,JSON.stringify(e,null," ")),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia;try{const t=navigator.mediaDevices.getDisplayMedia(e);S(t,"仍在等待 getDisplayMedia 返回 #"+r),s=await t}catch(n){if(!((null===(i=null==n?void 0:n.message)||void 0===i?void 0:i.indexOf("user gesture"))>-1&&a.Device.onUserGestureNeeded))throw t.error("屏幕共享获取失败: #"+r,n.name,n.message),n;t.warn("荧幕共享获取中断，需要手势触发。",r),a.Device.onUserGestureNeeded(n);try{s=await new Promise(((t,i)=>{a.Device.once("user-gesture-fired",(()=>{navigator.mediaDevices.getDisplayMedia(e).then(t).catch(i)}))}))}catch(e){throw t.error("第二次屏幕共享获取失败: #"+r,e.name,e.message),e}}return(e=>{t.log("获取到屏幕共享流: #"+r,e.id),e.getTracks().forEach((e=>{y(e)})),Promise.resolve(e)})(s),s};let g=Date.now(),v=0;const _=()=>{const e=n.getParameters().tracks.video,t=n.getParameters().tracks.audio,i=Date.now();if(i-g>5e3&&v<n.getParameters().maxEventLoopLagWarning){let e=`侦测到主线程事件循环从卡死中恢复。卡顿时间：${i-g-1e3}毫秒。`;e+="这可能是由于页面切往后台、设备休眠、频繁的dom操作、阻塞性代码引起的。",e+=`当前页面页面是否隐藏：${document.hidden}，可见性：${document.visibilityState}，网络状态：${navigator.onLine}。`,v+=1,v===n.getParameters().maxEventLoopLagWarning&&(e+="今后不再提示。"),p.warn(e)}g=i;const r=(e,t)=>{if(!e)return;let r="";if(r=e.canvas?`CANVASTRACK#${t}${e.canvas.width}x${e.canvas.height}`:`${e.kind.toUpperCase()}TRACK#${t}【${e.label}】`,!e.endedAt)if("ended"===e.readyState){p.log(r+": 已停止"),e.endedAt=i;const t=new CustomEvent("neTrackEnded");e.dispatchEvent(t)}else!e.canvas&&e.muted&&e.enabled?(e.mutedStartAt=e.mutedStartAt||i,e.mutedCnt=e.mutedCnt||0,e.mutedCnt++,11!==e.mutedCnt&&31!==e.mutedCnt||(p.warn(`${r}： 处于无数据状态，请检查设备是否正常:${i-e.mutedStartAt}ms`),function(e){const t=[...n.getParameters().tracks.video,...n.getParameters().tracks.audio];for(let i=0;i<t.length;i++){const r=t[i];if(r&&r.label===e.label&&r!==e&&"ended"!==r.readyState)return!0}return!1}(e)&&p.warn(r+" ：该设备打开了多次"))):e.mutedStartAt&&(e.mutedCnt&&e.mutedCnt>11&&p.warn(`${r}：数据恢复正常 :${i-e.mutedStartAt}ms`),delete e.mutedStartAt,delete e.mutedCnt)};e.forEach(r),t.forEach(r)};function y(e){if(e)if("ended"===e.readyState&&p.error("注意：输入的track已经停止：",e),"audio"===e.kind){const t=n.getParameters().tracks.audio;let i=f?e.getSettings():e.getConstraints();p.log("获取到的设备类型: AUDIOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(i));const r=t.findIndex((t=>e===t));r>-1?(p.warn(`注意：AUDIOTRACK#${t.length} 与 AUDIOTRACK#${r} 相同`),t.push(null)):(e.addEventListener("ended",_),t.push(e))}else{const t=n.getParameters().tracks.video;let i=f?e.getSettings():e.getConstraints();p.log("获取到的设备类型: VIDEOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(i));const r=t.findIndex((t=>e===t));r>-1?(p.warn(`注意：VIDEOTRACK#${t.length} 与 VIDEOTRACK#${r} 相同`),t.push(null)):(e.addEventListener("ended",_),t.push(e))}}async function S(e,t){let i=0;const r=Date.now();let s=setInterval((()=>{i++,l.getDefaultLogger().warn(`${t} ${Date.now()-r}ms`),s&&i>10&&(clearInterval(s),s=null)}),6e3);e.then((()=>{s&&(clearInterval(s),s=null)})).catch((e=>{s&&(clearInterval(s),s=null)}))}setInterval(_,1e3),t.watchTrack=y,t.printForLongPromise=S,t.printVideoState=async function(e,t){let i=0;const r=Date.now(),s=[1,5,10];let a=setInterval((()=>{if(i++,-1===s.indexOf(i))return;let e=`ReadyState:${u.MEDIA_READYSTATE_REV[t.readyState]}(${t.readyState})Paused: ${t.paused}.Time: ${Date.now()-r}ms.`;const n=t.srcObject,o=null==n?void 0:n.getTracks()[0];o?(e+=`Track enabled: ${o.enabled} muted:${o.muted} name:[${o.label}]`,o.enabled?o.muted?l.getDefaultLogger().warn("媒体处于mute状态，无数据或者解码失败："+e):l.getDefaultLogger().warn("媒体标签仍在启动播放中："+e):(l.getDefaultLogger().warn("媒体被disable："+e),a&&(clearInterval(a),a=null))):(l.getDefaultLogger().warn("媒体标签srcObject属性处于异常状态："+e),a&&(clearInterval(a),a=null)),a&&i>s[s.length-1]&&(clearInterval(a),a=null)}),6e3);e.then((()=>{a&&(clearInterval(a),a=null)})).catch((e=>{a&&(clearInterval(a),a=null)}))},t.emptyStreamWith=function(e,t){let i=!1;e.getTracks().forEach((r=>{r!==t?(e.removeTrack(r),e.onremovetrack&&e.onremovetrack({track:r})):i=!0})),!i&&t&&(e.addTrack(t),e.onaddtrack&&e.onaddtrack({track:t}))}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NeAudioNode=t.NeAudioNodeNullable=void 0;const r=i(73);let s=0;class a extends r.RTCEventEmitter{constructor(e,t){super(),this.id=s++,this.connectedTo=[],this.connectedFrom=[],this.tag=e,this.audioNode=t}connect(e){this.audioNode&&e.audioNode&&this.audioNode.connect(e.audioNode),-1===this.connectedTo.indexOf(e)&&this.connectedTo.push(e),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.push(this)}disconnect(e){this.audioNode&&e.audioNode&&this.audioNode.disconnect(e.audioNode),-1!==this.connectedTo.indexOf(e)&&this.connectedTo.splice(this.connectedTo.indexOf(e),1),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.splice(e.connectedFrom.indexOf(this),1)}isConnectedTo(e){return this.connectedTo.indexOf(e)>-1}isConnectedFrom(e){return this.connectedFrom.indexOf(e)>-1}disconnectFromAll(){this.connectedFrom.forEach((e=>{e.audioNode&&this.audioNode&&e.audioNode.disconnect(this.audioNode);const t=e.connectedTo.indexOf(this);t>-1&&e.connectedTo.splice(t,1)})),this.connectedFrom.length=0}disconnectToAll(){this.connectedTo.forEach((e=>{e.audioNode&&this.audioNode&&this.audioNode.disconnect(e.audioNode);const t=e.connectedFrom.indexOf(this);t>-1&&e.connectedFrom.splice(t,1)})),this.connectedTo.length=0}updateNode(e){this.connectedTo.forEach((t=>{t.audioNode&&(this.audioNode&&this.audioNode.disconnect(t.audioNode),e.connect(t.audioNode))})),this.connectedFrom.forEach((t=>{t.audioNode&&(this.audioNode&&t.audioNode.disconnect(this.audioNode),t.audioNode.connect(e))})),this.audioNode=e}}t.NeAudioNodeNullable=a,t.NeAudioNode=class extends a{constructor(e,t){super(e,t),this.tag=e,this.audioNode=t}}},function(e,t,i){var r=function(){return this}()||Function("return this")(),s=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,a=s&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,e.exports=i(78),s)r.regeneratorRuntime=a;else try{delete r.regeneratorRuntime}catch(e){r.regeneratorRuntime=void 0}},function(e,t){!function(t){var i=Object.prototype,r=i.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",n=s.asyncIterator||"@@asyncIterator",o=s.toStringTag||"@@toStringTag",d="object"==typeof e,c=t.regeneratorRuntime;if(c)d&&(e.exports=c);else{(c=t.regeneratorRuntime=d?e.exports:{}).wrap=f;var l={},u={};u[a]=function(){return this};var h=Object.getPrototypeOf,p=h&&h(h(w([])));p&&p!==i&&r.call(p,a)&&(u=p);var m=y.prototype=v.prototype=Object.create(u);_.prototype=m.constructor=y,y.constructor=_,y[o]=_.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===_||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,o in e||(e[o]="GeneratorFunction")),e.prototype=Object.create(m),e},c.awrap=function(e){return{__await:e}},S(R.prototype),R.prototype[n]=function(){return this},c.AsyncIterator=R,c.async=function(e,t,i,r){var s=new R(f(e,t,i,r));return c.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(m),m[o]="Generator",m[a]=function(){return this},m.toString=function(){return"[object Generator]"},c.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},c.values=w,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(i,r){return n.type="throw",n.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s],n=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var o=r.call(a,"catchLoc"),d=r.call(a,"finallyLoc");if(o&&d){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var a=s;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var n=a?a.completion:{};return n.type=e,n.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(n)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),T(i),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var s=r.arg;T(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:w(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),l}}}function f(e,t,i,r){var s=t&&t.prototype instanceof v?t:v,a=Object.create(s.prototype),n=new A(r||[]);return a._invoke=function(e,t,i){var r="suspendedStart";return function(s,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===s)throw a;return{value:void 0,done:!0}}for(i.method=s,i.arg=a;;){var n=i.delegate;if(n){var o=b(n,i);if(o){if(o===l)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var d=g(e,t,i);if("normal"===d.type){if(r=i.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(r="completed",i.method="throw",i.arg=d.arg)}}}(e,i,n),a}function g(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}function v(){}function _(){}function y(){}function S(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function R(e){var t;this._invoke=function(i,s){function a(){return new Promise((function(t,a){!function t(i,s,a,n){var o=g(e[i],e,s);if("throw"!==o.type){var d=o.arg,c=d.value;return c&&"object"==typeof c&&r.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,a,n)}),(function(e){t("throw",e,a,n)})):Promise.resolve(c).then((function(e){d.value=e,a(d)}),n)}n(o.arg)}(i,s,t,a)}))}return t=t?t.then(a,a):a()}}function b(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=g(i,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function w(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return{next:I}}function I(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())},function(e,t,i){e.exports={default:i(80),__esModule:!0}},function(e,t,i){i(39),i(40),i(49),i(91),i(103),i(104),e.exports=i(3).Promise},function(e,t,i){var r=i(26),s=i(27);e.exports=function(e){return function(t,i){var a,n,o=String(s(t)),d=r(i),c=o.length;return d<0||d>=c?e?"":void 0:(a=o.charCodeAt(d))<55296||a>56319||d+1===c||(n=o.charCodeAt(d+1))<56320||n>57343?e?o.charAt(d):a:e?o.slice(d,d+2):n-56320+(a-55296<<10)+65536}}},function(e,t,i){var r=i(44),s=i(22),a=i(24),n={};i(5)(n,i(1)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(n,{next:s(1,i)}),a(e,t+" Iterator")}},function(e,t,i){var r=i(6),s=i(4),a=i(30);e.exports=i(8)?Object.defineProperties:function(e,t){s(e);for(var i,n=a(t),o=n.length,d=0;o>d;)r.f(e,i=n[d++],t[i]);return e}},function(e,t,i){var r=i(18);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,i){var r=i(10),s=i(46),a=i(86);e.exports=function(e){return function(t,i,n){var o,d=r(t),c=s(d.length),l=a(n,c);if(e&&i!=i){for(;c>l;)if((o=d[l++])!=o)return!0}else for(;c>l;l++)if((e||l in d)&&d[l]===i)return e||l||0;return!e&&-1}}},function(e,t,i){var r=i(26),s=Math.max,a=Math.min;e.exports=function(e,t){return(e=r(e))<0?s(e+t,0):a(e,t)}},function(e,t,i){var r=i(9),s=i(48),a=i(31)("IE_PROTO"),n=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=s(e),r(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?n:null}},function(e,t,i){var r=i(89),s=i(90),a=i(17),n=i(10);e.exports=i(41)(Array,"Array",(function(e,t){this._t=n(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,i=this._i++;return!e||i>=e.length?(this._t=void 0,s(1)):s(0,"keys"==t?i:"values"==t?e[i]:[i,e[i]])}),"values"),a.Arguments=a.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){var r,s,a,n,o=i(15),d=i(0),c=i(19),l=i(50),u=i(16),h=i(7),p=i(20),m=i(92),f=i(93),g=i(51),v=i(52).set,_=i(98)(),y=i(34),S=i(53),R=i(99),b=i(54),E=d.TypeError,T=d.process,A=T&&T.versions,w=A&&A.v8||"",I=d.Promise,C="process"==l(T),O=function(){},k=s=y.f,P=!!function(){try{var e=I.resolve(1),t=(e.constructor={})[i(1)("species")]=function(e){e(O,O)};return(C||"function"==typeof PromiseRejectionEvent)&&e.then(O)instanceof t&&0!==w.indexOf("6.6")&&-1===R.indexOf("Chrome/66")}catch(e){}}(),x=function(e){var t;return!(!h(e)||"function"!=typeof(t=e.then))&&t},M=function(e,t){if(!e._n){e._n=!0;var i=e._c;_((function(){for(var r=e._v,s=1==e._s,a=0,n=function(t){var i,a,n,o=s?t.ok:t.fail,d=t.resolve,c=t.reject,l=t.domain;try{o?(s||(2==e._h&&L(e),e._h=1),!0===o?i=r:(l&&l.enter(),i=o(r),l&&(l.exit(),n=!0)),i===t.promise?c(E("Promise-chain cycle")):(a=x(i))?a.call(i,d,c):d(i)):c(r)}catch(e){l&&!n&&l.exit(),c(e)}};i.length>a;)n(i[a++]);e._c=[],e._n=!1,t&&!e._h&&D(e)}))}},D=function(e){v.call(d,(function(){var t,i,r,s=e._v,a=N(e);if(a&&(t=S((function(){C?T.emit("unhandledRejection",s,e):(i=d.onunhandledrejection)?i({promise:e,reason:s}):(r=d.console)&&r.error&&r.error("Unhandled promise rejection",s)})),e._h=C||N(e)?2:1),e._a=void 0,a&&t.e)throw t.v}))},N=function(e){return 1!==e._h&&0===(e._a||e._c).length},L=function(e){v.call(d,(function(){var t;C?T.emit("rejectionHandled",e):(t=d.onrejectionhandled)&&t({promise:e,reason:e._v})}))},F=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),M(t,!0))},V=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw E("Promise can't be resolved itself");(t=x(e))?_((function(){var r={_w:i,_d:!1};try{t.call(e,c(V,r,1),c(F,r,1))}catch(e){F.call(r,e)}})):(i._v=e,i._s=1,M(i,!1))}catch(e){F.call({_w:i,_d:!1},e)}}};P||(I=function(e){m(this,I,"Promise","_h"),p(e),r.call(this);try{e(c(V,this,1),c(F,this,1))}catch(e){F.call(this,e)}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=i(100)(I.prototype,{then:function(e,t){var i=k(g(this,I));return i.ok="function"!=typeof e||e,i.fail="function"==typeof t&&t,i.domain=C?T.domain:void 0,this._c.push(i),this._a&&this._a.push(i),this._s&&M(this,!1),i.promise},catch:function(e){return this.then(void 0,e)}}),a=function(){var e=new r;this.promise=e,this.resolve=c(V,e,1),this.reject=c(F,e,1)},y.f=k=function(e){return e===I||e===n?new a(e):s(e)}),u(u.G+u.W+u.F*!P,{Promise:I}),i(24)(I,"Promise"),i(101)("Promise"),n=i(3).Promise,u(u.S+u.F*!P,"Promise",{reject:function(e){var t=k(this);return(0,t.reject)(e),t.promise}}),u(u.S+u.F*(o||!P),"Promise",{resolve:function(e){return b(o&&this===n?I:this,e)}}),u(u.S+u.F*!(P&&i(102)((function(e){I.all(e).catch(O)}))),"Promise",{all:function(e){var t=this,i=k(t),r=i.resolve,s=i.reject,a=S((function(){var i=[],a=0,n=1;f(e,!1,(function(e){var o=a++,d=!1;i.push(void 0),n++,t.resolve(e).then((function(e){d||(d=!0,i[o]=e,--n||r(i))}),s)})),--n||r(i)}));return a.e&&s(a.v),i.promise},race:function(e){var t=this,i=k(t),r=i.reject,s=S((function(){f(e,!1,(function(e){t.resolve(e).then(i.resolve,r)}))}));return s.e&&r(s.v),i.promise}})},function(e,t){e.exports=function(e,t,i,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(i+": incorrect invocation!");return e}},function(e,t,i){var r=i(19),s=i(94),a=i(95),n=i(4),o=i(46),d=i(96),c={},l={};(t=e.exports=function(e,t,i,u,h){var p,m,f,g,v=h?function(){return e}:d(e),_=r(i,u,t?2:1),y=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(p=o(e.length);p>y;y++)if((g=t?_(n(m=e[y])[0],m[1]):_(e[y]))===c||g===l)return g}else for(f=v.call(e);!(m=f.next()).done;)if((g=s(f,_,m.value,t))===c||g===l)return g}).BREAK=c,t.RETURN=l},function(e,t,i){var r=i(4);e.exports=function(e,t,i,s){try{return s?t(r(i)[0],i[1]):t(i)}catch(t){var a=e.return;throw void 0!==a&&r(a.call(e)),t}}},function(e,t,i){var r=i(17),s=i(1)("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||a[s]===e)}},function(e,t,i){var r=i(50),s=i(1)("iterator"),a=i(17);e.exports=i(3).getIteratorMethod=function(e){if(null!=e)return e[s]||e["@@iterator"]||a[r(e)]}},function(e,t){e.exports=function(e,t,i){var r=void 0===i;switch(t.length){case 0:return r?e():e.call(i);case 1:return r?e(t[0]):e.call(i,t[0]);case 2:return r?e(t[0],t[1]):e.call(i,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(i,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(i,t[0],t[1],t[2],t[3])}return e.apply(i,t)}},function(e,t,i){var r=i(0),s=i(52).set,a=r.MutationObserver||r.WebKitMutationObserver,n=r.process,o=r.Promise,d="process"==i(18)(n);e.exports=function(){var e,t,i,c=function(){var r,s;for(d&&(r=n.domain)&&r.exit();e;){s=e.fn,e=e.next;try{s()}catch(r){throw e?i():t=void 0,r}}t=void 0,r&&r.enter()};if(d)i=function(){n.nextTick(c)};else if(!a||r.navigator&&r.navigator.standalone)if(o&&o.resolve){var l=o.resolve(void 0);i=function(){l.then(c)}}else i=function(){s.call(r,c)};else{var u=!0,h=document.createTextNode("");new a(c).observe(h,{characterData:!0}),i=function(){h.data=u=!u}}return function(r){var s={fn:r,next:void 0};t&&(t.next=s),e||(e=s,i()),t=s}}},function(e,t,i){var r=i(0).navigator;e.exports=r&&r.userAgent||""},function(e,t,i){var r=i(5);e.exports=function(e,t,i){for(var s in t)i&&e[s]?e[s]=t[s]:r(e,s,t[s]);return e}},function(e,t,i){var r=i(0),s=i(3),a=i(6),n=i(8),o=i(1)("species");e.exports=function(e){var t="function"==typeof s[e]?s[e]:r[e];n&&t&&!t[o]&&a.f(t,o,{configurable:!0,get:function(){return this}})}},function(e,t,i){var r=i(1)("iterator"),s=!1;try{var a=[7][r]();a.return=function(){s=!0},Array.from(a,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!s)return!1;var i=!1;try{var a=[7],n=a[r]();n.next=function(){return{done:i=!0}},a[r]=function(){return n},e(a)}catch(e){}return i}},function(e,t,i){var r=i(16),s=i(3),a=i(0),n=i(51),o=i(54);r(r.P+r.R,"Promise",{finally:function(e){var t=n(this,s.Promise||a.Promise),i="function"==typeof e;return this.then(i?function(i){return o(t,e()).then((function(){return i}))}:e,i?function(i){return o(t,e()).then((function(){throw i}))}:e)}})},function(e,t,i){var r=i(16),s=i(34),a=i(53);r(r.S,"Promise",{try:function(e){var t=s.f(this),i=a(e);return(i.e?t.reject:t.resolve)(i.v),t.promise}})},function(e,t,i){t.__esModule=!0;var r=n(i(106)),s=n(i(108)),a="function"==typeof s.default&&"symbol"==typeof r.default?function(e){return typeof e}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":typeof e};function n(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof s.default&&"symbol"===a(r.default)?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":void 0===e?"undefined":a(e)}},function(e,t,i){e.exports={default:i(107),__esModule:!0}},function(e,t,i){i(40),i(49),e.exports=i(35).f("iterator")},function(e,t,i){e.exports={default:i(109),__esModule:!0}},function(e,t,i){i(110),i(39),i(116),i(117),e.exports=i(3).Symbol},function(e,t,i){var r=i(0),s=i(9),a=i(8),n=i(16),o=i(43),d=i(111).KEY,c=i(21),l=i(32),u=i(24),h=i(23),p=i(1),m=i(35),f=i(36),g=i(112),v=i(113),_=i(4),y=i(7),S=i(48),R=i(10),b=i(29),E=i(22),T=i(44),A=i(114),w=i(115),I=i(55),C=i(6),O=i(30),k=w.f,P=C.f,x=A.f,M=r.Symbol,D=r.JSON,N=D&&D.stringify,L=p("_hidden"),F=p("toPrimitive"),V={}.propertyIsEnumerable,j=l("symbol-registry"),U=l("symbols"),B=l("op-symbols"),H=Object.prototype,$="function"==typeof M&&!!I.f,W=r.QObject,G=!W||!W.prototype||!W.prototype.findChild,q=a&&c((function(){return 7!=T(P({},"a",{get:function(){return P(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=k(H,t);r&&delete H[t],P(e,t,i),r&&e!==H&&P(H,t,r)}:P,J=function(e){var t=U[e]=T(M.prototype);return t._k=e,t},z=$&&"symbol"==typeof M.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof M},Y=function(e,t,i){return e===H&&Y(B,t,i),_(e),t=b(t,!0),_(i),s(U,t)?(i.enumerable?(s(e,L)&&e[L][t]&&(e[L][t]=!1),i=T(i,{enumerable:E(0,!1)})):(s(e,L)||P(e,L,E(1,{})),e[L][t]=!0),q(e,t,i)):P(e,t,i)},Q=function(e,t){_(e);for(var i,r=g(t=R(t)),s=0,a=r.length;a>s;)Y(e,i=r[s++],t[i]);return e},K=function(e){var t=V.call(this,e=b(e,!0));return!(this===H&&s(U,e)&&!s(B,e))&&(!(t||!s(this,e)||!s(U,e)||s(this,L)&&this[L][e])||t)},X=function(e,t){if(e=R(e),t=b(t,!0),e!==H||!s(U,t)||s(B,t)){var i=k(e,t);return!i||!s(U,t)||s(e,L)&&e[L][t]||(i.enumerable=!0),i}},Z=function(e){for(var t,i=x(R(e)),r=[],a=0;i.length>a;)s(U,t=i[a++])||t==L||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===H,r=x(i?B:R(e)),a=[],n=0;r.length>n;)!s(U,t=r[n++])||i&&!s(H,t)||a.push(U[t]);return a};$||(o((M=function(){if(this instanceof M)throw TypeError("Symbol is not a constructor!");var e=h(arguments.length>0?arguments[0]:void 0),t=function(i){this===H&&t.call(B,i),s(this,L)&&s(this[L],e)&&(this[L][e]=!1),q(this,e,E(1,i))};return a&&G&&q(H,e,{configurable:!0,set:t}),J(e)}).prototype,"toString",(function(){return this._k})),w.f=X,C.f=Y,i(56).f=A.f=Z,i(37).f=K,I.f=ee,a&&!i(15)&&o(H,"propertyIsEnumerable",K,!0),m.f=function(e){return J(p(e))}),n(n.G+n.W+n.F*!$,{Symbol:M});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)p(te[ie++]);for(var re=O(p.store),se=0;re.length>se;)f(re[se++]);n(n.S+n.F*!$,"Symbol",{for:function(e){return s(j,e+="")?j[e]:j[e]=M(e)},keyFor:function(e){if(!z(e))throw TypeError(e+" is not a symbol!");for(var t in j)if(j[t]===e)return t},useSetter:function(){G=!0},useSimple:function(){G=!1}}),n(n.S+n.F*!$,"Object",{create:function(e,t){return void 0===t?T(e):Q(T(e),t)},defineProperty:Y,defineProperties:Q,getOwnPropertyDescriptor:X,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var ae=c((function(){I.f(1)}));n(n.S+n.F*ae,"Object",{getOwnPropertySymbols:function(e){return I.f(S(e))}}),D&&n(n.S+n.F*(!$||c((function(){var e=M();return"[null]"!=N([e])||"{}"!=N({a:e})||"{}"!=N(Object(e))}))),"JSON",{stringify:function(e){for(var t,i,r=[e],s=1;arguments.length>s;)r.push(arguments[s++]);if(i=t=r[1],(y(t)||void 0!==e)&&!z(e))return v(t)||(t=function(e,t){if("function"==typeof i&&(t=i.call(this,e,t)),!z(t))return t}),r[1]=t,N.apply(D,r)}}),M.prototype[F]||i(5)(M.prototype,F,M.prototype.valueOf),u(M,"Symbol"),u(Math,"Math",!0),u(r.JSON,"JSON",!0)},function(e,t,i){var r=i(23)("meta"),s=i(7),a=i(9),n=i(6).f,o=0,d=Object.isExtensible||function(){return!0},c=!i(21)((function(){return d(Object.preventExtensions({}))})),l=function(e){n(e,r,{value:{i:"O"+ ++o,w:{}}})},u=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!s(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,r)){if(!d(e))return"F";if(!t)return"E";l(e)}return e[r].i},getWeak:function(e,t){if(!a(e,r)){if(!d(e))return!0;if(!t)return!1;l(e)}return e[r].w},onFreeze:function(e){return c&&u.NEED&&d(e)&&!a(e,r)&&l(e),e}}},function(e,t,i){var r=i(30),s=i(55),a=i(37);e.exports=function(e){var t=r(e),i=s.f;if(i)for(var n,o=i(e),d=a.f,c=0;o.length>c;)d.call(e,n=o[c++])&&t.push(n);return t}},function(e,t,i){var r=i(18);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,i){var r=i(10),s=i(56).f,a={}.toString,n="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return n&&"[object Window]"==a.call(e)?function(e){try{return s(e)}catch(e){return n.slice()}}(e):s(r(e))}},function(e,t,i){var r=i(37),s=i(22),a=i(10),n=i(29),o=i(9),d=i(42),c=Object.getOwnPropertyDescriptor;t.f=i(8)?c:function(e,t){if(e=a(e),t=n(t,!0),d)try{return c(e,t)}catch(e){}if(o(e,t))return s(!r.f.call(e,t),e[t])}},function(e,t,i){i(36)("asyncIterator")},function(e,t,i){i(36)("observable")},function(e,t,i){function r(e){return e>0&&0==(e&e-1)}Object.defineProperty(t,"__esModule",{value:!0}),t.loadImageBatch=t.retryLoadImage=t.loadImage=t.createTexture=t.imgDataSize=t.toNthPower=t.isNthPower=void 0,t.isNthPower=r,t.toNthPower=function(e){if(r(e))return e;const t=[4096,2048,1024,512,256,128,64,32,16,8,4,2,1];let i=1/0;for(let r=0;r<t.length;r++){const s=t[r],a=Math.abs(e-s);if(e>=s)return a>i?t[r-1]:s;i=a}return 1},t.imgDataSize=function(e,t,i){if(i=null!=i?i:Math.min(t)){const i=Math.max(e,t);if(i>512){const r=i/512;return{width:e/r>>0,height:t/r>>0}}}return{width:e,height:t}},t.createTexture=function e(t,i,r){const s=t.createTexture();if(!s)return console.error(`texture:[${i}] created error.`),null;const a=Object.assign({flipY:!0,wrapS:"clamp",wrapT:"clamp",genMipMaps:!1},r),n={clamp:t.CLAMP_TO_EDGE,repeat:t.REPEAT,mirror:t.MIRRORED_REPEAT},o={glTexture:s,source:i,refresh(){const{source:e,glTexture:i,opts:r}=o,{genMipMaps:s}=r,a=t.TEXTURE_2D;t.bindTexture(a,i);const{flipY:d}=r;d?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(a,t.TEXTURE_WRAP_S,n[r.wrapS]),t.texParameteri(a,t.TEXTURE_WRAP_T,n[r.wrapT]),t.texParameteri(a,t.TEXTURE_MIN_FILTER,s?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(a,t.TEXTURE_MAG_FILTER,t.LINEAR),"width"in r&&"height"in r?t.texImage2D(a,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,e):null!==e&&t.texImage2D(a,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s&&t.generateMipmap(a)},updateMipMap(){const{glTexture:e,opts:i}=o,{genMipMaps:r}=i;if(!r)return;const s=t.TEXTURE_2D;t.bindTexture(s,e),t.generateMipmap(s)},clone:()=>e(t,o.source,o.opts),opts:a};return o.refresh(),o};const s={};function a(e,t,i){"string"==typeof e&&e&&(s[e]?null==t||t(s[e]):fetch(e+"?rdn="+Date.now()).then((e=>e.arrayBuffer())).then((r=>{let a=!1;const n=new Blob([r],{type:"image/*"}),o=new Image;new URL(e,window.location.href).origin!==window.location.origin&&(o.crossOrigin="anonymous"),o.onload=()=>{a||(a=!0,s[e]=o,null==t||t(o))},o.onerror=e=>{null==i||i(e)},o.src=URL.createObjectURL(n),setTimeout((()=>{!a&&o.complete&&o.naturalHeight>0&&(a=!0,s[e]=o,null==t||t(o))}),0)})).catch((e=>{null==i||i(e)})))}function n(e,t=3,i,r){let s=null;const n=(o=0)=>{(o+=1)<=t?a(e,(e=>{null==i||i(e)}),(e=>{s=e,n(o)})):null==r||r(s)};n()}t.loadImage=a,t.retryLoadImage=n,t.loadImageBatch=function(e,t=3,i){let r={},s=[];const a=()=>{Object.keys(r).length+s.length===e.length&&(null==i||i(r,s))};e.forEach((e=>{n(e,t,(t=>{r[e]=t,a()}),(()=>{s.push(e),a()}))}))}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.alerter=void 0;const s=r(i(12)),a=r(i(13)),n=i(73),o=i(58),d=i(148);Object.defineProperty(t,"alerter",{enumerable:!0,get:function(){return d.alerter}});const c=i(149),l=i(2);class u extends n.RTCEventEmitter{constructor(){super(),this.deviceChangeDetectionTimer=null,this.deviceInited=!1,this.hasPerm={audioIn:!1,video:!1,audioOut:!1},this.deviceHistory={audioIn:[],video:[],audioOut:[]},this.compatAudioInputList=c.compatAudioInputList,this.__v_skip=l.getParameters().enableVSkip,this.onUserGestureNeeded=null,this.logger=new o.Logger({tagGen:()=>`Device m${this.deviceHistory.audioIn.length}c${this.deviceHistory.video.length}s${this.deviceHistory.audioOut.length}`}),this.handleDeviceChange=this.detectDeviceChange.bind(this),this.onUserGestureNeeded=this.defaultHandleUserGestureNeeded.bind(this),d.alerter.addListener("@user-gesture-fired",(()=>{this.safeEmit("user-gesture-fired")}))}async getDevices(e){if(!navigator.mediaDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices),new a.default({code:s.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 mediaDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});if(!navigator.mediaDevices.enumerateDevices)throw this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices.enumerateDevices),new a.default({code:s.default.NOT_SUPPORT_ERROR,message:"getDevices: 当前浏览器不支持 enumerateDevices",url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"});let t={video:[],audioIn:[],audioOut:[]},i=await navigator.mediaDevices.enumerateDevices(),r=null;if(e.requestPerm){const t=i.find((t=>e.audioinput&&"audioinput"==t.kind&&!t.label)),s=i.find((t=>e.videoinput&&"videoinput"==t.kind&&!t.label));if(t||s)try{r=await navigator.mediaDevices.getUserMedia({audio:t,video:s})}catch(e){this.logger.error(e.name,e.message,e.stack)}}return i=await navigator.mediaDevices.enumerateDevices(),i.forEach((function(i){if(e.videoinput&&"videoinput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"camera "+(t.video.length+1))};e.groupId&&(r.groupId=i.groupId),t.video.push(r)}else if(e.audioinput&&"audioinput"===i.kind){let r;r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"microphone "+(t.audioIn.length+1))},e.groupId&&(r.groupId=i.groupId),t.audioIn.push(r)}else if(e.audiooutput&&"audiooutput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"speaker "+(t.audioOut.length+1))};e.groupId&&(r.groupId=i.groupId),t.audioOut.push(r)}r&&r.getTracks().forEach((e=>{e.stop()}))})),t}async getCameras(e){const t=await this.getDevices({videoinput:!0,requestPerm:e});return t?t.video:[]}async getMicrophones(e){const t=await this.getDevices({audioinput:!0,requestPerm:e});return t?t.audioIn:[]}async getSpeakers(e){const t=await this.getDevices({audioinput:!0,audiooutput:!0,requestPerm:e});return t?t.audioOut:[]}async detectDeviceChange(){let e={audioIn:{added:[],changed:[],removed:[]},video:{added:[],changed:[],removed:[]},audioOut:{added:[],changed:[],removed:[]}};const t=await this.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:!1,groupId:!0,noFillLabel:!0});["audioIn","video","audioOut"].forEach((i=>{if(this.deviceInited){const r=t[i].find((e=>e.deviceId&&e.label));r?this.hasPerm[i]?(t[i].forEach((t=>{const r=this.deviceHistory[i].find((e=>e.deviceId===t.deviceId||""===e.deviceId&&"default"===t.deviceId));if(r){if(r.label!==t.label||r.groupId!==t.groupId){let s=`检测到设备改变：${i}: deviceId ${t.deviceId}`;r.label!==t.label?s+=`【Label ${r.label} => ${t.label}】`:s+=" Label "+t.label,r.groupId!==t.groupId&&(s+="【groupId changed】"),this.logger.log(s),e[i].changed.push(t)}}else this.logger.log(`检测到设备新增：${i}: deviceId ${t.deviceId} 【${t.label}】`),e[i].added.push(t)})),this.deviceHistory[i].forEach((r=>{t[i].find((e=>r.deviceId===e.deviceId||""===r.deviceId&&"default"===e.deviceId))||(this.logger.log(`检测到设备拔出：${i}: deviceId ${r.deviceId} 【${r.label}】`),e[i].removed.push(r))})),this.deviceHistory[i]=t[i],e[i].added.forEach((e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"ACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"ACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"ACTIVE"})})),e[i].changed.forEach((e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"CHANGED"}):"video"===i?this.emit("camera-changed",{device:e,state:"CHANGED"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"CHANGED"})})),e[i].removed.forEach((e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"INACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"INACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"INACTIVE"})}))):(this.hasPerm[i]=!0,this.deviceHistory[i]=t[i],"audioIn"===i?(this.logger.log(`麦克风设备：${r.deviceId}【${r.label}】`),this.emit("recording-device-init")):"video"===i?(this.logger.log(`摄像头设备：【${t[i].map((e=>e.label)).join("】【")}】`),this.emit("camera-init")):"audioOut"===i&&(this.logger.log(`扬声器设备：${r.deviceId}【${r.label}】`),this.emit("playout-device-init"))):this.deviceHistory[i]=t[i]}else this.deviceHistory[i]=t[i]})),this.deviceInited||(this.deviceInited=!0,t.audioIn.length||this.logger.error("未侦测到可用麦克风"),t.video.length||this.logger.error("未侦测到可用摄像头"))}async startDeviceChangeDetection(){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(this.deviceChangeDetectionTimer&&clearInterval(this.deviceChangeDetectionTimer),await this.handleDeviceChange(),navigator.mediaDevices.ondevicechange?navigator.mediaDevices.ondevicechange===this.handleDeviceChange||(l.getParameters().forceListenDeviceChange?navigator.mediaDevices.ondevicechange=this.handleDeviceChange:this.logger.warn("系统设备枚举回调已被占用，设备枚举实效性将受到影响")):navigator.mediaDevices.ondevicechange=this.handleDeviceChange,l.getParameters().deviceChangeInterval&&(this.deviceChangeDetectionTimer=setInterval(this.handleDeviceChange,1e3))):this.logger.warn("当前环境不支持设备枚举")}stopDeviceChangeDetection(){this.logger.log("停止监听浏览器设备变化"),this.deviceChangeDetectionTimer&&(clearInterval(this.deviceChangeDetectionTimer),this.deviceChangeDetectionTimer=null),navigator.mediaDevices&&navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null),this.deviceInited=!1,this.deviceHistory.audioIn=[],this.deviceHistory.audioOut=[],this.deviceHistory.video=[],this.hasPerm.audioIn=!1,this.hasPerm.video=!1,this.hasPerm.audioOut=!1}enableCompatMode(){this.logger.log("开启兼容模式"),c.compatAudioInputList.enabled=!0,this.handleDeviceChange()}disableCompatMode(){this.logger.log("关闭兼容模式。"),c.compatAudioInputList.enabled=!1,this.handleDeviceChange()}defaultHandleUserGestureNeeded(e){const t=`由于浏览器限制，该操作需手势触发。<br/>${e.name}<br/>${e.message}<br/>点击此处以继续`;d.alerter.alert(t),this.logger.warn('为避免看到这个消息，您应该实现 Device.onUserGestureNeeded 方法，引导用户作出手势，并触发 Device.on("user-gesture-fired")事件。')}clean(){}}const h=new u;t.Device=h},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.getBrowserInfo=t.getOSInfo=void 0;const n=a(i(14)),o=new Map([[n.IS_ANDROID,["Android",n.ANDROID_VERSION]],[n.IS_IOS,["iOS",n.IOS_VERSION]],[n.IS_WIN,["Windows",n.WIN_VERSION]],[n.IS_MAC,["MacOS",n.MACOS_VERSION]]]);t.getOSInfo=function(){let e="unknown",t="unknown";return o.get(!0)&&(e=o.get(!0)[0],t=o.get(!0)[1]),{osName:e,osVersion:t}};const d=new Map([[n.IS_FIREFOX,["Firefox",n.FIREFOX_VERSION]],[n.IS_EDG,["Edg",n.EDG_VERSION]],[n.IS_CHROME,["Chrome",n.CHROME_VERSION]],[n.IS_SAFARI,["Safari",n.SAFARI_VERSION]],[n.IS_WECHAT,["WeChat",n.WECHAT_VERSION]],[n.IS_WQQB,["QQ(Win)",n.WQQB_VERSION]],[n.IS_MQQB,["QQ(Mobile)",n.MQQB_VERSION]],[n.IS_X5MQQB,["QQ(Mobile X5)",n.MQQB_VERSION]],[n.IS_MACQQB,["QQ(Mac)",n.MACQQB_VERSION]],[n.IS_IPADQQB,["QQ(iPad)",n.IPADQQB_VERSION]],[n.IS_MIBROWSER,["MI",n.MI_VERSION]],[n.IS_HUAWEIBROWSER,["HW",n.HUAWEI_VERSION]],[n.IS_SAMSUNGBROWSER,["Samsung",n.SAMSUNG_VERSION]],[n.IS_OPPOBROWSER,["OPPO",n.OPPO_VERSION]],[n.IS_VIVOBROWSER,["VIVO",n.VIVO_VERSION]],[n.IS_EDGE,["EDGE",n.EDGE_VERSION]],[n.IS_SOGOUM,["SogouMobile",n.SOGOUM_VERSION]],[n.IS_SOGOU,["Sogou",n.SOGOU_VERSION]],[n.IS_ELECTRON,["Electron",n.ELECTRON_VERSION]]]);t.getBrowserInfo=function(){let e="unknown",t="unknown";return d.get(!0)&&(e=d.get(!0)[0],t=d.get(!0)[1]),{browserName:e,browserVersion:t}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=t.UnsupportedError=void 0;class r extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(e).stack}}t.UnsupportedError=r;class s extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,s):this.stack=new Error(e).stack}}t.InvalidStateError=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.canReceive=t.canSend=t.generateProbatorRtpParameters=t.reduceCodecs=t.getSendingRemoteRtpParameters=t.getSendingRtpParameters=t.getRecvRtpCapabilities=t.getExtendedRtpCapabilities=t.validateSctpStreamParameters=t.validateSctpParameters=t.validateNumSctpStreams=t.validateSctpCapabilities=t.validateRtcpParameters=t.validateRtpEncodingParameters=t.validateRtpHeaderExtensionParameters=t.validateRtpCodecParameters=t.validateRtpParameters=t.validateRtpHeaderExtension=t.validateRtcpFeedback=t.validateRtpCodecCapability=t.validateRtpCapabilities=void 0;const n=a(i(225)),o=a(i(61));function d(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if(e.kind=i[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function c(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="")}function l(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function u(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)h(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)p(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)m(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),f(e.rtcp)}function h(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===i[1].toLowerCase()?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function p(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError("invalid header extension parameter")}}function m(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function f(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0)}function g(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function v(e){return!!e&&/.+\/rtx$/i.test(e.mimeType)}function _(e,t,{strict:i=!1,modify:r=!1}={}){const s=e.mimeType.toLowerCase();if(s!==t.mimeType.toLowerCase())return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(s){case"video/h265":case"video/vp9":case"video/av1":return!1;case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return!1;if(i){if(!n.isSameProfile(e.parameters,t.parameters))return!1;let i;try{i=n.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(e){return!1}r&&(i?e.parameters["profile-level-id"]=i:delete e.parameters["profile-level-id"])}}return!0}function y(e,t){return!(e.kind&&t.kind&&e.kind!==t.kind||e.uri!==t.uri)}function S(e,t){const i=[];for(const r of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find((e=>e.type===r.type&&(e.parameter===r.parameter||!e.parameter&&!r.parameter)));e&&i.push(e)}return i}t.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)d(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)l(t)},t.validateRtpCodecCapability=d,t.validateRtcpFeedback=c,t.validateRtpHeaderExtension=l,t.validateRtpParameters=u,t.validateRtpCodecParameters=h,t.validateRtpHeaderExtensionParameters=p,t.validateRtpEncodingParameters=m,t.validateRtcpParameters=f,t.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");g(e.numStreams)},t.validateNumSctpStreams=g,t.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},t.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},t.getExtendedRtpCapabilities=function(e,t){const i={codecs:[],headerExtensions:[]};for(const r of t.codecs||[]){if(v(r))continue;const t=(e.codecs||[]).find((e=>_(e,r,{strict:!0,modify:!0})));if(!t)continue;const s={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:r.parameters,rtcpFeedback:S(t,r)};i.codecs.push(s)}for(const r of i.codecs){const i=e.codecs.find((e=>v(e)&&e.parameters.apt===r.localPayloadType)),s=t.codecs.find((e=>v(e)&&e.parameters.apt===r.remotePayloadType));i&&s&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=s.preferredPayloadType)}for(const r of t.headerExtensions){const t=e.headerExtensions.find((e=>y(e,r)));if(!t)continue;const s={kind:r.kind,uri:r.uri,sendId:t.preferredId,recvId:r.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":s.direction="sendrecv";break;case"recvonly":s.direction="sendonly";break;case"sendonly":s.direction="recvonly";break;case"inactive":s.direction="inactive"}i.headerExtensions.push(s)}return i},t.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const i of e.codecs){const e={mimeType:i.mimeType,kind:i.kind,preferredPayloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(e),!i.localRtxPayloadType)continue;const r={mimeType:i.kind+"/rtx",kind:i.kind,preferredPayloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(r)}for(const i of e.headerExtensions){if("sendrecv"!==i.direction&&"recvonly"!==i.direction)continue;const e={kind:i.kind,uri:i.uri,preferredId:i.sendId,preferredEncrypt:i.encrypt,direction:i.direction};t.headerExtensions.push(e)}return t},t.getSendingRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}return i},t.getSendingRemoteRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}if(i.headerExtensions.some((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri)))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"goog-remb"!==e.type));else if(i.headerExtensions.some((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri)))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type));else for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter((e=>"transport-cc"!==e.type&&"goog-remb"!==e.type));return i},t.reduceCodecs=function(e,t){const i=[];if(t){for(let r=0;r<e.length;++r)if(_(e[r],t)){i.push(e[r]),v(e[r+1])&&i.push(e[r+1]);break}if(0===i.length)throw new TypeError("no matching codec found")}else i.push(e[0]),v(e[1])&&i.push(e[1]);return i},t.generateProbatorRtpParameters=function(e,t){u(e=o.clone(e,{}));const i={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:t}],rtcp:{cname:"probator"}};return i.codecs.push(e.codecs[0]),i.codecs[0].payloadType=127,i.headerExtensions=e.headerExtensions,i},t.canSend=function(e,t){return t.codecs.some((t=>t.kind===e))},t.canReceive=function(e,t){if(u(e),0===e.codecs.length)return!1;for(let i in e.codecs)if("video/rtx"!==e.codecs[i].mimeType)for(let r in t.codecs)if(t.codecs[r].localPayloadType===e.codecs[i].payloadType)return!0;return!1}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getBlobUrl=void 0;const s=r(i(246)),a=r(i(247)),n=r(i(248)),o=r(i(249)),d=r(i(250)),c=r(i(251)),l={volumeProcessor:{blobParts:[n.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioWorkletAgentProcessor:{blobParts:[c.default],options:{type:"text/javascript; charset=utf-8"},url:""},webWorkerTimer:{blobParts:[o.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioAIProcessor:{blobParts:[d.default],options:{type:"text/javascript; charset=utf-8"},url:""},signalProbeWorker:{blobParts:[a.default],options:{type:"text/js-worker"},url:""},rtcTimer:{blobParts:[s.default],options:{type:"text/js-worker"},url:""}};t.getBlobUrl=function(e){if(!l[e].url){const t=new Blob(l[e].blobParts,l[e].options);l[e].url=window.URL.createObjectURL(t)}return l[e].url}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.JSONBigStringify=t.JSONBigParse=void 0;const r=i(255),s=i(256);t.JSONBigParse=s.JSONParse(),t.JSONBigStringify=r.stringify},function(e,t,i){e.exports=a,a.className="ReflectionObject";var r,s=i(25);function a(e,t){if(!s.isString(e))throw TypeError("name must be a string");if(t&&!s.isObject(t))throw TypeError("options must be an object");this.options=t,this.parsedOptions=null,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(a.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),a.prototype.toJSON=function(){throw Error()},a.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof r&&t._handleAdd(this)},a.prototype.onRemove=function(e){var t=e.root;t instanceof r&&t._handleRemove(this),this.parent=null,this.resolved=!1},a.prototype.resolve=function(){return this.resolved||this.root instanceof r&&(this.resolved=!0),this},a.prototype.getOption=function(e){if(this.options)return this.options[e]},a.prototype.setOption=function(e,t,i){return i&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},a.prototype.setParsedOption=function(e,t,i){this.parsedOptions||(this.parsedOptions=[]);var r=this.parsedOptions;if(i){var a=r.find((function(t){return Object.prototype.hasOwnProperty.call(t,e)}));if(a){var n=a[e];s.setProperty(n,i,t)}else(a={})[e]=s.setProperty({},i,t),r.push(a)}else{var o={};o[e]=t,r.push(o)}return this},a.prototype.setOptions=function(e,t){if(e)for(var i=Object.keys(e),r=0;r<i.length;++r)this.setOption(i[r],e[i[r]],t);return this},a.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},a._configure=function(e){r=e}},function(e,t,i){e.exports=c;var r=i(125);((c.prototype=Object.create(r.prototype)).constructor=c).className="Field";var s,a=i(64),n=i(133),o=i(25),d=/^required|optional|repeated$/;function c(e,t,i,s,a,c,l){if(o.isObject(s)?(l=a,c=s,s=a=void 0):o.isObject(a)&&(l=c,c=a,a=void 0),r.call(this,e,c),!o.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!o.isString(i))throw TypeError("type must be a string");if(void 0!==s&&!d.test(s=s.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==a&&!o.isString(a))throw TypeError("extend must be a string");"proto3_optional"===s&&(s="optional"),this.rule=s&&"optional"!==s?s:void 0,this.type=i,this.id=t,this.extend=a||void 0,this.required="required"===s,this.optional=!this.required,this.repeated="repeated"===s,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!o.Long&&void 0!==n.long[i],this.bytes="bytes"===i,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=l}c.fromJSON=function(e,t){return new c(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(c.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),c.prototype.setOption=function(e,t,i){return"packed"===e&&(this._packed=null),r.prototype.setOption.call(this,e,t,i)},c.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return o.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=n.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof s?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof a&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof a)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=o.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;o.base64.test(this.typeDefault)?o.base64.decode(this.typeDefault,e=o.newBuffer(o.base64.length(this.typeDefault)),0):o.utf8.write(this.typeDefault,e=o.newBuffer(o.utf8.length(this.typeDefault)),0),this.typeDefault=e}return this.map?this.defaultValue=o.emptyObject:this.repeated?this.defaultValue=o.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof s&&(this.parent.ctor.prototype[this.name]=this.defaultValue),r.prototype.resolve.call(this)},c.d=function(e,t,i,r){return"function"==typeof t?t=o.decorateType(t).name:t&&"object"==typeof t&&(t=o.decorateEnum(t).name),function(s,a){o.decorateType(s.constructor).add(new c(a,e,t,i,{default:r}))}},c._configure=function(e){s=e}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getWebGLContext=t.get2DContext=void 0;const r=i(2);t.get2DContext=function(e,t){return r.getParameters().disable2dContext?null:e.getContext("2d",t)},t.getWebGLContext=function(e,t){return r.getParameters().disableWebGLContext?null:e.getContext("webgl",t)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.EnhancedEventEmitter=void 0;const r=i(170),s=i(38),a="EnhancedEventEmitter";class n extends r.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const i=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return s.Logger.error(a,"safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(i)}}async safeEmitAsPromise(e,...t){return new Promise(((i,r)=>{try{this.emit(e,...t,i,r)}catch(t){s.Logger.error(a,"safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,t),r(t)}}))}}t.EnhancedEventEmitter=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.HandlerInterface=void 0;const r=i(128);class s extends r.EnhancedEventEmitter{constructor(){super()}}t.HandlerInterface=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.applyCodecParameters=t.getCname=t.extractDtlsParameters=t.extractRtpCapabilities=void 0;const o=a(i(70)),d=n(i(12)),c=n(i(13));t.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,i=[];let r=!1,s=!1;for(const a of e.media){const e=a.type;switch(e){case"audio":if(r)continue;r=!0;break;case"video":if(s)continue;s=!0;break;default:continue}for(const i of a.rtp){const r={kind:e,mimeType:`${e}/${i.codec}`,preferredPayloadType:i.payload,clockRate:i.rate,channels:i.encoding,parameters:{},rtcpFeedback:[]};t.set(r.preferredPayloadType,r)}for(const e of a.fmtp||[]){const i=o.parseParams(e.config),r=t.get(e.payload);r&&(i&&i.hasOwnProperty("profile-level-id")&&(i["profile-level-id"]=String(i["profile-level-id"])),r.parameters=i)}for(const e of a.rtcpFb||[]){const i=t.get(e.payload);if(!i)continue;const r={type:e.type,parameter:e.subtype};r.parameter||delete r.parameter,i.rtcpFeedback.push(r)}for(const t of a.ext||[]){if(t["encrypt-uri"])continue;const r={kind:e,uri:t.uri,preferredId:t.value};i.push(r)}}return{codecs:Array.from(t.values()),headerExtensions:i}},t.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find((e=>e.iceUfrag&&0!==e.port));if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"extractDtlsParameters: active media 未找到"});const i=t.fingerprint||e.fingerprint;let r;switch(t.setup){case"active":r="client";break;case"passive":r="server";break;case"actpass":r="auto"}return{role:r,fingerprints:[{algorithm:i.type,value:i.hash}]}},t.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find((e=>"cname"===e.attribute));return t?t.value:""},t.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const i of e.codecs){const e=i.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find((e=>e.payload===i.payloadType)))continue;t.fmtp=t.fmtp||[];let r=t.fmtp.find((e=>e.payload===i.payloadType));r||(r={payload:i.payloadType,config:""},t.fmtp.push(r));const s=o.parseParams(r.config);switch(e){case"audio/opus":{const e=i.parameters["sprop-stereo"];void 0!==e&&(s.stereo=e?1:0);break}}r.config="";for(const e of Object.keys(s))r.config&&(r.config+=";"),r.config+=`${e}=${s[e]}`}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.filterTransportCCFromSdp=t.filterTransportCCFromRtpParameters=void 0,t.filterTransportCCFromRtpParameters=function(e){if(e.headerExtensions)for(let t=e.headerExtensions.length-1;t>=0;t--)e.headerExtensions[t].uri.indexOf("transport-wide-cc")>-1&&e.headerExtensions.splice(t,1);for(let t=e.codecs.length-1;t>=0;t--){const i=e.codecs[t];if(i.rtcpFeedback)for(let e=i.rtcpFeedback.length-1;e>=0;e--)"transport-cc"===i.rtcpFeedback[e].type&&i.rtcpFeedback.splice(e,1)}},t.filterTransportCCFromSdp=function(e){for(let t in e.media){const i=e.media[t];if(i.ext)for(let e=i.ext.length-1;e>=0;e--)i.ext[e].uri.indexOf("transport-wide-cc")>-1&&i.ext.splice(e,1);if(i.rtcpFb)for(let e=i.rtcpFb.length-1;e>=0;e--)"transport-cc"===i.rtcpFb[e].type&&i.rtcpFb.splice(e,1)}}},function(e,t,i){e.exports=u;var r=i(125);((u.prototype=Object.create(r.prototype)).constructor=u).className="Namespace";var s,a,n,o=i(126),d=i(146),c=i(25);function l(e,t){if(e&&e.length){for(var i={},r=0;r<e.length;++r)i[e[r].name]=e[r].toJSON(t);return i}}function u(e,t){r.call(this,e,t),this.nested=void 0,this._nestedArray=null}function h(e){return e._nestedArray=null,e}u.fromJSON=function(e,t){return new u(e,t.options).addJSON(t.nested)},u.arrayToJSON=l,u.isReservedId=function(e,t){if(e)for(var i=0;i<e.length;++i)if("string"!=typeof e[i]&&e[i][0]<=t&&e[i][1]>t)return!0;return!1},u.isReservedName=function(e,t){if(e)for(var i=0;i<e.length;++i)if(e[i]===t)return!0;return!1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=c.toArray(this.nested))}}),u.prototype.toJSON=function(e){return c.toObject(["options",this.options,"nested",l(this.nestedArray,e)])},u.prototype.addJSON=function(e){if(e)for(var t,i=Object.keys(e),r=0;r<i.length;++r)t=e[i[r]],this.add((void 0!==t.fields?s.fromJSON:void 0!==t.values?n.fromJSON:void 0!==t.methods?a.fromJSON:void 0!==t.id?o.fromJSON:u.fromJSON)(i[r],t));return this},u.prototype.get=function(e){return this.nested&&this.nested[e]||null},u.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof n)return this.nested[e].values;throw Error("no such enum: "+e)},u.prototype.add=function(e){if(!(e instanceof o&&void 0!==e.extend||e instanceof s||e instanceof n||e instanceof a||e instanceof u||e instanceof d))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof u&&e instanceof u)||t instanceof s||t instanceof a)throw Error("duplicate name '"+e.name+"' in "+this);for(var i=t.nestedArray,r=0;r<i.length;++r)e.add(i[r]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0)}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),h(this)},u.prototype.remove=function(e){if(!(e instanceof r))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),h(this)},u.prototype.define=function(e,t){if(c.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var i=this;e.length>0;){var r=e.shift();if(i.nested&&i.nested[r]){if(!((i=i.nested[r])instanceof u))throw Error("path conflicts with non-namespace objects")}else i.add(i=new u(r))}return t&&i.addJSON(t),i},u.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof u?e[t++].resolveAll():e[t++].resolve();return this.resolve()},u.prototype.lookup=function(e,t,i){if("boolean"==typeof t?(i=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),c.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".")}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var r=this.get(e[0]);if(r){if(1===e.length){if(!t||t.indexOf(r.constructor)>-1)return r}else if(r instanceof u&&(r=r.lookup(e.slice(1),t,!0)))return r}else for(var s=0;s<this.nestedArray.length;++s)if(this._nestedArray[s]instanceof u&&(r=this._nestedArray[s].lookup(e,t,!0)))return r;return null===this.parent||i?null:this.parent.lookup(e,t)},u.prototype.lookupType=function(e){var t=this.lookup(e,[s]);if(!t)throw Error("no such type: "+e);return t},u.prototype.lookupEnum=function(e){var t=this.lookup(e,[n]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},u.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[s,n]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},u.prototype.lookupService=function(e){var t=this.lookup(e,[a]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},u._configure=function(e,t,i){s=e,a=t,n=i}},function(e,t,i){var r=t,s=i(25),a=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function n(e,t){var i=0,r={};for(t|=0;i<e.length;)r[a[i+t]]=e[i++];return r}r.basic=n([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),r.defaults=n([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",s.emptyArray,null]),r.long=n([0,0,0,1,1],7),r.mapKey=n([0,0,0,5,5,0,0,0,1,1,0,2],2),r.packed=n([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createFrameBuffer=void 0;const r=i(118);t.createFrameBuffer=function(e,t,i,s){const a=e.createFramebuffer();if(!a)return console.error("framebuffer created error."),null;const n=r.createTexture(e,null,{width:t,height:i,genMipMaps:null!=s&&s});return n?(e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n.glTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),{framebuffer:a,targetTexture:n,bind:t=>{t?e.bindFramebuffer(e.FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,a)}}):null}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Program=void 0;const r=i(312),s=i(161),a=i(313),n=i(314);t.Program=class{constructor(e,t){this.shaders={},this.uniforms={},this.attributes={},this.indices=null,this.gl=e,this.draw=t,this._program=e.createProgram(),this.setShader(r.defaultShader.vShader,"VERTEX"),this.setShader(r.defaultShader.fShader,"FRAGMENT")}get program(){return this._program||console.error("program create error."),this._program}parseUniforms(){const e=n.parseUniforms(this.gl,this.program);for(const t in e)t in this.uniforms&&e[t].setter(this.uniforms[t].value);this.uniforms=e}parseAttributes(){const e=this.gl,t=s.parseAttributes(this.gl,this.program);for(const i in this.attributes){const r=this.attributes[i];if(i in t){const e=r.attributeBuffer;e&&t[i].bufferSetter(e)}else e.deleteBuffer(r.buffer)}this.attributes=t}get count(){const e=this.attributes;let t=-1;for(const i in e){const r=e[i];-1!==t&&t!==r.count&&console.warn("inconsistent attribute length."),t=Math.max(t,r.count)}return t}setShader(e,t){const i=this.gl,s=this.program,n=a.createShader(i,e,t);if(n){const e=this.shaders[t];e&&(i.detachShader(s,e),i.deleteShader(e)),i.attachShader(s,n),this.shaders[t]=n,this.shaders.VERTEX&&this.shaders.FRAGMENT&&(i.linkProgram(s),this.parseUniforms(),this.parseAttributes())}else"VERTEX"===t?this.setShader(r.defaultShader.vShader,"VERTEX"):this.setShader(r.defaultShader.fShader,"FRAGMENT")}getUniform(e){var t;const i=null!==(t=this.uniforms[e])&&void 0!==t?t:null;return i||console.warn(`uniform:[${e}] does not exist.`),i}setUniform(e,t){var i;null===(i=this.getUniform(e))||void 0===i||i.setter(t)}updateUniform(e,t){var i;const r=this.getUniform(e);null==r||r.setter(null!==(i=t(r.value))&&void 0!==i?i:r.value)}setAttributeBuffer(e){var t;e&&(null===(t=this.getAttribute(e.name))||void 0===t||t.bufferSetter(e))}getAttribute(e){return this.attributes[e]||console.warn(`attribute:[${e}] does not exist.`),this.attributes[e]}setAttribute(e,t){var i;null===(i=this.getAttribute(e))||void 0===i||i.setter(t)}updateAttribute(e,t){var i;const r=this.getAttribute(e);null==r||r.setter(null!==(i=t(r.typedArray))&&void 0!==i?i:r.typedArray)}setIndices(e){if(e&&"indices"===e.name){const t=this.gl;t.bindBuffer(e.target,e.buffer),t.bufferData(e.target,e.typedArray,e.usage)}this.indices=e}render(){const e=this.gl,t=this.program;e.useProgram(t);const i=this.uniforms;for(const e in i)i[e].setter();const r=this.attributes;for(const e in r)r[e].setter();this.indices&&e.bindBuffer(this.indices.target,this.indices.buffer),this.draw?this.draw():e.drawArrays(e.TRIANGLE_STRIP,0,this.count)}destroy(e=!0){var t,i;const r=this.gl;if(e){for(const e in this.attributes){const t=this.attributes[e];if(t){const i=r.getAttribLocation(this.program,e);r.disableVertexAttribArray(i),r.deleteBuffer(t.buffer)}}this.indices&&r.deleteBuffer(this.indices.buffer)}r.deleteShader(null!==(t=this.shaders.VERTEX)&&void 0!==t?t:null),r.deleteShader(null!==(i=this.shaders.FRAGMENT)&&void 0!==i?i:null),r.deleteProgram(this.program)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.baseTextureShader=void 0,t.baseTextureShader={vShader:"\n    attribute vec4 position;\n    attribute vec2 uv;\n    varying vec2 vuv;\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vuv);\n    }\n",yFlipFShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vec2(vuv.x, 1.0 - vuv.y));\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;const r=i(11);class s extends r.EventEmitter{constructor(e,t,i,r){super(),this.programs={},this.framebuffers={},this.renderer=e,this._map=t,this.posBuffer=i,this.uvBuffer=r}get map(){return this._map}set map(e){}get output(){return this._map}updateSize(){}render(){}destroy(e=!0){this.removeAllListeners();const t=this.renderer.gl,i=this.framebuffers,r=this.programs;for(const e in i){const r=i[e];r.bind(!0),null==t||t.deleteTexture(r.targetTexture.glTexture),null==t||t.deleteFramebuffer(r.framebuffer)}for(const t in r)r[t].destroy(e)}}t.Filter=s},,,,,,function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteSdp=void 0;const n=a(i(70)),o=a(i(14)),d=i(2),c=i(38),l=i(229);t.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=r,this._plainRtpParameters=s,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[e-1].algorithm,hash:i.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}s&&(this._sdpObject.origin.address=s.ip,this._sdpObject.origin.ipVer=s.ipVersion)}updateIceParameters(e){c.Logger.debug("RemoteSdp","updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){c.Logger.debug("RemoteSdp",`updateDtlsRole() [role: ${e}]`),this._dtlsParameters&&(this._dtlsParameters.role=e);for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){if(d.getParameters().reuseMid)for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObjectArr:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s,extmapAllowMixed:a=!1}){(null==e?void 0:e.length)&&e.forEach(((e,n)=>{if(!e)return;const o=new l.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s?s[n]:void 0,extmapAllowMixed:a});t?this._replaceMediaSection(o,t):this._addMediaSection(o)}))}receive({mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s,reuseMid:a=null,reuseMediaSection:n}){const o=this._midToIndex.get(e);let d;void 0!==o&&(d=this._mediaSections[o]),d?(d=new l.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),this._replaceMediaSection(d,e)):(d=new l.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),null===a?this._addMediaSection(d):this._replaceMediaSection(d,a))}disableMediaSection(e){const t=this._midToIndex.get(e);void 0!==t&&this._mediaSections[t].disable()}closeMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t)return;const i=this._mediaSections[t];e===this._firstMid&&c.Logger.debug("RemoteSdp","closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),i.close()}planBStopReceiving({mid:e,offerRtpParameters:t}){const i=this._midToIndex.get(e);if(void 0===i)return;const r=this._mediaSections[i];r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new l.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new l.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,o.ANY_CHROME_MAJOR_VERSION&&o.ANY_CHROME_MAJOR_VERSION>=72&&this._sdpObject.media.sort((function(e,t){return e.mid-t.mid})),n.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if("string"==typeof t){const i=this._midToIndex.get(t);if(void 0===i)return;const r=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(r.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(e.mid);if(void 0===t)return;this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject()}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter((e=>!e.closed)).map((e=>e.mid)).join(" "))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.addNackSuppportForOpus=t.mangleRtpParameters=t.getCapabilities=void 0;const n=a(i(61));t.getCapabilities=function(){const e=RTCRtpReceiver.getCapabilities(),t=n.clone(e,{});for(const e of t.codecs){if(e.channels=e.numChannels,delete e.numChannels,e.mimeType=e.mimeType||`${e.kind}/${e.name}`,e.parameters){const t=e.parameters;t.apt&&(t.apt=Number(t.apt)),t["packetization-mode"]&&(t["packetization-mode"]=Number(t["packetization-mode"]))}for(const t of e.rtcpFeedback||[])t.parameter||(t.parameter="")}return t},t.mangleRtpParameters=function(e){const t=n.clone(e,{});t.mid&&(t.muxId=t.mid,delete t.mid);for(const e of t.codecs)e.channels&&(e.numChannels=e.channels,delete e.channels),e.mimeType&&!e.name&&(e.name=e.mimeType.split("/")[1]),delete e.mimeType;return t},t.addNackSuppportForOpus=function(e){var t;for(const i of e.codecs||[])"audio/opus"!==i.mimeType.toLowerCase()||(null===(t=i.rtcpFeedback)||void 0===t?void 0:t.some((e=>"nack"===e.type&&!e.parameter)))||(i.rtcpFeedback||(i.rtcpFeedback=[]),i.rtcpFeedback.push({type:"nack"}))}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleBig=void 0;class r{constructor(e){this.isSimpleBig=!0,"string"==typeof e?this.numStr=e:e>Number.MIN_SAFE_INTEGER?this.numStr=e.toString():(console.error("Invalid numStr:",e),this.numStr="-1")}toString(){return this.numStr}static fromHex(e){if(e.length<13)return parseInt(e,16);let t="0";return e.split("").forEach((e=>{var i=parseInt(e,16);for(let e=8;e;e>>=1)t=s(t,t),i&e&&(t=s(t,"1"))})),new r(t)}}function s(e,t){let i=0,r=[],s=e.split("").map(Number),a=t.split("").map(Number);for(;s.length||a.length;){const e=(s.pop()||0)+(a.pop()||0)+i;r.unshift(e<10?e:e-10),i=e<10?0:1}return i&&r.unshift(i),r.join("")}t.SimpleBig=r},function(e,t,i){e.exports=n;var r=i(125);((n.prototype=Object.create(r.prototype)).constructor=n).className="OneOf";var s=i(126),a=i(25);function n(e,t,i,s){if(Array.isArray(t)||(i=t,t=void 0),r.call(this,e,i),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=s}function o(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t])}n.fromJSON=function(e,t){return new n(e,t.oneof,t.options,t.comment)},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},n.prototype.add=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,o(this),this},n.prototype.remove=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},n.prototype.onAdd=function(e){r.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var i=e.get(this.oneof[t]);i&&!i.partOf&&(i.partOf=this,this.fieldsArray.push(i))}o(this)},n.prototype.onRemove=function(e){for(var t,i=0;i<this.fieldsArray.length;++i)(t=this.fieldsArray[i]).parent&&t.parent.remove(t);r.prototype.onRemove.call(this,e)},n.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,i){a.decorateType(t.constructor).add(new n(i,e)),Object.defineProperty(t,i,{get:a.oneOfGetter(e),set:a.oneOfSetter(e)})}}},function(e,t,i){var r=i(74),s=i(58),a=i(2),n=[];e.exports=class{constructor(e){this.formatTimeUnit=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i},this.logCache=function(e){if(window.logUpload&&!(0,a.getParameters)().disableAllReports)if(window.wsTransport)n.length&&(n.forEach((function(e){window.wsTransport&&window.wsTransport.sendLog(e.args)})),n=[]),window.wsTransport&&window.wsTransport.sendLog(e);else{var t=Date.now();try{n.length&&n[n.length-1].args[0].replace("[NERTC","[缓存][NERTC")}catch(e){}n.push({time:t,args:e})}},this.prefix=e?"protoo-client:"+e:"protoo-client"}debug(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,e),this.logCache(e)}warn(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,e),this.logCache(e)}error(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.ERROR&&console.error.apply(console,e),this.logCache(e)}formatArgs(e){var t=new Date,i=this.formatTimeUnit(""+(t.getMonth()+1))+"-"+this.formatTimeUnit(""+t.getDate())+" "+this.formatTimeUnit(""+t.getHours())+":"+this.formatTimeUnit(""+t.getMinutes())+":"+this.formatTimeUnit(""+t.getSeconds())+":"+this.formatTimeUnit(""+t.getMilliseconds(),3),r="[NERTC:LOG:"+(0,s.updateLogIndex)()+" "+i+" "+this.prefix.toUpperCase()+"]";return e.unshift(r),e}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.alerter=void 0;const n=i(164),o=a(i(14)),d=i(73),c=i(2),l=i(67);class u extends d.RTCEventEmitter{constructor(){super(...arguments),this.elem=null}alert(e,t){t||(t={resume:!1}),this.elem||(this.elem=document.createElement("div"),this.elem.style.fontSize="20px",this.elem.style.position="fixed",this.elem.style.background="yellow",this.elem.style.margin="auto",this.elem.style.width="100%",this.elem.style.zIndex="9999",this.elem.style.top="0",this.elem.addEventListener("click",(()=>{var e;(null===(e=this.elem)||void 0===e?void 0:e.parentNode)&&this.elem.parentNode.removeChild(this.elem),this.safeEmit("@user-gesture-fired")}))),this.elem.style.display="block",this.elem.innerHTML=e,document.body.appendChild(this.elem),t.resume&&this.elem.addEventListener("click",h,{once:!0})}watchClient(e){e.addListener("@pairing-join-start",(()=>{if(0===n.systemChecker.checkCnt||"always"===c.getParameters().enableAlerter){const e=72;if(o.IS_CHROME&&(o.IS_MAC||o.IS_WIN)&&o.CHROME_MAJOR_VERSION&&o.CHROME_MAJOR_VERSION<e){let e=`您当前正在使用的Chrome浏览器版本为${o.CHROME_MAJOR_VERSION}, 不在NERTC的支持范围。请更新您的浏览器。<br/>您看到这条提示是因为您未调用 NERTC.checkSystemRequirements()，并且浏览器版本过低。`;this.alert(e)}}})),e.addListener("@connection-state-change",(t=>{if("DISCONNECTING"===t.curState&&"CONNECTING"===t.prevState&&(e._events&&!e._events["connection-state-change"]&&!e._events.SOCKET_ERROR||"always"===c.getParameters().enableAlerter)){let e="由于网络原因，您当前已经退出房间。<br/>您看到这条提示是因为您未监听 connection-state-change 或 SOCKET_ERROR 事件，并且加入房间后意外退出了房间。";this.alert(e)}}))}watchLocalStream(e){e.on("@notAllowedError",(t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0})}}))}watchRemoteStream(e){e.on("@notAllowedError",(t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0})}}))}}function h(){const e=c.getParameters().clients;for(let t=0;t<e.length;t++){const i=e[t];if(!i.destroyed)for(let e in i.adapterRef.remoteStreamMap)i.adapterRef.remoteStreamMap[e].resume()}const t=c.getParameters().localStreams;for(let e=0;e<t.length;e++){const i=t[e];i.destroyed||i.resume()}const i=l.getAudioContext();"suspended"===(null==i?void 0:i.state)&&(e[0]&&e[0].logger.warn("尝试恢复 AudioContext"),i.resume())}t.alerter=new u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.compatAudioInputList=void 0;const r=i(2);t.compatAudioInputList=new class{constructor(){this.enabled=r.getParameters().enableCompatAudio,this.compatTracks=[]}findSource(e){const t=this.compatTracks.find((t=>t.dest.id===e));return t?t.source:null}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encryptionModeToInt=t.EncryptionModes=t.Encryption=void 0;const s=i(11),a=r(i(151)),n={none:-1,"sm4-128-ecb":0};t.EncryptionModes=n,t.encryptionModeToInt=function(e){return"none"===e||"sm4-128-ecb"===e?n[e]:void 0};class o extends s.EventEmitter{constructor(e){super(),this.encryptionMode="none",this.encryptionSecret="",this.encodedInsertableStreams=!1,this.adapterRef=e}setEncryptionMode(e){this.encryptionMode=e}setEncryptionSecret(e){this.encryptionSecret=a.default(e)}handleUpstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("生成第一帧上行自定义加密（明文）。长度:",t.data.byteLength,e.mediaType,e.streamType),this.adapterRef.instance.safeEmit("sender-transform",{uid:this.adapterRef.channelInfo.uid,mediaType:e.mediaType,streamType:e.streamType,encodedFrame:t,controller:i})}handleDownstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("收到第一帧下行自定义加密（密文）。长度:",t.data.byteLength,e.uid,e.mediaType),"key"===t.type&&this.adapterRef.state.videoFirstIframeTime<this.adapterRef.state.signalJoinSuccessTime&&(this.adapterRef.state.videoFirstIframeTime=Date.now()),this.adapterRef.instance.safeEmit("receiver-transform",{uid:e.uid,mediaType:e.mediaType,encodedFrame:t,controller:i})}}t.Encryption=o},function(e,t,i){var r,s,a,n,o;r=i(213),s=i(167).utf8,a=i(214),n=i(167).bin,(o=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?n.stringToBytes(e):s.stringToBytes(e):a(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var i=r.bytesToWords(e),d=8*e.length,c=1732584193,l=-271733879,u=-1732584194,h=271733878,p=0;p<i.length;p++)i[p]=16711935&(i[p]<<8|i[p]>>>24)|4278255360&(i[p]<<24|i[p]>>>8);i[d>>>5]|=128<<d%32,i[14+(d+64>>>9<<4)]=d;var m=o._ff,f=o._gg,g=o._hh,v=o._ii;for(p=0;p<i.length;p+=16){var _=c,y=l,S=u,R=h;c=m(c,l,u,h,i[p+0],7,-680876936),h=m(h,c,l,u,i[p+1],12,-389564586),u=m(u,h,c,l,i[p+2],17,606105819),l=m(l,u,h,c,i[p+3],22,-1044525330),c=m(c,l,u,h,i[p+4],7,-176418897),h=m(h,c,l,u,i[p+5],12,1200080426),u=m(u,h,c,l,i[p+6],17,-1473231341),l=m(l,u,h,c,i[p+7],22,-45705983),c=m(c,l,u,h,i[p+8],7,1770035416),h=m(h,c,l,u,i[p+9],12,-1958414417),u=m(u,h,c,l,i[p+10],17,-42063),l=m(l,u,h,c,i[p+11],22,-1990404162),c=m(c,l,u,h,i[p+12],7,1804603682),h=m(h,c,l,u,i[p+13],12,-40341101),u=m(u,h,c,l,i[p+14],17,-1502002290),c=f(c,l=m(l,u,h,c,i[p+15],22,1236535329),u,h,i[p+1],5,-165796510),h=f(h,c,l,u,i[p+6],9,-1069501632),u=f(u,h,c,l,i[p+11],14,643717713),l=f(l,u,h,c,i[p+0],20,-373897302),c=f(c,l,u,h,i[p+5],5,-701558691),h=f(h,c,l,u,i[p+10],9,38016083),u=f(u,h,c,l,i[p+15],14,-660478335),l=f(l,u,h,c,i[p+4],20,-405537848),c=f(c,l,u,h,i[p+9],5,568446438),h=f(h,c,l,u,i[p+14],9,-1019803690),u=f(u,h,c,l,i[p+3],14,-187363961),l=f(l,u,h,c,i[p+8],20,1163531501),c=f(c,l,u,h,i[p+13],5,-1444681467),h=f(h,c,l,u,i[p+2],9,-51403784),u=f(u,h,c,l,i[p+7],14,1735328473),c=g(c,l=f(l,u,h,c,i[p+12],20,-1926607734),u,h,i[p+5],4,-378558),h=g(h,c,l,u,i[p+8],11,-2022574463),u=g(u,h,c,l,i[p+11],16,1839030562),l=g(l,u,h,c,i[p+14],23,-35309556),c=g(c,l,u,h,i[p+1],4,-1530992060),h=g(h,c,l,u,i[p+4],11,1272893353),u=g(u,h,c,l,i[p+7],16,-155497632),l=g(l,u,h,c,i[p+10],23,-1094730640),c=g(c,l,u,h,i[p+13],4,681279174),h=g(h,c,l,u,i[p+0],11,-358537222),u=g(u,h,c,l,i[p+3],16,-722521979),l=g(l,u,h,c,i[p+6],23,76029189),c=g(c,l,u,h,i[p+9],4,-640364487),h=g(h,c,l,u,i[p+12],11,-421815835),u=g(u,h,c,l,i[p+15],16,530742520),c=v(c,l=g(l,u,h,c,i[p+2],23,-995338651),u,h,i[p+0],6,-198630844),h=v(h,c,l,u,i[p+7],10,1126891415),u=v(u,h,c,l,i[p+14],15,-1416354905),l=v(l,u,h,c,i[p+5],21,-57434055),c=v(c,l,u,h,i[p+12],6,1700485571),h=v(h,c,l,u,i[p+3],10,-1894986606),u=v(u,h,c,l,i[p+10],15,-1051523),l=v(l,u,h,c,i[p+1],21,-2054922799),c=v(c,l,u,h,i[p+8],6,1873313359),h=v(h,c,l,u,i[p+15],10,-30611744),u=v(u,h,c,l,i[p+6],15,-1560198380),l=v(l,u,h,c,i[p+13],21,1309151649),c=v(c,l,u,h,i[p+4],6,-145523070),h=v(h,c,l,u,i[p+11],10,-1120210379),u=v(u,h,c,l,i[p+2],15,718787259),l=v(l,u,h,c,i[p+9],21,-343485551),c=c+_>>>0,l=l+y>>>0,u=u+S>>>0,h=h+R>>>0}return r.endian([c,l,u,h])})._ff=function(e,t,i,r,s,a,n){var o=e+(t&i|~t&r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},o._gg=function(e,t,i,r,s,a,n){var o=e+(t&r|i&~r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},o._hh=function(e,t,i,r,s,a,n){var o=e+(t^i^r)+(s>>>0)+n;return(o<<a|o>>>32-a)+t},o._ii=function(e,t,i,r,s,a,n){var o=e+(i^(t|~r))+(s>>>0)+n;return(o<<a|o>>>32-a)+t},o._blocksize=16,o._digestsize=16,e.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var i=r.wordsToBytes(o(e,t));return t&&t.asBytes?i:t&&t.asString?n.bytesToString(i):r.bytesToHex(i)}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Record=void 0;const o=i(11),d=n(i(12)),c=n(i(13)),l=a(i(14));class u extends o.EventEmitter{constructor(e){super(),this._status={recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null},this._recorder=null,this.logger=e.logger.getChild((()=>"recorder "+this._status.recordStatus)),this._reset(),this.client=e.client}get recoder(){return this._recorder}async start(e){const{stream:t=null,uid:i="0",type:r="video",reset:s=!1,recordName:a}=e;this.logger.log("开始本地录制: ",JSON.stringify(e,null,""));let n=null;if(!window.MediaRecorder||!MediaRecorder.isTypeSupported||!l.IS_CHROME)throw n="Record.start: 当前浏览器不支持本地录制",this.logger.warn(n),new c.default({code:d.default.RECORDING_NOT_SUPPORT,message:n});if(this._status.isRecording)throw n="Record.start: 操作异常, 当前正在录制中",this.logger.warn(n),new c.default({code:d.default.REPEAT_RECORDING_ERROR,message:n});if(this._status.recordUrl&&"downloaded"!==this._status.recordStatus){if(!e.reset)throw n="Record.start: 操作异常, 请先下载或重置上一段录制文件",this.logger.warn(n),new c.default({code:d.default.RECORDING_CACHE_ERROR,message:n});this.logger.warn("Record.start: 存在未下载视频，强制清除..."),await this.clean()}n&&this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:n,uid:i,mediaType:r,recordName:""},null," ")}),this._status.stream=t,this._status.option=e,this._status.fileName=this._getFilename(a),this._status.startTime=this._getTimeStamp();let o=["video/mp4;codecs=opus","video/webm","video/webm;codecs=h264","video/x-matroska;codecs=opus","video/invalid"];if("audio"===e.type&&(o=["audio/wav","audio/ogg","audio/pcm","audio/webm"]),!(this._status.mimeType=this._validation(o)[0]))return"RecordBrowserNotSupport";try{await this._format(),await this._start(),this.client.apiFrequencyControl({name:"startMediaRecording",code:0,param:JSON.stringify({uid:i,mediaType:r,recordName:""},null," ")})}catch(e){return this.logger.error("Record.start 内部异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:e.message,uid:i,mediaType:r,recordName:""},null," ")}),Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record.start: 录制异常 "+e.message}))}}stop(e){let t=null;return this._status.isRecording&&this._recorder||(this.logger.log("Record.stop 当前没有进行录制"),t="RecordNotExist"),this._recorder&&"started"!==this._status.state&&(this.logger.warn("Record.stop: record stopping when "+this._recorder.state),t="RecordStateError"),t?(e&&!1===e.isUser||this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""}),Promise.resolve()):(this._status.state="stopped",this._status.recordStatus="stopping",new Promise(((t,i)=>{var r;this._status.fileName=this._status.fileName,this._recorder.onstop=()=>{this._onStop(t)},null===(r=null==this?void 0:this._recorder)||void 0===r||r.stop(),this.client.apiFrequencyControl({name:"stopMediaRecording",code:0,param:""}),e&&e.isUser&&this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""})})))}play(e){return"stopped"!==this._status.state?(this.client.apiFrequencyControl({name:"playMediaRecording",code:-1,param:JSON.stringify({reason:"RecordStateError"},null," ")}),this.logger.warn("MediaRecordHelper: record stopping when "+(this._recorder&&this._recorder.state)),Promise.resolve()):(this.client.apiFrequencyControl({name:"playMediaRecording",code:0,param:JSON.stringify({recordId:""},null," ")}),this._play(e))}download(e=!0){return Promise.resolve().then((()=>this._status.isRecording?(this.logger.log("Record.download: 正在录制中，立即停止..."),this.stop({isUser:!1})):Promise.resolve())).then((()=>{if(this._status.recordUrl){const e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=this._status.recordUrl,e.download=(this._status.fileName||this._getTimeStamp())+".webm",e.click(),this._status.recordStatus="downloaded"}else this.logger.log("Record.download: cannot download media without url ...");return e&&this.client.apiFrequencyControl({name:"downloadMediaRecording",code:0,param:""}),Promise.resolve(this._status)}))}async clean(){this.client.apiFrequencyControl({name:"cleanMediaRecording",code:0,param:""}),this._status.isRecording&&this._recorder&&await this.stop(),this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._destroy(),this._status.recordStatus="init"}leave(e={uid:0}){if(!this._status.isRecording||!this._recorder)return Promise.resolve();const{uid:t}=e;return t&&this._status.option?t===+this._status.option.uid?this.stop():void 0:Promise.resolve()}pause(){this._recorder&&this._recorder.pause()}resume(){this._recorder&&this._recorder.resume()}_reset(){this._recorder=null,Object.assign(this._status,{recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null})}_getTimeStamp(){return Math.floor(Date.now()/1e3)}_getFilename(e){let t="";e&&(t+=e+"_");const i=new Date;return t+=`${i.getFullYear()}${(i.getMonth()+1).toString().padStart(2,"0")}${i.getDate().toString().padStart(2,"0")}`,t+=`${i.getHours().toString().padStart(2,"0")}${i.getMinutes().toString().padStart(2,"0")}${i.getSeconds().toString().padStart(2,"0")}${i.getMilliseconds().toString().padStart(3,"0")}`,t}_validation(e){return e.filter((e=>MediaRecorder.isTypeSupported(e)))}_format(){let e=this._status.stream;return this._status.option,new Promise(((t,i)=>{let r=new MediaStream;if(!e)return i(new c.default({code:d.default.RECORDING_ERROR,message:"Record._format: stream 未明确"}));if(this._matchLocalStreamConstructor(e.constructor.toString())&&(e=[e]),Array.isArray(e)){if(e.forEach((e=>{e&&this._matchLocalStreamConstructor(e.constructor.toString())&&e.getTracks().forEach((e=>{r.addTrack(e)}))})),0===r.getTracks().length)return this.logger.error("_format: No tracks available"),t(r);this._status.opStream=r,t(r)}}))}_matchLocalStreamConstructor(e){return/(LocalMediaStream|MediaStream)/.test(e)}_start(){let e={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:this._status.mimeType};if(!this._status.opStream)return Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record._start: opStream 未明确"}));const t=this._status.opStream.getAudioTracks();let i;i=t.length>1?new MediaStream([t[0]]):this._status.opStream;let r=this._recorder=new MediaRecorder(i,e);return r.ondataavailable=this._onDataAvailable.bind(this),r.onstop=()=>{this.logger.log("MediaRecordHelper: _start: record stop automatically ..."),this._onStop()},this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._status.recordedChunks=[],this._status.isRecording=!0,this._status.state="started",this._status.recordId+=1,this._status.recordStatus="starting",this._recorder.start(),this._clearTimer(),this._startTimer(),Promise.resolve(this._status.recordId)}_startTimer(){this._status.timer||(this._status.timer=setInterval((()=>{this.logger.log(`MediaRecordHelper: startTimer: ${(new Date).toLocaleString()} --\x3e MediaRecorder status: ${this._recorder&&this._recorder.state}`)}),5e3))}_onStop(e){this.logger.log("MediaRecordHelper: _onStop: record stoped !!!"),this._clearTimer(),this._status.recordStatus="stopped",this._status.isRecording=!1,this._status.endTime=this._getTimeStamp();let t=new Blob(this._status.recordedChunks,{type:this._status.mimeType});this._status.recordUrl=URL.createObjectURL(t),this.emit("media-recording-stopped",this.getRecordStatus()),e&&e(this._status.fileName)}_play(e){let t=null;if(-1!=this._status.mimeType.indexOf("audio"))t=document.createElement("audio");else{if(-1==this._status.mimeType.indexOf("video"))return Promise.reject(new c.default({code:d.default.NOT_SUPPORT_ERROR,message:"_play: 当前浏览器不支持 MIME type "+this._status.mimeType}));t=document.createElement("video"),t.autoplay=!0}return this._status.recordUrl?(e.appendChild(t),t.srcObject=null,t.src=this._status.recordUrl,t.controls=!1,t.play(),Promise.resolve(this._status.option)):Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:"Record._play: 录制 url 未明确"}))}async _destroy(){this._status.audioController&&this._status.audioController.destroy(),this._status.isRecording&&await this.stop({isUser:!1}),this._clearTimer(),this._recorder=null,Object.assign(this._status,{stream:null,recordedChunks:[],isRecording:!1,audioController:null,status:"init"})}_clearTimer(){this._status.timer&&(clearInterval(this._status.timer),this._status.timer=null)}_onDataAvailable(e){if(this._status.recordStatus="recording",this.logger.log("MediaRecordHelper: ondataavailable: data received"),!(e.data.size>0))return this.logger.warn("MediaRecordHelper: ondataavailable: no data"),void this.stop();this._status.recordedChunks.push(e.data)}checkIsRecording(){return this._status.isRecording}getRecordStatus(){const e=Object.assign({id:this._status.recordId,type:this._status.mimeType,name:this._status.fileName,status:this._status.recordStatus,isRecording:this._status.isRecording,startTime:this._status.startTime,endTime:this._status.endTime},this._status.option);return this.client.apiFrequencyControl({name:"listMediaRecording",code:0,param:""}),e}destroy(){this._destroy()}}t.Record=u},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addLegacySimulcast=t.getRtpEncodings=void 0;const s=r(i(12)),a=r(i(13));t.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const i of e.ssrcs||[]){const e=i.id;t.add(e)}if(0===t.size)throw new a.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"getRtpEncodings: a=ssrc 行未找到"});const i=new Map;for(const r of e.ssrcGroups||[]){if("FID"!==r.semantics)continue;let[e,s]=r.ssrcs.split(/\s+/);e=Number(e),s=Number(s),t.has(e)&&(t.delete(e),t.delete(s),i.set(e,s))}for(const e of t)i.set(e,null);const r=[];for(const[e,t]of i){const i={ssrc:e};t&&(i.rtx={ssrc:t}),r.push(i)}return r},t.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const i=(e.ssrcs||[]).find((e=>"msid"===e.attribute));if(!i)throw new a.default({code:s.default.UNKNOWN_TYPE_ERROR,message:"addLegacySimulcast: a=ssrc 行的 msid 信息未找到"});const[r,n]=i.value.split(" "),o=i.id;let d;(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===o&&(d=Number(t[1]),!0)}));const c=e.ssrcs.find((e=>"cname"===e.attribute)).value,l=[],u=[];for(let e=0;e<t;++e)l.push(o+e),d&&u.push(d+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:l.join(" ")});for(let t=0;t<l.length;++t){const i=l[t];e.ssrcs.push({id:i,attribute:"cname",value:c}),e.ssrcs.push({id:i,attribute:"msid",value:`${r} ${n}`})}for(let t=0;t<u.length;++t){const i=l[t],s=u[t];e.ssrcs.push({id:s,attribute:"cname",value:c}),e.ssrcs.push({id:s,attribute:"msid",value:`${r} ${n}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${s}`})}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isIosFromRtpStats=t.getNativeRtpCapabilities=t.detectRtcCapabilities=void 0;const n=a(i(70)),o=a(i(130)),d=i(144);let c=null;async function l(){const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();(null==t?void 0:t.sdp.indexOf("a=rtcp-fb:111"))&&-1===t.sdp.indexOf("a=rtcp-fb:111 nack")&&(t.sdp=t.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack"));let i=!1;try{await e.getStats((()=>{}))}catch(e){"TypeError"===e.name&&(i=!0)}try{e.close()}catch(e){}const r=n.parse(t.sdp),s=o.extractRtpCapabilities({sdpObject:r});d.addNackSuppportForOpus(s);const a={nativeRtpCapabilities:s,isIOS:i};return c=a,a}catch(t){try{e.close()}catch(e){}throw t}}t.detectRtcCapabilities=l,t.getNativeRtpCapabilities=async function(){c||(c=await l());try{return JSON.parse(JSON.stringify(c.nativeRtpCapabilities))}catch(e){return c.nativeRtpCapabilities}},t.isIosFromRtpStats=function(){return null==c?void 0:c.isIOS}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCCanvas=void 0;const r=i(127);t.RTCCanvas=class{constructor(e,t){this.isAppend=!1,this.title=e,this.isAppend=t,this.createCanvas()}get _canvas(){return this.canvas}get _ctx(){return this.ctx}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=r.get2DContext(this.canvas),this.isAppend&&document.body.appendChild(this.canvas)}setSize(e,t){this.canvas&&(this.canvas.width=e,this.canvas.height=t)}destroy(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isAppend&&document.body.removeChild(this.canvas),this.canvas=null}}},function(e,t,i){e.exports=u;var r,s=i(63),a=s.LongBits,n=s.base64,o=s.utf8;function d(e,t,i){this.fn=e,this.len=t,this.next=void 0,this.val=i}function c(){}function l(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function u(){this.len=0,this.head=new d(c,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(u.create=function(){return new r})()}:function(){return new u}};function p(e,t,i){t[i]=255&e}function m(e,t){this.len=e,this.next=void 0,this.val=t}function f(e,t,i){for(;e.hi;)t[i++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[i++]=127&e.lo|128,e.lo=e.lo>>>7;t[i++]=e.lo}function g(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}u.create=h(),u.alloc=function(e){return new s.Array(e)},s.Array!==Array&&(u.alloc=s.pool(u.alloc,s.Array.prototype.subarray)),u.prototype._push=function(e,t,i){return this.tail=this.tail.next=new d(e,t,i),this.len+=t,this},m.prototype=Object.create(d.prototype),m.prototype.fn=function(e,t,i){for(;e>127;)t[i++]=127&e|128,e>>>=7;t[i]=e},u.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new m((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},u.prototype.int32=function(e){return e<0?this._push(f,10,a.fromNumber(e)):this.uint32(e)},u.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},u.prototype.uint64=function(e){var t=a.from(e);return this._push(f,t.length(),t)},u.prototype.int64=u.prototype.uint64,u.prototype.sint64=function(e){var t=a.from(e).zzEncode();return this._push(f,t.length(),t)},u.prototype.bool=function(e){return this._push(p,1,e?1:0)},u.prototype.fixed32=function(e){return this._push(g,4,e>>>0)},u.prototype.sfixed32=u.prototype.fixed32,u.prototype.fixed64=function(e){var t=a.from(e);return this._push(g,4,t.lo)._push(g,4,t.hi)},u.prototype.sfixed64=u.prototype.fixed64,u.prototype.float=function(e){return this._push(s.float.writeFloatLE,4,e)},u.prototype.double=function(e){return this._push(s.float.writeDoubleLE,8,e)};var v=s.Array.prototype.set?function(e,t,i){t.set(e,i)}:function(e,t,i){for(var r=0;r<e.length;++r)t[i+r]=e[r]};u.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(p,1,0);if(s.isString(e)){var i=u.alloc(t=n.length(e));n.decode(e,i,0),e=i}return this.uint32(t)._push(v,t,e)},u.prototype.string=function(e){var t=o.length(e);return t?this.uint32(t)._push(o.write,t,e):this._push(p,1,0)},u.prototype.fork=function(){return this.states=new l(this),this.head=this.tail=new d(c,0,0),this.len=0,this},u.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new d(c,0,0),this.len=0),this},u.prototype.ldelim=function(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this},u.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t},u._configure=function(e){r=e,u.create=h(),r._configure()}},function(e,t,i){e.exports=d;var r,s=i(63),a=s.LongBits,n=s.utf8;function o(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function d(e){this.buf=e,this.pos=0,this.len=e.length}var c,l="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new d(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new d(e);throw Error("illegal buffer")},u=function(){return s.Buffer?function(e){return(d.create=function(e){return s.Buffer.isBuffer(e)?new r(e):l(e)})(e)}:l};function h(){var e=new a(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw o(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw o(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function m(){if(this.pos+8>this.len)throw o(this,8);return new a(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}d.create=u(),d.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,d.prototype.uint32=(c=4294967295,function(){if(c=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return c;if((this.pos+=5)>this.len)throw this.pos=this.len,o(this,10);return c}),d.prototype.int32=function(){return 0|this.uint32()},d.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},d.prototype.bool=function(){return 0!==this.uint32()},d.prototype.fixed32=function(){if(this.pos+4>this.len)throw o(this,4);return p(this.buf,this.pos+=4)},d.prototype.sfixed32=function(){if(this.pos+4>this.len)throw o(this,4);return 0|p(this.buf,this.pos+=4)},d.prototype.float=function(){if(this.pos+4>this.len)throw o(this,4);var e=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},d.prototype.double=function(){if(this.pos+8>this.len)throw o(this,4);var e=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},d.prototype.bytes=function(){var e=this.uint32(),t=this.pos,i=this.pos+e;if(i>this.len)throw o(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,i):t===i?new this.buf.constructor(0):this._slice.call(this.buf,t,i)},d.prototype.string=function(){var e=this.bytes();return n.read(e,0,e.length)},d.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw o(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw o(this)}while(128&this.buf[this.pos++]);return this},d.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},d._configure=function(e){r=e,d.create=u(),r._configure();var t=s.Long?"toLong":"toNumber";s.merge(d.prototype,{int64:function(){return h.call(this)[t](!1)},uint64:function(){return h.call(this)[t](!0)},sint64:function(){return h.call(this).zzDecode()[t](!1)},fixed64:function(){return m.call(this)[t](!0)},sfixed64:function(){return m.call(this)[t](!1)}})}},function(e,t,i){e.exports=s;var r=i(63);function s(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)this[t[i]]=e[t[i]]}s.create=function(e){return this.$type.create(e)},s.encode=function(e,t){return this.$type.encode(e,t)},s.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},s.decode=function(e){return this.$type.decode(e)},s.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},s.verify=function(e){return this.$type.verify(e)},s.fromObject=function(e){return this.$type.fromObject(e)},s.toObject=function(e,t){return this.$type.toObject(e,t)},s.prototype.toJSON=function(){return this.$type.toObject(this,r.toJSONOptions)}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ajax=t.getFormData=void 0;const s=r(i(12)),a=r(i(13)),n=i(124);t.getFormData=e=>Object.keys(e).map((t=>encodeURIComponent(t)+"="+encodeURIComponent(/Object/i.test(e[t])?n.JSONBigStringify(e[t]):e[t]))).join("&"),t.ajax=function(e){if(!e||!e.url)return Promise.reject(new a.default({code:s.default.NETWORK_REQUEST_ERROR,message:"ajax: 参数异常"}));e.dataType=e.dataType||"json";var i=new XMLHttpRequest;i.open(e.type||"GET",e.url,!0),i.responseType=""+e.dataType;const r=e.contentType||"application/json;charset=UTF-8";return i.setRequestHeader("Content-type",r),e.header&&Object.keys(e.header).map((t=>{e.header&&e.header[t]&&i.setRequestHeader(t,e.header[t])})),new Promise(((o,d)=>{i.onload=function(){if(i.status>400)return Promise.reject(new a.default({code:s.default.NETWORK_REQUEST_ERROR,message:"ajax: 响应异常, code: "+i.status}));var e=i.response;o(e)},i.onerror=function(e){d(e)},i.ontimeout=function(t){d({code:456,desc:"ERR_TIMED_OUT "+e.url})},r.indexOf("x-www-form-urlencoded")>=0?e.data?i.send(t.getFormData(e.data)):i.send():e.data?e.header&&"gzip"===e.header["Content-Encoding"]?i.send(e.data):i.send(n.JSONBigStringify(e.data)):i.send()}))}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageBase=void 0,t.StageBase=class{constructor(e){this.enabled=!1,this.node=null,this.state="UNINIT",this.context=e}isTransparent(){return!1}}},function(e,t,i){function r(e,t){return{ARRAY_BUFFER:e.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER:e.ELEMENT_ARRAY_BUFFER}[null!=t?t:"ARRAY_BUFFER"]}function s(e,t){return{STATIC_DRAW:e.STATIC_DRAW,DYNAMIC_DRAW:e.DYNAMIC_DRAW,STREAM_DRAW:e.STREAM_DRAW}[null!=t?t:"STATIC_DRAW"]}function a(e,t){const i={Int8Array:e.BYTE,Uint8Array:e.UNSIGNED_BYTE,Int16Array:e.SHORT,Uint16Array:e.UNSIGNED_SHORT,Int32Array:e.INT,Uint32Array:e.UNSIGNED_INT,Float32Array:e.FLOAT}[Object.prototype.toString.call(t).replace(/object|\[|\]|\s/g,"")];return void 0===i?(console.warn("attribute buffer type error.\n legal type may << Int8Array、Uint8Array、Int16Array、Uint16Array、Float32Array."),e.FLOAT):i}Object.defineProperty(t,"__esModule",{value:!0}),t.parseAttributes=t.createAttributeBuffer=void 0,t.createAttributeBuffer=function(e,t,i,n,o,d,c,l,u){const h=e.createBuffer();if(!h)return console.error("buffer created failed."),null;const p=i.length;return{type:a(e,i),buffer:h,name:t,typedArray:i,itemSize:null!=n?n:1,count:p/(null!=n?n:1)>>0,normalized:null!=c&&c,target:r(e,o),usage:s(e,d),stride:null!=l?l:0,offset:null!=u?u:0}},t.parseAttributes=function(e,t){const i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),n={};for(let o=0;o<i;o++){const i=e.getActiveAttrib(t,o);if(i){const{name:o}=i,d=e.getAttribLocation(t,o);if(null!==d){const t={type:e.FLOAT,buffer:null,typedArray:null,itemSize:1,count:0,normalized:!1,target:r(e),usage:s(e),stride:0,offset:0,setter:i=>{if(i){const{buffer:r}=t;if(!r)return void console.error(`buffer of attribute:[${o}] is not initialized.`);const{type:s}=t;if(a(e,i)!==s)return void console.error(`typedArray's type of attribute:[${o}] is inconsistent.`);t.typedArray=i;const{itemSize:n,normalized:c,target:l,usage:u,stride:h,offset:p}=t;e.bindBuffer(l,r),e.bufferData(l,i,u),e.enableVertexAttribArray(d),e.vertexAttribPointer(d,n,s,c,h,p)}else{const{buffer:i,type:r,itemSize:s,normalized:a,target:n,stride:o,offset:c}=t;e.bindBuffer(n,i),e.vertexAttribPointer(d,s,r,a,o,c)}},bufferSetter:e=>{if(e){const{name:i}=e;i===o&&(t.type=e.type,t.buffer=e.buffer,t.itemSize=e.itemSize,t.count=e.count,t.normalized=e.normalized,t.target=e.target,t.usage=e.usage,t.stride=e.stride,t.offset=e.offset,t.setter(e.typedArray))}},get attributeBuffer(){return null===t.buffer?null:{type:t.type,buffer:t.buffer,name:o,typedArray:t.typedArray,itemSize:t.itemSize,count:t.count,normalized:t.normalized,target:t.target,usage:t.usage,stride:t.stride,offset:t.offset}}};n[o]=t}else console.warn(`attribute:[${o}] is null.`)}}return n}},,,function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.checkSystemRequirements=t.systemChecker=void 0,t.systemChecker=new class{constructor(){this.checkCnt=0}checkSystemRequirements(){this.checkCnt++;const e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;return e?e.prototype.getSenders&&e.prototype.addTransceiver&&e.prototype.getTransceivers||e.prototype.addStream?!!window.WebSocket||(console.warn("checkSystemRequirements: 没有 WebSocket 对象。"),!1):(console.warn("checkSystemRequirements: RTCPeerConnection不符合sdk要求"),!1):(console.warn("checkSystemRequirements: 没有 RTCPeerConnection 对象。"),!1)}},t.checkSystemRequirements=function(){return t.systemChecker.checkSystemRequirements()}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AuidoMixingState=void 0,t.AuidoMixingState={UNSTART:"MIX_UNSTART",STARTING:"MIX_STARTING",PLAYED:"MIX_PLAYING",PAUSED:"MIX_PAUSED",STOPED:"MIX_STOPED"}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isHttpProtocol=t.checkBrowserCompatibility=t.isBrowserSupported=t.isPullStreamSupported=t.isPushStreamSupported=t.RtcSupport=void 0;const n=i(119),o=i(60),d=a(i(14)),c=i(120);let l={isPullStreamSupport:!1,isPushStreamSupport:!1,isScreenShareSupport:!1},u={video:[],audio:[]},h={video:[],audio:[]};var p=null;d.IS_IOS&&d.IS_WECHAT||(p=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var m=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,f=window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,g=window.MediaStream=window.MediaStream||window.webkitMediaStream;function v(e){let t;return t||(t=document.createElement("video")),!!t.canPlayType({ogg:'video/ogg; codecs="theora"',h264:'video/mp4; codecs="avc1.42E01E"',webm:'video/webm; codecs="vp8, vorbis"',vp9:'video/webm; codecs="vp9"',hls:'application/x-mpegURL; codecs="avc1.42E01E"'}[e]||e)}const _={WebRTC:!!f&&!!g,RTCPeerConnection:!!f,Vp8:v("webm"),Vp9:v("vp9"),H264:v("h264"),GetUserMedia:!!p&&!!navigator.mediaDevices,DataChannel:!!(f&&"undefined"!=typeof RTCDataChannel&&f.prototype&&f.prototype.createDataChannel),WebAudio:!(!m||!m.prototype.createMediaStreamSource),MediaStream:!!g};function y(){let e=c.getBrowserInfo().browserName,t=c.getBrowserInfo().browserVersion;return t=t&&t.match(/\d+/)[0],{prefix:e,version:t}}const S={checkWebRtc:()=>_,checkWebAudio:()=>({WebAudio:_.WebAudio,MediaStream:_.MediaStream}),checkCompatibility(){let e=Object.assign(y(),{system:c.getOSInfo().osName+" "+c.getOSInfo().osVersion,browser:c.getBrowserInfo().browserName,version:c.getBrowserInfo().browserVersion});return new Promise((function(t,i){(async()=>{const i=Object.assign(e,_,{ScreenSharing:!1}),r=await n.Device.getDevices({audiooutput:!0,audioinput:!0,videoinput:!0,requestPerm:!0}).catch((e=>t(i)));i.MicrophoneList=r&&r.audioIn||[],i.CameraList=r&&r.video||[],i.Microphone=r&&r.audioIn&&r.audioIn.length>0||!1,i.Camera=r&&r.video&&r.video.length>0||!1,t(i)})()}))},checkVersion:()=>y()};t.RtcSupport=S;const R=function(){return["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection"].filter((e=>e in window)).length>0},b=function(){return!!window.WebSocket&&!!window.WebSocket.prototype.send};async function E(){return await async function(){return!!u.video.length||(u=await o.getSupportedCodecs("send"),u.video.indexOf("H264")>-1||u.video.indexOf("VP8")>-1)}()&&R()&&b()&&function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter((e=>e in navigator.mediaDevices)).length===e.length}()&&async function(){return!!f.prototype.getStats||!!RTCRtpSender.prototype.getStats}()}async function T(){return await async function(){return!!h.video.length||(h=await o.getSupportedCodecs("recv"),h.video.indexOf("H264")>-1||h.video.indexOf("VP8")>-1)}()&&R()&&b()&&async function(){return!!f.prototype.getStats||!!RTCRtpReceiver.prototype.getStats}()}t.isPushStreamSupported=E,t.isPullStreamSupported=T,t.isBrowserSupported=function(){return!(!(d.IS_CHROME&&d.CHROME_MAJOR_VERSION>=72)&&!(d.IS_MAC_SAFARI&&d.SAFARI_MAJOR_VERSION>=12)&&(!(d.IS_IOS_SAFARI&&d.SAFARI_MAJOR_VERSION>=13)||d.IS_WECHAT)&&!(d.IS_EDG&&d.EDG_MAJOR_VERSION>=80)&&!(d.IS_FIREFOX&&d.FIREFOX_MAJOR_VERSION>=66)&&(!d.IS_IOS||!d.IS_MQQB)&&!(d.IS_IOS&&d.IOS_VERSION&&parseFloat(d.IOS_VERSION)>=14.3&&d.IS_WECHAT&&d.WECHAT_VERSION&&parseFloat(d.WECHAT_VERSION)>=6.5)&&(!d.IS_ANDROID||!d.IS_TBS&&!d.IS_XWEB))},t.checkBrowserCompatibility=async function(){const e=function(){if(d.IS_ELECTRON)return!0;{let e=navigator.mediaDevices;return!(!e||!e.getDisplayMedia)}}(),t=await E(),i=await T();return l.isScreenShareSupport=e,l.isPushStreamSupport=t,l.isPullStreamSupport=i,l};const A="file:"===location.protocol||"localhost"===location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);t.isHttpProtocol=function(){return"http:"===location.protocol&&!A}},function(e,t){var i={utf8:{stringToBytes:function(e){return i.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(i.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}};e.exports=i},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.parseScalabilityMode=t.Device=t.detectDevice=t.version=t.types=void 0;const n=i(169);Object.defineProperty(t,"detectDevice",{enumerable:!0,get:function(){return n.detectDevice}}),Object.defineProperty(t,"Device",{enumerable:!0,get:function(){return n.Device}});const o=a(i(240));t.types=o,t.version="__MEDIASOUP_CLIENT_VERSION__";var d=i(243);Object.defineProperty(t,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}})},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.detectDevice=void 0;const n=i(128),o=i(121),d=i(222),c=i(230),l=i(236),u=i(237),h=i(38),p=a(i(122)),m=i(172),f=a(i(61)),g=a(i(14)),v=i(120),_=i(154),y="Device";function S(){return"object"==typeof navigator&&"string"==typeof navigator.userAgent?g.IS_CHROME_ONLY&&g.CHROME_MAJOR_VERSION&&g.CHROME_MAJOR_VERSION>=58&&g.CHROME_MAJOR_VERSION<69?"Chrome62":g.IS_CHROME_ONLY&&g.CHROME_MAJOR_VERSION&&g.CHROME_MAJOR_VERSION>=69?"Chrome74":g.IS_ANDROID?g.ANY_CHROME_MAJOR_VERSION&&g.ANY_CHROME_MAJOR_VERSION>=58&&g.ANY_CHROME_MAJOR_VERSION<69?"Chrome62":"Chrome74":g.IS_ELECTRON&&g.IS_CHROME_ONLY&&g.ANY_CHROME_MAJOR_VERSION&&g.ANY_CHROME_MAJOR_VERSION>=69?"Chrome74":g.IS_FIREFOX&&g.FIREFOX_MAJOR_VERSION&&g.FIREFOX_MAJOR_VERSION>=58?"Firefox60":g.IS_ANY_SAFARI&&g.SAFARI_MAJOR_VERSION&&g.SAFARI_MAJOR_VERSION>=12||g.IS_ANY_SAFARI&&g.IS_WECHAT||_.isIosFromRtpStats()?"Safari12":(h.Logger.warn(y,"this._detectDevice() | browser not supported [name:%s, version:%s], using Chrome72 as default",v.getBrowserInfo().browserName,v.getBrowserInfo().browserVersion),"Chrome74"):(h.Logger.warn(y,"this._detectDevice() | unknown device, using Chrome 72 as default"),"Chrome74")}t.detectDevice=S,t.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new n.EnhancedEventEmitter,h.Logger.debug(y,"constructor()"),i){if(h.Logger.warn(y,"constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof i)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=i}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)h.Logger.debug(y,"constructor() | handler given: %s",e);else{if(!(e=S()))throw new o.UnsupportedError("device not supported");h.Logger.debug(y,"constructor() | detected handler: %s",e)}switch(e){case"Chrome62":this._handlerFactory=c.Chrome62.createFactory();break;case"Chrome74":this._handlerFactory=d.Chrome74.createFactory();break;case"Safari12":this._handlerFactory=u.Safari12.createFactory();break;case"Firefox60":this._handlerFactory=l.Firefox60.createFactory();break;default:h.Logger.warn(`unknown browser handlerName "${e}, using Chrome 74 as default"`),this._handlerFactory=d.Chrome74.createFactory()}}const r=this._handlerFactory();this._handlerName=r.name,r.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new o.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new o.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){let t;h.Logger.debug(y,"load()"),e=f.clone(e,void 0);try{if(this._loaded)throw new o.InvalidStateError("already loaded");p.validateRtpCapabilities(e),t=this._handlerFactory();const i=await t.getNativeRtpCapabilities();h.Logger.debug(y,"load() | got native RTP capabilities"),p.validateRtpCapabilities(i),this._extendedRtpCapabilities=p.getExtendedRtpCapabilities(i,e),h.Logger.debug(y,"load() | got extended RTP capabilities"),this._canProduceByKind.audio=p.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=p.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=p.getRecvRtpCapabilities(this._extendedRtpCapabilities),p.validateRtpCapabilities(this._recvRtpCapabilities),h.Logger.debug(y,"load() | got receiving RTP capabilities"),this._sctpCapabilities=await t.getNativeSctpCapabilities(),h.Logger.debug(y,"load() | got native SCTP capabilities"),p.validateSctpCapabilities(this._sctpCapabilities),h.Logger.debug(y,"load() succeeded"),this._loaded=!0,t.close()}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new o.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,appData:c={}}){return h.Logger.debug(y,"createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,appData:c})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,appData:c={}}){return h.Logger.debug(y,"createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,appData:c})}_createTransport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:n,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u={}}){if(!this._loaded)throw new o.InvalidStateError("not loaded");if(u&&"object"!=typeof u)throw new TypeError("if given, appData must be an object");const h=new m.Transport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:n,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}}},function(e,t,i){var r,s="object"==typeof Reflect?Reflect:null,a=s&&"function"==typeof s.apply?s.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(i,r){function s(i){e.removeListener(t,a),r(i)}function a(){"function"==typeof e.removeListener&&e.removeListener("error",s),i([].slice.call(arguments))}v(e,t,a,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&v(e,"error",t,{once:!0})}(e,s)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var d=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,i,r){var s,a,n,o;if(c(i),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),n=a[t]),void 0===n)n=a[t]=i,++e._eventsCount;else if("function"==typeof n?n=a[t]=r?[i,n]:[n,i]:r?n.unshift(i):n.push(i),(s=l(e))>0&&n.length>s&&!n.warned){n.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+n.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=n.length,o=d,console&&console.warn&&console.warn(o)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=h.bind(r);return s.listener=i,r.wrapFn=s,s}function m(e,t,i){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(s):g(s,s.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function v(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(a){r.once&&e.removeEventListener(t,s),i(a)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var n;if(t.length>0&&(n=t[0]),n instanceof Error)throw n;var o=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw o.context=n,o}var d=s[e];if(void 0===d)return!1;if("function"==typeof d)a(d,this,t);else{var c=d.length,l=g(d,c);for(i=0;i<c;++i)a(l[i],this,t)}return!0},o.prototype.addListener=function(e,t){return u(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return u(this,e,t,!0)},o.prototype.once=function(e,t){return c(t),this.on(e,p(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,p(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,r,s,a,n;if(c(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){n=i[a].listener,s=a;break}if(s<0)return this;0===s?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,n||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,a=Object.keys(i);for(r=0;r<a.length;++r)"removeListener"!==(s=a[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return m(this,e,!0)},o.prototype.rawListeners=function(e){return m(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},o.prototype.listenerCount=f,o.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Transport=void 0;const n=i(239),o=a(i(14)),d=i(2),c=i(173),l=i(128),u=i(121),h=i(38),p=a(i(122)),m=i(174),f=a(i(61)),g="Transport";let v=0;class _ extends l.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:p,appData:m,handlerFactory:_,extendedRtpCapabilities:y,canProduceByKind:S}){super(),this.idx=++v,this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new n.AwaitQueue({ClosedErrorClass:u.InvalidStateError}),this._observer=new l.EnhancedEventEmitter,this.send=[],this.recv=[],h.Logger.debug(g,`constructor() [id: ${t}, direction: ${e}]`),this._id=t,this._direction=e,this._extendedRtpCapabilities=y,this._canProduceByKind=S,this._maxSctpMessageSize=a?a.maxMessageSize:null,delete(c=f.clone(c,{})).iceServers,delete c.iceTransportPolicy,delete c.bundlePolicy,delete c.rtcpMuxPolicy,delete c.sdpSemantics,this._handler=_(),this._handler.run({direction:e,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:p,extendedRtpCapabilities:y,appData:m}),this._appData=m,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){if(!this._closed){h.Logger.debug(g,"close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new u.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(h.Logger.debug(g,"restartIce()"),this._closed)throw new u.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push((async()=>this._handler.restartIce(e)),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(h.Logger.debug(g,"updateIceServers()"),this._closed)throw new u.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._handler.updateIceServers(e)}async produce({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,stopTracks:a=!1,disableTrackOnPause:n=!0,zeroRtpOnPause:o=!1,appData:d}){if(h.Logger.debug(g,"produce()"),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new u.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new u.UnsupportedError("cannot produce "+e.kind);if("ended"===e.readyState)throw new u.InvalidStateError("track ended");if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(d&&"object"!=typeof d)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push((async()=>{let c;if(i&&!Array.isArray(i))throw TypeError("encodings must be an array");i&&0===i.length?c=void 0:i&&(c=i.map((e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"==typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t})));const{localId:l,localIdLow:u,rtpParameters:h,rtpSender:f,rtpSenderLow:g,dtlsParameters:v,offer:_}=await this._handler.send({track:e,trackLow:t,encodings:c,codecOptions:r,appData:d,codec:s});f&&this.updateSenderInfo(f,"screenShare"===d.mediaType?"screen":d.mediaType,"high",l),g&&u&&this.updateSenderInfo(g,"screenShare"===d.mediaType?"screen":d.mediaType,"low",u);try{p.validateRtpParameters(h);const{id:i}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:h,track:e,trackLow:t,appData:d,localDtlsParameters:v,offer:_}),r=new m.Producer({id:i,localId:l,localIdLow:u,rtpSender:f,rtpSenderLow:g,track:e,trackLow:t,rtpParameters:h,stopTracks:a,disableTrackOnPause:n,zeroRtpOnPause:o,appData:d});return this._producers.set(r.id,r),this._handleProducer(r),this._observer.safeEmit("newproducer",r),r}catch(e){throw this._handler.stopSending(l,d.mediaType).catch((()=>{})),e}}),"transport.produce()").catch((e=>{throw e}))}async fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:n,codecOptions:o,offer:d,audioProfile:c,codec:l}){await this._handler.fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:n,codecOptions:o,offer:d,codec:l,audioProfile:c})}async prepareLocalSdp(e,t,i){try{const{dtlsParameters:r,rtpCapabilities:s,offer:a,mid:n,iceUfragReg:o}=await this._handler.prepareLocalSdp(e,i);if(!this._recvRtpCapabilities||!p.canSend("audio",this._recvRtpCapabilities)||!p.canSend("video",this._recvRtpCapabilities)){let e=p.getExtendedRtpCapabilities(s,t);this._recvRtpCapabilities=p.getRecvRtpCapabilities(e),p.validateRtpCapabilities(this._recvRtpCapabilities)}return{dtlsParameters:r,rtpCapabilities:this._recvRtpCapabilities,offer:a,mid:n,iceUfragReg:o}}catch(e){throw e}}async recoverLocalSdp(e,t,i){if(!(o.ANY_CHROME_MAJOR_VERSION&&o.ANY_CHROME_MAJOR_VERSION>=58&&o.ANY_CHROME_MAJOR_VERSION<69))try{return void await this._handler.recoverTransceiver(e,t,i)}catch(e){throw e}}updateSenderInfo(e,t,i,r){let s=this.send.find((t=>t.sender===e));return s?(s.mediaType!==t||s.streamType||i||s.localId!==r)&&(h.Logger.debug(g,`Sender Change. mediaType:${s.mediaType} => ${t}, StreamType: ${s.streamType} => ${i}, LocalId: ${s.localId} => ${r} index: ${s.index}`),s.mediaType=t,s.streamType=i,s.localId=r,s.index=0):(s={sender:e,mediaType:t,streamType:i,localId:r,index:0},this.send.unshift(s)),s}updateReceiverInfo(e,t,i,r){let s=this.recv.find((t=>t.receiver===e));return s?s.uid===t&&s.mediaType===i&&s.localId===r||(h.Logger.debug(g,`Receiver Change. uid:${s.uid} => ${t}, mediaType:${s.mediaType} => ${i} localId: ${s.localId} => ${r} index: ${s.index}`),s.uid=t,s.mediaType=i,s.localId=r,s.index=0):(s={receiver:e,uid:t,mediaType:i,localId:r,index:0},this.recv.unshift(s)),s}async consume({id:e,producerId:t,kind:i,uid:r,mediaType:s,rtpParameters:a,appData:n={},offer:o,iceParameters:l,iceCandidates:p,dtlsParameters:m,sctpParameters:v,probeSSrc:_}){if(h.Logger.debug(g,"consume()"),a=f.clone(a,void 0),this._closed)throw new u.InvalidStateError("closed");if("recv"!==this._direction)throw new u.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==i&&"video"!==i)throw new TypeError(`invalid kind '${i}'`);if(n&&"object"!=typeof n)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push((async()=>{const{localId:u,rtpReceiver:f,track:y}=await this._handler.receive({iceParameters:l,iceCandidates:p,dtlsParameters:m,sctpParameters:v,trackId:e,kind:i,rtpParameters:a,offer:o,probeSSrc:_,remoteUid:n.remoteUid,extendedRtpCapabilities:this._extendedRtpCapabilities,appData:n});f&&(this.updateReceiverInfo(f,r,s,u),"audio"===f.track.kind&&d.getParameters().audioPlayoutDelayHint&&(f.playoutDelayHint=d.getParameters().audioPlayoutDelayHint,h.Logger.debug(g,"audioPlayoutDelayHint: ",d.getParameters().audioPlayoutDelayHint)),"video"===f.track.kind&&d.getParameters().videoPlayoutDelayHint&&(f.playoutDelayHint=d.getParameters().videoPlayoutDelayHint,h.Logger.debug(g,"videoPlayoutDelayHint: ",d.getParameters().videoPlayoutDelayHint)));const S=new c.Consumer({id:e,localId:u,producerId:t,rtpReceiver:f,track:y,rtpParameters:a,appData:n});return this._consumers.set(S.id,S),this._handleConsumer(S),this._observer.safeEmit("newconsumer",S),S}),"transport.consume()")}_handleHandler(){const e=this._handler;e.on("@connect",(({dtlsParameters:e},t,i)=>{this._closed?i(new u.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,i)})),e.on("@connectionstatechange",(e=>{e!==this._connectionState&&(h.Logger.debug(g,"connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))}))}_handleProducer(e){e.on("@close",(()=>{this._closed||(h.Logger.debug(g,"producer 关闭: ",e.localId),this._awaitQueue.push((async()=>this._handler.stopSending(e.localId,e.appData.mediaType))).catch((e=>h.Logger.warn(g,"producer.close() failed:%o",e))))})),e.on("@replacetrack",((t,i,r)=>{this._awaitQueue.push((async()=>this._handler.replaceTrack(e.localId,t)),"producer @replacetrack event").then(i).catch(r)})),e.on("@setmaxspatiallayer",((t,i,r)=>{this._awaitQueue.push((async()=>this._handler.setMaxSpatialLayer(e.localId,t)),"producer @setmaxspatiallayer event").then(i).catch(r)})),e.on("@setrtpencodingparameters",((t,i,r)=>{this._awaitQueue.push((async()=>this._handler.setRtpEncodingParameters(e.localId,t)),"producer @setrtpencodingparameters event").then(i).catch(r)})),e.on("@getstats",((t,i)=>{if(this._closed)return i(new u.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)}))}_handleConsumer(e){e.on("@close",(()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push((async()=>this._handler.stopReceiving(e.localId)),"consumer @close event").catch((()=>{}))})),e.on("@getstats",((t,i)=>{if(this._closed)return i(new u.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)}))}}t.Transport=_},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Consumer=void 0;const r=i(128),s=i(121),a=i(38),n="Consumer";class o extends r.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:s,track:o,rtpParameters:d,appData:c}){super(),this._closed=!1,this._observer=new r.EnhancedEventEmitter,a.Logger.debug(n,"constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=s,this._track=o,this._rtpParameters=d,this._paused=!o.enabled,this._appData=c,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){this._closed||(a.Logger.debug(n,"close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(a.Logger.debug(n,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new s.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){a.Logger.debug(n,"pause()"),this._closed?a.Logger.error(n,"pause() | Consumer closed"):this._paused?a.Logger.debug("pause() | Consumer is already paused"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"))}resume(){a.Logger.debug(n,"resume()"),this._closed?a.Logger.error(n,"resume() | Consumer closed"):this._paused?(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume")):a.Logger.debug("resume() | Consumer is already resumed")}_onTrackEnded(){a.Logger.debug(n,'track "ended" event, %o, %s',this.id,this.kind),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){a.Logger.debug(n,"don not stop receiver track")}}t.Consumer=o},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Producer=void 0;const n=a(i(14)),o=i(2),d=i(128),c=i(121),l=i(38),u="Producer";class h extends d.EnhancedEventEmitter{constructor({id:e,localId:t,localIdLow:i,rtpSender:r,rtpSenderLow:s,track:a,trackLow:n,rtpParameters:o,stopTracks:c,disableTrackOnPause:h,zeroRtpOnPause:p,appData:m}){super(),this._closed=!1,this._observer=new d.EnhancedEventEmitter,l.Logger.debug(u,"constructor()",t),this._id=e,this._localId=t,this._localIdLow=i,this._rtpSender=r,this._rtpSenderLow=s,this._track=a,this._trackLow=n,this._kind=a.kind,this._rtpParameters=o,this._paused=!!h&&!a.enabled,this._maxSpatialLayer=void 0,this._stopTracks=c,this._disableTrackOnPause=h,this._zeroRtpOnPause=p,this._appData=m,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){}get observer(){return this._observer}close(){this._closed||(l.Logger.debug(u,"close()"),this._closed=!0,this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(l.Logger.debug(u,"transportClosed()"),this._closed=!0,this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new c.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){l.Logger.debug(u,"pause()"),this._closed?l.Logger.error(u,"pause() | Producer closed"):(this._paused=!0,n.SAFARI_VERSION&&15.1===parseFloat(n.SAFARI_VERSION)||this._disableTrackOnPause&&(this._track&&(this._track.enabled=!1),this._trackLow&&(this._trackLow.enabled=!1)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch((()=>{})),this._observer.safeEmit("pause"))}resume(){l.Logger.debug(u,"resume()"),this._closed?l.Logger.error(u,"resume() | Producer closed"):(this._paused=!1,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!0),this._trackLow&&(this._trackLow.enabled=!0)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch((()=>{})),this._observer.safeEmit("resume"))}async replaceTrack({track:e}){if(l.Logger.debug(u,"replaceTrack()"),this._closed){if(e&&this._stopTracks)try{if("audio"===e.kind){const t=o.getParameters().tracks.audio.findIndex((t=>e===t));l.Logger.warn(`Stopping AUDIOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}else{const t=o.getParameters().tracks.video.findIndex((t=>e===t));l.Logger.warn(`Stopping VIDEOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}e.stop()}catch(e){}throw new c.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new c.InvalidStateError("track ended");e!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):l.Logger.debug(u,"replaceTrack() | same track, ignored")}async setMaxSpatialLayer(e){if(this._closed)throw new c.InvalidStateError("closed");if("video"!==this._kind)throw new c.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new c.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e)}_onTrackEnded(){l.Logger.debug(u,'track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){this._track&&l.Logger.warn(u,"don not stop sender track")}}t.Producer=h},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getRTCTimer=void 0;const r=i(123);class s{constructor(e={from:{native:!0,worker:!0,webAudio:!0},minInterval:8}){this.history=[],this.timers=[void 0],this.worker=null,this.options=e;const t=e=>{const t={source:e,ts:Date.now()},i=this.history[this.history.length-1];if(!(i&&t.ts-i.ts<this.options.minInterval)){this.history.push(t),this.history.length>1e3&&this.history.shift();for(let i=0;i<this.timers.length;i++){const r=this.timers[i];if(r&&!(r.cntMax<=r.cnt||t.ts-r.lastCalledAt<r.interval-1)){r.cnt++,r.lastCalledAt=t.ts;try{r.handler()}catch(e){console.error(e)}}}}};e.from.native&&(this.nativeTimer=setInterval((()=>{t("native")}),this.options.minInterval)),e.from.worker&&void 0!==typeof Worker&&(this.worker=new Worker(r.getBlobUrl("rtcTimer")),this.worker.onmessage=()=>{t("worker")})}setInterval(e,t){const i={handler:e,id:this.timers.length,interval:t,lastCalledAt:Date.now(),cnt:0,cntMax:Number.MAX_SAFE_INTEGER};return this.timers.push(i),i.id}clearInterval(e){if(!e)return;const t=this.timers[e];t&&(t.id===e?delete this.timers[e]:console.error("timer错位",e,t))}}let a=null;t.getRTCTimer=function(){return a||(a=new s),a}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevel=void 0;const r=i(11),s=i(123),a=i(67);let n="NOTREADY",o=null;class d extends r.EventEmitter{constructor(e){super(),this.volume=0,this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.support=null,this.logger=e.logger.getChild((()=>{let e="AudioLevel";return e+="READY"!==n?" "+n:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e}));const t=a.getAudioContext(),i=e.stream;t&&(this.support={stream:i,context:t},this.updateStream(i,e.sourceNode))}async updateStream(e,t){var i;if(this.logger.log("AudioLevel updateStream"),this.support){if(!t&&e.getAudioTracks().length>0)try{t=this.support.context.createMediaStreamSource(e)}catch(i){if("TypeError"!==i.name)return void this.logger.error("无法创建MediaStreamAudioSourceNode",i.name,i.message);t=new MediaStreamAudioSourceNode(this.support.context,{mediaStream:e})}if(this.support.sourceNode&&this.support.sourceNode.disconnect(),this.support.sourceNode=t,!this.support.audioWorkletNode){if(!this.support.context.audioWorklet)return void this.logger.error("该环境不支持音量模块");o?"LOADING"===n&&await o:(n="LOADING",this.logger.log("正在载入音量模块"),o=this.support.context.audioWorklet.addModule(s.getBlobUrl("volumeProcessor")),await o,n="READY",this.logger.log("载入音量模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"vumeter"),this.support.audioWorkletNode.port.onmessage=e=>{var t,i;const r=Date.now(),s=Math.floor(r);if(this.volume=e.data.volume,e.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===s||this.left.history.unshift({sec:s,sum:0}),this.left.volume=e.data.left,this.left.history[0].sum+=e.data.left,this.left.history.length>2&&this.left.history.pop();else{const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(e.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===s||this.right.history.unshift({sec:s,sum:0}),this.right.volume=e.data.right,this.right.history[0].sum+=e.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(t=this.left)||void 0===t?void 0:t.history[1])&&(null===(i=this.right)||void 0===i?void 0:i.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}}}}null===(i=this.support.sourceNode)||void 0===i||i.connect(this.support.audioWorkletNode);const r=a.getAudioLevelDestination();r&&this.support.audioWorkletNode.connect(r),this.volume=0}}getAudioLevel(){return this.volume}destroy(){this.logger.log("destroy() AudioLevel模块")}}t.AudioLevel=d},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.forceAudioConstraints=t.set3AConstraint=t.patchScreenConstraints=void 0;const s=i(2),a=r(i(12)),n=r(i(13));function o(e,t,i){if(e&&"boolean"==typeof i)switch(t){case"AEC":e.echoCancellation=i,e.googEchoCancellation=i,e.googEchoCancellation2=i;break;case"ANS":e.noiseSuppression=i,e.googNoiseSuppression=i,e.googNoiseSuppression2=i;break;case"AGC":e.autoGainControl=i,e.googAutoGainControl=i,e.googAutoGainControl2=i}}t.patchScreenConstraints=function(e,t){if("default"!==s.getParameters().screenFocus)try{if("undefined"!=typeof CaptureController){const i=new CaptureController;i.setFocusBehavior(s.getParameters().screenFocus),e.controller=i,t.log("屏幕共享跳转控制："+s.getParameters().screenFocus)}else t.log("当前浏览器不支持屏幕共享跳转控制:"+s.getParameters().screenFocus)}catch(e){}if("default"!==s.getParameters().screenDisplaySurface&&e.video&&(e.video.displaySurface=s.getParameters().screenDisplaySurface),"default"!==s.getParameters().screenSurfaceSwitching&&(e.surfaceSwitching=s.getParameters().screenSurfaceSwitching),s.getParameters().screenPreferCurrentTab&&(e.preferCurrentTab=s.getParameters().screenPreferCurrentTab),"default"!==s.getParameters().screenSelfBrowserSurface&&(e.selfBrowserSurface=s.getParameters().screenSelfBrowserSurface),e.preferCurrentTab&&"exclude"===e.selfBrowserSurface)throw t.log("屏幕共享参数 preferCurrentTab: true 和 selfBrowserSurface: 'exclude' 互斥，不能同时存在"),new n.default({code:a.default.INVALID_PARAMETER_ERROR,message:"screenShare: preferCurrentTab: true 和 selfBrowserSurface: 'exclude' 互斥，不能同时存在"})},t.set3AConstraint=o,t.forceAudioConstraints=function(e){"no"!==s.getParameters().forceAEC&&o(e,"AEC","on"===s.getParameters().forceAEC),"no"!==s.getParameters().forceANS&&o(e,"ANS","on"===s.getParameters().forceANS),"no"!==s.getParameters().forceAGC&&o(e,"AGC","on"===s.getParameters().forceAGC),-1!==s.getParameters().forceChannelCount&&(e.channelCount=s.getParameters().forceChannelCount),-1!==s.getParameters().forceSampleRate&&(e.sampleRate=s.getParameters().forceSampleRate),-1!==s.getParameters().forceLatency&&(e.latency=s.getParameters().forceLatency)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DataReport=void 0;const r=i(57),s=i(14),a=i(258);let n="https://statistic.live.126.net/statics/report/common/form";t.DataReport=class{constructor(e){this.configs=e||{};const t=e.adapterRef;e.sdkRef,this.adapterRef=t;let i=t.instance,r=t.channelInfo||{};this.cid=r.cid||r.channelId||0,this.uid=r.uid||0;const s=i._params&&i._params.appkey;this.time=r.clientNtpTime-r.T4,this.common={name:"common",ver:"2.0",sdk_type:"nrtc2",session_id:this.adapterRef.deviceId,app_key:s},this.eventKeys=[],this.eventMap={},this.api=[],this.heartbeat=null}addEvent(e,t){return-1==this.eventKeys.indexOf(e)&&this.eventKeys.push(e),t.time?t.time=t.time+this.time:(this.adapterRef.logger.warn(`addEvent:事件${e}没有time属性。使用当前时间戳`),t.time=Date.now()),this.eventMap[e]=t,this}updateCommon(e){return Object.assign(this.common,e),this}setHeartbeat(e){this.heartbeat=e;const t=Object.keys(this.adapterRef.apiEvent),i=Object.keys(this.adapterRef.apiEvents),r=t.concat(i.filter((e=>!t.includes(e))));let s=[];for(let e in r){const t=r[e];this.adapterRef.apiEvents[t]&&this.adapterRef.apiEvents[t].length?(s=s.concat(this.adapterRef.apiEvents[t]),this.adapterRef.apiEvents[t]=[]):this.adapterRef.apiEvent[t]&&this.adapterRef.apiEvent[t].length&&(s=s.concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}return this.api=this.api.concat(s),this}setNetworkChange(e){return this.addEvent("networkChange",e),this}setLogin(e){var t,i,n;e.sdk_ver=e.sdk_ver||r.SDK_VERSION,e.platform=e.platform||"Web",e.app_key=e.app_key||this.common.app_key,e.meeting_mode=e.meeting_mode||1,e.model=e.model,e.build=r.BUILD,e.supported_codec_send=null===(t=this.adapterRef.mediaCapability.supportedCodecSend)||void 0===t?void 0:t.join(","),e.supported_codec_recv=null===(i=this.adapterRef.mediaCapability.supportedCodecRecv)||void 0===i?void 0:i.join(","),e.preferred_codec_send=null===(n=this.adapterRef.mediaCapability.preferredCodecSend.video)||void 0===n?void 0:n.join(","),e.extra_info=JSON.stringify({proc:a.processManager.processId,page:a.processManager.pageId,brow:a.processManager.browserId,userAgent:s.USER_AGENT}),e.lbs_addrs=this.adapterRef.lbsManager.getReportField("nrtc"),this.addEvent("login",e)}setRelogin(e){this.addEvent("relogin",e)}setLogout(e){this.addEvent("logout",e)}deviceAbnormal(e){this.addEvent("deviceAbnormal",e)}setDisconnect(e){this.addEvent("disconnect",e)}setRecvFirstFrame(e){this.addEvent("recvFirstFrame",e)}setSendFirstPackage(e){this.addEvent("firstPacketSent",e)}setRecvFirstPackage(e){this.addEvent("recvFirstPackage",e)}setFunction(e){this.addEvent("function",e)}setRequestLbs(e){this.addEvent("requestLBS",e)}setAudioVideoBanned(e){this.addEvent("audioVideoBanned",e)}setStreamException(e){this.addEvent("streamException",e)}setUserCustomEvent(e){this.addEvent("userCustomEvent",e)}setException(e){this.addEvent("exception",e)}reset(){this.eventKeys=[],this.api=[],this.heartbeat=null}send(e){let t={common:this.common};if(e||(e=this.eventKeys),this.heartbeat&&(t.heartbeat=this.heartbeat,this.api.length&&(this.api.forEach((e=>{e.uid||(e.uid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid),e.cid||(e.cid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid),e.param&&"object"==typeof e.param&&void 0!==e.param.clientUid&&(e.param.clientUid=e.uid)})),t.event={apiEvent:this.api},this.api=[])),e){if(e.length){let i=0,r={};for(let t=e.length-1;t>=0;t--){const s=e[t];this.eventMap[s]&&(i++,r[s]=this.eventMap[s],delete this.eventMap[s],e.splice(t,1))}i&&(t.event=r)}}else if(!this.heartbeat)return this;return this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer&&(n=this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer),this.adapterRef.lbsManager.ajax({type:"post",url:n,data:t,header:{sdktype:this.common.sdk_type,appkey:this.common.app_key,platform:"web",sdkver:r.SDK_VERSION}}).then((t=>{e===this.eventKeys&&this.reset()})).catch((e=>{this.adapterRef.logger.log("dataReport, send error: ",e.name,e.message,e),this.reset()})),this}}},function(e,t,i){e.exports=i(262)},function(e,t,i){e.exports=function(e,t){for(var i=new Array(arguments.length-1),r=0,s=2,a=!0;s<arguments.length;)i[r++]=arguments[s++];return new Promise((function(s,n){i[r]=function(e){if(a)if(a=!1,e)n(e);else{for(var t=new Array(arguments.length-1),i=0;i<t.length;)t[i++]=arguments[i];s.apply(null,t)}};try{e.apply(t||null,i)}catch(e){a&&(a=!1,n(e))}}))}},function(module,exports,__webpack_require__){function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(e,t,i){t.Service=i(272)},function(e,t,i){e.exports={}},function(e,t,i){e.exports=function(e){for(var t,i=a.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),o=e.fieldsArray.slice().sort(a.compareFieldsById),d=0;d<o.length;++d){var c=o[d].resolve(),l=e._fieldsArray.indexOf(c),u=c.resolvedType instanceof r?"int32":c.type,h=s.basic[u];t="m"+a.safeProp(c.name),c.map?(i("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",t,c.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(c.id<<3|2)>>>0,8|s.mapKey[c.keyType],c.keyType),void 0===h?i("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",l,t):i(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|h,u,t),i("}")("}")):c.repeated?(i("if(%s!=null&&%s.length){",t,t),c.packed&&void 0!==s.packed[u]?i("w.uint32(%i).fork()",(c.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",u,t)("w.ldelim()"):(i("for(var i=0;i<%s.length;++i)",t),void 0===h?n(i,c,l,t+"[i]"):i("w.uint32(%i).%s(%s[i])",(c.id<<3|h)>>>0,u,t)),i("}")):(c.optional&&i("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",t,c.name),void 0===h?n(i,c,l,t):i("w.uint32(%i).%s(%s)",(c.id<<3|h)>>>0,u,t))}return i("return w")};var r=i(64),s=i(133),a=i(25);function n(e,t,i,r){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",i,r,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",i,r,(t.id<<3|2)>>>0)}},function(e,t,i){e.exports=_;var r=i(132);((_.prototype=Object.create(r.prototype)).constructor=_).className="Type";var s=i(64),a=i(146),n=i(126),o=i(186),d=i(187),c=i(158),l=i(157),u=i(156),h=i(25),p=i(184),m=i(189),f=i(190),g=i(191),v=i(192);function _(e,t){r.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function y(e){return e._fieldsById=e._fieldsArray=e._oneofsArray=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(_.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var i=this.fields[e[t]],r=i.id;if(this._fieldsById[r])throw Error("duplicate id "+r+" in "+this);this._fieldsById[r]=i}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=h.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=h.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=_.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof c||((e.prototype=new c).constructor=e,h.merge(e.prototype,t)),e.$type=e.prototype.$type=this,h.merge(e,c,!0),this._ctor=e;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var r={};for(i=0;i<this.oneofsArray.length;++i)r[this._oneofsArray[i].resolve().name]={get:h.oneOfGetter(this._oneofsArray[i].oneof),set:h.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(e.prototype,r)}}}),_.generateConstructor=function(e){for(var t,i=h.codegen(["p"],e.name),r=0;r<e.fieldsArray.length;++r)(t=e._fieldsArray[r]).map?i("this%s={}",h.safeProp(t.name)):t.repeated&&i("this%s=[]",h.safeProp(t.name));return i("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},_.fromJSON=function(e,t){var i=new _(e,t.options);i.extensions=t.extensions,i.reserved=t.reserved;for(var c=Object.keys(t.fields),l=0;l<c.length;++l)i.add((void 0!==t.fields[c[l]].keyType?o.fromJSON:n.fromJSON)(c[l],t.fields[c[l]]));if(t.oneofs)for(c=Object.keys(t.oneofs),l=0;l<c.length;++l)i.add(a.fromJSON(c[l],t.oneofs[c[l]]));if(t.nested)for(c=Object.keys(t.nested),l=0;l<c.length;++l){var u=t.nested[c[l]];i.add((void 0!==u.id?n.fromJSON:void 0!==u.fields?_.fromJSON:void 0!==u.values?s.fromJSON:void 0!==u.methods?d.fromJSON:r.fromJSON)(c[l],u))}return t.extensions&&t.extensions.length&&(i.extensions=t.extensions),t.reserved&&t.reserved.length&&(i.reserved=t.reserved),t.group&&(i.group=!0),t.comment&&(i.comment=t.comment),i},_.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return h.toObject(["options",t&&t.options||void 0,"oneofs",r.arrayToJSON(this.oneofsArray,e),"fields",r.arrayToJSON(this.fieldsArray.filter((function(e){return!e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},_.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var i=this.oneofsArray;for(t=0;t<i.length;)i[t++].resolve();return r.prototype.resolveAll.call(this)},_.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},_.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof n&&void 0===e.extend){if(this._fieldsById?this._fieldsById[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),y(this)}return e instanceof a?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),y(this)):r.prototype.add.call(this,e)},_.prototype.remove=function(e){if(e instanceof n&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),y(this)}if(e instanceof a){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),y(this)}return r.prototype.remove.call(this,e)},_.prototype.isReservedId=function(e){return r.isReservedId(this.reserved,e)},_.prototype.isReservedName=function(e){return r.isReservedName(this.reserved,e)},_.prototype.create=function(e){return new this.ctor(e)},_.prototype.setup=function(){for(var e=this.fullName,t=[],i=0;i<this.fieldsArray.length;++i)t.push(this._fieldsArray[i].resolve().resolvedType);this.encode=p(this)({Writer:u,types:t,util:h}),this.decode=m(this)({Reader:l,types:t,util:h}),this.verify=f(this)({types:t,util:h}),this.fromObject=g.fromObject(this)({types:t,util:h}),this.toObject=g.toObject(this)({types:t,util:h});var r=v[e];if(r){var s=Object.create(this);s.fromObject=this.fromObject,this.fromObject=r.fromObject.bind(s),s.toObject=this.toObject,this.toObject=r.toObject.bind(s)}return this},_.prototype.encode=function(e,t){return this.setup().encode(e,t)},_.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},_.prototype.decode=function(e,t){return this.setup().decode(e,t)},_.prototype.decodeDelimited=function(e){return e instanceof l||(e=l.create(e)),this.decode(e,e.uint32())},_.prototype.verify=function(e){return this.setup().verify(e)},_.prototype.fromObject=function(e){return this.setup().fromObject(e)},_.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},_.d=function(e){return function(t){h.decorateType(t,e)}}},function(e,t,i){e.exports=n;var r=i(126);((n.prototype=Object.create(r.prototype)).constructor=n).className="MapField";var s=i(133),a=i(25);function n(e,t,i,s,n,o){if(r.call(this,e,t,s,void 0,void 0,n,o),!a.isString(i))throw TypeError("keyType must be a string");this.keyType=i,this.resolvedKeyType=null,this.map=!0}n.fromJSON=function(e,t){return new n(e,t.id,t.keyType,t.type,t.options,t.comment)},n.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},n.prototype.resolve=function(){if(this.resolved)return this;if(void 0===s.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return r.prototype.resolve.call(this)},n.d=function(e,t,i){return"function"==typeof i?i=a.decorateType(i).name:i&&"object"==typeof i&&(i=a.decorateEnum(i).name),function(r,s){a.decorateType(r.constructor).add(new n(s,e,t,i))}}},function(e,t,i){e.exports=o;var r=i(132);((o.prototype=Object.create(r.prototype)).constructor=o).className="Service";var s=i(188),a=i(25),n=i(182);function o(e,t){r.call(this,e,t),this.methods={},this._methodsArray=null}function d(e){return e._methodsArray=null,e}o.fromJSON=function(e,t){var i=new o(e,t.options);if(t.methods)for(var r=Object.keys(t.methods),a=0;a<r.length;++a)i.add(s.fromJSON(r[a],t.methods[r[a]]));return t.nested&&i.addJSON(t.nested),i.comment=t.comment,i},o.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return a.toObject(["options",t&&t.options||void 0,"methods",r.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},Object.defineProperty(o.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=a.toArray(this.methods))}}),o.prototype.get=function(e){return this.methods[e]||r.prototype.get.call(this,e)},o.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return r.prototype.resolve.call(this)},o.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof s?(this.methods[e.name]=e,e.parent=this,d(this)):r.prototype.add.call(this,e)},o.prototype.remove=function(e){if(e instanceof s){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,d(this)}return r.prototype.remove.call(this,e)},o.prototype.create=function(e,t,i){for(var r,s=new n.Service(e,t,i),o=0;o<this.methodsArray.length;++o){var d=a.lcFirst((r=this._methodsArray[o]).resolve().name).replace(/[^$\w_]/g,"");s[d]=a.codegen(["r","c"],a.isReserved(d)?d+"_":d)("return this.rpcCall(m,q,s,r,c)")({m:r,q:r.resolvedRequestType.ctor,s:r.resolvedResponseType.ctor})}return s}},function(e,t,i){e.exports=a;var r=i(125);((a.prototype=Object.create(r.prototype)).constructor=a).className="Method";var s=i(25);function a(e,t,i,a,n,o,d,c,l){if(s.isObject(n)?(d=n,n=o=void 0):s.isObject(o)&&(d=o,o=void 0),void 0!==t&&!s.isString(t))throw TypeError("type must be a string");if(!s.isString(i))throw TypeError("requestType must be a string");if(!s.isString(a))throw TypeError("responseType must be a string");r.call(this,e,d),this.type=t||"rpc",this.requestType=i,this.requestStream=!!n||void 0,this.responseType=a,this.responseStream=!!o||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=c,this.parsedOptions=l}a.fromJSON=function(e,t){return new a(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment,t.parsedOptions)},a.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return s.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},a.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),r.prototype.resolve.call(this))}},function(e,t,i){e.exports=function(e){var t=a.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break"),t("switch(t>>>3){");for(var i=0;i<e.fieldsArray.length;++i){var o=e._fieldsArray[i].resolve(),d=o.resolvedType instanceof r?"int32":o.type,c="m"+a.safeProp(o.name);t("case %i:",o.id),o.map?(t("if(%s===util.emptyObject)",c)("%s={}",c)("var c2 = r.uint32()+r.pos"),void 0!==s.defaults[o.keyType]?t("k=%j",s.defaults[o.keyType]):t("k=null"),void 0!==s.defaults[d]?t("value=%j",s.defaults[d]):t("value=null"),t("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",o.keyType)("case 2:"),void 0===s.basic[d]?t("value=types[%i].decode(r,r.uint32())",i):t("value=r.%s()",d),t("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==s.long[o.keyType]?t('%s[typeof k==="object"?util.longToHash(k):k]=value',c):t("%s[k]=value",c)):o.repeated?(t("if(!(%s&&%s.length))",c,c)("%s=[]",c),void 0!==s.packed[d]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",c,d)("}else"),void 0===s.basic[d]?t(o.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",c,i):t("%s.push(r.%s())",c,d)):void 0===s.basic[d]?t(o.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",c,i):t("%s=r.%s()",c,d),t("break")}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<e._fieldsArray.length;++i){var l=e._fieldsArray[i];l.required&&t("if(!m.hasOwnProperty(%j))",l.name)("throw util.ProtocolError(%j,{instance:m})",n(l))}return t("return m")};var r=i(64),s=i(133),a=i(25);function n(e){return"missing required '"+e.name+"'"}},function(e,t,i){e.exports=function(e){var t=s.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),i={};e.oneofsArray.length&&t("var p={}");for(var r=0;r<e.fieldsArray.length;++r){var d=e._fieldsArray[r].resolve(),c="m"+s.safeProp(d.name);if(d.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",c,d.name),d.map)t("if(!util.isObject(%s))",c)("return%j",a(d,"object"))("var k=Object.keys(%s)",c)("for(var i=0;i<k.length;++i){"),o(t,d,"k[i]"),n(t,d,r,c+"[k[i]]")("}");else if(d.repeated)t("if(!Array.isArray(%s))",c)("return%j",a(d,"array"))("for(var i=0;i<%s.length;++i){",c),n(t,d,r,c+"[i]")("}");else{if(d.partOf){var l=s.safeProp(d.partOf.name);1===i[d.partOf.name]&&t("if(p%s===1)",l)("return%j",d.partOf.name+": multiple values"),i[d.partOf.name]=1,t("p%s=1",l)}n(t,d,r,c)}d.optional&&t("}")}return t("return null")};var r=i(64),s=i(25);function a(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function n(e,t,i,s){if(t.resolvedType)if(t.resolvedType instanceof r){e("switch(%s){",s)("default:")("return%j",a(t,"enum value"));for(var n=Object.keys(t.resolvedType.values),o=0;o<n.length;++o)e("case %i:",t.resolvedType.values[n[o]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",i,s)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",s)("return%j",a(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",s,s,s,s)("return%j",a(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',s)("return%j",a(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',s)("return%j",a(t,"boolean"));break;case"string":e("if(!util.isString(%s))",s)("return%j",a(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',s,s,s)("return%j",a(t,"buffer"))}return e}function o(e,t,i){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",i)("return%j",a(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",i)("return%j",a(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",i)("return%j",a(t,"boolean key"))}return e}},function(e,t,i){var r=t,s=i(64),a=i(25);function n(e,t,i,r){if(t.resolvedType)if(t.resolvedType instanceof s){e("switch(d%s){",r);for(var a=t.resolvedType.values,n=Object.keys(a),o=0;o<n.length;++o)t.repeated&&a[n[o]]===t.typeDefault&&e("default:"),e("case%j:",n[o])("case %i:",a[n[o]])("m%s=%j",r,a[n[o]])("break");e("}")}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,i,r);else{var d=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":d=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,d)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,d?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r)}}return e}function o(e,t,i,r){if(t.resolvedType)t.resolvedType instanceof s?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",r,i,r,r):e("d%s=types[%i].toObject(m%s,o)",r,i,r);else{var a=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":a=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,a?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r)}}return e}r.fromObject=function(e){var t=e.fieldsArray,i=a.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return i("return new this.ctor");i("var m=new this.ctor");for(var r=0;r<t.length;++r){var o=t[r].resolve(),d=a.safeProp(o.name);o.map?(i("if(d%s){",d)('if(typeof d%s!=="object")',d)("throw TypeError(%j)",o.fullName+": object expected")("m%s={}",d)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",d),n(i,o,r,d+"[ks[i]]")("}")("}")):o.repeated?(i("if(d%s){",d)("if(!Array.isArray(d%s))",d)("throw TypeError(%j)",o.fullName+": array expected")("m%s=[]",d)("for(var i=0;i<d%s.length;++i){",d),n(i,o,r,d+"[i]")("}")("}")):(o.resolvedType instanceof s||i("if(d%s!=null){",d),n(i,o,r,d),o.resolvedType instanceof s||i("}"))}return i("return m")},r.toObject=function(e){var t=e.fieldsArray.slice().sort(a.compareFieldsById);if(!t.length)return a.codegen()("return {}");for(var i=a.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),r=[],n=[],d=[],c=0;c<t.length;++c)t[c].partOf||(t[c].resolve().repeated?r:t[c].map?n:d).push(t[c]);if(r.length){for(i("if(o.arrays||o.defaults){"),c=0;c<r.length;++c)i("d%s=[]",a.safeProp(r[c].name));i("}")}if(n.length){for(i("if(o.objects||o.defaults){"),c=0;c<n.length;++c)i("d%s={}",a.safeProp(n[c].name));i("}")}if(d.length){for(i("if(o.defaults){"),c=0;c<d.length;++c){var l=d[c],u=a.safeProp(l.name);if(l.resolvedType instanceof s)i("d%s=o.enums===String?%j:%j",u,l.resolvedType.valuesById[l.typeDefault],l.typeDefault);else if(l.long)i("if(util.Long){")("var n=new util.Long(%i,%i,%j)",l.typeDefault.low,l.typeDefault.high,l.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",u)("}else")("d%s=o.longs===String?%j:%i",u,l.typeDefault.toString(),l.typeDefault.toNumber());else if(l.bytes){var h="["+Array.prototype.slice.call(l.typeDefault).join(",")+"]";i("if(o.bytes===String)d%s=%j",u,String.fromCharCode.apply(String,l.typeDefault))("else{")("d%s=%s",u,h)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",u,u)("}")}else i("d%s=%j",u,l.typeDefault)}i("}")}var p=!1;for(c=0;c<t.length;++c){l=t[c];var m=e._fieldsArray.indexOf(l);u=a.safeProp(l.name),l.map?(p||(p=!0,i("var ks2")),i("if(m%s&&(ks2=Object.keys(m%s)).length){",u,u)("d%s={}",u)("for(var j=0;j<ks2.length;++j){"),o(i,l,m,u+"[ks2[j]]")("}")):l.repeated?(i("if(m%s&&m%s.length){",u,u)("d%s=[]",u)("for(var j=0;j<m%s.length;++j){",u),o(i,l,m,u+"[j]")("}")):(i("if(m%s!=null&&m.hasOwnProperty(%j)){",u,l.name),o(i,l,m,u),l.partOf&&i("if(o.oneofs)")("d%s=%j",a.safeProp(l.partOf.name),l.name)),i("}")}return i("return d")}},function(e,t,i){var r=t,s=i(158);r[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=e["@type"].substring(e["@type"].lastIndexOf("/")+1),i=this.lookup(t);if(i){var r="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return-1===r.indexOf("/")&&(r="/"+r),this.create({type_url:r,value:i.encode(i.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){var i="",r="";if(t&&t.json&&e.type_url&&e.value){r=e.type_url.substring(e.type_url.lastIndexOf("/")+1),i=e.type_url.substring(0,e.type_url.lastIndexOf("/")+1);var a=this.lookup(r);a&&(e=a.decode(e.value))}if(!(e instanceof this.ctor)&&e instanceof s){var n=e.$type.toObject(e,t);return""===i&&(i="type.googleapis.com/"),r=i+("."===e.$type.fullName[0]?e.$type.fullName.substr(1):e.$type.fullName),n["@type"]=r,n}return this.toObject(e,t)}}},function(e,t,i){e.exports=u;var r=i(132);((u.prototype=Object.create(r.prototype)).constructor=u).className="Root";var s,a,n,o=i(126),d=i(64),c=i(146),l=i(25);function u(e){r.call(this,"",e),this.deferred=[],this.files=[]}function h(){}u.fromJSON=function(e,t){return t||(t=new u),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},u.prototype.resolvePath=l.path.resolve,u.prototype.fetch=l.fetch,u.prototype.load=function e(t,i,r){"function"==typeof i&&(r=i,i=void 0);var s=this;if(!r)return l.asPromise(e,s,t,i);var o=r===h;function d(e,t){if(r){var i=r;if(r=null,o)throw e;i(e,t)}}function c(e){var t=e.lastIndexOf("google/protobuf/");if(t>-1){var i=e.substring(t);if(i in n)return i}return null}function u(e,t){try{if(l.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),l.isString(t)){a.filename=e;var r,n=a(t,s,i),u=0;if(n.imports)for(;u<n.imports.length;++u)(r=c(n.imports[u])||s.resolvePath(e,n.imports[u]))&&p(r);if(n.weakImports)for(u=0;u<n.weakImports.length;++u)(r=c(n.weakImports[u])||s.resolvePath(e,n.weakImports[u]))&&p(r,!0)}else s.setOptions(t.options).addJSON(t.nested)}catch(e){d(e)}o||m||d(null,s)}function p(e,t){if(!(s.files.indexOf(e)>-1))if(s.files.push(e),e in n)o?u(e,n[e]):(++m,setTimeout((function(){--m,u(e,n[e])})));else if(o){var i;try{i=l.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||d(e))}u(e,i)}else++m,s.fetch(e,(function(i,a){--m,r&&(i?t?m||d(null,s):d(i):u(e,a))}))}var m=0;l.isString(t)&&(t=[t]);for(var f,g=0;g<t.length;++g)(f=s.resolvePath("",t[g]))&&p(f);if(o)return s;m||d(null,s)},u.prototype.loadSync=function(e,t){if(!l.isNode)throw Error("not supported");return this.load(e,t,h)},u.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return"'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return r.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function m(e,t){var i=t.parent.lookup(t.extend);if(i){var r=new o(t.fullName,t.id,t.type,t.rule,void 0,t.options);return r.declaringField=t,t.extensionField=r,i.add(r),!0}return!1}u.prototype._handleAdd=function(e){if(e instanceof o)void 0===e.extend||e.extensionField||m(0,e)||this.deferred.push(e);else if(e instanceof d)p.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof c)){if(e instanceof s)for(var t=0;t<this.deferred.length;)m(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var i=0;i<e.nestedArray.length;++i)this._handleAdd(e._nestedArray[i]);p.test(e.name)&&(e.parent[e.name]=e)}},u.prototype._handleRemove=function(e){if(e instanceof o){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof d)p.test(e.name)&&delete e.parent[e.name];else if(e instanceof r){for(var i=0;i<e.nestedArray.length;++i)this._handleRemove(e._nestedArray[i]);p.test(e.name)&&delete e.parent[e.name]}},u._configure=function(e,t,i){s=e,a=t,n=i}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHelper=void 0;const o=i(11),d=i(165),c=i(72),l=i(159),u=n(i(12)),h=n(i(13)),p=a(i(75)),m=i(75),f=i(69),g=i(284),v=a(i(14)),_=i(38),y=i(149),S=i(119),R=i(2),b=i(285),E=i(67),T=i(286),A=i(177);class w extends o.EventEmitter{constructor(e){super(),this.audio={audioStream:new MediaStream,audioSourceStream:new MediaStream,musicStream:new MediaStream,micStream:new MediaStream,pipeline:null,audioSource:null,micTrack:null,deviceInfo:{mic:{compatAudio:!1,label:""}},webAudio:null,micConstraint:null,mixAudioConf:{index:0,audioBuffer:{},sounds:{}},stageAIProcessing:null,audioRoutingEnabled:!1},this.video={videoStream:new MediaStream,renderStream:new MediaStream,low:null,cameraTrack:null,cameraConstraint:{video:{}},videoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:8e5,contentHint:null},low:{maxBitrate:1e5,contentHint:"motion"}}},this.screen={screenVideoStream:new MediaStream,renderStream:new MediaStream,low:null,screenVideoTrack:null,screenVideoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.screenAudio={screenAudioStream:new MediaStream,screenAudioTrack:null,screenAudioSource:null,pipeline:null},this.listenToTrackEnded=e=>{e&&e.addEventListener("ended",(async()=>{var t;v.ANY_CHROME_MAJOR_VERSION&&v.ANY_CHROME_MAJOR_VERSION<62&&await this.delay(100),this.logger.log("Track ended",e.label,e.id),this.stream.isRemote||this.stream.localStreamId!==(null===(t=this.stream.client.adapterRef.localStream)||void 0===t?void 0:t.localStreamId)||(e!==this.audio.micTrack&&e!==this.audio.audioSource||(this.logger.warn("音频轨道已停止"),this.stream.client.safeEmit("audioTrackEnded"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"audioTrackEnded",mediaType:"audio"})),e!==this.video.cameraTrack&&e!==this.video.videoSource||(this.logger.warn("视频轨道已停止"),this.stream.client.safeEmit("videoTrackEnded"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"video"})),(e===this.screen.screenVideoTrack||e===this.screen.screenVideoSource||e.label.indexOf("screen")>-1||e.label.indexOf("window")>-1||e.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已停止"),this.stream.client.safeEmit("stopScreenSharing"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"videoTrackEnded",mediaType:"screen"})),e===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已停止"),this.stream.client.safeEmit("stopScreenAudio"),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:"stopScreenAudio",mediaType:"screenAudio"})))}))},this.stream=e.stream,this.logger=e.stream.logger.getChild((()=>{var e;let t="mediaHelper";return this.audio.audioRoutingEnabled&&(t+=" WebAudio"),this.audio.webAudio&&(this.audio.webAudio.context&&"running"!==this.audio.webAudio.context.state&&(t+=" "+this.audio.webAudio.context.state),this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.UNSTART&&(t+=" "+(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf.state))),t})),this.getSettingsEnabled="getSettings"in MediaStreamTrack.prototype,this.bindRenderStream(),S.Device.on("recording-device-changed",(e=>{this.audio.micTrack&&this.audio.deviceInfo.mic.deviceId===e.device.deviceId&&("INACTIVE"===e.state?(this.logger.error("当前使用的麦克风设备被移除，需重新启用设备",e.device),this.stream.emit("recording-device-changed",e)):S.Device.deviceHistory.audioIn.find((e=>{e.groupId,this.audio.deviceInfo.mic.groupId}))||(this.logger.error(`当前麦克风已由【${this.audio.deviceInfo.mic.label}】切换至【${e.device.label}】，可能会影响通话质量`),this.audio.deviceInfo.mic.label=e.device.label,this.audio.deviceInfo.mic.groupId=e.device.groupId,this.stream.emit("recording-device-changed",e)))}))}getOrCreateAudioPipeline(e="audio"){let t;const i=E.getAudioContext();if(!i)return this.logger.error("getOrCreateAudioPipeline: AudioContext is not supported"),null;if("audio"===e)if(this.audio.pipeline?t=this.audio.pipeline:(t=new T.AudioPipeline({logger:this.logger,outputStream:this.audio.audioStream,context:i}),this.audio.pipeline=t,this.logger.log("getOrCreateAudioPipeline: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.audio.micTrack&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("remote",this.audio.micTrack,"remote"+this.stream.streamID));else{const e=this.audio.micTrack||this.audio.audioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"))}else if(this.screenAudio.pipeline?t=this.screenAudio.pipeline:(t=new T.AudioPipeline({logger:this.logger,outputStream:this.screenAudio.screenAudioStream,context:i}),this.screenAudio.pipeline=t,this.logger.log("getOrCreateAudioPipeline/screenAudio: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.screenAudio.screenAudioTrack&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("remote",this.screenAudio.screenAudioTrack,`remote${this.stream.streamID}/screenAudio`));else{const e=this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"))}return t}bindRenderStream(){v.IS_SAFARI&&"safari"===R.getParameters().shimLocalCanvas||"all"===R.getParameters().shimLocalCanvas?(this.video.videoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=g.pcCloneTrack(e.track);m.watchTrack(t),this.logger.warn("renderStream cloned track for video:",e.track,t),m.emptyStreamWith(this.video.renderStream,t)}else m.emptyStreamWith(this.video.renderStream,e.track)},this.video.videoStream.onremovetrack=e=>{m.emptyStreamWith(this.video.renderStream,null)},this.screen.screenVideoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=g.pcCloneTrack(e.track);m.watchTrack(t),this.logger.warn("renderStream cloned track for screen:",e.track,t),m.emptyStreamWith(this.screen.renderStream,t)}else m.emptyStreamWith(this.screen.renderStream,e.track)},this.screen.screenVideoStream.onremovetrack=e=>{m.emptyStreamWith(this.screen.renderStream,null)}):(this.video.renderStream=this.video.videoStream,this.screen.renderStream=this.screen.screenVideoStream)}assertLive(){if(!this.stream.isRemote&&!this.stream.isRemote&&this.stream.destroyed)throw this._reset(),new h.default({code:u.default.LOCALSTREAM_NOT_FOUND_ERROR,message:"assertLive: localStream 已经销毁"})}_reset(){this.stopAllEffects(),this.stream.isRemote||(this.audio.webAudio&&(this.audio.webAudio.off("audioFilePlaybackCompleted"),this.audio.webAudio.destroy()),this.audio.webAudio=null,this.audio.micConstraint=null,this.audio.audioRoutingEnabled=!1,this.audio.micTrack&&(this.audio.micTrack.stop(),this.audio.micTrack=null),this.video.low&&(this.video.low.destroy(),this.video.low=null),this.video.videoSource=null,this.video.cameraTrack&&(this.video.cameraTrack.stop(),this.video.cameraTrack=null),this.screen.screenVideoTrack&&(this.screen.screenVideoTrack.stop(),this.screen.screenVideoTrack=null),this.video.cameraConstraint={video:{}},this.screenAudio.screenAudioTrack&&(this.screenAudio.screenAudioTrack.stop(),this.screenAudio.screenAudioTrack=null),this.audio.mixAudioConf={index:0,audioBuffer:{},sounds:{}}),m.emptyStreamWith(this.audio.audioStream,null),m.emptyStreamWith(this.audio.musicStream,null),m.emptyStreamWith(this.audio.micStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null),m.emptyStreamWith(this.video.videoStream,null),m.emptyStreamWith(this.screen.screenVideoStream,null),m.emptyStreamWith(this.screenAudio.screenAudioStream,null)}updateWebAudio(){var e,t;if(!this.audio.webAudio){this.audio.webAudio=new E.WebAudio({mediaHelper:this,logger:this.logger}),this.audio.webAudio.on("audioFilePlaybackCompleted",this._audioFilePlaybackCompletedEvent.bind(this));const i=null===(t=null===(e=this.audio.webAudio)||void 0===e?void 0:e.musicDestination)||void 0===t?void 0:t.stream.getAudioTracks()[0];i&&m.emptyStreamWith(this.audio.musicStream,i)}this.audio.webAudio.updateTracks([{track:this.audio.micTrack||this.audio.audioSource,type:"microphone"}])}async getScreenSource(e){let t;const{width:i,height:r,frameRate:s}=this.screen.captureConfig.high;try{return t={video:{width:{ideal:i},height:{ideal:r},frameRate:{ideal:s,max:s}}},this.replaceConstraint(t,"screen"),await p.getScreenStream(t,this.logger)}catch(e){const t="screen";return e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.stream.client.safeEmit("accessDenied",t):e.message&&e.message.indexOf("not found")>-1?this.stream.client.safeEmit("notFound",t):e.message&&e.message.indexOf("not start video source")>-1?this.stream.client.safeEmit("beOccupied",t):this.stream.client.safeEmit("deviceError",t),this.stream.emit("device-error",{type:t,error:e}),Promise.reject(e)}}getTrackByMediaType(e){return"audio"===e?this.audio.micTrack||this.audio.audioSource:"audioSlave"===e?this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource:"video"===e?this.video.cameraTrack||this.video.videoSource:"screen"===e?this.screen.screenVideoTrack||this.screen.screenVideoSource:null}async getStream(e){let{audio:t=!1,audioDeviceId:i="",video:r=!1,videoDeviceId:s="",screen:a=!1,sourceId:n="",screenAudio:o=!1,facingMode:d="",audioSource:c=null,videoSource:l=null,screenAudioSource:u=null,screenVideoSource:h=null,deviceId:f=""}=e;if(c&&(t=!0),l&&(r=!0),h&&(a=!0),u&&(o=!0),this.stream.isRemote)return void this.logger.error("getStream: 远端流不能够调用getStream");if(!(t||r||a||o))return void this.logger.error("getStream: 必须指定媒体类型");if(c){if("ended"===c.readyState)return void this.logger.error("不应输入已经停止的轨道:",c.kind,c.label);m.watchTrack(c),this.audio.audioSource=c,m.emptyStreamWith(this.audio.audioSourceStream,c),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,c),this.updateAudioSender(c))),t=!1,this.stream.client.updateRecordingAudioStream()}if(l){if("ended"===l.readyState)return void this.logger.error("不应输入已经停止的轨道:",l.kind,l.label);m.watchTrack(l),this.video.videoSource=l,m.emptyStreamWith(this.video.videoStream,l),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),r=!1}if(u){if("ended"===u.readyState)return void this.logger.error("不应输入已经停止的轨道:",u.kind,u.label);m.watchTrack(u),this.screenAudio.screenAudioSource=u,m.emptyStreamWith(this.screenAudio.screenAudioStream,u),this.listenToTrackEnded(this.screenAudio.screenAudioSource),m.emptyStreamWith(this.screenAudio.screenAudioStream,u),o=!1}if(h){if("ended"===h.readyState)return void this.logger.error("不应输入已经停止的轨道:",h.kind,h.label);m.watchTrack(h),this.screen.screenVideoSource=h,m.emptyStreamWith(this.screen.screenVideoStream,h),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),a=!1}let g=null,v=null,_=null;try{if(a){const{width:e,height:i,frameRate:r}=this.screen.captureConfig.high;if(n){_={video:{mandatory:{maxWidth:e,maxHeight:i,maxFrameRate:r,minFrameRate:5,chromeMediaSource:"desktop",chromeMediaSourceId:n}}},this.replaceConstraint(_,"screen");const t=(await p.getStream(_,this.logger)).getVideoTracks()[0];this.screen.screenVideoTrack=t,m.emptyStreamWith(this.screen.screenVideoStream,t)}else{_={video:{width:{ideal:e},height:{ideal:i},frameRate:{ideal:r,max:r}},audio:o&&this.getAudioConstraints("audioSlave")?this.getAudioConstraints("audioSlave"):o},this.replaceConstraint(_,"screen");let t=await p.getScreenStream(_,this.logger);if(this.screen.screenVideoTrack=t.getVideoTracks()[0],this.listenToTrackEnded(this.screen.screenVideoTrack),m.emptyStreamWith(this.screen.screenVideoStream,this.screen.screenVideoTrack),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),o){const e=t.getAudioTracks()[0];e?(this.screenAudio.screenAudioTrack=e,m.emptyStreamWith(this.screenAudio.screenAudioStream,e),this.listenToTrackEnded(e),this.stream.client.apiEventReport("setFunction",{name:"pub_second_audio",oper:"1",value:JSON.stringify({result:"success",constaints:_.audio},null," ")})):(this.logger.warn("getStream screenAudio: 未获取到屏幕共享音频"),this.stream.screenAudio=!1,this.stream.client.emit("error","screenAudioNotAllowed"))}}if(this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"success",constaints:_},null," ")}),t){g={audio:this.getAudioConstraints("audio")},this.replaceConstraint(g,"audio");let e=await p.getStream(g,this.logger);this.audio.micTrack=e.getAudioTracks()[0],m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=y.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:g.audio},null," ")})}}else if(o)this.logger.error("无法单独获取屏幕共享音频");else if(t||r){if(this.stream.isRemote)return void this.logger.error("MediaHelper.getStream:远端流不能调用getStream");const{height:e,width:a,frameRate:n}=this.video.captureConfig.high;v={audio:t&&this.getAudioConstraints("audio")?this.getAudioConstraints("audio"):void 0,video:r?{width:{ideal:a},height:{ideal:e},frameRate:{ideal:n||15}}:void 0},i&&"object"==typeof v.audio&&(v.audio.deviceId={exact:i}),v.video&&(d?v.video.facingMode={exact:d}:s&&(v.video.deviceId={exact:s})),this.replaceConstraint(v,"video");const o=await p.getStream(v,this.logger),c=o.getVideoTracks()[0],l=o.getAudioTracks()[0];if(l){this.audio.micTrack=l,this.listenToTrackEnded(this.audio.micTrack),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const e=y.compatAudioInputList.findSource(this.audio.micTrack.id);if(e){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const t=e.getSettings();this.audio.deviceInfo.mic.label=e.label,this.audio.deviceInfo.mic.deviceId=t.deviceId,this.audio.deviceInfo.mic.groupId=t.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:v.audio},null," ")}),"object"==typeof v.audio&&(this.audio.micConstraint={audio:v.audio}),this.stream.client.updateRecordingAudioStream()}c&&(this.video.cameraTrack=c,m.emptyStreamWith(this.video.videoStream,c),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.listenToTrackEnded(this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:v.video})}),"object"==typeof v.video&&(this.video.cameraConstraint={video:v.video}))}this.assertLive()}catch(e){this.logger.error("getStream error:",e.name,e.message);let i="audio";return t&&this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")}),r&&(i="video",this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")})),a&&(i="screen",this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:JSON.stringify({result:"fail",reason:`${e.name} + ${e.message}`},null," ")})),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?this.stream.client.safeEmit("accessDenied",i):"NotFoundError"===e.name?this.stream.client.safeEmit("notFound",i):"NotReadableError"===e.name?this.stream.client.safeEmit("beOccupied",i):"OverconstrainedError"===e.name&&this.stream.client.safeEmit("deviceError",i),this.stream.emit("device-error",{type:i,error:e}),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:`getUserMediaError: ${e.name} + ${e.message}`,mediaType:i}),Promise.reject(e)}}async getSecondStream(e){let{audio:t=!1,video:i=!1}=e;if(!this.stream.isRemote)try{this.replaceConstraint(e,"video");const t=await p.getStream(e,this.logger),i=t.getAudioTracks()[0],r=t.getVideoTracks()[0];if(this.logger.log(`getSecondStream: ${i?i.label:""} ${r?r.label:""}`),i){"object"==typeof e.audio&&(this.audio.micConstraint={audio:e.audio}),this.audio.micTrack=i,this._stopTrack(this.audio.micStream),m.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(m.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=y.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){if(this.audio.deviceInfo.mic.compatAudio=!0,this.getSettingsEnabled){const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}}else if(this.audio.deviceInfo.mic.compatAudio=!1,this.getSettingsEnabled){const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:JSON.stringify({result:"success",constaints:e.audio},null," ")})}if(r){"object"==typeof e.video&&(this.video.cameraConstraint={video:e.video}),this.video.cameraTrack=r,this._stopTrack(this.video.videoStream),m.emptyStreamWith(this.video.videoStream,this.video.cameraTrack),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:JSON.stringify({result:"success",constaints:e.video},null," ")});const t=this.stream._play.video.view;t&&(await this.stream.play(t),"width"in this.stream.renderMode.local.video&&this.stream.setLocalRenderMode(this.stream.renderMode.local.video,"video"));const i=this.stream.getSender("video","high");(null==i?void 0:i.track)?i.replaceTrack(r):this.logger.warn("getSecondStream video: 此时未发布流")}}catch(e){this.logger.error("getStream error",e.message);const i=t?"set_mic":"set_camera";return this.stream.client.apiEventReport("setFunction",{name:i,oper:"1",value:JSON.stringify({result:"fail",reason:e.message},null," ")}),Promise.reject(e)}}convert(e){const t=e.resolution,i=e.frameRate;let r={width:640,height:480,frameRate:15};return 2===t?(r.width=320,r.height=180):4===t?(r.width=640,r.height=480):8===t||v.IS_IOS_SAFARI?(r.width=1280,r.height=720):16===t&&(r.width=1920,r.height=1080),i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_NORMAL?r.frameRate=15:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_5?r.frameRate=5:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_10?r.frameRate=10:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_15?r.frameRate=15:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_20?r.frameRate=20:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_25?r.frameRate=25:i===c.VIDEO_FRAME_RATE_ENUM.CHAT_VIDEO_FRAME_RATE_30&&(r.frameRate=30),r}getAudioConstraints(e){if(this.stream.isRemote)return void this.logger.error("Remote Stream dont have audio constraints");const t=this.stream,i=t.constraintSettings[e];let r={channelCount:"audio"===e?1:2};switch("audioSlave"===e&&(A.set3AConstraint(r,"AEC",!1),A.set3AConstraint(r,"ANS",!1),A.set3AConstraint(r,"AGC",!1)),t.audioProfile){case"standard_stereo":case"high_quality_stereo":A.set3AConstraint(r,"AGC",!1),A.set3AConstraint(r,"AEC",!1),A.set3AConstraint(r,"ANS",!1),r.channelCount=2}for(let e in i)if(["AEC","ANS","AGC"].indexOf(e)>-1){const t=e;A.set3AConstraint(r,t,i[t])}else r[e]=i[e];return A.forceAudioConstraints(r),r}getTrackSettings(){const e={};try{if(this.audio.micTrack){const t=y.compatAudioInputList.findSource(this.audio.micTrack.id);e.mic=t?{compat:!0,settings:this.getSettingsEnabled?t.getSettings():t.getConstraints(),label:t.label,readyState:t.readyState}:{settings:this.getSettingsEnabled?this.audio.micTrack.getSettings():this.audio.micTrack.getConstraints(),label:this.audio.micTrack.label,readyState:this.audio.micTrack.readyState}}this.audio.audioSource&&(e.audioSource={settings:this.getSettingsEnabled?this.audio.audioSource.getSettings():this.audio.audioSource.getConstraints(),label:this.audio.audioSource.label,readyState:this.audio.audioSource.readyState}),this.video.cameraTrack&&(e.camera={settings:this.getSettingsEnabled?this.video.cameraTrack.getSettings():this.video.cameraTrack.getConstraints(),label:this.video.cameraTrack.label,readyState:this.video.cameraTrack.readyState}),this.video.videoSource&&(e.videoSource={settings:this.getSettingsEnabled?this.video.videoSource.getSettings():this.video.videoSource.getConstraints(),label:this.video.videoSource.label,readyState:this.video.videoSource.readyState}),this.screen.screenVideoTrack&&(e.screen={settings:this.getSettingsEnabled?this.screen.screenVideoTrack.getSettings():this.screen.screenVideoTrack.getConstraints(),label:this.screen.screenVideoTrack.label,readyState:this.screen.screenVideoTrack.readyState}),this.screen.screenVideoSource&&(e.screenVideoSource={settings:this.getSettingsEnabled?this.screen.screenVideoSource.getSettings():this.screen.screenVideoSource.getConstraints(),label:this.screen.screenVideoSource.label,readyState:this.screen.screenVideoSource.readyState}),this.screenAudio.screenAudioTrack&&(e.screenAudio={settings:this.getSettingsEnabled?this.screenAudio.screenAudioTrack.getSettings():this.screenAudio.screenAudioTrack.getConstraints(),label:this.screenAudio.screenAudioTrack.label,readyState:this.screenAudio.screenAudioTrack.readyState}),this.screenAudio.screenAudioSource&&(e.screenAudioSource={settings:this.getSettingsEnabled?this.screenAudio.screenAudioSource.getSettings():this.screenAudio.screenAudioSource.getConstraints(),label:this.screenAudio.screenAudioSource.label,readyState:this.screenAudio.screenAudioSource.readyState}),S.Device.deviceHistory.audioOut[0]&&(e.audioOutDefault=S.Device.deviceHistory.audioOut[0])}catch(t){e.errName=t.name,e.errMessage=t.message}return e}updateStream(e,t){"audio"===e?(this.audio.micTrack=t,m.emptyStreamWith(this.audio.audioStream,t),this.stream._play.audio.dom&&(this.stream._play.audio.dom.srcObject=this.audio.audioStream)):"audioSlave"===e?(this.screenAudio.screenAudioTrack=t,m.emptyStreamWith(this.screenAudio.screenAudioStream,t),this.stream._play.audioSlave.dom&&(this.stream._play.audioSlave.dom.srcObject=this.screenAudio.screenAudioStream)):"video"===e?(this.video.cameraTrack=t,m.emptyStreamWith(this.video.videoStream,t),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream._play.video.dom&&(this.stream._play.video.dom.srcObject=this.video.renderStream)):"screen"===e&&(this.screen.screenVideoTrack=t,m.emptyStreamWith(this.screen.screenVideoStream,t),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),this.stream._play.screen.dom&&(this.stream._play.screen.dom.srcObject=this.screen.renderStream))}stopStream(e){var t,i,r,s,a,n;let o="set_mic";"audio"===e?(null===(t=this.audio.micTrack)||void 0===t||t.stop(),this.audio.micTrack=null,m.emptyStreamWith(this.audio.micStream,null),this.audio.audioSource=null,m.emptyStreamWith(this.audio.audioSourceStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting(),this.stream.isRemote||null===(i=this.stream.audioLevelHelper)||void 0===i||i.updateStream(this.screenAudio.screenAudioStream)):"screenAudio"===e?(null===(r=this.screenAudio.screenAudioTrack)||void 0===r||r.stop(),this.screenAudio.screenAudioTrack=null,this.screenAudio.screenAudioSource=null,m.emptyStreamWith(this.screenAudio.screenAudioStream,null),this.stream.isRemote||null===(s=this.stream.audioLevelHelperSlave)||void 0===s||s.updateStream(this.screenAudio.screenAudioStream),o="pub_second_audio"):"video"===e?(o="set_camera",null===(a=this.video.cameraTrack)||void 0===a||a.stop(),this.video.cameraTrack=null,this.video.videoSource=null,m.emptyStreamWith(this.video.videoStream,null)):"screen"===e&&(o="set_screen",null===(n=this.screen.screenVideoTrack)||void 0===n||n.stop(),this.screen.screenVideoTrack=null,this.screen.screenVideoSource=null,m.emptyStreamWith(this.screen.screenVideoStream,null)),this.stream.client.apiEventReport("setFunction",{name:o,oper:"0",value:"success"})}_stopTrack(e){if(!e)return;if(this.stream.isRemote)return;this.logger.log("清除stream: ",e);const t=e.getTracks();this.logger.log("清除stream: ",...t),t&&0!==t.length&&t.forEach((t=>{if("audio"===t.kind){const e=R.getParameters().tracks.audio.findIndex((e=>t===e));_.Logger.warn(`Stopping AUDIOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}else{const e=R.getParameters().tracks.video.findIndex((e=>t===e));_.Logger.warn(`Stopping VIDEOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}t.stop(),e.removeTrack(t),this.audio.micTrack===t&&(this.audio.micTrack=null,this.audio.deviceInfo.mic={compatAudio:y.compatAudioInputList.enabled,label:""},this.updateWebAudio()),this.screenAudio.screenAudioTrack===t&&(this.screenAudio.screenAudioTrack=null,this.updateWebAudio()),this.video.cameraTrack===t&&(this.video.cameraTrack=null),this.screen.screenVideoTrack===t&&(this.screen.screenVideoTrack=null)}))}getAudioTrack(){var e;return null===(e=this.audio)||void 0===e?void 0:e.audioStream.getAudioTracks()[0]}getVideoTrack(){var e;return null===(e=this.video)||void 0===e?void 0:e.videoStream.getVideoTracks()[0]}setGain(e,t){this.audio.webAudio?(this.logger.log("setGain",e),this.audio.webAudio.setGain(e,t),this.canDisableAudioRouting()&&this.disableAudioRouting()):this.logger.log("setGain: 缺失本地音频")}getGain(){var e;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.getVolumeData())||"0.0"}canDisableAudioRouting(){var e;let t=!0;if(!this.audio.webAudio)return!1;if(null===(e=this.audio.stageAIProcessing)||void 0===e?void 0:e.enabled)return!1;this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PLAYED&&this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED||(t=!1),Object.values(this.audio.mixAudioConf.sounds).forEach((e=>{"STARTING"!==e.state&&"PLAYED"!==e.state&&"PAUSED"!==e.state||(t=!1)}));const i=this.audio.webAudio.getGainMin();return t&&1===i&&this.audio.webAudio.audioInArr.length<=1}_audioFilePlaybackCompletedEvent(){this.canDisableAudioRouting()&&this.disableAudioRouting()}startAudioMixing(e){let t,i;return this.logger.log("开始伴音:",JSON.stringify(e,null," ")),Object.assign(this.audio.mixAudioConf,e),this.audio.mixAudioConf.audioFilePath?0!==this.getAudioInputTracks().length&&this.stream.pubStatus.audio.audio?this.audio.webAudio&&this.audio.webAudio.context||(i="startAudioMixing() 浏览器环境不支持伴音",t=u.default.AUDIO_MIX_NO_SUPPORT):(i="startAudioMixing() 当前没有开启过麦克风",t=u.default.AUDIO_MIX_NO_AUDIO):(i="startAudioMixing() 没有设置云端文件路径",t=u.default.AUDIO_MIX_FILE_ERROR),t?(this.logger.error(i),this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),Promise.reject(new h.default({code:t,message:i}))):(this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED&&(this.logger.log("startAudioMixing() 当前已经开启伴音，先关闭之前的伴音"),this.stopAudioMixing()),this.audio.webAudio.mixAudioConf.state,d.AuidoMixingState.STARTING),this.audio.mixAudioConf.audioFilePath&&this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]?(this.logger.log("startAudioMixing() 开始伴音, 已经加载过云端音乐"),this.startMix(this.audio.mixAudioConf.index)):(this.logger.log("startAudioMixing() 开始伴音, 先加载云端音乐"),this.loadRemoteAudioFile(this.audio.mixAudioConf.index)))}loadRemoteAudioFile(e){const t=this.audio.mixAudioConf.audioFilePath;return t?l.ajax({url:t,type:"GET",dataType:"arraybuffer"}).then((i=>(this.logger.log("loadRemoteAudioFile 加载云端音乐成功"),new Promise(((r,s)=>{var a,n;null===(n=null===(a=this.audio.webAudio)||void 0===a?void 0:a.context)||void 0===n||n.decodeAudioData(i,(i=>{var s;this.logger.log("loadRemoteAudioFile 云端音乐解码成功"),this.audio.mixAudioConf.audioBuffer[t]=i,null===(s=this.startMix(e))||void 0===s||s.then((e=>{r(e)}))}),(e=>{s(new h.default({code:u.default.AUDIO_MIX_FILE_ERROR,message:"loadRemoteAudioFile: 云端音乐解码失败: "+e.message}))}))}))))).catch((e=>Promise.reject(new h.default({code:u.default.AUDIO_MIX_FILE_ERROR,message:`loadRemoteAudioFile: 加载云端音乐失败: ${e.name} ${e.message}`})))):(this.logger.warn("loadRemoteAudioFile() audioFilePath未设置"),Promise.resolve())}delay(e){return new Promise((t=>setTimeout(t,e)))}startMix(e){var t;if(this.logger.log("startMix 开始混音:",JSON.stringify(this.audio.mixAudioConf)),e!==this.audio.mixAudioConf.index)return this.logger.log("startMix: 该次伴音已经取消"),Promise.resolve();this.audio.audioRoutingEnabled||this.enableAudioRouting();const{audioFilePath:i="",loopback:r=!1,replace:s=!1,cycle:a=0,playStartTime:n=0,volume:o=255,auidoMixingEnd:d=null}=this.audio.mixAudioConf;return null===(t=this.audio.webAudio)||void 0===t?void 0:t.startMix({buffer:this.audio.mixAudioConf.audioBuffer[i],loopback:r,replace:s,cycle:a,playStartTime:n,volume:o,auidoMixingEnd:d})}stopAudioMixing(e=!0){var t;return(null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio.stopAudioMixing(e)):(this.logger.error("stopAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"stopAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"stopAudioMixing() 当前没有开启伴音"})))}pauseAudioMixing(){var e;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED?(this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&this.audio.webAudio.pauseAudioMixing()):(this.logger.error("pauseAudioMixing() 当前没有开启伴音"),this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:"pauseAudioMixing() 当前没有开启伴音"}),null," ")}),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"pauseAudioMixing() 当前没有开启伴音"})))}resumeAudioMixing(){var e;let t,i;if((null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED&&(i="resumeAudioMixing() 当前没有暂停伴音",t=u.default.AUDIO_MIX_NOT_PAUSE):(i="resumeAudioMixing() 当前没有开启伴音",t=u.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:t?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:i||""}),null," ")}),t)return this.logger.error(i),Promise.reject(new h.default({code:t,message:i}));if(!this.audio.webAudio)return;let{audioFilePath:r="",loopback:s=!1,replace:a=!1,cycle:n=0,playStartTime:o=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf,l=(this.audio.webAudio.mixAudioConf.pauseTime-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;return l>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime)),n-=Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=n),this.audio.webAudio.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.audio.webAudio.mixAudioConf.setPlayStartTime),o=this.audio.webAudio.mixAudioConf.setPlayStartTime,this.audio.webAudio.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",JSON.stringify(this.audio.webAudio.mixAudioConf)),this.logger.log("已经播放的时间: ",l),l>this.audio.webAudio.mixAudioConf.totalTime&&(l%=this.audio.webAudio.mixAudioConf.totalTime),o=l),this.logger.log("回复重置的时间点：",o),this.audio.webAudio.resumeAudioMixing({buffer:this.audio.mixAudioConf.audioBuffer[r],loopback:s,replace:a,cycle:n,playStartTime:o,auidoMixingEnd:c})}setAudioMixingVolume(e){var t;let i,r;return(null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(!Number.isInteger(e)||e<0||e>255)&&(r="adjustAudioMixingVolume() volume应该是1-255的number类型",i=u.default.AUDIO_MIX_VOLUME_ERROR):(r="adjustAudioMixingVolume() 当前没有开启伴音",i=u.default.AUDIO_MIX_NOT_STATE_ERROR),this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:i?-1:0,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:r||"",volume:e}),null," ")}),i?(this.logger.error(r),Promise.reject(new h.default({code:i,message:r}))):this.audio.webAudio&&this.audio.webAudio.setAudioMixingVolume(e)}setAudioMixingPlayTime(e){var t;let i,r;if((null===(t=this.audio.webAudio)||void 0===t?void 0:t.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource){if(e<0)r="setAudioMixingPosition(): 设置的playStartTime 小于 0 了",i=u.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(e>=this.audio.webAudio.mixAudioConf.totalTime)r="setAudioMixingPosition(): 设置的playStartTime大于音频文件总时长了",i=u.default.AUDIO_MIX_PLAY_START_TIME_ERROR;else if(this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PAUSED)return this.audio.webAudio.mixAudioConf.setPlayStartTime=e,this.logger.log("setAudioMixingPosition() 当前正在暂停，记录设置的播放位置，在恢复伴音时，跳转到此次设置的播放位置: ",e),Promise.resolve()}else r="setAudioMixingPosition(): 当前没有开启伴音",i=u.default.AUDIO_MIX_NOT_STATE_ERROR;return this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:i?-1:0,param:JSON.stringify({playTime:e,reason:r||""},null," ")}),i?(this.logger.error(r),Promise.reject(new h.default({code:i,message:r}))):new Promise(((t,i)=>{this.stopAudioMixing(!1).then((r=>{if(!this.audio.webAudio)return;this.audio.mixAudioConf.playStartTime=e;let{audioFilePath:s="",loopback:a=!1,replace:n=!1,cycle:o=0,playStartTime:d=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf;this.logger.log("设置混音的播放位置:",this.audio.webAudio.mixAudioConf);let l=(Date.now()-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;this.logger.log("已经播放的时间: ",l),l>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime)),o-=Math.floor(l/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=o),this.logger.log(`setAudioMixingPlayTime, playTime: ${e}, cycle: ${o}`),this.audio.webAudio.setAudioMixingPlayTime({buffer:this.audio.mixAudioConf.audioBuffer[s],loopback:a,replace:n,cycle:o,playStartTime:d,auidoMixingEnd:c}).then((i=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:0,param:JSON.stringify({playTime:e},null," ")}),t(i)})).catch((t=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"重新播放伴音失败"+t.message},null," ")}),i(t)}))})).catch((t=>(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"暂停当前播放失败"+t.message},null," ")}),Promise.reject(t))))}))}getAudioMixingPlayedTime(){var e,t;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingCurrentPosition",code:0,param:JSON.stringify({playTime:null===(t=this.audio.webAudio.getAudioMixingPlayedTime())||void 0===t?void 0:t.playedTime},null," ")}),this.audio.webAudio.getAudioMixingPlayedTime()):(this.logger.log("getAudioMixingCurrentPosition() 当前没有开启伴音"),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingCurrentPosition() 当前没有开启伴音"})))}getAudioMixingTotalTime(){var e,t;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf)&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingDuration",code:0,param:JSON.stringify({totalTime:null===(t=this.audio.webAudio.getAudioMixingTotalTime())||void 0===t?void 0:t.totalTime},null," ")}),this.audio.webAudio.getAudioMixingTotalTime()):(this.logger.log("getAudioMixingDuration() 当前没有开启伴音"),Promise.reject(new h.default({code:u.default.AUDIO_MIX_NOT_STATE_ERROR,message:"getAudioMixingDuration() 当前没有开启伴音"})))}isMixAuido(){return!!(this.audio.webAudio&&this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource)}_initSoundIfNotExists(e,t){this.audio.mixAudioConf.sounds[e]||(this.audio.mixAudioConf.sounds[e]={soundId:e,state:"UNSTART",filePath:t||"",volume:100,sourceNode:null,gainNode:null,cycle:1,playStartTime:0,playOverTime:0,pauseTime:0,startTime:0,totalTime:0,options:{}}),t&&(this.audio.mixAudioConf.sounds[e].filePath=t)}async playEffect(e,t){const{soundId:i,filePath:r,cycle:s=1}=e,a={tag:"Stream.playEffect:filePath",value:r};f.checkExists(a);const n={tag:"Stream.playEffect:soundId",value:i,min:1,max:1e4};f.isExistOptions(n).result&&f.checkValidInteger(n);const o={tag:"Stream.playEffect:cycle",value:s,min:1,max:1e4};if(f.isExistOptions(o).result&&f.checkValidInteger(o),this._initSoundIfNotExists(i,r),this.audio.audioRoutingEnabled||this.enableAudioRouting(),0===this.getAudioInputTracks().length||!this.stream.pubStatus.audio.audio)return Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_NO_AUDIO,message:"playEffect() 当前没有开启麦克风，无法使用音效功能"}));if(!this.audio.webAudio||!this.audio.webAudio.context)return this.logger.log("playEffect() 浏览器不支持"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_NO_SUPPORT,message:"playEffect() 当前浏览器不支持音效功能"}));if(this.audio.mixAudioConf.sounds[i]&&("STARTING"===this.audio.mixAudioConf.sounds[i].state||"PLAYED"===this.audio.mixAudioConf.sounds[i].state||"PAUSED"===this.audio.mixAudioConf.sounds[i].state)&&(this.logger.log(`pauseEffect: 该音效文件正处于: ${this.audio.mixAudioConf.sounds[i].state} 状态`),void 0===t))return Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_ERROR,message:"playEffect() playStartTime 异常"}));this.audio.mixAudioConf.sounds[i].state="STARTING",this.audio.mixAudioConf.audioBuffer[r]?this.logger.log("playEffect: 已经 load 音效文件"):(this.logger.log("playEffect, 先 load 音效文件"),await this.preloadEffect(i,r));try{const a=this.audio.webAudio.createAudioBufferSource(this.audio.mixAudioConf.audioBuffer[r]);this.audio.mixAudioConf.sounds[i].sourceNode=a.sourceNode,a&&a.sourceNode&&(a.sourceNode.onended=e=>{this.stopEffect(i)}),this.audio.mixAudioConf.sounds[i].gainNode=a.gainNode,this.audio.mixAudioConf.sounds[i].totalTime=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration,this.audio.mixAudioConf.sounds[i].cycle=s;const n=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration;this.audio.mixAudioConf.sounds[i].playOverTime=n,s>1&&(this.audio.mixAudioConf.sounds[i].playOverTime=s*n-this.audio.mixAudioConf.sounds[i].playStartTime),this.audio.mixAudioConf.sounds[i].playStartTime=t||0,this.audio.webAudio.startAudioEffectMix(this.audio.mixAudioConf.sounds[i]),this.audio.mixAudioConf.sounds[i].state="PLAYED",this.audio.mixAudioConf.sounds[i].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"playEffect",code:0,param:JSON.stringify(e,null," ")})}catch(e){}}async stopEffect(e){var t;const i={tag:"Stream.stopEffect:soundId",value:e};let r,s;if(f.isExistOptions(i).result&&f.checkValidInteger(i),this.audio.mixAudioConf.sounds[e]||(s="stopEffect() soundId找不到对应的音效文件",r=u.default.AUDIO_EFFECT_FILE_LOST_ERROR),r)throw new h.default({code:r,message:s});null===(t=this.audio.webAudio)||void 0===t||t.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].state="STOPED",this._audioFilePlaybackCompletedEvent(),this.stream.client.apiFrequencyControl({name:"stopEffect",code:0,param:JSON.stringify(e,null," ")})}async pauseEffect(e){const t={tag:"Stream.pauseEffect:soundId",value:e};let i,r;if(f.isExistOptions(t).result&&f.checkValidInteger(t),this.audio.mixAudioConf.sounds[e]){if("PAUSED"===this.audio.mixAudioConf.sounds[e].state)return void this.logger.log("pauseEffect: 已经暂停");"PLAYED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("pauseEffect: 当前没有开启该音效"),r="pauseEffect() 当前没有开启该音效",i=u.default.AUDIO_EFFECT_NOT_STATE_ERROR)}else r="pauseEffect() soundId找不到对应的音效文件",i=u.default.AUDIO_EFFECT_FILE_LOST_ERROR;if(i)throw new h.default({code:i,message:r});if(!this.audio.webAudio)return;this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].pauseTime=Date.now(),this.audio.mixAudioConf.sounds[e].state="PAUSED";let s=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;this.logger.log("pauseEffect 已经播放的时间: ",s),s>this.audio.mixAudioConf.sounds[e].totalTime&&(s%=this.audio.mixAudioConf.sounds[e].totalTime),this.logger.log("pauseEffect 暂停位置: ",s),this.stream.client.apiFrequencyControl({name:"pauseEffect",code:0,param:JSON.stringify(e,null," ")})}async resumeEffect(e){const t={tag:"Stream.resumeEffect:soundId",value:e};let i,r;if(f.isExistOptions(t).result&&f.checkValidInteger(t),this.audio.mixAudioConf.sounds[e]?"PAUSED"!==this.audio.mixAudioConf.sounds[e].state&&(r="resumeEffect() 当前没有暂停该音效文件",i=u.default.AUDIO_EFFECT_NOT_PAUSE):(r="resumeEffect() soundId找不到对应的音效文件",i=u.default.AUDIO_EFFECT_FILE_LOST_ERROR),i)throw new h.default({code:i,message:r});if(!this.audio.webAudio)return;let s=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;if(this.logger.log("resumeEffect 已经播放的时间: ",s),s>this.audio.mixAudioConf.sounds[e].totalTime){const t=Math.floor(s/this.audio.mixAudioConf.sounds[e].totalTime);this.logger.log("播放过的圈数 playedCycle: ",t),s%=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle=this.audio.mixAudioConf.sounds[e].cycle-t}this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle>1&&(this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].cycle*this.audio.mixAudioConf.sounds[e].totalTime-this.audio.mixAudioConf.sounds[e].playStartTime),s>this.audio.mixAudioConf.sounds[e].totalTime&&(s%=this.audio.mixAudioConf.sounds[e].totalTime),this.audio.mixAudioConf.sounds[e].playStartTime=s,this.logger.log("resumeEffect 回复重置的时间点：",s),this.playEffect({soundId:e,filePath:this.audio.mixAudioConf.sounds[e].filePath,cycle:this.audio.mixAudioConf.sounds[e].cycle},s),this.audio.mixAudioConf.sounds[e].state="PLAYED",this.audio.mixAudioConf.sounds[e].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"resumeEffect",code:0,param:JSON.stringify(e,null," ")})}async setVolumeOfEffect(e,t){var i;const r={tag:"Stream.setVolumeOfEffect:soundId",value:e,min:1};if(f.isExistOptions(r).result&&f.checkValidInteger(r),!this.audio.mixAudioConf.sounds[e])throw new h.default({code:u.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"resumeEffect() soundId找不到对应的音效文件"});const s={tag:"Stream.setVolumeOfEffect:volume",value:t,min:0,max:100};f.isExistOptions(s).result&&f.checkValidInteger(s),this.logger.log(`setVolumeOfEffect 设置 ${e} 音效文件的音量: ${t}`),this._initSoundIfNotExists(e);const a=null===(i=this.audio.mixAudioConf.sounds[e])||void 0===i?void 0:i.gainNode;a?a.gain.value=t/100:this.logger.log("setVolumeOfEffect: no gainNode"),this.audio.mixAudioConf.sounds[e].volume=t,this.stream.client.apiFrequencyControl({name:"setVolumeOfEffect",code:0,param:JSON.stringify({soundId:e,volume:t},null," ")})}async preloadEffect(e,t){const i={tag:"Stream.preloadEffect:filePath",value:t};f.checkExists(i);const r={tag:"Stream.preloadEffect:soundId",value:e};if(f.isExistOptions(r).result&&f.checkValidInteger(r),this.logger.log(`preloadEffect 设置soundId: ${e}, 音效文件的filePath: ${t}`),this._initSoundIfNotExists(e,t),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.audio.mixAudioConf.audioBuffer[t])this.logger.log("preloadEffect: 已经 load 音效文件");else try{await this.loadAudioBuffer(t),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:0,param:JSON.stringify({soundId:e,filePath:t},null," ")})}catch(e){throw this.logger.error("preloadEffect 错误: ",e.name,e.message),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:-1,param:JSON.stringify({reason:e.message},null," ")}),e}}async unloadEffect(e){const t={tag:"Stream.unloadEffect:soundId",value:e,min:1};return f.isExistOptions(t).result&&f.checkValidInteger(t),this.logger.log(`unloadEffect() ${e} 音效文件`),this.audio.mixAudioConf.sounds[e]?"UNSTART"!==this.audio.mixAudioConf.sounds[e].state&&"STOPED"!==this.audio.mixAudioConf.sounds[e].state?(this.logger.log("unloadEffect() 该音效文件正在播放"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_PLAY_ALREADY,message:"unloadEffect() 该音效文件正在播放"}))):(delete this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.sounds[e].filePath],delete this.audio.mixAudioConf.sounds[e],void this.stream.client.apiFrequencyControl({name:"unloadEffect",code:0,param:JSON.stringify({soundId:e},null," ")})):(this.logger.log("unloadEffect() 没有该音效文件"),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:"unloadEffect() soundId找不到对应的音效文件"})))}getEffectsVolume(){this.logger.log("getEffectsVolume()");const e=[];return Object.values(this.audio.mixAudioConf.sounds).forEach((t=>{e.push({soundId:t.soundId,volume:t.volume})})),this.stream.client.apiFrequencyControl({name:"getEffectsVolume",code:0,param:JSON.stringify(e,null,2)}),e}setEffectsVolume(e){const t={tag:"Stream.setEffectsVolume:volume",value:e,min:0,max:100};f.isExistOptions(t).result&&f.checkValidInteger(t),this.logger.log("setEffectsVolume(), 设置音量: "+e),Object.values(this.audio.mixAudioConf.sounds).forEach((t=>{this.setVolumeOfEffect(t.soundId,e)})),this.stream.client.apiFrequencyControl({name:"setEffectsVolume",code:0,param:JSON.stringify({volume:e},null,2)})}async stopAllEffects(){this.logger.log("stopAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach((e=>{"PLAYED"!==e.state&&"PAUSED"!==e.state||this.stopEffect(e.soundId)})),this.stream.client.apiFrequencyControl({name:"stopAllEffects",code:0,param:JSON.stringify("stopAllEffects",null,2)})}async pauseAllEffects(){this.logger.log("pauseAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach((e=>{"PLAYED"===e.state&&this.pauseEffect(e.soundId)})),this.stream.client.apiFrequencyControl({name:"pauseAllEffects",code:0,param:JSON.stringify("pauseAllEffects",null,2)})}async resumeAllEffects(){this.logger.log("resumeAllEffects()"),Object.values(this.audio.mixAudioConf.sounds).forEach((e=>{"PAUSED"===e.state&&this.resumeEffect(e.soundId)})),this.stream.client.apiFrequencyControl({name:"resumeAllEffects",code:0,param:JSON.stringify("resumeAllEffects",null,2)})}getAudioEffectsTotalTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsDuration: 当前没有音效文件"),Promise.resolve();let s;return this._initSoundIfNotExists(t,i),"PLAYED"===this.audio.mixAudioConf.sounds[t].state&&(s=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsDuration",code:0,param:JSON.stringify({totalTime:s},null," ")}),s}getAudioEffectsPlayedTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsCurrentPosition() 当前没有音效文件"),Promise.resolve();this._initSoundIfNotExists(t,i);let s=Date.now();"PAUSED"==this.audio.mixAudioConf.sounds[t].state&&(this.logger.log("getAudioEffectsCurrentPosition() 当前是暂停状态"),s=this.audio.mixAudioConf.sounds[t].pauseTime);let a=(s-this.audio.mixAudioConf.sounds[t].startTime)/1e3+this.audio.mixAudioConf.sounds[t].playStartTime;return a>this.audio.mixAudioConf.sounds[t].totalTime&&(a%=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioEffectsCurrentPosition",code:0,param:JSON.stringify({playTime:a},null," ")}),{playedTime:a}}loadAudioBuffer(e){return l.ajax({url:e,type:"GET",dataType:"arraybuffer"}).then((t=>(this.logger.log("loadAudioBuffer 加载 audio file 成功"),new Promise(((i,r)=>{var s,a;null===(a=null===(s=this.audio.webAudio)||void 0===s?void 0:s.context)||void 0===a||a.decodeAudioData(t,(t=>{this.logger.log("loadAudioBuffer audio file 解码成功"),this.audio.mixAudioConf.audioBuffer[e]=t,i(t)}),(e=>{this.logger.log("loadAudioBuffer 云端音乐解码失败：",e.message),r(new h.default({code:u.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 云端音乐解码失败: ${e.name} ${e.message}`}))}))}))))).catch((e=>(this.logger.log("loadAudioBuffer 加载云端音乐失败: ",e),Promise.reject(new h.default({code:u.default.AUDIO_EFFECT_FILE_ERROR,message:`loadAudioBuffer: 加载云端音乐失败: ${e.name} ${e.message}`})))))}getAudioInputTracks(){var e,t;let i=[];return"live"===(null===(e=this.audio.audioSource)||void 0===e?void 0:e.readyState)&&i.push(this.audio.audioSource),"live"===(null===(t=this.audio.micTrack)||void 0===t?void 0:t.readyState)&&i.push(this.audio.micTrack),i}getAudioSlaveInputTracks(){var e,t;let i=[];return"live"===(null===(e=this.screenAudio.screenAudioTrack)||void 0===e?void 0:e.readyState)&&i.push(this.screenAudio.screenAudioTrack),"live"===(null===(t=this.screenAudio.screenAudioSource)||void 0===t?void 0:t.readyState)&&i.push(this.screenAudio.screenAudioSource),i}enableAudioRouting(){if(this.audio.webAudio&&this.audio.webAudio.destination){this.audio.audioRoutingEnabled=!0;const e=this.audio.webAudio.destination.stream.getAudioTracks()[0];this.logger.log("enableAudioRouting: ",e.label);const t=this.audio.audioStream.getAudioTracks()[0];t&&(e.enabled=t.enabled,t.enabled=!0),m.emptyStreamWith(this.audio.audioStream,e),this.stream.audioLevelHelper&&this.stream.audioLevelHelper.updateStream(this.audio.audioStream),this.updateAudioSender(e)}else this.logger.log("enableAudioRouting: 已替换为Destination")}disableAudioRouting(){const e=this.getAudioInputTracks();if(e.length){1===e.length?this.logger.log("disableAudioRouting: ",e[0].label):this.logger.warn("disableAudioRouting: 仍然有多于一个输入",...e);const t=this.audio.audioStream.getAudioTracks()[0];m.emptyStreamWith(this.audio.audioStream,e[0]),e[0].enabled=t.enabled,t.enabled=!0,this.updateAudioSender(e[0])}else this.logger.log("disableAudioRouting quiet."),m.emptyStreamWith(this.audio.audioStream,null);this.audio.audioRoutingEnabled=!1}updateAudioSender(e){var t,i,r,s,a,n,o,d,c,l,u,h,p,m,f,g,v;if(this.stream.isRemote)throw new Error("updateAudioSender only for localStream");if(null===(i=null===(t=this.stream.getAdapterRef())||void 0===t?void 0:t._mediasoup)||void 0===i?void 0:i._micProducer)if(null===(a=null===(s=null===(r=this.stream.getAdapterRef())||void 0===r?void 0:r._mediasoup)||void 0===s?void 0:s._micProducer)||void 0===a?void 0:a._rtpSender)this.logger.info("updateAudioSender: 替换当前_micProducer的track",e.label),null===(c=null===(d=null===(o=null===(n=this.stream.getAdapterRef())||void 0===n?void 0:n._mediasoup)||void 0===o?void 0:o._micProducer)||void 0===d?void 0:d._rtpSender)||void 0===c||c.replaceTrack(e);else if(null===(p=null===(h=null===(u=null===(l=this.stream.getAdapterRef())||void 0===l?void 0:l._mediasoup)||void 0===u?void 0:u._sendTransport)||void 0===h?void 0:h.handler)||void 0===p?void 0:p._pc){const t=null===(g=null===(f=null===(m=this.stream.getAdapterRef())||void 0===m?void 0:m._mediasoup)||void 0===f?void 0:f._sendTransport)||void 0===g?void 0:g.handler._pc.audioSender;t&&(this.logger.info("updateAudioSender: 替换audioSender",null===(v=null==t?void 0:t.track)||void 0===v?void 0:v.label),t.replaceTrack(e))}}enablePreProcessing(e,t){b.enablePreProcessing(this,e,t)}disablePreProcessing(e,t=!1){b.disablePreProcessing(this,e,t)}canDisablePreProcessing(e){return b.canDisablePreProcessing(this,e)}getPreprocessingStats(e="video"){var t;const i=null===(t=this[e].preProcessing)||void 0===t?void 0:t.history;if(!(null==i?void 0:i.length))return null;const r=i[i.length-1].endTs-i[0].startTs,s={total:0};for(let e=0;e<i.length;e++){s.total+=i[e].endTs-i[e].startTs;for(let t of i[e].handlerTs)t.spent>0&&(s[t.name]||(s[t.name]=0),s[t.name]+=t.spent)}return{fps:1e3*i.length/r,load:s.total/r,delay:s.total/i.length,spent:s}}replaceConstraint(e,t){var i,r,s,a,n,o;(null==e?void 0:e.video)&&("safari16_screen"===R.getParameters().replaceIdealConstraint&&v.IS_SAFARI&&v.SAFARI_MAJOR_VERSION&&v.SAFARI_MAJOR_VERSION>=16&&"screen"===t||"all"===R.getParameters().replaceIdealConstraint)&&((null===(r=null===(i=null==e?void 0:e.video)||void 0===i?void 0:i.width)||void 0===r?void 0:r.ideal)&&(e.video.width.max=e.video.width.ideal,delete e.video.width.ideal),(null===(a=null===(s=null==e?void 0:e.video)||void 0===s?void 0:s.height)||void 0===a?void 0:a.ideal)&&(e.video.height.max=e.video.height.ideal,delete e.video.height.ideal),(null===(o=null===(n=null==e?void 0:e.video)||void 0===n?void 0:n.frameRate)||void 0===o?void 0:o.ideal)&&(e.video.frameRate.max=e.video.frameRate.ideal,delete e.video.frameRate.ideal))}destroy(){this.logger.log("清除 meida"),this._reset()}}t.MediaHelper=w},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageAIProcessing=void 0;const r=i(160),s=i(290);class a extends r.StageBase{constructor(e,t){super(e),this.type="stageAIProcessing",this.node=null,this.audioWorkletAgent=null,this.AIDenoise=null,this.enableAIDenoise=!0,this.pluginList=[],this.logger=t,this.enabled=!1}hasPlugin(e){return-1!==this.pluginList.indexOf(e)}registerPlugin(e,t,i){"AIDenoise"===e&&(this.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"))}registerAIDenoisePlugin(e,t){this.AIDenoise=e}async init(){var e;this.state="INITING",this.audioWorkletAgent||(this.audioWorkletAgent=new s.AudioWorkletAgent({logger:this.logger,context:this.context}),this.node=this.audioWorkletAgent.node,await this.audioWorkletAgent.init(),this.audioWorkletAgent.on("rawinputs",(e=>{this.enabled&&this.AIDenoise&&this.AIDenoise.load&&this.AIDenoise.process(e.inputs[0],(t=>{t.length&&(e.inputs[0]=t),this.audioWorkletAgent.outputData(e.inputs[0])}))}))),null===(e=this.AIDenoise)||void 0===e||e.init(),this.state="INITED"}unregisterAIDenoise(){this.AIDenoise&&(this.AIDenoise.destroy(),this.AIDenoise=null),this.state="UNINIT"}}t.StageAIProcessing=a},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Play=void 0;const s=i(11),a=i(68),n=r(i(12)),o=r(i(13)),d=i(155),c=i(59),l=i(2),u=i(293),h=i(294),p=i(127),m=i(75),f=i(72);class g extends s.EventEmitter{constructor(e){super(),this.snapshotIndex=0,this.sinkId=null,this.audio={normalizedVolume:1,dom:null},this.audioSlave={normalizedVolume:1,dom:null},this.mask={enabled:!1},this.stream=e.stream,this.logger=e.stream.logger.getChild((()=>{var e,t;let i="player";return(null===(e=this.audio.dom)||void 0===e?void 0:e.paused)&&(i+=" audio_paused"),(null===(t=this.audioSlave.dom)||void 0===t?void 0:t.paused)&&(i+=" audioSlave_paused"),i})),this.video={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:u.createCanvasWatermarkControl(this.logger),encoderWatermark:h.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}},this.screen={dom:null,containerDom:null,view:null,size:{width:0,height:0},canvasWatermark:u.createCanvasWatermarkControl(this.logger),encoderWatermark:h.createEncoderWatermarkControl(this.logger),frameData:{canvas:null,context:null},renderMode:{width:0,height:0,cut:!1}}}_initDomAndView(e){const t=this[e];if(t.view){if(!t.containerDom){const i=document.createElement("div");t.containerDom=i,t.containerDom.className=`nertc-${e}-container nertc-${e}-container-${this.stream.isRemote?"remote":"local"}`,i.style.overflow="hidden",i.style.position="relative",i.style.width=t.view.clientWidth+"px",i.style.height=t.view.clientHeight+"px",i.style.display="inline-block"}if(!t.dom){const i=document.createElement("video");t.dom=i,i.style.position="absolute",i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%,-50%)",i.setAttribute("x-webkit-airplay","x-webkit-airplay"),i.setAttribute("playsinline","playsinline"),i.setAttribute("webkit-playsinline","webkit-playsinline"),i.preload="auto",i.dataset.uid=""+this.stream.getId(),i.autoplay=!0,i.muted=!0,t.size.width=0,t.size.height=0,l.getParameters().controlOnPaused&&(i.addEventListener("pause",this.showControlIfVideoPause.bind(this)),i.addEventListener("play",this.handleVideoScreenPlay.bind(this)),i.addEventListener("click",this.handleVideoScreenClick.bind(this))),i.addEventListener("resize",(r=>{if(!this[e].dom||this[e].dom!==i||this[e].dom!==r.target)return;const s=i.videoWidth,a=i.videoHeight;s>2&&a>2&&this.stream.isRemote&&this.stream.client.adapterRef.state.videoResizeTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.videoResizeTime=Date.now()),s===t.size.width&&a===t.size.height||(this.logger.log(`[Play] 视频分辨率发生变化：${e} ${t.size.width}x${t.size.height} => ${s}x${a}。当前父节点：${c.getDomInfo(t.view)}${t.size.width<4?" 首帧渲染":""}`),s>a&&t.size.width>t.size.height||s<a&&t.size.width<t.size.height||this.setRender(e),t.size.width=s,t.size.height=a)}))}t.containerDom==t.dom.parentNode?this.logger.log("[Play] initVideoNode: 节点已挂载，请勿重复挂载"):(t.containerDom.appendChild(t.dom),this.logger.log("[Play] initVideoNode "+e)),t.view==t.containerDom.parentNode?this.logger.log("[Play] mountVideoToDom: 节点已挂载，请勿重复挂载"):(this.logger.log("[Play] mountVideoToDom"),t.view.appendChild(t.containerDom),this.logger.log("[Play] 视频主流dom节点挂载成功。父节点："+c.getDomInfo(t.view)),t.canvasWatermark.watermarks.length?t.canvasWatermark.start(t.containerDom):t.canvasWatermark.div=t.containerDom)}}showControlIfVideoPause(){a.MediaTypeList.forEach((e=>{const t=this[e].dom;(null==t?void 0:t.paused)&&this.logger.log("[Play] 可能遇到了播放问题",e)}))}handleVideoScreenClick(){a.MediaTypeList.forEach((e=>{const t=this[e].dom;(null==t?void 0:t.paused)&&(this.logger.log("[Play] 侦测到视频点击，尝试恢复播放:"+e),t.play())}))}handleVideoScreenPlay(){a.MediaTypeList.forEach((e=>{const t=this[e].dom;!1===(null==t?void 0:t.paused)&&this.logger.log("[Play] 侦测到播放: "+e)}))}isPlaying(e){let t=this[e].dom;if(!t)return!1;if(!t.srcObject)return!1;if(t.paused)return!1;if(4!==t.readyState)return!1;{let i=t.srcObject.getTracks()[0];if(!i)return!1;if(!i.enabled)return!1;if(i.muted)return!1;if("audio"===e||"audioSlave"===e){if(t.muted)return!1;if(0===t.volume)return!1}}return!0}canPlay(e){const t={result:!1,reason:""},i=this.stream.mediaHelper.getTrackByMediaType(e),r=this[e].dom;return i?"ended"===i.readyState?t.reason="ENDED":i.muted||!i.enabled?t.reason="MUTED":r&&r.srcObject?r.paused?"audio"===i.kind?t.result=!0:t.reason="PAUSED":t.reason="PLAYING":t.result=!0:this.stream.isRemote?this.stream.pubStatus[e].producerId?this.stream.pubStatus[e].consumerId?"end"!==this.stream.pubStatus[e].consumerStatus?t.reason="CONSUME_"+this.stream.pubStatus[e].consumerStatus:t.reason="INVALID_STATE":t.reason="NOT_SUBSCRIBED":t.reason="NOT_PUBLISHED":t.reason="NOT_OPENED",t}async resume(){const e=[];a.MediaTypeList.forEach((t=>{const i=this[t].dom;if(null==i?void 0:i.paused){const r=i.play();e.push(r),r.then((()=>{this.logger.log(`[Resume] 恢复播放: ${t} 成功`)})),r.catch((e=>{if(this.logger.error(`[Resume] 恢复播放 ${t} 出现问题:`,e.name,e.message),"notAllowedError"===e.name||"NotAllowedError"===e.name)throw new o.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"resume: 浏览器自动播放受限: "+e.name})}))}}));try{await Promise.all(e)}catch(e){}}updatePlaybackVolume(){a.MediaTypeListAudio.forEach((e=>{const t=this[e].dom;if(t){let i;i=this.stream.isRemote?this.stream.client.adapterRef.nomalizedPlaybackVolume*this[e].normalizedVolume:this[e].normalizedVolume,Math.abs(t.volume-i)>.01&&(this.logger.log(`updatePlaybackVolume ${e} ${t.volume} => ${i} ( ${this.stream.client.adapterRef.nomalizedPlaybackVolume} * ${this[e].normalizedVolume})`),t.volume=i)}}))}async playAudioStream(e,t,i){const r=this[e];r.dom||(r.dom=document.createElement("audio"));const s=r.dom;if(s.muted="boolean"==typeof i&&i,s.srcObject=t,this.updatePlaybackVolume(),this.sinkId){this.logger.log(`[Play ${e}] 音频尝试使用输出设备`,this.sinkId);try{await s.setSinkId(this.sinkId),this.logger.log(`[Play] ${e} 音频使用输出设备成功`,this.sinkId)}catch(e){this.logger.error("[Play] 音频输出设备切换失败",e.name,e.message,e)}}try{await this.playDomElement(s,l.getParameters().playMediaTimeout),this.logger.log("[Play] 播放音频完成，当前播放状态:",s.played.length),this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"success",streamUid:this.stream.stringStreamID,muted:s.muted,active:s.srcObject.active,played:s.played.length},null," ")})}catch(t){if(this.logger.warn(`[Play ${e}] 播放音频出现问题: `,t.name,t.message,t),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"fail",reason:`${t.name} + ${t.message}`,uid:this.stream.stringStreamID,muted:s.muted,active:s.srcObject.active,played:s.played.length},null," ")}),"notAllowedError"===t.name||"NotAllowedError"===t.name)throw new o.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:`playStream ${e}: 浏览器自动播放受限: ${t.name}`})}}setPlayVolume(e,t){this[e].normalizedVolume=t,this.updatePlaybackVolume()}async playVideoStream(e,t,i){var r,s,a;const d=this[e];if((null===(r=d.dom)||void 0===r?void 0:r.srcObject)!==t){d.view=i,this._initDomAndView(e),this.mask.enabled&&this.enableMask();try{const i=t.getVideoTracks()[0];if(i){let t="getSettings"in MediaStreamTrack.prototype?i.getSettings():i.getConstraints();this.logger.log(`[Play] 开始加载 ${e} 播放视频源：视频参数 "${i.label}",enabled ${i.enabled} , ${JSON.stringify(t)}`)}else this.logger.error(`[Play ${e}] 加载播放视频源失败：没有视频源`);const r=d.dom;if(!r)return;r.srcObject=t,this.stream.isRemote&&this.stream.client.adapterRef.state.domVideoAppendTime<this.stream.client.adapterRef.state.signalJoinSuccessTime&&(this.stream.client.adapterRef.state.domVideoAppendTime=Date.now()),await this.playDomElement(r,l.getParameters().playMediaTimeout),this.logger.log(`[Play] 成功加载主流播放视频源：当前视频实际分辨率${r.videoWidth}x${r.videoHeight}，显示宽高${r.offsetWidth}x${r.offsetHeight}`),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,muted:r.muted,active:r.srcObject.active,played:r.played.length},null," ")}),r.paused&&l.getParameters().controlOnPaused&&this.showControlIfVideoPause()}catch(i){if(this.logger.warn(`[Play ${e}] 播放视频出现问题:`,i.name,i.message,i),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"1",value:JSON.stringify({result:"fail",reason:`${i.name} + ${i.message}`,uid:this.stream.stringStreamID,muted:null===(s=null==d?void 0:d.dom)||void 0===s?void 0:s.muted,active:t.active,played:null===(a=null==d?void 0:d.dom)||void 0===a?void 0:a.played.length},null," ")}),"notAllowedError"===i.name||"NotAllowedError"===i.name)throw new o.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: "+i.name})}}else this.logger.log(`[Play ${e}] playVideoStream: 跳过重复的播放请求`)}async stopPlayStream(e){"audio"===e||"audioSlave"===e?this._stopPlayAudioStream(e):"video"!==e&&"screen"!==e||this._stopPlayVideoStream(e)}async _stopPlayAudioStream(e){const t=this[e].dom;t&&(t.muted=!0,t.srcObject=null,this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,muted:t.muted},null," ")}))}async _stopPlayVideoStream(e){this.logger.log("stopPlayVideoStream 停止播放 "+e);const t=this[e].view,i=this[e].containerDom,r=this[e].dom;if(i&&r){i===r.parentNode?(this.logger.log(`清除 ${e} dom`),i.removeChild(r)):i.lastChild&&(this.logger.log("videoContainerDom 删除子节点"),i.removeChild(i.lastChild));try{r.remove(),r.srcObject=null,this[e].dom=null,this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID},null," ")})}catch(t){this.logger.log("stopPlayVideoStream e: ",t),this.stream.client.apiEventReport("setFunction",{name:`set_${e}_play`,oper:"0",value:JSON.stringify({result:"failed",uid:this.stream.stringStreamID,reason:t.message},null," ")})}}t&&i&&(t==i.parentNode?(this.logger.log(`清除 ${e} containerDom`),t.removeChild(i)):t.lastChild&&(this.logger.log(e+" View 删除子节点"),t.removeChild(t.lastChild),t.innerHTML=""),this[e].containerDom=null,this[e].view=null)}setRender(e,t){var i,r,s,a;const n=this[e],o=n.containerDom,d=n.dom;if(t?(this.logger.log(`[Play ${e}] setRender() options: ${JSON.stringify(t)}`),n.renderMode=Object.assign({},t)):(t=n.renderMode,this.logger.log("[Play] setVideoRender() existing videoRenderMode: "+JSON.stringify(t))),o&&d)return o.style.width=t.width+"px",o.style.height=t.height+"px",t.cut?(d.videoWidth/d.videoHeight>t.width/t.height?(d.style.width="auto",d.style.height="100%"):(d.style.width="100%",d.style.height="auto"),void this.stream.client.apiEventReport("setFunction",{name:"set_render_"+e,oper:"1",value:JSON.stringify({result:"success",uid:this.stream.stringStreamID,played:d.played.length,domStyleWidth:d.style.width,domStyleHeight:d.style.height,containerDomWidth:null===(r=null===(i=n.containerDom)||void 0===i?void 0:i.style)||void 0===r?void 0:r.width,containerDomHeight:null===(a=null===(s=n.containerDom)||void 0===s?void 0:s.style)||void 0===a?void 0:a.height},null," ")})):(d.style.height="100%",void(d.style.width="100%"))}async setAudioOutput(e){this.sinkId=e;for(let t of a.MediaTypeListAudio){const i=this[t].dom;(null==i?void 0:i.srcObject)&&i.srcObject.getAudioTracks().length&&(await i.setSinkId(e),this.logger.log("[Play] setAudioOutput() 设置通话音频输出设备成功"))}}async takeSnapshot(e,t,i){if(this.mask.enabled)return this.logger.warn("takeSnapshot: 目前在打码状态"),null;let r=new d.RTCCanvas("canvas"),s=r._canvas,a=r._ctx;if(!a||!s)throw this.logger.error("takeSnapshot() 浏览器环境不支持"),new o.default({code:n.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"takeSnapshot() 浏览器环境不支持"});const c=["video","screen"];let l="";for(let n of c)if(!e.mediaType&&this[n].dom||e.mediaType===n){const o=e.name||(i||this.stream.getId())+"-"+this.snapshotIndex++;a.fillStyle="#ffffff";const d=this[n].dom;if(!d)return;a.fillRect(0,0,d.videoWidth,d.videoHeight),r.setSize(d.videoWidth,d.videoHeight),a.drawImage(d,0,0,d.videoWidth,d.videoHeight,0,0,d.videoWidth,d.videoHeight),"download"===t?l=await new Promise(((e,t)=>{s.toBlob((t=>{this.logger.log("takeSnapshot() 获取到截图的blob: ",t);let i=URL.createObjectURL(t),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=o+".png",r.click(),window.URL.revokeObjectURL(i),e(o+".png")}))})):"base64"===t&&(l=this.getBase64Image(s))}return r.destroy(),l}_initFrameDataCanvas(e){const t=this[e].frameData;return t.canvas||(this.logger.log("正在初始化 frameData.canvas "+e),t.canvas=document.createElement("canvas"),t.context=p.get2DContext(t.canvas,{willReadFrequently:!0})),t.context}getCurrentFrameData(e){if(this.mask.enabled)return this.logger.error("getCurrentFrameData: 当前在打码状态"),null;let t,i,r;if(r=e.mediaType&&"video"!==e.mediaType?"screen":"video",i=this[r].dom,t=this[r].frameData,!i)return this.logger.error("getCurrentFrameData: Playing Video is not found"),null;i.paused&&this.logger.warn("getCurrentFrameData: 目前数据源不在播放状态，截图结果可能不是最新。"),t.canvas||this._initFrameDataCanvas(r);const s=t.canvas,a=t.context;if(!a||!s)throw new o.default({code:n.default.STREAM_TAKE_SNAPSHOT_NO_CANVAS_ERROR,message:"getCurrentFrameData() 浏览器环境不支持"});const d=i.videoWidth,c=i.videoHeight;if(!d||!c)return null;let l,u;return e.width&&e.width>0?e.height&&e.height>0?(l=e.width,u=e.height):(l=e.width,u=Math.floor(e.width/d*c)):e.height&&e.height>0?(u=e.height,l=Math.floor(e.height/c*d)):(l=d,u=c),s.width!==l&&(s.width=l),s.height!==u&&(s.height=u),a.drawImage(i,0,0,l,u),a.getImageData(0,0,l,u)}getBase64Image(e){return e.toDataURL("image/",1)}async playDomElement(e,t){return new Promise(((i,r)=>{let s=setTimeout((()=>{s&&(s=null,i())}),t),a=setTimeout((()=>{var t,i;if(a&&(a=null,e.readyState===f.MEDIA_READYSTATE.HAVE_ENOUGH_DATA||l.getParameters().moreNotAllowedError)){const e=new o.default({code:n.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playDomElement: 浏览器自动播放受限，表现为Play既不成功也不失败。可尝试通过resume()恢复。"});this.stream.safeEmit("notAllowedError",e),null===(t=this.stream.getAdapterRef())||void 0===t||t.instance.safeEmit("NotAllowedError",e),null===(i=this.stream.getAdapterRef())||void 0===i||i.instance.safeEmit("notAllowedError",e)}}),l.getParameters().playMediaTimeoutForAutoplay);const d=e.play();m.printVideoState(d,e),d.then((()=>{s&&(clearTimeout(s),s=null,i()),a&&(clearTimeout(a),a=null)})).catch((e=>{s&&(clearTimeout(s),s=null,"AbortError"===(null==e?void 0:e.name)?i():r(e)),a&&(clearTimeout(a),a=null)}))}))}enableMask(){this.mask.enabled=!0,this.video.dom&&(this.video.dom.style.filter="blur(20px)")}disableMask(){this.mask.enabled=!1,this.video.dom&&(this.video.dom.style.filter=""),this.screen.dom&&(this.screen.dom.style.filter="")}destroy(){a.MediaTypeList.forEach((e=>{this.stopPlayStream(e)}))}}t.Play=g},function(e,t,i){var r;!function(s){var a,n,o,d=(a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,n=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,o=/[^-+\dA-Z]/g,function(e,t,i,r){if(1!==arguments.length||"string"!==function(e){return null===e?"null":void 0===e?"undefined":"object"!=typeof e?typeof e:Array.isArray(e)?"array":{}.toString.call(e).slice(8,-1).toLowerCase()}(e)||/\d/.test(e)||(t=e,e=void 0),(e=e||new Date)instanceof Date||(e=new Date(e)),isNaN(e))throw TypeError("Invalid date");var s=(t=String(d.masks[t]||t||d.masks.default)).slice(0,4);"UTC:"!==s&&"GMT:"!==s||(t=t.slice(4),i=!0,"GMT:"===s&&(r=!0));var l=i?"getUTC":"get",u=e[l+"Date"](),h=e[l+"Day"](),p=e[l+"Month"](),m=e[l+"FullYear"](),f=e[l+"Hours"](),g=e[l+"Minutes"](),v=e[l+"Seconds"](),_=e[l+"Milliseconds"](),y=i?0:e.getTimezoneOffset(),S=function(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setDate(t.getDate()-(t.getDay()+6)%7+3);var i=new Date(t.getFullYear(),0,4);i.setDate(i.getDate()-(i.getDay()+6)%7+3);var r=t.getTimezoneOffset()-i.getTimezoneOffset();t.setHours(t.getHours()-r);var s=(t-i)/6048e5;return 1+Math.floor(s)}(e),R=function(e){var t=e.getDay();return 0===t&&(t=7),t}(e),b={d:u,dd:c(u),ddd:d.i18n.dayNames[h],dddd:d.i18n.dayNames[h+7],m:p+1,mm:c(p+1),mmm:d.i18n.monthNames[p],mmmm:d.i18n.monthNames[p+12],yy:String(m).slice(2),yyyy:m,h:f%12||12,hh:c(f%12||12),H:f,HH:c(f),M:g,MM:c(g),s:v,ss:c(v),l:c(_,3),L:c(Math.round(_/10)),t:f<12?"a":"p",tt:f<12?"am":"pm",T:f<12?"A":"P",TT:f<12?"AM":"PM",Z:r?"GMT":i?"UTC":(String(e).match(n)||[""]).pop().replace(o,""),o:(y>0?"-":"+")+c(100*Math.floor(Math.abs(y)/60)+Math.abs(y)%60,4),S:["th","st","nd","rd"][u%10>3?0:(u%100-u%10!=10)*u%10],W:S,N:R};return t.replace(a,(function(e){return e in b?b[e]:e.slice(1,e.length-1)}))});function c(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}d.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},d.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},void 0===(r=function(){return d}.call(t,i,t,e))||(e.exports=r)}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.measureText=t.numberToRGBA=void 0,t.numberToRGBA=function(e){if(0===e)return"rgba(0,0,0,0)";let t,i,r,s;return r=e%256,i=(e=Math.floor(e/256))%256,t=(e=Math.floor(e/256))%256,s=(e=Math.floor(e/256))>0?(e%256/256).toFixed(2):1,`rgba(${t}, ${i}, ${r}, ${s})`},t.measureText=function(e,t,i){if(!e)return{width:0,height:0};let r=document.createElement("div"),s=document.createElement("span");s.innerText=e,s.style.fontSize=t,s.style.fontFamily=i,r.style.opacity="0",r.style.position="absolute",r.style.height=t,document.body.appendChild(r),r.appendChild(s);const a=r.clientHeight,n=s.offsetWidth;return r.remove(),{width:n,height:a}}},function(e,t,i){var r=a(i(65)),s=a(i(66));function a(e){return e&&e.__esModule?e:{default:e}}var n=i(170).EventEmitter,o=i(147);e.exports=class extends n{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new o("EnhancedEventEmitter")}safeEmit(e){try{for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.emit.apply(this,[e].concat(i))}catch(t){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t)}}safeEmitAsPromise(e){for(var t=this,i=arguments.length,a=Array(i>1?i-1:0),n=1;n<i;n++)a[n-1]=arguments[n];return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i,r){t.safeEmit.apply(t,[e].concat(a,[i,r]))})));case 1:case"end":return i.stop()}}),i,t)})))()}}},function(e,t,i){var r,s=(r=i(105))&&r.__esModule?r:{default:r},a=i(147),n=i(299).generateRandomNumber,o=i(124).JSONBigParse,d=new a("Message");e.exports=class{static parse(e){var t=void 0,i={};try{t=o(e)}catch(e){return void d.error("parse() | invalid JSONbig: %s",e)}if("object"===(void 0===t?"undefined":(0,s.default)(t))&&!Array.isArray(t)){if(t.request){if(i.request=!0,"string"!=typeof t.method)return void d.error("parse() | missing/invalid method field");if("number"!=typeof t.id)return void d.error("parse() | missing/invalid id field");i.id=t.id,i.method=t.method,i.data=t.data||{}}else if(t.response){if(i.response=!0,"number"!=typeof t.id)return void d.error("parse() | missing/invalid id field");i.id=t.id,t.ok?(i.ok=!0,i.data=t.data||{}):(i.ok=!1,i.errorCode=t.errorCode,i.errorReason=t.errorReason)}else{if(!t.notification)return void d.error("parse() | missing request/response field");if(i.notification=!0,"string"!=typeof t.method)return void d.error("parse() | missing/invalid method field");i.id=t.id,i.method=t.method,i.data=t.data||{}}return i}d.error("parse() | not an object")}static createRequest(e,t){return{request:!0,id:n(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,i){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:i}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(2),s=i(74),a=i(58);let n=window;const o={setLogLevel(e){r.getParameters().logLevel!==e&&(a.getDefaultLogger().info(`NERTC LogLevel was changed: ${s.loglevelMap[r.getParameters().logLevel]} => ${s.loglevelMap[e]}`),r.getParameters().logLevel=e)},enableLogUpload(){n.logUpload=!0},disableLogUpload(){n.logUpload=!1}};"on"===r.getParameters().forceLogUpload?o.enableLogUpload():o.disableLogUpload(),t.default=o},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.geofenceArea=void 0;const r=i(57),s=i(58),a=i(2);t.geofenceArea=new class{constructor(){this.areaCode="GLOBAL",this.regions=r.LBS_REGION_CONFIG,this.logger=s.getDefaultLogger().getChild((()=>"GeofenceArea "+this.areaCode))}setAreaById(e){if(this.regions[e]){const t=this.areaCode;this.areaCode=e,this.logger.log(`setArea: ${t} -> ${e}`)}else this.logger.error(`setAreaById: 不存在该区域：${e}。可用区域：${this.getAvailableAreas().join(",")}`);for(let e in a.getParameters().clients){const t=a.getParameters().clients[e];t.destroyed||"DISCONNECTED"!==t.adapterRef.connectState.curState||t.adapterRef.lbsManager.loadBuiltinConfig("setArea")}}getAvailableAreas(){const e=[];for(let t in this.regions)this.regions[t]&&this.regions[t].nrtc&&e.push(t);return e}getBuiltinConfig(){return"NONE"!==a.getParameters().forceGeofenceArea?this.regions[a.getParameters().forceGeofenceArea]:this.regions[this.areaCode]}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvBeautyFilter=t.resSet=void 0;const r=i(161),s=i(134),a=i(135),n=i(118),o=i(315),d=i(316),c=i(317),l=i(318),u=i(136),h=i(319),p=i(137);t.resSet={faceMask:"https://yx-web-nosdn.netease.im/common/6947be5d3e5604368401950ca0cf094d/facemask-01.png",eyeTeethMask:"https://yx-web-nosdn.netease.im/common/655421269305cac5c1e48d62f0fac8de/eye-teeth-mask-02.png",teethWhiten:"https://yx-web-nosdn.netease.im/common/ca8a6b0be3427ead9b19bcf9ae1245a8/teath.png"};const m={genTopFace(e){const t=h.Vector2.getVec(e,49),i=h.Vector2.getVec(e,43);let r=h.Vector2.sub(i,t),s=1.5*r.length;r=h.Vector2.normalize(r);const a=h.Vector2.sub(h.Vector2.getVec(e,0),i);let n=a.length;const o=h.Vector2.sub(h.Vector2.getVec(e,32),i);let d=o.length;const c=Math.max(n,d);let l=n/c,u=d/c;h.Vector2.setPoint(e,116,h.Vector2.add(i,h.Vector2.scale(r,s)));let p=h.Vector2.angle(a,r),m=h.Matrix3x3.rotate(p/-6,0,0),f=r;[110,109,108,107,106].forEach(((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,o=1*(1-a)+l*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*o*(1-a)+n*a)))})),p=h.Vector2.angle(o,r),m=h.Matrix3x3.rotate(p/6,0,0),f=r,[115,114,113,112,111].forEach(((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,n=1*(1-a)+u*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*n*(1-a)+d*a)))}))},genFaceOutline(e){const t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,106,107,108,109,110,111,112,113,114,115,116],i=h.Vector2.getVec(e,43);for(let r=0;r<t.length;r++){const s=t[r],a=h.Vector2.getVec(e,s),n=h.Vector2.add(i,h.Vector2.scale(h.Vector2.sub(a,i),1.3)),o=2*(117+r);e[o]=n.value[0]>>0,e[o+1]=n.value[1]>>0}}},f=new Set;let g=null,v=null,_=null;class y extends p.Filter{constructor(e,t,i,s,a,o,d,c,l,u,h,p){super(e,t,i,null),this.isShowWire=!1,this.advData=null,this.wirePosBuffer=null,this.targetPosBuffer=null,this.zIndexBuffer=null,this.indicesBuffer=null,this.faceMaskUVBuffer=null,this.planePosBuffer=null,this.planeUVBuffer=null,this.advEyeTeethPosBuffer=null,this.advEyeTeethIndicesBuffer=null,this.advEyeTeethZindexBuffer=null,this.advEyeTeethUVBuffer=null,this.defParams={enlargeEye:0,roundedEye:0,openCanthus:0,eyeDistance:.5,eyeAngle:.5,shrinkNose:0,lengthenNose:.5,shrinkMouth:.5,widenMouth:.5,mouthCorners:.5,adjustPhiltrum:.5,shrinkUnderjaw:0,shrinkCheekbone:0,lengthenJaw:.5,narrowedFace:0,shrinkFace:0,vShapedFace:0,minifyFace:0,shortenFace:0,whitenTeeth:0,brightenEye:0,fadeHeadWrinkle:0,fadeEyeRim:0,fadeNoseLine:0},f.add(this),this.faceMaskMap=n.createTexture(this.renderer.gl,g),this.eyeTeethMaskMap=n.createTexture(this.renderer.gl,v),this.whiteTeethLutMap=n.createTexture(this.renderer.gl,_,{flipY:!1}),this.params=Object.assign({},this.defParams),m.genTopFace(this.posBuffer.typedArray),m.genFaceOutline(this.posBuffer.typedArray),this.targetPosBuffer=r.createAttributeBuffer(this.renderer.gl,"tPosition",this.posBuffer.typedArray.slice(0),2),this.zIndexBuffer=s,this.indicesBuffer=a,this.faceMaskUVBuffer=o,this.planePosBuffer=d,this.planeUVBuffer=c,this.advEyeTeethPosBuffer=l,this.advEyeTeethIndicesBuffer=u,this.advEyeTeethZindexBuffer=h,this.advEyeTeethUVBuffer=p,this.setWirePosBuffer(),this.initProgramBuffer()}setWirePosBuffer(){if(!this.isShowWire)return;const e=new Set,t=[],i=this.indicesBuffer.typedArray,s=this.posBuffer.typedArray,a=(i,r)=>{if(!e.has(i+"-"+r)&&!e.has(r+"-"+i)){e.add(i+"-"+r);const a=2*i,n=2*r;t.push(s[a],s[a+1],s[n],s[n+1])}};for(let e=0;e<(i.length-2)/3;e++){const t=3*e,r=i[t],s=i[t+1],n=i[t+2];a(r,s),a(s,n),a(n,r)}this.wirePosBuffer?this.programs.wire.updateAttribute("position",(e=>{e.set(t,0)})):this.wirePosBuffer=r.createAttributeBuffer(this.renderer.gl,"position",new Int16Array(t),2)}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i={width:t.width>>2,height:t.height>>2};let r=null;if(this.isShowWire){const i=new a.Program(e,(()=>{var t;e.drawArrays(e.LINES,0,(null===(t=this.wirePosBuffer)||void 0===t?void 0:t.count)||0)}));i.setShader(c.advBeautyWireShader.vShader,"VERTEX"),i.setShader(c.advBeautyWireShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.wirePosBuffer),r=s.createFrameBuffer(e,t.width,t.height),i.setUniform("size",[t.width,t.height]),this.programs.wire=i,this.framebuffers.wire=r}const n=new a.Program(e,(()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0)}));n.setShader(d.advBeautyShader.vShader,"VERTEX"),n.setShader(d.advBeautyShader.fShader,"FRAGMENT"),n.setAttributeBuffer(this.posBuffer),n.setAttributeBuffer(this.targetPosBuffer),n.setAttributeBuffer(this.zIndexBuffer);const h=s.createFrameBuffer(e,t.width,t.height);n.setUniform("size",[t.width,t.height]),this.isShowWire&&n.setUniform("wireMap",r.targetTexture),n.setUniform("showWire",this.isShowWire?1:0),n.setUniform("map",this.map),n.setUniform("teethLut",this.whiteTeethLutMap),n.setUniform("teethIntensity",0),n.setUniform("eyeIntensity",0),n.setIndices(this.indicesBuffer),this.programs.morph=n,this.framebuffers.morph=h;const p=new a.Program(e,(()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0)}));p.setShader(l.advFaceMaskShader.vShader,"VERTEX"),p.setShader(u.baseTextureShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.targetPosBuffer),p.setAttributeBuffer(this.zIndexBuffer),p.setAttributeBuffer(this.faceMaskUVBuffer);const m=s.createFrameBuffer(e,i.width,i.height);p.setUniform("size",[t.width,t.height]),p.setUniform("map",this.faceMaskMap),p.setIndices(this.indicesBuffer),this.programs.faceMask=p,this.framebuffers.faceMask=m;const f=new a.Program(e,(()=>{e.drawElements(e.TRIANGLES,this.advEyeTeethIndicesBuffer.count,e.UNSIGNED_SHORT,0)}));f.setShader(l.advFaceMaskShader.vShader,"VERTEX"),f.setShader(u.baseTextureShader.fShader,"FRAGMENT"),f.setAttributeBuffer(this.advEyeTeethPosBuffer),f.setAttributeBuffer(this.advEyeTeethZindexBuffer),f.setAttributeBuffer(this.advEyeTeethUVBuffer);const g=s.createFrameBuffer(e,i.width,i.height);f.setUniform("size",[t.width,t.height]),f.setUniform("map",this.eyeTeethMaskMap),f.setIndices(this.advEyeTeethIndicesBuffer),this.programs.eyeTeeth=f,this.framebuffers.eyeTeeth=g,n.setUniform("eyeTeethMaskMap",g.targetTexture);for(let r=0;r<2;r++){const n=new a.Program(e);n.setShader(u.baseTextureShader.vShader,"VERTEX"),n.setShader(o.advBeautyEyeShader.fShader,"FRAGMENT"),n.setAttributeBuffer(this.planePosBuffer),n.setAttributeBuffer(this.planeUVBuffer);const d=s.createFrameBuffer(e,t.width,t.height);n.setUniform("map",0===r?h.targetTexture:this.framebuffers.lEye.targetTexture),n.setUniform("eyeCenter",[0,0]),n.setUniform("rdIntensity",0),n.setUniform("lgIntensity",0),n.setUniform("intensRatio",0),n.setUniform("range",0),n.setUniform("rdDir",[0,0]);const c=["lEye","rEye"][r];this.programs[c]=n,this.framebuffers[c]=d;const p=new a.Program(e);p.setShader(u.baseTextureShader.vShader,"VERTEX"),p.setShader(l.advFaceMaskShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.planePosBuffer),p.setAttributeBuffer(this.planeUVBuffer);const f=s.createFrameBuffer(e,i.width,i.height);p.setUniform("map",null),p.setUniform("maskMap",m.targetTexture),p.setUniform("index",r),this.programs["faceMaskMerge"+r]=p,this.framebuffers["faceMaskMerge"+r]=f}}get output(){return this.advData?this.framebuffers.rEye.targetTexture:super.output}get faceMask(){if(this.advData){const e=this.advData.length/212>>0;return this.framebuffers["faceMaskMerge"+(e-1)%2].targetTexture}return null}updateSize(){const e=this.renderer.getSize(),t={width:e.width>>2,height:e.height>>2};["wire","morph","lEye","rEye","faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].forEach((i=>{var r;-1===["faceMaskMerge0","faceMaskMerge1","lEye","rEye"].indexOf(i)&&(null===(r=this.programs[i])||void 0===r||r.setUniform("size",[e.width,e.height]));const s=this.framebuffers[i];if(s){const r=-1===["faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].indexOf(i)?e:t;s.targetTexture.opts.width=r.width,s.targetTexture.opts.height=r.height,s.targetTexture.refresh()}}))}setAdvData(e){this.advData=e.length?e:null}setAdvEffect(e,t){if(e in this.params&&"number"==typeof t)this.params[e]=Math.min(1,Math.max(0,t)),"whitenTeeth"===e&&0===this.params[e]?this.programs.morph.setUniform("teethIntensity",0):"brightenEye"===e?this.programs.morph.setUniform("eyeIntensity",t):"roundedEye"===e?(this.programs.lEye.setUniform("rdIntensity",t),this.programs.rEye.setUniform("rdIntensity",t)):"enlargeEye"===e&&(this.programs.lEye.setUniform("lgIntensity",t),this.programs.rEye.setUniform("lgIntensity",t));else for(const e in this.defParams)this.setAdvEffect(e,this.defParams[e])}presetAdvEffect(e){for(const t in this.defParams)t in e?this.setAdvEffect(t,e[t]):this.setAdvEffect(t,this.defParams[t])}get featureParas(){return this.advData?{forehead:this.params.fadeHeadWrinkle,eyeRim:this.params.fadeEyeRim,noseLine:this.params.fadeNoseLine}:{forehead:0,eyeRim:0,noseLine:0}}posToUV(e,t,i){return new h.Vector2(e.x/t,1-e.y/i)}render(){const e=this.advData;if(e){const t=this.renderer,i=t.gl,r=t.getSize(),s={width:r.width>>2,height:r.height>>2},a=e.length/212>>0;for(let n=0;n<a;n++){const a=e.slice(212*n,212*(n+1)),o=n%2,d=this.programs.morph,c=this.programs["faceMaskMerge"+o];d.setUniform("map",0===n?this.map:this.framebuffers.rEye.targetTexture),d.updateAttribute("position",(e=>{e.set(a,0),m.genTopFace(e),m.genFaceOutline(e)}));let l=null;if(d.updateAttribute("tPosition",(e=>{var t;const i=e;i.set(this.posBuffer.typedArray,0),h.preHandle(i);for(const e in h.handlers){const r=this.params[e];if(r!==this.defParams[e]){const s=null===(t=h.handlers[e])||void 0===t?void 0:t.call(h.handlers,i,r);"whitenTeeth"===e?d.setUniform("teethIntensity",s):"roundedEye"!==e&&"enlargeEye"!==e||(l=Object.assign(Object.assign({},s),{posData:i}))}}})),this.setWirePosBuffer(),this.isShowWire&&(this.framebuffers.wire.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.wire)),t.setViewport(0,0,s.width,s.height),this.framebuffers.faceMask.bind(),this.renderer.render(this.programs.faceMask),c.setUniform("index",n),c.setUniform("map",this.framebuffers["faceMaskMerge"+(0===o?1:0)].targetTexture),this.framebuffers["faceMaskMerge"+o].bind(),this.renderer.render(c),this.programs.eyeTeeth.updateAttribute("tPosition",(e=>{const t=e,i=this.targetPosBuffer.typedArray;[52,53,72,54,55,56,73,57,61,60,75,59,58,63,76,62,96,97,98,99,100,101,102,103].forEach(((e,r)=>{let s=2*r,a=2*e;t[s]=i[a],t[s+1]=i[a+1]}))})),this.framebuffers.eyeTeeth.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.eyeTeeth),t.setViewport(0,0,r.width,r.height),this.framebuffers.morph.bind(),this.renderer.render(d),l){const e=this.posToUV(l.lEyeCenter,r.width,r.height),t=this.posToUV(l.rEyeCenter,r.width,r.height),i=this.posToUV(h.Vector2.getVec(l.posData,52),r.width,r.height),s=this.posToUV(h.Vector2.getVec(l.posData,55),r.width,r.height);let a=h.Vector2.getVec(l.posData,72),n=h.Vector2.getVec(l.posData,73);const o=this.posToUV(h.Vector2.getVec(l.posData,58),r.width,r.height),d=this.posToUV(h.Vector2.getVec(l.posData,61),r.width,r.height);let c=h.Vector2.getVec(l.posData,75),u=h.Vector2.getVec(l.posData,76);const p=Math.min(1,Math.max(0,(h.Vector2.disPow2(a,n)-4)/4)),m=Math.min(1,Math.max(0,(h.Vector2.disPow2(c,u)-4)/4));a=this.posToUV(a,r.width,r.height),n=this.posToUV(n,r.width,r.height),c=this.posToUV(c,r.width,r.height),u=this.posToUV(u,r.width,r.height),this.programs.lEye.setUniform("eyeCenter",e.value),this.programs.lEye.setUniform("range",Math.max(h.Vector2.dis(e,i),h.Vector2.dis(e,s))),this.programs.lEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(a,n)).value),this.programs.lEye.setUniform("intensRatio",p),this.programs.rEye.setUniform("eyeCenter",t.value),this.programs.rEye.setUniform("range",Math.max(h.Vector2.dis(t,o),h.Vector2.dis(t,d))),this.programs.rEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(c,u)).value),this.programs.rEye.setUniform("intensRatio",m)}this.framebuffers.lEye.bind(),this.renderer.render(this.programs.lEye),this.framebuffers.rEye.bind(),this.renderer.render(this.programs.rEye)}}}static configStaticRes(e,i){const r=[];let s=1;const a=()=>{s-=1,s<=0&&(i?i.emit("advBeautyResComplete",r):f.forEach((e=>{try{e.emit("advBeautyResComplete",r)}catch(e){}})))};e.faceMask&&!g&&(s+=1,t.resSet.faceMask=e.faceMask,n.retryLoadImage(e.faceMask,3,(e=>{g=e,f.forEach((t=>{try{t.faceMaskMap.source=e,t.faceMaskMap.refresh()}catch(e){}})),a()}),(()=>{r.push(e.faceMask),a()}))),e.eyeTeethMask&&!v&&(s+=1,t.resSet.eyeTeethMask=e.eyeTeethMask,n.retryLoadImage(t.resSet.eyeTeethMask,3,(e=>{v=e,f.forEach((t=>{try{t.eyeTeethMaskMap.source=e,t.eyeTeethMaskMap.refresh()}catch(e){}})),a()}),(()=>{r.push(e.eyeTeethMask),a()}))),e.teethWhiten&&!_&&(s+=1,t.resSet.teethWhiten=e.teethWhiten,n.retryLoadImage(t.resSet.teethWhiten,3,(e=>{_=e,f.forEach((t=>{try{t.whiteTeethLutMap.source=e,t.whiteTeethLutMap.refresh()}catch(e){}})),a()}),(()=>{r.push(e.teethWhiten),a()}))),a()}destroy(){var e,t,i;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.faceMaskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.eyeTeethMaskMap.glTexture),null===(i=this.renderer.gl)||void 0===i||i.deleteTexture(this.whiteTeethLutMap.glTexture),f.delete(this)}remove(){f.delete(this)}}t.AdvBeautyFilter=y},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.lutShader=void 0,t.lutShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D lut;\n\n    // lut强度\n    uniform float intensity;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec3 color = texture2D(map, vuv).rgb;\n\n        if(intensity > 0.0){\n            float blue = color.b * 63.0;\n\n            vec2 q1;\n            float fb = floor(blue);\n            q1.y = floor(fb * 0.125);\n            q1.x = fb - (q1.y * 8.0);\n\n            vec2 q2;\n            float cb = ceil(blue);\n            q2.y = floor(cb * 0.125);\n            q2.x = cb - (q2.y * 8.0);\n\n            vec2 t = 0.123 * color.rg + vec2(0.000976563);\n            vec2 t1 = q1 * 0.125 + t;\n            vec3 p1 = texture2D(lut, t1).rgb;\n\n            vec2 t2 = q2 * 0.125 + t;\n            vec3 p2 = texture2D(lut, t2).rgb;\n\n            vec3 filter = mix(p1, p2, fract(blue));\n            color = mix(color, filter, intensity);\n        }\n        gl_FragColor = vec4(color, 1.0);\n    }"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.audioPlugins=t.videoPlugins=void 0,t.videoPlugins=["VirtualBackground","AdvancedBeauty"],t.audioPlugins=["AIDenoise"],t.default=["VirtualBackground","AdvancedBeauty","AIDenoise"]},,,,function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NERTC=void 0;const s=i(210),a=i(307),n=i(57),o=i(338),d=i(339),c=i(340),l=i(72),u=i(168),h=i(119),p=i(2),m=i(68),f=i(164),g=r(i(12)),v=r(i(13)),_=r(i(201)),y=i(74),S=i(69),R=i(60),b=i(166),E=i(202);let T,A=window;t.NERTC={Logger:{DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4,setLogLevel(e){const t=p.getParameters().forceLogLevel;-1!==t?null==T||T.logger.error("setLogLevel: 本页面的日志级别固定为 "+y.loglevelMap[t]):(T&&T.apiFrequencyControl({name:"setLogLevel",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||"",level:e}}),_.default.setLogLevel(e))},enableLogUpload(){"off"===p.getParameters().forceLogUpload?null==T||T.logger.error("enableLogUpload: 禁止开启日志上传"):(T&&T.apiFrequencyControl({name:"enableLogUpload",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||""}}),_.default.enableLogUpload())},disableLogUpload(){"on"===p.getParameters().forceLogUpload?null==T||T.logger.error("disableLogUpload: 禁止关闭日志上传"):(T&&T.apiFrequencyControl({name:"disableLogUpload",code:0,param:{clientUid:T.adapterRef.channelInfo.uid||""}}),_.default.disableLogUpload())}},setArea(e){const t=p.getParameters().forceGeofenceArea;if("NONE"!==t)null==T||T.logger.error("setArea: 本页面的日志级别固定为 "+t);else{S.checkValidObject({tag:"NERTC.setArea:area",value:e}),S.checkValidEnum({tag:"NERTC.setArea:area.areaCode",value:e.areaCode,enums:E.geofenceArea.getAvailableAreas()});let t=null;for(let e in p.getParameters().clients)if(t=p.getParameters().clients[e],!t.destroyed&&"DISCONNECTED"!==t.adapterRef.connectState.curState)throw new v.default({code:g.default.CLIENT_ALREADY_IN_CHANNEL_ERROR,message:"用户已在频道中，不支持调用setArea"});E.geofenceArea.setAreaById(e.areaCode),t&&t.apiFrequencyControl({name:"setArea",code:0,param:{clientUid:t.adapterRef.channelInfo.uid||"",area:e,config:E.geofenceArea.getBuiltinConfig()}})}},createClient(e){if(!f.checkSystemRequirements())throw console.error("浏览器环境不支持"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"云信sdk不支持，请使用最新版本的chrome浏览器"});S.checkExists({tag:"createClient:ClientOptions",value:e}),S.checkExists({tag:"createClient:ClientOptions.appkey",value:e.appkey});const i=new s.Client(Object.assign(e,{apiList:[],ref:t.NERTC}));return p.getParameters().clients.push(i),T||(T=i),i},createStream(e){if(S.checkExists({tag:"createStream:options",value:e}),b.isHttpProtocol()&&!p.getParameters().passEnvCheck)throw null==T||T.adapterRef.logger.warn("The current protocol is HTTP"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"请使用https环境或者localhost环境"});if(!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||p.getParameters().passEnvCheck))throw null==T||T.adapterRef.logger.warn("没有 getUserMedia 方法。请使用最新版本的chrome浏览器"),new v.default({code:g.default.NOT_SUPPORT_ERROR,message:"浏览器不支持开启媒体设备，请使用最新版本的chrome浏览器"});if(e.screenAudio&&!e.screen)throw new v.default({code:g.default.INVALID_OPERATION_ERROR,message:"createStream: screenAudio 要与 screen 一起开启"});if(!e.client&&T&&T.adapterRef.logger.warn("createStream: 未传入client参数。使用默认client。"),T||e.client){const t=new a.LocalStream(Object.assign(e,{isRemote:!1,client:e.client||T}));return p.getParameters().localStreams.push(t),t}return o.clientNotYetUninitialized},Device:h.Device,getDevices:(e=!1)=>h.Device.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:e}),getCameras:(e=!1)=>h.Device.getCameras(e),getMicrophones:(e=!1)=>h.Device.getMicrophones(e),getSpeakers:(e=!1)=>h.Device.getSpeakers(e),checkSystemRequirements:f.checkSystemRequirements,getSupportedCodec:async()=>await R.getSupportedCodecs(),checkBrowserCompatibility:async()=>await b.checkBrowserCompatibility(),getHandler:()=>u.detectDevice(),_geofenceArea:E.geofenceArea,getParameters:p.getParameters,destroy(e){let t=e||T;t&&t.destroy(),e||(T=null)},PlatformTypeMap:m.PlatformTypeMap,CHAT_VIDEO_FRAME_RATE_NORMAL:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,CHAT_VIDEO_FRAME_RATE_5:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,CHAT_VIDEO_FRAME_RATE_10:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10,CHAT_VIDEO_FRAME_RATE_15:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15,CHAT_VIDEO_FRAME_RATE_20:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20,CHAT_VIDEO_FRAME_RATE_25:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25,CHAT_VIDEO_FRAME_RATE_30:l.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_30,VIDEO_QUALITY_180p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p,VIDEO_QUALITY_480p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p,VIDEO_QUALITY_720p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p,VIDEO_QUALITY_1080p:l.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,RECORD_VIDEO_QUALITY_360p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_360p,RECORD_VIDEO_QUALITY_480p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_480p,RECORD_VIDEO_QUALITY_720p:l.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_720p,RECORD_VIDEO_FRAME_RATE_15:l.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_15,RECORD_VIDEO_FRAME_RATE_30:l.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_30,LIVE_STREAM_AUDIO_CODEC_PROFILE:d.LIVE_STREAM_AUDIO_CODEC_PROFILE,LIVE_STREAM_AUDIO_SAMPLE_RATE:d.LIVE_STREAM_AUDIO_SAMPLE_RATE,VIDEO_FRAME_RATE:l.VIDEO_FRAME_RATE,VIDEO_QUALITY:l.NERTC_VIDEO_QUALITY,NETWORK_STATUS:c.NETWORK_STATUS,STREAM_TYPE:l.STREAM_TYPE,VERSION:n.SDK_VERSION,BUILD:n.BUILD,ENV:n.ENV},e.exports=A.WebRTC2=t.NERTC},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const o=i(57),d=i(72),c=i(119),l=i(150),u=i(215),h=i(2),p=i(152),m=i(67),f=i(68),g=n(i(12)),v=n(i(13)),_=i(216),y=i(69),S=i(217),R=i(306),b=i(60),E=i(154),T=a(i(14));class A extends S.Base{constructor(e){super(e),this.destroyed=!1,this.outOfConnect=!1,this.onJoinFinish=null,this.spatialManager=null,this.__v_skip=h.getParameters().enableVSkip,this.apiFrequencyControl({name:"createClient",code:0,param:{clientUid:"",debug:e.debug}}),this.operationQueue=new _.OperationQueue(this.logger),this.handlePageUnload=e=>{"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.logger.warn(`收到 ${null==e?void 0:e.type} 事件，当前状态：${this.adapterRef.channelStatus}，即将离开房间`),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=g.default.PAGE_UNLOAD,this.leave())},this.handleOnOnline=e=>{var t;const i={cmd:"onOnline",data:{type:e.type}};null===(t=this.adapterRef.signalProbeManager.worker)||void 0===t||t.postMessage(i)},this.handleOnOffline=e=>{},this.handleUnhandledRejection=e=>{this.logger.warn(`Exception caught => type: ${e.type}, reason: ${e.reason}`),this.apiFrequencyControl({name:"exception",code:0,param:{clientUid:"",type:e.type,reason:e.reason}})},h.getParameters().leaveOnUnload&&(window.addEventListener("pagehide",this.handlePageUnload),window.addEventListener("beforeunload",this.handlePageUnload)),h.getParameters().trustOnOnline&&window.addEventListener("online",this.handleOnOnline),h.getParameters().trustOnOffline&&window.addEventListener("offline",this.handleOnOffline),h.getParameters().trustUnhandledrejection&&window.addEventListener("unhandledrejection",this.handleUnhandledRejection),this._roleInfo={userRole:0,audienceList:{}},this._init(e),this.logger.info(`NERTC ${o.SDK_VERSION} ${o.BUILD}: 客户端创建成功。`),this.on("@connection-state-change",(e=>{var t,i,r;"CONNECTED"===e.prevState&&(null===(t=this.recordManager.record)||void 0===t?void 0:t._status.isRecording)&&"started"===(null===(i=this.recordManager.record)||void 0===i?void 0:i._status.state)&&(this.logger.log("自动停止客户端录制功能"),this.recordManager.record.download()),"CONNECTED"===e.curState&&"CONNECTING"===e.prevState&&(e.reconnect&&this.adapterRef.lbsManager.startUpdate("reconnect"),(null===(r=this.adapterRef.datareportCache)||void 0===r?void 0:r.length)&&(this.logger.log(`上报进频道前事件：${this.adapterRef.datareportCache.length}条: ${this.adapterRef.datareportCache.map((e=>e.func)).join()}`),this.adapterRef.datareportCache.forEach((e=>{const t=e.datareport[e.func];t&&(t.cid=t.cid||this.adapterRef.channelInfo.cid,t.uid=t.uid||this.adapterRef.channelInfo.uid),e.datareport.send()})),this.adapterRef.datareportCache=[]))})),this.on("@media-stats-change",(e=>{let t=!1,i={profile:b.getCurrentProfileLevel()};e.data.forEach((e=>{var r;"video"!==e.mediaType&&"screen"!==e.mediaType||(null===(r=e.new)||void 0===r?void 0:r.CodecImplementationName)&&(i[`${e.mediaType}_${e.streamType}`]=e.new.CodecImplementationName,"unknown"!==e.new.CodecImplementationName&&(e.old&&e.old.CodecImplementationName===e.new.CodecImplementationName||(this.logger.log(`CodecImplementationName ${e.streamType} ${e.mediaType} ${e.new.CodecImplementationName}`),t=!0)))})),t&&this.apiFrequencyControl({name:"CodecImplementationName",code:0,param:i})}))}_init(e){const{appkey:t="",token:i}=e;this._params.appkey=t,this.adapterRef.lbsManager.loadBuiltinConfig("oninit"),this._params.token=i,this._roleInfo={userRole:0,audienceList:{}},c.Device.deviceInited||c.Device.startDeviceChangeDetection(),c.Device.on("recording-device-changed",(e=>{this.destroyed||(this.safeEmit("recording-device-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"recording-device-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}))})),c.Device.on("camera-changed",(e=>{this.destroyed||(this.safeEmit("camera-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"camera-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}))})),c.Device.on("playout-device-changed",(e=>{this.destroyed||(this.safeEmit("playout-device-changed",e),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"playout-device-changed",customIdentify:"client",param:JSON.stringify(e,null," ")}))}));const r=()=>{this.onJoinFinish?(this.onJoinFinish(),this.onJoinFinish=null):this.logger.debug("孤立的join完成回调")};this.addListener("@pairing-join-success",r),this.addListener("@pairing-join-error",r),"never"!==h.getParameters().enableAlerter&&c.alerter.watchClient(this.adapterRef.instance)}getUid(){return this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid}getParameter(e="getChannelInfo"){if(this.apiFrequencyControl({name:"getParameter",code:0,param:{type:e}}),"getChannelInfo"===e){const e=`appkey=${this._params.appkey}&osType=4&mode=2&netType=0&version=${o.SDK_VERSION+".0"}&webrtc=1&nrtcg2=1&t1=${Date.now()}`,t={"Content-Type":"application/x-www-form-urlencoded"};return JSON.stringify({postData:e,header:t})}}getChannelInfo(){return this.apiFrequencyControl({name:"getChannelInfo",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||""}}),this.adapterRef.channelInfo||{}}startProxyServer(e){let t=null;if(this.adapterRef.logger.log("startProxyServer() type: ",e),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.adapterRef.logger.warn("startProxyServer() 请在加入房间前调用"),t="startProxyServer() 请在加入房间前调用"),this.apiFrequencyControl({name:"startProxyServer",code:t?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:t}}),t)throw new v.default({code:g.default.API_CALL_SEQUENCE_BEFORE_ERROR,message:"startProxyServer() 请在加入房间前调用"});this.adapterRef.proxyServer.enable=!0,e&&(this.adapterRef.proxyServer.type=e)}stopProxyServer(){this.adapterRef.logger.log("stopProxyServer()"),this.adapterRef.proxyServer&&(this.adapterRef.proxyServer.enable=!1,this.adapterRef.proxyServer.wsProxyArray=null),this.apiFrequencyControl({name:"stopProxyServer",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:""}})}setLocalMediaPriority(e){this.logger.log("setLocalMediaPriority() options: ",JSON.stringify(e));let t=0,i="";"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(i="setLocalMediaPriority() 请在加入房间前调用",t=g.default.API_CALL_SEQUENCE_BEFORE_ERROR),100!==e.priority&&50!==e.priority&&(i="setLocalMediaPriority: options.priority应该是100或者50",t=g.default.SET_LOCAL_MEDIA_PRIORITY_ARGUMENT_ERROR);const{priority:r=100,preemtiveMode:s=!1}=e;if(this.apiFrequencyControl({name:"setLocalMediaPriority",code:t?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",priority:r,preemtiveMode:s,reason:t,message:i}}),t)throw this.logger.error(i),new v.default({code:t,message:i});this.adapterRef.userPriority=e}async join(e){this.logger.log("join() 加入频道, options: ",JSON.stringify(e,null," ")),this.adapterRef.instance.outOfConnect=!1;let t=null;try{if(!e.channelName||""===e.channelName)throw this.logger.log("join(): 请填写房间名称"),new v.default({code:g.default.JOIN_WITHOUT_CHANNEL_NAME,message:"join(): 请填写房间名称"});if(e.joinChannelRecordConfig&&(y.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordAudio should be boolean",value:e.joinChannelRecordConfig.recordAudio}),y.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordVideo should be boolean",value:e.joinChannelRecordConfig.recordVideo})),"string"==typeof e.uid){if(this.logger.log("join(): uid是string类型"),!/^[1-9]\d*$/.test(e.uid))throw this.logger.log("join(): uid不是数字字符串格式"),new v.default({code:g.default.JOIN_UID_TYPE_ERROR,message:"join() uid不是数字字符串格式"});this.adapterRef.channelInfo.uidType="string"}else{if("number"!=typeof e.uid)return this.logger.error("join(): uid参数格式非法"),Promise.reject(new v.default({code:g.default.JOIN_UID_TYPE_ERROR,message:"join() uid参数格式非法"}));if(this.logger.log("join(): uid是number类型"),this.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw this.logger.log("join():uid参数越界, 会导致精度缺失"),new v.default({code:g.default.JOIN_UID_TYPE_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1, 请输入正确的参数"})}if(this.onJoinFinish=await this.operationQueue.enqueue({caller:this,method:"join",options:e}),this.safeEmit("@pairing-join-start"),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus)return this.safeEmit("@pairing-join-error"),Promise.reject(new v.default({code:g.default.REPEAT_JOIN_ERROR,message:"join() 重复加入房间"}));if(this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.prevState="DISCONNECTED",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),e.spatial&&this.initSpatialManager(e.spatial),e.token&&(this._params.token=e.token),e.customData&&(this.adapterRef.channelInfo.customData=e.customData),T.ANY_CHROME_MAJOR_VERSION&&T.ANY_CHROME_MAJOR_VERSION>=58&&T.ANY_CHROME_MAJOR_VERSION<69||E.detectRtcCapabilities().catch((e=>{this.logger.warn("detectRtcCapabilities",e.name,e.message)})),this._params.JoinChannelRequestParam4WebRTC2={startJoinTime:Date.now(),appkey:this._params.appkey,userRole:this._roleInfo.userRole,channelName:e.channelName,wssArr:e.wssArr,uid:e.uid,permKey:e.permKey||"",token:this._params.token,joinChannelLiveConfig:e.joinChannelLiveConfig||{liveEnable:!1},joinChannelRecordConfig:e.joinChannelRecordConfig||{recordAudio:!1,recordVideo:!1,recordType:0,isHostSpeaker:!1},getChanneInfoResponse:e.getChanneInfoResponse},e.neRtcServerAddresses&&(this._params.neRtcServerAddresses={channelServer:e.neRtcServerAddresses.channelServer||"",statisticsServer:e.neRtcServerAddresses.statisticsServer||"",statisticsWebSocketServer:e.neRtcServerAddresses.statisticsWebSocketServer||"",roomServer:e.neRtcServerAddresses.roomServer||"",webSocketProxyServer:e.neRtcServerAddresses.webSocketProxyServer||"",mediaProxyServer:e.neRtcServerAddresses.mediaProxyServer||""}),!h.getParameters().disableLBSService&&!h.getParameters().lbsUseBuiltinOnly&&(t=this.adapterRef.lbsManager.loadLocalConfig("onjoin"),t.config)){const e=t.config.ts+1e3*t.config.config.ttl-Date.now();e<1e3*t.config.config.preloadTimeSec&&(this.logger.log(`join() LBS在 ${Math.floor(e/1e3)} 秒后过期。preloadTimeSec: ${t.config.config.preloadTimeSec}。发起异步刷新请求`),this.adapterRef.lbsManager.startUpdate("renew"))}if(this.setStartSessionTime(),this.initMode(),!this.adapterRef.mediaCapability.supportedCodecRecv||!this.adapterRef.mediaCapability.supportedCodecSend)try{await this.adapterRef.mediaCapability.detect()}catch(e){this.logger.warn("join() Failed to detect mediaCapability: ",e.name,e.message)}if(!this.adapterRef._meetings)throw this.logger.error("join() meeting模块缺失"),this.safeEmit("@pairing-join-error"),new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:"join() meeting模块缺失"});const i=await this.adapterRef._meetings.joinChannel(this._params.JoinChannelRequestParam4WebRTC2);return this.safeEmit("@pairing-join-success"),t&&!t.config&&this.adapterRef.lbsManager.startUpdate(t.reason),this.apiFrequencyControl({name:"join",code:0,param:Object.assign({},e)}),i}catch(i){throw this.safeEmit("@pairing-join-error"),t&&!t.config&&this.adapterRef.lbsManager.startUpdate(t.reason),this.apiFrequencyControl({name:"join",code:-1,param:Object.assign(Object.assign({},e),{reason:i&&i.message})}),i.getCode?i:new v.default({code:g.default.JOIN_FAILED,message:`join() 内部错误: ${i.name}, ${i.message}`})}}async leave(){var e;const t=await this.operationQueue.enqueue({caller:this,method:"leave",options:null}),i=(null===(e=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2)||void 0===e?void 0:e.logoutReason)||0;this.logger.log("leave() 离开频道: ",i),this.adapterRef.instance.apiEventReport("setLogout",{reason:i}),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings?this.adapterRef._meetings.leaveChannel().then(t):(this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},t()),this.apiFrequencyControl({name:"leave",code:0,param:{clientUid:this.getUid()}})}setEncryptionMode(e){if(y.checkValidInteger({tag:"Valid encryptionModes are: "+Object.keys(l.EncryptionModes).join(","),value:l.encryptionModeToInt(e)}),this.adapterRef.encryption.encodedInsertableStreams){const e="setEncryptionMode() 自定义加密功能与国密加密功能不兼容";throw this.logger.error(e),new v.default({code:g.default.SET_ENCRYPTION_MODE_ERROR,message:e})}this.logger.log("setEncryptionMode() 设置加密模式：",e),this.adapterRef.encryption.setEncryptionMode(e);const t={enable:"none"!==e,mode:l.encryptionModeToInt(e)};this.apiFrequencyControl({name:"setEncryptionMode",code:0,param:JSON.stringify(t,null," ")})}setEncryptionSecret(e){switch(this.adapterRef.encryption.encryptionMode){case"none":throw new v.default({code:g.default.SET_ENCRYPTION_SECRET_INVALID_OPERATION_ERROR,message:"setEncryptionSecret() 请先设置加密模式"});case"sm4-128-ecb":y.checkValidString({tag:"client.setEncryptionSecret:encryptionSecret",value:e,min:1,max:128})}this.logger.log("设置加密密钥"),this.adapterRef.encryption.setEncryptionSecret(e),this.apiFrequencyControl({name:"setEncryptionSecret",code:0,param:JSON.stringify({encryptionSecret:e},null," ")})}enableCustomTransform(e){var t;let i,r;if("DISCONNECTED"!==this.adapterRef.connectState.curState?(i="enableCustomTransform() 必须在加入频道前调用",r=g.default.API_CALL_SEQUENCE_BEFORE_ERROR):"function"!=typeof window.TransformStream?(i="enableCustomTransform() 浏览器不支持自定义加密, TransformStream 未找到",r=g.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):"function"!=typeof(null===(t=window.RTCRtpReceiver)||void 0===t?void 0:t.prototype.createEncodedStreams)?(i="enableCustomTransform() 浏览器不支持自定义加解密，未找到createEncodedStreams",r=g.default.CUSTOM_TRANSFOR_NOT_SUPPORT_ERROR):"none"!==this.adapterRef.encryption.encryptionMode&&(i="enableCustomTransform() 自定义加密功能与国密加密功能不兼容",r=g.default.SET_ENCRYPTION_MODE_ERROR),this.apiFrequencyControl({name:"enableCustomTransform",code:i?-1:0,param:JSON.stringify({enable:e,message:i})}),i)throw this.logger.error(i),new v.default({code:r,message:i});!1===e?(this.adapterRef.encryption.encodedInsertableStreams=!1,this.logger.log("enableCustomTransform() 已关闭自定义加解密")):(this.adapterRef.encryption.encodedInsertableStreams=!0,this.logger.log("enableCustomTransform() 已开启自定义加解密"))}async publish(e){y.checkExists({tag:"client.publish:stream",value:e}),await this.doPublish(e)}async doPublish(e){const t=await this.operationQueue.enqueue({caller:this,method:"publish",options:e});let i=0,r="";const s=()=>{var s,a;t();const n={reason:i,message:r,profileLevel:b.getCurrentProfileLevel(),pubStatus:e.pubStatus};(e.mediaHelper.video.cameraTrack||e.mediaHelper.video.videoSource)&&(n.webcamProducerCodec=null===(s=this.adapterRef._mediasoup)||void 0===s?void 0:s._webcamProducerCodec),(e.mediaHelper.screen.screenVideoTrack||e.mediaHelper.screen.screenVideoSource)&&(n.screenProducerCodec=null===(a=this.adapterRef._mediasoup)||void 0===a?void 0:a._screenProducerCodec),this.apiFrequencyControl({name:"publish",code:i?-1:0,param:JSON.stringify(n)});const o=JSON.stringify(e.mediaHelper.getTrackSettings());this.apiFrequencyControl({name:"_trackSettings",code:0,param:o}),this.adapterRef.instance.apiEventReport("setUserCustomEvent",{name:"media_track_Settings",customIdentify:"publish",param:o})};if(e&&(e.audio||e.video||e.screen||e.screenAudio)?1===this._roleInfo.userRole?(r="publish() 观众禁止Publish, 请先使用setClientRole设为主播",this.logger.error(r),i=g.default.PUBLISH_ROLE_ERROR):"CONNECTING"===this.adapterRef.connectState.curState?(r="publish() 当前正在连接, 将在连接成功后发布媒体流",this.bindLocalStream(e),i=g.default.RECONNECTING):"CONNECTED"!==this.adapterRef.connectState.curState&&(r="publish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(r),i=g.default.API_CALL_SEQUENCE_BEFORE_ERROR):e&&h.getParameters().allowEmptyMedia?this.logger.log("publish() 当前模式允许发布没有媒体流的localStream"):(r="publish() 传入的 stream 格式非法，没有媒体数据",this.logger.error(r),i=g.default.PUBLISH_NO_STREAM),i)return r?(s(),Promise.reject(new v.default({code:i,message:r}))):void s();try{if(!this.adapterRef._mediasoup)throw r="publish() 媒体mediasoup模块缺失",i=g.default.UNKNOWN_TYPE_ERROR,this.logger.error(r),s(),new v.default({code:i,message:r});this.bindLocalStream(e);try{await this.adapterRef._mediasoup.createProduce(e,"all")}catch(e){this.logger.error("publish() createProduce error: ",e)}s()}catch(e){throw this.logger.error("publish() 内部错误: ",e.name,e.message),i=g.default.UNKNOWN_TYPE_ERROR,r=e.message,s(),e.getCode?e:new v.default({code:i,message:`publish() 内部错误: ${e.name}, ${e.message}`})}}async unpublish(e){y.checkExists({tag:"client.unpublish:stream",value:e});const t=await this.operationQueue.enqueue({caller:this,method:"unpublish",options:null}),i=()=>{t(),JSON.stringify({pubStatus:e&&e.pubStatus,reason:r,message:s},null," "),this.apiFrequencyControl({name:"unpublish",code:r?-1:0,param:{clientUid:this.getUid(),pubStatus:e&&e.pubStatus,reason:r}})};let r=0,s="";if("CONNECTING"===this.adapterRef.connectState.curState?(this.adapterRef.localStream=null,s="unpublish() 当前正在连接, 连接成功后将不再发送媒体流",r=g.default.RECONNECTING):"CONNECTED"!==this.adapterRef.connectState.curState&&(s="unpublish() 当前不在频道中, 可能是没有加入频道或者是网络波动导致暂时断开连接",this.logger.error(s),r=g.default.API_CALL_SEQUENCE_BEFORE_ERROR),r)return i(),s?(this.logger.error(s),Promise.reject(new v.default({code:r,message:s}))):void 0;this.logger.log("unpublish(): 开始取消发布本地流");try{if(!this.adapterRef._mediasoup)throw s="unpublish() 媒体mediasoup模块缺失",r=g.default.UNKNOWN_TYPE_ERROR,this.logger.error(s),i(),new v.default({code:r,message:s});await this.adapterRef._mediasoup.destroyProduce("audio"),await this.adapterRef._mediasoup.destroyProduce("audioSlave"),await this.adapterRef._mediasoup.destroyProduce("video"),await this.adapterRef._mediasoup.destroyProduce("screen"),this.adapterRef.localStream=null,i()}catch(e){throw this.logger.error("unpublish() 内部错误: ",e.name,e.message),r=g.default.UNKNOWN_TYPE_ERROR,s=e.message,i(),e.getCode?e:new v.default({code:r,message:`unpublish() 内部错误: ${e.name}, ${e.message}`})}}getSubStatus(e,t){let i={status:"unsubscribed",subscribable:!1};if("all"===t){const t=[this.getSubStatus(e,"audio"),this.getSubStatus(e,"audioSlave"),this.getSubStatus(e,"video"),this.getSubStatus(e,"screen")];t.find((e=>"unsubscribing"===e.status))?i.status="unsubscribing":t.find((e=>"subscribing"===e.status))&&(i.status="subscribing"),t.find((e=>"subscribed"===e.status))&&(i.status="subscribed"),"subscribed"!==i.status&&"unsubscribed"!==i.status||t.find((e=>e.subscribable))&&(i.subscribable=!0)}else"start"===e.pubStatus[t].stopconsumerStatus?i.status="unsubscribing":"start"===e.pubStatus[t].consumerStatus?i.status="subscribing":e.pubStatus[t].consumerId?i.status="subscribed":"unsubscribed"===i.status&&e.pubStatus[t].producerId&&e.subConf[t]&&(i.subscribable=!0);return i}async subscribe(e,t){if(!this.spatialManager)return y.checkExists({tag:"client.subscribe:stream",value:e}),t?(this.logger.log(`subscribe [订阅远端: ${e.stringStreamID}] ${JSON.stringify(t)}`),e.doSetSubscribeConfig(t),this.doSubscribe(e)):(this.logger.log("subscribe() [订阅远端: ${stream.stringStreamID}]"),this.doSubscribe(e));this.logger.warn("subscribe() 已开启空间音频，跳过用户订阅步骤")}async doSubscribe(e){var t,i,r,s,a,n;const o=e.getId();if(!this.adapterRef._mediasoup){const e="subscribe() 媒体mediasoup模块缺失";throw this.logger.error(e),new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:e})}try{if(e.subConf.audio)!1===(null===(t=this.adapterRef.permKeyInfo)||void 0===t?void 0:t.subAudioRight)?(this.logger.error("subscribe() permKey权限控制，没有权限订阅audio"),this.adapterRef.instance.emit("error","no-subscribe-audio-permission")):e.pubStatus.audio.audio&&!e.pubStatus.audio.consumerId&&(this.logger.log(`subscribe() 开始订阅 ${e.getId()} 音频流`),e.pubStatus.audio.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(o,"audio","audio",e.pubStatus.audio.producerId),e.pubStatus.audio.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${e.getId()} 音频流完成`));else if(e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 音频流`),e.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.mediaHelper.updateStream("audio",null),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioStats[t],this.logger.log(`subscribe() 取消订阅 ${e.getId()} 音频流完成`)}if(e.subConf.audioSlave)!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.subAudioRight)?(this.logger.error("subscribe() permKey权限控制，没有权限订阅audio slave"),this.adapterRef.instance.emit("error","no-subscribe-audio-slave-permission")):e.pubStatus.audioSlave.audioSlave&&!e.pubStatus.audioSlave.consumerId&&(this.logger.log(`subscribe() 开始订阅 ${e.getId()} 音频辅流`),e.pubStatus.audioSlave.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(o,"audio","audioSlave",e.pubStatus.audioSlave.producerId),e.pubStatus.audioSlave.consumerStatus="end",this.logger.log(`subscribe() 订阅 ${e.getId()} 音频辅流完成`));else if(e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 音频辅流`),e.pubStatus.audioSlave.stopconsumerStatus="start",await(null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave")),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.mediaHelper.updateStream("audioSlave",null),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log("subscribe() 取消订阅 ${stream.getId()} 音频辅流完成")}if(e.subConf.video)if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.subVideoRight))this.logger.error("subscribe() permKey权限控制，没有权限订阅video"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(e.pubStatus.video.video&&!e.pubStatus.video.consumerId){let t;this.logger.log(`subscribe() 开始订阅 ${e.getId()} 视频流`),t=e.subConf.highOrLow.video===d.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(o,"video","video",e.pubStatus.video.producerId,t),this.logger.log(`subscribe() 订阅 ${e.getId()} 视频流完成`)}else this.logger.log("subscribe() stream.pubStatus.video: ",JSON.stringify(e.pubStatus.video));else e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus&&(this.logger.log("`subscribe() 开始取消订阅 ${stream.getId()} 视频流`"),e.pubStatus.video.stopconsumerStatus="start",await(null===(a=this.adapterRef._mediasoup)||void 0===a?void 0:a.destroyConsumer(e.pubStatus.video.consumerId,e,"video")),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.mediaHelper.updateStream("video",null),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1,this.logger.log(`subscribe() 取消订阅 ${e.getId()} 视频流完成`));if(e.subConf.screen){if(!1===(null===(n=this.adapterRef.permKeyInfo)||void 0===n?void 0:n.subVideoRight))this.logger.error("subscribe() permKey权限控制，没有权利订阅screen"),this.adapterRef.instance.emit("error","no-subscribe-screen-permission");else if(e.pubStatus.screen.screen&&!e.pubStatus.screen.consumerId){let t;this.logger.log(`subscribe() 开始订阅 ${e.getId()} 辅流`),t=e.subConf.highOrLow.screen===d.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(o,"video","screenShare",e.pubStatus.screen.producerId,t),this.logger.log(`subscribe() 订阅 ${e.getId()} 辅流完成`)}}else if(e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){this.logger.log(`subscribe() 开始取消订阅 ${e.getId()} 辅流`),e.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.mediaHelper.updateStream("screen",null),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();t&&delete this.adapterRef.remoteScreenStats[t],this.logger.log(`subscribe() 取消订阅 ${e.getId()} 辅流完成`)}this.apiFrequencyControl({name:"subscribe",code:0,param:JSON.stringify({reason:"",subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")})}catch(t){if("resetConsumeRequestStatus"===t)return void this.logger.warn("subscribe() API调用被打断");throw this.logger.error("subscribe() 内部错误: ",t.message),this.apiFrequencyControl({name:"subscribe",code:-1,param:JSON.stringify({reason:t.message,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")}),t.getCode?t:new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:`subscribe() 内部错误: ${t.name}, ${t.message}`})}}async unsubscribe(e,t){if(y.checkExists({tag:"client.unsubscribe:stream",value:e}),!t)return this.logger.log(`unsubscribe() [取消订阅远端: ${e.getId()}]`),this.doUnsubscribe(e);{y.checkValidObject({tag:"client.unsubscribe:unsubscribeOptions",value:t}),this.logger.log(`unsubscribe ${e.getId()} ${JSON.stringify(t)}`);const i={audio:e.subConf.audio,audioSlave:e.subConf.audio,video:e.subConf.video,screen:e.subConf.screen};f.MediaTypeList.forEach((e=>{!0===t[e]&&(i[e]=!1)})),e.doSetSubscribeConfig(i),this.doSubscribe(e)}}async doUnsubscribe(e,t){if(!this.adapterRef._mediasoup){const e="unsubscribe() 媒体mediasoup模块缺失";throw this.logger.error(e),new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:e})}try{if((void 0===t||"audio"===t)&&e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的音频流`),e.pubStatus.audio.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.mediaHelper.updateStream("audio",null),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的音频流完成`)}if((void 0===t||"audioSlave"===t)&&e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的音频辅流`),e.pubStatus.audioSlave.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave"),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.mediaHelper.updateStream("audioSlave",null),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的音频辅流完成`)}if(void 0!==t&&"video"!==t||!e.pubStatus.video.consumerId||"start"===e.pubStatus.video.stopconsumerStatus||(this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的视频流`),e.pubStatus.video.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.mediaHelper.updateStream("video",null),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1,e.getId(),this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的视频流完成`)),(void 0===t||"screen"===t)&&e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){this.logger.log(`unsubscribe() [开始取消订阅 ${e.getId()}] 的视频辅流`),e.pubStatus.screen.stopconsumerStatus="start",await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.mediaHelper.updateStream("screen",null),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();t&&delete this.adapterRef.remoteScreenStats[t],this.logger.log(`unsubscribe() [取消订阅 ${e.getId()}] 的视频辅流完成`)}this.apiFrequencyControl({name:"unsubscribe",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:"",subStatus:e.subStatus,subConf:e.subConf},null," ")})}catch(t){throw this.logger.error("unsubscribe() 内部错误:",t,t.name,t.message),this.apiFrequencyControl({name:"unsubscribe",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:t.message,subStatus:e.subStatus,subConf:e.subConf},null," ")}),t.getCode?t:new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:`unsubscribe() 内部错误: ${t.name}, ${t.message}`})}}async setRemoteVideoStreamType(e,t){var i;this.logger.log(`setRemoteVideoStreamType() uid ${e.getId()} 订阅成员的${t?"小":"大"}流`,t);try{await(null===(i=this.adapterRef._mediasoup)||void 0===i?void 0:i.setConsumerPreferredLayer(e,t?0:1,"video")),e.subConf.highOrLow.video=t,this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,highOrLow:t},null," ")})}catch(i){throw this.logger.error("setRemoteVideoStreamType() 内部错误: ",i.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:i.message,highOrLow:t},null," ")}),i.getCode?i:new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:`setRemoteVideoStreamType() 内部错误: ${i.name}, ${i.message}`})}}async setRemoteStreamType(e,t,i){var r;this.logger.log(`setRemoteStreamType() 订阅${e.getId()}成员${t}媒体的${t?"小":"大"}流`);try{await(null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r.setConsumerPreferredLayer(e,t?0:1,i)),e.subConf.highOrLow[i]=t,this.apiFrequencyControl({name:"setRemoteStreamType",code:0,param:{highOrLow:t,mediaType:i,clientUid:this.getUid(),streamID:e.stringStreamID}})}catch(r){throw this.logger.error("setRemoteStreamType() 内部错误: ",r.message),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:r.message,highOrLow:t,mediaType:i,streamID:e.stringStreamID},null," ")}),r.getCode?r:new v.default({code:g.default.UNKNOWN_TYPE_ERROR,message:"setRemoteStreamType() 内部错误: "+r.message})}}enableAudioVolumeIndicator(){this.logger.log("开启音量提醒")}enableDualStream(e={video:!0,screen:!1}){this.adapterRef.channelInfo.videoLow=e.video,this.adapterRef.channelInfo.screenLow=e.screen,this.logger.log("enableDualStream() 开启双流模式"),this.apiFrequencyControl({name:"enableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}})}disableDualStream(e={video:!1,screen:!1}){this.logger.log("disableDualStream() 关闭双流模式"),this.adapterRef.channelInfo.videoLow=!1,this.adapterRef.channelInfo.screenLow=!1,this.apiFrequencyControl({name:"disableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}})}setPlaybackVolume(e){let t,i;if(!Number.isInteger(e)||e<0||e>100)t=g.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,i="setPlaybackVolume() volume 应该为 0 - 100 的整数";else{const t=e/100;this.logger.log(`setPlaybackVolume: ${this.adapterRef.nomalizedPlaybackVolume} => ${t} normalized`),this.adapterRef.nomalizedPlaybackVolume=t}if(this.apiFrequencyControl({name:"setPlaybackVolume",code:t?-1:0,param:{volume:e}}),t)throw this.logger.error(i),new v.default({code:t,message:i});for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active&&t._play.updatePlaybackVolume()}}async setClientRole(e){var t;let i,r=0,s="";if("host"===e||"broadcaster"===e?i=0:"audience"===e?i=1:(s="setClientRole() 无法识别的角色："+e,this.logger.error(s),r=g.default.ROLE_TYPE_ERROR,i=-1),!r){const a=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid||"";if(i===this._roleInfo.userRole)this.logger.warn(`setClientRole() 用户${a}的角色已经是${e}了`);else switch(this.adapterRef.connectState.curState){case"CONNECTED":1===i&&this.adapterRef.localStream&&this.isPublished(this.adapterRef.localStream)&&(this.logger.info(`setClientRole() 主播 ${a}将设为观众，自动unPublish中`),await this.unpublish(this.adapterRef.localStream));const n=await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.updateUserRole(i));200!==n.code?(r=n.code,s=n.errMsg):this._roleInfo.userRole!==i&&(this._roleInfo.userRole=i,this.logger.info(`setClientRole() 本地用户${a} 设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;case"DISCONNECTED":this._roleInfo.userRole!==i&&(this._roleInfo.userRole=i,this.logger.info(`setClientRole() 本地用户${a}设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;default:s=`setClientRole() 本地用户${a}当前不在频道中，可能是网络波动导致暂时断开连接`,this.logger.error(s),r=g.default.USER_NOT_IN_CHANNEL_ERROR}}const a={code:r,message:s,role:i};if(this.apiFrequencyControl({name:"setClientRole",code:r?-1:0,param:a}),r)throw new v.default({code:r,message:s})}bindLocalStream(e){this.adapterRef.localStream=e,e.client=this,e.logger.parent=this.logger;const t=this.getUid();t&&e.streamID!==t&&(this.logger.warn("localStream更换streamID",e.streamID,"=>",t),e.streamID=t,e.stringStreamID=t.toString())}getConnectionState(){return this.apiFrequencyControl({name:"getConnectionState",code:0,param:JSON.stringify({},null," ")}),this.adapterRef.connectState.curState}getSystemStats(){return navigator.getBattery?new Promise(((e,t)=>{navigator.getBattery().then((function(t){e(100*t.level)}))})):Promise.reject(new v.default({code:g.default.GET_SYSTEM_STATS_NOT_SUPPORT_ERROR,message:"getSystemStats() 浏览器不支持, 建议使用最新版的 Chrome 浏览器"}))}getSessionStats(){return new Promise(((e,t)=>{this.adapterRef.sessionStats.Duration=(Date.now()-this.adapterRef.state.startSessionTime)/1e3,this.adapterRef.sessionStats.UserCount=Object.keys(this.adapterRef.memberMap).length+1,e(this.adapterRef.sessionStats)}))}getTransportStats(){return new Promise(((e,t)=>{e(this.adapterRef.transportStats)}))}getLocalAudioStats(){return new Promise(((e,t)=>{e(this.adapterRef.localAudioStats)}))}getLocalAudioSlaveStats(){return new Promise(((e,t)=>{e(this.adapterRef.localAudioSlaveStats)}))}getLocalVideoStats(e){let t=[];return e&&"video"!==e||(t=t.concat(this.adapterRef.localVideoStats)),e&&"screen"!==e||(t=t.concat(this.adapterRef.localScreenStats)),Promise.resolve(t)}getRemoteAudioStats(){return new Promise(((e,t)=>{e(this.adapterRef.remoteAudioStats)}))}getRemoteAudioSlaveStats(){return new Promise(((e,t)=>{e(this.adapterRef.remoteAudioSlaveStats)}))}getRemoteVideoStats(e){let t={};return e&&"screen"!==e||(t=Object.assign(t,this.adapterRef.remoteScreenStats)),e&&"video"!==e||(t=Object.assign(t,this.adapterRef.remoteVideoStats)),Promise.resolve(t)}setChannelProfile(e){const t=(null==e?void 0:e.mode)||null;let i,r;if(this.logger.log("setChannelProfile, options: ",JSON.stringify(e,null," ")),"rtc"!==t&&"live"!==t&&(r="setChannelProfile: 参数格式错误",i=g.default.SET_CHANNEL_PROFILE_INVALID_PARAMETER_ERROR,this.logger.warn(r)),"DISCONNECTED"!==this.adapterRef.connectState.curState?(r="setChannelProfile() 请在加入房间之前调用",i=g.default.API_CALL_SEQUENCE_BEFORE_ERROR,this.logger.warn(r)):(this.adapterRef.localStream&&("live"===t?this.adapterRef.localStream.audioProfile="music_standard":"rtc"===t&&(this.adapterRef.localStream.audioProfile="speech_low_quality")),this._params.mode=t),this.apiFrequencyControl({name:"setChannelProfile",code:i?-1:0,param:{mode:JSON.stringify(e,null," "),reason:i,message:r}}),i)throw new v.default({code:i,message:r})}async updatePermKey(e){var t;try{this.logger.log("updatePermKey() permKey: "+e),this.adapterRef.channelInfo.permKey=e,await(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t.updatePermKey(e)),this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:0,param:{permKey:e}})}catch(t){throw this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:t.code,param:{permKey:e,reason:t.message}}),t}}async addTasks(e){var t;const{rtmpTasks:i=[]}=e;let r,s;if(this.logger.log("addTasks() 增加互动直播推流任务, options: ",JSON.stringify(e)),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="addTasks() 观众角色不允许进行添加推流任务",r=g.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="addTasks() 加入房间后进行添加推流任务",r=g.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="addTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",r=g.default.ADD_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new v.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.addTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),message:e.message}}),e}}async deleteTasks(e){var t;const{taskIds:i=[]}=e;let r,s;if(this.logger.log("deleteTasks() 删除互动直播推流任务, options: ",e),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="deleteTasks() 观众角色不允许删除推流任务",r=g.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="deleteTasks() 加入房间后才能删除推流任务",r=g.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="deleteTasks() 参数格式错误, taskIds为空, 或者该数组长度为空",r=g.default.DELETE_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new v.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.deleteTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}async updateTasks(e){var t;const{rtmpTasks:i=[]}=e;let r,s;if(this.logger.log("updateTasks() 更新互动直播推流任务, options: ",e),i&&Array.isArray(i)&&i.length?1===this._roleInfo.userRole?(s="updateTasks() 观众角色不允许进行添加推流任务",r=g.default.TASKS_ROLE_ERROR):this.adapterRef._meetings||(s="updateTasks() 加入房间后进行添加推流任务",r=g.default.API_CALL_SEQUENCE_AFTER_ERROR):(s="updateTasks() 参数格式错误, rtmpTasks为空, 或者该数组长度为空",r=g.default.UPDATE_TASK_PARAMETER_ERROR),r)throw this.logger.error(s),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:{clientUid:this.getUid(),reason:r,message:s}}),new v.default({code:r,message:s});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.updateTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:0,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call")}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}refreshRemoteEvents(){for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];this.logger.warn("refreshRemoteEvents peer-online",e),this.safeEmit("peer-online",{uid:e}),f.MediaTypeList.forEach((i=>{t.pubStatus[i].producerId&&(this.logger.warn("refreshRemoteEvents stream-added",e,i),this.safeEmit("stream-added",{stream:t,mediaType:i}),t.muteStatus[i].send&&(this.logger.warn("refreshRemoteEvents mute-"+i,e,i),this.safeEmit("mute-"+i,{uid:t.getId()})))}))}}initSpatialManager(e){if(!this.spatialManager){const t=m.getAudioContext();if(!t)return void this.logger.error("当前环境不支持WebAudio");this.spatialManager=new R.SpatialManager({client:this,options:e,context:t})}this.spatialManager.init(),this.spatialManager.play()}syncUserList(){return this.adapterRef.memberMap}updateRecordingAudioStream(){if(!this.recordManager||!this.recordManager.formatMedia||!this.recordManager.formatMedia.destination)return;this.logger.log("updateRecordingAudioStream() [更新录制的音频]");const e=[];if(this.adapterRef.remoteStreamMap)for(var t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];e.push(i.mediaHelper.audio.audioStream)}this.adapterRef.localStream&&e.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),this.recordManager.formatMedia.updateStream(e)}async startMediaRecording(e){const{recorder:t,recordConfig:i}=e;this.recordManager.record||(this.recordManager.record=new p.Record({logger:this.logger,client:this.adapterRef.instance}),this.recordManager.record.on("media-recording-stopped",(e=>{this.safeEmit("@media-recording-stopped")}))),this.recordManager.formatMedia||(this.recordManager.formatMedia=new u.FormatMedia({adapterRef:this.adapterRef}));const r=[];if(this.adapterRef.localStream&&r.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),"all"===t&&this.adapterRef.remoteStreamMap)for(var s in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[s];r.push(e.mediaHelper.audio.audioStream)}const a=await this.recordManager.formatMedia.formatAudio(r),n=await this.recordManager.formatMedia.formatVideo(t,i),o=[];if(o.push(a,n),0!==o.length)return this.recordManager.record.start({uid:"",type:(null==i?void 0:i.recordType)||"video",recordName:null==i?void 0:i.recordName,reset:!0,stream:o});this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this.recordManager.record)throw new v.default({code:g.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.stop({})}cleanMediaRecording(){if(!this.recordManager.record)throw new v.default({code:g.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.clean()}downloadMediaRecording(){if(!this.recordManager.record)throw new v.default({code:g.default.RECORDING_NOT_START_ERROR,message:"stopMediaRecording() 录制未开始"});return this.recordManager.record.download()}async destroy(){const e=await this.operationQueue.enqueue({caller:this,method:"destroy",options:null});this.logger&&this.logger.warn("清除 Client 实例中"),this._reset(),this.destroyed=!0,this.logger&&this.logger.warn("已清除 Client 实例"),e()}}t.Client=A},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ENV=t.TAGS_TO_MAIN_DOMAIN=t.LBS_REGION_CONFIG=t.Config=void 0,t.Config={lbsUrl:"https://wecan-lbs.netease.im/api/v1/web_domains",checkSumUrl:"https://nrtc.netease.im/demo/getChecksum.action",createChannelUrl:"https://nrtc.netease.im/nrtc/createChannel.action",getChannelInfoUrl:"https://nrtc.netease.im/nrtc/getChannelInfos.action",roomsTaskUrl:"https://roomserver.netease.im/v2/sdk/rooms/",getCloudProxyInfoUrl:"https://ap-prd-jd.netease.im/v1/g2/getCloudProxyInfo"},t.LBS_REGION_CONFIG={GLOBAL:{cloudProxy:["ap-prd-jd.netease.im"],lbs:["wecan-lbs.netease.im","wecan-lbs.yunxinvcloud.com"],nrtc:["nrtc.netease.im","wecan-gw.yunxinvcloud.com"],call:["roomserver.netease.im","wecan-sdk.yunxinvcloud.com"],tracking:["statistic.live.126.net","apm.yunxinhi.com"]},OVERSEAS:{cloudProxy:["supervisor-overseas.yunxinvcloud.com"],lbs:["lbs-overseas.yunxinvcloud.com"],nrtc:["nrtc-overseas.yunxinvcloud.com"],call:["call-overseas.yunxinvcloud.com"],tracking:["statistic-overseas.yunxinfw.com"]}},t.TAGS_TO_MAIN_DOMAIN={cloudProxy:"ap-prd-jd.netease.im",lbs:"wecan-lbs.netease.im",nrtc:"nrtc.netease.im",call:"roomserver.netease.im",tracking:"statistic.live.126.net"},t.ENV="production"},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.logHelper=void 0,t.logHelper=class{constructor(e){if(e.maxLogsLines&&"number"==typeof e.maxLogsLines&&!isNaN(e.maxLogsLines)?this.maxLogsLines=e.maxLogsLines:this.maxLogsLines=5e3,e.logFilename&&(e.logFilename=e.logFilename+".txt"),this.useTimestamps=e.useTimestamps||!1,this.useLocalStorage=e.useLocalStorage||!1,this.autoTrim=!0,this.maxLines=e.maxLogsLines||5e3,this.tailNumLines=100,this.logFilename=e.logFilename||"nimWebRtcLog.txt",this.maxDepth=5,this.depth=0,this.parentSizes=[0],this.currentResult="",this.startTime=new Date,this.output="",this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.output=i.log;var r=new Date(i.startTime),s=new Date(i.lastLog);this.output+="\n---- Session end: "+i.lastLog+" ----\n",this.output+=this.formatSessionDuration(r.getTime(),s.getTime()),this.output+="\n\n"}}this.output+="---- Session started: "+this.startTime+" ----\n\n"}getLog(){var e=new Date;if(this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.startTime=new Date(i.startTime),this.output=i.log,e=new Date(i.lastLog)}}return this.output+"\n---- Log retrieved: "+e+" ----\n"+this.formatSessionDuration(this.startTime.getTime(),e.getTime())}tail(e){return e=e||this.tailNumLines,this.trimLog(this.getLog(),e)}search(e){for(var t=this.output.split("\n"),i=new RegExp(e),r=[],s=0;s<t.length;s++){var a="["+s+"] ";t[s].match(i)&&r.push(a+t[s])}var n=r.join("\n");return 0==n.length&&(n='Nothing found for "'+e+'".'),n}getSlice(e,t){return this.output.split("\n").slice(e,e+t).join("\n")}downloadLog(){var e=this.getLog(),t=new Blob([e],{type:"data:text/plain;charset=utf-8"}),i=document.createElement("a");i.href=window.URL.createObjectURL(t),i.target="_blank",i.download=this.logFilename,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(i.href)}clear(){var e=new Date;if(this.output="---- Log cleared: "+e+" ----\n",this.useLocalStorage){var t={startTime:this.startTime,log:this.output,lastLog:e},i=JSON.stringify(t);window.localStorage.setItem("nimWebRtcLog",i)}}log(e){var t=this.determineType(e);if(null!=t){var i=this.formatType(t,e);if(this.useTimestamps){var r=new Date;this.output+=this.formatTimestamp(r)}if(this.output+=i+"\n",this.autoTrim&&(this.output=this.trimLog(this.output,this.maxLines)),this.useLocalStorage){var s=new Date,a={startTime:this.startTime,log:this.output,lastLog:s},n=JSON.stringify(a);window.localStorage.setItem("nimWebRtcLog",n)}}this.depth=0,this.parentSizes=[0],this.currentResult=""}determineType(e){if(null!=e){var t=typeof e;return"object"==t?null==e.length?"function"==typeof e.getTime?"Date":"function"==typeof e.test?"RegExp":"Object":"Array":t}return"null"}formatType(e,t){if(this.maxDepth&&this.depth>=this.maxDepth)return"... (max-depth reached)";switch(e){case"Object":this.currentResult+="{\n",this.depth++,this.parentSizes.push(this.objectSize(t));var i=0;for(var r in t){this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+=r+": ";var s=this.determineType(t[r]);(a=this.formatType(s,t[r]))?("function"!==s&&(this.currentResult+=a),i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"),i++}if(this.depth--,this.parentSizes.pop(),this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+="}",0==this.depth)return this.currentResult;break;case"Array":for(this.currentResult+="[",this.depth++,this.parentSizes.push(t.length),i=0;i<t.length;i++){var a;"Object"!=(s=this.determineType(t[i]))&&"Array"!=s||(this.currentResult+="\n"+this.indentsForDepth(this.depth)),(a=this.formatType(s,t[i]))?(this.currentResult+=a,i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),"Array"==s&&(this.currentResult+="\n")):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),("Object"!=s||i==this.parentSizes[this.depth]-1)&&(this.currentResult+="\n"))}if(this.depth--,this.parentSizes.pop(),this.currentResult+="]",0==this.depth)return this.currentResult;break;case"function":var n=(t+="").split("\n");for(i=0;i<n.length;i++)n[i].match(/\}/)&&this.depth--,this.currentResult+=this.indentsForDepth(this.depth),n[i].match(/\{/)&&this.depth++,this.currentResult+=n[i]+"\n";return this.currentResult;case"RegExp":return"/"+t.source+"/";case"Date":case"string":return this.depth>0||0==t.length?'"'+t+'"':t;case"boolean":return t?"true":"false";case"number":return t+""}}indentsForDepth(e){for(var t="",i=0;i<e;i++)t+="\t";return t}trimLog(e,t){var i=e.split("\n");return i.length>t&&(i=i.slice(i.length-t)),i.join("\n")}lines(){return this.output.split("\n").length}formatSessionDuration(e,t){var i=t-e,r=Math.floor(i/1e3/60/60),s=("0"+r).slice(-2);i-=1e3*r*60*60;var a=Math.floor(i/1e3/60),n=("0"+a).slice(-2);i-=1e3*a*60;var o=Math.floor(i/1e3);return i-=1e3*o,"---- Session duration: "+s+":"+n+":"+("0"+o).slice(-2)+" ----"}formatTimestamp(e){var t=e.getFullYear(),i=e.getDate();return"["+t+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+i+" "+Number(e.getHours())+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)+"]: "}objectSize(e){var t,i=0;for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&i++;return i}}},function(e,t){var i,r;i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var t=[],r=0;r<e.length;r+=3)for(var s=e[r]<<16|e[r+1]<<8|e[r+2],a=0;a<4;a++)8*r+6*a<=8*e.length?t.push(i.charAt(s>>>6*(3-a)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],r=0,s=0;r<e.length;s=++r%4)0!=s&&t.push((i.indexOf(e.charAt(r-1))&Math.pow(2,-2*s+8)-1)<<2*s|i.indexOf(e.charAt(r))>>>6-2*s);return t}},e.exports=r},function(e,t){function i(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}
/*!
     * Determine if an object is a Buffer
     *
     * @author   Feross Aboukhadijeh <https://feross.org>
     * @license  MIT
     */e.exports=function(e){return null!=e&&(i(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}(e)||!!e._isBuffer)}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormatMedia=void 0;const s=i(11),a=r(i(12)),n=r(i(13)),o=i(127);class d extends s.EventEmitter{constructor(e){super(),this.adapterRef=e.adapterRef,this.logger=e.adapterRef.logger,this.audioContext=null,this.destination=null,this.audioStreams=[],this.canvas=null,this.canvasContext=null,this.canvasTimer=null}async formatAudio(e){this.logger.log("formatAudio() [混音: ]",e);try{return this.audioContext||(this.audioContext=new window.AudioContext),this.destination=this.audioContext.createMediaStreamDestination(),await this.initAudioIn(e),this.destination.stream}catch(e){return this.logger.error("formatAudio() 异常: ",e.name,e.message),Promise.reject(new n.default({code:a.default.RECORDING_NOT_SUPPORT,message:e.message||"formatAudio() 浏览器不支持"}))}}initAudioIn(e){if(this.audioContext&&this.destination){for(var t=0;t<e.length;t++){const i=e[t].getAudioTracks()[0];if("live"!==(null==i?void 0:i.readyState))continue;const r=this.audioContext.createMediaStreamSource(e[t]);r.connect(this.destination),this.audioStreams.push(r)}this.logger.log(`initAudioIn() [初始化音频 state: ${this.audioContext.state}]`),"running"!==this.audioContext.state&&this.audioContext.resume().then((()=>{this.audioContext&&this.logger.log(`initAudioIn(): [audioContext 状态变更成功 state: ${this.audioContext.state}]`)})).catch((e=>{this.logger.warn(`initAudioIn(): [audioContext 状态变更发生错误, errorName: ${e.name}, erroMessage: ${e.message}]`),this.audioContext&&this.audioContext.resume()}))}else this.logger.error("initAudioIn:参数不够")}async updateStream(e){this.logger.log("updateStream() [更新混频的音频数据: ]",e),this.audioStreams.forEach((e=>{e.disconnect(0)})),this.audioStreams.length=0,this.initAudioIn(e)}stopFormatAudio(){this.logger.log("stopFormatAudio() [结束混音]"),this.audioStreams.forEach((e=>{e.disconnect(0)})),this.audioContext&&this.audioContext.close(),this.audioContext=null,this.destination=null}async formatVideo(e,t){this.logger.log("formatVideo() 混频 recorder: ",e,"recordConfig: ",t);let i=640,r=360;const s=(null==t?void 0:t.recordVideoFrame)||15;switch(null==t?void 0:t.recordVideoQuality){case 360:i=640,r=360;break;case 480:i=640,r=480;break;case 720:i=1280,r=720}this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=o.get2DContext(this.canvas)),this.canvas.width=i,this.canvas.height=r,this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null);const a=Math.floor(i/2),n=Math.floor(r/2),d=Math.floor(i/3),c=Math.floor(r/3);return this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r)),this.canvasTimer&&clearInterval(this.canvasTimer),this.canvasTimer=setInterval((()=>{var s,o,l;this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r));let u=[];if("video"===(null==t?void 0:t.recordType)&&((null===(s=this.adapterRef.localStream)||void 0===s?void 0:s._play.video.dom)?u.push(this.adapterRef.localStream._play.video.dom):u.push(document.createElement("video")),(null===(o=this.adapterRef.localStream)||void 0===o?void 0:o._play.screen.dom)&&u.push(null===(l=this.adapterRef.localStream)||void 0===l?void 0:l._play.screen.dom),"all"===e&&this.adapterRef.remoteStreamMap))for(var h in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[h];e._play.video.dom&&u.push(e._play.video.dom),e._play.screen.dom&&u.push(e._play.screen.dom)}switch(u.length>9&&(u=u.filter((e=>4===e.readyState))),u.length){case 0:break;case 1:this.drawSingleVideo(u[0],0,0,i,r);break;case 2:this.drawSingleVideo(u[0],0,0,a,r),this.drawSingleVideo(u[1],a,0,a,r);break;case 3:case 4:this.drawSingleVideo(u[0],0,0,a,n),this.drawSingleVideo(u[1],a,0,a,n),this.drawSingleVideo(u[2],0,n,a,n),this.drawSingleVideo(u[3],a,n,a,n);break;default:this.drawSingleVideo(u[0],0,0,d,c),this.drawSingleVideo(u[1],d,0,d,c),this.drawSingleVideo(u[2],2*d,0,d,c),this.drawSingleVideo(u[3],0,c,d,c),this.drawSingleVideo(u[4],d,c,d,c),this.drawSingleVideo(u[5],2*d,c,d,c),this.drawSingleVideo(u[6],0,2*c,d,c),this.drawSingleVideo(u[7],d,2*c,d,c),this.drawSingleVideo(u[8],2*d,2*c,d,c)}}),Math.floor(1e3/s)),this.canvas.captureStream()}drawSingleVideo(e,t,i,r,s){var a;if(!e)return;const n=Math.min(r/e.videoWidth,s/e.videoHeight);let o=e.videoWidth*n,d=e.videoHeight*n,c=t+(r-o)/2,l=i+(s-d)/2;null===(a=this.canvasContext)||void 0===a||a.drawImage(e,c,l,o,d)}async stopFormatVideo(){this.logger.log("stopFormatAudio() [结束混频]"),this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null),this.canvasContext=this.canvas=null}destroy(){this.logger.log("destroy()"),this.stopFormatAudio(),this.stopFormatVideo()}}t.FormatMedia=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.OperationQueue=void 0;let r=!1;t.OperationQueue=class{constructor(e){this.cnt=0,this.current=null,this.history=null,this.queue=[],this.logger=e.getChild((()=>{let e="oper";return this.current?e+=` ${this.current.args.method}#${this.current.id}`:this.history&&(e+=` ${this.history.args.method}#${this.history.id} FINISHED`),this.queue.forEach((t=>{e+=`|${t.args.method}#${t.id}`})),e})),setInterval((()=>{if(this.current&&Date.now()-this.current.enqueueTs>5e3){if(this.queue.length){const e=this.queue[0];this.logger.error(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}。即将进行下一个操作：${e.args.method}#${e.id}`)}else this.logger.log(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}`);this.current.status="timeout",this.history=this.current,this.current=null,this.fire("timer")}}),5e3)}enqueue(e){var t,i;if(!r){const s=e.caller;s.clientId>-1&&s.clientId==(null===(i=null===(t=s.adapterRef)||void 0===t?void 0:t.instance)||void 0===i?void 0:i.clientId)&&s!==s.adapterRef.instance&&(s.logger.warn("侦测到该次调用的this不指向原生Client对象。请避免使用Proxy或bind等方式篡改SDK调用主体：Client:"+e.method),r=!0)}return new Promise(((t,i)=>{this.queue.push({id:++this.cnt,enqueueTs:Date.now(),args:e,resolve:t,reject:i,status:"pending"}),this.current?this.logger.log(`操作等位中，目前有其他操作。前面还有${this.queue.length}位：${e.method}#${this.cnt}。`):this.fire("instant")}))}fire(e){var t;if(!this.current){const i=this.queue.shift();if(i){if(null===(t=i.args.caller)||void 0===t?void 0:t.destroyed)return this.logger.error(`无法执行操作：${i.args.method}: 对象已被销毁，请重新创建对象`),void this.fire("functionEnd");this.history=this.current,this.current=i,this.current.status="live","instant"===e?this.logger.log("开始执行操作："+i.args.method):this.logger.log(`开始执行队列中的操作：${i.args.method}#${i.id}，等待时间：${Date.now()-i.enqueueTs}ms。`),i.startTs=Date.now(),i.resolve((()=>{this.current===i?(this.current.status="finished",this.history=this.current,this.current=null,this.logger.log(`执行操作结束：${i.args.method}。花费 ${i.startTs?Date.now()-i.startTs:null}ms`),this.fire("functionEnd")):"timeout"===i.status?this.logger.log(`执行操作结束：${i.args.method}。花费 ${i.startTs?Date.now()-i.startTs:null}ms。该操作超时，但未阻塞执行队列。`):this.logger.error(`操作收到多次返回：${i.args.method}#${i.id}。花费 ${i.startTs?Date.now()-i.startTs:null}ms`)}))}}}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Base=void 0;const s=i(150),a=i(218),n=i(220),o=i(257),d=i(2),c=i(178),l=i(259),u=i(282),h=i(68),p=r(i(12)),m=r(i(13)),f=r(i(201)),g=i(60),v=i(58),_=i(151),y=i(304),S=i(73),R=i(74),b=i(59),E=i(305);let T=0;class A extends S.RTCEventEmitter{constructor(e){super(),this.transportRebuildCnt=0,this.timeLast=Date.now(),this._params={appkey:"",mode:"rtc"},this.isReport="boolean"!=typeof e.report||e.report,this.clientId=T++,this.adapterRef={datareportCache:[],channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},apiEvents:{},requestId:{},instance:this,preferRemb:!1,deviceId:""};const t=d.getParameters().forceLogLevel;-1!==t?f.default.setLogLevel(t):!0===e.debug?f.default.setLogLevel(R.loglevels.DEBUG):!1===e.debug&&d.getParameters().logLevel<=R.loglevels.WARNING&&f.default.setLogLevel(R.loglevels.WARNING),this.logger=new v.Logger({tagGen:()=>{let e="client"+(this.clientId||"");const t=this.getUid();return t&&(e+="#"+t),"CONNECTED"!==this.adapterRef.connectState.curState&&(e+=" "+this.adapterRef.connectState.curState),this.destroyed&&(e+=" DESTROYED"),e}}),this.adapterRef.logger=this.logger,this.recordManager={record:null,formatMedia:null},this._reset(),this.adapterRef.encryption=new s.Encryption(this.adapterRef),e.debug&&(d.getParameters().debugG2=!0),this.sdkRef=e.ref}_reset(){this.sdkRef=null,this.adapterRef={datareportCache:[],audioAsl:{enabled:"unknown",aslActiveNum:-1},uid2SscrList:{},netStatusTimer:null,networkQuality:{},_statsReport:null,_meetings:null,state:void 0,mediaCapability:void 0,nim:void 0,instance:this,lbsManager:void 0,channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},memberMap:{},apiEvents:{},transportStats:{txRtt:-1,rxRtt:-1,NetworkType:"unknown",OutgoingAvailableBandwidth:-1},sessionStats:void 0,remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{},remoteStreamMap:{},localStream:null,localAudioStats:{},localAudioSlaveStats:{},localVideoStats:[],localScreenStats:[],logger:this.logger,logStorage:void 0,channelStatus:"init",_signalling:null,connectState:{prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},_mediasoup:null,mediaHelpers:{},netStatusList:[],requestId:{},deviceId:"",preferRemb:!1,nomalizedPlaybackVolume:1,userPriority:{priority:100,preemtiveMode:!1},proxyServer:{enable:!1,type:3},encryption:void 0,signalProbeManager:void 0,isAudioBanned:!1,isVideoBanned:!1,permKeyInfo:void 0},this.adapterRef.mediaCapability=new a.MediaCapability(this.adapterRef),this.adapterRef.encryption=new s.Encryption(this.adapterRef),this.adapterRef.signalProbeManager=new E.SignalProbeManager(this.adapterRef),this._resetState(),this.adapterRef.lbsManager=new y.LBSManager(this),this._destroyModule()}_getSupportedCodecs(){return g.getSupportedCodecs(...arguments)}initMode(){this.adapterRef._meetings||(this.adapterRef._meetings=new o.Meeting({sdkRef:this.sdkRef,adapterRef:this.adapterRef})),this.adapterRef._signalling||(this.adapterRef._signalling=new u.Signalling({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._mediasoup||(this.adapterRef._mediasoup=new n.Mediasoup({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._statsReport||(this.adapterRef._statsReport=new l.StatsReport({sdkRef:this.sdkRef,adapterRef:this.adapterRef,isReport:this.isReport}))}_destroyModule(){this.adapterRef._meetings&&(this.adapterRef._meetings.destroy(),this.adapterRef._meetings=null),this.adapterRef._signalling&&(this.adapterRef._signalling.destroy(),this.adapterRef._signalling=null),this.adapterRef._mediasoup&&(this.adapterRef._mediasoup.destroy(),this.adapterRef._mediasoup=null),this.recordManager.formatMedia&&(this.recordManager.formatMedia.destroy(),this.recordManager.formatMedia=null),this.recordManager.record&&(this.recordManager.record.destroy(),this.recordManager.record=null),this.adapterRef.signalProbeManager.stop()}_resetState(){this._params.neRtcServerAddresses={},this.adapterRef.channelStatus="init",this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},this.adapterRef.networkQuality={},this.adapterRef.localStream=null,this.adapterRef.memberMap={},this.adapterRef.remoteStreamMap={},this.adapterRef.netStatusList=[],this.adapterRef.netStatusTimer&&(clearInterval(this.adapterRef.netStatusTimer),this.adapterRef.netStatusTimer=null),this.adapterRef.uid2SscrList={},this.adapterRef.proxyServer={enable:!1,type:3},this.adapterRef.state={lastDeviceStatus:{audio:{type:null,device:null},video:{type:null,device:null}},audioDeviceHasOpened:!1,videoDeviceHasOpened:!1,chromeScreenShareOpened:!1,startSessionTime:0,endSessionTime:0,startPubVideoTime:0,startPubScreenTime:0,getChannelInfoTime:0,signalEstablishTime:0,signalOpenTime:0,signalJoinResTime:0,signalJoinSuccessTime:0,getChannelInfoRtt:0,signalWebsocketOpenRtt:0,signalJoinMsgRtt:0,signalAudioAddedTime:0,signalAudioSubscribedTime:0,signalVideoAddedTime:0,signalVideoSubscribedTime:0,iceRecvConnectedTime:0,domVideoAppendTime:0,videoFirstIframeTime:0,videoResizeTime:0},Object.assign(this.adapterRef,{transportStats:{NetworkType:"unknown",OutgoingAvailableBandwidth:0,txRtt:0,rxRtt:0},sessionStats:{Duration:0,RecvBitrate:0,RecvBytes:0,SendBitrate:0,SendBytes:0,UserCount:0},localAudioStats:[],localAudioSlaveStats:[],localVideoStats:[],localScreenStats:[],remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{}})}setSessionConfig(e={}){this.adapterRef.channelInfo||(this.adapterRef.channelInfo={}),this.adapterRef.channelInfo.sessionConfig||(this.adapterRef.channelInfo.sessionConfig={}),this.adapterRef.channelInfo.sessionConfig=Object.assign(this.adapterRef.channelInfo.sessionConfig,e)}resetChannel(){this.adapterRef.networkQuality={},this.adapterRef.netStatusList=[];for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active&&(t.active=!1,t.stop(),t.clearRemotePubStatus(),this.adapterRef.instance.safeEmit("peer-leave",{uid:e}))}this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this.adapterRef._mediasoup&&this.adapterRef._mediasoup.destroy()}async startSession(e=0){0===e?this.logger.log("开始音视频会话"):this.logger.log(`开始音视频会话：第${e}次`);let{wssArr:t,cid:i}=this.adapterRef.channelInfo;if(!t||0===t.length)throw this.logger.error("没有找到服务器地址 : "+JSON.stringify(this.adapterRef.channelInfo)),this.adapterRef.channelStatus="leave",new m.default({code:p.default.JOIN_FAILED,message:"没有找到媒体服务器地址"});if(!i)throw this.logger.error("服务器没有分配cid"),new m.default({code:p.default.JOIN_FAILED,message:"服务器没有分配cid"});if(this.logger.log(`开始连接服务器: ${this.adapterRef.channelInfo.wssArrIndex}, url: ${t[this.adapterRef.channelInfo.wssArrIndex]}`),this.adapterRef.channelInfo.wssArrIndex>=t.length)throw this.logger.error("所有的服务器地址都连接失败"),new m.default({code:p.default.NETWORK_ERROR,message:"所有的服务器地址都连接失败"});if(!this.adapterRef._signalling)throw new m.default({code:p.default.UNKNOWN_TYPE_ERROR,message:"startSession: 信令模块缺失"});try{await this.adapterRef._signalling.init(!1,!1)}catch(e){throw this.adapterRef.channelStatus="leave",e}const r=t[this.adapterRef.channelInfo.wssArrIndex];t.splice(this.adapterRef.channelInfo.wssArrIndex,1),t.unshift(r),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef._statsReport&&this.adapterRef._statsReport.start()}stopSession(){this.logger.log("开始清除音视频会话"),this._destroyModule();const e=d.getParameters().localStreams.filter((e=>e.client.clientId===this.clientId&&!e.destroyed));e.length&&(d.getParameters().keepLocalstreamOnLeave?this.logger.log("当前模式下离开频道不会销毁localStream"):(this.logger.log(`即将销毁${e.length}个localStream`),e.forEach((e=>{e.destroy()})))),Object.values(this.adapterRef.remoteStreamMap).forEach((e=>{e.destroy()})),this.adapterRef.remoteStreamMap={},this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this._resetState(),this.adapterRef._statsReport&&(this.adapterRef._statsReport.destroy(),this.adapterRef._statsReport=null)}async clearMember(e){var t;this.logger.log(e+"离开房间");const i=this.adapterRef.remoteStreamMap[e];if(null==i?void 0:i.active){for(let e of h.MediaTypeList)i.pubStatus[e].producerId&&this.adapterRef.instance.safeEmit("stream-removed",{stream:i,mediaType:e,reason:"onPeerLeave"});delete this.adapterRef.remoteStreamMap[e],delete this.adapterRef.memberMap[e],delete this.adapterRef.remoteAudioStats[e],delete this.adapterRef.remoteAudioSlaveStats[e],delete this.adapterRef.remoteVideoStats[e],delete this.adapterRef.remoteScreenStats[e];for(let e of h.MediaTypeList)i.pubStatus[e].consumerId&&await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.destroyConsumer(i.pubStatus[e].consumerId,i,e));i.active=!1,i.destroy()}this.adapterRef.netStatusList=this.adapterRef.netStatusList.filter(((t,i,r)=>t.uid!==e)),this.logger.log(e+" 离开房间 通知用户"),this.adapterRef.instance.safeEmit("peer-leave",{uid:e})}setStartSessionTime(){this.adapterRef.state.startSessionTime=Date.now();const e=b.generateUUID(),t=this.adapterRef.channelInfo.channelName||"",i=this.adapterRef.channelInfo.uid||0,r=Date.now(),s=_(e+t+i+r+"");this.adapterRef.deviceId=b.randomString(s,16)}setEndSessionTime(){if(!this.adapterRef.state.startSessionTime)return void this.logger.log("AbstractAdapter: setEndSessionTime: startSessionTime为空");this.adapterRef.state.endSessionTime=Date.now();const e=this.adapterRef.state.endSessionTime-this.adapterRef.state.startSessionTime;this.adapterRef.instance.safeEmit("@sessionDuration",e),this.adapterRef.state.startSessionTime=0,this.adapterRef.state.endSessionTime=0}async reBuildRecvTransport(){if(this.transportRebuildCnt++,this.transportRebuildCnt>=d.getParameters().maxTransportRebuildCnt)return void this.logger.error("reBuildRecvTransport 达到最大重连次数："+this.transportRebuildCnt);if(this.logger.warn("下行通道异常，重新建立 #"+this.transportRebuildCnt),!this.adapterRef._mediasoup)return;this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-start"),this.adapterRef._mediasoup._recvTransport&&(this.adapterRef._mediasoup._recvTransport.close(),this.adapterRef._mediasoup.getIceStatus("recv"),this.adapterRef._mediasoup._recvTransport=null),this.adapterRef._mediasoup.init(),this.logger.log("下行通道异常, remoteStreamMap",Object.keys(this.adapterRef.remoteStreamMap)),this.logger.log("this._eventQueue: ",this.adapterRef._mediasoup._eventQueue);let e=!1;for(const t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];if(i){i.pubStatus.audio.consumerStatus="init",i.pubStatus.video.consumerStatus="init",i.pubStatus.screen.consumerStatus="init",i.pubStatus.audio.consumerId="",i.pubStatus.video.consumerId="",i.pubStatus.screen.consumerId="",this.logger.log("重连逻辑订阅 start：",i.stringStreamID);try{await this.doSubscribe(i)}catch(t){this.logger.error("重连逻辑订阅 error: ",t,t.name,t.message),e=!0,this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-error");break}this.logger.log("重连逻辑订阅 over: ",i.stringStreamID)}}e||this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-success")}apiFrequencyControl(e){if(d.getParameters().disableAllReports)return;const{name:t,code:i,param:r}=e;if(!t)return;this.adapterRef.apiEvent[t]||(this.adapterRef.apiEvent[t]=[],this.adapterRef.apiEvents[t]=[],this.adapterRef.requestId[t]=0);let s=this.adapterRef.channelInfo.clientNtpTime-this.adapterRef.channelInfo.T4;s>0||(s=0);let a=Date.now()+s;if(a<=this.timeLast&&(a=this.timeLast+1),this.timeLast=a,this.adapterRef.apiEvent[t].length<10)this.adapterRef.apiEvent[t].push({cid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid,code:i,name:t,time:a,param:r,request_id:this.adapterRef.requestId[t]++});else{if(!this.adapterRef.apiEvent||!this.adapterRef.apiEvent[t]||!this.adapterRef.apiEvent[t].length)return;this.adapterRef.apiEvent[t][0].time,Date.now()-this.adapterRef.apiEvent[t][0].time<1e4?this.adapterRef.requestId[t]++:(this.adapterRef.apiEvents[t]=this.adapterRef.apiEvents[t].concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}}apiEventReport(e,t){if(!e)return;if(d.getParameters().disableAllReports)return;let i=new c.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef});i[e](Object.assign({uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid,time:Date.now()},t)),this.adapterRef.channelInfo.cid&&this.adapterRef.channelInfo.uid?i.send():(this.adapterRef.datareportCache.push({func:e,datareport:i}),this.adapterRef.datareportCache.length>20&&this.adapterRef.datareportCache.shift())}getUidAndKindBySsrc(e){var t,i;const r=["high","low"];for(let s of h.MediaTypeList)for(let a of r)if((null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.senderEncodingParameter[s][a])||void 0===i?void 0:i.ssrc)===e)return{uid:0,kind:s,streamType:a};for(let t in this.adapterRef.uid2SscrList){if(this.adapterRef.uid2SscrList[t].audio.ssrc==e)return{uid:t,kind:"audio",streamType:"high"};if(this.adapterRef.uid2SscrList[t].audioSlave.ssrc==e)return{uid:t,kind:"audioSlave",streamType:"high"};if(this.adapterRef.uid2SscrList[t].video&&this.adapterRef.uid2SscrList[t].video.ssrc==e)return{uid:t,kind:"video",streamType:"high"};if(this.adapterRef.uid2SscrList[t].screen&&this.adapterRef.uid2SscrList[t].screen.ssrc==e)return{uid:t,kind:"screen",streamType:"high"}}return{uid:0,kind:"",streamType:"high"}}getSsrcByUidAndKind(e,t){return this.adapterRef.uid2SscrList[e]&&this.adapterRef.uid2SscrList[e][t]}addSsrc(e,t,i){this.adapterRef.uid2SscrList[e]||(this.adapterRef.uid2SscrList[e]={audio:{ssrc:0},audioSlave:{ssrc:0},video:{ssrc:0},screen:{ssrc:0}}),this.adapterRef.uid2SscrList[e][t]?this.adapterRef.uid2SscrList[e][t].ssrc=i:this.adapterRef.uid2SscrList[e][t]={ssrc:i}}removeSsrc(e,t){this.adapterRef.uid2SscrList[e]&&(t?this.adapterRef.uid2SscrList[e][t]&&(this.adapterRef.uid2SscrList[e][t].ssrc=0):delete this.adapterRef.uid2SscrList[e])}isPublished(e){var t;return e&&(null===(t=this.adapterRef.localStream)||void 0===t?void 0:t.localStreamId)===e.localStreamId&&(e.audio&&e.pubStatus.audio.audio||e.video&&e.pubStatus.video.video||e.screen&&e.pubStatus.screen.screen)}getPeer(e){return this.adapterRef._mediasoup?"send"==e?this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport.handler._pc:"recv"==e?this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport.handler._pc:null:null}destroy(){this.logger.log("base: destroy!"),this._reset()}}t.Base=A},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MediaCapability=void 0;const r=i(219),s=i(60),a=i(2);t.MediaCapability=class{constructor(e){this.logger=e.logger.getChild((()=>{let e="codec"+this.room.videoCodecType.join(",");return this.supportedCodecSend&&2===this.supportedCodecSend.length&&this.supportedCodecRecv&&2===this.supportedCodecRecv.length||(e+=`/${this.supportedCodecSend}/${this.supportedCodecRecv}`),e})),this.supportedCodecRecv=null,this.supportedCodecSend=null,this.preferredCodecSend={video:["H264","VP8"],screen:["H264","VP8"]},this.room={videoCodecType:[]}}async detect(){const e=Date.now();let t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},i=await s.getSupportedCodecs("send")||{video:[],audio:["OPUS"]};if(a.getParameters().h264Wait){if(-1===t.video.indexOf("H264"))for(this.logger.warn(`当前浏览器不支持H264解码。这可能会触发频道内编码协商。最多等待 ${a.getParameters().h264Wait} 毫秒以避免编码器尚未加载。`);Date.now()-e<a.getParameters().h264Wait;){if(t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},-1!==t.video.indexOf("H264")){this.logger.log(`H264解码器加载完成！用时 ${Date.now()-e} 毫秒`);break}await new Promise((e=>{setTimeout(e,100)}))}-1===t.video.indexOf("H264")&&this.logger.warn("H264解码器加载失败！")}if(this.supportedCodecRecv=t.video,this.supportedCodecSend=i.video,a.getParameters().disableH264Send){let e=this.supportedCodecSend.indexOf("H264");-1!==e&&(this.logger.log("根据私有化参数设置，忽略H264发送支持"),this.supportedCodecSend.splice(e,1))}if(a.getParameters().disableVP8Send){let e=this.supportedCodecSend.indexOf("VP8");-1!==e&&(this.logger.log("根据私有化参数设置，忽略VP8发送支持"),this.supportedCodecSend.splice(e,1))}this.logger.log("detect supportedCodecRecv",JSON.stringify(this.supportedCodecRecv),"supportedCodecSend",JSON.stringify(this.supportedCodecSend),"Preferred codec:",JSON.stringify(this.preferredCodecSend))}getCodecCapability(){if(this.supportedCodecRecv&&this.supportedCodecSend){const e=[];for(let t of s.VideoCodecList)this.supportedCodecRecv.indexOf(t)>-1&&this.supportedCodecSend.indexOf(t)>-1&&e.push(t);return e}return this.logger.error("getCodecCapability: call detect first"),[]}stringify(){let e={256:[]};for(let t of this.getCodecCapability())r.VideoCodecStr2Int[t]>-1?e[256].push(r.VideoCodecStr2Int[t]):this.logger.error("MediaCapability:Unknown VideoCodecStr2Int",t);return 0===e[256].length&&this.logger.warn("MediaCapability:No Local Suitable codec available"),JSON.stringify(e)}getCodecSend(e,t){var i,r;let s={codecName:null},n={codecName:null};for(let o=0;o<this.preferredCodecSend[e].length;o++){const d=this.preferredCodecSend[e][o];if(t.codecs||!t.codecs.length)for(let e=0;e<t.codecs.length;e++){const o=t.codecs[e];a.getParameters().disableH264Send&&(null===(i=o.mimeType)||void 0===i?void 0:i.toLowerCase().indexOf("h264"))>-1||a.getParameters().disableVP8Send&&(null===(r=o.mimeType)||void 0===r?void 0:r.toLowerCase().indexOf("vp8"))>-1||o.mimeType&&o.mimeType.toLowerCase().indexOf(d.toLowerCase())>-1&&(this.room.videoCodecType.indexOf(d)>-1?s.codecName||(s={codecParam:o,codecName:d}):n.codecName||(n={codecParam:o,codecName:d}))}}return s.codecName?(this.logger.log("MediaCapability：发送的Codec为:",s.codecName,JSON.stringify(s.codecParam)),s):(this.logger.warn("MediaCapability：未找到合适的发送Codec。发送的Codec使用:",n.codecName,n.codecParam),n)}parseRoom(e){if(!e.mediaCapabilitySet)return;const t=JSON.parse(e.mediaCapabilitySet);if(t[256]){const i=this.room.videoCodecType;this.room.videoCodecType=[];for(const i of t[256]){let t=r.VideoCodecInt2Str[i];t?this.room.videoCodecType.push(t):this.logger.error("Unknown Video Codec Type",i,e)}i.length?this.logger.log("Room videoCodecType发生变更。new:",this.room.videoCodecType,"old:",i):this.logger.log("Room videoCodecType:",JSON.stringify(this.room.videoCodecType))}}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoCodecStr2Int=t.VideoCodecInt2Str=t.SignalChannelMode=void 0,function(e){e[e.CHANNEL_MODE_P2P=1]="CHANNEL_MODE_P2P",e[e.CHANNEL_MODE_MEETING=2]="CHANNEL_MODE_MEETING",e[e.CHANNEL_MODE_1V1=3]="CHANNEL_MODE_1V1"}(t.SignalChannelMode||(t.SignalChannelMode={})),t.VideoCodecStr2Int={H264:0,H265:1,VP8:2,NEVC:3},t.VideoCodecInt2Str={0:"H264",1:"H265",2:"VP8",3:"NEVC"}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mediasoup=void 0;const o=i(11),d=i(68),c=n(i(12)),l=n(i(13)),u=a(i(14)),h=i(221),p=a(i(168)),m=i(2),f=i(244),g=i(14),v=i(124),_=i(145),y=i(131);let S=0;class R extends o.EventEmitter{constructor(e){super(),this._consumers={},this._timeout=6e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._audioSlaveProducer=null,this._audioSlaveProducerId=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._webcamProducerCodec=null,this._screenProducerCodec=null,this._sendTransport=null,this._recvTransport=null,this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer=null,this._eventQueue=[],this._eventQueueData=[],this._protoo=null,this.mediasoupId=S++,this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},audioSlave:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this.unsupportedProducers={},this.iceStatusHistory={send:{promises:[],status:{ts:0,info:""}},recv:{promises:[],status:{ts:0,info:""}}},this.adapterRef=e.adapterRef,this.logger=e.logger,this.loggerSend=e.logger.getChild((()=>{var e,t;let i="MediaSend";if(this._sendTransport)if(null===(e=this._sendTransport._handler)||void 0===e?void 0:e._pc){const e=this._sendTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(i+=" "+e.connectionState),"stable"!==e.signalingState&&(i+=" "+e.signalingState)}else i+=" NOTRANSPORT";else i+=" UNINIT";return(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.mediasoupId)!==this.mediasoupId&&(i+=" DETACHED"),i})),this.loggerRecv=e.logger.getChild((()=>{var e,t;let i="MediaRecv";if(this._recvTransport)if(null===(e=this._recvTransport._handler)||void 0===e?void 0:e._pc){const e=this._recvTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(i+=" "+e.connectionState),"stable"!==e.signalingState&&(i+=" "+e.signalingState)}else i+=" NOTRANSPORT";else i+=" UNINIT";return(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.mediasoupId)!==this.mediasoupId&&(i+=" DETACHED"),i})),this._reset()}get consumers(){return this._consumers}_reset(){this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._micProducer=null,this._audioSlaveProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._consumers={},this._sendTransportTimeoutTimer&&clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._sendTransport&&(this._sendTransport.close(),this.getIceStatus("send")),this._sendTransport=null,this._recvTransport&&(this._recvTransport.close(),this.getIceStatus("recv")),this._recvTransport=null,this.resetConsumeRequestStatus()}async init(){this.logger.log("init() 初始化 devices、transport"),this._mediasoupDevice||(this._mediasoupDevice=new p.Device,this._mediasoupDevice&&await this._mediasoupDevice.load({routerRtpCapabilities:this._edgeRtpCapabilities}));let e=[],t="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach((t=>{e.push({urls:"turn:"+t+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+t+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})})),u.IS_FIREFOX||(t="relay")),e.length&&this.logger.log("iceTransportPolicy ",t," iceServers ",v.JSONBigStringify(e)),!this._sendTransport&&this._mediasoupDevice&&(this._sendTransport=this._mediasoupDevice.createSendTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),this.senderEncodingParameter={ssrcList:[],audioSlave:{high:null,low:null},audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this._sendTransport.on("connectionstatechange",this._sendTransportConnectionstatechange.bind(this,this._sendTransport)),this._sendTransport.handler._pc.addEventListener("iceconnectionstatechange",(()=>{this.getIceStatus("send")}))),!this._recvTransport&&this._mediasoupDevice){const i=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,iceTransportPolicy:t,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=i,i.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,i)),i.handler._pc.addEventListener("iceconnectionstatechange",(()=>{this.getIceStatus("recv")}))}let i=setInterval((()=>{const e=Date.now();e-this.iceStatusHistory.send.status.ts>1500&&this.getIceStatus("send"),e-this.iceStatusHistory.recv.status.ts>1500&&this.getIceStatus("recv"),this._mediasoupDevice||clearInterval(i)}),1e3);this.emit("transportReady")}async _sendTransportConnectionstatechange(e,t){if(this._sendTransport&&!this._sendTransport.closed)if(this._sendTransport.idx===e.idx)if(this.loggerSend.log(`send connection #${e._handler._pc.pcid} state  changed to ${t}`),this.emit("upstream-state-change",{connectionState:t}),"failed"===t)try{this._sendTransport&&(this._sendTransportTimeoutTimer||(this._sendTransportTimeoutTimer=setTimeout((()=>{this._reconnectTransportConnectTimeout()}),this._timeout))),this._sendTransportConnectTimeout()}catch(e){this.loggerSend.error("reconnectSendTransportConnect() | failed:",e.name,e.message)}else"connected"===t&&this._sendTransportTimeoutTimer&&(clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null);else this.loggerSend.warn(`_sendTransportConnectionstatechange：出现了_sendTransport绑定不一致的状况:${e.id}/${e.idx}=>${this._sendTransport.id}/${this._sendTransport.idx}`)}async _recvTransportConnectionstatechange(e,t){if(this._recvTransport&&!this._recvTransport.closed)if(this._recvTransport.idx===e.idx)if(this.loggerRecv.log(`recv connection ${e._handler._pc.pcid} state changed to ${t}`),this.emit("downstream-state-change",{connectionState:t}),"failed"===t){try{this._recvTransport&&(this._recvTransportTimeoutTimer||(this._recvTransportTimeoutTimer=setTimeout((()=>{this._reconnectTransportConnectTimeout()}),this._timeout)))}catch(e){this.loggerRecv.error("reconnectRecvTransportConnect() | failed:",e.name,e.message)}this._recvTransportConnectTimeout()}else"connected"===t&&this._recvTransportTimeoutTimer&&(clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null);else this.loggerRecv.warn(`_recvTransportConnectionstatechange：出现了_recvTransport绑定不一致的状况:${e.id}/${e.idx}=>${this._recvTransport.id}/${this._recvTransport.idx}`)}async _sendTransportConnectTimeout(){this.loggerSend.warn("媒体上行传输通道连接失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerSend.log("媒体上行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"sendPeerIceFailed",ext:""}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体上行传输通道建立失败, 此时sdk正在重连, 不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pushStreamException",value:"send transport connection failed"})))}async _recvTransportConnectTimeout(){this.loggerRecv.warn("媒体下行传输通道建立失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerRecv.error("媒体下行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"recvPeerIceFailed",ext:""}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体下行传输通道建立失败，此时sdk正在重连，不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pullStreamException",value:"receive transport connection failed"})))}async _reconnectTransportConnectTimeout(){this.loggerRecv.error("媒体传输通道一直重连失败，主动退出房间"),this.adapterRef.instance.safeEmit("error","MEDIA_TRANSPORT_DISCONNECT"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=c.default.MEDIA_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave()}async createProduce(e,t){var i,r,s,a,n;if(e.logger.log("发布音视频: ",e.getId(),t),!this._sendTransport)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 发送端 transport 未找到 1"});if(0===this._sendTransport.listenerCount("produce")&&this._sendTransport.on("produce",(async({kind:t,rtpParameters:i,appData:r,localDtlsParameters:s,offer:a},n,o)=>{if(this.loggerSend.log(`produce 反馈 [kind= ${t}, appData= ${v.JSONBigStringify(r)}]`),!this._sendTransport)return;const d="screenShare"==r.mediaType?"screen":r.mediaType;let h=!1;("video"===d&&this.adapterRef.channelInfo.videoLow||"screen"===d&&this.adapterRef.channelInfo.screenLow)&&(h=!0);const p=a.sdp.match(/a=ice-ufrag:([0-9a-zA-Z#=+-_\/\\\\]+)/);p||this.adapterRef.logger.error("找不到 iceUfragRegLocal: ",a.sdp);try{this.adapterRef.preferRemb&&(this.logger.log("使用REMB作为带宽估计方式"),y.filterTransportCCFromRtpParameters(i));let o,f,g,_,S=Object.assign({requestId:""+Math.ceil(1e9*Math.random()),kind:t,rtpParameters:i,iceUfrag:p[1],externData:{producerInfo:{mediaType:"audioSlave"===r.mediaType?"subAudio":r.mediaType,subStream:"screenShare"===r.mediaType||"audioSlave"===r.mediaType,simulcastEnable:h,spatialLayerCount:h?2:1,mute:e.muteStatus[d].send||!1}},appData:{enableTcpCandidate:!0}},r);if("screen"===d?S.deviceId="screen-share-default":"video"===d&&(e.mediaHelper.video.videoSource?S.deviceId="video-external-default":S.deviceId="video-default"),m.getParameters().revertSubstreamProduceType)switch(S.externData.producerInfo.mediaType){case"screenShare":S.externData.producerInfo.mediaType="video",S.externData.producerInfo.subStream=!1;break;case"video":S.externData.producerInfo.mediaType="screenShare",S.externData.producerInfo.subStream=!0;break;case"audio":S.externData.producerInfo.mediaType="subAudio",S.externData.producerInfo.subStream=!0;break;case"subAudio":S.externData.producerInfo.mediaType="audio",S.externData.producerInfo.subStream=!1}if(u.ANY_CHROME_MAJOR_VERSION&&u.ANY_CHROME_MAJOR_VERSION>=58&&u.ANY_CHROME_MAJOR_VERSION<69)o=i.encodings[0];else{if(o=this.senderEncodingParameter[d].high,f=this.senderEncodingParameter[d].low,g=a.sdp.indexOf(r.deviceId),_=a.sdp.indexOf(r.deviceIdLow),!o){if(i.encodings&&(o=i.encodings[0],o&&this.senderEncodingParameter.ssrcList.indexOf(o.ssrc)>-1&&(o=null),i.encodings[1]&&(f=i.encodings[1],f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(o=null))),!o&&r.deviceId&&g>-1){const e=a.sdp.substring(g).match(/a=ssrc-group:FID (\d+) (\d+)/);if(e&&(o={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),o&&this.senderEncodingParameter.ssrcList.indexOf(o.ssrc)>-1&&(o=null),!f&&r.deviceIdLow&&_>-1){const e=a.sdp.substring(_).match(/a=ssrc-group:FID (\d+) (\d+)/);e&&(f={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(f=null)}}o||(this.loggerSend.log("使用sdp中第一个ssrc"),o={ssrc:parseInt(a.sdp.match(/a=ssrc:(\d+)/)[1]),dtx:!1}),this.senderEncodingParameter[d].high=o,this.senderEncodingParameter.ssrcList.push(o.ssrc),f?(this.senderEncodingParameter[d].low=f,this.senderEncodingParameter.ssrcList.push(f.ssrc)):this.senderEncodingParameter[d].low=null}i.encodings=[this.senderEncodingParameter[d].high],this.senderEncodingParameter[d].low&&i.encodings.unshift(this.senderEncodingParameter[d].low)}"video"!==r.mediaType&&"screenShare"!==r.mediaType||(S.mediaProfile=[],f&&S.mediaProfile.push({ssrc:f.ssrc,res:"160*160",fps:"1",spatialLayer:0,maxBitrate:100}),S.mediaProfile.push({ssrc:o.ssrc,res:"640*480",fps:"15",spatialLayer:S.mediaProfile.length,maxBitrate:1e3}));for(let e=S.rtpParameters.codecs.length-1;e>=0;e--)"audio/red"===S.rtpParameters.codecs[e].mimeType&&S.rtpParameters.codecs.splice(e,1);if(void 0===s?S.transportId=this._sendTransport.id:S.dtlsParameters=s,!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: _protoo 未找到"});let R=S.rtpParameters;const b=R.codecs[0];m.getParameters().h264ProfileLevel&&m.getParameters().h264ProfileLevelSignal&&"video/H264"===b.mimeType&&b.parameters&&b.parameters["profile-level-id"]!==m.getParameters().h264ProfileLevelSignal&&(R=JSON.parse(JSON.stringify(R)),this.logger.log(`信令消息修改profile-level-id, ${R.codecs[0].parameters["profile-level-id"]} => ${m.getParameters().h264ProfileLevelSignal}`),R.codecs[0].parameters["profile-level-id"]=m.getParameters().h264ProfileLevelSignal,S.rtpParameters=R);let E=await this.adapterRef._signalling._protoo.request("Produce",S);const{code:T,transportId:A,iceParameters:w,iceCandidates:I,turnParameters:C,dtlsParameters:O,producerId:k,errMsg:P}=E;if(void 0!==A&&(this._sendTransport._id=A),200===T?this.loggerSend.log(`produce请求反馈结果, code: ${T}, kind: ${t}, producerId: ${k}`):this.loggerSend.error(`produce请求反馈错误, code: ${T}, kind: ${t}, producerId: ${k},  errMsg: ${P}, 请求：${v.JSONBigStringify(S)}, 返回：${v.JSONBigStringify(S)}`),C){let e=[];e.push({urls:"turn:"+C.ip+":"+C.port+"?transport=udp",credential:C.password,username:C.username},{urls:"turn:"+C.ip+":"+C.port+"?transport=tcp",credential:C.password,username:C.username}),await this._sendTransport.updateIceServers({iceServers:e})}let x={codecParam:null,codecName:null};if("audio"===r.mediaType?this._micProducerId=k:"audioSlave"===r.mediaType?this._audioSlaveProducerId=k:"video"===r.mediaType?(this._webcamProducerId=k,x=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video),this._webcamProducerCodec=x.codecName):"screenShare"===r.mediaType&&(this._screenProducerId=k,x=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video),this._screenProducerCodec=x.codecName),w&&(this._sendTransportIceParameters=w),!this.adapterRef.localStream)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createProduce: 未找到 localStream"});let M=[];if("audio"===r.mediaType||"audioSlave"===r.mediaType)M.push(Object.assign({},m.getParameters().codecOptions.audio));else if("video"===r.mediaType){if(i.encodings.length>=2){const e={};m.getParameters().videoLowStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().videoLowStartBitrate),m.getParameters().videoLowMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().videoLowMinBitrate),M.push(e)}const e={};m.getParameters().videoHighStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().videoHighStartBitrate),m.getParameters().videoHighMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().videoHighMinBitrate),M.push(e)}else if("screenShare"===r.mediaType){if(i.encodings.length>=2){const e={};m.getParameters().screenLowStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().screenLowStartBitrate),m.getParameters().screenLowMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().screenLowMinBitrate),M.push(e)}const e={};m.getParameters().screenHighStartBitrate&&(e.videoGoogleStartBitrate=m.getParameters().screenHighStartBitrate),m.getParameters().screenHighMinBitrate&&(e.videoGoogleMinBitrate=m.getParameters().screenHighMinBitrate),M.push(e)}this.logger.log(`codecOptions for producer ${r.mediaType}: ${v.JSONBigStringify(M)}`);let D=I;this.adapterRef.channelInfo.iceProtocol&&I&&(this.logger.warn("Produce iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),D=I.filter((e=>e.protocol==this.adapterRef.channelInfo.iceProtocol))),await this._sendTransport.fillRemoteRecvSdp({kind:t,appData:r,iceParameters:w,iceCandidates:D,dtlsParameters:O,sctpParameters:void 0,sendingRtpParameters:i,codecOptions:M,offer:a,codec:x.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),u.ANY_CHROME_MAJOR_VERSION&&u.ANY_CHROME_MAJOR_VERSION>=58&&u.ANY_CHROME_MAJOR_VERSION<69||"video"!==d&&"screen"!==d||(this.adapterRef.localStream.applyEncoderConfig(d,"high"),i.encodings.length>=2&&this.adapterRef.localStream.applyEncoderConfig(d,"low")),n({id:k})}catch(e){o(e)}})),"audio"===t||"all"===t)if(this._micProducer)this.loggerSend.log("音频已经publish，跳过");else{const t=e.mediaHelper.audio.audioStream.getAudioTracks()[0];if(t)if(!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.pubAudioRight))this.loggerSend.error("permKey权限控制，没有权利发布audio"),this.adapterRef.instance.safeEmit("error","no-publish-audio-permission");else if("ended"===t.readyState)this.loggerSend.error("发布媒体流失败，轨道已关闭，请检查输入设备:audio",t);else{this.loggerSend.log("发布音频流 audioTrack: ",t.id,t.label),e.pubStatus.audio.audio=!0;try{this._micProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:null,mediaType:"audio"}})}catch(e){this.loggerSend.error("produce audio error: ",e)}this.watchProducerState(this._micProducer,"_micProducer"),this.adapterRef.encryption.encodedInsertableStreams&&this._micProducer._rtpSender&&this.enableSendTransform(this._micProducer._rtpSender,"audio","high")}}if("audioSlave"===t||"all"===t)if(this._audioSlaveProducer)this.loggerSend.log("音频辅流已经publish，忽略");else{const t=e.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0];t&&(!1===(null===(r=this.adapterRef.permKeyInfo)||void 0===r?void 0:r.pubAudioRight)?(this.loggerSend.error("permKey权限控制，没有权利发布audio slave"),this.adapterRef.instance.safeEmit("error","no-publish-audio-slave-permission")):"ended"===t.readyState?this.loggerSend.error("发布媒体流失败，轨道已关闭，请检查输入设备:audioSlave",t):(this.loggerSend.log("发布音频辅流 audioSlaveTrack: ",t.id,t.label),e.pubStatus.audioSlave.audio=!0,this._audioSlaveProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:null,mediaType:"audioSlave"}}),this.watchProducerState(this._audioSlaveProducer,"_audioSlaveProducer")))}if("video"===t||"all"===t)if(this._webcamProducer)this.loggerSend.log("视频已经publish，跳过");else if(e.mediaHelper.video.videoStream.getVideoTracks().length){const t=e.mediaHelper.video.videoStream.getVideoTracks()[0];if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.pubVideoRight))this.loggerSend.error("permKey权限控制，没有权利发布video"),this.adapterRef.instance.safeEmit("error","no-publish-video-permission");else if("ended"===t.readyState)this.loggerSend.error("发布媒体流失败，轨道已关闭，请检查输入设备：video",t);else{let i=null;this.adapterRef.channelInfo.videoLow?(e.mediaHelper.video.low||(e.mediaHelper.video.low=new f.VideoTrackLow({logger:this.logger,mediaType:"video"})),e.mediaHelper.video.low.track?(i=e.mediaHelper.video.low.track,this.adapterRef.instance.safeEmit("track-low-init-success",{mediaType:"video"})):this.adapterRef.instance.safeEmit("track-low-init-fail",{mediaType:"video"})):(e.mediaHelper.video.low&&e.mediaHelper.video.low.bindSender(null,null),this.senderEncodingParameter.video.low=null),this.loggerSend.log("发布视频 videoTrack: ",t.id,t.label),e.pubStatus.video.video=!0;const r=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video);this._webcamProducer=await this._sendTransport.produce({track:t,trackLow:i,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:(null==i?void 0:i.id)||null,mediaType:"video"}}),this._webcamProducer._rtpSender&&e.mediaHelper.video.low&&(e.mediaHelper.video.low.bindSender(this._webcamProducer._rtpSender,this._webcamProducer._rtpSenderLow||null),g.IS_SAFARI&&g.SAFARI_MAJOR_VERSION&&g.SAFARI_MAJOR_VERSION<14&&(null===(a=e._play.video.dom)||void 0===a?void 0:a.srcObject)&&(this.logger.log("尝试重置本地视图的SrcObject"),e._play.video.dom.srcObject=e._play.video.dom.srcObject)),this.watchProducerState(this._webcamProducer,"_webcamProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._webcamProducer._rtpSender&&this.enableSendTransform(this._webcamProducer._rtpSender,"video","high"),this._webcamProducer._rtpSenderLow&&this.enableSendTransform(this._webcamProducer._rtpSenderLow,"video","low")),this.adapterRef.state.startPubVideoTime||(this.adapterRef.state.startPubVideoTime=Date.now())}}if("screen"===t||"all"===t)if(this._screenProducer)this.loggerSend.log("屏幕共享已经publish，跳过");else if(e.mediaHelper.screen.screenVideoStream.getVideoTracks().length){const t=e.mediaHelper.screen.screenVideoStream.getVideoTracks()[0];if(!1===(null===(n=this.adapterRef.permKeyInfo)||void 0===n?void 0:n.pubVideoRight))this.loggerSend.error("permKey权限控制，没有权利发布screen"),this.adapterRef.instance.safeEmit("error","no-publish-screen-permission");else if("ended"===t.readyState)this.loggerSend.error("发布媒体流失败，轨道已关闭，请检查输入设备:screen",t);else{let i=null;this.adapterRef.channelInfo.screenLow?(e.mediaHelper.screen.low||(e.mediaHelper.screen.low=new f.VideoTrackLow({logger:e.logger,mediaType:"screen"})),e.mediaHelper.screen.low.track?(i=e.mediaHelper.screen.low.track,this.adapterRef.instance.safeEmit("track-low-init-success",{mediaType:"screen"})):this.adapterRef.instance.safeEmit("track-low-init-fail",{mediaType:"screen"})):(e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(null,null),this.senderEncodingParameter.screen.low=null),this.loggerSend.log("发布屏幕共享 screenTrack: ",t.id,t.label),e.pubStatus.screen.screen=!0;const r=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video);this._screenProducer=await this._sendTransport.produce({track:t,trackLow:i,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{preferRemb:this.adapterRef.preferRemb,deviceId:t.id,deviceIdLow:(null==i?void 0:i.id)||null,mediaType:"screenShare"}}),this._screenProducer._rtpSender&&e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(this._screenProducer._rtpSender,this._screenProducer._rtpSenderLow||null),this.watchProducerState(this._screenProducer,"_screenProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._screenProducer._rtpSender&&this.enableSendTransform(this._screenProducer._rtpSender,"screen","high"),this._screenProducer._rtpSenderLow&&this.enableSendTransform(this._screenProducer._rtpSenderLow,"screen","low")),this.adapterRef.state.startPubScreenTime||(this.adapterRef.state.startPubScreenTime=Date.now())}}}enableSendTransform(e,t,i){var r;const s=null===(r=this._sendTransport)||void 0===r?void 0:r.send.find((t=>t.sender===e));if(s)if(s.encodedStreams)this.loggerRecv.log(`发送端自定义加密，复用之前的通道。 ${s.mediaType} ${s.streamType}`);else{const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleUpstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`发送端自定义加密，成功启动。 ${s.mediaType} ${s.streamType}`)}else this.loggerRecv.error("enableSendTransform() 未找到匹配的Sender",t,i)}enableRecvTransform(e,t,i){var r;const s=null===(r=this._recvTransport)||void 0===r?void 0:r.recv.find((t=>t.receiver===e));if(s)if(s.encodedStreams)this.loggerRecv.log(`接收端自定义解密，复用之前的通道。uid:${s.uid}, mediaType: ${s.mediaType}`);else{const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleDownstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`接收端自定义解密，成功启动。uid:${s.uid}, mediaType: ${s.mediaType}`)}else this.loggerRecv.error("enableRecvTransform() 未找到匹配的Receiver",t,i)}watchProducerState(e,t){var i;if(null===(i=e.rtpSender)||void 0===i?void 0:i.transport){const i=e.rtpSender.transport;"failed"===i.state?this.logger.error(`Producer state ${t} ${i.state}`):(this.logger.log(`Producer state ${t} ${i.state}`),e.rtpSender.transport.addEventListener("statechange",(()=>{switch(i.state){case"failed":this.logger.error(`Producer state changed: ${t} ${i.state}`);break;case"connected":case"new":case"connecting":this.logger.log(`Producer state changed: ${t} ${i.state}`)}})))}else this.logger.log("Producer state: transport is null")}async destroyProduce(e){var t;let i=null,r=null;if(!this.adapterRef.localStream)throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:`destroyProduce.${e}: 未找到 localStream`});"audio"===e?(i=this._micProducer,r=this._micProducerId,this._micProducer=this._micProducerId=null,this.adapterRef.localStream.pubStatus.audio.audio=!1):"audioSlave"===e?(i=this._audioSlaveProducer,r=this._audioSlaveProducerId,this._audioSlaveProducer=this._audioSlaveProducerId=null,this.adapterRef.localStream.pubStatus.audioSlave.audio=!1):"video"===e?(i=this._webcamProducer,r=this._webcamProducerId,this._webcamProducer=this._webcamProducerId=null,this.adapterRef.localStream.pubStatus.video.video=!1):"screen"===e&&(i=this._screenProducer,r=this._screenProducerId,this._screenProducer=this._screenProducerId=null,this.adapterRef.localStream.pubStatus.screen.screen=!1);try{if(this.loggerSend.log(`停止发布 destroyProduce ${e} producerId=`,r),!i)return;i.close(),(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)?this.adapterRef._signalling._protoo.request("CloseProducer",{requestId:""+Math.ceil(1e9*Math.random()),producerId:r}).catch((e=>{this.logger.error("CloseProducer Failed: ",e.name,e.message)})):this.logger.warn("destroyProduce: 当前信令中断, 不发信令包",e,r)}catch(e){this.loggerSend.error("destroyProduce failed: ",e.name,e.message)}}async createConsumer(e,t,i,r,s=0){this.adapterRef.instance.safeEmit("@pairing-createConsumer-start");let a=!1;if(this._eventQueue.forEach((t=>{if(t.id===r)return this.loggerRecv.log(`[subscribe] 已经在订阅任务队列中，忽略该次请求, uid: ${e}, mediaType: ${i}, producerId: ${r}`),void(a=!0)})),!a)return new Promise(((a,n)=>{this._eventQueue.push({uid:e,kind:t,id:r,mediaType:i,preferredSpatialLayer:s,resolve:a,reject:n}),this._eventQueue.length>1?this._eventQueueData=Object.assign([],this._eventQueue):this._createConsumer(this._eventQueue[0])}))}async setConsumerPreferredLayer(e,t,i){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"setConsumerPreferredLayer: _protoo 未找到"});return this.loggerSend.log("setConsumerPreferredLayer() [切换大小流]layer: ",t,1===t?"大流":"小流",i),await this.adapterRef._signalling._protoo.request("SetConsumerPreferredLayer",{requestId:""+Math.ceil(1e9*Math.random()),uid:new _.SimpleBig(e.streamID),producerId:e.pubStatus[i].producerId,consumerId:e.pubStatus[i].consumerId,spatialLayer:t})}async resetConsumeRequestStatus(){const e=this._eventQueue;this._eventQueue=[];for(let t=0;t<e.length;t++){const i=e[t];this.loggerRecv.log(`resetConsumeRequestStatus：uid ${i.uid}, uid ${i.uid}, kind ${i.kind}, id ${i.id}`),i.reject("resetConsumeRequestStatus")}}removeUselessConsumeRequest(e,t){if(e)for(let i=this._eventQueue.length-1;i>=1;i--){const r=this._eventQueue[i];r.uid.toString()!==e.toString()||r.mediaType!==t&&"all"!==t||(this.loggerRecv.warn(`removeUselessConsumeRequest：uid ${r.uid}, mediaType ${r.mediaType}, id ${r.id}, i ${i}`),r.resolve(null),this._eventQueue.splice(i,1))}}checkConsumerList(e){return this._eventQueue.shift(),e.resolve(null),this.loggerRecv.log("查看事件队列, _eventQueue: ",this._eventQueue.length),this._eventQueue.forEach((e=>{this.loggerRecv.log(`consumerList, uid: ${e.uid}, kind: ${e.kind}, mediaType: ${e.mediaType}, id: ${e.id}`)})),this._eventQueue.length>0&&this._createConsumer(this._eventQueue[0]),"checkConsumerList"}async _createConsumer(e){var t,i;const{uid:r,kind:s,mediaType:a,id:n,preferredSpatialLayer:o=0}=e,d="screenShare"===a?"screen":a;if("audio"===d?this.loggerRecv.log(`[Subscribe] 开始订阅 ${r} 的 ${d} 媒体: ${n}`):this.loggerRecv.log(`[Subscribe] 开始订阅 ${r} 的 ${d} 媒体: ${n} preferredSpatialLayer: ${o} 大小流: `,1===o?"大流":"小流"),!n)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);if(this.unsupportedProducers[n])return this.loggerRecv.warn("[Subscribe] createConsumer: 跳过不支持的Producer",n,v.JSONBigStringify(this.unsupportedProducers[n])),this.checkConsumerList(e);const u=this.adapterRef.remoteStreamMap[r];if(!u||!u.pubStatus[d][d]||!u.pubStatus[d].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if(u.pubStatus[d].consumerId){this.loggerRecv.log("[Subscribe] 已经订阅过");let t=!0;if(u.Play&&(t=u._play.isPlaying(d)),t)return this.loggerRecv.log("[Subscribe] 当前播放正常，直接返回"),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if("start"!==u.pubStatus[d].stopconsumerStatus){this.loggerRecv.log("[Subscribe] 先停止之前的订阅");try{if(u.pubStatus[d].stopconsumerStatus="start",!this.adapterRef._mediasoup)return this.checkConsumerList(e);await this.destroyConsumer(u.pubStatus.audio.consumerId,null,null),this.adapterRef.instance.removeSsrc(u.getId(),d),u.pubStatus[d].consumerId="",u.stop(d),u.pubStatus[d].stopconsumerStatus="end"}catch(e){this.loggerRecv.error("[Subscribe] 停止之前的订阅出现错误: ",e.name,e.message)}}}let p=null;if("audio"!==d&&"audioSlave"!==d||(p={opusStereo:1}),this._mediasoupDevice&&this._mediasoupDevice.loaded||(this.loggerRecv.warn("[Subscribe] createConsumer：Waiting for Transport Ready"),await h.waitForEvent(this,"transportReady",3e3)),!this._recvTransport)throw this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),e.resolve(null),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"createConsumer: 接收端 transport 未找到"});this.loggerRecv.log(`[Subscribe] prepareLocalSdp [kind: ${s}, mediaTypeShort: ${d}, uid: ${r}]`),this._recvTransport.id===this.adapterRef.channelInfo.uid&&(this.loggerRecv.log("[Subscribe] transporth还没有协商, 需要dtls消息"),this._recvTransport._handler._transportReady=!1);const f=await this._recvTransport.prepareLocalSdp(s,this._edgeRtpCapabilities,r);this.adapterRef&&"DISCONNECTING"!=this.adapterRef.connectState.curState&&"DISCONNECTED"!=this.adapterRef.connectState.curState||this.checkConsumerList(e),this.loggerRecv.log("[Subscribe] 获取本地sdp, mid =",f.mid);let{rtpCapabilities:g,offer:y}=f,S=f.mid;const R=f.dtlsParameters;S="number"==typeof S&&S<0?void 0:""+S;const b=y.sdp.match(/a=ice-ufrag:([0-9a-zA-Z=#+-_\/\\\\]+)/);if(!b)throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: iceUfragRegRemote 为空"});let E={requestId:""+Math.ceil(1e9*Math.random()),kind:s,rtpCapabilities:g,uid:new _.SimpleBig(r),producerId:n,preferredSpatialLayer:o,mid:S,pause:!1,iceUfrag:b[1],audioAslFlag:"yes"===this.adapterRef.audioAsl.enabled&&m.getParameters().audioAslFlag,appData:{enableTcpCandidate:!0}};if(void 0===R?E.transportId=this._recvTransport.id:E.dtlsParameters=R,this.loggerRecv.log(`[Subscribe] 发送consume请求, uid: ${r}, kind: ${s}, mediaTypeShort: ${d}, producerId: ${E.producerId}, transportId: ${E.transportId}, requestId: ${E.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo)throw e.resolve(null),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: _protoo 未找到"});const T=this.adapterRef._signalling._protoo;let A=null;try{A=await this.adapterRef._signalling._protoo.request("Consume",E)}catch(e){throw"request timeout"===e.message&&this.adapterRef._signalling._protoo.id===T.id?(this.logger.error(`[Subscribe] Consume消息Timeout, 尝试信令重连: ${e.name}/${e.message}, 当前的连接状态: ${this.adapterRef.connectState.curState}, 原始请求: `,v.JSONBigStringify(E)),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"consumeRequestTimeout",ext:""}),this.adapterRef._signalling._reconnection()):this.logger.error(`[Subscribe] Consume消息错误: ${e.name}/${e.message}, 当前的连接状态：${this.adapterRef.connectState.curState}, 原始请求：`,v.JSONBigStringify(E)),new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:"_createConsumer: Consume 消息错误:"+e.message})}let{transportId:w,iceParameters:I,iceCandidates:C,dtlsParameters:O,probeSSrc:k,rtpParameters:P,turnParameters:x,producerId:M,consumerId:D,code:N,errMsg:L}=A;if(this.loggerRecv.log(`[Subscribe] consume反馈结果 code: ${N} uid: ${r}, mid: ${P&&P.mid}, kind: ${s}, producerId: ${M}, consumerId: ${D}, transportId: ${w}, requestId: ${A.requestId}, errMsg: ${L}`),!this._recvTransport)return this.loggerRecv.error("[Subscribe] transport undefined, 直接返回"),this.checkConsumerList(e);if(200!==N&&!(null===(i=null===(t=this._recvTransport)||void 0===t?void 0:t._handler)||void 0===i?void 0:i.remoteSdp))return this._recvTransport.recoverLocalSdp(r,"0",s),this.loggerRecv.log("[Subscribe] consume, 此外没有remoteSdp, 忽略改次失败的consume"),this.checkConsumerList(e);if(x){let e=[];e.push({urls:"turn:"+x.ip+":"+x.port+"?transport=udp",credential:x.password,username:x.username},{urls:"turn:"+x.ip+":"+x.port+"?transport=tcp",credential:x.password,username:x.username}),await this._recvTransport.updateIceServers({iceServers:e})}const F=A.uid;P&&P.encodings&&P.encodings.length&&P.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(r,d,P.encodings[0].ssrc),void 0!==w&&(this._recvTransport._id=w),void 0!==k&&(this._probeSSrc=k),I&&(this._recvTransportIceParameters=I),P&&null!=P.mid&&(P.mid=P.mid+"");let V=C;this.adapterRef.channelInfo.iceProtocol&&C&&(this.logger.warn("Consume iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),V=C.filter((e=>e.protocol==this.adapterRef.channelInfo.iceProtocol)));const j=await this._recvTransport.consume({id:D||M||n,producerId:M||n,kind:s,mediaType:d,uid:r||F,rtpParameters:P,codecOptions:p,appData:{peerId:F,remoteUid:r,mid:S},offer:y,iceParameters:I,iceCandidates:V,dtlsParameters:O,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this.adapterRef.encryption.encodedInsertableStreams&&j.rtpReceiver&&this.enableRecvTransform(j.rtpReceiver,r,d),this._consumers[j.id]=j,j.on("transportclose",(()=>{this._consumers&&delete this._consumers[j.id]})),this.loggerRecv.log("[Subscribe] 订阅consume完成 peerId =",F),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${d}_sub`,oper:"1",value:v.JSONBigStringify({remoteUid:r,result:N,reason:L||"",preferredSpatialLayer:o,consumerId:D||"",producerId:M||n},null," ")}),u&&u.pubStatus[d].producerId){if(u.subStatus[d]=!0,u.pubStatus[d][d]=!0,u.pubStatus[d].consumerId=D,u.pubStatus[d].producerId=M,u.getMuteStatus(d).muted){this.loggerRecv.log(`[Subscribe] 远端流处于mute状态：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(u.getMuteStatus(d))}`);const e=u.getMuteStatus(d);e.send&&this.loggerRecv.log(`[Subscribe] 远端流把自己mute了：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(e)}`),e.recv&&(this.loggerRecv.log(`[Subscribe] 本端把远端流mute了：uid ${u.getId()}, ${d}, ${v.JSONBigStringify(e)}`),j.track.enabled=!1)}else j.track.enabled=!0;u.mediaHelper.updateStream(d,j.track),this.adapterRef.instance.safeEmit("@pairing-createConsumer-success"),"audio"===d?this.adapterRef.state.signalAudioSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalAudioSubscribedTime=Date.now()):"video"===d&&this.adapterRef.state.signalVideoSubscribedTime<this.adapterRef.state.signalOpenTime&&(this.adapterRef.state.signalVideoSubscribedTime=Date.now()),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:u,mediaType:d})}else this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.loggerRecv.log("[Subscribe] 该次consume状态错误: ",v.JSONBigStringify(u.pubStatus,null,""));return this.checkConsumerList(e)}async destroyConsumer(e,t,i){var r,s;if(e)try{const a=this._consumers[e];if(!a)return void this.loggerRecv.log("跳过停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID);this.loggerRecv.log("停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID),delete this._consumers[e];try{await(null===(s=null===(r=this.adapterRef._signalling)||void 0===r?void 0:r._protoo)||void 0===s?void 0:s.request("CloseConsumer",{requestId:""+Math.ceil(1e9*Math.random()),consumerId:e,producerId:a.producerId})),await a.close(),t&&i&&this.adapterRef.instance.safeEmit("@stream-unsubscribed",{stream:t,mediaType:i}),this.adapterRef.instance.apiEventReport("setFunction",{name:`set_${i}_sub`,oper:"0",value:v.JSONBigStringify({remoteUid:null==t?void 0:t.stringStreamID,consumerId:e||""},null," ")})}catch(e){this.logger.error("CloseConsumer失败",e.name,e.message,e)}}catch(e){this.loggerRecv.error("destroyConsumer() | failed:",e.name,e.message,e.stack)}}async closeTransport(e){var t,i;if(e&&e.id)try{this.logger.log(`closeTransport() [停止通道 transportId= ${e.id}]`);const r=await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("CloseTransport",{requestId:""+Math.ceil(1e9*Math.random()),transportId:e.id}));this.logger.log(`closeTransport() [停止通道反馈结果 result=${v.JSONBigStringify(r,null," ")}]`),e.close()}catch(e){this.logger.error("closeTransport() | failed:",e.name,e.message)}}async muteAudio(){var e,t,i,r;this.loggerSend.log("mute音频"),null===(e=this._micProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._micProducer)||void 0===r?void 0:r.id,mute:!0}}}))}catch(e){this.loggerSend.error("muteAudio() | failed:",e.name,e.message,e)}}async unmuteAudio(){var e,t,i,r;this.loggerSend.log("unmute音频"),null===(e=this._micProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._micProducer)||void 0===r?void 0:r.id,mute:!1}}}))}catch(e){return this.loggerSend.error("unmuteAudio() | failed: ",e.name,e.message),Promise.reject(e)}}async muteAudioSlave(){var e,t,i,r;this.loggerSend.log("mute音频辅流"),null===(e=this._audioSlaveProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._audioSlaveProducer)||void 0===r?void 0:r.id,mute:!0}}}))}catch(e){this.loggerSend.error("muteAudioSlave() | failed:",e.name,e.message)}}async unmuteAudioSlave(){var e,t,i,r;this.loggerSend.log("unmute音频辅流"),null===(e=this._audioSlaveProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._audioSlaveProducer)||void 0===r?void 0:r.id,mute:!1}}}))}catch(e){return this.loggerSend.error("unmuteAudioSlave() | failed: ",e.name,e.message),Promise.reject(e)}}async muteVideo(){var e,t,i,r;this.loggerSend.log("mute视频"),null===(e=this._webcamProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._webcamProducer)||void 0===r?void 0:r.id,mute:!0}}}))}catch(e){this.loggerSend.error("muteVideo() | failed:",e.name,e.message)}}async unmuteVideo(){var e,t,i,r;this.loggerSend.log("unmute视频"),null===(e=this._webcamProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._webcamProducer)||void 0===r?void 0:r.id,mute:!1}}}))}catch(e){this.loggerSend.error("unmuteVideo() | failed:",e.name,e.message)}}async muteScreen(){var e,t,i,r;this.loggerSend.log("mute屏幕共享"),null===(e=this._screenProducer)||void 0===e||e.pause();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._screenProducer)||void 0===r?void 0:r.id,mute:!0}}}))}catch(e){this.loggerSend.error("muteScreen() | failed: ",e.name,e.message)}}async unmuteScreen(){var e,t,i,r;this.loggerSend.log("unmute屏幕共享"),null===(e=this._screenProducer)||void 0===e||e.resume();try{await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{producerId:null===(r=this._screenProducer)||void 0===r?void 0:r.id,mute:!1}}}))}catch(e){this.loggerSend.error("unmuteScreen() | failed:",e.name,e.message)}}async updateUserRole(e){var t,i;this.loggerSend.log("updateUserRole() 更新用户角色为"+e);try{const r=await(null===(i=null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)||void 0===i?void 0:i.request("SendUserData",{externData:{type:"UserRole",cid:this.adapterRef.channelInfo.cid,uid:new _.SimpleBig(this.adapterRef.channelInfo.uid),data:{userRole:e}}}));return 200!==r&&this.logger.error(`UpdateUserRole:${r.errMsg}. Code: ${r.code}`),r}catch(e){throw this.loggerSend.error("updateUserRole() failed:",e.name,e.message),e}}async getIceStatus(e="send"){var t,i,r,s;const a=Date.now(),n={ts:Date.now(),direction:e,iceConnectionState:"uninit",info:"",stuckTime:-1,elapse:-1};let o;if(o="send"===e?null===(i=null===(t=this._sendTransport)||void 0===t?void 0:t._handler)||void 0===i?void 0:i._pc:null===(s=null===(r=this._recvTransport)||void 0===r?void 0:r._handler)||void 0===s?void 0:s._pc,o){if(n.info+="#"+o.pcid,n.iceConnectionState=o.iceConnectionState,n.info+="|iceConnectoinState "+o.iceConnectionState,o.iceStartedAt&&(n.elapse=a-o.iceStartedAt),this.iceStatusHistory[e].promises[0]&&(this.iceStatusHistory[e].promises[0](null),this.iceStatusHistory[e].promises=[]),"checking"===o.iceConnectionState){if(o.iceStartedAt||(o.iceStartedAt=a),await new Promise((t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,3e3)})),"checking"!==o.iceConnectionState)return n;n.elapse=Date.now()-o.iceStartedAt}"connected"!==o.iceConnectionState&&"completed"!==o.iceConnectionState||(o.iceConnectedAt||(o.iceConnectedAt=a),await new Promise((t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,100)})));let t=null;try{let i=Date.now(),r=null;if("send"===e){let e=o.getSenders()[0];(null==e?void 0:e.track)&&(r=e.track)}else{let e=o.getReceivers()[0];(null==e?void 0:e.track)&&(r=e.track)}let s=o.getStats(r);n.stuckTime=Date.now()-i,t=await s}catch(e){}const i=[],r=[];let s=Date.now();t&&t.forEach(((e,t)=>{i.push(e),"transport"===e.type&&r.push(e)})),r.length||(n.info+="|no transport stats"),r.forEach((e=>{var t,r;const s=i.find((t=>t.id===e.selectedCandidatePairId));if(s){const e=i.find((e=>e.id===s.localCandidateId));e?(n.info+=`|local:${e.protocol} `,n.info+=`${e.address||"NOADDRESS"}:${e.port||"NOPORT"} ${e.candidateType} ${e.networkType||""}`,n.networkType=e.networkType,n.protocol=e.protocol,n.relayProtocol=e.relayProtocol,n.ip=e.ip,n.address=e.address,"unsupported"===(null===(r=null===(t=this.adapterRef._statsReport)||void 0===t?void 0:t.stats)||void 0===r?void 0:r.chromeLegecy)&&(this.adapterRef.transportStats.NetworkType=e.networkType)):n.info+="|无法找到localCandidate "+s.localCandidateId;const a=i.find((e=>e.id===s.remoteCandidateId));a?(n.info+=`|remote:${a.protocol} `,n.info+=`${a.address||"NOADDRESS"}:${a.port||"NOPORT"} ${a.candidateType}`):n.info+="|无法找到remoteCandidate "+s.remoteCandidateId}else n.info+="无法找到candidatePair "+e.selectedCandidatePairId})),n.stuckTime+=Date.now()-s}else n.info="no_pc_"+e;if(this.iceStatusHistory[e].status.info!==n.info&&"new"!==n.iceConnectionState&&this._mediasoupDevice){const t={new:1,checking:2,connected:3,completed:4,failed:-1,disconnected:-2,closed:-3},i=t[n.iceConnectionState||0]||0;i>0?(this.adapterRef.logger.log("iceConnectionStateChanged",e,n.info),i===t.connected&&"recv"===e&&this.adapterRef.state.iceRecvConnectedTime<this.adapterRef.state.signalJoinResTime&&(this.adapterRef.state.iceRecvConnectedTime=Date.now())):this.adapterRef.logger.warn("iceConnectionStateChanged",e,n.info),this.adapterRef.instance.apiFrequencyControl({name:"_iceStateChange_"+e,code:i,param:v.JSONBigStringify(n)}),this.adapterRef.instance.safeEmit("@ice-change",n)}return this.iceStatusHistory[e].status=n,n}getReceivers(e={}){const t=[];for(let i in this.adapterRef.remoteStreamMap){const r=this.adapterRef.remoteStreamMap[i];e.uid&&e.uid.toString()!==i||d.MediaTypeList.forEach((s=>{if(e.mediaType&&e.mediaType!==s)return;if(!r.active||!r.pubStatus[s].consumerId)return;const a=this._consumers[r.pubStatus[s].consumerId];a&&t.push({uid:i,mediaType:s,remoteStream:r,consumer:a})}))}return t}destroy(){this.logger.log("清除 meidasoup"),this._reset()}}t.Mediasoup=R},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.waitForEvent=void 0,t.waitForEvent=async function(e,t,i){return new Promise(((r,s)=>{let a;const n=e=>{a&&clearTimeout(a),r(e)};i&&(a=setTimeout((()=>{e.removeListener(t,n),s(`timed out after ${i}ms:${t}`)}),i)),e.once(t,n)}))}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome74=void 0;const o=a(i(70)),d=n(i(12)),c=n(i(13)),l=i(60),u=i(2),h=i(38),p=a(i(122)),m=a(i(61)),f=i(129),g=a(i(130)),v=i(143),_=a(i(153)),y=i(131),S=i(144),R=i(154),b="Chrome_",E={OS:1024,MIS:1024};let T=0;class A extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new A}get name(){return"Chrome74"}get remoteSdp(){return this._remoteSdp}close(){if(h.Logger.debug(b,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){return R.getNativeRtpCapabilities()}async getNativeSctpCapabilities(){return h.Logger.debug(b,"getNativeSctpCapabilities()"),{numStreams:E}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(b,"run()"),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(b,"iceServers: ",a);const u={iceServers:a||[],iceTransportPolicy:n||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=T++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.warn("onicecandidateerror: ",e)}}async updateIceServers(e){h.Logger.debug(b,"updateIceServers(): ");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.Logger.debug(b,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=o.parse(e.sdp);t.media.forEach((e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),e.sdp=o.write(t),h.Logger.debug(b,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(b,"restartIce() | calling pc.setRemoteDescription() [answer]"),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(b,"restartIce() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(b,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(b,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&i.forEach(((e,t)=>{e.rid="r"+t}));const n=m.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=l.reduceCodecs(n.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(b,"audioSender 更新 track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"audioSlave"===a.mediaType&&this._pc.audioSlaveSender?(h.Logger.debug(b,"audioSlaveSender 更新 track: ",this._pc.audioSlaveSender.track,"=>",e),this._pc.audioSlaveSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(b,"videoSender 更新 track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(b,"videoSenderLow 更新 track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(b,"screenSender 更新 track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(b,"screenSenderLow 更新 track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f]}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream]})),"audio"!==a.mediaType||this._pc.audioSender?"audioSlave"!==a.mediaType||this._pc.audioSlaveSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSlaveSender=u.sender:this._pc.audioSender=u.sender),h.Logger.debug(b,`send() | [transceivers: ${this._pc.getTransceivers().length}]`);let v,S,R,E=await this._pc.createOffer(),T=o.parse(E.sdp);a.preferRemb&&y.filterTransportCCFromSdp(T);const A=T.media.filter((i=>{const r=this._mapMidTransceiver.get(""+i.mid);return!(i.type!==e.kind||r&&r.sender&&r.sender.track&&(r.sender.track.id===e.id?(v=i,1):t&&r.sender.track.id===t.id&&(S=i,1)))}));v||(v=A.pop()),t&&!S&&(S=A.pop()),this._transportReady||(R=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let w=null==v?void 0:v.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.send: localId 未找到"});let I=null;if(S&&(I=""+S.mid),n.mid=w,n.rtcp.cname=g.getCname({offerMediaObject:v}),i)if(1===i.length){let e=_.getRtpEncodings({offerMediaObject:v});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i;else n.encodings=[],S&&(n.encodings=n.encodings.concat(_.getRtpEncodings({offerMediaObject:S}))),n.encodings=n.encodings.concat(_.getRtpEncodings({offerMediaObject:v}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||"video/h264"===n.codecs[0].mimeType.toLowerCase())&&T.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),E.sdp=o.write(T),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,p),{localId:w,localIdLow:I,rtpParameters:n,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:R,offer:E}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:n,offer:d,audioProfile:c,codec:p}){h.Logger.debug(b,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const f=m.clone(this._sendingRemoteRtpParametersByKind[e]);f.codecs=l.reduceCodecs(f.codecs,p);let g=o.parse(this._pc.localDescription.sdp);const _=this._remoteSdp.getNextMediaSectionIdx();let y=g.media[_.idx],S=null;a.encodings&&a.encodings.length>1&&(S=g.media[_.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[y,S],reuseMid:_.reuseMid,offerRtpParameters:a,answerRtpParameters:f,codecOptions:n,extmapAllowMixed:!0});const R={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(b,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}R.sdp.indexOf("a=fmtp:111")&&(R.sdp=R.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),R.sdp=R.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}h.Logger.debug(b,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),u.getParameters().enableUdpCandidate||(R.sdp=R.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(R.sdp=R.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(R)}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(b,`stopSending() [kind: ${t}, localId: ${e}]`);const i=this._mapMidTransceiver.get(e);"audio"===t?this._pc.audioSender.replaceTrack(null):"audioSlave"===t?this._pc.audioSlaveSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):null==i||i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=o.parse(r.sdp);s.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),r.sdp=o.write(s),h.Logger.debug(b,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r)}catch(e){h.Logger.debug(b,"setLocalDescription error: ",e.message)}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(b,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(b,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(b,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t))}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(b,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e),r=null==i?void 0:i.sender.getParameters();r.encodings.forEach(((e,i)=>{e.active=i<=t})),await(null==i?void 0:i.sender.setParameters(r))}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(b,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)return;const r=i.sender.getParameters();r.encodings.forEach(((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)})),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(b,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(b,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){h.Logger.debug(b,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i,r=-1;if(u.getParameters().reuseMid)for(const t of this._mapMidTransceiver.keys()){const i=this._mapMidTransceiver.get(t);if(!i)continue;const s=i.receiver&&i.receiver.track&&i.receiver.track.kind||e;if(i.isUseless&&s===e){r=t-0,i.isUseless=!1;break}}let s=null;if(-1===r){if(h.Logger.debug(b,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),i=await this._pc.createOffer(),!i.sdp)throw h.Logger.error(b,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");i.sdp.indexOf("a=rtcp-fb:111")&&-1===i.sdp.indexOf("a=rtcp-fb:111 nack")&&(i.sdp=i.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")),i.sdp.indexOf("a=fmtp:111")&&(i.sdp=i.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"))}else if(this._pc.localDescription)i={type:"offer",sdp:this._pc.localDescription.sdp};else{if(i=await this._pc.createOffer(),!i.sdp)throw h.Logger.error(b,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");i.sdp.indexOf("a=rtcp-fb:111")&&-1===i.sdp.indexOf("a=rtcp-fb:111 nack")&&(i.sdp=i.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")),i.sdp.indexOf("a=fmtp:111")&&(i.sdp=i.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=o.parse(i.sdp);r=e.media[e.media.length-1].mid}if(!i.sdp)throw h.Logger.error(b,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");const a=o.parse(i.sdp);let n;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return S.addNackSuppportForOpus(d),-1===r&&(r=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+r,s)),{dtlsParameters:n,rtpCapabilities:d,offer:i,mid:r,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:n,offer:o,probeSSrc:d=-1,remoteUid:c,extendedRtpCapabilities:l,appData:p}){this._assertRecvDirection(),h.Logger.debug(b,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${c}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let m=n&&n.mid||p.mid;if(h.Logger.debug(b,"[Subscribe] receive() mid: "+m),null==n?void 0:n.mid)this._remoteSdp.receive({mid:m,kind:a,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s});else{h.Logger.debug(b,"[Subscribe] receive() 容错流程");const e=[];l.codecs.forEach((t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}}));const t={mid:m,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:m},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+m)}if(!o.sdp)throw h.Logger.error(b,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");o.sdp.indexOf("a=fmtp:111")&&(o.sdp=o.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const f={type:"answer",sdp:this._remoteSdp.getSdp()};f.sdp.indexOf("a=fmtp:111")&&(f.sdp=f.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),"chrome"!==u.getParameters().enableSdpRrtr&&"all"!==u.getParameters().enableSdpRrtr||(o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n"),f.sdp=f.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),f.sdp=f.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n")),u.getParameters().enableUdpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(b,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(o),h.Logger.debug(b,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(f);const g=this._pc.getTransceivers().find((e=>e.mid===m));return this._mapMidTransceiver.set(m,g),{localId:m,track:g.receiver.track,rtpReceiver:g.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(b,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.stopReceiving: RTCRtpTransceiver 未找到"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;h.Logger.debug(b,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(b,"stopReceiving() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Chrome.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=o.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Chrome74=A},function(e,t,i){var r=function(e){return String(Number(e))===e?Number(e):e},s=function(e,t,i){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var a=e.push?{}:s?t[e.name]:t;!function(e,t,i,s){if(s&&!i)t[s]=r(e[1]);else for(var a=0;a<i.length;a+=1)null!=e[a+1]&&(t[i[a]]=r(e[a+1]))}(i.match(e.reg),a,e.names,e.name),e.push&&t[e.push].push(a)},a=i(171),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var o=0;o<(a[t]||[]).length;o+=1){var d=a[t][o];if(d.reg.test(n))return s(d,r,n)}})),t.media=i,t};var o=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),s=0;s<i.length;s+=3)t.push({component:i[s],ip:i[s+1],port:i[s+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},function(e,t,i){var r=i(171),s=/%[sdv%]/g,a=function(e){var t=1,i=arguments,r=i.length;return e.replace(s,(function(e){if(t>=r)return e;var s=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}}))},n=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var n=t.names[s];t.name?r.push(i[t.name][n]):r.push(i[t.names[s]])}else r.push(i[t.name]);return a.apply(null,r)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||o,s=t.innerOrder||d,a=[];return i.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(n(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(n(t,i,e))}))}))})),e.media.forEach((function(e){a.push(n("m",r.m[0],e)),s.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(n(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(n(t,i,e))}))}))}))})),a.join("\r\n")+"\r\n"}},function(e,t,i){const r=i(226)("h264-profile-level-id");r.log=console.info.bind(console),t.ProfileConstrainedBaseline=1,t.ProfileBaseline=2,t.ProfileMain=3,t.ProfileConstrainedHigh=4,t.ProfileHigh=5,t.Level1_b=0,t.Level1=10,t.Level1_1=11,t.Level1_2=12,t.Level1_3=13,t.Level2=20,t.Level2_1=21,t.Level2_2=22,t.Level3=30,t.Level3_1=31,t.Level3_2=32,t.Level4=40,t.Level4_1=41,t.Level4_2=42,t.Level5=50,t.Level5_1=51,t.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t}}t.ProfileLevelId=s;const a=new s(1,31);class n{constructor(e){this._mask=~c("x",e),this._maskedValue=c("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}}class o{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i}}const d=[new o(66,new n("x1xx0000"),1),new o(77,new n("1xxx0000"),1),new o(88,new n("11xx0000"),1),new o(66,new n("x0xx0000"),2),new o(88,new n("10xx0000"),2),new o(77,new n("0x0x0000"),3),new o(100,new n("00000000"),5),new o(100,new n("00001100"),4)];function c(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function l(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}t.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const t=parseInt(e,16);if(0===t)return null;const i=255&t,a=t>>8&255,n=t>>16&255;let o;switch(i){case 11:o=0!=(16&a)?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:o=i;break;default:return r("parseProfileLevelId() | unrecognized level_idc:%s",i),null}for(const e of d)if(n===e.profile_idc&&e.profile_iop.isMatch(a))return new s(e.profile,o);return r("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},t.profileLevelIdToString=function(e){if(0==e.level)switch(e.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return r("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let t;switch(e.profile){case 1:t="42e0";break;case 2:t="4200";break;case 3:t="4d00";break;case 4:t="640c";break;case 5:t="6400";break;default:return r("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let i=e.level.toString(16);return 1===i.length&&(i="0"+i),`${t}${i}`},t.parseSdpProfileLevelId=function(e={}){const i=e["profile-level-id"];return i?t.parseProfileLevelId(i):a},t.isSameProfile=function(e={},i={}){const r=t.parseSdpProfileLevelId(e),s=t.parseSdpProfileLevelId(i);return Boolean(r&&s&&r.profile===s.profile)},t.generateProfileLevelIdForAnswer=function(e={},i={}){if(!e["profile-level-id"]&&!i["profile-level-id"])return r("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const a=t.parseSdpProfileLevelId(e),n=t.parseSdpProfileLevelId(i);if(!a)throw new TypeError("invalid local_profile_level_id");if(!n)throw new TypeError("invalid remote_profile_level_id");if(a.profile!==n.profile)throw new TypeError("H264 Profile mismatch");const o=l(e)&&l(i),d=a.level,c=function(e,t){return 0===e?10!==t&&0!==t:0===t?10!==e:e<t}(u=d,h=n.level)?u:h;var u,h;const p=o?d:c;return r("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",a.profile,p),t.profileLevelIdToString(new s(a.profile,p))}},function(e,t,i){(function(r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))})),t.splice(s,0,i)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=i(227)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,i(71))},function(e,t,i){e.exports=function(e){function t(e){let i,s,a,n=null;function o(...e){if(!o.enabled)return;const r=o,s=Number(new Date),a=s-(i||s);r.diff=a,r.prev=i,r.curr=s,i=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let n=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((i,s)=>{if("%%"===i)return"%";n++;const a=t.formatters[s];if("function"==typeof a){const t=e[n];i=a.call(r,t),e.splice(n,1),n--}return i})),t.formatArgs.call(r,e),(r.log||t.log).apply(r,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=r,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==n?n:(s!==t.namespaces&&(s=t.namespaces,a=t.enabled(e)),a),set:e=>{n=e}}),"function"==typeof t.init&&t.init(o),o}function r(e,i){const r=t(this.namespace+(void 0===i?":":i)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let i;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(i=0;i<s;i++)r[i]&&("-"===(e=r[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let i,r;for(i=0,r=t.skips.length;i<r;i++)if(t.skips[i].test(e))return!1;for(i=0,r=t.names.length;i<r;i++)if(t.names[i].test(e))return!0;return!1},t.humanize=i(228),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((i=>{t[i]=e[i]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var i=1e3,r=6e4,s=60*r,a=24*s;function n(e,t,i,r){var s=t>=1.5*i;return Math.round(e/i)+" "+r+(s?"s":"")}e.exports=function(e,t){t=t||{};var o=typeof e;if("string"===o&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return 6048e5*n;case"days":case"day":case"d":return n*a;case"hours":case"hour":case"hrs":case"hr":case"h":return n*s;case"minutes":case"minute":case"mins":case"min":case"m":return n*r;case"seconds":case"second":case"secs":case"sec":case"s":return n*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}(e);if("number"===o&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=a?n(e,t,a,"day"):t>=s?n(e,t,s,"hour"):t>=r?n(e,t,r,"minute"):t>=i?n(e,t,i,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=a?Math.round(e/a)+"d":t>=s?Math.round(e/s)+"h":t>=r?Math.round(e/r)+"m":t>=i?Math.round(e/i)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OfferMediaSection=t.AnswerMediaSection=t.MediaSection=void 0;const n=a(i(61));class o{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:r=!1}){if(this._mediaObject={},this._planB=r,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}i&&this.setDtlsRole(i.role)}get mid(){return String(this._mediaObject.mid)}get type(){return String(this._mediaObject.type)}get closed(){return 0===this._mediaObject.port}set mid(e){this._mediaObject.mid=e}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}function d(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}t.MediaSection=o,t.AnswerMediaSection=class extends o{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,offerMediaObject:o,offerRtpParameters:c,answerRtpParameters:l,codecOptions:u,extmapAllowMixed:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i=n.clone(e.parameters,{});if(u){const{opusStereo:t,opusFec:r,opusDtx:s,opusMaxPlaybackRate:a,opusPtime:n,videoGoogleStartBitrate:o,videoGoogleMaxBitrate:d,videoGoogleMinBitrate:l}=u,h=c.codecs.find((t=>t.payloadType===e.payloadType));switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(h.parameters["sprop-stereo"]=t?1:0,i.stereo=t?1:0),void 0!==r&&(h.parameters.useinbandfec=r?1:0,i.useinbandfec=r?1:0),void 0!==s&&(h.parameters.usedtx=s?1:0,i.usedtx=s?1:0),void 0!==a&&(i.maxplaybackrate=a),void 0!==n&&(h.parameters.ptime=n,i.ptime=n);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==o&&(i["x-google-start-bitrate"]=o),void 0!==d&&(i["x-google-max-bitrate"]=d),void 0!==l&&(i["x-google-min-bitrate"]=l)}}const r={payload:e.payloadType,config:""};for(const e of Object.keys(i))r.config&&(r.config+=";"),r.config+=`${e}=${i[e]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=l.codecs.map((e=>e.payloadType)).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions)(o.ext||[]).some((t=>t.uri===e.uri))&&this._mediaObject.ext.push({uri:e.uri,value:e.id});if(h&&"extmap-allow-mixed"===o.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const e of o.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of o.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof o.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize})}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}},t.OfferMediaSection=class extends o{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,mid:n,kind:o,offerRtpParameters:c,streamId:l,trackId:u,oldDataChannelSpec:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(n),this._mediaObject.type=o,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=r?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),o){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${u}`);for(const e of c.codecs){const t={payload:e.payloadType||e.localPayloadType||125,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i={payload:e.payloadType||e.localPayloadType||125,config:""},r=e.parameters||e.localParameters||{};for(const e of Object.keys(r))i.config&&(i.config+=";"),i.config+=`${e}=${r[e]}`;i.config&&this._mediaObject.fmtp.push(i);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=c.codecs.map((e=>e.payloadType||e.localPayloadType||125)).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,i=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${u}`}),i&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${l||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`}));break}case"application":h?(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize)}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){const r=e.encodings[0],s=r.ssrc,a=r.rtx&&r.rtx.ssrc?r.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],i=t.ssrc,r=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter((e=>e.id!==i&&e.id!==r)),r&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter((e=>e.ssrcs!==`${i} ${r}`)))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome62=void 0;const n=a(i(70)),o=i(38),d=i(121),c=a(i(61)),l=a(i(122)),u=a(i(130)),h=a(i(231)),p=i(60),m=i(2),f=i(129),g=i(143),v=i(131),_=i(232),y=a(i(14)),S="Chrome_",R={OS:1024,MIS:1024};class b extends f.HandlerInterface{constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new b}get name(){return"Chrome62"}close(){if(o.Logger.debug(S,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){o.Logger.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(e){}const i=n.parse(t.sdp);return u.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return o.Logger.debug("getNativeSctpCapabilities()"),{numStreams:R}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:d,proprietaryConstraints:c,extendedRtpCapabilities:u}){o.Logger.debug("run()"),this._direction=e,this._sendingRtpParametersByKind={audio:l.getSendingRtpParameters("audio",u),video:l.getSendingRtpParameters("video",u)},this._sendingRemoteRtpParametersByKind={audio:l.getSendingRemoteRtpParameters("audio",u),video:l.getSendingRemoteRtpParameters("video",u)},(null==r?void 0:r.role)&&"auto"!==r.role&&(this._forcedLocalDtlsRole="server"===r.role?"client":"server"),this._pc=new RTCPeerConnection(Object.assign({iceServers:a||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},d),c),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",(()=>{this.emit("@connectionstatechange",this._pc.connectionState)})):this._pc.addEventListener("iceconnectionstatechange",(()=>{switch(o.Logger.debug("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}})),this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{o.Logger.warn("onicecandidateerror: ",e)}}async updateIceServers(e){o.Logger.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(o.Logger.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if("send"===this._direction){const e=await this._pc.createOffer({iceRestart:!0});o.Logger.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const t={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",t),await this._pc.setRemoteDescription(t)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};o.Logger.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();o.Logger.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:r,appData:s}){this.assertSendDirection(),o.Logger.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let a,d,p=await this._pc.createOffer(),m=n.parse(p.sdp);s.preferRemb&&v.filterTransportCCFromSdp(m);const f=c.clone(this._sendingRtpParametersByKind[e.kind]);f.codecs=l.reduceCodecs(f.codecs,r);const g=c.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(g.codecs=l.reduceCodecs(g.codecs),this._transportReady||(d=await this._setupTransport({localDtlsRole:"server",localSdpObject:m})),"video"===e.kind&&t&&t.length>1&&(o.Logger.debug("send() | enabling simulcast"),m=n.parse(p.sdp),a=m.media.find((e=>"video"===e.type)),h.addLegacySimulcast({offerMediaObject:a,track:e,numStreams:t.length}),p={type:"offer",sdp:n.write(m)}),o.Logger.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),a=m.media.find((t=>t.type===e.kind)),f.rtcp.cname=u.getCname({offerMediaObject:a}),f.encodings=h.getRtpEncodings({offerMediaObject:a,track:e}),t)for(let e=0;e<f.encodings.length;++e)t[e]&&Object.assign(f.encodings[e],t[e]);if(f.encodings.length>1&&"video/vp8"===f.codecs[0].mimeType.toLowerCase())for(const e of f.encodings)e.scalabilityMode="S1T3";const _=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(_,e),{localId:_,rtpParameters:f,dtlsParameters:d,offer:p}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:d,offer:l,audioProfile:u,codec:h}){o.Logger.debug(S,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),l=(new _.Interop).toUnifiedPlan(l),await this._pc.setLocalDescription(l),this._remoteSdp||(this._remoteSdp=new g.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const f=c.clone(this._sendingRemoteRtpParametersByKind[e]);f.codecs=p.reduceCodecs(f.codecs,h);let v=n.parse(this._pc.localDescription.sdp);const y=this._remoteSdp.getNextMediaSectionIdx();let R=v.media[y.idx];a.encodings&&a.encodings.length>1&&v.media[y.idx+1],this._remoteSdp.send({offerMediaObjectArr:[R],reuseMid:y.reuseMid,offerRtpParameters:a,answerRtpParameters:f,codecOptions:d,extmapAllowMixed:!0});let b={type:"answer",sdp:this._remoteSdp.getSdp()};if(o.Logger.debug(S,"audioProfile设置为: ",u),u){let e=null;switch(u){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),b.sdp=b.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}o.Logger.debug(S,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),m.getParameters().enableUdpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),m.getParameters().enableTcpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(b)}async stopSending(e){this.assertSendDirection(),o.Logger.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const i=await this._pc.createOffer();o.Logger.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{await this._pc.setLocalDescription(i)}catch(e){if(0===this._sendStream.getTracks().length)return void o.Logger.warn("stopSending() | ignoring expected error due no sending tracks: %s",e.toString());throw e}if("stable"===this._pc.signalingState)return;const r={type:"answer",sdp:this._remoteSdp.getSdp()};o.Logger.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new d.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new d.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new d.UnsupportedError("not supported")}async getSenderStats(e){throw new d.UnsupportedError("not implemented")}async prepareLocalSdp(e,t){o.Logger.debug("prepareLocalSdp() [kind:%s, remoteUid:%s]",e,t);let i,r,s,a=-1;if(r="audio"===e||this._pc.localDescription.sdp.indexOf("m=audio")>-1,s="video"===e||this._pc.localDescription.sdp.indexOf("m=video")>-1,i=await this._pc.createOffer({offerToReceiveAudio:r,offerToReceiveVideo:s}),!i.sdp)throw o.Logger.error(S,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");if(i.sdp.indexOf("a=rtcp-fb:111")&&-1===i.sdp.indexOf("a=rtcp-fb:111 nack")&&(i.sdp=i.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")),i.sdp.indexOf("a=fmtp:111")&&(i.sdp=i.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),!i.sdp)throw o.Logger.error(S,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");i.sdp.includes("a=inactive")&&(i.sdp=i.sdp.replace(/a=inactive/g,"a=recvonly"));const d=n.parse(i.sdp);let c;a=d.media[d.media.length-1].mid,this._transportReady||(c=await this._setupTransport({localDtlsRole:"server",localSdpObject:d}));const l=u.extractRtpCapabilities({sdpObject:d});return-1===a&&(a=d.media[d.media.length-1].mid),{dtlsParameters:c,rtpCapabilities:l,offer:i,mid:a,iceUfragReg:""}}async receive({trackId:e,kind:t,rtpParameters:i,iceParameters:r,iceCandidates:s,dtlsParameters:a,sctpParameters:n,offer:d,remoteUid:c,extendedRtpCapabilities:l,appData:u}){this.assertRecvDirection(),o.Logger.debug("receive() [trackId:%s, kind:%s]",e,t);const h=t,p=i.rtcp.cname;this._remoteSdp||(this._remoteSdp=new g.RemoteSdp({iceParameters:r,iceCandidates:s,dtlsParameters:a,sctpParameters:n,planB:!0}),this._remoteSdp.updateDtlsRole("client"));let m=i&&i.mid||u.mid;o.Logger.debug(S,"[Subscribe] receive() mid: "+m),this._remoteSdp.receive({mid:h,kind:t,offerRtpParameters:i,streamId:p,trackId:e}),y.ANY_CHROME_MAJOR_VERSION&&y.ANY_CHROME_MAJOR_VERSION<59&&this._remoteSdp.getSdp().indexOf("a=setup:actpass")>-1&&this._remoteSdp.updateDtlsRole("client");let f={type:"answer",sdp:this._remoteSdp.getSdp()};return o.Logger.debug(S,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),o.Logger.debug(S,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(f),{localId:m,track:this._pc.getRemoteStreams().find((e=>e.id===p)).getTrackById(e),rtpReceiver:void 0}}async stopReceiving(e){this.assertRecvDirection();for(const t of e){o.Logger.debug("stopReceiving() [localId:%s]",t);const{mid:e,rtpParameters:i}=this._mapRecvLocalIdInfo.get(t)||{};this._mapRecvLocalIdInfo.delete(t),y.ANY_CHROME_MAJOR_VERSION&&y.ANY_CHROME_MAJOR_VERSION<59&&this._remoteSdp.updateDtlsRole("auto"),this._remoteSdp.planBStopReceiving({mid:e,offerRtpParameters:i})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};o.Logger.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();o.Logger.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new d.UnsupportedError("not implemented")}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=u.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}assertSendDirection(){if("send"!==this._direction)throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if("recv"!==this._direction)throw new Error('method can just be called for handlers with "recv" direction')}}t.Chrome62=b},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.addLegacySimulcast=t.getRtpEncodings=void 0,t.getRtpEncodings=function({offerMediaObject:e,track:t}){const i=new Set;for(const r of e.ssrcs||[])if("msid"===r.attribute&&r.value.split(" ")[1]===t.id){const e=r.id;i.add(e)}if(0===i.size)throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);const r=new Map;for(const t of e.ssrcGroups||[]){if("FID"!==t.semantics)continue;let[e,s]=t.ssrcs.split(/\s+/);e=Number(e),s=Number(s),i.has(e)&&(i.delete(e),i.delete(s),r.set(e,s))}for(const e of i)r.set(e,null);const s=[];for(const[e,t]of r){const i={ssrc:e};t&&(i.rtx={ssrc:t}),s.push(i)}return s},t.addLegacySimulcast=function({offerMediaObject:e,track:t,numStreams:i}){if(i<=1)throw new TypeError("numStreams must be greater than 1");let r,s,a;if(!(e.ssrcs||[]).find((e=>"msid"===e.attribute&&e.value.split(" ")[1]===t.id&&(r=e.id,a=e.value.split(" ")[0],!0))))throw new Error(`a=ssrc line with msid information not found [track.id:${t.id}]`);(e.ssrcGroups||[]).some((e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===r&&(s=Number(t[1]),!0)}));const n=e.ssrcs.find((e=>"cname"===e.attribute&&e.id===r));if(!n)throw new Error(`a=ssrc line with cname information not found [track.id:${t.id}]`);const o=n.value,d=[],c=[];for(let e=0;e<i;++e)d.push(r+e),s&&c.push(s+e);e.ssrcGroups=e.ssrcGroups||[],e.ssrcs=e.ssrcs||[],e.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let i=0;i<d.length;++i){const r=d[i];e.ssrcs.push({id:r,attribute:"cname",value:o}),e.ssrcs.push({id:r,attribute:"msid",value:`${a} ${t.id}`})}for(let i=0;i<c.length;++i){const r=d[i],s=c[i];e.ssrcs.push({id:s,attribute:"cname",value:o}),e.ssrcs.push({id:s,attribute:"msid",value:`${a} ${t.id}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${r} ${s}`})}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Interop=void 0;const s=r(i(233)),a=r(i(234)),n=["audio","video","data"],o=e=>e.find((e=>"SIM"===e.semantics)),d=e=>e.find((e=>"FID"===e.semantics));function c(e,t,i,r){if(!e||!t)return;const s=e=>r.find((t=>t.id.toString()===e));t.ssrcs.forEach((t=>{e.sources.push(s(t));const r=i[parseInt(t,10)].find((e=>"FID"===e.semantics));if(r){const i=r.ssrcs.find((e=>e!==t));e.sources.push(s(i)),e.ssrcGroups.push(r)}})),e.ssrcGroups.push(t)}function l(e,t,i,r){if(!e||!t)return;if(e.sources=[],e.ssrcGroups=[],!i[t.id])return e.sources.push(t),void(e.msid=t.msid);const s=o(i[t.id]),a=d(i[t.id]);if(s)c(e,s,i,r);else if(a){const s=a.ssrcs.find((e=>e!==t)),n=o(i[s]);n?c(e,n,i,r):(a.ssrcs.forEach((t=>{e.sources.push((e=>r.find((t=>t.id.toString()===e)))(t))})),e.ssrcGroups.push(a))}e.msid=e.sources[0].msid}function u(e,t,i){if(!i.find((t=>!!t.sources&&t.sources.some((t=>t.id===e.id))))){if(!t[e.id])return!1;const r=o(t[e.id]),s=d(t[e.id]);return r?i.some((e=>e.sources&&e.sources.some((e=>e.id.toString()===r.ssrcs[0])))):!(!s||e.id.toString()===s.ssrcs[0])&&u({id:s.ssrcs[0]},t,i)}return!0}t.Interop=class{toPlanB(e){if(!e||"string"!=typeof e.sdp)return console.warn("An empty description was passed as an argument."),e;const t=s.default.parse(e.sdp);if(!t.media||!t.media.length)return console.warn("The description has no media."),e;if(t.media.every((e=>-1!==n.indexOf(e.mid))))return console.warn("The description does not look like unified plan sdp"),e;const i={},r=t.media;t.media=[],r.forEach((e=>{const t=e.type;if("application"===t)return e.mid="data",void(i[e.mid]=e);if(void 0===i[t]){const r=a.default(e);r.sources&&Array.isArray(r.sources)&&r.sources.forEach((t=>{e.msid?t.msid=e.msid:delete t.msid})),r.ssrcGroups&&e.msid||(r.ssrcGroups=[]),delete r.msid,r.mid=t,i[t]=r}else if(e.msid){const r=a.default(e);r.sources&&Array.isArray(r.sources)&&(r.sources.forEach((t=>{t.msid=e.msid})),i[t].sources=(i[t].sources||[]).concat(r.sources)),void 0!==r.ssrcGroups&&Array.isArray(r.ssrcGroups)&&(i[t].ssrcGroups=(i[t].ssrcGroups||[]).concat(r.ssrcGroups))}})),t.media=Object.values(i);const o=[];Object.values(i).forEach((e=>{"inactive"!==e.direction&&o.push(e.mid)})),t.groups.forEach((e=>{"BUNDLE"===e.type&&(e.mids=o.join(" "))})),t.msidSemantic={semantic:"WMS",token:"*"};const d=s.default.write(t);return new RTCSessionDescription({type:e.type,sdp:d})}toUnifiedPlan(e,t=null){if(!e||"string"!=typeof e.sdp)return console.warn("An empty description was passed as an argument."),e;const i=s.default.parse(e.sdp);if(!i.media||!i.media.length)return console.warn("The description has no media."),e;if(i.media.length>3||i.media.every((e=>-1===n.indexOf(e.mid))))return console.warn("The description does not look like plan-b"),e;const r=t?s.default.parse(t.sdp):null,o=function(e,t){if(!e||!t||0===e.media.length||0===t.media.length)return!1;const i=e.media[0],r=t.media[0];return i.iceUfrag!==r.iceUfrag||i.icePwd!==r.icePwd}(i,r),d=i.media[0].iceUfrag,c=i.media[0].icePwd,h=i.media[0].fingerprint,p={};i.media.forEach((e=>{const t=e.type;if("application"===t){if(!r||!r.media){const t=a.default(e);return t.mid=Object.keys(p).length.toString(),void(p[e.mid]=t)}const i=r.media.findIndex((e=>e.type===t));return void(i&&(r.media[i]=e,r.media[i].mid=i))}const i=function(e){const t={};return e&&Array.isArray(e)?(e.forEach((e=>{e.ssrcs&&Array.isArray(e.ssrcs)&&e.ssrcs.forEach((i=>{void 0===t[i]&&(t[i]=[]),t[i].push(e)}))})),t):t}(e.ssrcGroups);if(e.sources)e.sources.forEach(((t,s)=>{if(!t.msid)return;if(!r||!r.media){if(u(t,i,Object.values(p)))return;const r=a.default(e);return r.mid=Object.keys(p).length.toString(),r.direction=s||"sendonly"===e.direction?"sendonly":"sendrecv",r.bundleOnly=void 0,l(r,t,i,e.sources),void(p[r.mid]=r)}if(u(t,i,r.media))return;const n=a.default(e);n.mid=r.media.length.toString(),n.direction="sendonly",l(n,t,i,e.sources),r.media.push(n)}));else if(!r){const t=a.default(e);t.mid=Object.keys(p).length.toString(),p[e.mid]=t}})),i.media=r?r.media:Object.values(p);const m=[];i.media.forEach((e=>{m.push(e.mid),o&&(e.iceUfrag=d,e.icePwd=c),e.fingerprint=h})),i.groups.forEach((e=>{"BUNDLE"===e.type&&(e.mids=m.join(" "))})),i.msidSemantic={semantic:"WMS",token:"*"},i.origin.sessionVersion++;const f=s.default.write(i);return new RTCSessionDescription({type:e.type,sdp:f})}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(i(70));t.default={write:function(e,t){return void 0!==e&&void 0!==e.media&&Array.isArray(e.media)&&e.media.forEach((e=>{e.sources&&e.sources.length&&(e.ssrcs=[],e.sources.forEach((t=>{Object.keys(t).forEach((i=>{"id"!==i&&e.ssrcs.push({id:t.id,attribute:i,value:t[i]})}))})),delete e.sources),e.ssrcGroups&&e.ssrcGroups.length&&e.ssrcGroups.forEach((e=>{void 0!==e.ssrcs&&Array.isArray(e.ssrcs)&&(e.ssrcs=e.ssrcs.join(" "))}))})),s.default.write(e,t)},parse:function(e){const t=s.default.parse(e);return void 0!==t&&void 0!==t.media&&Array.isArray(t.media)&&t.media.forEach((e=>{void 0!==e.ssrcs&&Array.isArray(e.ssrcs)&&(e.sources=[],e.ssrcs.forEach((t=>{const i=e.sources.findIndex((e=>e.id===t.id));if(i>-1)e.sources[i][t.attribute]=t.value;else{const i={id:t.id};i[t.attribute]=t.value,e.sources.push(i)}})),delete e.ssrcs),void 0!==e.ssrcGroups&&Array.isArray(e.ssrcGroups)&&e.ssrcGroups.forEach((e=>{"string"==typeof e.ssrcs&&(e.ssrcs=e.ssrcs.split(" "))}))})),t}}},function(e,t,i){(function(e,i){var r="[object Arguments]",s="[object Function]",a="[object GeneratorFunction]",n="[object Map]",o="[object Set]",d=/\w*$/,c=/^\[object .+?Constructor\]$/,l=/^(?:0|[1-9]\d*)$/,u={};u[r]=u["[object Array]"]=u["[object ArrayBuffer]"]=u["[object DataView]"]=u["[object Boolean]"]=u["[object Date]"]=u["[object Float32Array]"]=u["[object Float64Array]"]=u["[object Int8Array]"]=u["[object Int16Array]"]=u["[object Int32Array]"]=u[n]=u["[object Number]"]=u["[object Object]"]=u["[object RegExp]"]=u[o]=u["[object String]"]=u["[object Symbol]"]=u["[object Uint8Array]"]=u["[object Uint8ClampedArray]"]=u["[object Uint16Array]"]=u["[object Uint32Array]"]=!0,u["[object Error]"]=u[s]=u["[object WeakMap]"]=!1;var h="object"==typeof e&&e&&e.Object===Object&&e,p="object"==typeof self&&self&&self.Object===Object&&self,m=h||p||Function("return this")(),f=t&&!t.nodeType&&t,g=f&&"object"==typeof i&&i&&!i.nodeType&&i,v=g&&g.exports===f;function _(e,t){return e.set(t[0],t[1]),e}function y(e,t){return e.add(t),e}function S(e,t,i,r){var s=-1,a=e?e.length:0;for(r&&a&&(i=e[++s]);++s<a;)i=t(i,e[s],s,e);return i}function R(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function b(e){var t=-1,i=Array(e.size);return e.forEach((function(e,r){i[++t]=[r,e]})),i}function E(e,t){return function(i){return e(t(i))}}function T(e){var t=-1,i=Array(e.size);return e.forEach((function(e){i[++t]=e})),i}var A,w=Array.prototype,I=Function.prototype,C=Object.prototype,O=m["__core-js_shared__"],k=(A=/[^.]+$/.exec(O&&O.keys&&O.keys.IE_PROTO||""))?"Symbol(src)_1."+A:"",P=I.toString,x=C.hasOwnProperty,M=C.toString,D=RegExp("^"+P.call(x).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),N=v?m.Buffer:void 0,L=m.Symbol,F=m.Uint8Array,V=E(Object.getPrototypeOf,Object),j=Object.create,U=C.propertyIsEnumerable,B=w.splice,H=Object.getOwnPropertySymbols,$=N?N.isBuffer:void 0,W=E(Object.keys,Object),G=me(m,"DataView"),q=me(m,"Map"),J=me(m,"Promise"),z=me(m,"Set"),Y=me(m,"WeakMap"),Q=me(Object,"create"),K=ye(G),X=ye(q),Z=ye(J),ee=ye(z),te=ye(Y),ie=L?L.prototype:void 0,re=ie?ie.valueOf:void 0;function se(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function ae(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function ne(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function oe(e){this.__data__=new ae(e)}function de(e,t,i){var r=e[t];x.call(e,t)&&Se(r,i)&&(void 0!==i||t in e)||(e[t]=i)}function ce(e,t){for(var i=e.length;i--;)if(Se(e[i][0],t))return i;return-1}function le(e,t,i,c,l,h,p){var m;if(c&&(m=h?c(e,l,h,p):c(e)),void 0!==m)return m;if(!Ae(e))return e;var f=Re(e);if(f){if(m=function(e){var t=e.length,i=e.constructor(t);return t&&"string"==typeof e[0]&&x.call(e,"index")&&(i.index=e.index,i.input=e.input),i}(e),!t)return function(e,t){var i=-1,r=e.length;for(t||(t=Array(r));++i<r;)t[i]=e[i];return t}(e,m)}else{var g=ge(e),v=g==s||g==a;if(Ee(e))return function(e,t){if(t)return e.slice();var i=new e.constructor(e.length);return e.copy(i),i}(e,t);if("[object Object]"==g||g==r||v&&!h){if(R(e))return h?e:{};if(m=function(e){return"function"!=typeof e.constructor||_e(e)?{}:Ae(t=V(e))?j(t):{};var t}(v?{}:e),!t)return function(e,t){return he(e,fe(e),t)}(e,function(e,t){return e&&he(t,we(t),e)}(m,e))}else{if(!u[g])return h?e:{};m=function(e,t,i,r){var s,a=e.constructor;switch(t){case"[object ArrayBuffer]":return ue(e);case"[object Boolean]":case"[object Date]":return new a(+e);case"[object DataView]":return function(e,t){var i=t?ue(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return function(e,t){var i=t?ue(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}(e,r);case n:return function(e,t,i){return S(t?i(b(e),!0):b(e),_,new e.constructor)}(e,r,i);case"[object Number]":case"[object String]":return new a(e);case"[object RegExp]":return function(e){var t=new e.constructor(e.source,d.exec(e));return t.lastIndex=e.lastIndex,t}(e);case o:return function(e,t,i){return S(t?i(T(e),!0):T(e),y,new e.constructor)}(e,r,i);case"[object Symbol]":return s=e,re?Object(re.call(s)):{}}}(e,g,le,t)}}p||(p=new oe);var E=p.get(e);if(E)return E;if(p.set(e,m),!f)var A=i?function(e){return function(e,t,i){var r=t(e);return Re(e)?r:function(e,t){for(var i=-1,r=t.length,s=e.length;++i<r;)e[s+i]=t[i];return e}(r,i(e))}(e,we,fe)}(e):we(e);return function(e,t){for(var i=-1,r=e?e.length:0;++i<r&&!1!==t(e[i],i););}(A||e,(function(r,s){A&&(r=e[s=r]),de(m,s,le(r,t,i,c,s,e,p))})),m}function ue(e){var t=new e.constructor(e.byteLength);return new F(t).set(new F(e)),t}function he(e,t,i,r){i||(i={});for(var s=-1,a=t.length;++s<a;){var n=t[s],o=r?r(i[n],e[n],n,i,e):void 0;de(i,n,void 0===o?e[n]:o)}return i}function pe(e,t){var i,r,s=e.__data__;return("string"==(r=typeof(i=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==i:null===i)?s["string"==typeof t?"string":"hash"]:s.map}function me(e,t){var i=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){return!(!Ae(e)||(t=e,k&&k in t))&&(Te(e)||R(e)?D:c).test(ye(e));var t}(i)?i:void 0}se.prototype.clear=function(){this.__data__=Q?Q(null):{}},se.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},se.prototype.get=function(e){var t=this.__data__;if(Q){var i=t[e];return"__lodash_hash_undefined__"===i?void 0:i}return x.call(t,e)?t[e]:void 0},se.prototype.has=function(e){var t=this.__data__;return Q?void 0!==t[e]:x.call(t,e)},se.prototype.set=function(e,t){return this.__data__[e]=Q&&void 0===t?"__lodash_hash_undefined__":t,this},ae.prototype.clear=function(){this.__data__=[]},ae.prototype.delete=function(e){var t=this.__data__,i=ce(t,e);return!(i<0||(i==t.length-1?t.pop():B.call(t,i,1),0))},ae.prototype.get=function(e){var t=this.__data__,i=ce(t,e);return i<0?void 0:t[i][1]},ae.prototype.has=function(e){return ce(this.__data__,e)>-1},ae.prototype.set=function(e,t){var i=this.__data__,r=ce(i,e);return r<0?i.push([e,t]):i[r][1]=t,this},ne.prototype.clear=function(){this.__data__={hash:new se,map:new(q||ae),string:new se}},ne.prototype.delete=function(e){return pe(this,e).delete(e)},ne.prototype.get=function(e){return pe(this,e).get(e)},ne.prototype.has=function(e){return pe(this,e).has(e)},ne.prototype.set=function(e,t){return pe(this,e).set(e,t),this},oe.prototype.clear=function(){this.__data__=new ae},oe.prototype.delete=function(e){return this.__data__.delete(e)},oe.prototype.get=function(e){return this.__data__.get(e)},oe.prototype.has=function(e){return this.__data__.has(e)},oe.prototype.set=function(e,t){var i=this.__data__;if(i instanceof ae){var r=i.__data__;if(!q||r.length<199)return r.push([e,t]),this;i=this.__data__=new ne(r)}return i.set(e,t),this};var fe=H?E(H,Object):function(){return[]},ge=function(e){return M.call(e)};function ve(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||l.test(e))&&e>-1&&e%1==0&&e<t}function _e(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||C)}function ye(e){if(null!=e){try{return P.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Se(e,t){return e===t||e!=e&&t!=t}(G&&"[object DataView]"!=ge(new G(new ArrayBuffer(1)))||q&&ge(new q)!=n||J&&"[object Promise]"!=ge(J.resolve())||z&&ge(new z)!=o||Y&&"[object WeakMap]"!=ge(new Y))&&(ge=function(e){var t=M.call(e),i="[object Object]"==t?e.constructor:void 0,r=i?ye(i):void 0;if(r)switch(r){case K:return"[object DataView]";case X:return n;case Z:return"[object Promise]";case ee:return o;case te:return"[object WeakMap]"}return t});var Re=Array.isArray;function be(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}(e.length)&&!Te(e)}var Ee=$||function(){return!1};function Te(e){var t=Ae(e)?M.call(e):"";return t==s||t==a}function Ae(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function we(e){return be(e)?function(e,t){var i=Re(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&be(e)}(e)&&x.call(e,"callee")&&(!U.call(e,"callee")||M.call(e)==r)}(e)?function(e,t){for(var i=-1,r=Array(e);++i<e;)r[i]=t(i);return r}(e.length,String):[],s=i.length,a=!!s;for(var n in e)!t&&!x.call(e,n)||a&&("length"==n||ve(n,s))||i.push(n);return i}(e):function(e){if(!_e(e))return W(e);var t=[];for(var i in Object(e))x.call(e,i)&&"constructor"!=i&&t.push(i);return t}(e)}i.exports=function(e){return le(e,!0,!0)}}).call(this,i(62),i(235)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox60=void 0;const o=a(i(70)),d=n(i(12)),c=n(i(13)),l=i(60),u=i(2),h=i(38),p=a(i(122)),m=a(i(61)),f=i(129),g=a(i(130)),v=i(143),_=a(i(153)),y=i(131),S=i(144),R="Firefox_",b={OS:1024,MIS:1024};let E=0;class T extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={},this.signalingState="stable"}static createFactory(){return()=>new T}get name(){return"Firefox60"}get remoteSdp(){return this._remoteSdp}close(){if(h.Logger.debug(R,"close()"),this._pc)try{this._pc.oniceconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.Logger.debug(R,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp.indexOf("a=rtcp-fb:111")&&-1===t.sdp.indexOf("a=rtcp-fb:111 nack")&&(t.sdp=t.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack"));try{e.close()}catch(e){}const i=o.parse(t.sdp),r=g.extractRtpCapabilities({sdpObject:i});return S.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.Logger.debug(R,"getNativeSctpCapabilities()"),{numStreams:b}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(R,"run()",l),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(R,"iceServers: %o",a);const u={iceServers:a||[],iceTransportPolicy:n||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=E++,this._pc.oniceconnectionstatechange=()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.debug("onicecandidateerror: ",e)}}async updateIceServers(e){h.Logger.debug(R,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.Logger.debug(R,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=o.parse(e.sdp);t.media.forEach((e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),e.sdp=o.write(t),h.Logger.debug(R,"restartIce() | calling pc.setLocalDescription()"),this.signalingState="have-local-offer",await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(R,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),this.signalingState="have-local-offer",await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(R,`[Produce] send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&(i.forEach(((e,t)=>{e.rid="r"+t})),i.reverse());const n=m.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=l.reduceCodecs(n.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(R,"[Produce] audioSender更新track: ",this._pc.audioSender),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(R,"[Produce] videoSender更新track: ",this._pc.videoSender),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(R,"[Produce] videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(R,"[Produce] screenSender更新track: ",this._pc.screenSender),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(R,"[Produce] screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f]}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream]})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSender=u.sender),h.Logger.debug(R,"[Produce] send() | [transceivers:%d]",this._pc.getTransceivers().length);let v=await this._pc.createOffer();v.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(v.sdp=v.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let S,b,E,T=o.parse(v.sdp);a.preferRemb&&y.filterTransportCCFromSdp(T);const A=T.media.filter((i=>{const r=this._mapMidTransceiver.get(""+i.mid);return!(i.type!==e.kind||r&&r.sender&&r.sender.track&&(r.sender.track.id===e.id?(S=i,1):t&&r.sender.track.id===t.id&&(b=i,1)))}));S||(S=A.pop()),t&&!b&&(b=A.pop()),this._transportReady||(E=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let w=null==S?void 0:S.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.send: localId 未找到"});let I=null;if(b&&(I=""+b.mid),n.mid=w,n.rtcp.cname=g.getCname({offerMediaObject:S}),i)if(1===i.length){let e=_.getRtpEncodings({offerMediaObject:S});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i.reverse();else n.encodings=[],b&&(n.encodings=n.encodings.concat(_.getRtpEncodings({offerMediaObject:b}))),n.encodings=n.encodings.concat(_.getRtpEncodings({offerMediaObject:S}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||n.codecs[0].mimeType.toLowerCase()),T.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),v.sdp=o.write(T),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,p),{localId:w,localIdLow:I,rtpParameters:n,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:E,offer:v}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:n,offer:d,audioProfile:c,codec:u}){h.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const p=m.clone(this._sendingRemoteRtpParametersByKind[e]);p.codecs=l.reduceCodecs(p.codecs,u);let f=o.parse(this._pc.localDescription.sdp);const g=this._remoteSdp.getNextMediaSectionIdx();let _=f.media[g.idx],y=null;a.encodings&&a.encodings.length>1&&(y=f.media[g.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[_,y],reuseMid:g.reuseMid,offerRtpParameters:a,answerRtpParameters:p,codecOptions:n,extmapAllowMixed:!0});const S={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(R,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}S.sdp.indexOf("a=fmtp:111")&&(S.sdp=S.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),S.sdp=S.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}h.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(S)}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(R,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopSending: RTCRtpTransceiver 未找到"});"audio"===t?this._pc.audioSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):(i.sender.replaceTrack(null),this._pc.removeTrack(i.sender),this._remoteSdp.disableMediaSection(i.mid));const r=await this._pc.createOffer();r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let s=o.parse(r.sdp);s.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),r.sdp=o.write(s),h.Logger.debug(R,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r)}catch(e){h.Logger.debug(R,"setLocalDescription error = %o",e)}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(R,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(R,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(R,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t))}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(R,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e),r=null==i?void 0:i.sender.getParameters();t=r.encodings.length-1-t,r.encodings.forEach(((e,i)=>{e.active=i>=t})),await(null==i?void 0:i.sender.setParameters(r))}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(R,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach(((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)})),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(R,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(R,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){h.Logger.debug(R,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i,r=-1;if(u.getParameters().reuseMid)for(const t of this._mapMidTransceiver.keys()){const i=this._mapMidTransceiver.get(t);if(!i)continue;const s=i.receiver&&i.receiver.track&&i.receiver.track.kind||e;if(i.isUseless&&s===e){r=t-0,i.isUseless=!1;break}}let s=null;if(-1===r){if(h.Logger.debug(R,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),i=await this._pc.createOffer(),!i.sdp)throw h.Logger.error(R,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");i.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(i.sdp=i.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),i.sdp.indexOf("a=rtcp-fb:111")&&-1===i.sdp.indexOf("a=rtcp-fb:111 nack")&&(i.sdp=i.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")))}else if(this._pc.localDescription)i={type:"offer",sdp:this._pc.localDescription.sdp};else{if(i=await this._pc.createOffer(),!i.sdp)throw h.Logger.error(R,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");i.sdp.indexOf("a=rtcp-fb:111")&&-1===i.sdp.indexOf("a=rtcp-fb:111 nack")&&(i.sdp=i.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")),i.sdp.indexOf("a=fmtp:111")&&(i.sdp=i.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=o.parse(i.sdp);r=e.media[e.media.length-1].mid}if(!i.sdp)throw h.Logger.error(R,"[Subscribe] prepareLocalSdp() offer没有sdp"),new Error("INVALID_OFFER");const a=o.parse(i.sdp);let n;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return S.addNackSuppportForOpus(d),-1===r&&(r=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+r,s)),{dtlsParameters:n,rtpCapabilities:d,offer:i,mid:r,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:n,offer:o,probeSSrc:d=-1,remoteUid:c,extendedRtpCapabilities:l,appData:p}){this._assertRecvDirection(),h.Logger.debug(R,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${c}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let m=n&&n.mid||p.mid;if(h.Logger.debug(R,"[Subscribe] receive() mid: "+m),n.mid)this._remoteSdp.receive({mid:m,kind:a,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s});else{h.Logger.debug(R,"[Subscribe] receive() 容错流程");const e=[];l.codecs.forEach((t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}}));const t={mid:m,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:m},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+m)}const f={type:"answer",sdp:this._remoteSdp.getSdp()};f.sdp.indexOf("a=fmtp:111")&&(f.sdp=f.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),"all"===u.getParameters().enableSdpRrtr&&(o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n"),f.sdp=f.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),f.sdp=f.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n")),u.getParameters().enableUdpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(f.sdp=f.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(R,"[Subscribe] receive() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(o)}catch(e){if("InvalidModificationError"!==e.name)throw e;await this._pc.createOffer(),await this._pc.setLocalDescription(o)}h.Logger.debug(R,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(f);const g=this._pc.getTransceivers().find((e=>e.mid===m));return g.isUseless=!n.mid,this._mapMidTransceiver.set(m,g),{localId:m,track:g.receiver.track,rtpReceiver:g.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(R,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.stopReceiving: RTCRtpTransceiver 未找到"});t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Firefox.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=o.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Firefox60=T},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari12=void 0;const o=a(i(70)),d=n(i(12)),c=n(i(13)),l=i(60),u=i(238),h=i(2),p=i(38),m=a(i(122)),f=a(i(61)),g=i(129),v=a(i(130)),_=i(143),y=a(i(153)),S=i(131),R=i(144),b="Safari_",E={OS:1024,MIS:1024};let T=0;class A extends g.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new A}get name(){return"Safari12"}get remoteSdp(){return this._remoteSdp}close(){if(p.Logger.debug(b,"close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){p.Logger.debug(b,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp.indexOf("a=rtcp-fb:111")&&-1===t.sdp.indexOf("a=rtcp-fb:111 nack")&&(t.sdp=t.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack"));try{e.close()}catch(e){}const i=o.parse(t.sdp),r=v.extractRtpCapabilities({sdpObject:i});return R.addNackSuppportForOpus(r),r}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return p.Logger.debug(b,"getNativeSctpCapabilities()"),{numStreams:E}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:n,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){p.Logger.debug(b,"run()"),this._direction=e,this._appData=l,this._sendingRtpParametersByKind={audio:m.getSendingRtpParameters("audio",c),video:m.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:m.getSendingRemoteRtpParameters("audio",c),video:m.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection(Object.assign({iceServers:a||[],iceTransportPolicy:n||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),d),this._pc.pcid=T++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}}async updateIceServers(e){p.Logger.debug(b,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(p.Logger.debug(b,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=o.parse(e.sdp);t.media.forEach((e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),e.sdp=o.write(t),p.Logger.debug(b,"restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(b,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(b,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();p.Logger.debug(b,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),p.Logger.debug(b,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`);const n=f.clone(this._sendingRtpParametersByKind[e.kind],{});n.codecs=l.reduceCodecs(n.codecs,s);let u={},h={};const m=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(p.Logger.warn(b,"audioSender更新track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(p.Logger.warn(b,"videoSender更新track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(p.Logger.debug(b,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(p.Logger.warn(b,"screenSender更新track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(p.Logger.debug(b,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(m.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[m]}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream]})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=u.sender),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender):this._pc.videoSender=u.sender:this._pc.audioSender=u.sender,p.Logger.debug(b,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let g,_,R,E=await this._pc.createOffer(),T=o.parse(E.sdp);a.preferRemb&&S.filterTransportCCFromSdp(T);const A=T.media.filter((i=>{const r=this._mapMidTransceiver.get(""+i.mid);return!(i.type!==e.kind||r&&r.sender&&r.sender.track&&(r.sender.track.id===e.id?(g=i,1):t&&r.sender.track.id===t.id&&(_=i,1)))}));g||(g=A.pop()),t&&!_&&(_=A.pop()),this._transportReady||(R=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let w=null==g?void 0:g.mid;if("number"==typeof w&&(w=""+w),!w)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.send: localId 未找到"});let I=null;if(_&&(I=""+_.mid),n.mid=w,p.Logger.debug(b,"要检查M行: ",g),n.rtcp.cname=v.getCname({offerMediaObject:g}),i)if(1===i.length){let e=y.getRtpEncodings({offerMediaObject:g});Object.assign(e[0],i[0]),n.encodings=e}else n.encodings=i;else n.encodings=[],_&&(n.encodings=n.encodings.concat(y.getRtpEncodings({offerMediaObject:_}))),n.encodings=n.encodings.concat(y.getRtpEncodings({offerMediaObject:g}));return n.encodings.length>1&&("video/vp8"===n.codecs[0].mimeType.toLowerCase()||"video/h264"===n.codecs[0].mimeType.toLowerCase())&&T.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),E.sdp=o.write(T),this._mapMidTransceiver.set(w,u),I&&this._mapMidTransceiver.set(I,h),{localId:w,localIdLow:I,rtpParameters:n,rtpSender:u.sender,rtpSenderLow:h.sender||null,dtlsParameters:R,offer:E}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:n,offer:d,audioProfile:c,codec:h}){let m=o.parse(d.sdp);m.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),d.sdp=o.write(m),p.Logger.debug(b,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new _.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const g=f.clone(this._sendingRemoteRtpParametersByKind[e]);g.codecs=l.reduceCodecs(g.codecs,h);let v=o.parse(this._pc.localDescription.sdp);const y=this._remoteSdp.getNextMediaSectionIdx();let S=v.media[y.idx],R=null;a.encodings&&a.encodings.length>1&&(R=v.media[y.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[S,R],reuseMid:y.reuseMid,offerRtpParameters:a,answerRtpParameters:g,codecOptions:n,extmapAllowMixed:!0});const E={type:"answer",sdp:this._remoteSdp.getSdp()};if(p.Logger.debug(b,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}E.sdp.indexOf("a=fmtp:111")&&(E.sdp=E.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),E.sdp=E.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}u.canShimVideoOrientation(d,E)&&u.shimVideoOrientation(d,E),p.Logger.debug(b,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer:%o]",E.sdp),await this._pc.setRemoteDescription(E)}async stopSending(e,t){this._assertSendDirection(),p.Logger.debug(b,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);"audio"===t?(this._pc.audioSender.replaceTrack(null),p.Logger.debug(b,"删除发送的audio track: ",this._pc.audioSender)):"video"===t?(this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null),this._pc.videoSender.replaceTrack(null),p.Logger.debug(b,"删除发送的video track: ",this._pc.videoSender)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null),p.Logger.debug(b,"删除发送的screen track: ",this._pc.screenSender)):null==i||i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=o.parse(r.sdp);s.media.forEach((e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter((e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time"))),e.rtcpFb.push({payload:111,type:"nack"}))})),r.sdp=o.write(s),p.Logger.debug(b,"stopSending() | calling pc.setLocalDescription() [offer:%o]",r.sdp),await this._pc.setLocalDescription(r);const a={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(b,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),t?p.Logger.debug(b,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):p.Logger.debug(b,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);await(null==i?void 0:i.sender.replaceTrack(t))}async setMaxSpatialLayer(e,t){this._assertSendDirection(),p.Logger.debug(b,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.setMaxSpatialLayer: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach(((e,i)=>{e.active=i<=t})),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),p.Logger.debug(b,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.setRtpEncodingParameters: RTCRtpTransceiver 未找到"});const r=i.sender.getParameters();r.encodings.forEach(((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)})),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.getSenderStats: RTCRtpTransceiver 未找到"});return t.sender.getStats()}async recoverTransceiver(e,t,i){p.Logger.debug(b,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:p.Logger.debug(b,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){p.Logger.debug(b,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;if(h.getParameters().reuseMid)for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=null,s=null;if(-1===i)p.Logger.debug(b,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf("a=rtcp-fb:111")&&-1===r.sdp.indexOf("a=rtcp-fb:111 nack")&&(r.sdp=r.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack"));else if(this._pc.localDescription)r={type:this._pc.localDescription.type,sdp:this._pc.localDescription.sdp};else if(!this._pc.localDescription){r=await this._pc.createOffer(),r.sdp.indexOf("a=rtcp-fb:111")&&-1===r.sdp.indexOf("a=rtcp-fb:111 nack")&&(r.sdp=r.sdp.replace(/(a=rtcp-fb:111.*)/,"$1\r\na=rtcp-fb:111 nack")),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const e=o.parse(r.sdp);i=e.media[e.media.length-1].mid}const a=o.parse(r.sdp);let n;this._transportReady||(n=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=v.extractRtpCapabilities({sdpObject:a});return R.addNackSuppportForOpus(d),-1===i&&(i=a.media[a.media.length-1].mid,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:n,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:n,offer:o,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:m,appData:f}){this._assertRecvDirection(),p.Logger.debug(b,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${u}]`),this._remoteSdp||(this._remoteSdp=new _.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let g=n&&n.mid||f.mid;if(p.Logger.debug(b,"receive() mid: "+g),n.mid)this._remoteSdp.receive({mid:g,kind:a,offerRtpParameters:n,streamId:n.rtcp.cname,trackId:s});else{p.Logger.debug(b,"[Subscribe] receive() 容错流程");const e=[];m.codecs.forEach((t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}}));const t={mid:g,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:g},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+g)}let v={type:"answer",sdp:this._remoteSdp.getSdp()};v.sdp.indexOf("a=fmtp:111")&&(v.sdp=v.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),"all"===h.getParameters().enableSdpRrtr&&(o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),o.sdp=o.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n"),v.sdp=v.sdp.replace(/a=rtcp-fb:(\d+) rrtr ?\r\n/g,""),v.sdp=v.sdp.replace(/a=rtcp-fb:(\d+) nack ?\r\n/g,"a=rtcp-fb:$1 rrtr\r\na=rtcp-fb:$1 nack\r\n")),h.getParameters().enableUdpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),p.Logger.debug(b,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(o),p.Logger.debug(b,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(v);const y=this._pc.getTransceivers().find((e=>e.mid===g));if(!y)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.receive: RTCRtpTransceiver 未找到"});return this._mapMidTransceiver.set(g,y),{localId:g,track:y.receiver.track,rtpReceiver:y.receiver}}async stopReceiving(e){this._assertRecvDirection(),p.Logger.debug(b,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.stopReceiving: RTCRtpTransceiver 未找到"});p.Logger.debug(b,"transceiver: ",t),t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;p.Logger.debug(b,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(b,"stopReceiving() | calling pc.setRemoteDescription() [answer:%o]",r.sdp),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"Safari.getReceiverStats: RTCRtpTransceiver 未找到"});return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=o.parse(this._pc.localDescription.sdp));const i=v.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertSendDirection: 操作异常"})}_assertRecvDirection(){if("recv"!==this._direction)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"_assertRecvDirection: 操作异常"})}}t.Safari12=A},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimVideoOrientation=t.canShimVideoOrientation=void 0;const n=i(2),o=a(i(14)),d=i(120),c="a=extmap:4 ";t.canShimVideoOrientation=function(e,t){if("never"===n.getParameters().shimVideoOrientation)return!1;if("ios151"===n.getParameters().shimVideoOrientation){if(!o.IS_IOS)return!1;if(o.IS_SAFARI){if(parseFloat(d.getBrowserInfo().browserVersion)<15.1)return!1}else{if(!o.IS_WECHAT)return!1;if(!navigator.userAgent.match(/OS 15_[1-9]/))return!1}}if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return!1;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);return!!(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1]))},t.shimVideoOrientation=function(e,t){if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);if(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1])){const e=i[1];console.log(`shimVideoOrientation for ${d.getBrowserInfo().browserName} ${d.getBrowserInfo().browserVersion} ${e}`),t.sdp=t.sdp.split(c).join(e+"\r\n"+c)}else console.error("Failed to shimVideoOrientation",i,e.sdp.indexOf(c),i&&t.sdp.indexOf(i[1]))}},function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{d(r.next(e))}catch(e){a(e)}}function o(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AwaitQueue=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return r(this,void 0,void 0,(function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if("function"!=typeof e)throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch(e){}return new Promise(((i,r)=>{const s={task:e,name:t,resolve:i,reject:r,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),1===this.pendingTasks.length&&this.next()}))}))}stop(){if(!this.closed){for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){const e=new Date;return this.pendingTasks.map((t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0})))}next(){return r(this,void 0,void 0,(function*(){const e=this.pendingTasks[0];e&&(yield this.executeTask(e),this.pendingTasks.shift(),this.next())}))}executeTask(e){return r(this,void 0,void 0,(function*(){if(!e.stopped){e.executedAt=new Date;try{const t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}}))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||r(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),s(i(173),t),s(i(169),t),s(i(121),t),s(i(129),t),s(i(174),t),s(i(241),t),s(i(242),t),s(i(172),t)},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const r=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");t.parse=function(e){const t=r.exec(e||"");return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoTrackLow=void 0;const r=i(245),s=i(175),a=i(75),n=i(2),o=i(127),d=i(254),c=i(14);t.VideoTrackLow=class{constructor(e){var t;this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.context=o.get2DContext(this.canvas),this.timer=null,this.lastDrawAt=0,this.lastState="clear",this.high={sender:null,track:null,stream:new MediaStream,videoDom:r.getAutoplayVideo(),width:0,height:0},this.sender=null,this.emptyTrackInfo={track:null,count:0,visible:"unknown"},this.mediaType=e.mediaType,"video"===this.mediaType?(this.WIDTH_MAX=n.getParameters().videoLowMaxWidth,this.HEIGHT_MAX=n.getParameters().videoLowMaxHeight,this.FRAME_RATE=n.getParameters().videoLowFramerate):(this.WIDTH_MAX=n.getParameters().screenLowMaxWidth,this.HEIGHT_MAX=n.getParameters().screenLowMaxHeight,this.FRAME_RATE=n.getParameters().screenLowFramerate),this.stream=this.canvas.captureStream?this.canvas.captureStream(this.FRAME_RATE):null,this.track=(null===(t=this.stream)||void 0===t?void 0:t.getTracks()[0])||null,a.watchTrack(this.track),this.logger=e.logger.getChild((()=>{let e=`low_${this.mediaType} ${this.width}x${this.height}`;return this.high.sender?this.high.sender.track?"live"!==this.high.sender.track.readyState?e+=" HIGH_STATE_"+this.high.sender.track.readyState:(this.high.sender&&this.high.sender.track!==this.high.track&&(e+=" MISMATCH"),this.high.sender.track.enabled||(e+=" muted"),e+=` 【${this.high.sender.track.label}】`):e+=" NO_HIGH_TRACK":e+=" NO_HIGH_SENDER",this.track?"live"!==this.track.readyState&&(e+=" LOW_STATE_"+this.track.readyState):e+=" NO_LOW_TRACK",e})),this.track?this.context?this.timer=s.getRTCTimer().setInterval((()=>{this.drawOneFrame()}),1e3/this.FRAME_RATE):(this.logger.error("CanvasContext无法顺利启动"),this.stream=null,this.track=null):this.logger.error("当前浏览器不支持CanvasTrack")}_correctSize(){if(this.high.sender&&this._bindTrack(this.high.sender.track),this.high.width!==this.high.videoDom.videoWidth||this.high.height!==this.high.videoDom.videoHeight){const e=this.high.videoDom.videoWidth/this.high.videoDom.videoHeight;let t=this.width,i=this.height;const r=e>1?this.WIDTH_MAX:this.HEIGHT_MAX,s=e>1?this.HEIGHT_MAX:this.WIDTH_MAX;e>r/s?(i=Math.floor(this.high.videoDom.videoHeight/this.high.videoDom.videoWidth*r),i>0?t=r:(t=0,i=0)):(i=s,t=Math.floor(this.high.videoDom.videoWidth/this.high.videoDom.videoHeight*s),t>0?i=s:(t=0,i=0)),this.logger.log(`High resize ${this.high.width}x${this.high.height}=>${this.high.videoDom.videoWidth}x${this.high.videoDom.videoHeight}, low: ${this.width}x${this.height}=>${t}x${i}`),this.high.width=this.high.videoDom.videoWidth,this.high.height=this.high.videoDom.videoHeight,this.width=t,this.height=i,this.canvas.width=this.width,this.canvas.height=this.height}}destroy(){var e;this.timer&&(s.getRTCTimer().clearInterval(this.timer),this.timer=null),null===(e=this.track)||void 0===e||e.stop(),this.stream=null}drawOneFrame(){var e,t,i,r;if(this.context)if(this._correctSize(),!0===(null===(e=this.high.track)||void 0===e?void 0:e.enabled)&&!1===(null===(t=this.track)||void 0===t?void 0:t.enabled)&&(this.logger.log("恢复小流mute状态"),this.track.enabled=!0),this.track){if("live"!==this.track.readyState)this.logger.error("小流 Track 已停止");else if(!1===(null===(i=this.high.track)||void 0===i?void 0:i.enabled)){if("frame"===this.lastState||"clear"===this.lastState){this.logger.log("track处在mute状态");let e="black";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.fillRect(0,0,this.width,this.height)}}else if(this.high.videoDom.paused){if("frame"===this.lastState||"clear"===this.lastState){let e="paused";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.high.videoDom.play().catch((e=>{}))}("all"===n.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===n.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank()}else if("live"===(null===(r=this.high.track)||void 0===r?void 0:r.readyState)){if("frame"!==this.lastState){let e="frame";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e}const e=this.high.track.canvas;e?this.context.drawImage(e,0,0,this.width,this.height):this.context.drawImage(this.high.videoDom,0,0,this.width,this.height),this.lastDrawAt=Date.now(),("all"===n.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===n.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank()}else if("frame"===this.lastState){let e="clear";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.clearRect(0,0,this.width,this.height)}}else this.logger.error("无法获取小流 Track")}_checkCanvasBlank(){var e,t;(null===(e=this.high.sender)||void 0===e?void 0:e.track)&&(null===(t=this.sender)||void 0===t?void 0:t.track)&&(this.high.sender.track!==this.emptyTrackInfo.track&&(this.emptyTrackInfo={track:this.high.sender.track,count:0,visible:"unknown"}),"unknown"===this.emptyTrackInfo.visible)&&(this.high.videoDom.paused||4!==this.high.videoDom.readyState||d.isCanvasBlank(this.canvas)?this.emptyTrackInfo.count++:(this.emptyTrackInfo.visible="yes",this.logger.log("_checkCanvasBlank: 小流画面可见",this.emptyTrackInfo.count),this.sender.track!==this.track&&(this.logger.warn("小流切换至低分辨率模式"),this.sender.replaceTrack(this.track))),this.emptyTrackInfo.count>30&&(this.emptyTrackInfo.visible="no",this.sender.track!==this.high.sender.track?(this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，小流切换至相同分辨率模式"),this.sender.replaceTrack(this.high.sender.track)):this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，继续使用相同分辨率模式")))}_bindTrack(e){var t;this.high.track!==e&&(this.high.track&&this.high.stream.removeTrack(this.high.track),e&&this.high.stream.addTrack(e),this.high.track=e,this.high.videoDom.srcObject=this.high.stream,this.high.videoDom.play().catch((e=>{})),(null===(t=this.sender)||void 0===t?void 0:t.track)&&("no"===this.emptyTrackInfo.visible?(this.logger.warn("小流正在使用相同分辨率模式"),this.sender.replaceTrack(e)):this.sender.track!==this.track&&(this.logger.warn("小流正在使用低分辨率模式"),this.sender.replaceTrack(this.track))))}bindSender(e,t){this.high.sender=e,this.sender=t,e?this._bindTrack(e.track):this._bindTrack(null)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getAutoplayVideo=void 0;let r=0;t.getAutoplayVideo=function(){const e=document.createElement("video");return e.style.position="absolute",e.setAttribute("x-webkit-airplay","x-webkit-airplay"),e.setAttribute("playsinline","playsinline"),e.setAttribute("webkit-playsinline","webkit-playsinline"),e.preload="auto",e.className="nertc-video-id-"+r++,e.autoplay=!0,e.muted=!0,e}},function(e,t,i){e.exports="setInterval(() => {\n  self.postMessage('RTCTimer')\n}, 8)\n"},function(e,t,i){e.exports='!function(t){var e={};function s(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=t,s.c=e,s.d=function(t,e,n){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(n,i,function(e){return t[e]}.bind(null,i));return n},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=self;class i{constructor(t){this.signalProbers={},this.pingInterval=t.pingInterval,this.maxRtt=t.maxRtt,this.wsTimeout=t.wsTimeout,this.reconnectionInterval=t.reconnectionInterval;for(let e in t.signalStates)t.signalStates[e]?this.signalProbers[e]=new r(this,t.signalStates[e]):this.error(`Unrecognized ${e} ${t.signalStates}`);this.timer=setInterval(()=>{this.sync()},1e3)}sync(){const t=Date.now(),e={};for(let s in this.signalProbers){const n=this.signalProbers[s].signalState;-1===n.ping.rtt?n.active=!1:n.ping.recvIndex<n.ping.sendIndex&&(n.ping.rtt=Math.max(n.ping.rtt,t-n.ping.lastSentAt)),e[s]=n}n.postMessage({cmd:"sync",data:e})}log(t){n.postMessage({cmd:"log",data:t})}error(t){n.postMessage({cmd:"error",data:t})}handleDebugMessage(t){var e;if("closeWs"===t.data.type)for(let s in this.signalProbers){const n=this.signalProbers[s];n.signalState.index===t.data.index&&(this.error(`Closing #${t.data.index} ${n.wsUrl}`),null===(e=n.ws)||void 0===e||e.close())}if("doNotSendPing"===t.data.type)for(let e in this.signalProbers){const s=this.signalProbers[e];s.signalState.index===t.data.index&&(s.debug.doNotSendPing=!!t.data.value,s.log("doNotSendPing: "+JSON.stringify(t.data)))}}handleOnlineMessage(t){this.log("收到在线事件，探测服务发起重连");for(let t in this.signalProbers){this.signalProbers[t].init()}}}let a=null;n.postMessage({cmd:"ohayo"}),n.onmessage=t=>{const e=t.data;if("init"===e.cmd){if(a)return void a.error("Already Inited");const t=e.data;a=new i(t)}else if("debug"===e.cmd)null==a||a.handleDebugMessage(e);else{if("onOnline"!==e.cmd)return void(null==a||a.log("Invalid message "+JSON.stringify(e)));null==a||a.handleOnlineMessage(e)}};class r{constructor(t,e){this.debug={doNotSendPing:!1},this.signalProbeWorker=t,this.signalState=e;const s=e.wsUrl.split(/\\/\\?|\\?/);this.wsUrl=`wss://${s[0]}/nertc/private/ping${s[1]?"?"+s[1]:""}`,this.pingTimer=setInterval(this.checkState.bind(this),100),this.ws=null,this.init()}init(){this.ws&&this.ws.close(),this.ws=new WebSocket(this.wsUrl),this.ws.onmessage=this.handleWsMessage.bind(this,this.ws),this.ws.onopen=this.handleWsOpen.bind(this,this.ws),this.ws.onclose=this.checkState.bind(this),this.ws.onerror=this.checkState.bind(this),this.signalState.connect.startCnt++,this.signalState.connect.initAt=Date.now(),this.signalState.connect.connectAt=-1,this.signalState.ping.sendIndex=0,this.signalState.ping.recvIndex=0}getTag(){return`[signalProber #${this.signalState.index} rtt${this.signalState.ping.rtt}ms ${this.signalState.connect.successCnt}_${this.signalState.connect.failCnt}]`}log(t){this.signalProbeWorker.log(`${this.getTag()}${t}`)}error(t){this.signalProbeWorker.error(`${this.getTag()}${t}`)}checkState(){const t=Date.now();if(this.ws)if(this.ws.readyState===WebSocket.OPEN)if(this.signalState.ping.sendIndex===this.signalState.ping.recvIndex){if(t-this.signalState.ping.lastSentAt>this.signalProbeWorker.pingInterval){const e=""+t;this.debug.doNotSendPing||this.ws.send(e),this.signalState.ping.lastSentAt=t,this.signalState.ping.lastSentMsg=e,this.signalState.ping.sendIndex++}}else t-this.signalState.ping.lastSentAt>this.signalProbeWorker.maxRtt&&(this.signalState.active=!1,this.signalState.ping.rtt=-1),t-this.signalState.ping.lastSentAt>this.signalProbeWorker.wsTimeout&&(this.log(`timeout: ${t-this.signalState.ping.lastSentAt}ms. Connect cnt:${this.signalState.connect.startCnt} ${this.wsUrl}`),this.ws.close(),this.ws=null,this.init());else this.ws.readyState===WebSocket.CONNECTING||this.ws.readyState!==WebSocket.CLOSED&&this.ws.readyState!==WebSocket.CLOSING||(-1===this.signalState.connect.connectAt||0===this.signalState.ping.recvIndex?(this.ws=null,this.signalState.connect.failCnt++,this.signalState.connect.failCntFromLastSuccess++,this.signalState.connect.failCnt<=3&&this.log(`[checkState]WebSocket Failed count:${this.signalState.connect.failCntFromLastSuccess}. Next try: ${this.getBackoffTime()}ms`)):this.signalState.active&&(this.log(`[checkState]WebSocket CLOSED. Next try: ${this.getBackoffTime()}ms`),this.signalState.active=!1,this.signalState.ping.rtt=-1,this.ws=null,this.signalProbeWorker.sync()));else t-this.signalState.connect.initAt>this.getBackoffTime()&&this.init()}getBackoffTime(){return this.signalProbeWorker.reconnectionInterval*this.signalState.connect.failCntFromLastSuccess}handleWsOpen(t,e){const s=e.data;if(this.ws===t){const t=Date.now();this.signalState.connect.connectAt=t,this.signalState.connect.failCnt<=3&&this.log(`open ${this.signalState.connect.connectAt-this.signalState.connect.initAt}ms ${this.signalState.wsUrl} => ${this.wsUrl}`),this.checkState()}else this.error("Detached ws open "+JSON.stringify(s))}handleWsMessage(t,e){const s=e.data;if(this.ws!==t)return void this.error("Detached ws message "+JSON.stringify(s));if(this.signalState.ping.lastSentMsg!==s)return void(this.signalState.connect.failCnt<=3&&this.error("Unrecognized message "+JSON.stringify(s)));const n=Date.now();this.signalState.ping.recvIndex++,this.signalState.ping.rtt=n-this.signalState.ping.lastSentAt,1===this.signalState.ping.recvIndex&&(this.signalState.connect.successCnt++,this.signalState.connect.failCntFromLastSuccess=0),this.signalState.ping.rtt>this.signalProbeWorker.maxRtt?(this.signalState.ping.rtt=-1,this.signalState.active=!1):this.signalState.ping.rtt>0&&(this.signalState.active=!0)}}}]);'},function(e,t,i){e.exports="const SMOOTHING_FACTOR = 0.8\nconst MINIMUM_VALUE = 0.00001\nregisterProcessor(\n  'vumeter',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      this._leftVolume = 0\n      this._rightVolume = 0\n      this._updateIntervalInMS = 25\n      this._nextUpdateFrame = this._updateIntervalInMS\n      this.port.onmessage = (event) => {\n        if (event.data.updateIntervalInMS) this._updateIntervalInMS = event.data.updateIntervalInMS\n      }\n    }\n\n    get intervalInFrames() {\n      return (this._updateIntervalInMS / 1000) * sampleRate\n    }\n\n    process(inputs, outputs, parameters) {\n      const input = inputs[0]\n\n      // Note that the input will be down-mixed to mono; however, if no inputs are\n      // connected then zero channels will be passed in.\n      if (input.length > 0) {\n        const samplesLeft = input[0]\n        const samplesRight = input[1]\n\n        let sum = 0\n        let rms = 0\n        // Calculated the squared-sum.\n        if (samplesLeft && samplesLeft.length) {\n          for (let i = 0; i < samplesLeft.length; ++i) {\n            sum += samplesLeft[i] * samplesLeft[i]\n          }\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesLeft.length)\n          this._leftVolume = Math.max(rms, this._leftVolume * SMOOTHING_FACTOR)\n          if (this._leftVolume < 1e-10) {\n            this._leftVolume = 0\n          }\n        }\n        if (samplesRight) {\n          sum = 0\n          rms = 0\n          // Calculated the squared-sum.\n          for (let j = 0; j < samplesRight.length; ++j) sum += samplesRight[j] * samplesRight[j]\n\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesRight.length)\n          this._rightVolume = Math.max(rms, this._rightVolume * SMOOTHING_FACTOR)\n          if (this._rightVolume < 1e-10) {\n            this._rightVolume = 0\n          }\n        }\n\n        // Update and sync the volume property with the main thread.\n        this._nextUpdateFrame -= samplesLeft.length\n        if (this._nextUpdateFrame < 0) {\n          this._nextUpdateFrame += this.intervalInFrames\n          let volume = Math.max(this._leftVolume, this._rightVolume)\n          if (!(volume > -1)) {\n            if (this._leftVolume > -1) {\n              volume = this._leftVolume\n            } else if (this._rightVolume > -1) {\n              volume = this._rightVolume\n            }\n          }\n          if (samplesRight) {\n            this.port.postMessage({\n              left: this._leftVolume,\n              right: this._rightVolume,\n              volume: volume\n            })\n          } else {\n            this.port.postMessage({\n              volume: volume\n            })\n          }\n        }\n      }\n\n      return true\n    }\n  }\n)\n"},function(e,t,i){e.exports=";(function () {\n  const intervalIds = {}\n  const timeoutIds = {}\n\n  // 监听message 开始执行定时器或者销毁\n  self.onmessage = function onMsgFunc(e) {\n    switch (e.data.command) {\n      case 'interval:start': // 开启定时器\n        const intervalId = setInterval(function () {\n          postMessage({\n            message: 'interval:tick',\n            id: e.data.id\n          })\n        }, e.data.interval)\n\n        postMessage({\n          message: 'interval:started',\n          id: e.data.id\n        })\n\n        intervalIds[e.data.id] = intervalId\n        break\n      case 'interval:clear': // 销毁\n        clearInterval(intervalIds[e.data.id])\n\n        postMessage({\n          message: 'interval:cleared',\n          id: e.data.id\n        })\n\n        delete intervalIds[e.data.id]\n        break\n\n      case 'timeout:start': // 开启定时器\n        const timeoutId = this.setTimeout(function () {\n          postMessage({\n            message: 'timeout:tick',\n            id: e.data.id\n          })\n        }, e.data.timeout)\n\n        postMessage({\n          message: 'timeout:started',\n          id: e.data.id\n        })\n\n        timeoutIds[e.data.id] = timeoutId\n        break\n      case 'timeout:clear': // 销毁\n        clearTimeout(timeoutIds[e.data.id])\n\n        postMessage({\n          message: 'timeout:cleared',\n          id: e.data.id\n        })\n\n        delete timeoutIds[e.data.id]\n        break\n    }\n  }\n})()\n"},function(e,t,i){e.exports="/**\n * 模拟一个AI Worklet\n * 其实是个Delay\n */\nregisterProcessor(\n  'audioAIProcessor',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      // 尚未接入AI，以延迟1秒为例\n      this.inputSamplesHistory = []\n      this.delayMs = 3000\n    }\n\n    process(inputs, outputs, parameters) {\n      const now = Date.now()\n      const input = inputs[0].map((channel) => {\n        return channel.slice(0)\n      })\n      const output = outputs[0]\n      this.inputSamplesHistory.push({\n        input,\n        ms: now\n      })\n      const firstItem = this.inputSamplesHistory[0]\n      if (firstItem) {\n        if (now - firstItem.ms > this.delayMs) {\n          this.inputSamplesHistory.shift()\n          output.forEach((channel, index) => {\n            for (let i = 0; i < channel.length; i++) {\n              if (firstItem.input[index] && firstItem.input[index][i]) {\n                channel[i] = firstItem.input[index][i]\n              }\n            }\n          })\n        }\n      }\n      return true\n    }\n  }\n)\n"},function(e,t,i){e.exports="/* eslint-disable */\nregisterProcessor(\n  'audioWorkletAgentProcessor',\n  class extends AudioWorkletProcessor {\n    // Float32Array[][][]\n    constructor() {\n      super()\n      this.inputDataSeq = []\n      this.bufferDrop = 0\n      this.bufferDropSum = 0\n      this.bufferDropTime = 0\n      this.port.onmessage = (event) => {\n        if (event.data.type === 'outputData') {\n          this.inputDataSeq.push(event.data.data)\n          this.bufferDrop++\n        }\n      }\n    }\n\n    process(inputs, outputs, parameters) {\n      this.port.postMessage({\n        type: 'rawinputs',\n        inputs\n      })\n\n      const inputData = this.inputDataSeq.shift()\n      if (inputData && outputs[0] && !this.bufferDropSum) {\n        if (outputs[0][1]) {\n          outputs[0][1].set(inputData[0])\n        }\n        outputs[0][0].set(inputData[0])\n      }\n      if (this.bufferDrop > 200) {\n        this.bufferDropSum += this.bufferDrop\n        this.bufferDropTime = currentTime\n      }\n      this.bufferDrop = 0\n      if (this.bufferDropTime && currentTime - this.bufferDropTime > 0.3) {\n        this.inputDataSeq = []\n        this.port.postMessage({\n          type: 'bufferDrop',\n          cnt: this.bufferDropSum\n        })\n        this.bufferDropTime = 0\n        this.bufferDropSum = 0\n      }\n      return true\n    }\n  }\n)\n"},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimCanvas=t.canShimCanvas=void 0;const n=i(2),o=i(155),d=a(i(14));t.canShimCanvas=function(){let e=!1;if("never"===n.getParameters().shimCanvas)e=!1;else if("always"===n.getParameters().shimCanvas)e=!0;else if("ios151"===n.getParameters().shimCanvas)return!!(d.IS_IOS&&navigator.userAgent.indexOf(" OS 15_1")>-1);return e},t.shimCanvas=function(e){let t=new o.RTCCanvas("canvas");const i=document.createElement("video");let r,s=t._canvas;r="getSettings"in MediaStreamTrack.prototype?e.getSettings():e.getConstraints();let a=r.frameRate||15,n=t._ctx;const d=new MediaStream([e]);if(i.srcObject=d,i.setAttribute("playsinline","playsinline"),i.setAttribute("muted","muted"),i.setAttribute("autoplay","autoplay"),i.className="nertc-ios-shim",i.style.display="none",i.onresize=()=>{i.videoWidth&&i.videoHeight&&t.setSize(i.videoWidth,i.videoHeight)},n){const t=s.captureStream(a).getVideoTracks()[0];Object.defineProperty(t,"enabled",{get:()=>e.enabled,set(t){console.warn("Delegate cameraTrack enabled",t),e.enabled=t}});const r=setInterval((()=>{i.paused?i.play():"ended"===t.readyState?("live"===e.readyState&&(console.warn("canvasTrack已停止，回收videoTrack中"),e.stop()),clearInterval(r),document.body.removeChild(i)):n.drawImage(i,0,0)}),1e3/a);return document.body.appendChild(i),t}throw new Error("Ctx not supported")}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.syncTrackState=void 0;const r=new(i(58).Logger)({tagGen:()=>"syncTrackState"}),s=[];setInterval((()=>{for(let e=s.length-1;e>=0;e--){const t=s[e];if("ended"===t.srcTrack.readyState)return"live"===t.destTrack.readyState&&(r.log(`同步MediaStreamTrack关闭状态。【${t.srcTrack.label}】=>【${t.destTrack.label}】`),t.destTrack.stop()),void s.splice(e,1);if("bidirectional"===t.direction&&"ended"===t.destTrack.readyState)return"live"===t.srcTrack.readyState&&(r.warn(`同步MediaStreamTrack关闭状态。【${t.destTrack.label}】=>【${t.srcTrack.label}】`),t.srcTrack.stop()),void s.splice(e,1);t.srcTrack.enabled!==t.enabled&&(t.enabled=t.srcTrack.enabled,t.srcTrack.enabled!==t.destTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.destTrack.enabled=t.srcTrack.enabled)),"bidirectional"===t.direction&&t.destTrack.enabled!==t.enabled&&(t.enabled=t.destTrack.enabled,t.destTrack.enabled!==t.srcTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.srcTrack.enabled=t.destTrack.enabled))}}),1e3),t.syncTrackState=function(e,t,i){s.push({srcTrack:e,destTrack:t,direction:i,enabled:e.enabled})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isCanvasBlank=void 0;let r=null;t.isCanvasBlank=function(e){r||(r=document.createElement("canvas")),r.width=e.width,r.height=e.height;let t=e.toDataURL()===r.toDataURL();return t&&console.error("result",t,e),t}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.stringify=void 0;const r=i(145),s=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;let a,n;const o={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};let d;function c(e){return s.lastIndex=0,s.test(e)?`"${e.replace(s,(e=>{const t=o[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))}"`:`"${e}"`}t.stringify=function(e,t,i){let s;if(a="",n="","number"==typeof i)for(s=0;s<i;s+=1)n+=" ";else"string"==typeof i&&(n=i);if(d=t,t&&"function"!=typeof t&&!Array.isArray(t))throw new Error("JSON.stringify");return function e(t,i){let s,o,l,u;const h=a;let p,m=i[t];const f=null!=m&&m instanceof r.SimpleBig;switch(m&&"object"==typeof m&&"function"==typeof m.toJSON&&(m=m.toJSON(t)),"function"==typeof d&&(m=d.call(i,t,m)),typeof m){case"string":return c(m);case"number":return isFinite(m)?String(m):"null";case"boolean":case"bigint":return String(m);case"object":if(f)return m.toString();if(!m)return"null";if(a+=n,p=[],"[object Array]"===Object.prototype.toString.apply(m)){for(u=m.length,s=0;s<u;s+=1)p[s]=e(s,m)||"null";return l=0===p.length?"[]":a?`[\n${a}${p.join(",\n"+a)}\n${h}]`:`[${p.join(",")}]`,a=h,l}if(Array.isArray(d))for(u=d.length,s=0;s<u;s+=1)"string"==typeof d[s]&&(o=d[s],l=e(o,m),l&&p.push(c(o)+(a?": ":":")+l));else Object.keys(m).forEach((t=>{const i=e(t,m);i&&p.push(c(t)+(a?": ":":")+i)}));return l=0===p.length?"{}":a?`{\n${a}${p.join(",\n"+a)}\n${h}}`:`{${p.join(",")}}`,a=h,l;default:return""}}("",{"":e})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.JSONParse=void 0;const r=/(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])/,s=/(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)/;t.JSONParse=function(e){const t={strict:!1,storeAsString:!0,alwaysParseAsBig:!1,useNativeBigInt:!0,protoAction:"error",constructorAction:"error"};if(null!=e){if(!0===e.strict&&(t.strict=!0),!0===e.storeAsString&&(t.storeAsString=!0),t.alwaysParseAsBig=!0===e.alwaysParseAsBig&&e.alwaysParseAsBig,t.useNativeBigInt=!0===e.useNativeBigInt&&e.useNativeBigInt,void 0!==e.constructorAction){if("error"!==e.constructorAction&&"ignore"!==e.constructorAction&&"preserve"!==e.constructorAction)throw new Error('Incorrect value for constructorAction option, must be "error", "ignore" or undefined but passed '+e.constructorAction);t.constructorAction=e.constructorAction}if(void 0!==e.protoAction){if("error"!==e.protoAction&&"ignore"!==e.protoAction&&"preserve"!==e.protoAction)throw new Error('Incorrect value for protoAction option, must be "error", "ignore" or undefined but passed '+e.protoAction);t.protoAction=e.protoAction}}let i,a;const n={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};let o;const d=function(e){throw{name:"SyntaxError",message:e,at:i,text:o}},c=function(e){return e&&e!==a&&d(`Expected '${e}' instead of '${a}'`),a=o.charAt(i),i+=1,a},l=function(){let e,i="";for("-"===a&&(i="-",c("-"));a>="0"&&a<="9";)i+=a,c();if("."===a)for(i+=".";c()&&a>="0"&&a<="9";)i+=a;if("e"===a||"E"===a)for(i+=a,c(),"-"!==a&&"+"!==a||(i+=a,c());a>="0"&&a<="9";)i+=a,c();if(e=+i,isFinite(e))return i.length>15?t.storeAsString?i:t.useNativeBigInt?BigInt(i):null:t.alwaysParseAsBig?t.useNativeBigInt?BigInt(e):null:e;d("Bad number")};function u(){let e,t,r,s="";if('"'===a){let d=i;for(;c();){if('"'===a)return i-1>d&&(s+=o.substring(d,i-1)),c(),s;if("\\"===a){if(i-1>d&&(s+=o.substring(d,i-1)),c(),"u"===a){for(r=0,t=0;t<4&&(e=parseInt(c(),16),isFinite(e));t+=1)r=16*r+e;s+=String.fromCharCode(r)}else{if("string"!=typeof n[a])break;s+=n[a]}d=i}}}d("Bad string")}const h=function(){for(;a&&a<=" ";)c()};function p(){switch(h(),a){case"{":return m();case"[":return function(){const e=[];if("["===a){if(c("["),h(),"]"===a)return c("]"),e;for(;a;){if(e.push(p()),h(),"]"===a)return c("]"),e;c(","),h()}}d("Bad array")}();case'"':return u();case"-":return l();default:return a>="0"&&a<="9"?l():function(){switch(a){case"t":return c("t"),c("r"),c("u"),c("e"),!0;case"f":return c("f"),c("a"),c("l"),c("s"),c("e"),!1;case"n":return c("n"),c("u"),c("l"),c("l"),null}d(`Unexpected '${a}'`)}()}}const m=function(){let e;const i=Object.create(null);if("{"===a){if(c("{"),h(),"}"===a)return c("}"),i;for(;a;){if(e=u(),h(),c(":"),!0===t.strict&&Object.hasOwnProperty.call(i,e)&&d(`Duplicate key "${e}"`),!0===r.test(e)?"error"===t.protoAction?d("Object contains forbidden prototype property"):"ignore"===t.protoAction?p():i[e]=p():!0===s.test(e)?"error"===t.constructorAction?d("Object contains forbidden constructor property"):"ignore"===t.constructorAction?p():i[e]=p():i[e]=p(),h(),"}"===a)return c("}"),i;c(","),h()}}d("Bad object")};return function(e,t){let r;return o=""+e,i=0,a=" ",r=p(),h(),a&&d("Syntax error"),"function"==typeof t?function e(i,r){let s;const a=i[r];return a&&"object"==typeof a&&Object.keys(a).forEach((t=>{s=e(a,t),void 0!==s?a[t]=s:delete a[t]})),t.call(i,r,a)}({"":r},""):r}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Meeting=void 0;const s=i(11),a=i(57),n=i(151),o=r(i(12)),d=r(i(13)),c=i(124),l=i(145);class u extends s.EventEmitter{constructor(e){super(),this.info={turn:!0,relay:!1,forward:!1,secure:!0},this._reset(),this.adapterRef=e.adapterRef,this.sdkRef=e.sdkRef,this.logger=e.adapterRef.logger.getChild((()=>{var t,i,r;let s="meeting";return this.info.secure||(s+=" INSECURE"),this.info.forward&&(s+=" FORWARD"),this.info.turn||(s+=" NOTURN"),(null===(r=null===(i=null===(t=e.adapterRef.instance)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)&&(s+=" PRIVATE"),s}))}_reset(){}async getCloudProxyInfo(e){const{appkey:t,channelName:i,uid:r,token:s=""}=e;this.adapterRef.logger.log("getCloudProxyInfo() url: ",a.getCloudProxyInfoUrl);let u=a.getCloudProxyInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer&&(u=this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer,this.adapterRef.logger.log("getCloudProxyInfo() 私有化配置cloudProxyServer: ",u));let h=Date.parse(new Date)/1e3;try{const e=await this.adapterRef.lbsManager.ajax({url:u,type:"POST",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new l.SimpleBig(r),appkey:t,channelName:i,secureType:s?"1":"2",osType:"4",version:a.SDK_VERSION+".0"||!1,curtime:""+h,checksum:n(t+"."+r+"."+h),proxy:"1",needIPV6:"0"}});if(this.adapterRef.logger.log("getCloudProxyInfo() 获取到云代理服务相关信息: ",c.JSONBigStringify(e,null," ")),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:200===e.code?0:-1,param:{channelName:i,uid:r,appkey:t,token:s,reason:e.code}}),200===e.code){this.adapterRef.channelStatus="join";const{wsProxyArray:t,mediaProxyArray:i,mediaProxyToken:s,cname:a,curTime:n}=e;this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() webSocketProxyServer: ",this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer),this.adapterRef.proxyServer.wsProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer]):this.adapterRef.proxyServer.wsProxyArray=t,this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer?(this.adapterRef.logger.warn("getCloudProxyInfo() mediaProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer),this.adapterRef.proxyServer.mediaProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer],this.adapterRef.proxyServer.mediaProxyToken="netease",this.adapterRef.proxyServer.credential="netease"):(this.adapterRef.proxyServer.mediaProxyArray=i,this.adapterRef.proxyServer.mediaProxyToken=s,this.adapterRef.proxyServer.credential=r+"/"+n)}else this.adapterRef.logger.log("getCloudProxyInfo() 云代理服务相关信息获取失败, 回滚")}catch(t){throw this.adapterRef.logger.log("getCloudProxyInfo() 网络请求异常:",t.name,t.message,t),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiFrequencyControl({name:"startProxyServer",code:-1,param:Object.assign(Object.assign({},e),{reason:t.message})}),new d.default({code:o.default.NETWORK_REQUEST_ERROR,message:t.message})}}async joinChannel(e){try{this.adapterRef.proxyServer.enable&&await this.getCloudProxyInfo(e)}catch(e){throw e}const{appkey:t,channelName:i,uid:r,wssArr:s=null,sessionMode:u="meeting",joinChannelRecordConfig:h,joinChannelLiveConfig:p,token:m="",permKey:f="",getChanneInfoResponse:g}=e;let v=Date.now(),_=+new Date,y=a.getChannelInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.channelServer&&(y=this.adapterRef.instance._params.neRtcServerAddresses.channelServer,this.logger.log("jion() 私有化配置的 getChannelInfoUrl: ",y)),Object.assign(this.adapterRef.channelInfo,{uid:r,sessionMode:u,appkey:t});try{let S=g;S||(this.adapterRef.state.getChannelInfoRtt=0,S=await this.adapterRef.lbsManager.ajax({url:y,type:"POST",contentType:"application/x-www-form-urlencoded",header:{"Session-Id":this.adapterRef.deviceId||""},data:{uid:new l.SimpleBig(r),appkey:t,platformType:16,permKeySecret:f,channelName:i,secureType:m?"1":"2",osType:"4",mode:2,netType:"0",version:a.SDK_VERSION+".0"||!1,curtime:_,checksum:m||n(t+"."+r+"."+_),webrtc:1,nrtcg2:1,t1:v}}),this.adapterRef.state.getChannelInfoTime=Date.now(),this.adapterRef.state.getChannelInfoRtt||(this.adapterRef.state.getChannelInfoRtt=this.adapterRef.state.getChannelInfoTime-_));let R=!("0"==r||"0"!=r&&!r);if(this.info.secure=!!m,"string"==typeof S?(this.logger.warn("join() 返回值类型为string，应为object。尝试进行强制类型转换。",S),S=c.JSONBigParse(S)):this.logger.log("join() 获取到房间信息:",c.JSONBigStringify(S,null," ")),200===S.code){this.adapterRef.channelStatus="join";const{ips:a,time:n}=S;a&&a.uid||this.logger.warn("join 加入频道时服务端未返回uid");const o=S.config&&S.config.quality_level_limit||16;this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now();let d=a.webrtcarray&&a.webrtcarray.length&&a.webrtcarray[0];if(d&&this.adapterRef.proxyServer.wsProxyArray){const e=a.turnaddrs&&a.turnaddrs.length&&a.turnaddrs[0][0];let t=e.split(":").length>1?e.split(":")[1]:"",i=d.split("/").length>1?d.split("/")[1]:"";this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer&&(t=i.split(":")[1]),i&&t?this.adapterRef.proxyServer.wsProxyArray=this.adapterRef.proxyServer.wsProxyArray.map((e=>e+"/"+i.split(":")[0]+":"+t)):this.adapterRef.logger.log(`join 云代理无法获取到代理信息, serverurl: ${i}, port: ${t}`)}Object.assign(this.adapterRef.channelInfo,{cid:+S.cid,permKey:f,token:S.token,turnToken:a.token,channelName:i,wssArr:s||this.adapterRef.proxyServer.enable&&this.adapterRef.proxyServer.wsProxyArray||a.webrtcarray||[],relayaddrs:this.adapterRef.proxyServer.mediaProxyArray||a.relayaddrs||null,relaytoken:this.adapterRef.proxyServer.mediaProxyToken||a.relaytoken||null,wssArrIndex:0,maxVideoQuality:o,netDetect:!1},{uid:R?r:a.uid,sessionMode:u,appkey:t}),e.uid=e.uid?e.uid:this.adapterRef.channelInfo.uid,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.token=S.token,this.adapterRef.channelInfo.T4=Date.now();let c=this.adapterRef.channelInfo.T4-n.t1-(n.t3-n.t2);return this.adapterRef.channelInfo.clientNtpTime=n.t3+Math.round(c/2),this.adapterRef.instance.setSessionConfig(Object.assign({maxVideoQuality:o},p,h)),this.info.relay=a.relayaddrs&&a.relayaddrs.length>0,this.info.turn=a.turnaddrs&&a.turnaddrs.length>0,this.adapterRef.instance.startSession()}{let e="join() 服务器不允许加入房间, code "+S.code;return S.desc?e=S.desc:4003===S.code&&(e="房间人数超过最大值。"),this.logger.error(e),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:h.recordAudio,v_record:h.recordVideo,record_type:h.recordType,host_speaker:h.isHostSpeaker,result:S.code,permKey:this.adapterRef.channelInfo.permKey,serverIp:S.ips&&S.ips.turnaddrs&&S.ips.turnaddrs.length&&S.ips.turnaddrs[0],desc:e}),Promise.reject(new d.default({code:o.default.SERVER_AUTH_ERROR,extraCode:S.code,message:e}))}}catch(e){throw this.logger.log("joing() 获取到房间信息错误:",e.name,e.message),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:h.recordAudio,v_record:h.recordVideo,record_type:h.recordType,host_speaker:h.isHostSpeaker,result:-1,desc:`join() 内部错误: ${e.name}, ${e.message}`,serverIp:""}),new d.default({code:e.getCode&&e.getCode()||o.default.JOIN_FAILED,message:e.getCode&&e.getMessage()||`join() 内部错误: ${e.name}, ${e.message}`})}}leaveChannel(){return this.adapterRef._signalling?this.adapterRef._signalling.doSendLogout().then((()=>(this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.stopSession()))):Promise.resolve()}async addTasks(e){const{rtmpTasks:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("addTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks`;for(let r=0;r<t.length;r++){t[r].hostUid=new l.SimpleBig(this.adapterRef.channelInfo.uid),t[r].version=1,this.logger.log("addTasks() rtmpTask: ",c.JSONBigStringify(t[r]));const s=t[r].layout;s.users.forEach((e=>{"string"==typeof e.uid&&(e.uid=new l.SimpleBig(e.uid))}));try{const e=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:t[r].taskId,streamUrl:t[r].streamUrl,record:t[r].record,hostUid:t[r].hostUid,layout:s,config:t[r].config,extraInfo:t[r].extraInfo||""}});if(200!==e.code)return this.logger.error(`addTasks() 添加第 ${r} 个推流任务失败: `,e),Promise.reject(new d.default({code:o.default.ADD_TASK_FAILED_ERROR,extraCode:e.code,message:"addTasks() 添加推流任务失败: "+e.code}));this.logger.log(`addTasks() 添加第 ${r} 个推流任务完成`)}catch(e){return this.logger.error("addTasks: ",e.name,e.message),Promise.reject(new d.default({code:o.default.ADD_TASK_FAILED_ERROR,message:"addTasks() 内部错误: $e.message}"}))}}}async deleteTasks(e){const{taskIds:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("deleteTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks/delete`;for(let r=0;r<t.length;r++){this.logger.log("deleteTasks() taskId: ",t[r]);try{const e=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{taskId:t[r]}});return 200===e.code?(this.logger.log("删除推流任务完成"),Promise.resolve()):(this.logger.log("删除推流任务请求失败:",c.JSONBigStringify(e)),Promise.reject(new d.default({code:o.default.DELETE_TASK_FAILED_ERROR,extraCode:e.code,message:"deleteTasks() 删除推流任务失败: "+e.code})))}catch(e){return this.logger.error("deleteTasks发生错误: ",e.name,e.message),Promise.reject(new d.default({code:o.default.DELETE_TASK_FAILED_ERROR,message:"deleteTasks() 内部错误: $e.message}"}))}}}async updateTasks(e){const{rtmpTasks:t=[]}=e;let i=a.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("updateTasks() 私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/task/update`;for(let r=0;r<t.length;r++){const s=t[r].layout;s.users.forEach((e=>{"string"==typeof e.uid&&(e.uid=new l.SimpleBig(e.uid))}));try{const e=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken,"Session-Id":this.adapterRef.deviceId||""},data:{version:1,taskId:t[r].taskId,streamUrl:t[r].streamUrl,record:t[r].record,hostUid:new l.SimpleBig(this.adapterRef.channelInfo.uid),layout:s,config:t[r].config}});return 200===e.code?(this.logger.log("updateTasks() 更新推流任务完成"),Promise.resolve()):(this.logger.log("() 更新推流任务失败：",c.JSONBigStringify(e)),Promise.reject(new d.default({code:o.default.UPDATE_TASKS_FAILED_ERROR,extraCode:e.code,message:"updateTasks() 更新推流任务失败: "+e.code})))}catch(e){return this.logger.error("updateTasks 发生错误: ",e.name,e.message),Promise.reject(new d.default({code:o.default.UPDATE_TASKS_FAILED_ERROR,message:"updateTasks() 内部错误: $e.message}"}))}}}destroy(){this.logger.log("清除 meeting"),this._reset()}}t.Meeting=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.processManager=void 0;const r=i(59),s=i(2);t.processManager=new class{constructor(){this.id=new Date;const e=`${r.generateUUID().substr(0,4)}-${(new Date).toISOString().replace(/[^\d]/g,"")}`;if(this.processId="proc-"+e,!s.getParameters().reportPageBrowserId)return this.pageId="",void(this.browserId="");try{let t=sessionStorage.getItem("NERTC_PAGEID");t||(t="page-"+e,sessionStorage.setItem("NERTC_PAGEID",t)),this.pageId=t}catch(e){this.pageId=""}try{let t=sessionStorage.getItem("NERTC_BROWSERID");t||(t="brow-"+e,localStorage.setItem("NERTC_BROWSERID",t)),this.browserId=t}catch(e){this.browserId=""}}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReport=void 0;const s=i(11),a=i(57),n=r(i(260)),o=r(i(261)),d=i(277),c=i(2),l=i(120),u=i(280),h=i(178),p=Date.now();class m extends s.EventEmitter{constructor(e){var t,i;super(),this._reset(),this.heartbeat_=-1,this.wsTransport_=null,this.sdkRef=e.sdkRef,this.adapterRef=e.adapterRef,this.isReport=e.isReport,this.appKey=this.adapterRef.instance._params.appkey||this.adapterRef.channelInfo&&this.adapterRef.channelInfo.appKey||"",this.reportData={appkey:this.appKey,cid:(null===(t=this.adapterRef)||void 0===t?void 0:t.channelInfo.cid)||0,uid:""+(null===(i=this.adapterRef)||void 0===i?void 0:i.channelInfo.uid)||"0",browser:l.getBrowserInfo().browserName,platform:l.getOSInfo().osName,timestamp:0,local:{},remote:{}},this.stats=new d.GetStats({adapterRef:this.adapterRef})}_reset(){this.stats&&this.stats.destroy(),this.stats=null,this.stopHeartbeat()}stop(){this.stats&&this.stats.stop()}start(){var e,t,i;this.reportData.uid=""+(null===(e=this.adapterRef)||void 0===e?void 0:e.channelInfo.uid)||"0",this.reportData.cid=null===(t=this.adapterRef)||void 0===t?void 0:t.channelInfo.cid;let r=null===(i=this.adapterRef)||void 0===i?void 0:i.deviceId,s=u(`0${p}${a.SDK_VERSION}webwebrtc${r}40f5a1a1871e46089e1e5139a779dd77`),n=`${this.adapterRef.instance._params.neRtcServerAddresses.statisticsWebSocketServer||"wss://statistic.live.126.net/lps-websocket/websocket/collect"}?deviceId=${r}&isTest=0&sdkVer=${a.SDK_VERSION}&sdktype=webrtc&timestamp=${p}&platform=web&checkSum=${s}`,d=window;c.getParameters().disableAllReports||(this.wsTransport_=d.wsTransport=new o.default({url:n,adapterRef:this.adapterRef}),this.wsTransport_.init(),this.startHeartbeat())}startHeartbeat(){-1===this.heartbeat_&&(this.adapterRef.logger.log("startHeartbeat..."),this.heartbeat_=n.default.setInterval(this.doHeartbeat.bind(this),c.getParameters().doHeartbeatInterval))}stopHeartbeat(){-1!==this.heartbeat_&&(n.default.clearInterval(this.heartbeat_),this.heartbeat_=-1)}async doHeartbeat(){var e;try{let t=await(null===(e=this.stats)||void 0===e?void 0:e.getAllStats());this.isReport&&(null==t?void 0:t.times)%2==0&&(this.reportData.local=null==t?void 0:t.local,this.reportData.remote=null==t?void 0:t.remote,this.reportData.timestamp=(new Date).getTime(),this.wsTransport_.sendPB(this.reportData)),(null==t?void 0:t.times)%60==0&&this.sendDataReportHeartbeat()}catch(e){this.adapterRef.logger.warn("数据上报出现异常: ",e.message)}}sendDataReportHeartbeat(){var e;let t=new h.DataReport({adapterRef:this.adapterRef});t.setHeartbeat({name:"setHeartbeat",uid:""+(null===(e=this.adapterRef)||void 0===e?void 0:e.channelInfo.uid)||"0",cid:""+this.adapterRef.channelInfo.cid}),t.send()}destroy(){this.sendDataReportHeartbeat(),this.stop(),this._reset(),this.isReport&&this.wsTransport_&&this.wsTransport_.close()}}t.StatsReport=m},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(59),s=new class{constructor(){this.intervalMap_=new Map}setInterval(e,t,i=!0){const s=r.generateUUID();let a=Date.now(),n=a;this.intervalMap_.set(s,{rafId:null,timeoutId:null,onVisibilityChange:null});const o=()=>{if(i&&document.hidden){e();const i=setTimeout(o,t);this.setTimeoutId(s,i),a=Date.now(),n=a}else{n=Date.now(),n-a>=t&&(a=n,e());const i=requestAnimationFrame(o);this.setRafId(s,i)}},d=requestAnimationFrame(o);if(this.setRafId(s,d),i){const e=()=>{if(document.hidden){const e=Date.now()-a;if(e>=t)o();else{const i=setTimeout(o,t-e);this.setTimeoutId(s,i)}}};document.addEventListener("visibilitychange",e),this.setOnVisibilityChange(s,e)}return s}clearInterval(e){if(this.intervalMap_.has(e)){const{rafId:t,timeoutId:i,onVisibilityChange:r}=this.intervalMap_.get(e);cancelAnimationFrame(t),clearTimeout(i),document.removeEventListener("visibilitychange",r),this.intervalMap_.delete(e)}}setTimeoutId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t}}setRafId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t}}setOnVisibilityChange(e,t){this.intervalMap_.has(e)&&(this.intervalMap_.get(e).onVisibilityChange=t)}};t.default=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const n=i(11),o=a(i(179)),d=i(59),c=i(276),l=i(2);let u=new Uint8Array(1);u[0]=10;const h=u;t.default=class{constructor(e){this.lastLogTime=0,this.cachedLogs=[],this.textEncoder=new TextEncoder,this.url_=e.url,this.socket_=null,this.isConnected_=!1,this.isConnecting_=!1,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.reconnectionTimer_=-1,this.reconnectionCount_=0,this.emitter_=new n.EventEmitter,this.adapterRef=e.adapterRef,this.logger=this.adapterRef.logger.getChild((()=>"wsTransport"))}init(){if(l.getParameters().disableLBSService)this.logger.log("connect to url: "+this.url_);else{const e=this.adapterRef.lbsManager.getURLSettings(this.url_)[0];e&&e.url!==this.url_?(this.logger.log(`使用线路变更：From【${this.url_} 】to【${e.url} 】`),this.url_=e.url):this.logger.log(`使用线路： 【${this.url_}】`)}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_)}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1;const t=e.target.url;this.logger.log(`websocket[${t}] is connected`),this.urlSetting&&(this.logger.debug(`markFinish success seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.startPingPong()}onclose(e){const t=e.target.url,i=e.target===this.socket_;this.logger.log(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),this.socket_&&e.target===this.socket_&&(this.isConnected_=!1,e.wasClean&&1e3===e.code?this.close():(this.logger.warn(`onclose code:${e.code} reason:${e.reason}`),this.socket_.onclose=()=>{},this.socket_.close(4001),this.socket_=null,this.reconnect()))}onerror(e){const t=e.target.url;this.logger.warn(`websocket[${t}] error observed`),this.urlSetting&&(this.logger.debug(`markFinish fail seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.isConnected_?e.target===this.socket_&&(this.isConnected_=!1,this.socket_=null,this.reconnect()):this.reconnect(),this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){this.isConnected_&&e&&e.data&&(11===JSON.parse(e.data).action&&this.emit(11,e),this.clearReconnectionTimer())}isConnected(){return this.isConnected_}sendPB(e){var t;if(this.isConnected_){const i=this.createPBMessage(e);1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(i)}}sendPing(e){var t;this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(e)}async sendLog(e){var t,i;const r=Math.max(this.lastLogTime+1,Date.now());this.lastLogTime=r;try{this.cachedLogs.length&&this.cachedLogs[this.cachedLogs.length-1].data[0].replace("[NERTC","[缓存][NERTC")}catch(e){}if(this.cachedLogs.push({time:r,data:e}),this.cachedLogs.length>500&&this.cachedLogs.shift(),this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&(null===(i=this.adapterRef.channelInfo)||void 0===i?void 0:i.cid)){const e=this.cachedLogs;this.cachedLogs=[];const t=50,i=Math.ceil(e.length/t);for(let r=0;r<i;r++){const i=r*t,s=i+t,a=e.slice(i,s);await this.delay(100),this.sendBatch(a)}}}delay(e){return new Promise((t=>setTimeout(t,e)))}sendBatch(e){for(let t of e){const i=Object.assign({uid:this.adapterRef.channelInfo.uid,cid:this.adapterRef.channelInfo.cid},t);try{const e=this.textEncoder.encode(JSON.stringify(i));let t=[5,1,1,1,2,0,0,0],r=Uint8Array.from(t.concat(Array.from(e)));this.socket_.send(r)}catch(e){}}}createPBMessage(e){let t=o.Root.fromJSON(c).lookupType("WebrtcStats"),i=t.create(e),r=t.encode(i).finish();return Uint8Array.from([4,1,1,1,3,0,0,0].concat(Array.from(r)))}async startPingPong(){try{if(-1!==this.pingPongTimeoutId_)return;await this.ping(),this.pingPongTimeoutId_=setTimeout((()=>{this.pingPongTimeoutId_=-1,this.startPingPong()}),1e4)}catch(e){this.logger.log("ping-pong failed, start reconnection"),this.clearSocket(),this.reconnect()}}stopPingPong(){this.logger.log("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1}ping(){return new Promise(((e,t)=>{if(-1!==this.pingTimeoutId_)return e();this.sendPing(h),this.once(11,(()=>{clearTimeout(this.pingTimeoutId_),this.pingTimeoutId_=-1,e()})),this.pingTimeoutId_=setTimeout((()=>{this.pingTimeoutId_=-1,t()}),1e4)}))}reconnect(){var e,t,i;if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.logger.log("websocket is reconnecting");if(this.isConnecting_=!0,this.reconnectionCount_++,null===(i=null===(t=null===(e=this.adapterRef.instance)||void 0===e?void 0:e._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return void this.logger.log("WebSocket不启用备用线路：当前为私有化配置");{const e=this.adapterRef.lbsManager.getURLSettings(this.url_),t=e[this.reconnectionCount_%e.length];t.url!==this.url_&&(this.logger.warn(`${t.seqId} WebSocket切换备用线路 ${this.url_} => ${t.url}`),this.url_=t.url,this.urlSetting=t)}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);const r=d.getReconnectionTimeout(this.reconnectionCount_);this.reconnectionTimer_=setTimeout((()=>{this.isConnecting_=!1,this.clearReconnectionTimer(),this.socket_&&this.unbindSocket(this.socket_),this.socket_=null,this.reconnect()}),r)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}once(e,t,i){this.emitter_.once(e,t,i)}emit(e,t,i){this.emitter_.emit(e,t,i)}clearSocket(){this.socket_&&this.unbindSocket(this.socket_),this.isConnected_=!1,this.isConnecting_=!1,this.socket_=null}async close(){var e;await this.delay(1e3),this.logger.log("close websocket"),this.clearReconnectionTimer(),this.stopPingPong(),null===(e=this.socket_)||void 0===e||e.close(),this.clearSocket()}}},function(e,t,i){var r=e.exports=i(263);r.build="light",r.load=function(e,t,i){return"function"==typeof t?(i=t,t=new r.Root):t||(t=new r.Root),t.load(e,i)},r.loadSync=function(e,t){return t||(t=new r.Root),t.loadSync(e)},r.encoder=i(184),r.decoder=i(189),r.verifier=i(190),r.converter=i(191),r.ReflectionObject=i(125),r.Namespace=i(132),r.Root=i(193),r.Enum=i(64),r.Type=i(185),r.Field=i(126),r.OneOf=i(146),r.MapField=i(186),r.Service=i(187),r.Method=i(188),r.Message=i(158),r.wrappers=i(192),r.types=i(133),r.util=i(25),r.ReflectionObject._configure(r.Root),r.Namespace._configure(r.Type,r.Service,r.Enum),r.Root._configure(r.Type),r.Field._configure(r.Type)},function(e,t,i){var r=t;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=i(156),r.BufferWriter=i(270),r.Reader=i(157),r.BufferReader=i(271),r.util=i(63),r.rpc=i(182),r.roots=i(183),r.configure=s,s()},function(e,t,i){var r=t;r.length=function(e){var t=e.length;if(!t)return 0;for(var i=0;--t%4>1&&"="===e.charAt(t);)++i;return Math.ceil(3*e.length)/4-i};for(var s=new Array(64),a=new Array(123),n=0;n<64;)a[s[n]=n<26?n+65:n<52?n+71:n<62?n-4:n-59|43]=n++;r.encode=function(e,t,i){for(var r,a=null,n=[],o=0,d=0;t<i;){var c=e[t++];switch(d){case 0:n[o++]=s[c>>2],r=(3&c)<<4,d=1;break;case 1:n[o++]=s[r|c>>4],r=(15&c)<<2,d=2;break;case 2:n[o++]=s[r|c>>6],n[o++]=s[63&c],d=0}o>8191&&((a||(a=[])).push(String.fromCharCode.apply(String,n)),o=0)}return d&&(n[o++]=s[r],n[o++]=61,1===d&&(n[o++]=61)),a?(o&&a.push(String.fromCharCode.apply(String,n.slice(0,o))),a.join("")):String.fromCharCode.apply(String,n.slice(0,o))},r.decode=function(e,t,i){for(var r,s=i,n=0,o=0;o<e.length;){var d=e.charCodeAt(o++);if(61===d&&n>1)break;if(void 0===(d=a[d]))throw Error("invalid encoding");switch(n){case 0:r=d,n=1;break;case 1:t[i++]=r<<2|(48&d)>>4,r=d,n=2;break;case 2:t[i++]=(15&r)<<4|(60&d)>>2,r=d,n=3;break;case 3:t[i++]=(3&r)<<6|d,n=0}}if(1===n)throw Error("invalid encoding");return i-s},r.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}},function(e,t,i){function r(){this._listeners={}}e.exports=r,r.prototype.on=function(e,t,i){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this},r.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var i=this._listeners[e],r=0;r<i.length;)i[r].fn===t?i.splice(r,1):++r;return this},r.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,i)}return this}},function(e,t,i){function r(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),r=128===i[3];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3]}function a(e,r,s){t[0]=e,r[s]=i[3],r[s+1]=i[2],r[s+2]=i[1],r[s+3]=i[0]}function n(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],t[0]}function o(e,r){return i[3]=e[r],i[2]=e[r+1],i[1]=e[r+2],i[0]=e[r+3],t[0]}e.writeFloatLE=r?s:a,e.writeFloatBE=r?a:s,e.readFloatLE=r?n:o,e.readFloatBE=r?o:n}():function(){function t(e,t,i,r){var s=t<0?1:0;if(s&&(t=-t),0===t)e(1/t>0?0:2147483648,i,r);else if(isNaN(t))e(2143289344,i,r);else if(t>34028234663852886e22)e((s<<31|2139095040)>>>0,i,r);else if(t<11754943508222875e-54)e((s<<31|Math.round(t/1401298464324817e-60))>>>0,i,r);else{var a=Math.floor(Math.log(t)/Math.LN2);e((s<<31|a+127<<23|8388607&Math.round(t*Math.pow(2,-a)*8388608))>>>0,i,r)}}function i(e,t,i){var r=e(t,i),s=2*(r>>31)+1,a=r>>>23&255,n=8388607&r;return 255===a?n?NaN:s*(1/0):0===a?1401298464324817e-60*s*n:s*Math.pow(2,a-150)*(n+8388608)}e.writeFloatLE=t.bind(null,s),e.writeFloatBE=t.bind(null,a),e.readFloatLE=i.bind(null,n),e.readFloatBE=i.bind(null,o)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),r=128===i[7];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7]}function a(e,r,s){t[0]=e,r[s]=i[7],r[s+1]=i[6],r[s+2]=i[5],r[s+3]=i[4],r[s+4]=i[3],r[s+5]=i[2],r[s+6]=i[1],r[s+7]=i[0]}function n(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],i[4]=e[r+4],i[5]=e[r+5],i[6]=e[r+6],i[7]=e[r+7],t[0]}function o(e,r){return i[7]=e[r],i[6]=e[r+1],i[5]=e[r+2],i[4]=e[r+3],i[3]=e[r+4],i[2]=e[r+5],i[1]=e[r+6],i[0]=e[r+7],t[0]}e.writeDoubleLE=r?s:a,e.writeDoubleBE=r?a:s,e.readDoubleLE=r?n:o,e.readDoubleBE=r?o:n}():function(){function t(e,t,i,r,s,a){var n=r<0?1:0;if(n&&(r=-r),0===r)e(0,s,a+t),e(1/r>0?0:2147483648,s,a+i);else if(isNaN(r))e(0,s,a+t),e(2146959360,s,a+i);else if(r>17976931348623157e292)e(0,s,a+t),e((n<<31|2146435072)>>>0,s,a+i);else{var o;if(r<22250738585072014e-324)e((o=r/5e-324)>>>0,s,a+t),e((n<<31|o/4294967296)>>>0,s,a+i);else{var d=Math.floor(Math.log(r)/Math.LN2);1024===d&&(d=1023),e(4503599627370496*(o=r*Math.pow(2,-d))>>>0,s,a+t),e((n<<31|d+1023<<20|1048576*o&1048575)>>>0,s,a+i)}}}function i(e,t,i,r,s){var a=e(r,s+t),n=e(r,s+i),o=2*(n>>31)+1,d=n>>>20&2047,c=4294967296*(1048575&n)+a;return 2047===d?c?NaN:o*(1/0):0===d?5e-324*o*c:o*Math.pow(2,d-1075)*(c+4503599627370496)}e.writeDoubleLE=t.bind(null,s,0,4),e.writeDoubleBE=t.bind(null,a,4,0),e.readDoubleLE=i.bind(null,n,0,4),e.readDoubleBE=i.bind(null,o,4,0)}(),e}function s(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}function a(e,t,i){t[i]=e>>>24,t[i+1]=e>>>16&255,t[i+2]=e>>>8&255,t[i+3]=255&e}function n(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function o(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=r(r)},function(e,t,i){var r=t;r.length=function(e){for(var t=0,i=0,r=0;r<e.length;++r)(i=e.charCodeAt(r))<128?t+=1:i<2048?t+=2:55296==(64512&i)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},r.read=function(e,t,i){if(i-t<1)return"";for(var r,s=null,a=[],n=0;t<i;)(r=e[t++])<128?a[n++]=r:r>191&&r<224?a[n++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,a[n++]=55296+(r>>10),a[n++]=56320+(1023&r)):a[n++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],n>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,a)),n=0);return s?(n&&s.push(String.fromCharCode.apply(String,a.slice(0,n))),s.join("")):String.fromCharCode.apply(String,a.slice(0,n))},r.write=function(e,t,i){for(var r,s,a=i,n=0;n<e.length;++n)(r=e.charCodeAt(n))<128?t[i++]=r:r<2048?(t[i++]=r>>6|192,t[i++]=63&r|128):55296==(64512&r)&&56320==(64512&(s=e.charCodeAt(n+1)))?(r=65536+((1023&r)<<10)+(1023&s),++n,t[i++]=r>>18|240,t[i++]=r>>12&63|128,t[i++]=r>>6&63|128,t[i++]=63&r|128):(t[i++]=r>>12|224,t[i++]=r>>6&63|128,t[i++]=63&r|128);return i-a}},function(e,t,i){e.exports=function(e,t,i){var r=i||8192,s=r>>>1,a=null,n=r;return function(i){if(i<1||i>s)return e(i);n+i>r&&(a=e(r),n=0);var o=t.call(a,n,n+=i);return 7&n&&(n=1+(7|n)),o}}},function(e,t,i){e.exports=s;var r=i(63);function s(e,t){this.lo=e>>>0,this.hi=t>>>0}var a=s.zero=new s(0,0);a.toNumber=function(){return 0},a.zzEncode=a.zzDecode=function(){return this},a.length=function(){return 1};var n=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(e){if(0===e)return a;var t=e<0;t&&(e=-e);var i=e>>>0,r=(e-i)/4294967296>>>0;return t&&(r=~r>>>0,i=~i>>>0,++i>4294967295&&(i=0,++r>4294967295&&(r=0))),new s(i,r)},s.from=function(e){if("number"==typeof e)return s.fromNumber(e);if(r.isString(e)){if(!r.Long)return s.fromNumber(parseInt(e,10));e=r.Long.fromString(e)}return e.low||e.high?new s(e.low>>>0,e.high>>>0):a},s.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,i=~this.hi>>>0;return t||(i=i+1>>>0),-(t+4294967296*i)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(e){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var o=String.prototype.charCodeAt;s.fromHash=function(e){return e===n?a:new s((o.call(e,0)|o.call(e,1)<<8|o.call(e,2)<<16|o.call(e,3)<<24)>>>0,(o.call(e,4)|o.call(e,5)<<8|o.call(e,6)<<16|o.call(e,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},s.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},s.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:i<128?9:10}},function(e,t,i){e.exports=a;var r=i(156);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(63);function a(){r.call(this)}function n(e,t,i){e.length<40?s.utf8.write(e,t,i):t.utf8Write?t.utf8Write(e,i):t.write(e,i)}a._configure=function(){a.alloc=s._Buffer_allocUnsafe,a.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(e,t,i){t.set(e,i)}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var r=0;r<e.length;)t[i++]=e[r++]}},a.prototype.bytes=function(e){s.isString(e)&&(e=s._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(a.writeBytesBuffer,t,e),this},a.prototype.string=function(e){var t=s.Buffer.byteLength(e);return this.uint32(t),t&&this._push(n,t,e),this},a._configure()},function(e,t,i){e.exports=a;var r=i(157);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(63);function a(e){r.call(this,e)}a._configure=function(){s.Buffer&&(a.prototype._slice=s.Buffer.prototype.slice)},a.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},a._configure()},function(e,t,i){e.exports=s;var r=i(63);function s(e,t,i){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(i)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,i,s,a,n){if(!a)throw TypeError("request must be specified");var o=this;if(!n)return r.asPromise(e,o,t,i,s,a);if(o.rpcImpl)try{return o.rpcImpl(t,i[o.requestDelimited?"encodeDelimited":"encode"](a).finish(),(function(e,i){if(e)return o.emit("error",e,t),n(e);if(null!==i){if(!(i instanceof s))try{i=s[o.responseDelimited?"decodeDelimited":"decode"](i)}catch(e){return o.emit("error",e,t),n(e)}return o.emit("data",i,t),n(null,i)}o.end(!0)}))}catch(e){return o.emit("error",e,t),void setTimeout((function(){n(e)}),0)}else setTimeout((function(){n(Error("already ended"))}),0)},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(e,t,i){function r(e,t){"string"==typeof e&&(t=e,e=void 0);var i=[];function s(e){if("string"!=typeof e){var t=a();if(r.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var n=Object.keys(e),o=new Array(n.length+1),d=new Array(n.length),c=0;c<n.length;)o[c]=n[c],d[c]=e[n[c++]];return o[c]=t,Function.apply(null,o).apply(null,d)}return Function(t)()}for(var l=new Array(arguments.length-1),u=0;u<l.length;)l[u]=arguments[++u];if(u=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var i=l[u++];switch(t){case"d":case"f":return String(Number(i));case"i":return String(Math.floor(i));case"j":return JSON.stringify(i);case"s":return String(i)}return"%"})),u!==l.length)throw Error("parameter count mismatch");return i.push(e),s}function a(r){return"function "+(r||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+i.join("\n  ")+"\n}"}return s.toString=a,s}e.exports=r,r.verbose=!1},function(e,t,i){e.exports=a;var r=i(180),s=i(181)("fs");function a(e,t,i){return"function"==typeof t?(i=t,t={}):t||(t={}),i?!t.xhr&&s&&s.readFile?s.readFile(e,(function(r,s){return r&&"undefined"!=typeof XMLHttpRequest?a.xhr(e,t,i):r?i(r):i(null,t.binary?s:s.toString("utf8"))})):a.xhr(e,t,i):r(a,this,e,t)}a.xhr=function(e,t,i){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(0!==r.status&&200!==r.status)return i(Error("status "+r.status));if(t.binary){var e=r.response;if(!e){e=[];for(var s=0;s<r.responseText.length;++s)e.push(255&r.responseText.charCodeAt(s))}return i(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return i(null,r.responseText)}},t.binary&&("overrideMimeType"in r&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.responseType="arraybuffer"),r.open("GET",e),r.send()}},function(e,t,i){var r=t,s=r.isAbsolute=function(e){return/^(?:\/|\w+:)/.test(e)},a=r.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),i=s(e),r="";i&&(r=t.shift()+"/");for(var a=0;a<t.length;)".."===t[a]?a>0&&".."!==t[a-1]?t.splice(--a,2):i?t.splice(a,1):++a:"."===t[a]?t.splice(a,1):++a;return r+t.join("/")};r.resolve=function(e,t,i){return i||(t=a(t)),s(t)?t:(i||(e=a(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?a(e+"/"+t):t)}},function(e,t,i){var r=i(179),s=(r.roots.default||(r.roots.default=new r.Root)).addJSON({WebrtcStats:{fields:{local:{type:"local_obj",id:1},remote:{type:"remote_obj",id:2},timestamp:{type:"int64",id:3},appkey:{type:"string",id:4},cid:{type:"int64",id:5},uid:{type:"string",id:6},browser:{type:"string",id:7},platform:{type:"string",id:8},sdkVersion:{type:"string",id:9}},nested:{local_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4},bwe:{rule:"repeated",type:"bwe_obj",id:5}},nested:{audio_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},audioSlave_ssrc_obj:{fields:{audioInputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesSent:{type:"int64",id:4},bitsSentPerSecond:{type:"int64",id:5},targetBitrate:{type:"int64",id:6},packetsSent:{type:"int64",id:7},packetsSentPerSecond:{type:"int64",id:8},packetsLost:{type:"int64",id:9},fractionLost:{type:"int64",id:10},packetsLostRate:{type:"int64",id:11},nackCount:{type:"int64",id:12},rtt:{type:"int64",id:13},jitterReceived:{type:"int64",id:14},echoReturnLoss:{type:"string",id:15},echoReturnLossEnhancement:{type:"string",id:16},active:{type:"int64",id:17}}},video_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},screen_ssrc_obj:{fields:{bytesSent:{type:"int64",id:1},bitsSentPerSecond:{type:"int64",id:2},targetBitrate:{type:"int64",id:3},packetsSent:{type:"int64",id:4},packetsSentPerSecond:{type:"int64",id:5},packetsLost:{type:"int64",id:6},fractionLost:{type:"int64",id:7},packetsLostRate:{type:"int64",id:8},firCount:{type:"int64",id:9},pliCount:{type:"int64",id:10},nackCount:{type:"int64",id:11},framesEncoded:{type:"int64",id:12},framesEncodedPerSecond:{type:"int64",id:13},avgEncodeMs:{type:"int64",id:14},encodeUsagePercent:{type:"int64",id:15},framesSent:{type:"int64",id:16},frameRateInput:{type:"int64",id:17},frameRateSent:{type:"int64",id:18},frameWidthInput:{type:"int64",id:19},frameWidthSent:{type:"int64",id:20},frameHeightInput:{type:"int64",id:21},frameHeightSent:{type:"int64",id:22},hugeFramesSent:{type:"int64",id:23},qpSum:{type:"int64",id:24},qpPercentage:{type:"int64",id:25},freezeTime:{type:"int64",id:26},totalFreezeTime:{type:"int64",id:27},qualityLimitationReason:{type:"string",id:28},qualityLimitationResolutionChanges:{type:"int64",id:29},jitter:{type:"int64",id:30},rtt:{type:"int64",id:31},active:{type:"int64",id:32},streamType:{type:"string",id:33}}},bwe_obj:{fields:{googActualEncBitrate:{type:"int64",id:1},googAvailableSendBandwidth:{type:"int64",id:2},googRetransmitBitrate:{type:"int64",id:3},googAvailableReceiveBandwidth:{type:"int64",id:4},googTargetEncBitrate:{type:"int64",id:5},googBucketDelay:{type:"int64",id:6},googTransmitBitrate:{type:"int64",id:7}}}}},remote_obj:{fields:{audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:1},audioSlave_ssrc:{rule:"repeated",type:"audioSlave_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:4}},nested:{audio_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},audioSlave_ssrc_obj:{fields:{audioOutputLevel:{type:"int64",id:1},totalAudioEnergy:{type:"int64",id:2},totalSamplesDuration:{type:"int64",id:3},bytesReceived:{type:"int64",id:4},bitsReceivedPerSecond:{type:"int64",id:5},packetsReceived:{type:"int64",id:6},packetsReceivedPerSecond:{type:"int64",id:7},packetsLost:{type:"int64",id:8},packetsLostRate:{type:"int64",id:9},nackCount:{type:"int64",id:10},lastPacketReceivedTimestamp:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},freezeTime:{type:"int64",id:13},totalFreezeTime:{type:"int64",id:14},decodingPLC:{type:"int64",id:15},decodingPLCCNG:{type:"int64",id:16},decodingNormal:{type:"int64",id:17},decodingMuted:{type:"int64",id:18},decodingCNG:{type:"int64",id:19},decodingCTN:{type:"int64",id:20},currentDelayMs:{type:"int64",id:21},preferredJitterBufferMs:{type:"int64",id:22},jitterBufferMs:{type:"int64",id:23},jitterBufferDelay:{type:"int64",id:24},jitter:{type:"int64",id:25},rtt:{type:"int64",id:26},preemptiveExpandRate:{type:"int64",id:27},speechExpandRate:{type:"int64",id:28},concealedSamples:{type:"int64",id:29},silentConcealedSamples:{type:"int64",id:30},secondaryDecodedRate:{type:"int64",id:31},secondaryDiscardedRate:{type:"int64",id:32},remoteuid:{type:"string",id:33}}},video_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}},screen_ssrc_obj:{fields:{bytesReceived:{type:"int64",id:1},bitsReceivedPerSecond:{type:"int64",id:2},packetsReceived:{type:"int64",id:3},packetsReceivedPerSecond:{type:"int64",id:4},packetsLost:{type:"int64",id:5},packetsLostRate:{type:"int64",id:6},firCount:{type:"int64",id:7},pliCount:{type:"int64",id:8},nackCount:{type:"int64",id:9},lastPacketReceivedTimestamp:{type:"int64",id:10},estimatedPlayoutTimestamp:{type:"int64",id:11},pauseCount:{type:"int64",id:12},totalPausesDuration:{type:"int64",id:13},freezeCount:{type:"int64",id:14},totalFreezesDuration:{type:"int64",id:15},totalFreezeTime:{type:"int64",id:16},freezeTime:{type:"int64",id:17},framesDecoded:{type:"int64",id:18},framesDropped:{type:"int64",id:19},framesReceived:{type:"int64",id:20},decodeMs:{type:"int64",id:21},frameRateDecoded:{type:"int64",id:22},frameRateOutput:{type:"int64",id:23},frameRateReceived:{type:"int64",id:24},frameWidthReceived:{type:"int64",id:25},frameHeightReceived:{type:"int64",id:26},powerEfficientDecoder:{type:"int64",id:27},currentDelayMs:{type:"int64",id:28},jitterBufferDelay:{type:"int64",id:29},remoteuid:{type:"string",id:30}}}}}}}});e.exports=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GetStats=void 0;const n=i(278),o=a(i(14)),d=i(2),c=i(279);function l(e){if(!e)return 16;let t;return t=new Map([["speech_low_quality",16],["speech_standard",32],["music_standard",48],["standard_stereo",48],["high_quality",48],["high_quality_stereo",48]]).get(e),t}function u(e,t,i){e&&i>=Number.MIN_SAFE_INTEGER&&(e[t]=Math.round(i))}function h(e,t,i){if(e&&t&&e[i]>Number.MIN_SAFE_INTEGER&&t[i]>Number.MIN_SAFE_INTEGER&&e.timestamp&&t.timestamp){const r=(e[i]-t[i])/(e.timestamp-t.timestamp)*1e3;return Math.max(r,-1)}return NaN}t.GetStats=class{constructor(e){this.times=0,this.tmp={bytesSent:0,bytesReceived:0},this.chromeLegecy=d.getParameters().chromeLegacyDefault,this.adapterRef=e.adapterRef,this.browser="chrome",this.audioLevel=[],this._reset(),this.formativeStatsReport=new n.FormativeStatsReport({adapterRef:this.adapterRef}),this.statsInfo={send:{firstStartAt:0,lastStartAt:0,totalCnt:0,frequency:0,errCnt:0,cpStats:null,statsMapHistory:{},logger:this.adapterRef.logger.getChild((()=>`getStats ${this.browser} send ${this.statsInfo.send.errCnt}/${this.statsInfo.send.totalCnt}`))},recv:{firstStartAt:0,lastStartAt:0,totalCnt:0,frequency:0,errCnt:0,cpStats:null,statsMapHistory:{},logger:this.adapterRef.logger.getChild((()=>`getStats ${this.browser} recv ${this.statsInfo.recv.errCnt}/${this.statsInfo.recv.totalCnt} `))}}}_reset(){this.times=0,this.browser="chrome",o.IS_CHROME_ONLY&&o.CHROME_MAJOR_VERSION&&o.CHROME_MAJOR_VERSION>=72||o.IS_ANDROID?this.browser="chrome":o.IS_ANY_SAFARI&&o.SAFARI_MAJOR_VERSION&&o.SAFARI_MAJOR_VERSION>=12||o.IS_ANY_SAFARI&&o.IS_WECHAT?this.browser="safari":o.IS_FIREFOX&&o.FIREFOX_MAJOR_VERSION&&o.FIREFOX_MAJOR_VERSION>=60&&(this.browser="firefox"),this.audioLevel=[],this.formativeStatsReport&&this.formativeStatsReport.destroy(),this.formativeStatsReport=null}markStatsStart(e){const t=this.statsInfo[e];t&&(t.lastStartAt=Date.now(),t.firstStartAt||(t.firstStartAt=t.lastStartAt),t.totalCnt+=1,t.frequency=Math.floor(t.totalCnt/(t.lastStartAt-t.firstStartAt)*6e4))}async getAllStats(){var e,t,i,r,s,a,n,o,c,l;this.tmp={bytesSent:0,bytesReceived:0},this.times=(this.times||0)+1;let u=null,h=null;try{let s=null===(r=null===(i=null===(t=null===(e=null==this?void 0:this.adapterRef)||void 0===e?void 0:e._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i?void 0:i._handler)||void 0===r?void 0:r._pc;if(!s)return;u=await this.getLocalStats(s)}catch(e){this.statsInfo.send.errCnt++,this.statsInfo.send.errCnt<=d.getParameters().statsLogMaxCnt&&this.statsInfo.send.logger.warn("数据汇集出现异常: ",e.name,e.message,e.stack)}try{this.audioLevel.length=0,this.adapterRef.remoteAudioStats={},this.adapterRef.remoteAudioSlaveStats={},this.adapterRef.remoteVideoStats={},this.adapterRef.remoteScreenStats={};let e=null===(o=null===(n=null===(a=null===(s=null==this?void 0:this.adapterRef)||void 0===s?void 0:s._mediasoup)||void 0===a?void 0:a._recvTransport)||void 0===n?void 0:n._handler)||void 0===o?void 0:o._pc;if(!e)return;h=await this.getRemoteStats(e),this.audioLevel.sort((p="level",function(e,t){var i=e[p],r=t[p];return 0===r||r?0===i||i?r-i:1:-1})),this.audioLevel.length>0&&this.audioLevel[0].level>d.getParameters().activeSpeakerMin&&(null===(c=null==this?void 0:this.adapterRef)||void 0===c||c.instance.safeEmit("active-speaker",this.audioLevel[0]),null===(l=null==this?void 0:this.adapterRef)||void 0===l||l.instance.safeEmit("volume-indicator",this.audioLevel))}catch(e){this.statsInfo.recv.errCnt++,this.statsInfo.recv.errCnt<=d.getParameters().statsLogMaxCnt&&this.statsInfo.recv.logger.warn("数据汇集出现异常: ",e.name,e.message,e.stack)}var p;return{local:u,remote:h,times:this.times}}async getLocalStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"send")}async getRemoteStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"recv")}async chrome(e,t){const i="unsupported"===this.chromeLegecy?null:await(()=>new Promise((async i=>{try{this.markStatsStart(t),await e.getStats((r=>{this.chromeLegecy="supported";let s={};r.result().forEach((function(e){const t={};e.names().forEach((function(i){t[i]=e.stat(i)})),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,s[t.id]=t})),e.lastStats=e.lastStats||{},s=this.formatChromeNonStandardStats(e,s,t),i(s)}))}catch(e){this.statsInfo[t].errCnt++,"TypeError"===e.name?(this.statsInfo[t].logger.warn(`getStats出现异常：${e.name}。fallback: 切换getStats方式 ${this.browser} => safari`,e.name,e.message),this.browser="safari"):"NotSupportedError"===e.name?(this.statsInfo[t].logger.log(`getStats：当前浏览器不再支持非标准getStats ${e.name} ${e.message}`),"unknown"===this.chromeLegecy&&(this.chromeLegecy="unsupported"),i(null)):(this.statsInfo[t].errCnt<=d.getParameters().statsLogMaxCnt&&this.statsInfo[t].logger.warn(`getStats出现异常: ${e.name} ${e.message}`),i(null))}})))(),r=await(async()=>{if(!e.getTransceivers)return{};let i={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[],bwe:[]};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?(a.sender&&a.sender.track&&a.sender.getStats&&(this.markStatsStart(t),s=await a.sender.getStats(),s=this.formatChromeStandardizedStats(s,t),s.video_ssrc&&i.video_ssrc?(i.video_ssrc.push(s.video_ssrc[0]),i.video_ssrc.length>1&&"low"===(i.video_ssrc[0]||{}).streamType&&([i.video_ssrc[0],i.video_ssrc[1]]=[i.video_ssrc[1],i.video_ssrc[0]])):s.screen_ssrc&&i.screen_ssrc?(i.screen_ssrc.push(s.screen_ssrc[0]),i.screen_ssrc.length>1&&"low"===(i.screen_ssrc[0]||{}).streamType&&([i.screen_ssrc[0],i.screen_ssrc[1]]=[i.screen_ssrc[1],i.screen_ssrc[0]])):Object.assign(i,s)),0===i.bwe.length&&this.statsInfo.send.cpStats&&i.bwe.push({googAvailableSendBandwidth:this.statsInfo.send.cpStats.availableOutgoingBitrate/1e3})):"recvonly"===a.direction&&a.receiver&&a.receiver.track&&a.receiver.getStats&&(this.markStatsStart(t),s=await a.receiver.getStats(),s=this.formatChromeStandardizedStats(s,t),s.audio_ssrc&&i.audio_ssrc?i.audio_ssrc.push(s.audio_ssrc[0]):s.audioSlave_ssrc&&i.audioSlave_ssrc?i.audioSlave_ssrc.push(s.audioSlave_ssrc[0]):s.video_ssrc&&i.video_ssrc?i.video_ssrc.push(s.video_ssrc[0]):s.screen_ssrc&&i.screen_ssrc?i.screen_ssrc.push(s.screen_ssrc[0]):Object.assign(i,s))}return i})(),s={};return i&&r?Object.keys(i).forEach((e=>{const t=i[e],a=r[e];if(s[e]=[],a)for(let i=0;i<t.length;i++)a[i]&&s[e].push(Object.assign(t[i],a[i]));else s[e]=t})):i?Object.assign(s,i):r&&Object.assign(s,r),d.getParameters().showStatsLog&&("send"===t?this.statsInfo.send.logger.warn("getStats send",s):this.statsInfo.recv.logger.warn("getStats recv",s)),s}formatChromeNonStandardStats(e,t,i){const r=[],s=[],a=[],n=[],o=[],d={data:[]};Object.values(t).forEach((t=>{var c,u,h,p,m,f,g,v,_,y,S,R,b,E,T,A,w,I,C,O,k,P,x,M,D,N,L,F,V;if(t.id.includes("Conn-")&&"true"===t.googActiveConnection&&(null===(c=this.formativeStatsReport)||void 0===c||c.formatTransportData(t,i)),t.id.includes("Cand-")&&t.networkType)this.adapterRef.transportStats.NetworkType=t.networkType||"";else if("bweforvideo"===t.id&&"send"===i)t=function(e){const t={googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1};return Object.keys(e).map((i=>{t[i]&&(e[i]=parseInt(e[i])/1024)})),e}(t),this.adapterRef.transportStats.OutgoingAvailableBandwidth=t.googAvailableSendBandwidth,o.push({googActualEncBitrate:parseInt(t.googActualEncBitrate)||0,googAvailableSendBandwidth:parseInt(t.googAvailableSendBandwidth)||0,googRetransmitBitrate:parseInt(t.googRetransmitBitrate)||0,googAvailableReceiveBandwidth:parseInt(t.googAvailableReceiveBandwidth)||0,googTargetEncBitrate:parseInt(t.googTargetEncBitrate)||0,googTransmitBitrate:parseInt(t.googTransmitBitrate)||0,googBucketDelay:parseInt(t.googBucketDelay)||0});else if(/^ssrc_/i.test(t.id)){const o=null===(u=null==this?void 0:this.adapterRef)||void 0===u?void 0:u.instance.getUidAndKindBySsrc(parseInt(t.ssrc)),c=null==o?void 0:o.uid,j=null==o?void 0:o.streamType;let U="";U=(null==o?void 0:o.kind)?o.kind:"screen"===t.googContentType?"screen":t.mediaType;let B={};if("send"===i){if("audio"===t.mediaType){void 0!==t.audioInputLevel&&(B.audioInputLevel=parseInt(t.audioInputLevel)),B.totalAudioEnergy=parseInt(t.totalAudioEnergy),B.totalSamplesDuration=parseInt(t.totalSamplesDuration),B.bytesSent=parseInt(t.bytesSent),B.packetsSent=parseInt(t.packetsSent),B.packetsLost=parseInt(t.packetsLost),B.rtt=parseInt(t.googRtt),B.jitterReceived=parseInt(t.googJitterReceived),void 0!==t.googEchoCancellationReturnLoss&&(B.echoReturnLoss=""+t.googEchoCancellationReturnLoss),void 0!==t.googEchoCancellationReturnLossEnhancement&&(B.echoReturnLossEnhancement=t.googEchoCancellationReturnLossEnhancement),null===(h=this.formativeStatsReport)||void 0===h||h.formatSendData(B,U);const i={CodecType:"Opus",rtt:B.rtt||0,MuteState:(null===(g=null===(f=null===(m=null===(p=null==this?void 0:this.adapterRef)||void 0===p?void 0:p.localStream)||void 0===m?void 0:m.muteStatus)||void 0===f?void 0:f.audio)||void 0===g?void 0:g.send)||!1,RecordingLevel:B.audioInputLevel||0,SamplingRate:l(null===(_=null===(v=null==this?void 0:this.adapterRef)||void 0===v?void 0:v.localStream)||void 0===_?void 0:_.audioProfile),SendBitrate:B.bitsSentPerSecond||0,SendLevel:B.audioInputLevel||0};"audio"===U?(r.push(B),(null===(y=e.audioSender)||void 0===y?void 0:y.track)?this.adapterRef.localAudioStats[0]=i:this.adapterRef.localAudioStats=[]):"audioSlave"===U&&(s.push(B),(null===(S=e.audioSlaveSender)||void 0===S?void 0:S.track)?this.adapterRef.localAudioSlaveStats[0]=i:this.adapterRef.localAudioSlaveStats=[])}else if("video"===t.mediaType){B.bytesSent=parseInt(t.bytesSent),B.packetsSent=parseInt(t.packetsSent),B.packetsLost=parseInt(t.packetsLost),B.firCount=parseInt(t.googFirsReceived),B.pliCount=parseInt(t.googPlisReceived),B.nackCount=parseInt(t.googNacksReceived),void 0!==t.framesEncoded&&(B.framesEncoded=parseInt(t.framesEncoded)),B.avgEncodeMs=parseInt(t.googAvgEncodeMs),B.encodeUsagePercent=parseInt(t.googEncodeUsagePercent),B.frameRateInput=parseInt(t.googFrameRateInput),B.frameRateSent=parseInt(t.googFrameRateSent),B.frameWidthInput=parseInt(t.googFrameWidthInput),B.frameWidthSent=parseInt(t.googFrameWidthSent),B.frameHeightInput=parseInt(t.googFrameHeightInput),B.frameHeightSent=parseInt(t.googFrameHeightSent),void 0!==t.hugeFramesSent&&(B.hugeFramesSent=parseInt(t.hugeFramesSent)),B.qpSum=parseInt(t.qpSum),B.qualityLimitationReason=function(e){return e.googBandwidthLimitedResolution?1:e.googCpuLimitedResolution?2:e.googHasEnteredLowResolution?3:0}(t),B.qualityLimitationResolutionChanges=parseInt(t.googAdaptationChanges),B.rtt=parseInt(t.googRtt),B.streamType=j,"high"===j&&(null===(R=this.formativeStatsReport)||void 0===R||R.formatSendData(B,U));const i={LayerType:1,CodecName:t.googCodecName||"h264",CodecImplementationName:t.codecImplementationName||"",CaptureFrameRate:B.frameRateInput||0,CaptureResolutionHeight:B.frameHeightInput||0,CaptureResolutionWidth:B.frameWidthInput||0,EncodeDelay:B.avgEncodeMs||0,MuteState:(null===(T=null===(E=null===(b=this.adapterRef.localStream)||void 0===b?void 0:b.muteStatus)||void 0===E?void 0:E.video)||void 0===T?void 0:T.send)||!1,SendBitrate:B.bitsSentPerSecond||0,SendFrameRate:B.frameRateSent||0,SendResolutionHeight:B.frameHeightSent||0,SendResolutionWidth:B.frameWidthSent||0,TargetSendBitrate:B.bitsSentPerSecond||0,TotalDuration:void 0!==(null===(A=null==this?void 0:this.adapterRef)||void 0===A?void 0:A.state.startPubVideoTime)?(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3:0,TotalFreezeTime:B.totalFreezeTime||0};if("video"===U)if(a.push(B),null===(w=e.videoSender)||void 0===w?void 0:w.track){if("high"===j){const e=this.adapterRef.localVideoStats[0];this.adapterRef.localVideoStats[0]=i,d.data.push({mediaType:"video",streamType:"high",old:e,new:i})}}else d.data.push({mediaType:"video",streamType:"high",old:this.adapterRef.localVideoStats[0]||null,new:null}),this.adapterRef.localVideoStats=[];else if("screen"===U){if(null===(I=e.screenSender)||void 0===I?void 0:I.track){if("high"===j){i.MuteState=(null===(k=null===(O=null===(C=this.adapterRef.localStream)||void 0===C?void 0:C.muteStatus)||void 0===O?void 0:O.screen)||void 0===k?void 0:k.send)||!1,i.TotalDuration=void 0!==(null===(P=null==this?void 0:this.adapterRef)||void 0===P?void 0:P.state.startPubScreenTime)?(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3:0,i.LayerType=2;const e=this.adapterRef.localScreenStats[0];this.adapterRef.localScreenStats[0]=i,d.data.push({mediaType:"screen",streamType:"high",old:e,new:i})}}else d.data.push({mediaType:"screen",streamType:"high",old:this.adapterRef.localScreenStats[0]||null,new:null}),this.adapterRef.localScreenStats=[];n.push(B)}}}else if("recv"===i){if(!c)return{};if(null===(x=this.formativeStatsReport)||void 0===x||x.clearFirstRecvData(c),B.remoteuid=c,"audio"===t.mediaType){B.audioOutputLevel=parseInt(t.audioOutputLevel),B.totalAudioEnergy=parseInt(t.totalAudioEnergy),B.totalSamplesDuration=parseInt(t.totalSamplesDuration),B.bytesReceived=parseInt(t.bytesReceived),B.packetsReceived=parseInt(t.packetsReceived),B.packetsLost=parseInt(t.packetsLost),B.decodingPLC=parseInt(t.googDecodingPLC),B.decodingPLCCNG=parseInt(t.googDecodingPLCCNG),B.decodingNormal=parseInt(t.googDecodingNormal),B.decodingMuted=parseInt(t.googDecodingMuted),B.decodingCNG=parseInt(t.googDecodingCNG),B.decodingCTN=parseInt(t.googDecodingCTN),B.currentDelayMs=parseInt(t.googCurrentDelayMs),B.preferredJitterBufferMs=parseInt(t.googPreferredJitterBufferMs),B.jitterBufferMs=parseInt(t.googJitterBufferMs),B.jitter=parseInt(t.googJitterReceived),B.preemptiveExpandRate=parseInt(t.googPreemptiveExpandRate),B.speechExpandRate=parseInt(t.googAccelerateRate),B.secondaryDecodedRate=parseInt(t.googSecondaryDecodedRate),B.secondaryDiscardedRate=parseInt(t.googSecondaryDiscardedRate),null===(M=this.formativeStatsReport)||void 0===M||M.formatRecvData(B,U);const e=null===(D=null==this?void 0:this.adapterRef)||void 0===D?void 0:D.remoteStreamMap[B.remoteuid],i=null==e?void 0:e.muteStatus[U],a=!!i&&(i.send||i.recv),n={CodecType:"Opus",End2EndDelay:(parseInt(t.googCurrentDelayMs)||0)+(parseInt(t.googJitterBufferMs)||0),MuteState:a,PacketLossRate:B.packetsLostRate||0,RecvBitrate:B.bitsReceivedPerSecond||0,RecvLevel:B.audioOutputLevel||0,TotalFreezeTime:B.totalFreezeTime||0,TotalPlayDuration:parseInt(t.totalSamplesDuration)||0,TransportDelay:parseInt(t.googCurrentDelayMs)||0};"audio"===U?(B.remoteuid&&(this.adapterRef.remoteAudioStats[B.remoteuid]=n),r.push(B)):"audioSlave"===U&&(B.remoteuid&&(this.adapterRef.remoteAudioSlaveStats[B.remoteuid]=n),s.push(B))}else if("video"===t.mediaType){B.bytesReceived=parseInt(t.bytesReceived),B.bitsReceivedPerSecond=0,B.packetsReceived=parseInt(t.packetsReceived),B.packetsLost=parseInt(t.packetsLost),B.firCount=parseInt(t.googFirsSent),B.pliCount=parseInt(t.googPlisSent),B.nackCount=parseInt(t.googNacksSent),B.framesDecoded=parseInt(t.framesDecoded),B.decodeMs=parseInt(t.googDecodeMs),B.frameRateDecoded=parseInt(t.googFrameRateDecoded),B.frameRateOutput=parseInt(t.googFrameRateOutput),B.frameRateReceived=parseInt(t.googFrameRateReceived),B.frameWidthReceived=parseInt(t.googFrameWidthReceived),B.frameHeightReceived=parseInt(t.googFrameHeightReceived),B.currentDelayMs=parseInt(t.googCurrentDelayMs),void 0!==t.googJitterBufferMs&&(B.jitterBufferDelay=parseInt(t.googJitterBufferMs)),null===(N=this.formativeStatsReport)||void 0===N||N.formatRecvData(B,U);const e=null===(L=null==this?void 0:this.adapterRef)||void 0===L?void 0:L.remoteStreamMap[B.remoteuid];let i=e&&e.Play&&(null===(F=null==e?void 0:e.Play)||void 0===F?void 0:F.video.dom),r=e&&(e.muteStatus.video.send||e.muteStatus.video.recv)||!1;"screen"===U&&(i=e&&e.Play&&(null===(V=null==e?void 0:e.Play)||void 0===V?void 0:V.screen.dom),r=e&&(e.muteStatus.screen.send||e.muteStatus.screen.recv)||!1);const s={LayerType:1,CodecName:t.googCodecName,End2EndDelay:(parseInt(t.googCurrentDelayMs)||0)+(parseInt(t.googJitterBufferMs)||0)+(parseInt(t.googRenderDelayMs)||0),MuteState:r,PacketLossRate:B.packetsLostRate||0,RecvBitrate:B.bitsReceivedPerSecond||0,RecvResolutionHeight:B.frameHeightReceived||0,RecvResolutionWidth:B.frameWidthReceived||0,RenderFrameRate:B.frameRateOutput||0,RenderResolutionHeight:i?i.videoHeight:0,RenderResolutionWidth:i?i.videoWidth:0,TotalFreezeTime:t.totalFreezeTime||0,TotalPlayDuration:i&&i.played&&i.played.length?i.played.end(0):0,TransportDelay:parseInt(t.googCurrentDelayMs)||0};"video"===U?(this.adapterRef.remoteVideoStats[B.remoteuid]=s,a.push(B)):"screen"===U&&(s.LayerType=2,this.adapterRef.remoteScreenStats[B.remoteuid]=s,n.push(B))}}}})),this.adapterRef.instance.safeEmit("@media-stats-change",d);const c={};return r.length&&(c.audio_ssrc=r),s.length&&(c.audioSlave_ssrc=s),a.length&&(a.length>1&&"low"===(a[0]||{}).streamType&&([a[0],a[1]]=[a[1],a[0]]),c.video_ssrc=a),n.length&&(n.length>1&&"low"===(n[0]||{}).streamType&&([n[0],n[1]]=[n[1],n[0]]),c.screen_ssrc=n),o.length&&(c.bwe=o),c}formatChromeStandardizedStats(e,t){var i,r,s,a,n,o,p;const m=new c.FormativeStatsAudio,f=new c.FormativeStatsVideo;let g=0;e.forEach((e=>{var i;const r=this.statsInfo[t].statsMapHistory[e.id];let s=null;if(r){for(let t=r.length-1;t>=0;t--)s?r.splice(t,1):e.timestamp-r[t].timestamp>=d.getParameters().statsHistoryInterval&&(s=r[t]);r.length<10&&e.timestamp&&r.push(e)}else this.statsInfo[t].statsMapHistory[e.id]=[e];if("media-source"==e.type)"audio"===e.kind?(m.audioInputLevel=Math.round(32768*e.audioLevel),m.totalAudioEnergy=Math.round(e.totalAudioEnergy),m.totalSamplesDuration=Math.round(e.totalSamplesDuration),e.echoReturnLoss&&(m.echoReturnLoss=""+e.echoReturnLoss),e.echoReturnLossEnhancement&&(m.echoReturnLossEnhancement=""+100*e.echoReturnLossEnhancement)):"video"===e.kind&&(f.frameRateInput=e.framesPerSecond,f.frameWidthInput=e.width,f.frameHeightInput=e.height);else if("media-playout"===e.type){if("audio"===e.kind&&s){const t=1e3*h(e,s,"totalPlayoutDelay")/h(e,s,"totalSamplesCount");m.playoutDelayMs=t}}else if("outbound-rtp"==e.type){if(g=e.ssrc,"audio"===e.kind){if(u(m,"targetBitrate",e.targetBitrate/1e3),m.bytesSent=e.headerBytesSent+e.bytesSent,m.packetsSent=e.packetsSent,s&&"send"===t){const t=h(e,s,"bytesSent"),i=h(e,s,"headerBytesSent");u(m,"bitsSentPerSecond",.008*(t+i));const r=h(e,s,"packetsSent");u(m,"packetsSentPerSecond",r)}u(m,"nackCount",e.nackCount),m.active=e.active?1:0}else if("video"===e.kind){if(f.active=e.active?1:0,f.bytesSent=e.headerBytesSent+e.bytesSent,f.firCount=e.firCount,f.nackCount=e.nackCount,f.pliCount=e.pliCount,u(f,"framesEncoded",e.framesEncoded),u(f,"framesSent",e.framesSent),u(f,"hugeFramesSent",e.hugeFramesSent),f.packetsSent=e.packetsSent,f.qpSum=e.qpSum,s&&"send"===t){const t=h(e,s,"bytesSent"),i=h(e,s,"headerBytesSent");u(f,"bitsSentPerSecond",.008*(t+i));const r=h(e,s,"packetsSent");u(f,"packetsSentPerSecond",r);const a=h(e,s,"framesEncoded");u(f,"framesEncodedPerSecond",a);const n=h(e,s,"qpSum");u(f,"qpPercentage",n/a);const o=100*h(e,s,"totalEncodeTime");u(f,"encodeUsagePercent",o)}if(f.qualityLimitationReason=""+("bandwidth"===(a=e.qualityLimitationReason)?1:"cpu"===a?2:"other"===a?3:0),f.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges,f.CodecImplementationName=e.encoderImplementation,u(f,"targetBitrate",e.targetBitrate/1e3),u(f,"frameRateSent",e.framesPerSecond),void 0!==e.frameWidth&&(f.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(f.frameHeightSent=e.frameHeight),e.framesEncoded&&e.totalEncodeTime&&s){const t=1e3*(e.totalEncodeTime-s.totalEncodeTime)/(e.framesEncoded-s.framesEncoded);u(f,"avgEncodeMs",t)}}}else if("remote-inbound-rtp"==e.type){if("audio"===e.kind){if(u(m,"fractionLost",100*e.fractionLost),m.jitterReceived=Math.round(1e3*e.jitter),m.packetsLost=e.packetsLost,s&&"send"===t){const t=h(e,s,"packetsLost")/(m.packetsSentPerSecond||50)*100;u(m,"packetsLostRate",t)}u(m,"rtt",1e3*e.roundTripTime)}else if("video"===e.kind){if(u(f,"fractionLost",100*e.fractionLost),f.jitter=Math.round(1e3*e.jitter),f.packetsLost=e.packetsLost,s&&"send"===t){const t=h(e,s,"packetsLost")/(f.packetsSentPerSecond||0)*100;u(f,"packetsLostRate",t)}u(f,"rtt",1e3*e.roundTripTime)}}else if("inbound-rtp"==e.type){if(g=e.ssrc,"audio"===e.kind){if(u(m,"audioOutputLevel",32768*e.audioLevel),u(m,"totalAudioEnergy",e.totalAudioEnergy),u(m,"totalSamplesDuration",e.totalSamplesReceived/48e3),m.bytesReceived=e.headerBytesReceived+e.bytesReceived,u(m,"concealedSamples",e.concealedSamples),u(m,"estimatedPlayoutTimestamp",e.estimatedPlayoutTimestamp-e.timestamp),u(m,"jitter",1e3*e.jitter),u(m,"jitterBufferDelay",1e3*e.jitterBufferDelay),s){const t=1e3*h(e,s,"removedSamplesForAcceleration")/h(e,s,"totalSamplesCount");u(m,"speechExpandRate",t);const i=1e3*h(e,s,"insertedSamplesForDeceleration")/h(e,s,"totalSamplesCount");u(m,"preemptiveExpandRate",i)}if(u(m,"preferredJitterBufferMs",1e3*e.jitterBufferTargetDelay/e.jitterBufferEmittedCount),u(m,"secondaryDecodedRate",e.fecPacketsReceived-e.fecPacketsDiscarded),u(m,"secondaryDiscardedRate",e.fecPacketsDiscarded),u(m,"lastPacketReceivedTimestamp",e.timestamp-e.lastPacketReceivedTimestamp),u(m,"nackCount",e.nackCount),u(m,"silentConcealedSamples",e.silentConcealedSamples),m.packetsLost=e.packetsLost,m.packetsReceived=e.packetsReceived,s&&"recv"===t){const t=.008*h(e,s,"bytesReceived");u(m,"bitsReceivedPerSecond",t);const i=h(e,s,"packetsReceived");u(m,"packetsReceivedPerSecond",i);const r=h(e,s,"packetsLost"),a=r/(i+r||50)*100;a>=0?u(m,"packetsLostRate",a):m.packetsLostRate=0;const n=1e3*h(e,s,"jitterBufferDelay")/h(e,s,"jitterBufferEmittedCount");u(m,"jitterBufferMs",n)}}else if("video"===e.kind){f.bytesReceived=e.bytesReceived+e.headerBytesReceived,u(f,"lastPacketReceivedTimestamp",e.timestamp-e.lastPacketReceivedTimestamp),u(f,"estimatedPlayoutTimestamp",e.estimatedPlayoutTimestamp-e.timestamp),f.firCount=e.firCount,f.nackCount=e.nackCount,f.pliCount=e.pliCount,f.framesDecoded=e.framesDecoded,u(f,"framesDropped",e.framesDropped),u(f,"framesReceived",e.framesReceived),f.packetsReceived=e.packetsReceived,f.packetsLost=e.packetsLost,u(f,"pauseCount",e.pauseCount),u(f,"totalPausesDuration",1e3*e.totalPausesDuration),u(f,"freezeCount",e.freezeCount),u(f,"totalFreezesDuration",1e3*e.totalFreezesDuration),u(f,"frameRateReceived",e.framesPerSecond),u(f,"frameWidthReceived",e.frameWidth),u(f,"frameHeightReceived",e.frameHeight);const i=e.decoderImplementation;if(f.powerEfficientDecoder="OpenH264"===i?2:i?1:0,u(f,"jitterBufferDelay",1e3*e.jitterBufferDelay),s&&"recv"===t){const t=.008*h(e,s,"bytesReceived");u(f,"bitsReceivedPerSecond",t);const i=h(e,s,"packetsReceived");u(f,"packetsReceivedPerSecond",i);const r=h(e,s,"packetsLost"),a=r/(i+r)*100;a>=0&&u(f,"packetsLostRate",a);const n=1e3*h(e,s,"totalDecodeTime"),o=h(e,s,"framesDecoded");u(f,"decodeMs",n/o);const d=h(e,s,"framesDecoded");u(f,"frameRateDecoded",d);const c=h(e,s,"framesDropped");u(f,"frameRateOutput",d-c);const l=1e3*h(e,s,"jitterBufferDelay")/h(e,s,"jitterBufferEmittedCount");u(f,"jitterBufferMs",l)}}}else if("remote-outbound-rtp"==e.type)"audio"===e.kind?(e.jitter&&u(m,"jitter",1e3*e.jitter),e.roundTripTime&&u(m,"rtt",1e3*e.roundTripTime)):e.kind;else if("track"==e.type)"recv"===t&&"audio"===e.kind&&u(m,"audioOutputLevel",32768*e.audioLevel);else if("candidate-pair"===e.type)u(m,"rtt",1e3*e.currentRoundTripTime),u(f,"rtt",1e3*e.currentRoundTripTime),this.statsInfo[t].cpStats=e,null===(i=this.formativeStatsReport)||void 0===i||i.formatTransportDataChrome117(e,t);else if("codec"===e.type&&e.mimeType){const[t,i]=e.mimeType.split("/");"audio"===t?"audio/opus"===e.mimeType?m.CodecType="Opus":m.CodecType=i:"video"===t?e.mimeType&&(f.CodecName=i):(m.CodecType=e.mimeType,f.CodecName=e.mimeType)}var a}));const v=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i.instance.getUidAndKindBySsrc(g);if(!g||!v)return{};let _=null==v?void 0:v.kind;if("recv"===t&&("audio"===_||"audioSlave"===_?(m.jitterBufferMs&&u(m,"currentDelayMs",m.jitterBufferMs+(m.playoutDelayMs||0)),m.rtt&&(m.End2EndDelay=m.rtt+(m.jitterBufferMs||0))):"video"!==_&&"screen"!==_||(f.jitterBufferMs&&u(f,"currentDelayMs",f.jitterBufferMs),f.rtt&&(f.End2EndDelay=f.rtt+(f.jitterBufferMs||0)))),"send"===t){const e=this.adapterRef.localStream;if("video"===_||"screen"===_){if(f.streamType=(null==v?void 0:v.streamType)||"high","supported"!==this.chromeLegecy&&"high"===f.streamType){null===(r=this.formativeStatsReport)||void 0===r||r.formatSendData(f,_),f.LayerType="video"===_?1:2,f.CaptureFrameRate=f.frameRateInput,f.CaptureResolutionHeight=f.frameHeightInput,f.CaptureResolutionWidth=f.frameWidthInput,f.EncodeDelay=f.avgEncodeMs,e&&(f.MuteState=e.getMuteStatus(_).muted),f.SendBitrate=f.bitsSentPerSecond,f.SendFrameRate=f.frameRateSent,f.SendResolutionHeight=f.frameHeightSent,f.SendResolutionWidth=f.frameWidthSent,f.TargetSendBitrate=f.targetBitrate,f.TotalFreezeTime=f.totalFreezeTime,"video"===_&&this.adapterRef.state.startPubVideoTime&&(f.TotalDuration=(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3),"screen"===_&&this.adapterRef.state.startPubScreenTime&&(f.TotalDuration=(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3);const t={LayerType:f.LayerType,CodecName:f.CodecName,CodecImplementationName:f.CodecImplementationName,CaptureFrameRate:f.CaptureFrameRate,CaptureResolutionHeight:f.CaptureResolutionHeight,CaptureResolutionWidth:f.CaptureResolutionWidth,EncodeDelay:f.EncodeDelay,MuteState:f.MuteState,SendBitrate:f.SendBitrate,SendFrameRate:f.SendFrameRate,SendResolutionHeight:f.SendResolutionHeight,SendResolutionWidth:f.SendResolutionWidth,TargetSendBitrate:f.TargetSendBitrate,TotalDuration:f.TotalDuration,TotalFreezeTime:f.TotalFreezeTime},i="video"===_?this.adapterRef.localVideoStats:this.adapterRef.localScreenStats;"high"===f.streamType?i[0]=t:i[1]=t}}else if(("audio"===_||"audioSlave"===_)&&"supported"!==this.chromeLegecy){null===(s=this.formativeStatsReport)||void 0===s||s.formatSendData(m,_),e&&(m.MuteState=e.getMuteStatus(_).muted,"audio"===_&&e.audioLevelHelper?m.RecordingLevel=Math.round(32768*e.audioLevelHelper.volume):"audioSlave"===_&&e.audioLevelHelperSlave?m.RecordingLevel=Math.round(32768*e.audioLevelHelperSlave.volume):m.RecordingLevel=m.audioInputLevel,m.SamplingRate=l(e.audioProfile),m.SendBitrate=m.bitsSentPerSecond,m.SendLevel=m.audioInputLevel);const t={CodecType:m.CodecType,rtt:m.rtt,MuteState:m.MuteState,RecordingLevel:m.RecordingLevel,SamplingRate:m.SamplingRate,SendBitrate:m.SendBitrate,SendLevel:m.SendLevel};"audio"===_?this.adapterRef.localAudioStats[0]=t:"audioSlave"===_&&(this.adapterRef.localAudioSlaveStats[0]=t)}}const y={};if("recv"===t){const e=(null==v?void 0:v.uid)?this.adapterRef.remoteStreamMap[null==v?void 0:v.uid]:null;if("video"===_||"screen"===_){f.remoteuid=""+(null==v?void 0:v.uid);const t=null===(a=null==e?void 0:e._play[_])||void 0===a?void 0:a.dom;if("supported"!==this.chromeLegecy){null===(n=this.formativeStatsReport)||void 0===n||n.formatRecvData(f,_),f.LayerType="video"===_?1:2,e&&(f.MuteState=e.getMuteStatus(_).muted),f.PacketLossRate=f.packetsLostRate,f.RecvBitrate=f.bitsReceivedPerSecond,f.RecvResolutionHeight=f.frameHeightReceived,f.RecvResolutionWidth=f.frameWidthReceived,f.RenderFrameRate=f.frameRateReceived,t&&(f.RenderResolutionHeight=t.videoHeight,f.RenderResolutionWidth=t.videoWidth,(null===(o=t.played)||void 0===o?void 0:o.length)&&t.played.end&&(f.TotalPlayDuration=t.played.end(0))),f.TotalFreezeTime=f.totalFreezeTime,f.TransportDelay=f.rtt;const i={LayerType:f.LayerType,CodecName:f.CodecName,End2EndDelay:f.End2EndDelay,MuteState:f.MuteState,PacketLossRate:f.PacketLossRate,RecvBitrate:f.RecvBitrate,RecvResolutionHeight:f.RecvResolutionHeight,RecvResolutionWidth:f.RecvResolutionWidth,RenderFrameRate:f.RenderFrameRate,RenderResolutionHeight:f.RenderResolutionHeight,RenderResolutionWidth:f.RenderResolutionWidth,TotalFreezeTime:f.TotalFreezeTime,TotalPlayDuration:f.TotalPlayDuration,TransportDelay:f.TransportDelay};"video"===_?this.adapterRef.remoteVideoStats[f.remoteuid]=i:this.adapterRef.remoteScreenStats[f.remoteuid]=i}}else if("audio"===_||"audioSlave"===_){if(m.remoteuid=""+(null==v?void 0:v.uid),"supported"!==this.chromeLegecy){null===(p=this.formativeStatsReport)||void 0===p||p.formatRecvData(m,_),e&&(m.MuteState=e.getMuteStatus(_).muted),m.PacketLossRate=m.packetsLostRate,m.RecvBitrate=m.packetsReceivedPerSecond,m.RecvLevel=m.audioOutputLevel,m.TotalFreezeTime=m.totalFreezeTime,m.TotalPlayDuration=m.totalSamplesDuration,m.TransportDelay=m.rtt;const t={CodecType:m.CodecType,End2EndDelay:m.End2EndDelay,MuteState:m.MuteState,PacketLossRate:m.PacketLossRate,RecvBitrate:m.RecvBitrate,RecvLevel:m.RecvLevel,TotalFreezeTime:m.TotalFreezeTime,TotalPlayDuration:m.TotalPlayDuration,TransportDelay:m.TransportDelay};"audio"===_?this.adapterRef.remoteAudioStats[m.remoteuid]=t:"audioSlave"===_&&(this.adapterRef.remoteAudioSlaveStats[m.remoteuid]=t)}if(m.audioOutputLevel){const t=_&&(null==e?void 0:e.isPlaying(_))||!1;this.audioLevel.push({uid:m.remoteuid,level:t&&+m.audioOutputLevel||0,type:_})}}}return(null==_?void 0:_.includes("audio"))?y[_+"_ssrc"]=[m]:"video"!==_&&"screen"!==_||(y[_+"_ssrc"]=[f]),y}async safari(e,t){var i,r;if(!e.getTransceivers)return{};let s={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const a=e.getTransceivers();for(let e=0;e<a.length;e++){let n=null;const o=a[e];"sendonly"===o.direction?o.sender&&o.sender.getStats&&(this.markStatsStart(t),n=await o.sender.getStats(),n=this.formatSafariStandardizedStats(n,t,(null===(i=o.sender.track)||void 0===i?void 0:i.kind)||""),n.video_ssrc&&s.video_ssrc?(s.video_ssrc.push(n.video_ssrc[0]),s.video_ssrc.length>1&&"low"===(s.video_ssrc[0]||{}).streamType&&([s.video_ssrc[0],s.video_ssrc[1]]=[s.video_ssrc[1],s.video_ssrc[0]])):n.screen_ssrc&&s.screen_ssrc?(s.screen_ssrc.push(n.screen_ssrc[0]),s.screen_ssrc.length>1&&"low"===(s.screen_ssrc[0]||{}).streamType&&([s.screen_ssrc[0],s.screen_ssrc[1]]=[s.screen_ssrc[1],s.screen_ssrc[0]])):Object.assign(s,n)):"recvonly"===o.direction&&o.receiver&&o.receiver.getStats&&(this.markStatsStart(t),n=await o.receiver.getStats(),n=this.formatSafariStandardizedStats(n,t,(null===(r=o.receiver.track)||void 0===r?void 0:r.kind)||""),n.audio_ssrc&&s.audio_ssrc?s.audio_ssrc.push(n.audio_ssrc[0]):n.audioSlave_ssrc&&s.audioSlave_ssrc?s.audioSlave_ssrc.push(n.audioSlave_ssrc[0]):n.video_ssrc&&s.video_ssrc?s.video_ssrc.push(n.video_ssrc[0]):n.screen_ssrc&&s.screen_ssrc?s.screen_ssrc.push(n.screen_ssrc[0]):Object.assign(s,n))}return s}formatSafariStandardizedStats(e,t,i){var r,s,a,n,d,c,l;const u={},h={};let p=0;e.forEach((e=>{"track"==e.type?"audio"===e.kind||"audio"===i?(u.active=e.ended?0:1,void 0!==e.audioLevel&&(u.audioOutputLevel=Math.round(32768*e.audioLevel))):"video"!==e.kind&&"video"!==i||(h.active=e.ended?0:1,"send"===t?(h.frameWidthInput=e.width||e.frameWidth,h.frameHeightInput=e.height||e.frameHeight,void 0!==e.framesSent&&(h.framesSent=e.framesSent)):"recv"===t&&(h.frameWidthReceived=e.width||e.frameWidth,h.frameHeightReceived=e.height||e.frameHeight,void 0!==e.framesDecoded&&(h.framesDecoded=e.framesDecoded),void 0!==e.framesReceived&&(h.framesReceived=e.framesReceived),void 0!==e.framesDropped&&(h.framesDropped=e.framesDropped))):"outbound-rtp"==e.type?(p=e.ssrc,"audio"===e.kind||"audio"===e.mediaType||"audio"===i?(u.bytesSent=(e.headerBytesSent||0)+e.bytesSent,u.packetsSent=e.packetsSent,void 0!==e.nackCount&&(u.nackCount=e.nackCount)):"video"!==e.kind&&"video"!==e.mediaType&&"video"!==i||(h.bytesSent=(e.headerBytesSent||0)+e.bytesSent,h.firCount=e.firCount,h.nackCount=e.nackCount,h.pliCount=e.pliCount,h.framesEncoded=e.framesEncoded,void 0!==e.hugeFramesSent&&(h.hugeFramesSent=e.hugeFramesSent),h.packetsSent=e.packetsSent,h.qpSum=e.qpSum,void 0!==e.qualityLimitationResolutionChanges&&(h.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges),void 0!==e.totalEncodeTime&&(h.avgEncodeMs=Math.round(1e3*e.totalEncodeTime/e.framesEncoded)),void 0!==e.framesPerSecond&&(h.frameRateSent=e.framesPerSecond),void 0!==e.frameWidth&&(h.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(h.frameHeightSent=e.frameHeight),o.IS_ANY_SAFARI&&o.SAFARI_MAJOR_VERSION&&o.SAFARI_MAJOR_VERSION>=17&&(h.frameWidthInput=e.frameWidth,h.frameHeightInput=e.frameHeight,void 0!==e.framesSent&&(h.framesSent=e.framesSent)))):"remote-inbound-rtp"==e.type?"audio"===e.kind?(void 0!==e.jitter&&(u.jitterReceived=Math.round(1e3*e.jitter)),void 0!==e.packetsLost&&(u.packetsLost=e.packetsLost),u.rtt=Math.round(1e3*e.roundTripTime)):"video"===e.kind&&(void 0!==e.jitter&&(h.jitter=Math.round(1e3*e.jitter)),void 0!==e.packetsLost&&(h.packetsLost=e.packetsLost),h.rtt=Math.round(1e3*e.roundTripTime)):"inbound-rtp"==e.type?(p=e.ssrc,"audio"===e.kind||"audio"===e.mediaType||"audio"===i?(void 0!==e.audioLevel&&(u.audioOutputLevel=Math.round(32768*e.audioLevel)),void 0!==e.totalAudioEnergy&&(u.totalAudioEnergy=Math.round(e.totalAudioEnergy)),void 0!==e.totalSamplesReceived&&(u.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3)),u.bytesReceived=(e.headerBytesReceived||0)+e.bytesReceived,void 0!==e.concealedSamples&&(u.concealedSamples=e.concealedSamples),void 0!==e.estimatedPlayoutTimestamp&&(u.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.jitter&&(u.jitter=Math.round(1e3*e.jitter)),void 0!==e.jitterBufferDelay&&(u.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)),void 0!==e.lastPacketReceivedTimestamp&&(u.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp),void 0!==e.nackCount&&(u.nackCount=e.nackCount),void 0!==e.silentConcealedSamples&&(u.silentConcealedSamples=e.silentConcealedSamples),u.packetsLost=e.packetsLost,u.packetsReceived=e.packetsReceived,void 0!==e.jitter&&(u.jitter=Math.round(1e3*e.jitter))):"video"!==e.kind&&"video"!==e.mediaType&&"video"!==i||(h.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),void 0!==e.estimatedPlayoutTimestamp&&(h.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.lastPacketReceivedTimestamp&&(h.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp),h.firCount=e.firCount,h.nackCount=e.nackCount,h.pliCount=e.pliCount,void 0!==e.framesDecoded&&(h.framesDecoded=e.framesDecoded),void 0!==e.framesDropped&&(h.framesDropped=e.framesDropped),void 0!==e.framesReceived&&(h.framesReceived=e.framesReceived),h.packetsReceived=e.packetsReceived,h.packetsLost=e.packetsLost,void 0!==e.framesPerSecond&&(h.frameRateReceived=e.framesPerSecond),void 0!==e.frameWidth&&(h.frameWidthReceived=e.frameWidth),void 0!==e.frameHeight&&(h.frameHeightReceived=e.frameHeight),void 0!==e.jitter&&(h.jitter=Math.round(1e3*e.jitter)),void 0!==e.jitterBufferDelay&&(h.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount)),o.IS_ANY_SAFARI&&o.SAFARI_MAJOR_VERSION&&o.SAFARI_MAJOR_VERSION>=17&&(h.frameWidthReceived=e.frameWidth,h.frameHeightReceived=e.frameHeight,void 0!==e.framesDecoded&&(h.framesDecoded=e.framesDecoded),void 0!==e.framesReceived&&(h.framesReceived=e.framesReceived),void 0!==e.framesDropped&&(h.framesDropped=e.framesDropped)))):"remote-outbound-rtp"==e.type&&("audio"===e.kind?(void 0!==e.jitter&&(u.jitter=Math.round(1e3*e.jitter)),void 0!==e.roundTripTime&&(u.rtt=Math.round(1e3*e.roundTripTime))):e.kind)}));const m=null===(r=null==this?void 0:this.adapterRef)||void 0===r?void 0:r.instance.getUidAndKindBySsrc(p);let f=null==m?void 0:m.kind;"{}"!==JSON.stringify(h)&&"send"===t&&(h.streamType=(null==m?void 0:m.streamType)||"high");const g={};if("recv"===t)if(null===(s=this.formativeStatsReport)||void 0===s||s.clearFirstRecvData(null==m?void 0:m.uid),"{}"!==JSON.stringify(h))h.remoteuid=null==m?void 0:m.uid,null===(a=this.formativeStatsReport)||void 0===a||a.formatRecvData(h,f);else if("{}"!==JSON.stringify(u)&&(u.remoteuid=null==m?void 0:m.uid,null===(n=this.formativeStatsReport)||void 0===n||n.formatRecvData(u,f),u.audioOutputLevel)){const e=null===(d=null==this?void 0:this.adapterRef)||void 0===d?void 0:d.remoteStreamMap[u.remoteuid],t=f&&(null==e?void 0:e.isPlaying(f))||!1;this.audioLevel.push({uid:u.remoteuid,level:t&&+u.audioOutputLevel||0,type:f})}return(null==f?void 0:f.includes("audio"))?("send"===t&&(null===(c=this.formativeStatsReport)||void 0===c||c.formatSendData(u,f)),o.IS_ANY_SAFARI&&o.SAFARI_MAJOR_VERSION&&o.SAFARI_MAJOR_VERSION<17?"number"==typeof u.active&&(g[f+"_ssrc"]=[u]):"send"===t?"number"==typeof u.bitsSentPerSecond&&"number"==typeof u.packetsSentPerSecond&&(g[f+"_ssrc"]=[u]):g[f+"_ssrc"]=[u]):"video"!==f&&"screen"!==f||("high"===(null==m?void 0:m.streamType)&&"send"===t&&(null===(l=this.formativeStatsReport)||void 0===l||l.formatSendData(h,f)),o.IS_ANY_SAFARI&&o.SAFARI_MAJOR_VERSION&&o.SAFARI_MAJOR_VERSION<17?"number"==typeof h.active&&(g[f+"_ssrc"]=[h]):"send"===t?h.frameWidthInput&&"number"==typeof h.frameWidthInput&&h.frameHeightInput&&"number"==typeof h.frameHeightInput&&(g[f+"_ssrc"]=[h]):g[f+"_ssrc"]=[h]),g}async firefox(e,t){if(!e.getTransceivers)return{};let i={audio_ssrc:[],audioSlave_ssrc:[],video_ssrc:[],screen_ssrc:[]};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?a.sender&&a.sender.getStats&&(this.markStatsStart(t),s=await a.sender.getStats(),s=this.formatFirefoxStandardizedStats(s,t),Object.assign(i,s)):"recvonly"===a.direction&&a.receiver&&a.receiver.getStats&&(this.markStatsStart(t),s=await a.receiver.getStats(),s=this.formatFirefoxStandardizedStats(s,t),s.audio_ssrc&&i.audio_ssrc?i.audio_ssrc.push(s.audio_ssrc[0]):s.audioSlave_ssrc&&i.audioSlave_ssrc?i.audioSlave_ssrc.push(s.audioSlave_ssrc[0]):s.video_ssrc&&i.video_ssrc?i.video_ssrc.push(s.video_ssrc[0]):s.screen_ssrc&&i.screen_ssrc?i.screen_ssrc.push(s.screen_ssrc[0]):Object.assign(i,s))}return i}formatFirefoxStandardizedStats(e,t){var i,r,s,a,n,o,d;const c={},l={};let u=0;e.forEach((e=>{"outbound-rtp"==e.type?(u=e.ssrc,"audio"===e.kind?(c.bytesSent=(e.headerBytesSent||0)+e.bytesSent,c.packetsSent=e.packetsSent,c.nackCount=e.nackCount):"video"===e.kind&&(l.bytesSent=(e.headerBytesSent||0)+e.bytesSent,l.firCount=e.firCount,l.nackCount=e.nackCount,l.pliCount=e.pliCount,void 0!==e.hugeFramesSent&&(l.hugeFramesSent=e.hugeFramesSent),l.packetsSent=e.packetsSent,l.qpSum=e.qpSum,void 0!==e.framesEncoded&&(l.framesEncoded=e.framesEncoded),void 0!==e.framesSent&&(l.framesSent=e.framesSent),void 0!==e.totalEncodeTime&&void 0!==e.framesEncoded&&(l.avgEncodeMs=Math.round(1e3*e.totalEncodeTime/e.framesEncoded)),void 0!==e.framesPerSecond&&(l.frameRateSent=e.framesPerSecond),void 0!==e.frameWidth&&(l.frameWidthSent=e.frameWidth),void 0!==e.frameHeight&&(l.frameHeightSent=e.frameHeight))):"remote-inbound-rtp"==e.type?"video"===e.kind&&(l.fractionLost=e.fractionLost,l.jitter=Math.round(1e3*e.jitter),l.packetsLost=e.packetsLost,l.rtt=Math.round(1e3*e.roundTripTime)):"inbound-rtp"==e.type&&(u=e.ssrc,"audio"===e.kind?(void 0!==e.audioLevel&&(c.audioOutputLevel=Math.round(32768*e.audioLevel)),void 0!==e.insertedSamplesForDeceleration&&(c.preemptiveExpandRate=parseInt(e.insertedSamplesForDeceleration)),void 0!==e.removedSamplesForAcceleration&&(c.speechExpandRate=parseInt(e.removedSamplesForAcceleration)),c.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),c.concealedSamples=e.concealedSamples,c.jitter=Math.round(1e3*e.jitter),c.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount),c.silentConcealedSamples=e.silentConcealedSamples,c.packetsLost=e.packetsLost,c.packetsReceived=e.packetsReceived,void 0!==e.totalSamplesReceived&&(c.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3)),void 0!==e.totalAudioEnergy&&(c.totalAudioEnergy=Math.round(e.totalAudioEnergy)),void 0!==e.totalSamplesReceived&&(c.totalSamplesDuration=Math.round(e.totalSamplesReceived/48e3))):"video"===e.kind&&(l.bytesReceived=e.bytesReceived+(e.headerBytesReceived||0),l.firCount=e.firCount,l.nackCount=e.nackCount,l.pliCount=e.pliCount,l.framesDecoded=e.framesDecoded,l.framesDropped=e.framesReceived-e.framesDecoded,l.framesReceived=e.framesReceived,l.packetsReceived=e.packetsReceived,l.packetsLost=e.packetsLost,l.frameRateReceived=e.framesPerSecond||0,l.frameWidthReceived=e.frameWidth,l.frameHeightReceived=e.frameHeight,l.jitterBufferDelay=Math.round(1e3*e.jitterBufferDelay/e.jitterBufferEmittedCount),void 0!==e.estimatedPlayoutTimestamp&&(l.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp),void 0!==e.lastPacketReceivedTimestamp&&(l.lastPacketReceivedTimestamp=e.lastPacketReceivedTimestamp)))}));const h=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i.instance.getUidAndKindBySsrc(u);let p=null==h?void 0:h.kind;"{}"!==JSON.stringify(l)&&"send"===t&&(l.streamType=(null==h?void 0:h.streamType)||"high");const m={};if("recv"===t)if(null===(r=this.formativeStatsReport)||void 0===r||r.clearFirstRecvData(null==h?void 0:h.uid),"{}"!==JSON.stringify(l))l.remoteuid=null==h?void 0:h.uid,null===(s=this.formativeStatsReport)||void 0===s||s.formatRecvData(l,p);else if("{}"!==JSON.stringify(c)&&(c.remoteuid=null==h?void 0:h.uid,null===(a=this.formativeStatsReport)||void 0===a||a.formatRecvData(c,p),c.audioOutputLevel)){const e=null===(n=null==this?void 0:this.adapterRef)||void 0===n?void 0:n.remoteStreamMap[c.remoteuid],t=p&&(null==e?void 0:e.isPlaying(p))||!1;this.audioLevel.push({uid:c.remoteuid,level:t&&+c.audioOutputLevel||0,type:p})}return(null==p?void 0:p.includes("audio"))?("send"===t&&(null===(o=this.formativeStatsReport)||void 0===o||o.formatSendData(c,p)),m[p+"_ssrc"]=[c]):"video"!==p&&"screen"!==p||("high"===(null==h?void 0:h.streamType)&&"send"===t&&(null===(d=this.formativeStatsReport)||void 0===d||d.formatSendData(l,p)),m[p+"_ssrc"]=[l]),m}stop(){this._reset()}destroy(){this._reset()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.FormativeStatsReport=void 0,t.FormativeStatsReport=class{constructor(e){this.adapterRef=e.adapterRef,this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{},upCandidatePairStatsCache:{},downCandidatePairStatsCache:{}}}_reset(){this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.statsCatch={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{},upTransportCache:{},downTransportCache:{},upCandidatePairStatsCache:{},downCandidatePairStatsCache:{}}}clearFirstRecvData(e){const t=this.adapterRef.remoteStreamMap[e],i=this.firstData.recvFirstData[e];t&&i&&(""===t.pubStatus.audio.consumerId&&(i.recvFirstAudioFrame=i.recvFirstAudioPackage=!1,this.statsCatch.downAudioCache[e]=null),""===t.pubStatus.audioSlave.consumerId&&(this.statsCatch.downAudioSlaveCache[e]=null),""===t.pubStatus.video.consumerId&&(i.recvFirstVideoFrame=i.recvFirstVideoPackage=!1,this.statsCatch.downVideoCache[e]=null),""===t.pubStatus.screen.consumerId&&(i.recvFirstScreenFrame=i.recvFirstScreenPackage=!1,this.statsCatch.downScreenCache[e]=null))}formatTransportData(e,t){let i;"send"===t?(this.adapterRef.transportStats.rxRtt=e.googRtt-0,this.adapterRef.transportStats.txRtt=e.googRtt-0,this.adapterRef.sessionStats.SendBytes=e.bytesSent-0,this.statsCatch.upTransportCache&&(i=this.statsCatch.upTransportCache),this.statsCatch.upTransportCache=e,i&&(this.adapterRef.sessionStats.SendBitrate=Math.round(8*(e.bytesSent-i.bytesSent)/1e3))):(this.adapterRef.sessionStats.RecvBytes=e.bytesReceived-0,this.statsCatch.downTransportCache&&(i=this.statsCatch.downTransportCache),this.statsCatch.downTransportCache=e,i&&(this.adapterRef.sessionStats.RecvBitrate=Math.round(8*(e.bytesReceived-i.bytesReceived)/1e3)))}formatTransportDataChrome117(e,t){var i,r;if("send"===t){const t=this.statsCatch.upCandidatePairStatsCache;if(t&&t.timestamp&&e.timestamp-t.timestamp<900)return;this.adapterRef.transportStats.txRtt=Math.round(1e3*e.currentRoundTripTime);const r=null===(i=this.statsCatch.downCandidatePairStatsCache)||void 0===i?void 0:i.timestamp;(!r||e.timestamp-r>2e3)&&(this.adapterRef.transportStats.rxRtt=this.adapterRef.transportStats.txRtt),this.adapterRef.sessionStats.SendBytes=e.bytesSent,this.adapterRef.transportStats.OutgoingAvailableBandwidth=e.availableOutgoingBitrate/1e3,this.statsCatch.upCandidatePairStatsCache=e,t&&t.timestamp&&(this.adapterRef.sessionStats.SendBitrate=Math.round(8*(e.bytesSent-(t.bytesSent||0))/1e3))}else{const t=this.statsCatch.downCandidatePairStatsCache;if(t&&t.timestamp&&e.timestamp-t.timestamp<900)return;this.adapterRef.transportStats.rxRtt=Math.round(1e3*e.currentRoundTripTime),this.adapterRef.transportStats.txRtt<1&&(this.adapterRef.transportStats.txRtt=this.adapterRef.transportStats.rxRtt);const i=null===(r=this.statsCatch.upCandidatePairStatsCache)||void 0===r?void 0:r.timestamp;(!i||e.timestamp-i>2e3)&&(this.adapterRef.transportStats.txRtt=this.adapterRef.transportStats.rxRtt),this.adapterRef.sessionStats.RecvBytes=e.bytesReceived,this.statsCatch.downCandidatePairStatsCache=e,t&&t.timestamp&&(this.adapterRef.sessionStats.RecvBitrate=Math.round(8*(e.bytesReceived-(t.bytesReceived||0))/1e3))}}formatSendData(e,t){var i,r,s,a,n,o,d,c;let l;if("audio"===t){if(!(null===(r=null===(i=null==this?void 0:this.adapterRef)||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._micProducer))return this.firstData.sendFirstAudioPackage=!1,void(this.statsCatch.upAudioCache={});e.packetsSent>0&&!this.firstData.sendFirstAudioPackage&&(this.firstData.sendFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:0})),this.statsCatch.upAudioCache&&(l=this.statsCatch.upAudioCache),this.statsCatch.upAudioCache=e}else if("audioSlave"===t){if(!(null===(a=null===(s=null==this?void 0:this.adapterRef)||void 0===s?void 0:s._mediasoup)||void 0===a?void 0:a._audioSlaveProducer))return void(this.statsCatch.upAudioSlaveCache={});this.statsCatch.upAudioSlaveCache&&(l=this.statsCatch.upAudioSlaveCache),this.statsCatch.upAudioSlaveCache=e,this.dispatchExceptionEventSendAudio(l,e)}else if("video"===t){if(!(null===(o=null===(n=null==this?void 0:this.adapterRef)||void 0===n?void 0:n._mediasoup)||void 0===o?void 0:o._webcamProducer))return this.firstData.sendFirstVideoPackage=!1,void(this.statsCatch.upVideoCache={});e.packetsSent>0&&!this.firstData.sendFirstVideoPackage&&(this.firstData.sendFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:1})),this.statsCatch.upVideoCache&&(l=this.statsCatch.upVideoCache),this.statsCatch.upVideoCache=e,this.dispatchExceptionEventSendVideo(l,e)}else if("screen"===t){if(!(null===(c=null===(d=null==this?void 0:this.adapterRef)||void 0===d?void 0:d._mediasoup)||void 0===c?void 0:c._screenProducer))return this.firstData.sendFirstScreenPackage=!1,void(this.statsCatch.upScreenCache={});e.packetsSent>0&&!this.firstData.sendFirstScreenPackage&&(this.firstData.sendFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:2})),this.statsCatch.upScreenCache&&(l=this.statsCatch.upScreenCache),this.statsCatch.upScreenCache=e}if(e.bitsSentPerSecond||(e.bitsSentPerSecond=Math.round(8*(e.bytesSent-(l.bytesSent||0))/1e3)),e.packetsSentPerSecond||(e.packetsSentPerSecond=e.packetsSent-(l.packetsSent||0)),e.packetsLostRate||void 0!==e.packetsLost&&(e.packetsLostRate=this.getPacketLossRate(l,e,!0)),e.streamType){e.framesEncodedPerSecond||e.framesEncoded>=l.framesEncoded&&(e.framesEncodedPerSecond=e.framesEncoded-l.framesEncoded),e.qpPercentage||(e.qpPercentage=this.getQpPercentage(l,e)),e.frameRateSent||(e.frameRateSent=e.framesSent-l.framesSent);let i={freezeTime:0,totalFreezeTime:0};"video"===t?i=this.getLocalVideoFreezeStats(e):"screen"===t&&(i=this.getLocalScreenFreezeStats(e)),e.freezeTime||(e.freezeTime=i.freezeTime),e.totalFreezeTime||(e.totalFreezeTime=i.totalFreezeTime)}}formatRecvData(e,t){let i;const r=e.remoteuid||0;if(this.clearFirstRecvData(r),this.firstData.recvFirstData[r]||(this.firstData.recvFirstData[r]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1}),"audio"===t?(!this.firstData.recvFirstData[r].recvFirstAudioPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:0,pull_uid:r})),e.decodingNormal&&e.decodingNormal>0&&!this.firstData.recvFirstData[r].recvFirstAudioFrame&&(this.firstData.recvFirstData[r].recvFirstAudioFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:0,pull_uid:r})),this.statsCatch.downAudioCache&&(i=this.statsCatch.downAudioCache[r]),this.statsCatch.downAudioCache[r]=e,this.dispatchExceptionEventRecvAudio(i,e,r)):"audioSlave"===t?(this.statsCatch.downAudioSlaveCache&&(i=this.statsCatch.downAudioSlaveCache[r]),this.statsCatch.downAudioSlaveCache[r]=e):"video"===t?(!this.firstData.recvFirstData[r].recvFirstVideoPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:1,pull_uid:r})),!this.firstData.recvFirstData[r].recvFirstVideoFrame&&e.framesDecoded>0&&(this.firstData.recvFirstData[r].recvFirstVideoFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:1,pull_uid:r})),this.statsCatch.downVideoCache&&(i=this.statsCatch.downVideoCache[r]),this.statsCatch.downVideoCache[r]=e,this.dispatchExceptionEventRecvVideo(i,e,r)):"screen"===t&&(!this.firstData.recvFirstData[r].recvFirstScreenPackage&&e.packetsReceived>0&&(this.firstData.recvFirstData[r].recvFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:2,pull_uid:r})),!this.firstData.recvFirstData[r].recvFirstScreenFrame&&e.framesDecoded>0&&(this.firstData.recvFirstData[r].recvFirstScreenFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:2,pull_uid:r})),this.statsCatch.downScreenCache&&(i=this.statsCatch.downScreenCache[r]),this.statsCatch.downScreenCache[r]=e,this.dispatchExceptionEventRecvScreen(i,e,r)),!i||e.bytesReceived<i.bytesReceived)return;let s={freezeTime:0,totalFreezeTime:0};e.bitsReceivedPerSecond||(e.bitsReceivedPerSecond=Math.round(8*(e.bytesReceived-i.bytesReceived)/1e3)),e.packetsReceivedPerSecond||(e.packetsReceivedPerSecond=e.packetsReceived-i.packetsReceived),e.packetsLost||void 0!==e.packetsLost&&(e.packetsLostRate=this.getPacketLossRate(i,e)),"video"===t||"screen"===t?(e.frameRateReceived||(e.frameRateReceived=e.framesReceived-i.framesReceived),e.frameRateDecoded||(e.frameRateDecoded=e.framesDecoded-i.framesDecoded),"video"===t?s=this.getRemoteVideoFreezeStats(i,e,r):"screen"===t&&(s=this.getRemoteScreenFreezeStats(i,e,r))):e.decodingCTN&&(s=this.getRemoteAudioFreezeStats(i,e,r)),e.freezeTime||(e.freezeTime=s.freezeTime),e.totalFreezeTime||(e.totalFreezeTime=s.totalFreezeTime)}getQpPercentage(e,t){if(!(e&&e.framesEncoded&&e.qpSum&&t&&t.framesEncoded&&t.qpSum))return 0;const i=t.qpSum-e.qpSum,r=t.framesEncoded-e.framesEncoded;return i<=0||r<=0?0:i>r?100:Math.round(i/r*100)}getPacketLossRate(e,t,i=!1){if(!e||!t)return 0;const r=parseInt(e.packetsLost)||0,s=parseInt(t.packetsLost)||0;if(s<=r)return 0;const a=i?e.packetsSent:e.packetsReceived,n=i?t.packetsSent:t.packetsReceived,o=parseInt(a||"")||0,d=parseInt(n||"")||0;return d<=o?0:i?Math.round((s-r)/(d-o)*100):Math.round((s-r)/(s-r+(d-o))*100)}getLocalVideoFreezeStats(e){let t=0;if(!e||!e.frameRateSent)return{totalFreezeTime:t,freezeTime:0};let i=0,r=parseInt(e.frameRateSent);if(r<=0)return{totalFreezeTime:2e3,freezeTime:6};if(r>15)return{totalFreezeTime:0,freezeTime:0};i=Math.abs(15-r),t=parseInt(2e3*i);let s=0;return t<300?(t=0,s=0):s=t>1500?6:parseInt(t/300),{totalFreezeTime:t,freezeTime:s}}getLocalScreenFreezeStats(e){let t=0;if(!e||!e.frameRateSent)return{totalFreezeTime:t,freezeTime:0};let i=parseInt(e.framesEncoded)||0,r=parseInt(e.framesSent)||0;if(i<=0||r<=0)return{totalFreezeTime:2e3,freezeTime:6};let s=Math.abs(i-r);t=parseInt(s/i*2e3);let a=0;return t<300?(t=0,a=0):a=t>1500?6:parseInt(t/300),{totalFreezeTime:t,freezeTime:a}}getRemoteAudioFreezeStats(e,t,i){if(!e||!t)return{totalFreezeTime:0,freezeTime:0};let r=parseInt(e.decodingPLC)+parseInt(e.decodingCNG)+parseInt(e.decodingPLCCNG),s=parseInt(e.decodingCTN),a=parseInt(e.decodingPLC)+parseInt(e.decodingCNG)+parseInt(e.decodingPLCCNG),n=parseInt(t.decodingCTN);if(n<=r)return{totalFreezeTime:0,freezeTime:0};let o=(a-r)/(n-s);return{totalFreezeTime:parseInt(1e3*o),freezeTime:10*o>1?parseInt(10*o):o>0?1:0}}getRemoteVideoFreezeStats(e,t,i){let r=0;if(!t||0==t.framesDecoded)return{totalFreezeTime:r,freezeTime:0};if(t&&t.framesDecoded&&0==t.frameRateDecoded)return{totalFreezeTime:2e3,freezeTime:6};let s=parseInt(t.frameRateReceived)||0,a=parseInt(t.frameRateDecoded);if(s<=0||a<=0)return{totalFreezeTime:2e3,freezeTime:6};let n=0;if(s>15)return{totalFreezeTime:0,freezeTime:0};n=Math.abs(15-s),r=parseInt(n/15*2e3),r>2e3&&(r=2e3);let o=0;return r<300?(r=0,o=0):o=r>1500?6:parseInt(r/300),{totalFreezeTime:r,freezeTime:o}}getRemoteScreenFreezeStats(e,t,i){let r=0;if(!t)return{totalFreezeTime:r,freezeTime:0};let s=parseInt(t.frameRateReceived),a=parseInt(t.frameRateDecoded);if(s<=0||a<=0)return{totalFreezeTime:2e3,freezeTime:6};let n=Math.abs(a-s);r=parseInt(n/s*2e3)||0;let o=0;return r<300?(r=0,o=0):o=r>1500?6:parseInt(r/300),{totalFreezeTime:r,freezeTime:o}}dispatchExceptionEventSendAudio(e,t){var i,r,s,a;if(!e||!t)return;const n=null===(i=this.adapterRef.localStream)||void 0===i?void 0:i.muteStatus.audio.send,o=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.pubStatus.audio.audio;!0!==n&&!1!==o&&(0===t.audioInputLevel&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_INPUT_LEVEL_TOO_LOW",code:2001,uid:(null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid)||0}),0==parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"SEND_AUDIO_BITRATE_TOO_LOW",code:2003,uid:(null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid)||0}))}dispatchExceptionEventSendVideo(e,t){var i,r,s,a;if(!e||!t)return;const n=null===(i=this.adapterRef.localStream)||void 0===i?void 0:i.muteStatus.video.send,o=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.pubStatus.video.video;!0!==n&&!1!==o&&(t.frameRateInput&&parseInt(t.frameRateInput)>5&&parseInt(t.frameRateSent)<=1&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_SENT_TOO_LOW",code:1002,uid:(null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid)||0}),0==parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_VIDEO_BITRATE_TOO_LOW",code:1003,uid:(null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid)||0}))}dispatchExceptionEventRecvAudio(e,t,i){if(!e||!t||!t.googDecodingNormal)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.audio.send||r.muteStatus.audio.recv);if(r&&s)return;if(!r||!r.Play||!r.Play.audio.dom||!r.Play.audio.dom.srcObject||r.Play.audio.dom.muted)return;let a=parseInt(t.bytesReceived)-parseInt(e.bytesReceived),n=parseInt(t.decodingNormal)-parseInt(e.decodingNormal);if(a>0&&0===n&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_AUDIO_DECODE_FAILED",code:2005,uid:i}),a>0&&n>0&&0==+(t.audioOutputLevel||t.audioLevel)){const e=r&&r.Play&&r.Play.audio.dom&&r.Play.audio.dom.volume;e&&e>0&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_OUTPUT_LEVEL_TOO_LOW",code:2002,uid:i})}}dispatchExceptionEventRecvVideo(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.video.send||r.muteStatus.video.recv);r&&s||parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.frameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_VIDEO_DECODE_FAILED",code:1005,uid:i})}dispatchExceptionEventRecvScreen(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.screen.send||r.muteStatus.screen.recv);r&&s||parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.frameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_SCREEN_DECODE_FAILED",code:1005,uid:i})}destroy(){this._reset()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.FormativeStatsVideo=t.FormativeStatsAudio=void 0,t.FormativeStatsAudio=class{constructor(){this.echoReturnLoss="",this.echoReturnLossEnhancement="",this.CodecType="",this.totalFreezeTime=0,this.remoteuid=""}},t.FormativeStatsVideo=class{constructor(){this.totalFreezeTime=0,this.qualityLimitationReason="",this.streamType="",this.CodecName="",this.CodecImplementationName="",this.remoteuid=""}}},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/*
     * [js-sha1]{@link https://github.com/emn178/js-sha1}
     *
     * @version 0.6.0
     * @author Chen, Yi-Cyuan [emn178@gmail.com]
     * @copyright Chen, Yi-Cyuan 2014-2017
     * @license MIT
     */!function(){var root="object"==typeof window?window:{},NODE_JS=!root.JS_SHA1_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS&&(root=global);var COMMON_JS=!root.JS_SHA1_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(281),HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[],createOutputMethod=function(e){return function(t){return new Sha1(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Sha1},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var i=OUTPUT_TYPES[t];e[i]=createOutputMethod(i)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("sha1").update(e,"utf8").digest("hex");if(e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(void 0===e.length)return method(e);return crypto.createHash("sha1").update(new Buffer(e)).digest("hex")};return nodeMethod};function Sha1(e){e?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Sha1.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===root.ArrayBuffer&&(e=new Uint8Array(e));for(var i,r,s=0,a=e.length||0,n=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),t)for(r=this.start;s<a&&r<64;++s)n[r>>2]|=e[s]<<SHIFT[3&r++];else for(r=this.start;s<a&&r<64;++s)(i=e.charCodeAt(s))<128?n[r>>2]|=i<<SHIFT[3&r++]:i<2048?(n[r>>2]|=(192|i>>6)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]):i<55296||i>=57344?(n[r>>2]|=(224|i>>12)<<SHIFT[3&r++],n[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++s)),n[r>>2]|=(240|i>>18)<<SHIFT[3&r++],n[r>>2]|=(128|i>>12&63)<<SHIFT[3&r++],n[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],n[r>>2]|=(128|63&i)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=n[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=EXTRA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Sha1.prototype.hash=function(){var e,t,i=this.h0,r=this.h1,s=this.h2,a=this.h3,n=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(n=(t=i<<5|i>>>27)+(r&s|~r&a)+n+1518500249+o[e]<<0)<<5|n>>>27)+(i&(r=r<<30|r>>>2)|~i&s)+a+1518500249+o[e+1]<<0)<<5|a>>>27)+(n&(i=i<<30|i>>>2)|~n&r)+s+1518500249+o[e+2]<<0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|~a&i)+r+1518500249+o[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|~s&n)+i+1518500249+o[e+4]<<0,s=s<<30|s>>>2;for(;e<40;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(n=(t=i<<5|i>>>27)+(r^s^a)+n+1859775393+o[e]<<0)<<5|n>>>27)+(i^(r=r<<30|r>>>2)^s)+a+1859775393+o[e+1]<<0)<<5|a>>>27)+(n^(i=i<<30|i>>>2)^r)+s+1859775393+o[e+2]<<0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^i)+r+1859775393+o[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^n)+i+1859775393+o[e+4]<<0,s=s<<30|s>>>2;for(;e<60;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(n=(t=i<<5|i>>>27)+(r&s|r&a|s&a)+n-1894007588+o[e]<<0)<<5|n>>>27)+(i&(r=r<<30|r>>>2)|i&s|r&s)+a-1894007588+o[e+1]<<0)<<5|a>>>27)+(n&(i=i<<30|i>>>2)|n&r|i&r)+s-1894007588+o[e+2]<<0)<<5|s>>>27)+(a&(n=n<<30|n>>>2)|a&i|n&i)+r-1894007588+o[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|s&n|a&n)+i-1894007588+o[e+4]<<0,s=s<<30|s>>>2;for(;e<80;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(n=(t=i<<5|i>>>27)+(r^s^a)+n-899497514+o[e]<<0)<<5|n>>>27)+(i^(r=r<<30|r>>>2)^s)+a-899497514+o[e+1]<<0)<<5|a>>>27)+(n^(i=i<<30|i>>>2)^r)+s-899497514+o[e+2]<<0)<<5|s>>>27)+(a^(n=n<<30|n>>>2)^i)+r-899497514+o[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^n)+i-899497514+o[e+4]<<0,s=s<<30|s>>>2;this.h0=this.h0+i<<0,this.h1=this.h1+r<<0,this.h2=this.h2+s<<0,this.h3=this.h3+a<<0,this.h4=this.h4+n<<0},Sha1.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var exports=createMethod();COMMON_JS?module.exports=exports:(root.sha1=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(71),__webpack_require__(62))},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Signalling=void 0;const s=i(11),a=i(283),n=i(57),o=i(68),d=r(i(12)),c=r(i(13)),l=i(295),u=i(75),h=i(120),p=i(150),m=i(2),f=i(145),g=i(297);let v=0;class _ extends s.EventEmitter{constructor(e){super(),this.signallingId=v++,this._reconnectionTimer=null,this._protoo=null,this._url=null,this._resolve=null,this._reject=null,this.consumers={},this.keepAliveTimer=null,this._reconnectionTimeout=3e4,this.joinTimestamps=[],this.reconnectionControl={current:null,next:null,copynext:null},this.autoMask={timer:null,data:[]},this.logger=e.logger.getChild((()=>{var t,i;let r="signal";return this.signallingId&&(r+=this.signallingId),this._protoo?(this._protoo.id&&(r+="#"+this._protoo.id+"_"+(null===(t=this._protoo._transport)||void 0===t?void 0:t.wsid)),this._protoo.connected||(r+="!connected")):r+=" PROTOO_UNINIT",(null===(i=e.adapterRef._signalling)||void 0===i?void 0:i.signallingId)!==this.signallingId&&(r+=" DETACHED"),r})),this._reset(),this.adapterRef=e.adapterRef,this.browserDevice=h.getOSInfo().osName+"-"+h.getBrowserInfo().browserName+"-"+h.getBrowserInfo().browserVersion}async _reset(){this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._destroyProtoo(),this.reconnectionControl.current=null,this.reconnectionControl.next=null,this.reconnectionControl.copynext=null,this._reconnectionTimeout=3e4,this._resolve=null,this._reject=null}init(e,t){return this._reconnectionTimer?Promise.resolve():new Promise((async(i,r)=>{var s;e||(this._resolve=i),e||(this._reject=r);let a=this.reconnectionControl.next||{timeout:t?m.getParameters().reconnectionFirstTimeout:m.getParameters().joinFirstTimeout,url:this.adapterRef.channelInfo.wssArr[0],serverIndex:0,times:t?1:0,isJoinRetry:e,isReconnection:t,isLastTry:!1};if(a.isJoinRetry=e,a.isReconnection=t,t&&"unknown"!==this.adapterRef.signalProbeManager.online&&1===a.times&&m.getParameters().reconnectionWaitTimeout>0&&0===this.adapterRef.signalProbeManager.getActiveServerCount().cnt){const e=m.getParameters().reconnectionWaitTimeout;this.logger.warn(`目前所有服务端不在线，判断为网络断开。等待服务端起上线或 ${e}ms`);const t=await this.adapterRef.signalProbeManager.waitForServerActive(e);if((null===(s=this.adapterRef._signalling)||void 0===s?void 0:s.signallingId)!==this.signallingId)return;this.logger.warn("恢复重连过程。reason:"+t)}for(let e=0;e<6;e++){const e=this.adapterRef.signalProbeManager.getServerState(a.url);if(!e||a.isLastTry)break;if(this.adapterRef.signalProbeManager.getActiveServerCount().cnt>0)if(e.active){if(!(2*e.ping.rtt>a.timeout))break;this.logger.warn(`重连跳过：当前服务器rtt过长：${a.url} ${a.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} timeout: ${a.timeout}ms, rtt x2: ${e.ping.rtt}x2=${2*e.ping.rtt}ms`),a=this._getNextConnConfig(a)}else this.logger.error(`重连跳过：当前服务器不可用：${a.url} ${a.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} ${a.timeout}ms`),a=this._getNextConnConfig(a)}this.adapterRef.channelInfo.wssArrIndex=a.serverIndex,e?t?this.adapterRef.logger.error(`Signalling 开始尝试第 ${a.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${a.times}/${m.getParameters().reconnectionMaxRetry} 次重连，退避时间：${a.timeout}毫秒，服务器地址：${a.url}`):this.adapterRef.logger.error(`Join: 正在尝试第 ${a.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${a.times}/${m.getParameters().joinMaxRetry} 次重连，退避时间：${a.timeout}毫秒，服务器地址：${a.url}`):this.adapterRef.logger.log(`Join: 正在尝试第 ${a.serverIndex+1} / ${this.adapterRef.channelInfo.wssArr.length} 个服务器的第 ${a.times} / ${m.getParameters().joinMaxRetry} 次连接`),this.reconnectionControl.current=a,this.reconnectionControl.next=null,this._init(a.url);let n=this._getNextConnConfig(a);this.reconnectionControl.next=this.reconnectionControl.copynext=n,this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=setTimeout((()=>{var e;if(this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,(null===(e=this.adapterRef._signalling)||void 0===e?void 0:e.signallingId)===this.signallingId){if(this._protoo&&!this._protoo.closed){const e={name:"joinWsTime",code:-1,param:{reason:"timeout",time:Date.now()-this.adapterRef.state.signalEstablishTime,wsId:this._protoo.id,url:a.url,serverIndex:a.serverIndex}};this.adapterRef.instance.apiFrequencyControl(e)}this._destroyProtoo(),t?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),this._reconnection()):this._connection()}}),n.timeout)}))}_getNextConnConfig(e){let t=Object.assign({},e);return e.times?t.serverIndex++:(t.times=1,t.serverIndex=1),t.serverIndex>=this.adapterRef.channelInfo.wssArr.length&&(t.times++,t.serverIndex=0),e.isJoinRetry?t.timeout=m.getParameters().joinFirstTimeout+2e3*(t.times-1):e.isReconnection&&(t.timeout=m.getParameters().reconnectionFirstTimeout+2e3*(t.times-1)),t.isJoinRetry=e.isJoinRetry,t.isReconnection=e.isReconnection,t.isJoinRetry&&t.times>=m.getParameters().joinMaxRetry&&(t.isLastTry=!0),t.isReconnection&&t.times>=m.getParameters().reconnectionMaxRetry&&(t.isLastTry=!0),t.url=this.adapterRef.channelInfo.wssArr[t.serverIndex],t}async _connection(){this._destroyProtoo();const e=this.reconnectionControl.current,t=this.reconnectionControl.next;t?!e||t.times<=m.getParameters().joinMaxRetry?this.init(!0,!1):(this.adapterRef.logger.error("join() 所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server connection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.SIGNAL_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR"),this._reject&&this._reject(new c.default({code:d.default.NETWORK_ERROR,message:"join() 所有的服务器地址都连接失败"}))):this.adapterRef.logger.error("Join结束")}async _reconnection(){var e,t;if(!this._reconnectionTimer){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.reconnect=!0,this.adapterRef.connectState.prevState!==this.adapterRef.connectState.curState&&this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-start"),this._destroyProtoo(),(null===(e=this.adapterRef._mediasoup)||void 0===e?void 0:e._sendTransportTimeoutTimer)&&(clearTimeout(this.adapterRef._mediasoup._sendTransportTimeoutTimer),this.adapterRef._mediasoup._sendTransportTimeoutTimer=null),(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t._recvTransportTimeoutTimer)&&(clearTimeout(this.adapterRef._mediasoup._recvTransportTimeoutTimer),this.adapterRef._mediasoup._recvTransportTimeoutTimer=null),"CONNECTED"===this.adapterRef.connectState.prevState&&(this.adapterRef.netStatusList.forEach((e=>{e.uplinkNetworkQuality=0,e.downlinkNetworkQuality=0})),this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList));for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t._play&&(this.logger.warn("Destroy Remote Player",e),t._play.destroy())}this.reconnectionControl.next&&this.reconnectionControl.next.times>m.getParameters().reconnectionMaxRetry?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-skip"),this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server reconnection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.SIGNAL_CONNECTION_DISCONNECTED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR")):this.init(!0,!0)}}_init(e){-1===e.indexOf("?")&&(e+="?"),this.logger.log("Signalling: init url=",e),this.adapterRef.channelInfo._protooUrl=e,this._url=`${-1===e.indexOf("://")?"wss://":""}${e}&cid=${this.adapterRef.channelInfo.cid}&uid=${this.adapterRef.channelInfo.uid}&deviceid=${this.adapterRef.deviceId}`,this.logger.log("连接的url: ",this._url);const t=new g.WebSocketTransport(this._url,{retry:{retries:0,factor:2,minTimeout:1e3,maxTimeout:2e3,forever:!1,maxRetryTime:2e3}}),i=new g.Peer(t);this._protoo=i,i.signalling=this,this.adapterRef.state.signalEstablishTime=Date.now(),this._bindEvent()}_bindEvent(){var e,t,i,r,s;null===(e=this._protoo)||void 0===e||e.on("failed",this._handleFailed.bind(this)),null===(t=this._protoo)||void 0===t||t.on("close",this._handleClose.bind(this)),null===(i=this._protoo)||void 0===i||i.on("open",this.join.bind(this,this._protoo)),null===(r=this._protoo)||void 0===r||r.on("notification",this._handleMessage.bind(this,this._protoo)),null===(s=this._protoo)||void 0===s||s.on("disconnected",this._handleDisconnected.bind(this,this._protoo))}_destroyProtoo(){var e;if(this._protoo){this.logger.debug(`信令通道#${this._protoo.id}_${null===(e=this._protoo._transport)||void 0===e?void 0:e.wsid} 被主动关闭。`),this._protoo.removeAllListeners();try{this._protoo&&this._protoo.close()}catch(e){}this._protoo=null}}async _handleMessage(e,t){var i,r,s,n,o,c,l;if(!e||!this._isProtooDetached(e))switch(t.method){case"OnPeerJoin":{const{requestId:e,externData:i}=t.data;this.logger.log("收到OnPeerJoin成员加入消息 uid =",i.uid);let r=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=r.toString());let s=this.adapterRef.remoteStreamMap[r];s?s.active=!0:(s=new a.RemoteStream({uid:r,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[r]=s,this.adapterRef.memberMap[r]=r),this.adapterRef.instance._roleInfo.audienceList[r]=!1,this.adapterRef.instance.safeEmit("peer-online",{uid:r}),i.customData&&this.adapterRef.instance.safeEmit("custom-data",{uid:r,customData:i.customData});break}case"OnPeerLeave":{const{requestId:e,externData:i}=t.data;this.logger.log("OnPeerLeave externData =",i),i.userList&&i.userList.forEach((e=>{var t;let i=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(i=i.toString()),null===(t=this.adapterRef._mediasoup)||void 0===t||t.removeUselessConsumeRequest(i,"all"),this.adapterRef.instance.clearMember(i),this.adapterRef.instance.removeSsrc(i),delete this.adapterRef.instance._roleInfo.audienceList[i]}));break}case"OnNewProducer":{const{requestId:e,externData:s}=t.data;this.logger.log("收到OnNewProducer发布消息 externData =",JSON.stringify(s.producerInfo));let n,{uid:o,producerId:d,mediaType:c,mute:l,simulcastEnable:u}=s.producerInfo;switch("string"===this.adapterRef.channelInfo.uidType&&(o=o.toString()),c){case"video":n="video";break;case"screenShare":n="screen";break;case"audio":n="audio";break;case"subAudio":n="audioSlave";break;default:return void this.logger.warn(`OnNewProducer 不支持的媒体类型:${c}, uid ${o}`)}let h=this.adapterRef.remoteStreamMap[o];h?h.active=!0:(h=new a.RemoteStream({uid:o,audio:"audio"===n,audioSlave:"audioSlave"===n,video:"video"===n,screen:"screen"===n,client:this.adapterRef.instance,platformType:s.platformType}),this.adapterRef.remoteStreamMap[o]=h,this.adapterRef.memberMap[o]=o),h.muteStatus[n].send=s.producerInfo.mute,h.pubStatus[n].consumerId?null===(i=this.adapterRef._mediasoup)||void 0===i||i.destroyConsumer(h.pubStatus[n].consumerId,h,n):null===(r=this.adapterRef._mediasoup)||void 0===r||r.removeUselessConsumeRequest(o,c),h[n]=!0,h.pubStatus[n][n]=!0,h.pubStatus[n].producerId=d,h.pubStatus[n].mute=l,h.pubStatus[n].simulcastEnable=u,h.pubStatus[n].consumerId="",this.adapterRef.instance.safeEmit("stream-added",{stream:h,mediaType:n}),l&&("audioSlave"===n?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:h.getId()}):this.adapterRef.instance.safeEmit("mute-"+n,{uid:h.getId()}));break}case"OnProducerClose":{const{requestId:e,code:i,errMsg:r,externData:a}=t.data;let{uid:o,producerId:d,mediaType:c,cid:l}=a;"string"===this.adapterRef.channelInfo.uidType&&(o=o.toString());let h,p=this.adapterRef.remoteStreamMap[o];if(!p)return void this.logger.warn(`收到OnProducerClose消息，但是当前没有该Producer： code = ${i}, errMsg = ${r}, uid = ${o}, mediaType = ${c}, producerId: ${d}`);switch(this.logger.log(`收到OnProducerClose消息 code = ${i}, errMsg = ${r}, uid = ${o}, mediaType = ${c}, producerId: ${d}`),c){case"video":h="video";break;case"screenShare":h="screen";break;case"audio":h="audio";break;case"subAudio":h="audioSlave";break;default:return void this.logger.warn(`OnProducerClose 不支持的媒体类型 ${c} ${o}`)}if(p.pubStatus[h].producerId!==d)return void this.logger.log("该 producerId 已经无效，不处理");null===(s=this.adapterRef._mediasoup)||void 0===s||s.removeUselessConsumeRequest(o,c),p.pubStatus[h].consumerId&&(null===(n=this.adapterRef._mediasoup)||void 0===n||n.destroyConsumer(p.pubStatus[h].consumerId,p,h),p.pubStatus[h].consumerId=""),this.adapterRef.instance.removeSsrc(o,h),p.subStatus[h]=!1,p.pubStatus[h][h]=!1,p[h]=!1,p.pubStatus[h].consumerId="",p.pubStatus[h].producerId="","audio"===h?(p.mediaHelper.audio.micTrack=null,u.emptyStreamWith(p.mediaHelper.audio.audioStream,null)):"audioSlave"===h?(p.mediaHelper.screenAudio.screenAudioTrack=null,u.emptyStreamWith(p.mediaHelper.screenAudio.screenAudioStream,null)):"video"===h?(p.mediaHelper.video.cameraTrack=null,u.emptyStreamWith(p.mediaHelper.video.videoStream,null)):"screen"===h&&(p.mediaHelper.screen.screenVideoTrack=null,u.emptyStreamWith(p.mediaHelper.screen.screenVideoStream,null)),this.adapterRef.instance.safeEmit("stream-removed",{stream:p,mediaType:h});break}case"OnConsumerClose":{const{requestId:e,code:i,errMsg:r,consumerId:s,producerId:a}=t.data;this.logger.log(`chence OnConsumerClose code = ${i} errMsg = ${r} producerId = ${a}`);const n=this.consumers[s];if(!n)break;n.close();break}case"consumerPaused":{const{consumerId:e}=t.data;if(!this.consumers[e])break;break}case"consumerResumed":case"consumerScore":break;case"OnTransportClose":{const{requestId:e,code:i,errMsg:r,transportId:s}=t.data;this.logger.warn(`chence OnTransportClose: code = ${i}, errMsg = ${r}, transportId = ${s}`),(null===(o=this.adapterRef._mediasoup)||void 0===o?void 0:o._sendTransport)||(null===(c=this.adapterRef._mediasoup)||void 0===c?void 0:c._recvTransport)?(this.logger.warn("服务器媒体进程crash，上行媒体和下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnTransportClose",ext:""}),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnSignalRestart":{const{requestId:e,code:i,errMsg:r}=t.data;this.logger.warn(`chence OnSignalRestart code = ${i} errMsg = ${r}`),this.logger.warn("服务器信令进程crash，重连"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnSignalRestart",ext:""}),(null===(l=this._protoo)||void 0===l?void 0:l.connected)&&"CONNECTED"===this.adapterRef.connectState.curState||this._reconnection();break}case"OnPermKeyTimeout":this.adapterRef.instance.safeEmit("permkey-will-expire");break;case"OnPeerClose":this.logger.warn("相同UID在其他地方登录，您被踢出房间"),this.adapterRef.instance.safeEmit("uid-duplicate"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.UID_DUPLICATE,this.adapterRef.instance.leave();break;case"OnKickOff":{let{msg:e,reason:i}=t.data.externData;this._handleKickedNotify(i);break}case"OnUserData":{let{type:e,data:i}=t.data.externData;if("StreamStatus"===e)this._handleStreamStatusNotify(i);else if("NetStatus"===e)this._handleNetStatusNotify(i);else if("Mute"===e)this.logger.log("mute变更: ",JSON.stringify(i,null,"")),this._handleMuteNotify(i);else if("UserRole"===e)this.logger.log("UserRole变更: ",JSON.stringify(i,null,"")),this._handleUserRoleNotify(t.data.externData);else if("RtmpTaskStatus"===e)this.logger.log("RtmpTaskStatus变更: ",JSON.stringify(i,null,"")),this.adapterRef.instance.safeEmit("rtmp-state",i);else if("AutoMaskUid"===e){const e=i;this.logger.log("收到打码通知：",e.maskUid,"时长",e.duration,"秒"),e.maskUid&&e.duration&&(e.targetEndMs=Date.now()+1e3*e.duration,this.autoMask.data.push(e),this.updateMaskStatus())}else if("MediaCapability"===e){if(this.logger.warn("MediaCapability房间能力变更: ",JSON.stringify(i,null,"")),this.adapterRef.mediaCapability.parseRoom(i),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),this.adapterRef._mediasoup&&this.adapterRef.mediaCapability.room.videoCodecType&&this.adapterRef.localStream){const e=this.adapterRef.mediaCapability.getCodecSend("video",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),t=this.adapterRef.mediaCapability.getCodecSend("screen",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),i=this.adapterRef._mediasoup._webcamProducerCodec&&this.adapterRef._mediasoup._webcamProducerCodec!==e.codecName;i&&this.logger.warn("将视频的Codec切走：",this.adapterRef._mediasoup._webcamProducerCodec,"=>",e.codecName);const r=this.adapterRef._mediasoup._screenProducerCodec&&this.adapterRef._mediasoup._screenProducerCodec!==e.codecName;r&&this.logger.error("将辅流的Codec切走：",this.adapterRef._mediasoup._screenProducerCodec,"=>",t.codecName),i||r?this._protoo&&this._protoo._transport&&this._protoo._transport._ws&&this._protoo._transport._ws.close():this.logger.log("Codec保持不动。video:",this.adapterRef._mediasoup._webcamProducerCodec,", screen:",this.adapterRef._mediasoup._screenProducerCodec)}}else if("Ability"===e)this._handleAbility(t.data.externData.data);else if("ChangeRight"===e){let e=i.uid;if(1===i.audioRight?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"audio",state:!0,duration:i.audioDuration})):2===i.audioRight&&(this.adapterRef.isAudioBanned=!1,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"audio",state:!1,duration:i.audioDuration})),1===i.videoRight?(this.adapterRef.isVideoBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"video",state:!0,duration:i.videoDuration})):2===i.videoRight&&(this.adapterRef.isVideoBanned=!1,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:e,mediaType:"video",state:!1,duration:i.videoDuration})),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),this.adapterRef.isAudioBanned&&!this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),this.adapterRef.isAudioBanned||this.adapterRef.isVideoBanned||this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),!this.adapterRef.localStream)return}else this.logger.error(`收到OnUserData通知消息 type = ${e}, data: `,i)}}}_handleFailed(){var e,t,i;this.logger.log("Signalling:_handleFailed");const r={name:"joinWsTime",code:-2,param:{reason:"failed",time:Date.now()-this.adapterRef.state.signalEstablishTime,wsId:null===(e=this._protoo)||void 0===e?void 0:e.id,url:null===(t=this.reconnectionControl.current)||void 0===t?void 0:t.url,serverIndex:null===(i=this.reconnectionControl.current)||void 0===i?void 0:i.serverIndex}};this.adapterRef.instance.apiFrequencyControl(r)}_handleClose(){}_isProtooDetached(e){var t,i,r;return this._protoo?this._protoo.id!==e.id?(this.logger.warn(`Protoo is detached: ${e.id} => ${this._protoo.id}`),!0):(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t.signallingId)!==this.signallingId&&(this.logger.warn(`Protoo.signaling is detached: ${this._protoo.id} => ${null===(r=null===(i=this.adapterRef._signalling)||void 0===i?void 0:i._protoo)||void 0===r?void 0:r.id}`),!0):(this.logger.warn("Protoo is destroyed: "+e.id),!0)}_handleDisconnected(e){var t,i,r,s;this.logger.log("Signalling:_handleDisconnected"),this.adapterRef.instance.outOfConnect||(!this._reconnectionTimer||"connectioning"!==this.adapterRef.channelStatus&&"join"!==this.adapterRef.channelStatus?(this.logger.warn(`信令通道#${e.id}_${null===(s=e._transport)||void 0===s?void 0:s.wsid} 收到关闭信号，即将开始重连过程。`),this.adapterRef.channelStatus="connectioning",this._reconnection()):e.closed?this.logger.warn(`信令通道#${e.id}_${null===(t=e._transport)||void 0===t?void 0:t.wsid} 在建立过程中被关闭。当前正在重连中，等待下次重连过程。`):this.logger.warn(`信令通道#${e.id}_${null===(i=e._transport)||void 0===i?void 0:i.wsid} 在建立过程中被关闭。信令通道会自动重试。连接地址：${null===(r=e._transport)||void 0===r?void 0:r._url}`),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"websocketDisconnect",ext:""}))}async join(e){var t,i,r,s,o,l,u,f,g;if(e&&this._isProtooDetached(e))return;if(this.joinTimestamps.push(Date.now()),this.joinTimestamps.length>4&&this.joinTimestamps.shift(),this.joinTimestamps.length>=4&&this.joinTimestamps[3]-this.joinTimestamps[0]<1e3)return void this.logger.error("signaling.join: 在1秒以内连续发生了4次Join事件，异常退出。");let v;this.adapterRef.state.signalOpenTime=Date.now(),this.adapterRef.state.signalWebsocketOpenRtt=this.adapterRef.state.signalOpenTime-this.adapterRef.state.signalEstablishTime,this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null),v=!!this.adapterRef.encryption.encryptionSecret&&"none"!==this.adapterRef.encryption.encryptionMode;const _={method:"Join",permKeySecret:this.adapterRef.channelInfo.permKey,requestId:""+Math.ceil(1e9*Math.random()),supportStdRed:!0,supportTurn:!this.adapterRef.proxyServer.enable,externData:{userName:""+this.adapterRef.channelInfo.uid,token:this.adapterRef.channelInfo.token,cname:""+this.adapterRef.channelInfo.channelName,subType:"select",role:"part",version:"2.0",sessionMode:"meeting",engineVersion:n.ENGINE_VERSION,userRole:this.adapterRef.instance._roleInfo.userRole,userType:3,platformType:16,rtmp:{support:this.adapterRef.channelInfo.sessionConfig.liveEnable},record:{host:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,supportVideo:this.adapterRef.channelInfo.sessionConfig.recordVideo,supportAuido:this.adapterRef.channelInfo.sessionConfig.recordAudio,recordType:this.adapterRef.channelInfo.sessionConfig.recordType-0},mediaCapabilitySet:this.adapterRef.mediaCapability.stringify(),browser:{name:h.getBrowserInfo().browserName,version:""+h.getBrowserInfo().browserVersion},customData:this.adapterRef.channelInfo.customData||"",gmEnable:v,gmMode:p.encryptionModeToInt(this.adapterRef.encryption.encryptionMode),gmKey:this.adapterRef.encryption.encryptionSecret,customEncryption:!m.getParameters().forceCustomEncryptionOff&&this.adapterRef.encryption.encodedInsertableStreams,userPriority:this.adapterRef.userPriority}};if((null===(t=this.adapterRef._signalling)||void 0===t?void 0:t.signallingId)===this.signallingId){this.logger.log("Signalling: socket连接成功，开始发送Join请求"),null===(i=this._protoo)||void 0===i||i.clear();try{let t=null,i=this._protoo;try{const e=Date.now(),i=null===(r=this._protoo)||void 0===r?void 0:r.request("Join",_);!this.adapterRef.signalProbeManager.worker&&m.getParameters().signalProbeEnabled&&this.adapterRef.signalProbeManager.start(this.adapterRef.channelInfo.wssArr),t=await i,this.adapterRef.state.signalJoinResTime=Date.now(),this.adapterRef.state.signalJoinMsgRtt=(this.adapterRef.state.signalJoinResTime-e)/2;const a={name:"joinWsTime",code:0,param:{wsTime:this.adapterRef.state.signalWebsocketOpenRtt,joinRes:this.adapterRef.state.signalJoinResTime-this.adapterRef.state.signalOpenTime,wsId:null===(s=this._protoo)||void 0===s?void 0:s.id,url:null===(o=this.reconnectionControl.current)||void 0===o?void 0:o.url,serverIndex:null===(l=this.reconnectionControl.current)||void 0===l?void 0:l.serverIndex}};this.adapterRef.instance.apiFrequencyControl(a)}catch(e){if(i!==this._protoo)return void this.logger.warn(`Login 过期的信令通道消息：【${e.name}】`,e.message);throw this.logger.warn("Login request error: ",e.message),new c.default({code:d.default.LOGIN_REQUEST_ERROR,message:e.message})}if(this._isProtooDetached(e))return;if(this.logger.log("Signalling:Join请求收到response"),200!=t.code){let e="Unknown Error";return t.externData?e=t.externData.errMsg:t.errMsg&&(e=t.errMsg),this.logger.error(`Signalling: 加入房间失败, code = ${t.code}, reason = ${e}`),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),void this._joinFailed(t.code,e)}let n=this.adapterRef.channelInfo.uid;if(t.PermKey&&(this.adapterRef.permKeyInfo=t.PermKey),1===t.externData.audioRight?(this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:n,mediaType:"audio",state:!0})):this.adapterRef.isAudioBanned=!1,1===t.externData.videoRight?(this.adapterRef.isVideoBanned=!0,this.adapterRef.isAudioBanned=!0,this.adapterRef.instance.safeEmit("audioVideoBanned",{uid:n,mediaType:"audio",state:!0})):this.adapterRef.isVideoBanned=!1,this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!!this.adapterRef.isAudioBanned,isVideoBanned:!!this.adapterRef.isVideoBanned}),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.logger.warn("服务器禁止发送音频流"),this.reconnectionControl.next=null,this.logger.log("Signalling: 加入房间成功"),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTED","no"===m.getParameters().forceBWE?t.preferRemb?(this.logger.log("服务端配置bwe：上行使用remb"),this.adapterRef.preferRemb=!0):(this.logger.log("服务端配置bwe：上行使用transport-cc"),this.adapterRef.preferRemb=!1):(this.adapterRef.preferRemb||t.preferRemb)&&"transport-cc"===m.getParameters().forceBWE?(this.logger.warn("强行使用transport-cc。忽略服务端配置bwe：preferRemb: "+t.preferRemb),this.adapterRef.preferRemb=!1):"remb"===m.getParameters().forceBWE&&(this.logger.warn("强行使用REMB。忽略服务端配置bwe：preferRemb: "+t.preferRemb),this.adapterRef.preferRemb=!0),this.adapterRef.audioAsl.enabled=t.supportWebAsl?"yes":"no",this.adapterRef.audioAsl.aslActiveNum=t.aslActiveNum,t.supportWebAsl?t.aslActiveNum?this.logger.log("aslActiveNum数量： "+t.aslActiveNum):this.logger.warn("服务端支持ASL但没有返回ASL数量"):this.logger.log("服务端未开启ASL"),this.adapterRef.instance.safeEmit("aslStatus",{enabled:!!t.supportWebAsl,aslActiveNum:t.aslActiveNum}),"connectioning"===this.adapterRef.channelStatus){if(this.adapterRef.connectState.reconnect=!0,this.logger.log("Signalling: 重连成功, 清除之前的媒体的通道"),this.adapterRef.channelStatus="join",this.adapterRef.instance.apiEventReport("setRelogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,reason:1,server_ip:this.adapterRef.channelInfo._protooUrl}),this.adapterRef.instance.resetChannel(),!this.adapterRef._mediasoup)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 1"});this.adapterRef._mediasoup._edgeRtpCapabilities=t.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(t.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init(),this.adapterRef.localStream?this.adapterRef.localStream.audio||this.adapterRef.localStream.video||this.adapterRef.localStream.screen||this.adapterRef.localStream.screenAudio||m.getParameters().allowEmptyMedia||this.adapterRef.localStream.audioSlave?(this.logger.log(`重连成功，重新publish本端流: audio ${this.adapterRef.localStream.hasAudio()}, video ${this.adapterRef.localStream.hasVideo()}, screen ${this.adapterRef.localStream.hasScreen()}, audioSlave ${this.adapterRef.localStream.hasAudioSlave()}`),this.adapterRef.instance.doPublish(this.adapterRef.localStream)):this.logger.log("重连成功，当前没有媒体流，无需发布"):this.logger.log("重连成功，当前在未发布状态，无需发布")}else{this.adapterRef.connectState.reconnect=!1;const e=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2,i=Date.now();if(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime=i,this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,signalling_time:e.startWssTime-e.startJoinTime,time_elapsed:i-e.startJoinTime,model:this.browserDevice}),!this.adapterRef._mediasoup)throw new c.default({code:d.default.UNKNOWN_TYPE_ERROR,message:"signalling_join: 媒体服务异常 2"});this.adapterRef._mediasoup._edgeRtpCapabilities=t.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(t.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init()}this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.logger.log("Signalling: 查看房间其他人的发布信息: "+JSON.stringify(t.externData.userList));const u=[];if(void 0!==t.externData&&t.externData.userList&&t.externData.userList.length){let e=this;for(const i of t.externData.userList){let t=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=t.toString());let r=this.adapterRef.remoteStreamMap[t];if(r?(r.active=!0,this.adapterRef.memberMap[t]=""+t,u.push({eventName:"peer-online",eventData:{uid:t}})):(r=new a.RemoteStream({uid:t,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[t]=r,this.adapterRef.memberMap[t]=""+t,u.push({eventName:"peer-online",eventData:{uid:t}})),i.customData&&u.push({eventName:"custom-data",eventData:{uid:t,customData:i.customData}}),i.producerInfoList)for(const s of i.producerInfoList){const{mediaType:i,producerId:a,mute:n,simulcastEnable:o}=s;let d;switch(i){case"video":d="video";break;case"screenShare":d="screen";break;case"audio":d="audio";break;case"subAudio":d="audioSlave";break;default:this.logger.warn(`join: 不支持的媒体类型 ${i} ${t}`);continue}r[d]=!0,r.pubStatus[d][d]=!0,r.pubStatus[d].producerId=a,r.pubStatus[d].mute=n,r.muteStatus[d].send=n,r.pubStatus[d].simulcastEnable=o,e.logger.log(`Signalling: 通知 ${r.getId()} 发布信息: ${JSON.stringify(r.pubStatus,null,"")}`),(r.pubStatus.audio.audio||r.pubStatus.video.video||r.pubStatus.screen.screen||r.pubStatus.audioSlave.audioSlave)&&u.push({eventName:"stream-added",eventData:{stream:r,mediaType:d}}),n&&("audioSlave"===d?u.push({eventName:"mute-audio-slave",eventData:{uid:r.getId()}}):u.push({eventName:"mute-"+d,eventData:{uid:r.getId()}}))}}for(let e in this.adapterRef.remoteStreamMap)this.adapterRef.remoteStreamMap[e].active||(this.logger.warn("重连期间远端流停止发布："+e),delete this.adapterRef.remoteStreamMap[e])}const h=this.adapterRef.instance;setTimeout((()=>{for(let e=0;e<u.length;e++){const t=u[e].eventName,i=u[e].eventData;h&&("stream-added"===t&&("audio"===i.mediaType?h.adapterRef.state.signalAudioAddedTime<h.adapterRef.state.signalOpenTime&&(h.adapterRef.state.signalAudioAddedTime=Date.now()):"video"===i.mediaType&&h.adapterRef.state.signalVideoAddedTime<h.adapterRef.state.signalOpenTime&&(h.adapterRef.state.signalVideoAddedTime=Date.now())),h.safeEmit(t,i))}}),0),this.adapterRef.state.signalJoinSuccessTime=Date.now(),this._resolve?(this.logger.log("加入房间成功, 反馈通知"),this._resolve(t),this._resolve=null,this._reject=null):this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-success"),this.doSendKeepAliveTask()}catch(e){this.logger.error("Signalling: 登录流程内部错误: ",e.message);const t={name:"joinWsTime",code:-3,param:{reason:e.message,wsTime:this.adapterRef.state.signalWebsocketOpenRtt,joinRes:Date.now()-this.adapterRef.state.signalOpenTime,wsId:null===(u=this._protoo)||void 0===u?void 0:u.id,url:null===(f=this.reconnectionControl.current)||void 0===f?void 0:f.url,serverIndex:null===(g=this.reconnectionControl.current)||void 0===g?void 0:g.serverIndex}};this.adapterRef.instance.apiFrequencyControl(t),this._joinFailed(-1,e.message||"LOGIN_ERROR")}}}_joinFailed(e,t){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.channelStatus="init",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),4009===e&&this.adapterRef.instance.safeEmit("crypt-error",{cryptType:this.adapterRef.encryption.encryptionMode});const i=Date.now(),r=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:e,server_ip:this.adapterRef.channelInfo._protooUrl,signalling_rtt:this.adapterRef.state.signalJoinMsgRtt,signalling_time:r.startWssTime-r.startJoinTime,time_elapsed:i-r.startJoinTime,model:this.browserDevice,desc:t||""}),this._reject?(this.logger.error("加入房间失败, 反馈通知"),this._reject(new c.default({code:d.default.SERVER_AUTH_ERROR,extraCode:e,message:t||"join failed"})),this._resolve=null,this._reject=null,this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.adapterRef.channelStatus="leave",this.adapterRef.instance.stopSession()):("room not found"===t?this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t,"，这通常是因为房间内其他人都已离开，房间关闭引起的"):this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t),this.adapterRef.instance.safeEmit("error","RELOGIN_ERROR"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.LOGIN_FAILED,this.adapterRef.instance.leave())}doSendKeepAliveTask(){this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null);let e=!1;this.keepAliveTimer=setInterval((async()=>{e||(e=!0,await this.doSendKeepAlive(),e=!1)}),6e3)}async doSendKeepAlive(){var e,t;if(!(null===(e=this._protoo)||void 0===e?void 0:e.connected))return;this._protoo.id,null===(t=this._protoo._transport)||void 0===t||t.wsid;const i=Date.now();try{await this._protoo.request("Heartbeat")}catch(e){this.logger.error(`信令包保活失败, reason: ${e.message}, ${Date.now()-i}ms`)}}async updatePermKey(e){var t;if(this.logger.log("updatePermKey newwork isConnect: ",null===(t=this._protoo)||void 0===t?void 0:t.connected),!this._protoo||!this._protoo.connected)return;const i=await this._protoo.request("PermKeyUpdate",{requestId:""+Math.ceil(1e9*Math.random()),permKeySecret:e});200!==i.code?new c.default({code:d.default.UPDATE_PERMKEY_ERROR,extraCode:i.code,message:"update permkey 认证错误"}):this.adapterRef.permKeyInfo=i.PermKey}updateMaskStatus(){var e,t,i;let r=Date.now();for(let i=this.autoMask.data.length-1;i>=0;i--){let s=this.autoMask.data[i];if(r>=s.targetEndMs){if(this.adapterRef.channelInfo.uid===s.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户去除打码",s.maskUid),null===(e=this.adapterRef.localStream._play)||void 0===e||e.disableMask();else{const e=this.adapterRef.remoteStreamMap[s.maskUid];e&&(null===(t=e._play)||void 0===t?void 0:t.mask.enabled)&&(this.logger.log("updateMaskStatus 远端用户去除打码",s.maskUid),e._play.disableMask())}this.autoMask.data.splice(i,1)}}let s=Number.MAX_SAFE_INTEGER;for(let e=0;e<this.autoMask.data.length;e++){let t=this.autoMask.data[e];if(s=Math.min(s,t.targetEndMs),this.adapterRef.channelInfo.uid==t.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户增加打码",t.maskUid),null===(i=this.adapterRef.localStream._play)||void 0===i||i.enableMask();else{const e=this.adapterRef.remoteStreamMap[t.maskUid];e?e._play&&!e._play.mask.enabled&&(this.logger.log("updateMaskStatus 远端用户增加打码",t.maskUid,"打码时长",t.duration,"秒"),e._play.enableMask()):this.logger.log("updateMaskStatus 远端用户不在频道中",t.maskUid,"打码时长",t.duration,"秒")}}this.autoMask.timer&&clearTimeout(this.autoMask.timer),this.autoMask.timer=setTimeout((()=>{this.updateMaskStatus()}),s-r)}async doSendLogout(){if(this.logger.log("doSendLogout() begin"),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),!this._protoo||!this._protoo.connected)return;let e={requestId:""+Math.ceil(1e9*Math.random()),externData:{reason:0}};this._protoo.notify("Leave",e),this.logger.log("doSendLogout() success")}_handleStreamStatusNotify(e){}_handleNetStatusNotify(e){const t=e.netStatusList;let i=l.parseBase64(t).toString(),r=[],s=i.substr(2,2)+i.substr(0,2);s=parseInt(s,16),i=i.substr(4);for(let e=0;e<s;e++){let e=i.substr(0,16);e=a(e);const t=i.substr(16,2),s=i.substr(18,2);let n=0;if("00"!=i.substr(20,2)){const e=i.substr(22,2);n=parseInt(e,16),i.substr(24,n),n++}const o={uid:"string"===this.adapterRef.channelInfo.uidType?f.SimpleBig.fromHex(e).toString():parseInt(e,16),downlinkNetworkQuality:parseInt(t,16),uplinkNetworkQuality:parseInt(s,16),receiveTs:Date.now()};r.push(o),i=i.substr(22+n)}function a(e){let t=[];for(var i=e.length;i>=1;i-=2)t.push(e[i-2],e[i-1]);return t.join("")}let n=!0,o=[];r=r.filter((e=>0!=e.uid)),this.adapterRef.netStatusList.map((e=>{n=!0,r.map((t=>{e.uid!=t.uid&&0!=t.uid||(n=!1)})),n&&o.push(e)}));let d=o.concat(r);d=d.filter((e=>this.adapterRef.memberMap[e.uid]||e.uid==this.adapterRef.channelInfo.uid)),this.adapterRef.netStatusList=d,this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)}_handleMuteNotify(e){const t=e.producerId,i=e.mute;Object.values(this.adapterRef.remoteStreamMap).forEach((e=>{o.MediaTypeList.forEach((r=>{e.pubStatus[r].producerId===t&&(e.muteStatus[r].send=i,i?"audioSlave"===r?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("mute-"+r,{uid:e.getId()}):"audioSlave"===r?this.adapterRef.instance.safeEmit("unmute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("unmute-"+r,{uid:e.getId()}))}))}))}_handleUserRoleNotify(e){let t=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=t.toString());const i=e.data&&e.data.userRole;if(this.logger.warn(`用户${t}角色变为${i?"观众":"主播"}`),t&&1===i&&(this.adapterRef.instance.clearMember(t),this.adapterRef.instance.removeSsrc(t),this.adapterRef.instance._roleInfo.audienceList[t]=!0),t&&0===i){this.adapterRef.instance.safeEmit("peer-online",{uid:t});let i=this.adapterRef.remoteStreamMap[t];i?i.active=!0:(i=new a.RemoteStream({uid:t,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:e.platformType}),this.adapterRef.remoteStreamMap[t]=i,this.adapterRef.memberMap[t]=t),this.adapterRef.instance._roleInfo.audienceList[t]=!1}}_handleAbility(e){this.adapterRef.instance.safeEmit("warning",{code:e.code,msg:e.msg})}_handleKickedNotify(e,t=this.adapterRef.channelInfo.uid){"string"===this.adapterRef.channelInfo.uidType&&(t=t.toString()),1==e?(this.logger.warn("房间被关闭"),this.adapterRef.instance.outOfConnect=!0,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.CHANNEL_CLOSED,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("channel-closed",{})):2==e?(this.logger.warn(t+"被踢出房间"),this.adapterRef.instance.outOfConnect=!0,t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.CLIENT_BANNED,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("client-banned",{uid:t})):5==e&&(this.logger.warn(t+" permKey 超时被踢出房间"),this.adapterRef.instance.outOfConnect=!0,t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=d.default.PERMKEY_TIMEOUT,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("permkey-timeout",{uid:t}))}destroy(){this.logger.log("清除 Signalling"),this._destroyProtoo(),this._reset()}}t.Signalling=_},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteStream=void 0;const s=i(72),a=i(148),n=i(194),o=i(2),d=i(196),c=i(152),l=i(68),u=r(i(12)),h=r(i(13)),p=i(69),m=i(73),f=i(67);let g=0;class v extends m.RTCEventEmitter{constructor(e){if(super(),this.audioLevelHelper=null,this.platformType=l.PlatformType.unknown,this.isRemote=!0,this.__v_skip=o.getParameters().enableVSkip,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.active=!0,this.destroyed=!1,this.spatialPosition={x:0,y:0},this.remoteStreamId=g++,this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.platformType=e.platformType,this.logger=e.client.adapterRef.logger.getChild((()=>{var t;let i="remote#"+this.stringStreamID;return l.PlatformTypeMap[this.platformType]&&(i+=" "+l.PlatformTypeMap[this.platformType]),i+=this.remoteStreamId,this.pubStatus.audio.consumerId?i+="M":this.pubStatus.audio.producerId&&(i+="m"),this.pubStatus.video.consumerId?i+="C":this.pubStatus.video.producerId&&(i+="c"),this.pubStatus.screen.consumerId?i+="S":this.pubStatus.screen.producerId&&(i+="s"),(null===(t=e.client.adapterRef.remoteStreamMap[this.streamID])||void 0===t?void 0:t.remoteStreamId)!==this.remoteStreamId&&(i+=" DETACHED"),i})),"string"==typeof e.uid)e.client.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid)throw this.logger.error("remoteSteram: uid参数格式非法"),new h.default({code:u.default.STREAM_UID_ERROR,message:"remoteSteram: uid参数格式非法"});if(e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw this.logger.error("remoteSteram: uid超出number类型精度"),new h.default({code:u.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数"})}this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:s.STREAM_TYPE.HIGH,screen:s.STREAM_TYPE.HIGH}},this.renderMode={remote:{video:{},screen:{}}},this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioSlave=e.audioSlave||!1,this.video=e.video||!1,this.screen=e.screen||!1,this.client=e.client,this.mediaHelper=new n.MediaHelper({stream:this}),this._play=new d.Play({stream:this}),this._record=new c.Record({logger:this.logger,client:this.client}),"never"!==o.getParameters().enableAlerter&&a.alerter.watchRemoteStream(this),this.client.apiFrequencyControl({name:"createRemoteStream",code:0,param:{streamID:this.stringStreamID,isRemote:!0,clientUid:this.client.adapterRef.channelInfo.uid||""}})}_reset(){this.audio=!1,this.audioSlave=!1,this.video=!1,this.screen=!1,this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:s.STREAM_TYPE.HIGH,screen:s.STREAM_TYPE.HIGH}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.renderMode={remote:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}doSetSubscribeConfig(e){const t=Object.assign({},this.subConf);t.highOrLow=Object.assign({},this.subConf.highOrLow);for(let t of l.MediaTypeListAudio){const i=e[t];"boolean"==typeof i&&(this.subConf[t]=i)}for(let t of l.MediaTypeListVideo){const i=e[t];e.highOrLow&&(this.subConf.highOrLow[t]=e.highOrLow),"high"===i||"low"===i?(this.subConf[t]=!0,this.subConf.highOrLow[t]=s.STREAM_TYPE["high"===i?"HIGH":"LOW"]):"boolean"==typeof i&&(this.subConf[t]=i)}this.pubStatus.audio.audio&&this.subConf.audio?(this.subConf.audio=!0,this.audio=!0):this.subConf.audio=!1,this.pubStatus.audioSlave.audioSlave&&this.subConf.audioSlave?(this.subConf.audioSlave=!0,this.audioSlave=!0):this.subConf.audioSlave=!1,this.pubStatus.video.video&&this.subConf.video?(this.subConf.video=!0,this.video=!0):this.subConf.video=!1,this.pubStatus.screen.screen&&this.subConf.screen?(this.subConf.screen=!0,this.screen=!0):this.subConf.screen=!1;let i="doSetSubscribeConfig",r=!1;for(let e of l.MediaTypeList)i+=` ${e}:${t[e]}`,t[e]!==this.subConf[e]&&(i+="=>"+this.subConf[e],r=!0),"video"!==e&&"screen"!==e||(i+=" "+s.STREAM_TYPE_REV[t.highOrLow[e]],t.highOrLow[e]!==this.subConf.highOrLow[e]&&(i+="=>"+s.STREAM_TYPE_REV[this.subConf.highOrLow[e]],r=!0));r||(i+="【Unchanged】"),this.logger.log(i)}setSubscribeConfig(e){if(this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则：${JSON.stringify(e)}`),this.doSetSubscribeConfig(e),this.logger.log(`setSubscribeConfig() 设置 ${this.stringStreamID} 订阅规则结果：${JSON.stringify(this.subConf)}`),this.client.apiFrequencyControl({name:"setSubscribeConfig",code:0,param:{streamID:this.stringStreamID,isRemote:!0,conf:Object.assign({},this.subConf)}}),this.pubStatus.screen.screen){const e={uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,subscribe:this.subConf.screen};this.client.apiFrequencyControl({name:"subscribeRemoteSubStreamVideo",code:0,param:JSON.stringify(e,null," ")})}}getAudioStream(){return this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({isRemote:!0,streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream}getAudioTrack(){return this.mediaHelper.audio.audioStream.getAudioTracks()[0]||null}getVideoTrack(){return this.mediaHelper.video.videoStream.getVideoTracks()[0]||null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}async play(e,t={}){if((t.video||t.screen)&&!e)throw this.logger.warn(`play() remoteStream ${this.getId()} 播放视频没有指定div标签`),new h.default({code:u.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});if(p.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!0),p.isExistOptions({tag:"Stream.playOptions.audioSlave",value:t.audioSlave}).result||(t.audioSlave=!0),p.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),p.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`play() uid ${this.stringStreamID} 播放, playOptions:${JSON.stringify(t)}`),t.audio&&this._play&&this.mediaHelper.audio.audioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频`);try{await this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,t.muted)}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}if(t.audioSlave&&this._play&&this.mediaHelper.screenAudio.screenAudioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频辅流播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频辅流`);try{await this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,t.muted)}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}let i;if(i="string"==typeof e?document.getElementById(e):e||null,i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 主流 远端`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,i),"width"in this.renderMode.remote.video&&this._play.setRender("video",this.renderMode.remote.video)}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 辅流 远端`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.remote.screen&&this._play.setRender("screen",this.renderMode.remote.screen)}catch(e){this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!0},null," ")})}async resume(){f.tryResumeAudioContext()&&this.logger.log("正在尝试恢复AudioContext自动播放受限"),this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume()),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}setRemoteRenderMode(e,t){if(!e||!Number.isInteger(e.width)||!Number.isInteger(e.width))throw this.logger.warn("setRemoteRenderMode 参数宽高错误"),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,isRemote:!0,mediaType:t},e)}),new h.default({code:u.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.client&&this._play&&(this.logger.log(`uid ${this.stringStreamID} 设置远端视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setRender("video",e),this.renderMode.remote.video=e),t&&"screen"!==t||(this.renderMode.remote.screen=e,this._play&&this._play.setRender("screen",e)),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:0,param:Object.assign(Object.assign({},e),{mediaType:t,isRemote:!0,streamID:this.stringStreamID})}))}stop(e){this.logger.log(`stop() uid ${this.stringStreamID}, 停止播放 ${e||"音视频流"}`),this._play&&(l.MediaTypeList.forEach((t=>{e&&t!==e||this._play.stopPlayStream(t)})),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}))}isPlaying(e){if(this._play){if(l.MediaTypeList.indexOf(e)>-1)return this._play.isPlaying(e);throw this.logger.warn("isPlaying() unknown type"),new h.default({code:u.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: false`),!1}canPlay(e){return-1===l.MediaTypeList.indexOf(e)?null:this._play.canPlay(e)}async unmuteAudio(){var e;let t,i;if(this.muteStatus.audio.recv||(t=u.default.STREAM_NOT_MUTE_AUDIO_YET,i="remoteStream.unmuteAudio: 当前没有mute音频, 不支持unmute"),this._play.audio.dom&&(null===(e=this.mediaHelper.audio.audioStream)||void 0===e?void 0:e.active)||(t=u.default.STREAM_UNMUTE_AUDIO_WITHOUT_STREAM,i="remoteStream.unmuteAudio: 没有音频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudio",code:t?-1:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:i||""},null," ")}),t)throw this.logger.error(i),new h.default({code:t,message:i});try{this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID),this.muteStatus.audio.recv=!1,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,!1)}catch(e){this.logger.error("unmuteAudio() 异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e},null," ")})}}async muteAudio(){var e,t,i,r,s,a;if(this.logger.log("禁用音频轨道: ",this.stringStreamID),!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.audio)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(a=null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.audio)||void 0===s?void 0:s.audioStream)||void 0===a?void 0:a.active))throw this.logger.log("muteAudio() 之前没有播放过音频, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_AUDIO_ERROR,message:"remoteStream.muteAudio: 之前没有播放过音频, 不支持muteAudio"});try{this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audio"),this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(e){this.logger.error("API调用失败: Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")})}}async unmuteAudioSlave(){var e;let t,i;if(this.muteStatus.audioSlave.recv||(t=u.default.STREAM_NOT_MUTE_AUDIO_SLAVE_YET,i="remoteStream.unmuteAudioSlave: 当前没有mute音频辅流, 不支持unmute"),this._play.audioSlave.dom&&(null===(e=this.mediaHelper.screenAudio.screenAudioStream)||void 0===e?void 0:e.active)||(t=u.default.STREAM_UNMUTE_AUDIO_SLAVE_WITHOUT_STREAM,i="remoteStream.unmuteAudioSlave: 没有音频辅流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:t?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:i||""},null," ")}),t)throw this.logger.error(i),new h.default({code:t,message:i});try{this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!1,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream("audioSlave",this.mediaHelper.screenAudio.screenAudioStream,!1)}catch(e){this.logger.error("Stream:unmuteAudioSlave 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}async muteAudioSlave(){var e,t,i,r,s,a;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.audioSlave)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(a=null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.screenAudio)||void 0===s?void 0:s.screenAudioStream)||void 0===a?void 0:a.active))throw this.logger.error("muteAudioSlave() 之前没有播放过音频辅流, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_AUDIO_SLAVE_ERROR,message:"remoteStream.muteAudioSlave: 之前没有播放过音频辅流, 不支持mute"});try{this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID),this.muteStatus.audioSlave.recv=!0,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayStream("audioSlave"),this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("Stream:muteAudioSlave 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.audio.audioStream.getAudioTracks().length>0}hasAudioSlave(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}getAudioLevel(e="audio"){const t=this.mediaHelper.getOrCreateAudioPipeline(e);if(!t)return 0;{let i=0;if(!t.audioLevelNode){const t=f.getAudioContext();if(t&&t.audioWorklet&&t.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),"suspended"===(null==t?void 0:t.state)){const e=new h.default({code:u.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:"playVideoStream: 浏览器自动播放受限: AudioContext is Suspended"});this.client.safeEmit("notAllowedError",e),this.safeEmit("notAllowedError",e)}else this.client.apiFrequencyControl({name:"getAudioLevel",code:0,param:{mediaType:e,isRemote:!0,streamID:this.stringStreamID}})}const r=t.getAudioLevel();switch(r?i=r.volume:(this.logger.log("getAudioLevel() 正在加载音频模块"),i=0),o.getParameters().audioLevelFittingAlgorithm){case"classic":return i;case"linear":return Math.max(0,Math.min(100,o.getParameters().audioLevelRatioRemote*Math.round(200*i)));case"log2":return Math.max(0,Math.min(100,o.getParameters().audioLevelRatioRemote*Math.round(8.638*Math.log2(i)+97.244)))}}}setAudioVolume(e=100){var t;let i,r;(!Number.isInteger(e)||e<0||e>100)&&(i=u.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.audio&&this._play&&this._play.audio&&this._play.audio.dom||(r="setAudioVolume() 没有音频流，请检查是否有订阅播放过音频",i=u.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*e,normalizedVolume:s,reason:r}}),i)throw this.logger.error(r),new h.default({code:i,message:r});this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),null===(t=this._play)||void 0===t||t.setPlayVolume("audio",s)}setAudioSlaveVolume(e=100){var t;let i,r;Number.isInteger(e)?e<0?e=0:e>100&&(e=100):(i=u.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioSlaveVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.audio&&this._play&&this._play.audioSlave&&this._play.audioSlave.dom||(r="setAudioSlaveVolume() 没有音频流，请检查是否有订阅播放过音频辅流",i=u.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!0,volume:2.55*e,normalizedVolume:s,reason:r||""}}),i)throw this.logger.error(r),new h.default({code:i,message:r});this.logger.log(`setAudioSlaveVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),null===(t=this._play)||void 0===t||t.setPlayVolume("audioSlave",s)}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout((()=>{t(e)}),0),this.logger.error("设置输出设备失败",e.name,e.message),new h.default({code:u.default.SET_AUDIO_OUTPUT_ERROR,message:e.message||"系统内部错误"})}t&&setTimeout(t,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!0},null," ")})}async unmuteVideo(){let e,t;if(this.muteStatus.video.recv||(e=u.default.STREAM_NOT_MUTE_VIDEO_YET,t="remoteStream.unmuteVideo: 当前没有mute视频, 不支持unmute"),this.mediaHelper.video.cameraTrack||(e=u.default.STREAM_UNMUTE_VIDEO_WITHOUT_STREAM,t="remoteStream.unmuteVideo: 没有视频流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteVideo",code:e?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:t||""},null," ")}),e)throw this.logger.error(t),new h.default({code:e,message:t});try{this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!1,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0)}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}async muteVideo(){var e,t,i,r,s;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.video)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(s=null===(r=this.mediaHelper)||void 0===r?void 0:r.video)||void 0===s?void 0:s.cameraTrack))throw this.logger.log("muteVideo() 之前没有播放过视频, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_VIDEO_ERROR,message:"remoteStream.muteVideo: 之前没有播放过视频, 不支持mute"});try{this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`),this.muteStatus.video.recv=!0,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")})}}async unmuteScreen(){let e,t;if(this.muteStatus.screen.recv||(e=u.default.STREAM_NOT_MUTE_SCREEN_YET,t="remoteStream.unmuteScreen: 当前没有mute屏幕共享, 不支持unmute"),this.mediaHelper.screen.screenVideoTrack||(e=u.default.STREAM_UNMUTE_SCREEN_WITHOUT_STREAM,t="remoteStream.unmuteScreen: 没有屏幕共享流, 无法执行unmute操作"),this.client.apiFrequencyControl({name:"unmuteScreen",code:e?-1:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:t||""},null," ")}),e)throw this.logger.error(t),new h.default({code:e,message:t});try{this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的屏幕共享轨道`),this.muteStatus.screen.recv=!1,this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("unmuteScreen() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}async muteScreen(){var e,t,i,r;if(!(null===(i=null===(t=null===(e=this._play)||void 0===e?void 0:e.screen)||void 0===t?void 0:t.dom)||void 0===i?void 0:i.srcObject)||!(null===(r=this.mediaHelper)||void 0===r?void 0:r.screen.screenVideoTrack))throw this.logger.log("muteScreen() 之前没有播放过屏幕共享, 不支持unmute: ",this.stringStreamID),new h.default({code:u.default.STREAM_MUTE_SCREEN_ERROR,message:"remoteStream.muteScreen: 之前没有播放过屏幕共享, 不支持mute"});try{this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的屏幕共享轨道`),this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.recv=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("muteScreen() 异常: ",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}hasVideo(){this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length}hasScreen(){this.mediaHelper.screen.screenVideoStream.getVideoTracks().length}async takeSnapshot(e){var t,i,r,s;let a,n;const o=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(o||d?(await this._play.takeSnapshot(e,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign(Object.assign({},e),{streamID:this.stringStreamID,isRemote:!0})})):(n="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",a=u.default.STREAM_TAKE_SNAPSHOT_ERROR),a)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},e),{reason:n}),null," ")}),new h.default({code:a,message:n})}takeSnapshotBase64(e){var t,i,r,s;let a,n;const o=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(o||d){let t=this._play.takeSnapshot(e,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!0},e)}),t}if(n="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",a=u.default.STREAM_TAKE_SNAPSHOT_ERROR,a)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!0},e),{reason:n}),null," ")}),new h.default({code:a,message:n})}getCurrentFrameData(e={mediaType:"video"}){return this._play.getCurrentFrameData(e)}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":t.push(this.mediaHelper.audio.audioStream)}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new h.default({code:u.default.RECORDING_ERROR,message:"remoteStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("未发现要录制的媒体流")}stopMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.playMediaRecording: 录制未开始"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.listMediaRecording: 录制未开始"});const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(e){if(!this._record||!this._record.recoder)throw new h.default({code:u.default.RECORDING_NOT_START_ERROR,message:"remoteStream.downloadMediaRecording: 录制未开始"});return this._record.download()}clearRemotePubStatus(){for(let e of l.MediaTypeList)this[e]=!1,this.pubStatus[e][e]=!1,this.pubStatus[e].producerId="",this.pubStatus[e].consumerId="",this.pubStatus[e].consumerStatus="init",this.pubStatus[e].stopconsumerStatus="init"}setCanvasWatermarkConfigs(e){if(this._play){let t="screen"===e.mediaType?this._play.screen.canvasWatermark:this._play.video.canvasWatermark;if(!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new h.default({code:u.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new h.default({code:u.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});t.checkWatermarkParams(e),t.updateWatermarks(e),Object.assign({uid:this.stringStreamID},e),this.client.apiFrequencyControl({name:"setRemoteCanvasWatermarkConfigs",code:0,param:{isRemote:!0,streamID:this.stringStreamID,mediaType:e.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}getMuteStatus(e){if(l.MediaTypeList.indexOf(e)>-1)return{send:this.muteStatus[e].send,recv:this.muteStatus[e].recv,muted:this.muteStatus[e].send||this.muteStatus[e].recv};throw new Error("getMuteStatus Invalid Media "+e)}getAdapterRef(){var e;return(null===(e=this.client.adapterRef.remoteStreamMap[this.streamID])||void 0===e?void 0:e.remoteStreamId)===this.remoteStreamId?this.client.adapterRef:null}getNativeDom(e){var t;const i=this[e],r=null===(t=this._play[e])||void 0===t?void 0:t.dom;return i&&r||this.logger.warn("No remote "+e),r}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!0}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset())}}t.RemoteStream=v},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.pcCloneTrack=void 0,t.pcCloneTrack=function(e){const t=new RTCPeerConnection,i=new RTCPeerConnection;window.pcLocal=t,window.pcRemote=i,t.onicecandidate=e=>{e.candidate&&i.addIceCandidate(e.candidate)},t.onnegotiationneeded=async e=>{const r=await t.createOffer();await t.setLocalDescription(r),await i.setRemoteDescription(r);const s=await i.createAnswer();await i.setLocalDescription(s),await t.setRemoteDescription(s)};const r=t.addTransceiver("video",{direction:"recvonly"});return i.addTrack(e),e.addEventListener("neTrackEnded",(()=>{i.close(),r.receiver.track.stop()})),r.receiver.track}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.preProcessingPureColor=t.preProcessingCopy=t.preProcessingSyncState=t.disablePreProcessing=t.canDisablePreProcessing=t.enablePreProcessing=void 0;const r=i(75),s=i(175),a=i(155);function n(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled)}function o(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled),i.canvasCtx.drawImage(i.videoElem,0,0)}t.enablePreProcessing=async function(e,t,i){let d;if(i||(i=e[t].captureConfig.high.frameRate),d="video"===t?e.video.cameraTrack||e.video.videoSource:e.screen.screenVideoTrack||e.screen.screenVideoSource,!d)return void e.logger.warn("enablePreProcessing：当前没有视频输入 "+t);let c,l=e[t].preProcessing;if(!l){e.logger.log("enablePreProcessing:初始化 mediaType "+t);const i=document.createElement("video");let r=new a.RTCCanvas("canvas"),s=r._canvas,d=r._ctx;if(!d)throw new Error("无法创建canvasCtx 2d");const c=s.captureStream();i.onresize=()=>{r.setSize(i.videoWidth,i.videoHeight),i.play()};const u=c.getVideoTracks()[0];l={canvasTrack:u,canvasCtx:d,videoTrack:null,videoElem:i,canvasElem:s,handlers:[{name:"syncState",enabled:!0,func:n},{name:"copy",enabled:!0,func:o},{name:"mirror",enabled:!1,func:()=>{}},e.stream._play[t].encoderWatermark.handler],history:[],timer:null},e[t].preProcessing=l}if(!l)return;"video"===t?r.emptyStreamWith(e.video.videoStream,l.canvasTrack):r.emptyStreamWith(e.screen.screenVideoStream,l.canvasTrack),l.videoElem.srcObject=new MediaStream([d]),l.videoTrack=d,e.stream.isRemote||(c=e.stream.getSender(t,"high")),c&&(c.replaceTrack(l.canvasTrack),e.logger.log(`enablePreProcessing ${t} 成功替换上行`));const u=async()=>{if(l)if(l.videoElem.videoWidth&&l.videoElem.videoHeight&&(l.videoElem.videoWidth===l.canvasElem.width&&l.videoElem.videoHeight===l.canvasElem.height||(e.logger.warn(`前处理宽高变化 ${t} ${l.canvasElem.width}x${l.canvasElem.height} => ${l.videoElem.videoWidth}x${l.videoElem.videoHeight}`),l.canvasElem.width=l.videoElem.videoWidth,l.canvasElem.height=l.videoElem.videoHeight)),l.handlers.length){const i=Date.now(),r=[];for(let s of l.handlers)if(s&&s.enabled){const a=i;await s.func(e,t,l);const n=Date.now()-a;r.push({name:s.name,spent:n})}const s=Date.now();let a=0;for(;a<l.history.length&&s-l.history[a].endTs>5e3;a++);l.history.splice(0,a),l.history.push({startTs:i,endTs:s,handlerTs:r})}else o(e,t,l)};l.timer&&clearInterval(l.timer);const h=Math.floor(1e3/i);try{u()}catch(t){e.logger.error("drawFrame",t.name,t.message,t.stack)}l.timer=s.getRTCTimer().setInterval(u,h),e[t].preProcessingEnabled=!0,e.emit("preProcessChange",{mediaType:t,isOn:!0})},t.canDisablePreProcessing=function(e,t){const i=e[t].preProcessing;return!(!i||!i.timer)&&0===i.handlers.filter((e=>e&&e.enabled&&"syncState"!==e.name&&"copy"!==e.name)).length},t.disablePreProcessing=async function(e,t="video",i=!1){e.logger.log("disablePreProcessing "+t);const a=e[t].preProcessing;if(!a)return void e.logger.warn(`disablePreProcessing ${t}:当前没有前处理配置`);let n,o;a.canvasCtx.clearRect(0,0,a.canvasElem.width,a.canvasElem.height),(null==a?void 0:a.timer)&&(s.getRTCTimer().clearInterval(a.timer),a.timer=null),"video"===t?(n=e.video.cameraTrack||e.video.videoSource,r.emptyStreamWith(e.video.videoStream,n)):(n=e.screen.screenVideoTrack||e.screen.screenVideoSource,r.emptyStreamWith(e.screen.screenVideoStream,n)),a.videoElem.srcObject&&(a.videoElem.srcObject=null),e.stream.isRemote||(o=e.stream.getSender(t,"high")),o&&("live"===(null==n?void 0:n.readyState)?(o.replaceTrack(n),e.logger.log(`disablePreProcessing ${t} 成功替换上行为【${n.label}】`)):(o.replaceTrack(null),e.logger.warn("disablePreProcessing 删除上行"))),i||(e[t].preProcessingEnabled=!1),e.emit("preProcessChange",{mediaType:t,isOn:!1})},t.preProcessingSyncState=n,t.preProcessingCopy=o,t.preProcessingPureColor=function(e,t,i){i.canvasCtx.fillStyle="green",i.canvasCtx.fillRect(0,0,i.canvasElem.width,i.canvasElem.height)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPipeline=void 0;const r=i(287),s=i(76),a=i(288),n=i(289),o=i(195),d=i(291),c=i(292);let l=0;t.AudioPipeline=class{constructor(e){this.id=++l,this.inputs={local:{track:null,node:null,label:""},remote:{track:null,node:null,label:""}},this.audioLevelNode=null,this.stages=[],this.mixins={},this.output={track:null,stream:new MediaStream,destination:null,directOutput:!0},this.context=e.context,this.logger=e.logger.getChild((()=>{let e="AudioPipeline#"+this.id;this.inputs.local.track&&(e+=" LOCAL",this.inputs.local.track===this.output.track&&(e+=`[${this.inputs.local.label}]`)),this.inputs.remote.track&&(e+=" REMOTE",this.inputs.remote.track===this.output.track&&(e+=`[${this.inputs.remote.label}]`));let t="";for(let e in this.mixins)this.output.destination&&this.mixins[e].node.isConnectedTo(this.output.destination)&&(t+=" m"+e);t&&(e+=" "+t);for(let t in this.stages)this.stages[t].enabled&&(e+="/"+this.stages[t].type);return e})),this.stageInputVolume=new n.StageInputVolume(this.context),this.stageAIProcessing=new o.StageAIProcessing(this.context,this.logger),this.stageDelay=new d.StageDelay(this.context),this.stages=[this.stageInputVolume,this.stageAIProcessing,this.stageDelay],this.output.stream=e.outputStream,this.pluginList=[],this.logger.log("Audio Pipeline Init")}getMixin(e){return this.mixins[e]||(this.mixins[e]=new c.AudioMix(this)),this.mixins[e]}getEnabledStages(){return this.stages.filter((e=>e.enabled))}setInput(e,t,i){this.inputs[e].track=t,this.updateConnection()}getInputVolume(){return this.stageInputVolume.volume}setInputVolume(e){this.stageInputVolume.setVolume(e),this.stageInputVolume.isTransparent()?this.stageInputVolume.enabled&&(this.stageInputVolume.enabled=!1,this.updateConnection()):this.stageInputVolume.enabled||(this.stageInputVolume.enabled=!0,this.updateConnection())}setDelay(e){this.stageDelay.setDelay(e),this.stageDelay.isTransparent()?this.stageDelay.enabled&&(this.stageDelay.enabled=!1,this.updateConnection()):this.stageDelay.enabled||(this.stageDelay.enabled=!0,this.updateConnection())}getAudioLevel(){return this.audioLevelNode||(this.initAudioLevelNode(),this.updateConnection()),this.audioLevelNode?(this.audioLevelNode.audioNode&&!this.audioLevelNode.audioNode.port.onmessage&&(this.audioLevelNode.logger.warn("Rebinding Audio Worklet Node"),this.audioLevelNode.bindAudioWorkletNode(this.audioLevelNode.audioNode)),this.audioLevelNode.getAudioLevel()):0}initAudioLevelNode(){this.audioLevelNode?this.logger.log("initAudioLevelNode: audioLevelNode Already Inited"):(this.audioLevelNode=new r.AudioLevelNode({logger:this.logger,context:this.context}),this.updateConnection())}hasWorkingMixin(){for(let e in this.mixins)if("MIX_PLAYING"===this.mixins[e].mixAudioConf.state)return!0;return!1}updateConnection(){var e,t,i,r,n,o;const d=this.getInputsInfo();let c=null;switch(d.cnt){case 0:this.output.directOutput=!0,this.output.stream.getTracks().length&&(this.output.stream.getTracks().forEach((e=>{this.output.stream.removeTrack(e)})),this.logger.log("updateConnection:NoInput"),this.output.stream.dispatchEvent(new Event("neTrackUpdated")),this.output.track=null),this.audioLevelNode&&this.audioLevelNode.disconnectFromAll();break;case 1:if(this.getEnabledStages().length||this.hasWorkingMixin()){this.output.destination||(this.logger.log("updateConnection: Creating output destination"),this.output.destination=new s.NeAudioNode("destination",this.context.createMediaStreamDestination())),this.output.track=this.output.destination.audioNode.stream.getTracks()[0],this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach((e=>{var t;this.logger.log(`updateConnection: Updating output track ${e.label} => ${null===(t=this.output.track)||void 0===t?void 0:t.label}`),this.output.stream.removeTrack(e)})),this.output.stream.addTrack(this.output.track),this.output.stream.dispatchEvent(new Event("neTrackUpdated")));let e=!1;for(let t in this.mixins){const i=this.mixins[t];"MIX_PLAYING"===i.mixAudioConf.state?(i.mixAudioConf.replace&&(e=!0),i.node.isConnectedTo(this.output.destination)||(this.logger.log(`connect ${t} to destination`),i.node.connect(this.output.destination))):i.node.isConnectedTo(this.output.destination)&&i.node.disconnect(this.output.destination)}if(this.stages){let t=this.output.destination;for(let s=this.stages.length-1;s>=0;s--){const a=this.stages[s];a.enabled&&a.node?(c||(c=a.node),e&&t===this.output.destination?a.node.isConnectedTo(t)&&a.node.disconnect(t):a.node.isConnectedTo(t)||(a.node.disconnectToAll(),a.node.connect(t)),t=a.node):a.enabled||(null===(i=a.node)||void 0===i||i.disconnectToAll(),null===(r=a.node)||void 0===r||r.disconnectFromAll())}d.singleInput&&(d.singleInput.track&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote)),e&&t===this.output.destination?(null===(n=d.singleInput.node)||void 0===n?void 0:n.isConnectedTo(t))&&(null===(o=d.singleInput.node)||void 0===o||o.disconnect(t)):d.singleInput.node&&!d.singleInput.node.isConnectedTo(t)&&(d.singleInput.node.disconnectToAll(),d.singleInput.node.connect(t)))}}else this.output.directOutput=!0,(null===(e=d.singleInput)||void 0===e?void 0:e.track)&&(this.output.track=d.singleInput.track,this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach((e=>{this.output.stream.removeTrack(e)})),this.output.stream.addTrack(this.output.track),this.logger.log("updateConnection: DIRECT",this.output.track.label),this.output.stream.dispatchEvent(new Event("neTrackUpdated"))),this.audioLevelNode&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote),c=d.singleInput.node)),(null===(t=d.singleInput)||void 0===t?void 0:t.node)&&d.singleInput.node.disconnectToAll()}this.audioLevelNode&&c&&(c.isConnectedTo(this.audioLevelNode)||(this.audioLevelNode.disconnectFromAll(),c.connect(this.audioLevelNode)))}getInputsInfo(){let e=0,t=null;return this.inputs.local.track&&(e++,t=this.inputs.local),this.inputs.remote.track&&(e++,t=this.inputs.remote),{cnt:e,singleInput:1===e?t:null}}registerPlugin(e,t,i){"AIDenoise"===e&&(this.stageAIProcessing.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"))}unregisterPlugin(e){const t=this.pluginList.indexOf(e);-1!==t&&(this.pluginList.splice(t,1),this.stageAIProcessing.unregisterAIDenoise())}hasPlugin(e){return-1!==this.pluginList.indexOf(e)}async enableAIdenoise(e=!0){this.logger.log("Enabling AI Denoise",e),this.stageAIProcessing.enabled=e,"UNINIT"===this.stageAIProcessing.state&&await this.stageAIProcessing.init(),this.updateConnection()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevelNode=void 0;const r=i(123),s=i(76),a=i(67);let n="NOTREADY",o=null;class d extends s.NeAudioNodeNullable{constructor(e){super("AudioLevelNode",null),this.volume=0,this.volumeTs=Date.now(),this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.context=e.context,this.logger=e.logger.getChild((()=>{let e="AudioLevelNode#"+this.id;return e+="READY"!==n?" "+n:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e})),this.initAudioWorklet()}async initAudioWorklet(){if(this.logger.log("AudioLevelNode initAudioWorklet"),!this.context.audioWorklet)return void this.logger.error("该环境不支持音频处理");o?"LOADING"===n&&await o:(n="LOADING",this.logger.log("正在载入音量模块"),o=this.context.audioWorklet.addModule(r.getBlobUrl("volumeProcessor")),await o,n="READY",this.logger.log("载入音量模块成功"));const e=new AudioWorkletNode(this.context,"vumeter");this.bindAudioWorkletNode(e);const t=a.getAudioLevelDestination();t&&e.connect(t),this.connectedFrom.forEach((e=>{e.connect(this)})),this.connectedTo.forEach((e=>{this.connect(e)}))}bindAudioWorkletNode(e){this.audioNode=e,e.port.onmessage=t=>{var i,r;if(this.audioNode!==e)return;const s=Date.now(),a=Math.floor(s);if(t.data.volume>-1){if(this.volume=t.data.volume,this.volumeTs=s,t.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===a||this.left.history.unshift({sec:a,sum:0}),this.left.volume=t.data.left,this.left.history[0].sum+=t.data.left,this.left.history.length>2&&this.left.history.pop();else{const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(t.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===a||this.right.history.unshift({sec:a,sum:0}),this.right.volume=t.data.right,this.right.history[0].sum+=t.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(i=this.left)||void 0===i?void 0:i.history[1])&&(null===(r=this.right)||void 0===r?void 0:r.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}}}else this.logger.error("Unsupported message",t.data)}}getAudioLevel(){var e,t;return Date.now()-this.volumeTs>1e3?{volume:0}:{volume:this.volume,left:null===(e=this.left)||void 0===e?void 0:e.volume,right:null===(t=this.right)||void 0===t?void 0:t.volume}}}t.AudioLevelNode=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getMediaStreamSourceNode=void 0;const r=i(76),s=[];t.getMediaStreamSourceNode=function(e,t,i){const a=s.find((i=>i.ctx===e&&i.track===t));if(a){if(i){if(!a.audioElem){const e=document.createElement("audio");e.muted=!0,e.volume=0,e.autoplay=!0,e.controls=!0,a.audioElem=e}a.audioElem.srcObject=a.stream,a.audioElem.play().catch((e=>{}))}return a.node}{const a=new MediaStream([t]),n=e.createMediaStreamSource(a),o=new r.NeAudioNode("MediaStreamSource",n);let d=null;i&&(d=document.createElement("audio"),d.muted=!0,d.volume=0,d.autoplay=!0,d.controls=!0,d.srcObject=a,d.play().catch((e=>{})));const c={track:t,stream:a,source:n,ctx:e,node:o,audioElem:d};return s.push(c),o}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageInputVolume=void 0;const r=i(160),s=i(76);class a extends r.StageBase{constructor(e){super(e),this.type="stageInputVolume",this.node=null,this.volume=1}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("gain",this.context.createGain()),this.state="INITED")}isTransparent(){return Math.abs(this.volume-1)<.01}setVolume(e){"UNINIT"===this.state&&this.init(),this.node&&e<=this.node.audioNode.gain.maxValue&&e>=this.node.audioNode.gain.minValue&&(this.node.audioNode.gain.value=e,this.volume=e)}}t.StageInputVolume=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioWorkletAgent=void 0;const r=i(11),s=i(123),a=i(76);let n="NOTREADY",o=null;class d extends r.EventEmitter{constructor(e){super(),this.outputCnt=0,this.inputCnt=0,this.node=new a.NeAudioNodeNullable("AudioWorkletAgent",null),this.logger=e.logger.getChild((()=>{let e="AudioWorkletAgent";return"READY"!==n&&(e+=" "+n),e}));const t=e.context;this.support={context:t}}async init(){this.support.audioWorkletNode?this.logger.error("Already Inited"):this.support.context.audioWorklet?(o?"LOADING"===n&&await o:(n="LOADING",this.logger.log("正在载入 audioWorkletAgentProcessor 模块"),o=this.support.context.audioWorklet.addModule(s.getBlobUrl("audioWorkletAgentProcessor")),await o,n="READY",this.logger.log("载入 audioWorkletAgentProcessor 模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"audioWorkletAgentProcessor"),this.node.updateNode(this.support.audioWorkletNode),this.bindProcessorEvents()):this.logger.error("该环境不支持音频处理")}outputData(e){if(!this.support.audioWorkletNode)throw new Error("Destroyed");this.inputCnt++,this.support.audioWorkletNode.port.postMessage({type:"outputData",data:e})}bindProcessorEvents(){this.removeAllListeners("rawinputs"),this.support.audioWorkletNode.port.onmessage=e=>{this.emit("processor-message",e),"rawinputs"===e.data.type?this.handleTypeRawInputs(e):"bufferDrop"===e.data.type?this.logger.warn(`音频处理程序刚刚丢弃了${5*e.data.cnt}ms的处理数据`):console.error("Unknown message",e)}}handleTypeRawInputs(e){this.outputCnt++,this.emit("rawinputs",e.data)}}t.AudioWorkletAgent=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageDelay=void 0;const r=i(160),s=i(76);class a extends r.StageBase{constructor(e){super(e),this.type="stageDelay",this.node=null,this.delayTime=1}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("delay",this.context.createDelay(10)),this.state="INITED",this.node.audioNode.delayTime.value=this.delayTime)}isTransparent(){return this.delayTime<.01}setDelay(e){"UNINIT"===this.state&&this.init(),this.node&&(this.delayTime=e,this.node.audioNode.delayTime.value=e)}}t.StageDelay=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioMix=void 0;const r=i(76),s=i(73),a=i(159);class n extends s.RTCEventEmitter{constructor(e){super(),this.pipeline=e,this.context=e.context;const t=new r.NeAudioNode("AudioMixingGain",this.context.createGain());this.node=t,this.mixAudioConf={audioFilePath:"",state:"MIX_UNSTART",buffer:null,cachedBuffers:{},audioSource:null,gainFilter:t,replace:!1,loopback:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.logger=e.logger.getChild((()=>"AudioMix "+this.mixAudioConf.state))}async startAudioMixing(e){if((null==e?void 0:e.audioFilePath)?this.logger.log("即将开始伴音:",JSON.stringify(e,null," ")):this.logger.error("startAudioMixing:未指定伴音文件"),Object.assign(this.mixAudioConf,e),this.mixAudioConf.audioFilePath){if(this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath])return this.mixAudioConf.buffer=this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath],this.logger.log("即将从缓存播放伴音",this.mixAudioConf.audioFilePath),this.startMix();{this.logger.log("即将加载云端音乐",this.mixAudioConf.audioFilePath),this.mixAudioConf.state="MIX_STARTING";const e=await this.loadAudioBuffer(this.mixAudioConf.audioFilePath);if("MIX_STARTING"===this.mixAudioConf.state)return this.mixAudioConf.buffer=e,this.startMix();this.logger.warn("startAudioMixing: 播放行为被覆盖")}}}stopAudioMixing(e=!1){return this.mixAudioConf.audioSource?(this.logger.log("即将停止混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource=null):this.logger.warn("stopAudioMixing:当前没有在混音"),this.mixAudioConf.startTime=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.playStartTime=0,e&&this.resetMixConf(),this.mixAudioConf.state="MIX_STOPED",this.pipeline.updateConnection(),this.logger.log("混音已停止"),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=null,this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state="MIX_PAUSED";let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(){let e,t=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.cycle=this.mixAudioConf.cycle-Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播放时间: ",this.mixAudioConf.setPlayStartTime),e=this.mixAudioConf.setPlayStartTime,this.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",this.mixAudioConf),this.logger.log("已经播放的时间: ",t),t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),e=t),this.logger.log("回复重置的时间点：",e),this.mixAudioConf.playStartTime=e,this.startMix()}setAudioMixingVolume(e){if(e<=255&&e>=0){const t=e/255;this.logger.log(`setAudioMixingVolume ${this.mixAudioConf.gainFilter.audioNode.gain.value} => ${t}`),this.mixAudioConf.gainFilter.audioNode.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.audioNode.gain.value}else this.logger.error("setAudioMixingVolume: volume不在0~255范围内：",e)}getAudioMixingPlayedTime(){let e=Date.now();"MIX_PAUSED"==this.mixAudioConf.state&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}startMix(){if(this.logger.log("startMix: ",this.mixAudioConf),this.mixAudioConf.buffer){if(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=new r.NeAudioNode("AudioMixBufferSource",this.pipeline.context.createBufferSource()),this.mixAudioConf.audioSource.audioNode.buffer=this.mixAudioConf.buffer,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.onended=e=>{this.audioEnd(e)},this.mixAudioConf.totalTime=this.mixAudioConf.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.audioNode.gain.value=this.mixAudioConf.volume,this.mixAudioConf.loopback&&this.mixAudioConf.cycle>1){this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback;const e=this.mixAudioConf.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",e),this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime,e-1)}else this.mixAudioConf.loopback&&1==this.mixAudioConf.cycle?(this.mixAudioConf.audioSource.audioNode.loop=!1,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",this.mixAudioConf.loopback),this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state="MIX_PLAYING",this.mixAudioConf.startTime=Date.now(),this.pipeline.updateConnection(),Promise.resolve()}this.logger.error("startMix: 缺少 mixAudioConf.buffer")}audioEnd(e){return"MIX_PLAYING"!==this.mixAudioConf.state?void this.logger.error("audioEnd:状态不对"):this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.audioNode.loop&&this.mixAudioConf.cycle<=0?void this.logger.log("无限循环时，伴音播放完成event: ",e):(this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.audioNode.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),this.pipeline.updateConnection(),Promise.resolve())}async loadAudioBuffer(e){let t,i;this.mixAudioConf.cachedBuffers[e]?this.logger.warn(`loadAudioBuffer: 该文件已有缓存，长度：${this.mixAudioConf.cachedBuffers[e].duration} 秒。即将更新该文件地址：${e}`):this.logger.warn("loadAudioBuffer: 开始加载文件。地址："+e);try{t=await a.ajax({url:e,type:"GET",dataType:"arraybuffer"})}catch(e){throw this.logger.error("loadAudioBuffer 加载云端音乐失败: ",e),e}this.logger.log(`loadAudioBuffer 文件下载成功。大小：${Math.floor(t.byteLength/1024)} KB`);try{i=await this.pipeline.context.decodeAudioData(t)}catch(e){throw this.logger.log("loadAudioBuffer 解码失败:",e),e}return this.logger.log(`loadAudioBuffer 解码成功。长度：${i.duration} 秒。`),this.mixAudioConf.cachedBuffers[e]=i,i}resetMixConf(){this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource=null),this.mixAudioConf.audioFilePath="",this.mixAudioConf.buffer=null,this.mixAudioConf.state="MIX_UNSTART",this.mixAudioConf.replace=!1,this.mixAudioConf.cycle=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.startTime=0,this.mixAudioConf.totalTime=0,this.mixAudioConf.volume=1,this.mixAudioConf.playStartTime=0,this.mixAudioConf.setPlayStartTime=0,this.mixAudioConf.auidoMixingEnd=null,this.emit("audioFilePlaybackCompleted")}}t.AudioMix=n},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createCanvasWatermarkControl=t.CanvasWatermarkControl=void 0;const s=r(i(197)),a=i(11),n=i(69),o=i(198);class d extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{background:"rgba(128,128,128, 0.5)",overflow:"hidden","white-space":"break-spaces",position:"absolute",wordBreak:"break-all",color:"white",fontSize:"10pt"}},this.watermarks=[],this.div=null}checkWatermarkParams(e){e.textWatermarks&&e.textWatermarks.forEach((e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};n.isExistOptions(a).result&&n.checkValidInteger(a);const o={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};n.isExistOptions(o).result&&n.checkValidInteger(o)})),e.timestampWatermarks&&[e.timestampWatermarks].forEach((e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};n.isExistOptions(a).result&&n.checkValidInteger(a);const o={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};n.isExistOptions(o).result&&n.checkValidInteger(o)})),e.imageWatermarks&&e.imageWatermarks.forEach((e=>{const t={tag:"Stream.setCanvasWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};n.checkExists(a);const o={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1};n.checkValidInteger(o);const d={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0};n.isExistOptions(d).result&&n.checkValidFloat(d)}))}updateWatermarks(e){this.clear(),this.watermarks=[],e.imageWatermarks&&e.imageWatermarks.forEach((e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;"number"==typeof e.offsetX?t.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(t.left=e.offsetX),"number"==typeof e.offsetY?t.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(t.top=e.offsetY),0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&("number"==typeof e.wmWidth?t.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(t.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?t.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(t.height=e.wmHeight)),"number"==typeof e.wmHeight?t.height=e.wmHeight+"px":e.wmHeight&&"string"==typeof e.wmHeight&&(t.height=e.wmHeight),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),elem:null,style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,elem:null,style:t},this.watermarks.push(i)})),e.textWatermarks&&e.textWatermarks.forEach((e=>{let t=e.content||"";const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.color=o.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.color=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize),"number"==typeof e.offsetX?i.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(i.left=e.offsetX),"number"==typeof e.offsetY?i.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(i.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?i.background="":"number"==typeof e.wmColor?i.background=o.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(i.background=e.wmColor),e.wmWidth,"number"==typeof e.wmWidth?e.wmWidth>0&&(i.width=e.wmWidth+"px"):"string"==typeof e.wmWidth&&(i.width=e.wmWidth),e.wmHeight&&("number"==typeof e.wmHeight?(e.wmHeight>0&&(i.wmHeight=e.wmWidth+"px"),i.height=e.wmHeight+"px"):"string"==typeof e.wmHeight&&(i.height=e.wmHeight));const r={type:"text",content:t,loop:!1,elem:null,loopIndex:0,style:i};this.watermarks.push(r)})),e.timestampWatermarks&&[e.timestampWatermarks].forEach((e=>{const t=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?t.color=o.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(t.color=e.fontColor),"number"==typeof e.fontSize?t.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(t.fontSize=e.fontSize),"number"==typeof e.offsetX?t.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(t.left=e.offsetX),"number"==typeof e.offsetY?t.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(t.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?t.background="":"number"==typeof e.wmColor?t.background=o.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(t.background=e.wmColor),e.wmWidth&&("number"==typeof e.wmWidth?t.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(t.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?t.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(t.height=e.wmHeight));const i={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,elem:null,style:t};this.watermarks.push(i)})),this.div&&this.start(this.div)}start(e){this.clear(),this.div=e,this.watermarks.forEach((t=>{let i;switch(t.type){case"text":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-text",i.innerText=t.content||"",Object.assign(i.style,t.style);break;case"timestamp":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-timestamp",i.innerText="",Object.assign(i.style,t.style);break;case"image":!t.imageUrls&&t.content&&(t.imageUrls=[t.content]),i=document.createElement("div"),i.className="nim-watermark nim-watermark-image-container",t.imgElems=[],t.imageUrls&&t.imageUrls.length&&t.imageUrls.forEach(((e,r)=>{const s=document.createElement("img");s.className="nim-watermark nim-watermark-image nim-watermark-image-"+r,s.src=e,s.style.width="100%",t.style.height&&(s.style.height="100%"),s.style.overflow="hidden",t.imgElems&&t.imgElems.push(s),i.appendChild(s),r>0&&(s.style.display="none")})),t.loopIndex=-1;const e=()=>{if(!t.interval&&t.imgElems&&t.loopIndex>=0)t.imgElems[t.loopIndex].style.display="";else{if(t.imgElems&&t.imgElems[t.loopIndex]&&(t.imgElems[t.loopIndex].style.display="none"),t.loopIndex++,t.imgElems&&t.loopIndex>=t.imgElems.length){if(!t.loop)return void(t.loopTimer&&clearInterval(t.loopTimer));t.loopIndex=0}t.imgElems&&(t.imgElems[t.loopIndex].style.display="")}};e(),t.interval&&(t.loopTimer=setInterval(e,t.interval)),Object.assign(i.style,t.style)}t.elem=i,e.appendChild(t.elem)}))}clear(){this.div&&this.watermarks.forEach((e=>{e.elem&&(e.elem.remove(),e.elem=null),e.loopTimer&&clearTimeout(e.loopTimer)}))}}t.CanvasWatermarkControl=d;const c=new class{constructor(){this.controls=[],this.timer=setInterval((()=>{this.updateTimestamps()}),1e3)}updateTimestamps(){this.controls.forEach((e=>{e.watermarks.filter((e=>"timestamp"===e.type)).forEach((e=>{e.elem&&(e.elem.innerText=s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"))}))}))}};t.createCanvasWatermarkControl=function(e){const t=new d(e);return c.controls.push(t),t}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createEncoderWatermarkControl=t.EncoderWatermarkControl=void 0;const s=r(i(197)),a=i(11),n=i(69),o=i(2),d=i(198);class c extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{left:0,top:0,textWidth:0,textHeight:0,fontSize:"15pt",fontFamily:o.getParameters().encoderWatermarkFontFamily,fillStyle:"white",textBaseline:"hanging",bgWidth:-1,bgHeight:-1,bgFillStyle:"rgba(136, 136, 136, 0.5)"}},this.watermarks=[],this.handler={name:"watermark",enabled:!1,func:this.handleFrame.bind(this)}}handleFrame(e,t,i){this.watermarks.forEach((e=>{if("text"===e.type||"timestamp"===e.type){let t="";t="timestamp"===e.type?s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"):e.content||"",i.canvasCtx.font=`${e.style.fontSize} ${e.style.fontFamily}`,i.canvasCtx.textBaseline=e.style.textBaseline,e.content,-1===e.style.bgWidth&&-1===e.style.bgHeight&&(e.style.bgWidth=e.style.textWidth,e.style.bgHeight=e.style.textHeight),e.style.bgWidth&&e.style.bgHeight&&(i.canvasCtx.fillStyle=e.style.bgFillStyle,i.canvasCtx.fillRect(e.style.left,e.style.top,e.style.bgWidth,e.style.bgHeight)),i.canvasCtx.fillStyle=e.style.fillStyle,i.canvasCtx.fillText(t,e.style.left,e.style.top)}if("image"===e.type&&e.imgElems){let t;if(e.interval){if(e.startMs&&e.interval){const i=Date.now()-e.startMs,r=Math.floor(i/e.interval);for(let i=r;i<r+e.imgElems.length;i++){const r=e.imgElems[e.loop?i%e.imgElems.length:i];if(r&&r.complete&&r.naturalWidth&&r.naturalHeight){t=r;break}}}}else e.imgElems[0].complete&&e.imgElems[0].naturalWidth&&e.imgElems[0].naturalHeight&&(t=e.imgElems[0]);if(t){let r,s;e.style.bgWidth>0&&e.style.bgHeight>0?(r=e.style.bgWidth,s=e.style.bgHeight):(r=t.naturalWidth,s=t.naturalHeight),i.canvasCtx.drawImage(t,e.style.left,e.style.top,r,s)}}}))}checkWatermarkParams(e){var t,i;const r={tag:"Stream.setEncoderWatermarkConfigs:watermarks.count",value:((null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||0)+(e.timestampWatermarks?1:0)+((null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)||0),max:o.getParameters().encoderWatermarkLimit};n.checkValidInteger(r),e.textWatermarks&&e.textWatermarks.forEach((e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1,max:128};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};n.isExistOptions(a).result&&n.checkValidInteger(a);const o={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};n.isExistOptions(o).result&&n.checkValidInteger(o)})),e.timestampWatermarks&&[e.timestampWatermarks].forEach((e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1,max:128};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};n.isExistOptions(a).result&&n.checkValidInteger(a);const o={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};n.isExistOptions(o).result&&n.checkValidInteger(o)})),e.imageWatermarks&&e.imageWatermarks.forEach((e=>{const t={tag:"Stream.setEncoderWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};n.isExistOptions(t).result&&n.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};n.isExistOptions(i).result&&n.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};n.isExistOptions(r).result&&n.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};n.isExistOptions(s).result&&n.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};n.checkExists(a);const o={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1,max:10};n.checkValidInteger(o);const d={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0,max:30};n.isExistOptions(d).result&&n.checkValidFloat(d)}))}updateWatermarks(e){this.watermarks=[],e.imageWatermarks&&e.imageWatermarks.forEach((e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;if("number"==typeof e.offsetX?t.left=e.offsetX:e.offsetX,"number"==typeof e.offsetY?t.top=e.offsetY:e.offsetY,0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&"number"==typeof e.wmWidth&&(t.bgWidth=e.wmWidth),e.wmHeight&&"number"==typeof e.wmHeight&&(t.bgHeight=e.wmHeight),!1!==e.loop&&(e.loop=!0),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,style:t},i.startMs=Date.now(),i.imgElems=[],i.imageUrls)for(let e=0;e<i.imageUrls.length;e++){const t=new Image;t.src=i.imageUrls[e],i.imgElems.push(t)}this.watermarks.push(i)})),e.textWatermarks&&e.textWatermarks.forEach((e=>{let t=e.content||"";const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.fillStyle=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize);const r=d.measureText(e.content,i.fontSize,i.fontFamily);i.textWidth=r.width,i.textHeight=r.height,e.offsetX&&(i.left=e.offsetX),e.offsetY&&(i.top=e.offsetY),e.wmColor,e.wmWidth>=0&&(i.bgWidth=e.wmWidth),e.wmHeight>=0&&(i.bgHeight=e.wmHeight),"number"==typeof e.wmColor?i.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(i.bgFillStyle=e.wmColor);const s={type:"text",content:t,loop:!1,loopIndex:0,style:i};this.watermarks.push(s)})),e.timestampWatermarks&&[e.timestampWatermarks].forEach((e=>{const t=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?t.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(t.fillStyle=e.fontColor),"number"==typeof e.fontSize?t.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(t.fontSize=e.fontSize);const i=d.measureText("yyyy-mm-dd HH:MM:ss",t.fontSize,t.fontFamily);t.textWidth=i.width,t.textHeight=i.height,e.offsetX&&(t.left=e.offsetX),e.offsetY&&(t.top=e.offsetY),e.wmWidth>=0&&(t.bgWidth=e.wmWidth),e.wmHeight>=0&&(t.bgHeight=e.wmHeight),"number"==typeof e.wmColor?t.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"===e.wmColor&&(t.bgFillStyle=e.wmColor);const r={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,style:t};this.watermarks.push(r)}))}}t.EncoderWatermarkControl=c,t.createEncoderWatermarkControl=function(e){return new c(e)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parseBase64=void 0;const r=i(296);let s;t.parseBase64=function(e){var t=e.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(!s){s=[];for(var a=0;a<65;a++)s[i.charCodeAt(a)]=a}var n=i.charAt(64);if(n){var o=e.indexOf(n);-1!==o&&(t=o)}return function(e,t,i){for(var s=[],a=0,n=0;n<t;n++)if(n%4){var o=i[e.charCodeAt(n-1)]<<n%4*2|i[e.charCodeAt(n)]>>>6-n%4*2;s[a>>>2]|=o<<24-a%4*8,a++}return new r.WordArray(s,a)}(e,t,s)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.WordArray=t.Hex=void 0,t.Hex={stringify(e){for(var t=e.words,i=e.sigBytes,r=[],s=0;s<i;s++){var a=t[s>>>2]>>>24-s%4*8&255;r.push((a>>>4).toString(16)),r.push((15&a).toString(16))}return r.join("")}},t.WordArray=class{constructor(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length}toString(e){return(e||t.Hex).stringify(this)}concat(e){var t=this.words,i=e.words,r=this.sigBytes,s=e.sigBytes;if(this.clamp(),r%4)for(var a=0;a<s;a++){var n=i[a>>>2]>>>24-a%4*8&255;t[r+a>>>2]|=n<<24-(r+a)%4*8}else for(var o=0;o<s;o+=4)t[r+o>>>2]=i[o>>>2];return this.sigBytes+=s,this}clamp(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4)}}},function(e,t,i){var r=i(298),s=i(300);t.Peer=r,t.WebSocketTransport=s},function(e,t,i){var r=a(i(65)),s=a(i(66));function a(e){return e&&e.__esModule?e:{default:e}}var n=i(147),o=i(199),d=i(200),c=i(2).getParameters,l=new n("Peer"),u=0;e.exports=class extends o{constructor(e){super(l),l.debug("constructor()"),this._closed=!1,this.id=u++,this._transport=e,this._connected=!1,this._data={createTs:Date.now()},this._sents=new Map,this._notificationId=0,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){l.debug("close()"),this._closed=!0,this._connected=!1,this._notificationId=0,this._transport.close(),this._transport=null;var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0)r.value.close()}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}}clear(){var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0)r.value.close()}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}request(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createRequest(e,i),"Heartbeat"!=e&&t._logger.debug("request() [method: "+e+", id: "+a.id+"]"),r.next=4,t._transport.send(a);case 4:return r.abrupt("return",new Promise((function(e,i){var r=c().protooMessageTimeout,s={id:a.id,method:a.method,startTs:Date.now(),resolve:function(i){t._sents.delete(a.id)&&(t._closed||(clearTimeout(s.timer),e(i)))},reject:function(e){t._sents.delete(a.id)&&(clearTimeout(s.timer),i(e))},timer:setTimeout((function(){t._sents.delete(a.id)&&i(new Error("request timeout"))}),r),close:function(){var e=new Error;e.name="peer closed",s.method&&(e.message="向edge的 "+s.method+" 请求被取消：连接 #"+t.id+" 已被关闭。连接建立时间："+(t._data.openTs-t._data.createTs)+"ms, 请求时间："+(Date.now()-s.startTs)+"ms"),i(e)}};t._sents.set(a.id,s)})));case 5:case"end":return r.stop()}}),s,t)})))()}notify(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createNotification(e,i),t._logger.debug("notify() [method:%s]",e),r.next=4,t._transport.send(a);case 4:case"end":return r.stop()}}),s,t)})))()}_handleTransport(){var e=this;if(this._transport.closed)return this._closed=!0,void setTimeout((function(){e._closed||(e._connected=!1,e.safeEmit("close"))}));this._transport.on("open",(function(){e._closed||(l.debug('emit "open"'),e._connected=!0,e._data.openTs=Date.now(),e.safeEmit("open"))})),this._transport.on("disconnected",(function(){e._closed||(l.debug('emit "disconnected"'),e._connected=!1,e.safeEmit("disconnected"))})),this._transport.on("failed",(function(t){e._closed||(l.debug('emit "failed" [currentAttempt:%s]',t),e._connected=!1,e.safeEmit("failed",t))})),this._transport.on("close",(function(){e._closed||(e._closed=!0,l.debug('emit "close"'),e._connected=!1,e.safeEmit("close"))})),this._transport.on("message",(function(t){t.request?e._handleRequest(t):t.response?e._handleResponse(t):t.notification&&e._handleNotification(t)}))}_handleRequest(e){var t=this;try{this.emit("request",e,(function(i){var r=d.createSuccessResponse(e,i);t._transport.send(r).catch((function(){}))}),(function(i,r){i instanceof Error?(i=500,r=String(i)):"number"==typeof i&&r instanceof Error&&(r=String(r));var s=d.createErrorResponse(e,i,r);t._transport.send(s).catch((function(){}))}))}catch(t){var i=d.createErrorResponse(e,500,String(t));this._transport.send(i).catch((function(){}))}}_handleResponse(e){var t=this._sents.get(e.id);if(t)if(e.ok)t.resolve(e.data);else{var i=new Error(e.errorReason);i.code=e.errorCode,t.reject(i)}else l.error("received response does not match any sent request",e.id,JSON.stringify(e))}_handleNotification(e){if(this._handleNotification>e.id)l.warn("忽略重复的通知消息: ",JSON.stringify(e,null," "));else{this._notificationId=e.id;var t=d.createSuccessResponse(e,{});this._transport.send(t).catch((function(){})),this.safeEmit("notification",e)}}}},function(e,t,i){t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t,i){var r=a(i(65)),s=a(i(66));function a(e){return e&&e.__esModule?e:{default:e}}var n=i(301),o=i(147),d=i(199),c=i(200),l=i(124).JSONBigStringify,u=i(2).getParameters,h={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},p=new o("WebSocketTransport"),m=0;e.exports=class extends d{constructor(e,t){super(p),p.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this.wsid=0,this.skipReconnection=!1,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){p.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){p.error("close() | error closing the WebSocket: %o",e)}}}send(e){var t=this;return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!t._closed){i.next=2;break}throw new Error("transport closed");case 2:i.prev=2,t._ws.send(l(e)),i.next=10;break;case 6:throw i.prev=6,i.t0=i.catch(2),p.warn("send() failed:",i.t0.name,i.t0.message),i.t0;case 10:case"end":return i.stop()}}),i,t,[[2,6]])})))()}_runWebSocket(){var e=this,t=n.operation(this._options.retry||h),i=!1;t.attempt((function(r){e._closed?t.stop():(p.debug("_runWebSocket() [currentAttempt:%s]",r),e._ws=new WebSocket(e._url,["protoo"]),m++,e.wsid=m,e._ws.onopen=function(){e._closed||(i=!0,e.safeEmit("open"))},e._ws.onclose=function(s){if(!e._closed)if(p.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',s.wasClean,s.code,s.reason),i){if(t.stop(),e.safeEmit("disconnected"),e._closed||e.skipReconnection)return;e._runWebSocket()}else e.safeEmit("failed",r),e._closed||t.retry(!0)||(e._closed=!0,e.safeEmit("close"))},e._ws.onerror=function(){e._closed||p.error('WebSocket "error" event')},e._ws.onmessage=function(t){if(!e._closed){var i=c.parse(t.data);i&&(0!==e.listenerCount("message")?u().signalingMessageDelay?setTimeout((function(){e._closed||e.safeEmit("message",i)}),u().signalingMessageDelay):e.safeEmit("message",i):p.error('no listeners for WebSocket "message" event, ignoring received message'))}})}))}}},function(e,t,i){e.exports=i(302)},function(e,t,i){var r=i(303);t.operation=function(e){var i=t.timeouts(e);return new r(i,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,r=Math.round(i*t.minTimeout*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,i,r){if(i instanceof Array&&(r=i,i=null),!r)for(var s in r=[],e)"function"==typeof e[s]&&r.push(s);for(var a=0;a<r.length;a++){var n=r[a],o=e[n];e[n]=function(r){var s=t.operation(i),a=Array.prototype.slice.call(arguments,1),n=a.pop();a.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),n.apply(this,arguments))})),s.attempt((function(){r.apply(e,a)}))}.bind(e,o),e[n].options=i}}},function(e,t){function i(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(void 0===i){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),i=this._timeouts.shift()}var r=this,s=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),i);return this._options.unref&&s.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){i._operationTimeoutCb()}),i._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,i=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,n=(e[a]||0)+1;e[a]=n,n>=i&&(t=s,i=n)}return t}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LBSManager=void 0;const s=i(57),a=i(159),n=r(i(12)),o=r(i(13)),d=i(59),c=i(2),l=i(124),u=i(202),h=i(57);var p;!function(e){e[e.UNKNOWN_ERROR=99999]="UNKNOWN_ERROR",e[e.TIMEOUT=70100]="TIMEOUT",e[e.JSON_ERROR=70101]="JSON_ERROR",e[e.FORMAT_ERROR=70102]="FORMAT_ERROR"}(p||(p={}));let m=0;t.LBSManager=class{constructor(e){this.lbsManagerId=m++,this.urlBackupMap={},this.requestCnt=0,this.localStorageKey="LBS_CONFIG",this.builtinConfig=u.geofenceArea.getBuiltinConfig(),this.updateTimer=null,this.lastUpdateStartAt=0,this.lastUpdate=null,this.tagToMainDomain={},this.lbsState="uninit",this.lbsStateWillChangeTimer=null,this.client=e,this.logger=e.logger.getChild((()=>{let e="LBSManager "+this.lbsState;return this.client.adapterRef.lbsManager.lbsManagerId!==this.lbsManagerId&&(e+="DETACHED"),e})),window.addEventListener("online",(()=>{"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.adapterRef.lbsManager.lbsManagerId===this.lbsManagerId&&Date.now()-this.lastUpdateStartAt>3e3&&(this.logger.log("侦测到网络连接恢复，尝试更新LBS配置"),this.startUpdate("online"))}))}async startUpdate(e){var t,i,r;if(c.getParameters().disableLBSService||c.getParameters().lbsUseBuiltinOnly)return;if(!this.client._params.appkey)return void this.logger.error("无法更新域名配置：缺少appkey");if(null===(r=null===(i=null===(t=this.client)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)return void this.logger.log("忽略更新LBS配置请求：当前为私有化配置");const a=Date.now(),n=a-this.lastUpdateStartAt;if(n<3e3)return void this.logger.log(`startUpdate 忽略更新请求 ${e}: 上次更新于 ${n} 毫秒前`);this.lastUpdateStartAt=a,this.logger.log("startUpdate: 开始更新LBS配置。原因："+e);let o=null;try{o=await this.ajax({url:`${s.lbsUrl}?reason=${e}&sdkVersion=${encodeURIComponent(s.SDK_VERSION)}&appKey=${encodeURIComponent(this.client._params.appkey)}&business=rtc&clientType=16`,type:"GET",header:{}})}catch(e){this.logger.error("LBS更新失败！",e)}if(this.getReportField("lbs").forEach((e=>{this.client.apiEventReport("setRequestLbs",e)})),o&&o.nrtc&&o.call&&o.tracking)return o.ttl&&(this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout((()=>{this.logger.log("LBS已到过期时间，正在回滚至内建设置"),this.loadBuiltinConfig("expire")}),1e3*o.ttl)),this.lastUpdate={activeFrom:Date.now(),res:o},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.nrtc,o.nrtc,"nrtc","lbs"),this.addUrlBackup(this.tagToMainDomain.call,o.call,"call","lbs"),this.addUrlBackup(this.tagToMainDomain.tracking,o.tracking,"tracking","lbs"),this.lbsState="remote",this.logger.log(`成功加载远端配置。过期时间：${o.ttl}秒后。preloadTimeSec:${o.preloadTimeSec}：`),this.client.safeEmit("@lbs-config-update",{reason:e}),this.saveConfig(o),o;this.logger.error("startUpdate更新失败：无效的 LBS 返回",o)}async loadBuiltinConfig(e){if(!c.getParameters().disableLBSService){this.builtinConfig=u.geofenceArea.getBuiltinConfig(),"uninit"!==this.lbsState&&this.handleLbsStateWillChange(e);for(let e in this.builtinConfig)if(this.builtinConfig[e].length){const t=h.TAGS_TO_MAIN_DOMAIN[e]||this.builtinConfig[e][0];this.addUrlBackup(t,this.builtinConfig[e],e,"builtin"),this.tagToMainDomain[e]=t}this.lbsState="builtin",this.client.safeEmit("@lbs-config-update",{reason:e}),"oninit"!==e&&this.logger.log(`成功加载内建配置 ${e}。`)}}handleLbsStateWillChange(e){this.lbsStateWillChangeTimer&&clearTimeout(this.lbsStateWillChangeTimer);const t={lbsState:this.lbsState,settings:this.getSettings()};this.lbsStateWillChangeTimer=setTimeout((()=>{const i={lbsState:this.lbsState,settings:this.getSettings()};"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.apiFrequencyControl({name:"_lbsStateChange",code:0,param:{reason:e,before:t,after:i}})}),0)}getSettings(){const e=Object.keys(this.urlBackupMap),t={};return e.forEach((e=>{t[e]=this.urlBackupMap[e].map((e=>{const t=e.lastRequest?{status:e.lastRequest.status,rtt:e.lastRequest.rtt}:void 0;return{domain:e.domain,successCount:e.successCount,failCount:e.failCount,lastResult:t}}))})),t}getReportField(e){const t=[];for(let i in this.urlBackupMap)for(let r=0;r<this.urlBackupMap[i].length;r++){const s=this.urlBackupMap[i][r];s.tag===e&&t.push(s)}let i=[],r=0;return t.forEach((t=>{if(t.lastRequest&&"inprogress"!==t.lastRequest.status){if(t.lastRequest.requestId>r&&(r=t.lastRequest.requestId,i=[]),t.lastRequest.requestId!==r)return;"lbs"===e?i.push({app_key:this.client._params.appkey,request_id:t.lastRequest.uuid,err_code:t.lastRequest.errCode,err_msg:t.lastRequest.errMsg,rtt:t.lastRequest.rtt,time:t.lastRequest.finishiedAt}):"nrtc"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1}):"call"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt}):i.push({domain:t.domain,requestId:t.lastRequest.uuid,addr:"",type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt})}})),i}saveConfig(e){if(!this.client._params.appkey)return void this.logger.error("saveConfig: 缺少appkey");const t={ts:Date.now(),appKey:this.client._params.appkey,sdkVersion:s.SDK_VERSION,sdkBuild:s.BUILD,areaCode:u.geofenceArea.areaCode,config:e};try{localStorage.setItem(this.localStorageKey,l.JSONBigStringify(t))}catch(e){this.logger.error("saveConfig：无法存储LBS设置",e.name,e.message)}}loadLocalConfig(e){var t,i;if(!this.client._params.appkey)return this.logger.error("loadLocalConfig: 缺少appkey"),{reason:"appkeyNotFound",config:null};if(null===(i=null===(t=this.client._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return this.logger.log("忽略 loadLocalConfig 请求：当前为私有化配置"),{reason:"privilization",config:null};let r=null;try{const e=window.localStorage.getItem(this.localStorageKey);if(!e)return this.logger.log("本地未发现LBS配置"),{reason:"configNotFound",config:null};r=l.JSONBigParse(e)}catch(e){this.logger.error("无法读取本地配置：",e.name,e.message)}if(!r)return{reason:"configError",config:null};const a=Date.now(),n=r.ts+1e3*r.config.ttl-a;return n<0?(this.logger.log(`LBS不使用本地配置：ttl已过期${Math.floor(-n/1e3)} 秒。`),{reason:"expire",config:null}):r.sdkVersion!==s.SDK_VERSION||r.sdkBuild!==s.BUILD?(this.logger.warn(`LBS不使用本地配置：版本不匹配。${r.sdkVersion}/${r.sdkBuild} ${s.SDK_VERSION}/${s.BUILD}。`),{reason:"version",config:null}):r.appKey!==this.client._params.appkey?(this.logger.warn(`LBS不使用本地配置：appKey不匹配。${r.appKey} ${this.client._params.appkey}。`),{reason:"appkey",config:null}):r.areaCode!==u.geofenceArea.areaCode?(this.logger.warn(`LBS不使用本地配置：areaCode不匹配。${r.areaCode} ${u.geofenceArea.areaCode}。`),{reason:"areaCode",config:null}):(this.lastUpdate={activeFrom:r.ts,res:r.config},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.call,r.config.call,"call","localstorage"),this.addUrlBackup(this.tagToMainDomain.nrtc,r.config.nrtc,"nrtc","localstorage"),this.addUrlBackup(this.tagToMainDomain.tracking,r.config.tracking,"tracking","localstorage"),this.lbsState="local",this.logger.log(`成功加载本地配置。过期时间：${Math.floor(n/1e3)} 秒后。`),this.client.safeEmit("@lbs-config-update",{reason:e}),{reason:"success",config:r})}addUrlBackup(e,t,i,r){const s=this.urlBackupMap[e]||[];this.urlBackupMap[e]=[];const a=this.urlBackupMap[e],n=Date.now();t.forEach((t=>{let o=s.find((i=>i.domain===t&&i.mainDomain===e));o?(o.updatedAt=n,o.tag=i,o.source=r):o={id:a.length,domain:t,mainDomain:e,successCount:0,failCount:0,updatedAt:n,tag:i,source:r},a.push(o)}))}getURLSettings(e){const t=/(\/\/)([^\/]+)(\/)/,i=e.match(t);let r="";r=i?i[2]:e,this.urlBackupMap[r]||this.addUrlBackup(r,[r],"extra","extra");const s=this.requestCnt++;return this.urlBackupMap[r].map(((i,r)=>{const a=e.replace(t,`$1${i.domain}$3`);return{seqId:`${s}_${r}`,state:"uninit",requestId:s,url:a,item:i}}))}markSuccess(e,t){var i;"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="success",this.logger.debug(`markFinish success seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`)),e.item.successCount++,e.state="success";const r=this.urlBackupMap[e.item.mainDomain];if(r&&"fail"===(null===(i=r[0].lastRequest)||void 0===i?void 0:i.status)){const t=r.findIndex((t=>t===e.item));t>-1&&(this.logger.warn(`主备域名互换。${r[0].domain} => ${e.item.domain}`),this.handleLbsStateWillChange("domainDown:"+r[0].domain),r.splice(t,1),r.unshift(e.item))}}markFail(e,t,i,r){"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="fail",t.errCode=i,t.errMsg=r,this.logger.debug(`markFinish fail seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`,i,r)),e.item.failCount++,e.state="fail",this.logger.error("markFail：",e.item.domain,i,r)}isAllRequestsFinished(e){for(let t in e){const i=e[t];if("uninit"===i.state||"sent"===i.state)return!1}return!0}ajax(e){if(c.getParameters().disableLBSService)return a.ajax(e);const t=this.getURLSettings(e.url);let i=!1;return new Promise(((r,s)=>{let u=0,h=0;const m=(a,d,c)=>{var m,g,v,_,y,S,R;if(h=Date.now()-u,e.url.indexOf("getChannelInfos.action")>-1&&(this.client.adapterRef.state.getChannelInfoRtt=h),a.status>=400){if(this.markFail(c,d,a.status,"string"==typeof a.response?a.response:l.JSONBigStringify(a.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${c.url} 】【备 ${t[1].url} 】`,a.status),t[1].fire();else if(this.isAllRequestsFinished(t))return s(new o.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 网络请求错误"}))}else if("json"!==a.responseType||a.response)if(500===(null===(m=a.response)||void 0===m?void 0:m.code)){if(this.markFail(c,d,p.UNKNOWN_ERROR,l.JSONBigStringify(a.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${c.url} 】【备 ${t[1].url} 】`,a.response),t[1].fire();else if(this.isAllRequestsFinished(t)){var b=a.response;r(b)}}else if("lbs"!==c.item.tag||(null===(v=null===(g=a.response)||void 0===g?void 0:g.call)||void 0===v?void 0:v.length)&&(null===(y=null===(_=a.response)||void 0===_?void 0:_.nrtc)||void 0===y?void 0:y.length)&&(null===(R=null===(S=a.response)||void 0===S?void 0:S.tracking)||void 0===R?void 0:R.length)){if(this.markSuccess(c,d),t.forEach((e=>{e.timer&&(clearTimeout(e.timer),e.timer=void 0),e.fire=void 0})),i)return void this.logger.log(`${c.url} 已忽略返回值：${a.status}`);f(a),b=a.response,r(b)}else{if(this.markFail(c,d,p.FORMAT_ERROR,l.JSONBigStringify(a.response)),!(t[1]&&t[1].fire&&t[1].timer))return r(a.response);this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${c.url} 】【备 ${t[1].url} 】`,"FORMAT_ERROR"),t[1].fire()}else if(this.markFail(c,d,p.JSON_ERROR,"JSON_ERROR"),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${c.url} 】【备 ${t[1].url} 】`,a),t[1].fire();else if(this.isAllRequestsFinished(t))return s(new o.default({code:n.default.LBS_JSON_ERROR,message:"LBS: 结果json解析错误"}))},f=e=>{i=!0,e.onload=null,e.onerror=null,e.ontimeout=null},g=(e,i,r,a)=>{if(this.markFail(r,i,p.UNKNOWN_ERROR,`${a.type||l.JSONBigStringify(a)}:${r.url}`),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${r.url} 】【备 ${t[1].url} 】`,a),t[1].fire();else if(this.isAllRequestsFinished(t))return f(e),s(new o.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(onerror)"}))},v=(e,i,r,a)=>{if(this.markFail(r,i,p.TIMEOUT,"TIMEOUT"),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求超时，启用备用线路 【主 ${r.url}】【备 ${t[1].url}】`,a),t[1].fire();else if(this.isAllRequestsFinished(t))return f(e),s(new o.default({code:n.default.LBS_REQUEST_ERROR,message:"LBS: 主线路请求发生错误(ontimeout)"}))};t.forEach(((t,i)=>{t.fire=()=>{t.fire=void 0,t.timer&&(clearTimeout(t.timer),t.timer=void 0),t.state="sent";const i={status:"inprogress",startAt:Date.now(),requestId:t.requestId,seqId:t.seqId,uuid:"",finishiedAt:0,errCode:0,errMsg:"",rtt:-1};t.item.lastRequest=i,((t,i)=>{const r=new XMLHttpRequest;t.xhr=r,r.open(e.type||"GET",i.url,!0),r.responseType=e.dataType||"json";const s=e.contentType||"application/json;charset=UTF-8";if(r.setRequestHeader("Content-Type",s),e.header&&Object.keys(e.header).map((t=>{e.header&&e.header[t]&&r.setRequestHeader(t,e.header[t])})),"lbs"===i.item.tag){const e=d.generateUUID();i.item.lastRequest&&(i.item.lastRequest.uuid=e),r.setRequestHeader("X-Request-Id",e)}r.onload=m.bind(r,r,t,i),r.onerror=g.bind(r,r,t,i),r.ontimeout=v.bind(r,r,t,i),u=Date.now(),s.indexOf("x-www-form-urlencoded")>=0?e.data?r.send(a.getFormData(e.data)):r.send():e.data?r.send(l.JSONBigStringify(e.data)):r.send()})(i,t)},i&&(t.timer=setTimeout((()=>{t.fire&&(this.logger.warn("主线路请求超时，发起备用线路请求："+t.url),t.fire())}),c.getParameters().fireBackupDelay*i))})),t[0].fire&&t[0].fire()}))}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SignalProbeManager=void 0;const r=i(123),s=i(2);t.SignalProbeManager=class{constructor(e){this.worker=null,this.signalStates={},this.online="unknown",this.serverActiveWaiters=[],this.adapterRef=e,this.logger=this.adapterRef.instance.logger.getChild((()=>"SignalProbe online:"+this.online))}start(e){this.signalStates={},this.online="unknown",e.forEach(((e,t)=>{this.signalStates[e]={index:t,wsUrl:e,active:!1,connect:{startCnt:0,successCnt:0,failCnt:0,failCntFromLastSuccess:0,initAt:-1,connectAt:-1},ping:{sendIndex:0,recvIndex:0,lastSentAt:-1,lastSentMsg:"",rtt:-1}}})),this.logger.log("start",this.signalStates),this.worker&&this.worker.terminate();const t=r.getBlobUrl("signalProbeWorker"),i=new Worker(t);this.worker=i,i.onmessage=e=>{this.processWorkerMessage(e)}}stop(){var e;null===(e=this.worker)||void 0===e||e.terminate(),this.worker=null,this.signalStates={},this.online="unknown"}getServerState(e){return this.signalStates[e]||null}getActiveServerCount(){let e=0,t=0,i=0;for(let r in this.signalStates)t++,this.signalStates[r].ping.rtt>0?e++:i++;return 0===e&&(i=-1),{cnt:e,total:t,code:i}}waitForServerActive(e=1e4){return new Promise((t=>{const i={res:t,resolved:!1,timer:setTimeout((()=>{i.resolved||(i.resolved=!0,this.clearWaiters(),t("timeout"))}),e)};this.serverActiveWaiters.push(i)}))}processWorkerMessage(e){if(!this.worker||!e.data)return;const t=e.data;switch(t.cmd){case"ohayo":try{const e={cmd:"init",data:{signalStates:JSON.parse(JSON.stringify(this.signalStates)),pingInterval:2e3,reconnectionInterval:1e4,maxRtt:s.getParameters().joinFirstTimeout+4e3,wsTimeout:s.getParameters().joinFirstTimeout+8e3}};this.worker.postMessage(e)}catch(e){this.logger.warn("无法启动通道探测：",e)}break;case"sync":this.processCmdSync(t.data);break;case"log":this.logger.log(t.data);break;case"error":this.logger.error(t.data);break;default:this.logger.error("msg",t)}}clearWaiters(){this.serverActiveWaiters=this.serverActiveWaiters.filter((e=>!e.resolved))}processCmdSync(e){const t=this.signalStates;this.signalStates=e;let i=!1;for(let r in t){const s=t[r],a=e[r];s&&a?s.active&&!a.active?(i=!0,"no"!==this.online&&0===this.getActiveServerCount().cnt&&(this.online="no",this.logger.error("所有服务端的ping均在下线状态，请检查网络")),this.logger.warn("[sync]Turns into inactive: "+a.wsUrl,a)):!s.active&&a.active&&(i=!0,1===this.getActiveServerCount().cnt&&"unknown"!==this.online&&this.logger.warn("已有服务端上线，网络恢复"),this.online="yes",this.logger.log(`[sync]Turns into active. RTT: ${a.ping.rtt}ms. ${a.wsUrl}`)):this.logger.warn("[sync]Unrecognized signal",r,s,a)}if(i){const e={name:"onPingStateChange",code:this.getActiveServerCount().code,param:{online:this.online}};for(let t in this.signalStates){const i=this.signalStates[t];i&&(e.param[t]={active:i.active,rtt:i.ping.rtt,successCnt:i.connect.successCnt,failCnt:i.connect.failCnt})}this.adapterRef.instance.apiFrequencyControl(e)}this.serverActiveWaiters.length&&this.getActiveServerCount().cnt>0&&this.serverActiveWaiters.forEach((e=>{e.resolved||(e.resolved=!0,this.clearWaiters(),clearTimeout(e.timer),e.res("active"))}))}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialManager=void 0;const r=i(119),s=i(2);t.SpatialManager=class{constructor(e){this.elem=document.createElement("audio"),this.fakeElem=document.createElement("audio"),this.data={},this.__v_skip=s.getParameters().enableVSkip,this.context=e.context,this.client=e.client,this.options=e.options,this.logger=e.client.adapterRef.logger.getChild((()=>"spatial"));try{this.destination=new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"!==e.name)throw e;this.destination=this.context.createMediaStreamDestination()}this.elem.setAttribute("playsinline","playsinline"),this.elem.setAttribute("autoplay","autoplay"),this.elem.className="nertc-panner-manager",this.elem.srcObject=this.destination.stream,this.fakeElem.muted=!0,this.fakeElem.volume=0,this.fakeElem.autoplay=!0,this.fakeElem.controls=!0}getUserData(e){const t=""+e;""+parseInt(t)!==t&&this.logger.warn("getUserData:异常的uid：",e);let i=this.data[t];return i||(i={position:{x:0,y:0}},this.data[t]=i),i}shouldSubscribe(e){const t=this.getUserData(e);return Math.abs(t.position.x)<=64&&Math.abs(t.position.y)<=64}async updatePosition(e,t){const i=this.getUserData(e),r=this.client.adapterRef.remoteStreamMap[e];if(r){const s=this.client.getSubStatus(r,"all");if(this.shouldSubscribe(e))if(s.subscribable)this.logger.log(`[remote#${e} status:${s.status}]界内，【即将订阅】: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doSubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界内，即将更新remoteStream位置: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}else if("subscribed"===s.status)this.logger.log(`[remote#${e} status:${s.status}]界外，【即将取消订阅】:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doUnsubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界外，即将更新remoteStream位置:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}}else this.logger.log(`updatePosition: 更新位置的stream: ${e} ( ${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y}init(){this.client.addListener("@stream-added",(e=>{const t=this.getUserData(e.stream.getId());e.stream.setSubscribeConfig(this.options.subConfig),this.updatePosition(e.stream.getId(),t.position)})),this.client.addListener("@stream-unsubscribed",(e=>{const t=this.getUserData(e.stream.getId());this.updatePosition(e.stream.getId(),t.position)})),this.client.addListener("@stream-subscribed",(async e=>{this.logger.log("Subscribed to",e.stream.streamID,e.mediaType);const t=this.getUserData(e.stream.getId());"audio"===e.mediaType&&(t.audioNodes&&(t.audioNodes.pannerNode.disconnect(),t.audioNodes.source.disconnect(),t.audioNodes.gainNode.disconnect()),t.audioNodes={source:this.context.createMediaStreamSource(e.stream.mediaHelper.audio.audioStream),gainNode:this.context.createGain(),pannerNode:new PannerNode(this.context,{panningModel:"HRTF",distanceModel:"linear",rolloffFactor:1,coneInnerAngle:360,positionX:t.position.x,positionY:t.position.y,positionZ:0,maxDistance:100})},t.audioNodes.source.connect(t.audioNodes.gainNode),t.audioNodes.gainNode.connect(t.audioNodes.pannerNode),t.audioNodes.pannerNode.connect(this.destination),this.fakeElem.srcObject=e.stream.mediaHelper.audio.audioStream,this.fakeElem.play().catch((e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",(()=>{this.fakeElem.play()})))})),this.logger.log("Connected",e.stream.getId,e.stream.mediaHelper.audio.audioStream.getAudioTracks()[0])),this.updatePosition(e.stream.getId(),t.position)}))}play(){this.elem.controls=!0,"suspended"===this.context.state&&r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(new Error("恢复AudioContext")),r.Device.once("user-gesture-fired",(()=>{this.context.resume()}))),this.elem.play().catch((e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",(()=>{this.elem.play()})))}))}}},function(module,exports,__webpack_require__){var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStream=void 0;const videoQuality_1=__webpack_require__(72),alerter_1=__webpack_require__(148),audioLevel_1=__webpack_require__(176),media_1=__webpack_require__(194),parameters_1=__webpack_require__(2),play_1=__webpack_require__(196),record_1=__webpack_require__(152),video_post_processing_1=__importDefault(__webpack_require__(308)),advanced_beauty_1=__importDefault(__webpack_require__(331)),basic_beauty_1=__importDefault(__webpack_require__(332)),virtual_background_1=__importDefault(__webpack_require__(333)),plugin_1=__webpack_require__(334),plugin_list_1=__webpack_require__(205),param_1=__webpack_require__(69),types_1=__webpack_require__(68),errorCode_1=__importDefault(__webpack_require__(12)),rtcError_1=__importDefault(__webpack_require__(13)),gum_1=__webpack_require__(75),param_2=__webpack_require__(69),applyResolution_1=__webpack_require__(335),env=__importStar(__webpack_require__(14)),RTCEventEmitter_1=__webpack_require__(73),utils_1=__webpack_require__(59),webAudio_1=__webpack_require__(67),StageAIProcessing_1=__webpack_require__(195),wasmDetect_1=__webpack_require__(336),audioProfile_1=__webpack_require__(337);let localStreamCnt=0;class LocalStream extends RTCEventEmitter_1.RTCEventEmitter{constructor(e){if(super(),this.safariVideoSizeChange=!1,this._advancedBeautyProcessor=null,this.videoPostProcessTags={isBeautyTrack:!1,isBodySegmentTrack:!1,isAdvBeautyTrack:!1},this.replaceTags={videoPost:!1,waterMark:!1,isMuted:!1},this.audioLevelHelper=null,this.audioLevelHelperSlave=null,this.__v_skip=parameters_1.getParameters().enableVSkip,this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.state="UNINIT",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.isRemote=!1,this.active=!0,this.destroyed=!1,this.canvasWatermarkOptions=null,this.encoderWatermarkOptions=null,this.supportWasm=!0,this.supportAIDenoise=!0,this.constraintSettings={audio:{},audioSlave:{},video:{},screen:{}},this.basicBeautyStaticRes=e=>{this.logger.log("config basic beauty static resources."),this.WebGLSupportError(),basic_beauty_1.default.configStaticRes(e)},this.advBeautyStaticRes=e=>{this.logger.log("config advanced beauty static resources."),this.WebGLSupportError(),advanced_beauty_1.default.configStaticRes(e)},this.setAdvBeautyEffect=(...e)=>{this.logger.log("set advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.setAdvEffect(...e))},this.presetAdvBeautyEffect=(...e)=>{this.logger.log("preset advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.presetAdvEffect(...e))},this.localStreamId=localStreamCnt++,this.logger=e.client.adapterRef.logger.getChild((()=>{var e;let t=this.localStreamId?"local"+this.localStreamId:"localStream";if(this.mediaHelper){let e="";this.mediaHelper.audio.micTrack&&(e+="m"),this.mediaHelper.video.cameraTrack&&(e+="c"),this.mediaHelper.screen.screenVideoTrack&&(e+="s"),this.mediaHelper.screenAudio.screenAudioTrack&&(e+="t"),e&&(t+=" "+e)}return"INITED"!==this.state&&(t+=" "+this.state),"INITED"===this.state&&this.client&&(null===(e=this.client.adapterRef.localStream)||void 0===e?void 0:e.localStreamId)!==this.localStreamId&&(t+=" DETACHED"),this.destroyed&&(t+=" DESTROYED"),t})),e.uid)if("string"==typeof e.uid){if(this.logger.log("createStream: uid是string类型"),e.client.adapterRef.channelInfo.uidType="string",!/^[1-9]\d*$/.test(e.uid))throw this.logger.log("join(): uid不是数字字符串格式"),new rtcError_1.default({code:errorCode_1.default.JOIN_UID_TYPE_ERROR,message:"createStream: uid不是数字字符串格式"})}else{if("number"!=typeof e.uid)throw this.logger.error("createStream: uid参数格式非法"),new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"createStream: uid参数格式非法"});if(this.logger.log("createStream: uid是number类型"),e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER)throw new rtcError_1.default({code:errorCode_1.default.STREAM_UID_ERROR,message:"Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数"})}else e.uid="local_"+this.localStreamId;this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,e.audioProcessing&&(this.constraintSettings.audio=Object.assign({},e.audioProcessing)),this.microphoneId=e.microphoneId||"",this.cameraId=e.cameraId||"",this.video=e.video||!1,this.screen=e.screen||!1,this.screenAudio=e.screenAudio||!1,this.sourceId=e.sourceId||"",this.facingMode=e.facingMode||"",this.client=e.client,this.audioSource=e.audioSource||null,this.videoSource=e.videoSource||null,this.screenAudioSource=e.screenAudioSource||null,this.screenVideoSource=e.screenVideoSource||null,this._segmentProcessor=null,this._cameraTrack=null,this._transformedTrack=null,this.mediaHelper=new media_1.MediaHelper({stream:this}),this._play=new play_1.Play({stream:this}),this._record=new record_1.Record({logger:this.logger,client:this.client}),this.client._params&&"live"===this.client._params.mode?this.audioProfile="music_standard":this.audioProfile="speech_low_quality","never"!==parameters_1.getParameters().enableAlerter&&alerter_1.alerter.watchLocalStream(this),this.logger.log("创建本地Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:e.audio,video:e.video})),this.client.apiFrequencyControl({name:"createLocalStream",code:0,param:{streamID:this.stringStreamID,videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,video:this.video,screen:this.screen,screenProfile:this.screenProfile}}),this.supportWasm=wasmDetect_1.webassemblySupported(),this.videoPostProcess=new video_post_processing_1.default(this.logger),this.basicBeauty=new basic_beauty_1.default(this.videoPostProcess),this.virtualBackground=new virtual_background_1.default(this.videoPostProcess),this.advancedBeauty=new advanced_beauty_1.default(this.videoPostProcess),env.IS_ANY_SAFARI&&this.videoPostProcess.on("safariVideoSizeChange",(()=>{this.safariVideoSizeChange=!0,this.loseContext()})),this.videoPostProcess.on("contextLost",(()=>{this.suspendVideoPostProcess(),this.safariVideoSizeChange?setTimeout((()=>{this.restoreContext()}),0):this.emit("video-post-context-lost")})),this.videoPostProcess.on("contextRestored",(e=>{this.resumeVideoPostProcess(),this.safariVideoSizeChange?this.safariVideoSizeChange=!1:(this.emit("video-post-context-restored",e),this.logger.log("webgl context restored, try to reinitialize webgl pipeline."))})),this.videoPostProcess.on("beautyResComplete",(e=>{this.emit("basic-beauty-res-complete",e)})),this.videoPostProcess.on("advBeautyResComplete",(e=>{this.emit("adv-beauty-res-complete",e)})),this.videoPostProcess.on("taskSwitch",(e=>{if(this.replaceTags.videoPost=e,this.replaceCanvas(),e&&env.IS_ANY_SAFARI){const e=parseFloat(env.SAFARI_VERSION||"0");e<15.4&&this.logger.warn("It is detected that you are using safari and the version is lower than 15.4. For a better experience, it is recommended to use version 15.4 and above."),15.3===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause memory leaks (Safari kernel bug: capturing video streams from WebGL will cause memory leaks)."),15===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause the page to crash (Safari kernel bug: WebGL rendering WebCam will cause the page to crash).")}})),env.IS_ANY_SAFARI&&env.SAFARI_MAJOR_VERSION<15&&document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.replaceTags.videoPost&&this.logger.warn("In the current version of Safari, the page with the video post-processing function is restored from the background, the sending frame rate will slowly return to the normal frame rate from a lower value.")})),this.mediaHelper.on("preProcessChange",(e=>{"video"===e.mediaType&&(this.replaceTags.waterMark=e.isOn,this.replaceCanvas())}))}getAdapterRef(){var e;return(null===(e=this.client.adapterRef.localStream)||void 0===e?void 0:e.localStreamId)===this.localStreamId?this.client.adapterRef:null}_reset(){this.streamID="",this.stringStreamID="",this.state="UNINIT",this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.audioProfile="speech_low_quality",this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.audio=!1,this.microphoneId="",this.video=!1,this.cameraId="",this.screen=!1,this.screenAudio=!1,this.sourceId="",this.facingMode="",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.renderMode={local:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._record&&this._record.destroy(),this._record=null,this.audioLevelHelper&&this.audioLevelHelper.destroy(),this.audioLevelHelper=null,this.audioLevelHelperSlave&&this.audioLevelHelperSlave.destroy(),this.audioLevelHelperSlave=null}get segmentProcessor(){return this._segmentProcessor}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}getAudioStream(){return this.mediaHelper?(this.client.apiFrequencyControl({name:"getAudioStream",code:0,param:JSON.stringify({streamID:this.getId()},null," ")}),this.mediaHelper.audio.audioStream):null}async init(){const e=await this.client.operationQueue.enqueue({caller:this,method:"init",options:null}),t=()=>{e();const t={audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio};(this.audio||this.screenAudio)&&(t.audioProfile=this.audioProfile,t.audioProcessing=this.constraintSettings.audio,t.audioSlaveProcessing=this.constraintSettings.audioSlave),this.video&&(t.videoProfile=this.mediaHelper.video.captureConfig.high,t.videoEncoder=this.mediaHelper.video.encoderConfig.high),this.screen&&(t.screenProfile=this.mediaHelper.screen.captureConfig.high,t.screenEncoder=this.mediaHelper.screen.encoderConfig.high),this.initVideoPostProcess(),this.client.apiFrequencyControl({name:"init",code:0,param:Object.assign({streamID:this.stringStreamID},t)}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};let i=null;this.state="INITING",this.logger.log("init() 初始化音视频流对象"),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.videoProfile&&(this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate);try{this.audio&&await this.mediaHelper.getStream({audio:this.audio,audioDeviceId:this.microphoneId,audioSource:this.audioSource})}catch(e){this.logger.log("init() 打开mic失败: "+e.message),i=e,this.audio=!1}try{this.video&&(await this.mediaHelper.getStream({video:this.video,videoSource:this.videoSource,videoDeviceId:this.cameraId,facingMode:this.facingMode}),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}catch(e){this.logger.log("init() 打开camera失败: "+e.message),i=e,this.video=!1}try{if(this.screen){const e={sourceId:this.sourceId,screen:this.screen,screenVideoSource:this.screenVideoSource,screenAudio:this.screenAudio,screenAudioSource:this.screenAudioSource};await this.mediaHelper.getStream(e),this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen")}}catch(e){this.logger.log("init() 打开screen失败: "+e.message),i=e,this.screen=this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0,this.screenAudio=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}if(this.audio||this.video||this.screen||this.screenAudio)this.state="INITED";else{if(i)throw this.state="UNINIT",this.logger.error("localStream.init失败:",i.name,i.message,i),t(),i;if(!parameters_1.getParameters().allowEmptyMedia)throw this.state="UNINIT",this.logger.warn("init() localStream不允许初始化时无任何音视频"),t(),new rtcError_1.default({code:errorCode_1.default.STREAM_PROFILE_ERROR,message:"init() localStream不允许初始化时无任何音视频"});this.logger.log("init() 当前模式下localStream允许初始化时无任何音视频"),this.state="INITED"}t()}initVideoPostProcess(){var e;null===(e=this.videoPostProcess)||void 0===e||e.init()}getAudioTrack(e="audio"){if(this.mediaHelper)return"audio"===e?this.mediaHelper.getAudioInputTracks()[0]:"audioSlave"===e?this.mediaHelper.getAudioSlaveInputTracks()[0]:null}getVideoTrack(e="video"){if(this.mediaHelper)return"video"===e?this.mediaHelper.video.cameraTrack||this.mediaHelper.video.videoSource:"screen"===e?this.mediaHelper.screen.screenVideoTrack||this.mediaHelper.screen.screenVideoSource:null}getScreenTrack(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0]||null}getAudioSlaveTrack(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0]||null}async play(e,t={}){if((t.video||t.screen)&&!e)throw this.logger.warn(`play() localStream ${this.getId()} 播放视频没有指定div标签`),new rtcError_1.default({code:errorCode_1.default.STREAM_PLAY_ARGUMENT_ERROR,message:"play() 播放视频没有指定div标签"});param_2.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!1),t.audio&&!t.audioType&&(t.audioType="mixing"),param_2.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),param_2.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`play() uid: ${this.stringStreamID}, playOptions: ${JSON.stringify(t)}`),t.audio&&this._play&&this.mediaHelper.getAudioInputTracks().length>0&&(this.logger.log(`play() uid ${this.stringStreamID} 开始播放本地音频: `,t.audioType),"voice"===t.audioType?this._play.playAudioStream("audio",this.mediaHelper.audio.micStream,t.muted):"music"===t.audioType?this._play.playAudioStream("audio",this.mediaHelper.audio.musicStream,t.muted):"mixing"===t.audioType&&this._play.playAudioStream("audio",this.mediaHelper.audio.audioStream,t.muted));let i=null;if("string"==typeof e?i=document.getElementById(e):e&&(i=e),i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 主流 本地`);try{await this._play.playVideoStream("video",this.mediaHelper.video.renderStream,i),"width"in this.renderMode.local.video&&this._play.setRender("video",this.renderMode.local.video)}catch(e){throw this.logger.log("play() 视频播放异常: ",e),e}await this.resumeVideoPostProcess()}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`play() uid ${this.stringStreamID} 开始启动视频播放 辅流 本地`);try{await this._play.playVideoStream("screen",this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.local.screen&&this._play.setRender("screen",this.renderMode.local.screen)}catch(e){throw this.logger.log("play() 屏幕共享播放异常: ",e),e}}}if(t.audio){const e={enable:!0};this.client.apiFrequencyControl({name:"enableEarback",code:0,param:JSON.stringify(e,null," ")})}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!1},null," ")})}async resume(){this._play&&(this.logger.log("resume() uid: ",this.stringStreamID),await this._play.resume()),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}setLocalRenderMode(e,t){if(!e||!param_1.isNumber(e.width)||!param_1.isNumber(e.height)||e.width<0||e.height<0)throw this.logger.warn("setLocalRenderMode() 参数宽高错误"),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,mediaType:t},e)}),new rtcError_1.default({code:errorCode_1.default.STREAM_RENDER_ARGUMENT_ERROR,message:"setLocalRenderMode() 参数宽高错误"});this.logger.log(`setLocalRenderMode() uid ${this.stringStreamID} 设置本地视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setRender("video",e),this.renderMode.local.video=e,this.replaceCanvas()),t&&"screen"!==t||(this.renderMode.local.screen=e,this._play&&this._play.setRender("screen",e)),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:0,param:Object.assign({streamID:this.stringStreamID,mediaType:t},e)})}stop(e){this.logger.log(`stop() uid ${this.stringStreamID} 停止播放 ${e||"音视频流"}`),this._play&&(types_1.MediaTypeList.forEach((t=>{e&&t!==e||this._play.stopPlayStream(t)})),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}))}isPlaying(e){if(this._play){if(types_1.MediaTypeList.indexOf(e)>-1)return this._play.isPlaying(e);throw this.logger.warn("isPlaying() unknown type"),new rtcError_1.default({code:errorCode_1.default.STREAM_ISPLAYING_ARGUMENT_ERROR,message:"isPlaying() type 参数类型非法"})}return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: false`),!1}canPlay(e){return-1===types_1.MediaTypeList.indexOf(e)?null:this._play.canPlay(e)}async open(e){var t,i,r,s;let{type:a,deviceId:n,sourceId:o,facingMode:d,screenAudio:c,audioSource:l,videoSource:u,screenAudioSource:h,screenVideoSource:p,enableMediaPub:m}=e,f="boolean"!=typeof m||!1!==m;const g=await this.client.operationQueue.enqueue({caller:this,method:"open",options:e}),v=t=>{g();const i=utils_1.makePrintable(Object.assign({},e,t.param),1);this.client.apiFrequencyControl({name:"open",code:t.code,param:Object.assign({streamID:this.stringStreamID},i)}),this.client.apiFrequencyControl({name:"_trackSettings",code:t.code,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};try{switch(this.getAdapterRef()||(this.logger.log("open(): 绑定 localStream ",a),this.client.bindLocalStream(this)),a){case"audio":if(this.logger.log("open(): 开启 "+(l?l.label:"mic设备")),this.mediaHelper.audio.micTrack||this.mediaHelper.audio.audioSource)return this.logger.warn("open(): 请先关闭麦克风"),v({code:-1,param:{reason:"重复打开麦克风",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_MIC_ERROR,message:"open() 重复打开麦克风"}));if(this.audio=!0,this.mediaHelper){const e={audio:!0,audioDeviceId:n,audioSource:l};await this.mediaHelper.getStream(e),this.audioLevelHelper&&this.mediaHelper.audio.audioStream&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),n&&(this.microphoneId=n),this.audioSource=l||null,"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):f&&(this.logger.log("Stream.open:开始发布",e),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.createProduce(this,"audio")))}break;case"screenAudio":if(!h)return void this.logger.warn("open(): 不允许单独开启屏幕共享音频功能。");if(this.logger.log("open(): 开启自定义屏幕共享音频 "+h.label),this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource)return this.logger.warn("请先关闭屏幕共享音频"),v({code:-1,param:{reason:"请先关闭屏幕共享音频",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复打开屏幕共享音频"}));if(this.screenAudio=!0,this.mediaHelper){const e={screenAudio:!0,screenAudioSource:h};await this.mediaHelper.getStream(e),this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):f&&(this.logger.log("Stream.open:开始发布",e),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.createProduce(this,"audioSlave")))}break;case"video":case"screen":if(this.logger.log(`开启${"video"===a?"camera":"screen"}设备`),this[a]){const e="video"===a;return this.logger.warn("open() 请先关闭"+(e?"摄像头":"屏幕共享")),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"open() 重复打开"+(e?"摄像头":"屏幕共享"),type:a},null," ")}),v({code:-1,param:{reason:"open() 重复打开"+(e?"摄像头":"屏幕共享"),type:a}}),Promise.reject(new rtcError_1.default({code:e?errorCode_1.default.REPEAT_OPEN_CAMERA_ERROR:errorCode_1.default.REPEAT_OPEN_SCREEN_ERROR,message:"open() 重复打开"+(e?"摄像头":"屏幕共享")}))}if(e.screenAudio&&(this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource))return this.logger.warn("open() 重复开启屏幕共享音频"),v({code:-1,param:{reason:"open() 重复开启屏幕共享音频",type:a}}),Promise.reject(new rtcError_1.default({code:errorCode_1.default.REPEAT_OPEN_AUDIO_SLAVE_ERROR,message:"open() 重复开启屏幕共享音频"}));this[a]=!0;const c={videoDeviceId:n,sourceId:o,videoSource:u,screenAudioSource:h,screenVideoSource:p,facingMode:d};c[a]=!0,"screen"===a&&e.screenAudio&&(c.screenAudio=!0,this.screenAudio=!0),await this.mediaHelper.getStream(c),this.videoSource=u||null,this.screenAudio&&this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"video"===a&&this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),"screen"===a&&this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen"),n&&"video"===a&&(this.cameraId=n),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中, 无需发布。",c):f&&(this.logger.log("Stream.open:开始发布",c),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.createProduce(this,a)),e.screenAudio&&await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.createProduce(this,"audioSlave")));break;default:throw this.logger.warn("open() 非法参数"),new rtcError_1.default({code:errorCode_1.default.STREAM_OPTN_NO_TYPE_ERROR,message:"open() type 参数类型非法"})}v({code:0,param:{type:a}})}catch(t){throw["audio","video","screen"].indexOf(a)>-1&&(this[a]=!1,"screen"===a&&e.screenAudio&&(this.screenAudio=!1)),this.logger.log(a+" 开启失败: ",t.name,t.message),v({code:-1,param:{type:a,reason:t.message}}),new rtcError_1.default({code:t.code||errorCode_1.default.MEDIA_DEVICE_ERROR,message:`${t.name} ${t.message}`})}}async switchScreenStream(e){var t;let i=null,r=!1,s=null,a="";"video"===(null===(t=e.screenVideoSource)||void 0===t?void 0:t.kind)?(i=e.screenVideoSource,r=!0):i=(await this.mediaHelper.getScreenSource({screen:this.screen})).getVideoTracks()[0],i?(s=await this.replaceTrack({mediaType:"screen",track:i,external:r}),s?(this.client.adapterRef.logger.log(`switchScreenStream: 已从 ${s.external?"自定义辅流":"屏幕共享"} 切换到 ${r?"自定义辅流":"屏幕共享"}`),s.external||s.oldTrack.stop()):(a="当前没有screen流",this.client.adapterRef.logger.error(`switchScreenStream: 无法切换到${r?"自定义辅流":"屏幕共享"}: ${a}`))):(a="无法获得新的screenVideoTrack",this.client.adapterRef.logger.error("switchScreenStream: ",a)),this.client.adapterRef.instance.apiEventReport("setFunction",{name:"switch_to_custom_screen",oper:"1",param:a||"success"}),this.client.apiFrequencyControl({name:"switchScreenStream",code:a?-1:0,param:JSON.stringify({external:r,reason:a},null," ")})}async close(e){var t,i,r,s;e||(e={type:"all"});const a=await this.client.operationQueue.enqueue({caller:this,method:"close",options:e});let n,o,d=e.type;switch(d){case"audio":if(this.logger.log("close() 关闭mic设备"),!this.audio){n=errorCode_1.default.STREAM_CLOSE_AUDIO_ERROR,o="close() 没有开启过麦克风";break}this.audio=!1,this.mediaHelper.stopStream("audio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("close() 关闭音频，保留发布：",d):(this.logger.log("close() 停止发布音频"),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.destroyProduce("audio"))):this.logger.log("close() 未发布音频，无需停止发布"),this.audioSource=null;break;case"screenAudio":if(this.logger.log("close() 关闭屏幕共享音频"),!this.screenAudio){n=errorCode_1.default.STREAM_CLOSE_AUDIO_SLAVE_ERROR,o="close() 没有开启过屏幕共享音频";break}this.screenAudio=!1,this.mediaHelper.stopStream("screenAudio"),this.getAdapterRef()?(this.logger.log("close() 停止发布音频辅流"),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.destroyProduce("audioSlave"))):this.logger.log("close() 未发布音频，无需停止发布");break;case"video":if(this.logger.log("close() 关闭camera设备"),!this.video){n=errorCode_1.default.STREAM_CLOSE_CAMERA_ERROR,o="close() 没有开启过摄像头";break}await this.suspendVideoPostProcess(),this._transformedTrack&&this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.video=!1,this.mediaHelper.stopStream("video"),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("video",!0),null==this||this._play.stopPlayStream("video"),this.getAdapterRef()?(this.logger.log("close() 停止发布视频"),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.destroyProduce("video"))):this.logger.log("close() 未发布视频，无需停止发布"),this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1),this.videoSource=null;break;case"screen":if(this.logger.log("close() 关闭屏幕共享"),!this.screen){n=errorCode_1.default.STREAM_CLOSE_SCREEN_ERROR,o="close() 没有开启过屏幕共享";break}this.screen=!1,this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("screen",!0),this.mediaHelper.stopStream("screen"),null==this||this._play.stopPlayStream("screen"),this.getAdapterRef()?(this.logger.log("Stream.close: 停止发布辅流"),await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.destroyProduce("screen"))):this.logger.log("Stream.close: 未发布辅流，无需停止发布");break;case"all":this.logger.log(`Stream.close:关闭所有设备: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`),this.audio&&await this.close({type:"audio"}),this.video&&await this.close({type:"video"}),this.screen&&await this.close({type:"screen"}),this.screenAudio&&await this.close({type:"screenAudio"}),this.logger.log(`Stream.close:关闭所有设备成功: audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`);break;default:n=errorCode_1.default.STREAM_CLOSE_ARGUMENT_ERROR,o="close() Unknown Type"}if(n)throw this.logger.error(o),this.client.apiFrequencyControl({name:"close",code:-1,param:JSON.stringify({reason:o,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,type:e.type},null," ")}),a(),new rtcError_1.default({code:n,message:o});return a(),void this.client.apiFrequencyControl({name:"close",code:0,param:JSON.stringify({reason:n,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio,type:e.type},null," ")})}async unmuteAudio(){var e,t;this.logger.log("unmuteAudio() 启用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach((e=>{e.enabled=!0})),this.mediaHelper.getAudioInputTracks().forEach((e=>{e.enabled=!0})),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=1),this.muteStatus.audio.send=!1,this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("unmuteAudio() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteAudio(){var e,t;this.logger.log("muteAudio() 禁用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach((e=>{e.enabled=!1})),this.mediaHelper.getAudioInputTracks().forEach((e=>{e.enabled=!1})),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=0),this.muteStatus.audio.send=!0,this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("muteAudio() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async unmuteAudioSlave(){var e;this.logger.log("unmuteAudioSlave() 启用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach((e=>{e.enabled=!0})),this.muteStatus.audioSlave.send=!1,this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("unmuteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudioSlave(){var e;this.logger.log("muteAudioSlave() 禁用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach((e=>{e.enabled=!1})),this.muteStatus.audioSlave.send=!0,this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("muteAudioSlave() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.getAudioInputTracks().length>0}hasAudioSlave(){return this.mediaHelper.getAudioSlaveInputTracks().length>0}getAudioLevel(e="audio"){var t,i;let r=0;if("audio"===e){if(!this.audioLevelHelper&&this.mediaHelper.audio.audioStream.getAudioTracks().length){const e=webAudio_1.getAudioContext();e&&e.audioWorklet&&e.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),this.audioLevelHelper=new audioLevel_1.AudioLevel({stream:this.mediaHelper.audio.audioStream,logger:this.logger})}r=(null===(t=this.audioLevelHelper)||void 0===t?void 0:t.getAudioLevel())||r}else!this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.audioLevelHelperSlave=new audioLevel_1.AudioLevel({stream:this.mediaHelper.screenAudio.screenAudioStream,logger:this.logger})),r=(null===(i=this.audioLevelHelperSlave)||void 0===i?void 0:i.getAudioLevel())||r;switch(parameters_1.getParameters().audioLevelFittingAlgorithm){case"classic":return r;case"linear":return Math.max(0,Math.min(100,Math.round(200*r)));case"log2":return Math.max(0,Math.min(100,Math.round(8.638*Math.log2(r)+97.244)))}}getAudioSlaveLevel(){return this.mediaHelper.getGain()}setAudioProfile(e){param_1.checkValidEnum({tag:"LocalStream.setAudioProfile",value:e,enums:audioProfile_1.AudioProfile}),this.logger.log("setAudioProfile() 设置音频属性: ",e),this.audioProfile=e,this.client.apiFrequencyControl({name:"setAudioProfile",code:0,param:{streamID:this.stringStreamID,profile:e}})}setAudioProcessing(e,t){param_1.checkValidEnum({tag:"LocalStream.setAudioProcessing",value:e,enums:types_1.MediaTypeList});const i=this.constraintSettings[e],r=Object.assign({},i,t);return this.constraintSettings[e]=r,this.logger.log(`setAudioProcessing ${e} ${JSON.stringify(i)} => ${JSON.stringify(r)}`),"audio"===e&&this.mediaHelper.getAudioInputTracks().length||"audioSlave"===e&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length?(this.logger.warn("setAudioProcessing：当前已有开启音频。3A开关设置仅在重启音频后生效"),this.client.apiFrequencyControl({name:"setAudioProcessing",code:-1,param:JSON.stringify(t)})):this.client.apiFrequencyControl({name:"setAudioProcessing",code:0,param:JSON.stringify(t)}),this.mediaHelper.getAudioConstraints(e)}setAudioVolume(e=100){var t;let i,r;(!Number.isInteger(e)||e<0||e>100)&&(i=errorCode_1.default.SET_AUDIO_VOLUME_ARGUMENTS_ERROR,r="setAudioVolume() volume 应该为 0 - 100 的整数");const s=e/100;if(this.logger.log(`setAudioVolume() 调节${this.stringStreamID}的音量大小: ${2.55*e} (normalized: ${s})`),this.audio?null===(t=this._play)||void 0===t||t.setPlayVolume("audio",s):(r="setAudioVolume() 没有音频流，请检查是否有发布过音频",i=errorCode_1.default.SET_AUDIO_VOLUME_ERROR),this.client.apiFrequencyControl({name:"setAudioVolume",code:i?-1:0,param:{streamID:this.stringStreamID,isRemote:!1,volume:2.55*e,normalizedVolume:s,reason:r}}),i)throw this.logger.error(r),new rtcError_1.default({code:i,message:r})}setCaptureVolume(e,t){let i,r;if(Number.isInteger(e)?(e<0||e>100)&&(i=errorCode_1.default.STREAM_SET_CAPTURE_VOLUME_ARGUMENT_ERROR,r="setCaptureVolume() volume 应该为 0 - 100 的整数"):(i=errorCode_1.default.SET_CAPTURE_VOLUME_ARGUMENTS_ERROR,r="setCaptureVolume() volume 应该为 0 - 100 的整数"),this.client.apiFrequencyControl({name:"setCaptureVolume",code:i?-1:0,param:JSON.stringify({streamID:this.stringStreamID,audioType:t,volume:e},null," ")}),i)throw this.logger.error(r),new rtcError_1.default({code:i,message:r});this.logger.log(`setCaptureVolume() 调节${this.stringStreamID}的音量大小: ${e}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setGain(e/100,t)}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout((()=>{t(e)}),0),this.logger.error("设置输出设备失败",e.name,e.message),new rtcError_1.default({code:errorCode_1.default.SET_AUDIO_OUTPUT_ERROR,message:e.message||"系统内部错误"})}t&&setTimeout(t,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!1},null," ")})}async switchDevice(e,t){var i,r,s,a;this.logger.log(`switchDevice() 切换媒体输入设备: ${e}, deviceId: ${t}`);let n,o,d={};if(this.inSwitchDevice[e]?(o="switchDevice() 正在切换中, 重复切换 "+e,n=errorCode_1.default.SWITCH_DEVICE_REPEAT_ERROR):this.inSwitchDevice[e]=!0,"audio"===e){const s=this.mediaHelper.audio.micTrack;let a;if(a="getSettings"in MediaStreamTrack.prototype?null==s?void 0:s.getSettings().deviceId:null===(r=null===(i=null==s?void 0:s.getConstraints())||void 0===i?void 0:i.deviceId)||void 0===r?void 0:r.exact,"live"===(null==s?void 0:s.readyState)&&a===t)return void this.logger.warn("switchDevice() 切换相同的麦克风设备，不处理");if(this.hasAudio()?this.audioSource&&(o="switchDevice() 自定义音频输入不支持，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_AUDIO):(o="switchDevice() 当前没有开启音频输入设备，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_MIC_ERROR),n)throw this.logger.error(o),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:o,type:e,deviceId:t,streamID:this.stringStreamID}}),new rtcError_1.default({code:n,message:o});this.mediaHelper.audio.micConstraint&&this.mediaHelper.audio.micConstraint.audio?this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}:this.mediaHelper.audio.micConstraint?(this.mediaHelper.audio.micConstraint.audio={},this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}):this.mediaHelper.audio.micConstraint={audio:{deviceId:{exact:t}}},d=this.mediaHelper.audio.micConstraint,this.microphoneId=t}else{if("video"!==e)return this.logger.error("switchDevice() type参数错误: "+e),Promise.reject(new rtcError_1.default({code:errorCode_1.default.SWITCH_DEVICE_REPEAT_ARGUMENTS_ERROR,message:"switchDevice() type参数错误: "+e}));{const i=this.mediaHelper.video.cameraTrack;let r;if(await this.suspendVideoPostProcess(),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),r="getSettings"in MediaStreamTrack.prototype?null==i?void 0:i.getSettings().deviceId:null===(a=null===(s=null==i?void 0:i.getConstraints())||void 0===s?void 0:s.deviceId)||void 0===a?void 0:a.exact,"live"===(null==i?void 0:i.readyState)&&r===t)return this.logger.log("switchDevice() 切换相同的摄像头设备，不处理"),void(this.inSwitchDevice[e]=!1);if(this.hasVideo()?this.videoSource&&(o="switchDevice() 自定义视频输入不支持切换",n=errorCode_1.default.SWITCH_DEVICE_NO_SUPPORT_VIDEO):(o="switchDevice() 当前没有开启视频输入设备，无法切换",n=errorCode_1.default.SWITCH_DEVICE_NO_CAMERA_ERROR),n)return this.logger.error(o),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:o,type:e,deviceId:t,streamID:this.stringStreamID}}),Promise.reject(new rtcError_1.default({code:n,message:o}));this.mediaHelper.video.cameraConstraint&&this.mediaHelper.video.cameraConstraint.video&&(this.mediaHelper.video.cameraConstraint.video.deviceId={exact:t},d=this.mediaHelper.video.cameraConstraint),this.cameraId=t,this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1)}}try{const i=this.mediaHelper.video.preProcessingEnabled;i&&this.mediaHelper.disablePreProcessing("video"),await this.mediaHelper.getSecondStream(d),this.inSwitchDevice[e]=!1,i&&this.mediaHelper.enablePreProcessing("video"),"video"===e&&await this.resumeVideoPostProcess(),"audio"===e&&this.audioLevelHelper&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),this.client.apiFrequencyControl({name:"switchDevice",code:0,param:{type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),this._play.resume()}catch(i){throw this.logger.error("switchDevice() 异常：",i.name,i.message,i),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:i.message,type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),new rtcError_1.default({code:i.code||errorCode_1.default.UNKNOWN_TYPE_ERROR,message:i.message||i.name})}}async unmuteVideo(){var e,t;this.logger.log(`unmuteVideo() 启用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!1),this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!0),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!0),env.IS_SAFARI){const e=null===(t=this._play)||void 0===t?void 0:t.video.containerDom;e&&(e.style.backgroundColor="")}this.muteStatus.video.send=!1,this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!1}catch(e){this.logger.error("unmuteVideo() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteVideo(){var e,t;this.logger.log(`muteVideo() 禁用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!0),env.IS_SAFARI){const t=null===(e=this._play)||void 0===e?void 0:e.video.dom;t&&(t.style.backgroundColor="black")}this.getAdapterRef()&&await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.muteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!1),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!1),this.muteStatus.video.send=!0,this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!0}catch(e){this.logger.error("muteVideo() 异常: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")}),this.replaceTags.isMuted=!1}}async unmuteScreen(){var e;this.logger.log(`unmuteScreen() 启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteScreen()),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!0),this.muteStatus.screen.send=!1,this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("unmuteScreen() 异常: ",e.name,e.message),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteScreen(){var e;this.logger.log(`muteScreen() 禁用 ${this.stringStreamID} 的辅流轨道`);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteScreen()),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!1),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.send=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("muteScreen() ",e.message),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}hasVideo(){return this.logger.log("hasVideo()"),this.mediaHelper.video.videoStream.getVideoTracks().length>0}async setVideoProfile(e){e.resolution>-1&&(this.videoProfile.resolution=e.resolution),e.frameRate>-1&&(this.videoProfile.frameRate=e.frameRate),this.mediaHelper.video.captureConfig.high=this.mediaHelper.convert(this.videoProfile),this.mediaHelper.video.encoderConfig.high.maxBitrate=this.getVideoBW(this.videoProfile)||this.mediaHelper.video.encoderConfig.high.maxBitrate,this.logger.log(`setVideoProfile() options: ${JSON.stringify(e)}, 视频采集参数: ${JSON.stringify(this.mediaHelper.video.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.video.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate;let t=this.mediaHelper.video.cameraTrack;if(this.videoPostProcess.hasAnyTask&&(this.logger.log("setVideoProfile() 侦测到美颜在开启状态"),t=this.videoPostProcess.sourceTrack),t)try{let e;this.logger.log(`setVideoProfile() 尝试动态修改分辨率【${t.label}】`),await applyResolution_1.applyResolution({track:t,targetWidth:this.mediaHelper.video.captureConfig.high.width,targetHeight:this.mediaHelper.video.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger}),e=t&&"getSettings"in MediaStreamTrack.prototype?t.getSettings():t.getConstraints(),e.width&&e.height&&(this.mediaHelper.video.cameraConstraint.video.width=e.width,this.mediaHelper.video.cameraConstraint.video.height=e.height)}catch(e){this.logger.error("setVideoProfile() 无法设置动态分辨率:",e.name,e.message)}const i=this.getSender("video","high");if(i){const t=i.getParameters(),r=t.encodings&&t.encodings[0];if((null==r?void 0:r.maxBitrate)!==this.mediaHelper.video.encoderConfig.high.maxBitrate){this.logger.log(`setVideoProfile() 调整上行码率 ${r.maxBitrate} => ${this.mediaHelper.video.encoderConfig.high.maxBitrate}`),r.maxBitrate=this.mediaHelper.video.encoderConfig.high.maxBitrate;try{i.setParameters(t)}catch(e){this.logger.warn("setVideoProfile() 无法调整上行码率: ",e.name,e.message)}}}this.client.apiFrequencyControl({name:"setVideoProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)}),this.replaceCanvas()}setVideoEncoderConfiguration(e){if(e.mediaType=e.mediaType||"video",e.streamType=e.streamType||"high",this.logger.log("setVideoEncoderConfiguration() 自定义视频编码配置: ",e),this.mediaHelper[e.mediaType].encoderConfig[e.streamType]){if(e.maxBitrate){const t=1e3*e.maxBitrate;this.logger.log(`setVideoEncoderConfiguration() 设置maxBitrate ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate} => ${t}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate=t}else this.logger.log("setVideoEncoderConfiguration:未设定maxBitrate。保留目前的值: ",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate);"string"==typeof e.contentHint?(this.logger.log(`setVideoEncoderConfiguration: 应用 contentHint ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint} => ${e.contentHint}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint=e.contentHint):this.logger.log("setVideoEncoderConfiguration: 未设定 contentHint。保留目前的值：",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint)}else this.logger.warn("setVideoEncoderConfiguration() 无法识别的媒体类型：",e.mediaType,e.streamType);this.getSender(e.mediaType,e.streamType)&&this.applyEncoderConfig(e.mediaType,e.streamType),this.client.apiFrequencyControl({name:"setVideoEncoderConfiguration",code:0,param:{streamID:this.stringStreamID,options:e}})}async replaceTrack(e){let t,i=!1,r=!1,s="video";if("screen"===e.mediaType)r=this.mediaHelper.screen.preProcessingEnabled,s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("screen"),this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint));else if("video"===e.mediaType){const r=this.mediaHelper.video.preProcessingEnabled;s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("video"),this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("replaceTrack() 应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}if(!t)return this.logger.error(`replaceTrack() ${e.mediaType} 当前没有可替换的流`),null;if(this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track),r)this.mediaHelper.enablePreProcessing(s);else{const t=this.getSender(e.mediaType,"high");t&&(t.replaceTrack(e.track),this.logger.log(`replaceTrack() ${e.mediaType} 成功替换上行`))}return this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}hasScreen(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0}setScreenProfile(e){e.frameRate>-1&&(this.screenProfile.frameRate=e.frameRate),e.resolution>-1&&(this.screenProfile.resolution=e.resolution),this.mediaHelper.screen.captureConfig.high=this.mediaHelper.convert(this.screenProfile),this.mediaHelper.screen.encoderConfig.high.maxBitrate=this.getVideoBW(this.screenProfile),this.logger.log(`setScreenProfile() profile: ${JSON.stringify(e)}, 屏幕共享采集参数: ${JSON.stringify(this.mediaHelper.screen.captureConfig.high)}, 编码参数: ${JSON.stringify(this.mediaHelper.screen.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.screenQuality=e,this.mediaHelper.screen.screenVideoTrack&&applyResolution_1.applyResolution({track:this.mediaHelper.screen.screenVideoTrack,targetWidth:this.mediaHelper.screen.captureConfig.high.width,targetHeight:this.mediaHelper.screen.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const t=this.getSender("screen","high");if(t){const i=t.getParameters(),r=i.encodings&&i.encodings[0];if((null==r?void 0:r.maxBitrate)!==this.mediaHelper.screen.encoderConfig.high.maxBitrate){this.logger.log(`setScreenProfile() 调整上行码率 ${r.maxBitrate} => ${this.mediaHelper.screen.encoderConfig.high.maxBitrate}`),r.maxBitrate=this.mediaHelper.screen.encoderConfig.high.maxBitrate;try{t.setParameters(i)}catch(e){this.logger.error("setScreenProfile() 无法调整上行码率",e.name,e.message)}}}this.client.apiFrequencyControl({name:"setScreenProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)})}getSender(e,t){var i,r,s;const a=null===(s=null===(r=null===(i=this.getAdapterRef())||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._sendTransport)||void 0===s?void 0:s.handler._pc;let n=null;return a&&("audio"===e&&(n="high"===t?a.audioSender:null),"video"===e?n="high"===t?a.videoSender:a.videoSenderLow:"screen"===e?n="high"===t?a.screenSender:a.screenSenderLow:"audioSlave"===e&&(n=a.audioSlaveSender)),n||null}applyEncoderConfig(e,t){let i=this.mediaHelper[e].encoderConfig[t].maxBitrate;if(!i)return;let r=this.getSender(e,t);if(!r)return void this.logger.error("localStream.applyEncoderConfig: cannot find sender for ",e,t);let s=this.mediaHelper[e].encoderConfig[t].contentHint;"string"==typeof s&&r.track&&r.track.contentHint!==s&&(this.logger.log(`applyEncoderConfig 应用 contentHint：${e} ${t} ${r.track.contentHint} => ${s}`),r.track.contentHint=s);const a=r.getParameters();let n;a.encodings&&a.encodings.length?(n=a.encodings[0].maxBitrate,a.encodings[0].maxBitrate=i):a.encodings=[{maxBitrate:i}],r.setParameters(a).then((()=>{this.logger.log(`最大编码码率：${e} ${t} ${n?n+"=>":""}${i}`)})).catch((r=>{this.logger.error(`应用最大编码码率失败：${e} ${t} ${i}`,a,r.name,r.message)}))}getVideoBW(e){return e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?14e4:22e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?5e5:75e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?113e4:171e4:e.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?e.frameRate<=videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15?208e4:315e4:(this.logger.warn("发现不支持的 NERTC_VIDEO_QUALITY "+e.resolution),8e5)}async takeSnapshot(e){var t,i,r,s;let a,n;const o=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(o||d?(this.logger.log("takeSnapshot() options: "+JSON.stringify(e)),await this._play.takeSnapshot(e,"download",this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)})):(n="takeSnapshot(): 没有视频流, 请检查视频是否正在播放",a=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR),a)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:n}),null," ")}),new rtcError_1.default({code:a,message:n})}takeSnapshotBase64(e){var t,i,r,s;let a,n;const o=this.video&&(null===(i=null===(t=this._play)||void 0===t?void 0:t.video)||void 0===i?void 0:i.dom),d=this.screen&&(null===(s=null===(r=this.Play)||void 0===r?void 0:r.screen)||void 0===s?void 0:s.dom);if(o||d){let t=this._play.takeSnapshot(e,"base64");return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)}),t}if(n="takeSnapshotBase64(): 没有视频流, 请检查视频是否正在播放",a=errorCode_1.default.STREAM_TAKE_SNAPSHOT_ERROR,a)throw this.logger.error(n),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:n}),null," ")}),new rtcError_1.default({code:a,message:n})}getCurrentFrameData(e={mediaType:"video"}){return this._play.getCurrentFrameData(e)}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":if(t.push(this.mediaHelper.audio.audioStream),this.client.adapterRef.remoteStreamMap)for(var i in this.client.adapterRef.remoteStreamMap){const e=this.client.adapterRef.remoteStreamMap[i];t.push(e.mediaHelper.audio.audioStream)}}if(0!==t.length){if(!this._record||!this.streamID||!t)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_ERROR,message:"localStream_startMediaRecording: 开始录制时参数异常"});return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("未发现要录制的媒体流")}stopMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.stopMediaRecording: 录制未开始"});return this._record.stop({})}playMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.playMediaRecording: 录制未开始"});return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.listMediaRecording: 录制未开始"});const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.cleanMediaRecording: 录制未开始"});return this._record.clean()}downloadMediaRecording(e){if(!this._record||!this._record.recoder)throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:"localStream.downloadMediaRecording: 录制未开始"});return this._record.download()}startAudioMixing(e){return this.logger.log("startAudioMixing() 开始伴音"),this.mediaHelper.startAudioMixing(e)}stopAudioMixing(){return this.logger.log("stopAudioMixing() 停止伴音"),this.mediaHelper.stopAudioMixing()}pauseAudioMixing(){return this.logger.log("pauseAudioMixing() 暂停伴音"),this.mediaHelper.pauseAudioMixing()}resumeAudioMixing(){return this.logger.log("resumeAudioMixing() 恢复伴音"),this.mediaHelper.resumeAudioMixing()}adjustAudioMixingVolume(e){return this.logger.log("adjustAudioMixingVolume() 调节伴音音量: ",e),this.mediaHelper.setAudioMixingVolume(e)}getAudioMixingDuration(){return this.logger.log("getAudioMixingDuration() 获取伴音总时长"),this.mediaHelper.getAudioMixingTotalTime()}getAudioMixingCurrentPosition(){return this.mediaHelper.getAudioMixingPlayedTime()}setAudioMixingPosition(e){return this.logger.log("setAudioMixingPosition() 设置伴音音频文件的播放位置: ",e),this.mediaHelper.setAudioMixingPlayTime(e)}async playEffect(e){return this.logger.log("playEffect() 开始播放音效: ",JSON.stringify(e,null," ")),this.mediaHelper.playEffect(e)}async stopEffect(e){return this.logger.log("stopEffect() 停止播放音效: ",e),this.mediaHelper.stopEffect(e)}async pauseEffect(e){return this.logger.log("pauseEffect() 暂停播放音效：",e),this.mediaHelper.pauseEffect(e)}async resumeEffect(e){return this.logger.log("resumeEffect() 恢复播放音效文件: ",e),this.mediaHelper.resumeEffect(e)}async setVolumeOfEffect(e,t){return this.logger.log(`setVolumeOfEffect() 调节 ${e} 音效文件音量为: ${t}`),this.mediaHelper.setVolumeOfEffect(e,t)}async preloadEffect(e,t){return this.logger.log(`preloadEffect() 预加载 ${e} 音效文件地址: ${t}`),this.mediaHelper.preloadEffect(e,t)}async unloadEffect(e){return this.logger.log("unloadEffect() 释放指定音效文件 "+e),this.mediaHelper.unloadEffect(e)}getEffectsVolume(){return this.logger.log("getEffectsVolume() 获取所有音效文件播放音量"),this.mediaHelper.getEffectsVolume()}setEffectsVolume(e){return this.logger.log("setEffectsVolume() 设置所有音效文件播放音量:",e),this.mediaHelper.setEffectsVolume(e)}async stopAllEffects(){return this.logger.log("stopAllEffects() 停止播放所有音效文件"),this.mediaHelper.stopAllEffects()}async pauseAllEffects(){return this.logger.log("pauseAllEffects() 暂停播放所有音效文件"),this.mediaHelper.pauseAllEffects()}async resumeAllEffects(){return this.logger.log("resumeAllEffects() 恢复播放所有音效文件"),this.mediaHelper.resumeAllEffects()}getAudioEffectsDuration(e){return this.logger.log("getAudioEffectsDuration() 获取音效总时长"),this.mediaHelper.getAudioEffectsTotalTime(e)}getAudioEffectsCurrentPosition(e){return this.mediaHelper.getAudioEffectsPlayedTime(e)}setCanvasWatermarkConfigs(e){if(this._play){let t="screen"===e.mediaType?this._play.screen.canvasWatermark:this._play.video.canvasWatermark;if(!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});t.checkWatermarkParams(e),t.updateWatermarks(e),this.canvasWatermarkOptions=e,this.client.apiFrequencyControl({name:"setLocalCanvasWatermarkConfigs",code:0,param:{streamID:this.stringStreamID,isRemote:!1,mediaType:e.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs: 播放器未初始化")}setEncoderWatermarkConfigs(e){var t,i;if(this._play&&this._play){const r=e.mediaType||"video",s=this._play[r].encoderWatermark;if(!s)return void this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化",e.mediaType);(null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||e.timestampWatermarks||(null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)?(s.handler.enabled=!0,this.mediaHelper[r].preProcessingEnabled||this.mediaHelper.enablePreProcessing(r)):(s.handler.enabled=!1,this.mediaHelper.canDisablePreProcessing(r)&&this.mediaHelper.disablePreProcessing(r));const a={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>a.TEXT)throw this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${a.TEXT}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 10 个文字水印"});if(e.imageWatermarks&&e.imageWatermarks.length>a.IMAGE)throw this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${a.IMAGE}`),new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:"最多可以设置 4 个图片水印"});s.checkWatermarkParams(e),s.updateWatermarks(e),this.encoderWatermarkOptions=e,this.client.apiFrequencyControl({name:"setEncoderWatermarkConfigs",code:0,param:JSON.stringify(e,null,2)})}else this.logger.error("setEncoderWatermarkConfigs: 播放器未初始化")}getMuteStatus(e){if(types_1.MediaTypeList.indexOf(e)>-1)return{muted:this.muteStatus[e].send};throw new Error("getMuteStatus Invalid Media "+e)}WebGLSupportError(){if(0===this.videoPostProcess.availableCode)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:"当前环境不支持 WebGL"})}setBeautyEffectOptions(e){if(this.logger.log("set basic beauty parameters:",e),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");for(const t in e)try{e[t]=Math.min(Math.max(parseFloat(e[t]+""),0),1)}catch(i){e[t]=0,this.logger.error("setBeautyEffectOptions:"+i.message)}this.lastEffects=Object.assign(Object.assign({},this.lastEffects),e),this.basicBeauty.setBeautyOptions(e)}}async setBeautyEffect(e,t=!1){if(this.logger.log((e?"start":"close")+" basic beauty."),this.WebGLSupportError(),e&&this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);const i=this.basicBeauty;if(!t){if(e&&i.isEnable)return this.logger.warn("basic beauty is already opened");if(!e&&!i.isEnable)return this.logger.warn("basic beauty is already closed")}if(this.videoPostProcessTags.isBeautyTrack=e,this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let r=0;try{this._transformedTrack=await i.setBeauty(e,this._cameraTrack),await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(e){r=-1,this.logger.error("setBeautyEffect:"+e.message)}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),e&&0===r){let e;e=this.lastEffects?this.lastEffects:{brightnessLevel:0,rednessLevel:0,smoothnessLevel:0},i.setBeautyOptions(e)}t||this.client.apiFrequencyControl({name:"setBeautyEffect",code:r,param:{streamID:this.stringStreamID,isRemote:!1,isEnable:e}})}else this.logger.log("setBeautyEffect:video track not ready.")}setFilter(e,t){if(this.logger.log("set beauty filter parameters:"+JSON.stringify([e,t])),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");try{void 0!==t&&(t=Math.min(Math.max(parseFloat(t+""),0),1))}catch(e){t=void 0,this.logger.error("setFilter:"+e.message)}this.lastFilter=e,this.basicBeauty.setFilter(e,t)}}async enableBodySegment(){if(this.logger.log("start virtual background."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);if(!this.videoPostProcess.getPlugin("VirtualBackground"))throw this.logger.error("virtual background plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"virtual background plugin is not register"});if(this._segmentProcessor)return this.logger.warn("virtual background is already opened.");this._segmentProcessor=this.virtualBackground,this._segmentProcessor.init(),this._segmentProcessor.once("segment-load",(async()=>{var e;let t=0;try{await this._startBodySegment()}catch(i){null===(e=this._segmentProcessor)||void 0===e||e.destroy(),this._segmentProcessor=null,t=-1,this.logger.error("enableBodySegment:"+i.message)}this.client.apiFrequencyControl({name:"enableBodySegment",code:t,param:{streamID:this.stringStreamID}})})),env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when background-segmentation is enabled.")}async disableBodySegment(){if(this.logger.log("close virtual background."),this.WebGLSupportError(),this._segmentProcessor){let e=0;try{await this._cancelBodySegment(),this._segmentProcessor.destroy(),this._segmentProcessor=null}catch(t){e=-1,this.logger.error("disableBodySegment:"+t.message)}this.client.apiFrequencyControl({name:"disableBodySegment",code:e,param:{streamID:this.stringStreamID}})}else this.logger.warn("virtual background is already closed.")}async _startBodySegment(){this.videoPostProcess.availableCode<2||this._segmentProcessor&&(await this.transformTrack(!0,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!0)}async _cancelBodySegment(){this.videoPostProcess.availableCode<1||this._segmentProcessor&&(await this.transformTrack(!1,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!1)}setBackground(e){this.logger.log("set virtual background parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.virtualBackground.isEnable||this.logger.warn("virtual background is not opened."),this.virtualBackground.setVirtualBackGround(e))}setBackGround(e){this.setBackground(e)}async enableAdvancedBeauty(e){if(this.logger.log("start advanced beauty."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);if(!this.videoPostProcess.getPlugin("AdvancedBeauty"))throw this.logger.error("advanced beauty plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"advanced beauty plugin is not register"});if(this._advancedBeautyProcessor)return this.logger.warn("advanced beauty is already opened.");this._advancedBeautyProcessor=this.advancedBeauty,this._advancedBeautyProcessor.init(e),this._advancedBeautyProcessor.once("facePoints-load",(async()=>{var e;let t=0;try{await this._startAdvancedBeauty()}catch(i){null===(e=this._advancedBeautyProcessor)||void 0===e||e.destroy(),this._advancedBeautyProcessor=null,t=-1,this.logger.error("enableAdvancedBeauty:"+i.message)}this.client.apiFrequencyControl({name:"enableAdvancedBeauty",code:t,param:{streamID:this.stringStreamID}})})),env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when advanced-beauty is enabled.")}async disableAdvancedBeauty(){if(this.logger.log("close advanced beauty."),this.WebGLSupportError(),this._advancedBeautyProcessor){let e=0;try{await this._cancelAdvancedBeauty(),this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null}catch(t){e=-1,this.logger.error("disableAdvancedBeauty:"+t.message)}this.client.apiFrequencyControl({name:"disableAdvancedBeauty",code:e,param:{streamID:this.stringStreamID}})}else this.logger.warn("advanced beauty is already closed.")}async _startAdvancedBeauty(){this.videoPostProcess.availableCode<2||this._advancedBeautyProcessor&&(await this.transformTrack(!0,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async _cancelAdvancedBeauty(){this.videoPostProcess.availableCode<1||this._advancedBeautyProcessor&&(await this.transformTrack(!1,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!1)}async enableAIDenoise(){if(!this.supportAIDenoise)return this.logger.warn("Unsupport ai denoise. Please check your plugin version"),!1;let e;if(this.logger.log("start ai denoise."),this.mediaHelper.audio.stageAIProcessing){if(e=this.mediaHelper.audio.stageAIProcessing,e.enabled&&"INITED"===e.state)return this.logger.warn("ai denoise is already opened."),!0}else{const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e}if(!e.hasPlugin("AIDenoise"))throw this.logger.error("AIDenoise plugin is not register."),new rtcError_1.default({code:errorCode_1.default.PLUGIN_NOT_REGISTER,message:"AIDenoise plugin is not register"});return e.enabled=!0,"UNINIT"===e.state&&await e.init(),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio(),this.client.apiFrequencyControl({name:"enableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!0}async disableAIDenoise(){this.logger.log("close ai denoise.");const e=this.mediaHelper.audio.stageAIProcessing;return e?e.enabled?(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),this.client.apiFrequencyControl({name:"disableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!1):(this.logger.warn("ai denoise is already closed."),!0):(this.logger.warn("disableAIDenoise: ai denoise is not created"),!0)}async replacePluginTrack(e){if(this.videoPostProcess.availableCode<1)return;let t,i=!1;if("screen"===e.mediaType?(this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint))):"video"===e.mediaType&&(this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint))),!t)return this.logger.error(`replaceTrack ${e.mediaType} 当前没有可替换的流`),null;this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track);const r=this.getSender(e.mediaType,"high");return r&&(r.replaceTrack(e.track),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行`)),this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}async transformTrack(e,t){if(!(this.videoPostProcess.availableCode<1)&&t)if(this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let i=null;try{this._transformedTrack=await t.setTrack(e,this._cameraTrack),this._transformedTrack&&await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(e){i=e}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),i)throw i}else this.logger.log("transformTrack:video track not ready.")}async registerPlugin(options){if(this.logger.log("register plugin:"+options.key),!this.supportWasm)throw this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:"unsupportWasm"}}),new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:`该浏览器不支持WebAssembly，注册 ${options.key} 失败。`});if(this.videoPostProcess.getPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`);const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing&&stageAIProcessing.hasPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),!1;let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:"unsupport plugin "+options.key});plugin.once("plugin-load",(()=>{if(this.logger.log(`plugin ${options.key} loaded`),-1!==plugin_list_1.videoPlugins.indexOf(options.key))this.WebGLSupportError(),this.videoPostProcess.registerPlugin(options.key,plugin);else{if(-1===plugin_list_1.audioPlugins.indexOf(options.key))throw new Error("unsupport plugin "+options.key);if("AIDenoise"===options.key){let e;if(this.mediaHelper.audio.stageAIProcessing)e=this.mediaHelper.audio.stageAIProcessing;else{const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e}e.registerPlugin(options.key,plugin,options.wasmUrl)}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}})})),plugin.once("plugin-load-error",(()=>{this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`load ${options.wasmUrl} error.`}})})),plugin.once("error",(e=>{"AIDenoise"==options.key&&(this.supportAIDenoise=!1),this.unregisterPlugin(options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:`插件 ${options.key} 内部错误：${e}。`}})}))}catch(e){throw this.emit("plugin-load-error",{key:options.key,msg:e}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key,msg:e}}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:e.message})}}async unregisterPlugin(e){if(this.logger.log("unRegister plugin:"+e),-1===plugin_list_1.audioPlugins.indexOf(e))this.WebGLSupportError(),this.videoPostProcess&&("VirtualBackground"===e&&this._segmentProcessor?await this.disableBodySegment():"AdvancedBeauty"===e&&this._advancedBeautyProcessor&&await this.disableAdvancedBeauty(),this.videoPostProcess.unregisterPlugin(e));else if("AIDenoise"===e){const e=this.mediaHelper.audio.stageAIProcessing;e&&(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),e.unregisterAIDenoise(),this.mediaHelper.audio.stageAIProcessing=null)}}async suspendVideoPostProcess(){if(this.videoPostProcess.availableCode<1)return;const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!1,!0),this.videoPostProcessTags.isBeautyTrack=!0),t&&(await this._cancelBodySegment(),this.videoPostProcessTags.isBodySegmentTrack=!0),i&&(await this._cancelAdvancedBeauty(),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async resumeVideoPostProcess(){if(!(this.videoPostProcess.availableCode<1))try{const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!0,!0),this.lastEffects&&this.setBeautyEffectOptions(this.lastEffects),this.lastFilter&&this.setFilter(this.lastFilter)),t&&await this._startBodySegment(),i&&await this._startAdvancedBeauty()}catch(e){this.logger.log("开启失败: "+e)}}async replaceCanvas(){var e;if(this.videoPostProcess.availableCode<1)return;if(!this._play)return;if(!env.IS_ANY_SAFARI)return;if(env.SAFARI_VERSION&&parseFloat(env.SAFARI_VERSION)>15.2)return;const t=this._play.video.dom,i=this._play.video.containerDom;if(t&&i){const r=this.videoPostProcess.filters,s=this.videoPostProcess.video,a=this.replaceTags.videoPost,n=this.replaceTags.waterMark;if(a){const e=r.canvas;if(e.style.height="0px",e.style.width="0px",document.body.appendChild(e),env.SAFARI_MAJOR_VERSION<14&&s&&(s.style.height="0px",s.style.width="0px",document.body.appendChild(s)),n||r.canvas.parentElement===i)n&&(t.style.display="");else{const e=r.canvas;t.style.display="none",e.style.position="absolute";const s=i.getBoundingClientRect(),a=s.width/s.height,n=e.width/e.height,{width:o,height:d,cut:c}=this.renderMode.local.video;if(c)if(o/d>n){e.style.width="100%",e.style.left="0px";const t=s.width/n/s.height;e.style.height=100*t+"%",e.style.top=50*-(t-1)+"%"}else{e.style.height="100%",e.style.top="0px";const t=s.height*n/s.width;e.style.width=100*t+"%",e.style.left=50*-(t-1)+"%"}else if(a>n){e.style.height="100%",e.style.top="0px";const t=s.height*n/s.width;e.style.width=100*t+"%",e.style.left=50*(1-t)+"%"}else{e.style.width="100%",e.style.left="0px";const t=s.width/n/s.height;e.style.height=100*t+"%",e.style.top=50*(1-t)+"%"}i.appendChild(r.canvas)}}else t.style.display="",null===(e=r.canvas.parentNode)||void 0===e||e.removeChild(r.canvas)}}loseContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.loseContext()}catch(e){}}restoreContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.restoreContext()}catch(e){}}getNativeDom(e){const t=this[e],i=this._play[e].dom;return t&&i||this.logger.warn("No local "+e),i}delay(e){return new Promise((t=>setTimeout(t,e)))}async destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!1}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),env.ANY_CHROME_MAJOR_VERSION&&env.ANY_CHROME_MAJOR_VERSION<62&&await this.delay(100),this._reset(),this.destroyed=!0,this.lastEffects=null,this.lastFilter=null,this._segmentProcessor&&(this._segmentProcessor.destroy(),this._segmentProcessor=null),this._advancedBeautyProcessor&&(this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null),this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.videoPostProcess.destroy())}}exports.LocalStream=LocalStream},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(11),d=a(i(14)),c=n(i(309)),l=i(310);class u extends o.EventEmitter{constructor(e){super(),this.pluginModules={VirtualBackground:null,AdvancedBeauty:null},this.isAlive=!0,this.filters=null,this.video=null,this.frameRate=15,this.timerId=-1,this.taskSet=new Set,this.taskSnapshot=new Set,this.readyTaskSet=new Set(["BasicBeauty"]),this.sourceMap=null,this.maskData=null,this.advBeautyData=[],this.sourceTrack=null,this.trackInstance=null,this.videoSizeTag="",this.frameCount=[0,0],this.update=(e=!0)=>{if(this.availableCode<2)return;if(d.IS_ANY_SAFARI&&"hidden"===document.visibilityState)return;const t=this.filters;if(!this.taskSet.size)return t?t.update(!1):c.default.clearTimeout(this.timerId);if(e&&(this.frameCount[0]+=1),this.taskReady){let e=!1,i=!1;if(this.taskSet.has("VirtualBackground")&&(t.virtualBackground.setMaskMap(this.maskData),this.maskData=null,e=!0,i=!0),this.taskSet.has("AdvancedBeauty")?(t.advBeauty.setAdvData(this.advBeautyData),this.advBeautyData=[],e=!0):i=!1,this.taskSnapshot=new Set(this.taskSet),this.readyTaskSet.clear(),this.readyTaskSet.add("BasicBeauty"),this.frameCount[1]=this.frameCount[0],e?(t.update(!1),this.sourceMap=t.normal.getImageData(t.srcMap)):t.update(!0),this.taskSet.has("VirtualBackground")){const e=this.pluginModules.VirtualBackground;if(e){const{width:r,height:s}=t.canvas;r>16&&s>16?e.process(i?this.sourceMap.slice():this.sourceMap,r,s,(e=>{const t=(e.data||e).length;this.maskData=this.taskSet.has("VirtualBackground")&&t>0?e:null,this.readyTaskSet.add("VirtualBackground"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))}),d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104):this.readyTaskSet.add("VirtualBackground")}}if(this.taskSet.has("AdvancedBeauty")){const e=this.pluginModules.AdvancedBeauty;if(e){const{width:i,height:r}=t.canvas;e.process(this.sourceMap,i,r,(e=>{this.advBeautyData=this.taskSet.has("AdvancedBeauty")?e:[],this.readyTaskSet.add("AdvancedBeauty"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))}),d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104)}}}},this.setTaskAndTrack=(e,t,i)=>new Promise(((r,s)=>{if(this.availableCode<1)return s(this.glErrorTip);if(t){if(this.hasTask(e))return r(this.track);this.createTrack(i).then((t=>{this.addTask(e),setTimeout((()=>{r(this.track)}),t)})).catch((e=>{s(e)}))}else{if(!this.hasTask(e))return r(this.track);this.removeTask(e),r(this.track)}})),this.logger=e}registerPlugin(e,t){this.pluginModules[e]=t}getPlugin(e){return this.pluginModules[e]}unregisterPlugin(e){this.pluginModules[e]=null}init(){try{this.filters=new l.Filters;const e=this.filters.canvas;e.addEventListener("webglcontextlost",(e=>{e.preventDefault(),this.emit("contextLost")}),!1),e.addEventListener("webglcontextrestored",(e=>{var t;e.preventDefault();let i=!0;this.filters=(null===(t=this.filters)||void 0===t?void 0:t.clone())||null,this.filters||(i=!1),this.emit("contextRestored",i)}),!1)}catch(e){}}get availableCode(){return this.isAlive?this.filters&&this.filters.gl?this.filters.gl.isContextLost()?1:2:0:-1}get glErrorTip(){switch(this.availableCode){case-1:return"localStream is already destroyed.";case 0:return"the current environment does not support webgl.";case 1:return"webgl context has been lost."}return""}get taskReady(){for(const e of this.taskSnapshot)if(!this.readyTaskSet.has(e))return!1;return!0}addTask(e){this.taskSet.has(e)||(this.taskSet.add(e),this.logger.log(`task ${e} is added.`),this.update(),1===this.taskSet.size&&(this.updateTimer(),this.emit("taskSwitch",!0)))}removeTask(e){var t;this.taskSet.delete(e),this.logger.log(`task ${e} is removed.`),0===this.taskSet.size&&(c.default.clearTimeout(this.timerId),this.timerId=-1,this.sourceMap=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.emit("taskSwitch",!1)),this.update(),this.taskSnapshot.delete(e)}hasTask(e){return this.taskSet.has(e)}get hasAnyTask(){return this.taskSet.size>0}videoSizeChange(e,t){if(d.IS_ANY_SAFARI&&this.filters){const i=`${e}-${t}`;this.videoSizeTag!==i&&(this.videoSizeTag=i,this.emit("safariVideoSizeChange"))}}createTrack(e){return new Promise(((t,i)=>{var r,s;if(this.trackInstance&&this.trackInstance===e)return this.logger.log("VideoPostProcess track transform unnecessary"),t(0);this.logger.log("VideoPostProcess track transform");const a=e.getSettings();this.frameRate=a.frameRate||15,this.frameRate>30&&(this.logger.warn("In chrome, webgl drawing video which framerate greater than 30fps may cause memory leak."),this.frameRate=30),this.sourceTrack=e,this.trackInstance&&(this.trackInstance.stop(),this.trackInstance=null),a.width&&a.height&&(null===(r=this.filters)||void 0===r||r.setSize(a.width,a.height),this.videoSizeTag||(this.videoSizeTag=`${a.width}-${a.height}`));const n=(null===(s=this.filters)||void 0===s?void 0:s.canvas).captureStream(this.frameRate);this.trackInstance=n.getVideoTracks()[0],this.video=this.video||document.createElement("video");const o=new MediaStream([this.sourceTrack]);this.video.srcObject=o;const d=e=>{var t;const{videoWidth:i,videoHeight:r}=e;null===(t=this.filters)||void 0===t||t.setSize(i,r),this.videoSizeChange(i,r)};this.video.onloadedmetadata=()=>{this.video.play().then((()=>{this.filters.mapSource=this.video,d(this.video),t(0)})).catch((e=>{i(e)}))},this.video.onresize=()=>{d(this.video)}}))}get track(){return this.taskSet.size?(this.logger.log("return video post procss track."),this.trackInstance):(this.logger.log("return origin track."),this.sourceTrack)}updateTimer(){c.default.clearTimeout(this.timerId),this.timerId=c.default.setTimeout((()=>{this.updateTimer(),this.update()}),1e3/(1.1*this.frameRate),null)}destroy(){var e,t,i;this.isAlive=!1,c.default.clearTimeout(this.timerId),this.removeAllListeners(),this.taskSet.clear(),this.readyTaskSet.clear(),this.taskSnapshot.clear(),null===(e=this.sourceTrack)||void 0===e||e.stop(),this.sourceTrack=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.video=null,null===(i=this.filters)||void 0===i||i.destroy(),this.filters=null,this.sourceMap=null,this.maskData=null,this.advBeautyData=null,this.pluginModules=null,this.frameCount=[0,0]}}t.default=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(123),s=new class{constructor(){this.id=0,this.callbacks={},this.worker=null}getWorker(){return this.worker||(this.worker=new Worker(r.getBlobUrl("webWorkerTimer")),this.worker.onmessage=e=>{switch(e.data.message){case"interval:tick":case"timeout:tick":{const t=this.callbacks[e.data.id];t&&t.fn&&t.fn.apply(t.context);break}case"interval:cleared":case"timeout:cleared":delete this.callbacks[e.data.id]}}),this.worker}setInterval(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"interval:start",interval:t,id:r}),r}setTimeout(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"timeout:start",timeout:t,id:r}),r}clearInterval(e){this.getWorker().postMessage({command:"interval:clear",id:e})}clearTimeout(e){this.getWorker().postMessage({command:"timeout:clear",id:e})}};t.default=s},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filters=void 0;const r=i(161),s=i(311),a=i(118),n=i(203),o=i(320),d=i(324),c=i(325),l=i(326),u=i(327);class h{constructor(e){this._alive=!0,this.time=-1,this.lastTimer=performance.now(),this.webglLostContext=null,this._renderer=new s.Renderer({canvas:e,antialias:!0}),this.map=a.createTexture(this._renderer.gl,null);const t=this._renderer.gl;this.webglLostContext=t.getExtension("WEBGL_lose_context");const{posArray:i,uvArray:h,advBeautyIndicesArray:p,advBeautyPosArray:m,advBeautyZindexArray:f,advFaceMaskUVArray:g,advEyeTeethPosArray:v,advEyeTeethIndicesArray:_,advEyeTeethZindexArray:y,advEyeTeethUVArray:S}=l.typedArray,R=r.createAttributeBuffer(t,"position",i,2),b=r.createAttributeBuffer(t,"uv",h,2),E=r.createAttributeBuffer(t,"position",m,2),T=r.createAttributeBuffer(t,"zIndex",f,1),A=r.createAttributeBuffer(t,"indices",p,1,"ELEMENT_ARRAY_BUFFER"),w=r.createAttributeBuffer(t,"uv",g,2),I=r.createAttributeBuffer(t,"tPosition",v,2),C=r.createAttributeBuffer(t,"indices",_,1,"ELEMENT_ARRAY_BUFFER"),O=r.createAttributeBuffer(t,"zIndex",y,1),k=r.createAttributeBuffer(t,"uv",S,2);this.advBeauty=new n.AdvBeautyFilter(this._renderer,this.map,E,T,A,w,R,b,I,C,O,k),this.beauty=new o.BeautyFilter(this._renderer,this.map,R,b),this.lut=new d.LutFilter(this._renderer,this.map,R,b),this.normal=new c.NormalFilter(this._renderer,this.map,R,b),this.virtualBackground=new u.VirtualBackFilter(this._renderer,this.map,R,b)}clone(){var e;try{const t=new h(this._renderer.canvas);t.mapSource=(null===(e=this.srcMap)||void 0===e?void 0:e.source)||null,this.advBeauty.remove(),t.advBeauty.presetAdvEffect(Object.assign({},this.advBeauty.params));const i=this.virtualBackground.lastSetInfo;return"bk"===i.type?t.virtualBackground.setBackground(i.value):"blur"===i.type&&t.virtualBackground.setBlurIntensity(i.value),t}catch(e){return null}}get filters(){return[this.advBeauty,this.beauty,this.lut,this.virtualBackground,this.normal]}get canvas(){return this._renderer.canvas}get gl(){return this._renderer.gl}get srcMap(){return this.map}set mapSource(e){const t=this.map;t&&(t.source=e,t.refresh())}get isAlive(){return this._alive}setSize(e,t){this._renderer.setSize(e,t),this.filters.forEach((e=>{e.updateSize()}))}render(){const e=this.filters;e[0].map=this.map,e[0].render(),e[1].faceMask=e[0].faceMask,e[1].featureParas=e[0].featureParas;for(let t=1;t<e.length;t++)e[t].map=e[t-1].output,e[t].render()}update(e=!0){var t;if(this._alive){if(this.time<0)this.time=0,this.lastTimer=performance.now();else{const e=performance.now(),t=Math.min(e-this.lastTimer,100);this.lastTimer=e,this.time+=t/1e3}e&&(null===(t=this.map)||void 0===t||t.refresh()),this.render()}}destroy(){this._alive=!1,this.time=-1;const e=this._renderer.gl;this.filters.forEach((e=>{e.destroy()})),null==e||e.deleteTexture(this.map.glTexture)}}t.Filters=h},function(e,t,i){var r=this&&this.__rest||function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]])}return i};Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;const s=i(127);t.Renderer=class{constructor(e){this._gl=null,this._pixelRatio=1,this._viewport={x:0,y:0,width:640,height:480};const t=Object.assign({preserveDrawingBuffer:!0,powerPreference:"high-performance"},e),{canvas:i=document.createElement("canvas"),width:a=640,height:n=480}=t,o=r(t,["canvas","width","height"]);this._canvas=i,this._gl=s.getWebGLContext(i,o);const d=this.setSize(a,n);this.setViewport(0,0,d.width,d.height)}get canvas(){return this._canvas}get gl(){return this._gl}getPixelRatio(){var e;return null!==(e=this._pixelRatio)&&void 0!==e?e:1}setPixelRatio(e){const t=this.getPixelRatio();if(t===e)return;const i=this.getSize();i.width/=t,i.height/=t,this._pixelRatio=e,this.setSize(i.width,i.height)}getSize(){return{width:this.canvas.width,height:this.canvas.height}}setSize(e,t,i=!1){const r=this.canvas,s=this.getPixelRatio();return r.width=e*s,i&&(r.style.width=e+"px"),r.height=t*s,i&&(r.style.height=t+"px"),this.getSize()}getViewport(){return this._viewport}setViewport(e,t,i,r){var s;this._viewport={x:e,y:t,width:i,height:r},null===(s=this.gl)||void 0===s||s.viewport(e,t,i,r)}resize(e,t,i,r){const s=this.setSize(e,t);i&&this.setPixelRatio(i),r?this.setViewport(r.x,r.y,r.width,r.height):this.setViewport(0,0,s.width,s.height)}render(e){if(!this.gl)return;const t=this.gl;t.enable(t.CULL_FACE),e.render()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultShader=void 0,t.defaultShader={vShader:"\n    attribute vec4 position;\n    void main() {\n        gl_Position = position;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createShader=void 0,t.createShader=function(e,t,i){const r=e.createShader({VERTEX:e.VERTEX_SHADER,FRAGMENT:e.FRAGMENT_SHADER}[i]);if(!r)return console.error(i+"Shader was not created successfully."),null;if(e.shaderSource(r,t),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;const s=t.split("\n").map(((e,t)=>`${t+1}${e}`)).join("\n");return console.error(`${e.getShaderInfoLog(r)}\n%cshader source code\n${s}\n`,"color: #008040"),e.deleteShader(r),null}},function(e,t,i){function r(e,t,i,r,s,a){var n;if(i===e.FLOAT)return r?i=>e.uniform1fv(t,i):i=>e.uniform1f(t,i);const o={[e.FLOAT_VEC2]:i=>e.uniform2fv(t,i),[e.FLOAT_VEC3]:i=>e.uniform3fv(t,i),[e.FLOAT_VEC4]:i=>e.uniform4fv(t,i)}[i];if(o)return o;if(i===e.INT||i===e.BOOL)return r?i=>e.uniform1iv(t,i):i=>e.uniform1i(t,i);const d={[e.BOOL_VEC2]:e.INT_VEC2,[e.BOOL_VEC3]:e.INT_VEC3,[e.BOOL_VEC4]:e.INT_VEC4},c={[e.INT_VEC2]:i=>e.uniform2iv(t,i),[e.INT_VEC3]:i=>e.uniform3iv(t,i),[e.INT_VEC4]:i=>e.uniform4iv(t,i)}[null!==(n=d[i])&&void 0!==n?n:i];if(c)return c;const l={[e.FLOAT_MAT2]:i=>e.uniformMatrix2fv(t,!1,i),[e.FLOAT_MAT3]:i=>e.uniformMatrix3fv(t,!1,i),[e.FLOAT_MAT4]:i=>e.uniformMatrix4fv(t,!1,i)}[i];if(l)return l;if(i===e.SAMPLER_2D||i===e.SAMPLER_CUBE){const n=i===e.SAMPLER_2D?e.TEXTURE_2D:e.TEXTURE_CUBE_MAP;if(r){const i=[];for(let e=0;e<s;e++)i.push(a.value++);return r=>{e.uniform1iv(t,i),r.forEach(((t,r)=>{var s;e.activeTexture(e.TEXTURE0+i[r]),e.bindTexture(n,null!==(s=null==t?void 0:t.glTexture)&&void 0!==s?s:null)}))}}{const i=a.value++;return r=>{var s;e.uniform1i(t,i),e.activeTexture(e.TEXTURE0+i),e.bindTexture(n,null!==(s=null==r?void 0:r.glTexture)&&void 0!==s?s:null)}}}return()=>{console.warn("no matching uniform setter.")}}Object.defineProperty(t,"__esModule",{value:!0}),t.parseUniforms=void 0,t.parseUniforms=function(e,t){const i={value:0},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),a={};for(let n=0;n<s;n++){const s=e.getActiveUniform(t,n);if(s){const n=s.size>1,o=n?s.name.replace("[0]",""):s.name,d=s.type,c=e.getUniformLocation(t,o);if(null!==c){const t=r(e,c,d,n,s.size,i);a[o]={type:d,size:s.size,value:null,setter:e=>{void 0!==e?a[o].value=e:t(a[o].value)}}}else console.warn(`uniform:[${o}] is null.`)}}return a}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyEyeShader=void 0,t.advBeautyEyeShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform vec2 eyeCenter;\n    uniform vec2 rdDir;\n    uniform float rdIntensity;\n    uniform float lgIntensity;\n    uniform float intensRatio;\n    uniform float range;\n\n    varying vec2 vuv;\n\n    mat3 scaleByNormal(vec2 normal, float k, float refx, float refy){\n        float a = 1.0 + (k - 1.0) * normal.x * normal.x;\n        float b = (k - 1.0) * normal.x * normal.y;\n        float c = 1.0 + (k - 1.0) * normal.y * normal.y;\n        return mat3(\n            a, b, 0.0,\n            b, c, 0.0,\n            (1.0 - a) * refx - b * refy, (1.0 - c) * refy - b * refx, 1.0\n        );\n    }\n\n    vec2 lgEye(vec2 uv, vec2 center, float range, float strength, float powRatio) {\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        vec2 dir = normalize(uv - center);\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        float newDist = dist * scale;\n        return center + newDist * dir;\n    }\n\n    vec2 rdEye(vec2 uv, vec2 center, float range, float strength, float powRatio){\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        return (scaleByNormal(rdDir, scale, center.x, center.y) * vec3(uv, 1.0)).xy;\n    }\n\n    void main() {\n        vec2 uv = vuv;\n        if(intensRatio > 0.0){\n            if(rdIntensity > 0.0){\n                float maxRdIntens = mix(1.0, 0.5, lgIntensity);\n                float rdIntens = mix(0.0, maxRdIntens, rdIntensity * intensRatio);\n                uv = lgEye(uv, eyeCenter, range * 2.0, rdIntens, 0.075);\n                uv = rdEye(uv, eyeCenter, range * 2.0, rdIntens, 0.1);\n            }\n            if(lgIntensity > 0.0){\n                float lgIntens = lgIntensity * intensRatio;\n                uv = lgEye(uv, eyeCenter, range * 2.5, lgIntens, 0.1);\n                uv = rdEye(uv, eyeCenter, range * 2.5, lgIntens, 0.05);\n            }\n        }\n        gl_FragColor = texture2D(map, uv);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyShader=void 0,t.advBeautyShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n    attribute vec2 tPosition;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = position;\n        vec2 ntPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n            ntPos = npos(ntPos);\n        }\n        vec2 ndcPos = ndcpos(ntPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n\n        vuv = nPos;\n        vuv.y = 1.0 - vuv.y;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform float showWire;\n    uniform vec2 size;\n    uniform sampler2D map;\n    uniform sampler2D wireMap;\n    uniform sampler2D eyeTeethMaskMap;\n    uniform sampler2D teethLut;\n    uniform float eyeIntensity;\n    uniform float teethIntensity;\n    varying vec2 vuv;\n\n    vec3 lut64(vec3 color, sampler2D lut){\n        float blue = color.b * 63.0;\n\n        vec2 q1;\n        float fb = floor(blue);\n        q1.y = floor(fb * 0.125);\n        q1.x = fb - (q1.y * 8.0);\n\n        vec2 q2;\n        float cb = ceil(blue);\n        q2.y = floor(cb * 0.125);\n        q2.x = cb - (q2.y * 8.0);\n\n        vec2 t = 0.123 * color.rg + vec2(0.000976563);\n        vec2 t1 = q1 * 0.125 + t;\n        vec3 p1 = texture2D(lut, t1).rgb;\n\n        vec2 t2 = q2 * 0.125 + t;\n        vec3 p2 = texture2D(lut, t2).rgb;\n\n        return mix(p1, p2, fract(blue));\n    }\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        if(eyeIntensity > 0.0 || teethIntensity > 0.0){\n            vec4 eyeTeethMask = texture2D(eyeTeethMaskMap, vuv);\n            float teethInten = eyeTeethMask.r > 0.0 ? teethIntensity * eyeTeethMask.a : 0.0;\n            float eyeInten = eyeTeethMask.g > 0.0 ? eyeIntensity * eyeTeethMask.a : 0.0;\n            if(teethInten>0.0){\n                color.rgb = mix(color.rgb, lut64(color.rgb, teethLut), teethInten);\n            }\n            if(eyeInten>0.0){\n                vec2 step1 = vec2(size.x / 640.0 / size.x, 0.0);\n                vec2 step2 = vec2(0.0, size.y / 480.0 /size.y);\n                vec3 sumColor = vec3(0.0, 0.0, 0.0);\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 2.0 * step2).rgb;\n\n                sumColor = sumColor * 0.04;\n                sumColor = clamp(sumColor + (color.rgb - sumColor) * 2.0, 0.0, 1.0);\n                sumColor = max(color.rgb, sumColor);\n                color.rgb = mix(color.rgb, sumColor, eyeInten);\n                eyeInten = 1.0 + eyeInten * 0.25;\n                color.rgb = (color.rgb - vec3(0.5)) * eyeInten + vec3(0.5);\n            }\n        }\n        if(showWire > 0.5){\n            vec4 wire = texture2D(wireMap, vuv);\n            gl_FragColor = mix(color, wire, wire.a);\n        }else{\n            gl_FragColor = color;\n        }\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyWireShader=void 0,t.advBeautyWireShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = npos(position);\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, 0.0, 1.0);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n    void main() {\n        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advFaceMaskShader=void 0,t.advFaceMaskShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 tPosition;\n    attribute vec2 uv;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n        }\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform int index;\n    varying vec2 vuv;\n\n    void main() {\n      vec4 color = index == 0 ? vec4(0.0) : texture2D(map, vuv);\n      vec4 mask = texture2D(maskMap, vuv);\n      float a = 1.0 - (1.0 - color.a) * (1.0 - mask.a);\n      vec3 rgb = max(color.rgb, mask.rgb);\n      gl_FragColor = vec4(rgb, a);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.handlers=t.preHandle=t.Matrix3x3=t.Vector2=void 0;class r{constructor(e,t){this.value=[0,0],this.value=[e,t]}get x(){return this.value[0]}set x(e){this.value[0]=e}get y(){return this.value[1]}set y(e){this.value[1]=e}get lengthPow2(){return Math.pow(this.x,2)+Math.pow(this.y,2)}get length(){return Math.sqrt(this.lengthPow2)}static getVec(e,t){const i=2*t;if(i<0)throw new Error("index out range");const s=i+1;if(s>=e.length)throw new Error("index out range");return new r(e[i],e[s])}static setPoint(e,t,i){const r=2*t;if(r<0)throw new Error("index out range");const s=r+1;if(s>=e.length)throw new Error("index out range");e[r]=i.value[0],e[s]=i.value[1]}static normalize(e){const t=Math.sqrt(e.value[0]*e.value[0]+e.value[1]*e.value[1]);return new r(e.value[0]/t,e.value[1]/t)}static add(e,t){return new r(e.value[0]+t.value[0],e.value[1]+t.value[1])}static sub(e,t){return new r(e.value[0]-t.value[0],e.value[1]-t.value[1])}static scale(e,t){return new r(e.value[0]*t,e.value[1]*t)}static scaleByAxis(e,t,i){return new r(e.x*t,e.y*i)}static disPow2(e,t){const i=e.value,r=t.value,s=i[0]-r[0],a=i[1]-r[1];return s*s+a*a}static dis(e,t){return Math.sqrt(r.disPow2(e,t))}static lerp(e,t,i){if(!e||!t)return e||t;const s=e.value,a=t.value;return new r(s[0]+(a[0]-s[0])*i,s[1]+(a[1]-s[1])*i)}static intersectPoint(e,t,i,s){const a=e.value,n=t.value,o=i.value,d=s.value,c=o[0]-d[0],l=a[0]-n[0],u=o[1]-d[1],h=a[1]-n[1],p=l*u-h*c;if(0==p)return null;const m=a[0]*n[1]-a[1]*n[0],f=o[0]*d[1]-o[1]*d[0];return new r((m*c-l*f)/p,(m*u-h*f)/p)}static center(...e){const t=e.length;if(!t)return new r(0,0);if(1===t)return new r(...e[0].value);if(2===t)return new r((e[0].value[0]+e[1].value[0])/2,(e[0].value[1]+e[1].value[1])/2);let i=0,s=0,a=0;for(let r=t-1,n=0;n<t;r=n,n++){const t=e[r].value,o=e[n].value,d=t[0]*o[1]-o[0]*t[1];i+=d,s+=(o[0]+t[0])*d,a+=(o[1]+t[1])*d}let n=0,o=0;return 0!=i&&(n=s/(3*i),o=a/(3*i)),new r(n,o)}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t){return e.x*t.y-t.x*e.y}static angle(e,t){const i=r.normalize(e),s=r.normalize(t);return Math.acos(Math.min(1,Math.max(-1,r.dot(i,s))))}static fromToAngle(e,t){return r.cross(e,t)<0?-r.angle(e,t):r.angle(e,t)}}t.Vector2=r;class s{constructor(e,t,i,r,s,a,n,o,d){this.matrix=[[e,t,i],[r,s,a],[n,o,d]]}get a(){return this.matrix[0][0]}set a(e){this.matrix[0][0]=e}get b(){return this.matrix[1][0]}set b(e){this.matrix[1][0]=e}get c(){return this.matrix[0][1]}set c(e){this.matrix[0][1]=e}get d(){return this.matrix[1][1]}set d(e){this.matrix[1][1]=e}get e(){return this.matrix[0][2]}set e(e){this.matrix[0][2]=e}get f(){return this.matrix[1][2]}set f(e){this.matrix[1][2]=e}get transpose(){let e=this.matrix;return new s(e[0][0],e[1][0],e[2][0],e[0][1],e[1][1],e[2][1],e[0][2],e[1][2],e[2][2])}multiplyPoint(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1]+this.matrix[0][2],a=t*this.matrix[1][0]+i*this.matrix[1][1]+this.matrix[1][2],n=t*this.matrix[2][0]+i*this.matrix[2][1]+this.matrix[2][2];return new r(s/n,a/n)}multiplyVector(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1],a=t*this.matrix[1][0]+i*this.matrix[1][1];return new r(s,a)}static identity(){return new s(1,0,0,0,1,0,0,0,1)}static rotate(e,t,i){let r=Math.cos(e),a=Math.sin(e),n=s.identity();return n.matrix[0][0]=r,n.matrix[0][1]=-a,n.matrix[1][0]=a,n.matrix[1][1]=r,n.matrix[0][2]=t*(1-r)+i*a,n.matrix[1][2]=i*(1-r)-t*a,n}static scaleByNormal(e,t,i,a){e=r.normalize(e);let n=1+(t-1)*Math.pow(e.x,2),o=(t-1)*e.x*e.y,d=1+(t-1)*Math.pow(e.y,2);return new s(n,o,(1-n)*i-o*a,o,d,(1-d)*a-o*i,0,0,1)}}t.Matrix3x3=s;let a,n,o=!0;t.preHandle=e=>{a=r.getVec(e,74),n=r.getVec(e,77)},t.handlers={eyeAngle:(e,t)=>{const i=.06*(t-.5)*Math.PI,o=s.rotate(i,a.x,a.y);[52,53,54,55,56,57,72,73].forEach((t=>{const i=o.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i)}));const d=s.rotate(-i,n.x,n.y);[58,59,60,61,62,63,75,76].forEach((t=>{const i=d.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i)}))},openCanthus:(e,t)=>{t*=.05;const i=r.getVec(e,43),s=r.getVec(e,46);let a=r.getVec(e,55),n=r.getVec(e,58);const o=r.intersectPoint(i,s,a,n)||i;a=r.lerp(a,o,t),n=r.lerp(n,o,t),r.setPoint(e,55,a),r.setPoint(e,58,n),[54,56,59,63].forEach((i=>{let s=r.getVec(e,i);s=r.lerp(s,i<57?a:n,.05*t),r.setPoint(e,i,s)}))},eyeDistance:(e,t)=>{t=.1*(t-.5);const i=r.getVec(e,43),s=r.scale(r.sub(a,i),t),o=r.scale(r.sub(n,i),t);[52,53,54,55,56,57,72,73,74].forEach((t=>{const i=r.add(r.getVec(e,t),s);r.setPoint(e,t,i)})),[58,59,60,61,62,63,75,76,77].forEach((t=>{const i=r.add(r.getVec(e,t),o);r.setPoint(e,t,i)})),a=r.getVec(e,74),n=r.getVec(e,77)},roundedEye:(e,t)=>(o=!1,a=r.center(...[52,53,54,55,56,57,72,73].map((t=>r.getVec(e,t)))),n=r.center(...[58,59,60,61,62,63,75,76].map((t=>r.getVec(e,t)))),{lEyeCenter:a,rEyeCenter:n}),enlargeEye:(e,t)=>(o?(a=r.center(...[52,53,54,55,56,57,72,73].map((t=>r.getVec(e,t)))),n=r.center(...[58,59,60,61,62,63,75,76].map((t=>r.getVec(e,t))))):o=!0,{lEyeCenter:a,rEyeCenter:n}),shrinkNose:(e,t)=>{t*=.15;const i=r.getVec(e,46);[80,81,82,83].forEach((s=>{r.setPoint(e,s,r.lerp(r.getVec(e,s),i,t))}));const s=r.getVec(e,49);[47,51].forEach((i=>{r.setPoint(e,i,r.lerp(r.getVec(e,i),s,t))}))},lengthenNose:(e,t)=>{t=.25*(t-.5);const i=[80,81,82,83,47,51],s=r.getVec(e,46),a=[];i.forEach((t=>{a.push(r.sub(r.getVec(e,t),s))}));const n=r.getVec(e,49),o=r.lerp(n,r.getVec(e,87),t);r.setPoint(e,49,o);const d=r.sub(o,n),c=r.add(s,d);r.setPoint(e,46,c),a.forEach(((t,s)=>{const a=r.add(c,t);r.setPoint(e,i[s],a)}))},shrinkMouth:(e,t)=>{const i=1+.25*(t-=.65),s=1+.2*t,a=[1,.7,.2,0,.2,.7,1,.66,.33,0,.33,.66],n=[1,.66,0,.66,1,.66,0,.66],o=[84,85,86,87,88,89,90,91,92,93,94,95],d=[96,97,98,99,100,101,102,103],c=[],l=[];o.forEach((t=>{c.push(r.getVec(e,t))})),d.forEach((t=>{l.push(r.getVec(e,t))}));const u=r.center(...c);c.forEach(((t,n)=>{const d=a[n],c=i*d+s*(1-d);r.setPoint(e,o[n],r.add(u,r.scale(r.sub(t,u),c)))})),l.forEach(((t,a)=>{const o=n[a],c=i*o+s*(1-o);r.setPoint(e,d[a],r.add(u,r.scale(r.sub(t,u),c)))}))},widenMouth:(e,t)=>{t-=.5,t*=t<0?.3:.2;const i=r.getVec(e,90),a=r.getVec(e,84),n=r.getVec(e,87),o=r.getVec(e,93),d=r.intersectPoint(i,a,n,o)||r.center(n,o),c=s.scaleByNormal(r.sub(d,a),t+1,d.x,d.y),l=s.scaleByNormal(r.sub(d,i),t+1,d.x,d.y);[84,96,85,95,97,103,86,94].forEach((t=>{r.setPoint(e,t,c.multiplyPoint(r.getVec(e,t)))})),[90,100,89,91,99,101,88,92].forEach((t=>{r.setPoint(e,t,l.multiplyPoint(r.getVec(e,t)))}))},mouthCorners:(e,t)=>{const i=.06*(t-.5)*Math.PI,a=r.center(...[84,85,86,87,88,89,90,91,92,93,94,95].map((t=>r.getVec(e,t))));let n=s.rotate(i,a.value[0],a.value[1]),o=s.rotate(.66*i,a.value[0],a.value[1]),d=s.rotate(.33*i,a.value[0],a.value[1]),c=s.rotate(.1*i,a.value[0],a.value[1]),l=[n,o,c,d,o,n,o,o];[84,85,86,94,95,96,97,103].forEach(((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s)})),n=s.rotate(-i,a.value[0],a.value[1]),o=s.rotate(.66*-i,a.value[0],a.value[1]),d=s.rotate(.33*-i,a.value[0],a.value[1]),c=s.rotate(.1*-i,a.value[0],a.value[1]),l=[n,o,c,d,o,n,o,o],[90,89,88,92,91,100,99,101].forEach(((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s)}))},adjustPhiltrum:(e,t)=>{t=.25*(t-.5);const i=r.getVec(e,87),s=r.scale(r.sub(r.getVec(e,49),i),t);for(let t=84;t<104;t++)r.setPoint(e,t,r.add(r.getVec(e,t),s))},shrinkUnderjaw:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,16),n=r.getVec(e,49),o=r.getVec(e,0),d=r.getVec(e,32),c=[[6,26],[8,24],[10,22],[12,20],[14,18]],l=[],u=[],h=[];c.forEach((t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);l.push([i,s]),u.push(r.intersectPoint(i,n,o,a)),h.push(r.intersectPoint(s,n,d,a))}));const p=[.33,.66,1,.66,.33];l.forEach(((t,a)=>{const n=r.lerp(t[0],u[a],i*p[a]),o=r.lerp(t[1],h[a],s*p[a]);r.setPoint(e,c[a][0],n),r.setPoint(e,c[a][1],o)}))},shrinkCheekbone:(e,t)=>{const i=t*=.08,s=t,a=r.getVec(e,43),n=r.getVec(e,49),o=[[0,32],[2,30],[4,28],[6,26],[8,24]],d=[],c=[];o.forEach((t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);d.push([i,s]),c.push(r.intersectPoint(i,s,a,n))}));const l=[.33,.66,.33,.22,.11];d.forEach(((t,a)=>{const n=r.lerp(t[0],c[a],i*l[a]),d=r.lerp(t[1],c[a],s*l[a]);r.setPoint(e,o[a][0],n),r.setPoint(e,o[a][1],d)}))},lengthenJaw:(e,t)=>{t=.1*(.5-t);const i=r.getVec(e,16),s=r.sub(r.getVec(e,49),i),a=[.5,.5];[12,20,14,16,18].forEach(((i,n)=>{r.setPoint(e,i,r.add(r.getVec(e,i),r.scale(s,t*(a[n]||1))))}))},narrowedFace:(e,t)=>{const i=t*=.05,s=t,a=r.getVec(e,43),n=r.getVec(e,16),o=[.33,.66,1];[[106,111],[0,32],[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]].forEach(((t,d)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,n);const h=o[d]||1;c=r.lerp(c,u,i*h),l=r.lerp(l,u,s*h),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l)}))},shrinkFace:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,43),n=r.getVec(e,16);let o=[[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],d=[.1,.325,.55,.775,1,.9,.8,.7];o.forEach(((t,o)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,n);c=r.lerp(c,u,i*d[o]),l=r.lerp(l,u,s*d[o]),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l)}));const c=r.getVec(e,93);o=[[14,18],[12,20]],d=[.4,.2],o.forEach(((t,a)=>{let n=r.getVec(e,t[0]),o=r.getVec(e,t[1]);n=r.lerp(n,c,i*d[a]),o=r.lerp(o,c,s*d[a]),r.setPoint(e,t[0],n),r.setPoint(e,t[1],o)})),r.setPoint(e,16,r.lerp(r.getVec(e,16),c,.6*Math.max(i,s)))},vShapedFace:(e,t)=>{const i=t*=.2,s=t,a=r.getVec(e,16),n=r.getVec(e,2),o=r.getVec(e,30),d=[[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],c=[],l=[],u=[];d.forEach((t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);c.push([i,s]),l.push(r.intersectPoint(i,s,n,a)),u.push(r.intersectPoint(s,i,o,a))}));const h=[.33,.66];c.forEach(((t,a)=>{const n=r.lerp(t[0],l[a],i*(h[a]||1)),o=r.lerp(t[1],u[a],s*(h[a]||1));r.setPoint(e,d[a][0],n),r.setPoint(e,d[a][1],o)}))},minifyFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),s=r.getVec(e,49),a=r.getVec(e,2),n=r.getVec(e,30),o=r.lerp(r.intersectPoint(i,s,a,n),i,t);let d=[.1,.25,.4,.55,.7,.85];[4,6,8,10,12,14,84,85,86,94,95,96,97,103,47,80,82].forEach(((i,s)=>{const a=r.lerp(r.getVec(e,i),o,t*(d[s]||.65));r.setPoint(e,i,a)})),[28,26,24,22,20,18,88,89,90,91,92,99,100,101,51,81,83].forEach(((i,s)=>{const a=r.lerp(r.getVec(e,i),o,t*(d[s]||.65));r.setPoint(e,i,a)})),d=[1],[16,93,102,98,87,49,46].forEach(((i,s)=>{const a=r.lerp(r.getVec(e,i),o,t*(d[s]||.65));r.setPoint(e,i,a)}))},shortenFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),a=r.getVec(e,49),n=r.center(i,a)||r.getVec(e,45),o=s.scaleByNormal(r.sub(i,a),1-t,n.x,n.y);for(let t=4;t<30;t+=2)r.setPoint(e,t,o.multiplyPoint(r.getVec(e,t)));for(let t=80;t<84;t++)r.setPoint(e,t,o.multiplyPoint(r.getVec(e,t)));for(let t=46;t<52;t++)r.setPoint(e,t,o.multiplyPoint(r.getVec(e,t)));for(let t=84;t<104;t++)r.setPoint(e,t,o.multiplyPoint(r.getVec(e,t)))},whitenTeeth:(e,t)=>{let i=r.dis(r.getVec(e,98),r.getVec(e,102))/(r.dis(r.getVec(e,96),r.getVec(e,100))||1);return t*Math.max(0,Math.min(1,Math.pow(5*i,2)))}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BeautyFilter=void 0;const r=i(134),s=i(135),a=i(118),n=i(136),o=i(321),d=i(322),c=i(323),l=i(204),u=i(137),h={};class p extends u.Filter{constructor(e,t,i,r){super(e,t,i,r),this._smooth=0,this._whiten=0,this._redden=0,this._faceMask=null,this._featureParas={forehead:0,eyeRim:0,noseLine:0},this.featureEnable=!1,this.whitenMap=a.createTexture(e.gl,null,{flipY:!1}),this.reddenMap=a.createTexture(e.gl,null,{flipY:!1});const{programs:s,framebuffers:n}=this.initProgramsBuffers();this.programs=s,this.framebuffers=n,this.initUniforms()}initProgramsBuffers(){const e=this.renderer.gl,t=this.renderer.getSize(),i={},a={},u={blurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},blurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},highPass:{vShader:n.baseTextureShader.vShader,fShader:c.beautyHighPassShader.fShader,size:t},hBlurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},hBlurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},beauty:{vShader:n.baseTextureShader.vShader,fShader:o.beautyShader.fShader,size:t},whiten:{vShader:n.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t},redden:{vShader:n.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t}};for(const t in u){const{vShader:n,fShader:o,size:d}=u[t],c=new s.Program(e);c.setShader(n,"VERTEX"),c.setShader(o,"FRAGMENT"),c.setAttributeBuffer(this.posBuffer),c.setAttributeBuffer(this.uvBuffer),i[t]=c;const l=r.createFrameBuffer(e,d.width,d.height);a[t]=l}return{programs:i,framebuffers:a}}initUniforms(){const e=this.programs,t=this.framebuffers,i=this.map,{width:r,height:s}=this.renderer.getSize(),a=[r,s],n=[r>>1,s>>1];e.blurX.setUniform("map",i),e.blurX.setUniform("size",n),e.blurY.setUniform("map",t.blurX.targetTexture),e.blurY.setUniform("size",n),e.blurY.setUniform("isVertical",1),e.highPass.setUniform("map",i),e.highPass.setUniform("blurMap",t.blurY.targetTexture),e.hBlurX.setUniform("map",t.highPass.targetTexture),e.hBlurX.setUniform("size",a),e.hBlurY.setUniform("map",t.hBlurX.targetTexture),e.hBlurY.setUniform("size",a),e.hBlurY.setUniform("isVertical",1),e.beauty.setUniform("size",a),e.beauty.setUniform("map",i),e.beauty.setUniform("blurMap",t.blurY.targetTexture),e.beauty.setUniform("highPassMap",t.hBlurY.targetTexture),e.beauty.setUniform("intensity",0);const o=this.featureParas;for(const t in o)e.beauty.setUniform(t+"Inten",this._featureParas[t]);e.whiten.setUniform("map",i),e.whiten.setUniform("lut",this.whitenMap),e.whiten.setUniform("intensity",0),e.redden.setUniform("map",i),e.redden.setUniform("lut",this.reddenMap),e.redden.setUniform("intensity",0)}get map(){return super.map}set map(e){e!==this._map&&(this._map=e,["blurX","highPass","beauty"].forEach((e=>{this.programs[e].setUniform("map",this._map)})),this.mapChange())}setLutsSrc(e,t){const{whiten:i,redden:r}=e;let s=2;const n=[],o=()=>{s-=1,s<=0&&(null==t||t(n))};if(h.whiten){this.whitenMap.source=h.whiten,this.whitenMap.refresh();const e=this._whiten;this._whiten=0,this.whiten=e,o()}else a.retryLoadImage(i,3,(e=>{h.whiten=e,this.whitenMap.source=e,this.whitenMap.refresh();const t=this._whiten;this._whiten=0,this.whiten=t,o()}),(()=>{n.push(i),o()}));if(h.redden){this.reddenMap.source=h.redden,this.reddenMap.refresh();const e=this._redden;this._redden=0,this.redden=e,o()}else a.retryLoadImage(r,3,(e=>{h.redden=e,this.reddenMap.source=e,this.reddenMap.refresh();const t=this._redden;this._redden=0,this.redden=t,o()}),(()=>{n.push(r),o()}))}get smoothOut(){return this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:this.map}get whitenOut(){return this.whiten?this.framebuffers.whiten.targetTexture:this.smoothOut}mapChange(){this.programs.whiten.setUniform("map",this.smoothOut),this.programs.redden.setUniform("map",this.whitenOut)}get smooth(){return this._smooth}set smooth(e){this._smooth!==e&&(this._smooth=e,this.programs.beauty.setUniform("intensity",this._smooth),this.mapChange())}get whiten(){return this._whiten}set whiten(e){this._whiten!==e&&(this._whiten=e,this.programs.whiten.setUniform("intensity",this.whitenMap&&this.whitenMap.source?this._whiten:0),this.mapChange())}get redden(){return this._redden}set redden(e){this._redden!==e&&(this._redden=e,this.programs.redden.setUniform("intensity",this.reddenMap&&this.reddenMap.source?this._redden:0))}set faceMask(e){this._faceMask!==e&&(this.programs.beauty.setUniform("maskMap",e),this.programs.beauty.setUniform("hasMask",e?1:0),this._faceMask=e)}set featureParas(e){let t=0;for(const i in e){const r=e[i];t+=r,this._featureParas[i]!==r&&(this.programs.beauty.setUniform(i+"Inten",r),this._featureParas[i]=r)}this.featureEnable=t>0,this.mapChange()}get output(){return this.redden?this.framebuffers.redden.targetTexture:this.whiten?this.framebuffers.whiten.targetTexture:this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[e.width,e.height],i=[e.width>>1,e.height>>1];["blurX","blurY"].forEach((e=>{const t=this.framebuffers[e];t.targetTexture.opts.width=i[0],t.targetTexture.opts.height=i[1],t.targetTexture.refresh(),this.programs[e].setUniform("size",i)})),["highPass","hBlurX","hBlurY","beauty","whiten","redden"].forEach((e=>{const i=this.framebuffers[e];i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),["highPass","whiten","redden"].indexOf(e)<0&&this.programs[e].setUniform("size",t)}))}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=this.programs,s=this.framebuffers;(this.smooth||this.featureEnable)&&(e.setViewport(0,0,t>>1,i>>1),s.blurX.bind(),e.render(r.blurX),s.blurY.bind(),e.render(r.blurY),e.setViewport(0,0,t,i),s.highPass.bind(),e.render(r.highPass),s.hBlurX.bind(),e.render(r.hBlurX),s.hBlurY.bind(),e.render(r.hBlurY),s.beauty.bind(),e.render(r.beauty)),this.whiten&&(s.whiten.bind(),e.render(r.whiten)),this.redden&&(s.redden.bind(),e.render(r.redden))}destroy(){super.destroy();const e=this.renderer.gl;null==e||e.deleteTexture(this.whitenMap.glTexture),null==e||e.deleteTexture(this.reddenMap.glTexture)}}t.BeautyFilter=p},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyShader=void 0,t.beautyShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform vec2 size;\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n    uniform sampler2D highPassMap;\n    uniform sampler2D maskMap;\n    uniform int hasMask;\n\n    // 磨皮度\n    uniform float intensity;\n    uniform float foreheadInten;\n    uniform float eyeRimInten;\n    uniform float noseLineInten;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 originColor = texture2D(map, vuv);\n        float _intensity = intensity;\n        if(hasMask > 0){\n            vec4 mask = texture2D(maskMap, vuv);\n            float intens = max(max(mask.r * noseLineInten, mask.g * foreheadInten), mask.b * eyeRimInten);\n            if(intens > 0.0){\n              _intensity = mix(_intensity, 1.5, intens);\n            }else{\n              _intensity *= mask.a;\n            }\n        }\n        if(_intensity > 0.0){\n            vec2 stepOffset = 0.5 / size;\n            float uOffsetX = stepOffset.x;\n            float uOffsetY = stepOffset.y;\n            float strength = _intensity * 1.0;\n\n            vec4 meanColor = texture2D(blurMap, vuv);\n            vec4 varColor = texture2D(highPassMap, vuv);\n\n            float value = clamp((min(originColor.r, meanColor.r - 0.1) - 0.2) * 4.0, 0.0, 1.0);\n            float meanValue = (varColor.r + varColor.g + varColor.b) / 3.0;\n            float currentIntensity = (1.0 - meanValue / (meanValue + 0.1)) * value * strength;\n            vec3 resultColor = mix(originColor.rgb, meanColor.rgb, currentIntensity);\n            float sum = 0.25*originColor.g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x-uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x+uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y-uOffsetY)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y-uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y-uOffsetY)).g;\n\n            float hPass = originColor.g - sum + 0.5;\n            float flag = step(0.5, hPass);\n            vec3 color = mix(max(vec3(0.0), (2.0*hPass + resultColor - 1.0)), min(vec3(1.0), (resultColor + 2.0*hPass - 1.0)), flag);\n\n            gl_FragColor = vec4(mix(resultColor.rgb, color.rgb, _intensity), 1.0);\n        }else{\n            gl_FragColor = originColor;\n        }\n    }"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyBlurShader=void 0,t.beautyBlurShader={vShader:"\n    uniform vec2 size;\n    uniform float isVertical;\n\n    attribute vec4 position;\n    attribute vec2 uv;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n        // 偏移步距\n        vec2 stepOffset = 1.0 / size;\n        if(isVertical> 0.5){\n            stepOffset.x = 0.0;\n        }else{\n            stepOffset.y = 0.0;\n        }\n\n        vTextureShift1 = vec4(uv - stepOffset, uv + stepOffset);\n\t\tvTextureShift2 = vec4(uv- 2.0 * stepOffset, uv + 2.0 * stepOffset);\n\t\tvTextureShift3 = vec4(uv - 3.0 * stepOffset, uv + 3.0 * stepOffset);\n\t\tvTextureShift4 = vec4(uv - 4.0 * stepOffset, uv + 4.0 * stepOffset);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n\n        vec3 sum = color.rgb;\n        sum += texture2D(map, vTextureShift1.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift1.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift2.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift2.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift3.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift3.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift4.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift4.zw).rgb;\n\n        gl_FragColor = vec4(sum * 0.1111, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyHighPassShader=void 0,t.beautyHighPassShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        vec4 blurColor = texture2D(blurMap, vuv);\n        vec3 diffColor = (color.rgb - blurColor.rgb) * 6.0;\n        diffColor = diffColor * diffColor;\n        diffColor = min(diffColor, 1.0);\n        gl_FragColor = vec4(diffColor, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LutFilter=void 0;const r=i(134),s=i(135),a=i(118),n=i(136),o=i(204),d=i(137),c={};class l extends d.Filter{constructor(e,t,i,r){super(e,t,i,r),this.lutImgs={},this.curLutName=null,this.lutMap=a.createTexture(e.gl,null,{flipY:!1});const{program:s,framebuffer:n}=this.initProgramBuffer();this.programs.main=s,this.framebuffers.main=n}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=new s.Program(e);i.setShader(n.baseTextureShader.vShader,"VERTEX"),i.setShader(o.lutShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const a=r.createFrameBuffer(e,t.width,t.height);return i.setUniform("map",this.map),i.setUniform("lut",this.lutMap),i.setUniform("intensity",0),{program:i,framebuffer:a}}getLutImg(e){var t;return e&&null!==(t=this.lutImgs[e])&&void 0!==t?t:null}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}setLutsSrc(e,t){let i=Object.keys(e).length;const r=[],s=()=>{i-=1,i<=0&&(null==t||t(r))};for(const t in e){const{src:i,intensity:n=.5}=e[t];this.lutImgs[t]={img:null,intensity:n},c[t]?(this.lutImgs[t].img=c[t],t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s()):a.retryLoadImage(i,3,(e=>{c[t]=e,this.lutImgs[t].img=e,t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s()}),(()=>{r.push(i),s()}))}}get output(){return this.intensity?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.main;t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh()}setlut(e,t){if(e!==this.curLutName){this.curLutName=e;const t=this.getLutImg(this.curLutName);t&&(this.lutMap.source=t.img,this.lutMap.refresh())}t=null!=t?t:this.intensity,this.intensity=t}get intensity(){const e=this.getLutImg(this.curLutName);return e?e.intensity:0}set intensity(e){const t=this.getLutImg(this.curLutName);t?(t.intensity=e,t.img?this.programs.main.setUniform("intensity",this.intensity):this.programs.main.setUniform("intensity",0)):this.programs.main.setUniform("intensity",0)}render(){this.intensity&&(this.framebuffers.main.bind(),this.renderer.render(this.programs.main))}destroy(){var e;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.lutMap.glTexture)}}t.LutFilter=l},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NormalFilter=void 0;const r=i(134),s=i(135),a=i(136),n=i(137);class o extends n.Filter{constructor(e,t,i,r){super(e,t,i,r),this._srcMap=null,this.pixels=null,this.initProgram()}initProgram(){const e=this.renderer.gl;let t=this.renderer.getSize();const i=new s.Program(e);i.setShader(a.baseTextureShader.vShader,"VERTEX"),i.setShader(a.baseTextureShader.yFlipFShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const n=r.createFrameBuffer(e,t.width,t.height);i.setUniform("map",this._srcMap),this.programs.imgData=i,this.framebuffers.imgData=n;const o=new s.Program(e);o.setShader(a.baseTextureShader.vShader,"VERTEX"),o.setShader(a.baseTextureShader.fShader,"FRAGMENT"),o.setAttributeBuffer(this.posBuffer),o.setAttributeBuffer(this.uvBuffer),o.setUniform("map",this._map),this.programs.main=o}getImageData(e){e!==this._srcMap&&(this._srcMap=e,this.programs.imgData.setUniform("map",this._srcMap)),this._srcMap&&this._srcMap.refresh();const t=this.renderer,{width:i,height:r}=t.getSize(),s=t.gl;return this.framebuffers.imgData.bind(),t.render(this.programs.imgData),this.pixels&&this.pixels.length===i*r*4||(this.pixels=new Uint8Array(i*r*4)),s.readPixels(0,0,i,r,s.RGBA,s.UNSIGNED_BYTE,this.pixels),this.framebuffers.imgData.bind(!0),this.pixels}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.imgData;t&&(t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh())}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=e.gl;e.setViewport(0,0,t,i),r.bindFramebuffer(r.FRAMEBUFFER,null),e.render(this.programs.main)}}t.NormalFilter=o},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.typedArray=void 0,t.typedArray={posArray:new Int8Array([-1,1,-1,-1,1,1,1,-1]),uvArray:new Uint8Array([0,1,0,0,1,1,1,0]),advBeautyPosArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0,0);return e.push(0,0,0,1,1,1,1,0),e})()),advBeautyZindexArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0);return e.push(-1,-1,-1,-1),e})()),advBeautyIndicesArray:new Uint16Array([145,146,147,145,147,148,0,2,52,52,2,57,57,2,4,57,4,73,73,4,80,73,80,56,56,80,55,55,80,43,67,55,43,67,54,55,66,54,67,66,72,54,65,72,66,65,53,72,64,53,65,64,52,53,33,52,64,0,52,33,33,64,34,34,64,65,34,65,35,35,65,66,35,66,36,36,66,67,36,67,37,53,52,57,53,57,73,53,73,72,72,73,56,72,56,54,54,56,55,37,67,43,37,43,38,38,43,68,68,43,58,58,43,81,43,46,81,81,46,83,46,51,83,46,49,51,46,47,49,46,82,47,80,82,46,43,80,46,43,55,80,67,55,43,38,68,39,39,68,69,39,69,40,40,69,70,40,70,41,41,70,71,41,71,42,32,61,30,30,61,62,30,62,28,62,76,28,76,81,28,63,81,76,58,81,63,43,81,58,43,58,68,68,58,59,68,59,69,69,59,75,69,75,70,70,75,60,70,60,71,71,60,61,71,61,42,42,61,32,59,58,63,59,63,76,59,76,75,75,76,62,75,62,60,60,62,61,4,82,80,4,6,82,6,8,82,82,8,84,8,10,84,84,10,12,84,12,95,95,12,14,95,14,94,94,14,93,93,14,16,93,16,18,93,18,92,92,18,20,92,20,91,91,20,90,90,20,22,90,22,24,90,24,83,83,24,26,83,26,28,83,28,81,106,0,33,106,33,34,107,106,34,107,34,35,108,107,35,108,35,36,109,108,36,109,36,37,110,109,37,116,110,37,116,37,38,115,116,38,114,115,38,114,38,39,113,114,39,113,39,40,112,113,40,112,40,41,111,112,41,111,41,42,111,42,32,82,84,47,47,84,85,47,85,86,47,86,49,49,86,87,49,87,88,49,88,51,51,88,89,51,89,90,83,51,90,85,84,96,85,96,97,85,97,86,86,97,87,87,97,98,87,98,99,87,99,88,88,99,89,89,99,100,89,100,90,100,91,90,101,91,100,101,92,91,102,92,101,102,93,92,102,94,93,103,94,102,103,95,94,96,95,103,84,95,96,96,103,97,97,103,102,97,102,98,98,102,99,99,102,101,99,101,100,0,117,118,0,118,2,2,118,119,2,119,4,4,119,120,4,120,6,6,120,121,6,121,8,8,121,122,8,122,10,10,122,123,10,123,12,12,123,124,12,124,14,14,124,125,14,125,16,16,125,126,16,126,18,18,126,127,18,127,20,20,127,128,20,128,22,22,128,129,22,129,24,24,129,130,24,130,26,26,130,131,26,131,28,28,131,132,28,132,30,30,132,133,30,133,32,106,134,117,106,117,0,107,135,134,107,134,106,108,136,135,108,135,107,109,137,136,109,136,108,110,138,137,110,137,109,116,144,138,116,138,110,115,143,144,115,144,116,114,142,143,114,143,115,113,141,142,113,142,114,112,140,141,112,141,113,111,139,140,111,140,112,32,133,139,32,139,111]),advFaceMaskUVArray:new Float32Array([.30859375,.58203125,.30859375,.5546875,.310546875,.52734375,.3125,.5,.314453125,.47265625,.318359375,.4453125,.322265625,.41796875,.330078125,.392578125,.337890625,.369140625,.349609375,.34765625,.365234375,.328125,.380859375,.310546875,.400390625,.296875,.419921875,.28515625,.44140625,.27734375,.46484375,.271484375,.486328125,.26953125,.509765625,.271484375,.533203125,.275390625,.5546875,.283203125,.578125,.29296875,.59765625,.306640625,.6171875,.32421875,.634765625,.341796875,.650390625,.36328125,.662109375,.388671875,.669921875,.4140625,.67578125,.44140625,.6796875,.46875,.68359375,.49609375,.685546875,.525390625,.6875,.552734375,.6875,.580078125,.33984375,.634765625,.36328125,.66796875,.392578125,.673828125,.421875,.671875,.451171875,.6640625,.521484375,.666015625,.55078125,.671875,.58203125,.673828125,.611328125,.666015625,.63671875,.634765625,.486328125,.60546875,.484375,.568359375,.482421875,.533203125,.482421875,.498046875,.443359375,.47265625,.462890625,.46875,.484375,.46484375,.505859375,.470703125,.52734375,.474609375,.369140625,.599609375,.384765625,.611328125,.421875,.611328125,.4375,.59765625,.419921875,.591796875,.384765625,.591796875,.537109375,.59765625,.552734375,.611328125,.591796875,.611328125,.607421875,.59765625,.591796875,.591796875,.5546875,.591796875,.36328125,.646484375,.392578125,.650390625,.421875,.6484375,.451171875,.642578125,.521484375,.642578125,.55078125,.6484375,.580078125,.6484375,.611328125,.64453125,.40234375,.615234375,.400390625,.58984375,.40234375,.6015625,.57421875,.615234375,.57421875,.58984375,.572265625,.6015625,.4609375,.6015625,.51171875,.6015625,.443359375,.521484375,.5234375,.5234375,.431640625,.490234375,.537109375,.4921875,.416015625,.392578125,.44140625,.41796875,.470703125,.427734375,.486328125,.427734375,.5,.4296875,.53125,.419921875,.55859375,.39453125,.537109375,.375,.51171875,.36328125,.484375,.361328125,.4609375,.36328125,.4375,.375,.421875,.392578125,.453125,.408203125,.484375,.412109375,.51953125,.41015625,.552734375,.39453125,.51953125,.388671875,.484375,.38671875,.453125,.38671875,.40234375,.599609375,.57421875,.599609375,.3046875,.634765625,.31640625,.685546875,.341796875,.734375,.380859375,.7734375,.431640625,.802734375,.6875,.638671875,.671875,.693359375,.642578125,.7421875,.599609375,.78125,.546875,.806640625,.48828125,.81640625,.25390625,.576171875,.2578125,.50390625,.26171875,.43359375,.271484375,.36328125,.29296875,.298828125,.328125,.24609375,.373046875,.205078125,.427734375,.1796875,.486328125,.169921875,.546875,.177734375,.60546875,.19921875,.65625,.240234375,.69921875,.291015625,.724609375,.357421875,.736328125,.427734375,.744140625,.501953125,.74609375,.57421875,.25,.64453125,.263671875,.7109375,.296875,.7734375,.34765625,.82421875,.4140625,.86328125,.74609375,.650390625,.7265625,.720703125,.689453125,.783203125,.6328125,.833984375,.564453125,.8671875,.48828125,.880859375,0,0,0,0,0,0,0,0]),advEyeTeethPosArray:new Int16Array(48),advEyeTeethZindexArray:new Int16Array(24),advEyeTeethUVArray:new Float32Array([.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.067,.28,.267,.389,.512,.364,.754,.389,.933,.29,.76,.159,.497,.112,.243,.156]),advEyeTeethIndicesArray:new Uint16Array([1,0,7,1,7,6,1,6,2,2,6,5,2,5,3,3,5,4,11,12,13,11,13,14,11,14,10,10,14,15,10,15,9,9,15,8,16,23,17,17,23,22,17,22,18,18,22,19,19,22,21,19,21,20]),advForeheadPosArray:new Int16Array(98),advForeheadZindexArray:new Int16Array(49),advForeheadUVArray:new Float32Array([.12,.564,.181,.619,.26,.628,.341,.616,.41,.592,.597,.592,.666,.616,.747,.628,.827,.619,.887,.564,.051,.638,.101,.753,.154,.853,.236,.933,.355,.955,.504,.956,.652,.955,.771,.933,.853,.853,.907,.753,.956,.638,.155,.266,.281,.306,.441,.371,.598,.395,.694,.334,.763,.247,.134,.379,.242,.427,.401,.49,.604,.522,.749,.455,.87,.3,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11]),advForeheadIndicesArray:new Uint16Array([18,0,1,11,18,1,11,1,2,12,11,2,12,2,3,13,12,3,13,3,4,14,13,4,14,4,15,15,4,5,16,15,5,17,16,5,17,5,6,17,6,18,18,6,7,19,18,7,19,7,8,20,19,8,20,8,9,27,21,28,28,21,22,29,28,22,29,22,23,30,29,23,30,23,24,31,30,24,31,24,25,32,31,25,32,25,26])}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualBackFilter=void 0;const r=i(134),s=i(328),a=i(135),n=i(118),o=i(136),d=i(329),c=i(330),l=i(137);class u extends l.Filter{constructor(e,t,i,r){super(e,t,i,r),this.intensity=.1,this.lastSetInfo={},this.sourceMap=t,this.maskMap=n.createTexture(e.gl,null),this.bkColor=new s.GlColor("#e7ad3c"),this.bkMap=n.createTexture(e.gl,null),this.initProgramBuffer()}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=[n.toNthPower(t.width),n.toNthPower(t.height)],s=new a.Program(e);s.setShader(o.baseTextureShader.vShader,"VERTEX"),s.setShader(o.baseTextureShader.fShader,"FRAGMENT"),s.setAttributeBuffer(this.posBuffer),s.setAttributeBuffer(this.uvBuffer);const l=r.createFrameBuffer(e,i[0],i[1],!0);s.setUniform("map",this.sourceMap),this.programs.mip=s,this.framebuffers.mip=l;const u=new a.Program(e);u.setShader(o.baseTextureShader.vShader,"VERTEX"),u.setShader(d.mipMapBlurShader.fShader,"FRAGMENT"),u.setAttributeBuffer(this.posBuffer),u.setAttributeBuffer(this.uvBuffer);const h=r.createFrameBuffer(e,t.width,t.height);u.setUniform("map",l.targetTexture),u.setUniform("radius",.25*Math.max(t.width,t.height)),u.setUniform("intensity",.1),this.programs.blur=u,this.framebuffers.blur=h;const p=new a.Program(e);p.setShader(o.baseTextureShader.vShader,"VERTEX"),p.setShader(c.virtualBackShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.posBuffer),p.setAttributeBuffer(this.uvBuffer);const m=r.createFrameBuffer(e,t.width,t.height);p.setUniform("map",this.map),p.setUniform("maskMap",this.maskMap),p.setUniform("backColor",this.bkColor.value),p.setUniform("backMap",this.bkMap),p.setUniform("size",[t.width,t.height]),p.setUniform("bkSize",[0,0]),p.setUniform("backType",0),p.setUniform("emptyFrame",0),this.programs.main=p,this.framebuffers.main=m}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}set emptyFrame(e){this.programs.main.setUniform("emptyFrame",e?1:0)}setMaskMap(e){const t=this.maskMap;t&&(t.source=e,t.refresh())}setBkColor(e){this.bkColor.setValue(e||"#e7ad3c"),this.programs.main.setUniform("backColor",this.bkColor.value)}getBkInfo(){const e=this.bkMap,t=e?e.source:null,i={type:"color",size:[0,0]};return t&&("videoWidth"in t?(i.type="video",i.size=[t.videoWidth,t.videoHeight]):t instanceof Image&&(i.type="image",i.size=[t.naturalWidth,t.naturalHeight])),i}setBkMap(e){const t=this.bkMap;t&&(e instanceof Image||null===e?(t.source=e,t.refresh()):"readyState"in e&&(e.readyState<2?setTimeout((()=>{this.setBkMap(e)}),16.7):(t.source=e,t.refresh())))}setBackground(e){const t=typeof e;"string"===t||null===e?(this.setBkColor(e),this.setBkMap(null)):"object"===t&&(this.setBkColor(null),this.setBkMap(e));const i=this.getBkInfo();this.programs.main.setUniform("backType","color"===i.type?0:1),"color"!==i.type&&(this.programs.main.setUniform("backMap",this.bkMap),this.programs.main.setUniform("bkSize",i.size)),this.lastSetInfo={type:"bk",value:e}}setBlurIntensity(e){const t=this.renderer.getSize();e=Math.max(.1,Math.min(1,e)),this.programs.blur.setUniform("intensity",e),this.programs.main.setUniform("backMap",this.framebuffers.blur.targetTexture),this.programs.main.setUniform("bkSize",[t.width,t.height]),this.programs.main.setUniform("backType",1),this.lastSetInfo={type:"blur",value:e}}get output(){return this.maskMap&&this.maskMap.source?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[n.toNthPower(e.width),n.toNthPower(e.height)];["blur","main"].forEach((t=>{const i=this.framebuffers[t];i.targetTexture.opts.width=e.width,i.targetTexture.opts.height=e.height,i.targetTexture.refresh()}));const i=this.framebuffers.mip;i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),this.programs.main.setUniform("size",[e.width,e.height]),this.programs.blur.setUniform("radius",.25*Math.max(e.width,e.height)),this.programs.main.getUniform("backMap").value===i.targetTexture&&this.programs.main.setUniform("bkSize",t)}render(){var e;if(this.maskMap&&this.maskMap.source){const t=this.renderer;if(this.programs.main.getUniform("backMap").value===this.framebuffers.blur.targetTexture){const e=t.getSize(),i=this.framebuffers.mip.targetTexture;t.setViewport(0,0,i.opts.width,i.opts.height),this.framebuffers.mip.bind(),this.programs.mip.render(),this.framebuffers.mip.targetTexture.updateMipMap(),t.setViewport(0,0,e.width,e.height),this.framebuffers.blur.bind(),this.programs.blur.render()}else"video"===this.getBkInfo().type&&(null===(e=this.bkMap)||void 0===e||e.refresh());this.framebuffers.main.bind(),this.programs.main.render()}}destroy(){var e,t;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.maskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.bkMap.glTexture)}}t.VirtualBackFilter=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.GlColor=void 0,t.GlColor=class{constructor(e){this._color=[1,1,1,1],this.convert(e)}convert(e){if("string"==typeof e){if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/i.test(e)){if(4===e.length){let t="#";for(let i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t}const t=[];for(let i=1;i<7;i+=2)t.push(parseInt("0x"+e.slice(i,i+2)));return void this.convert(t)}console.error(`color:[${e}] format is error.`)}else this._color=e.map(((e,t)=>t<3?Math.min(Math.max(Number(e),0),255)/255:Math.min(Math.max(Number(Number(null!=e?e:1)),0),1)))}get value(){return this._color}setValue(e){this.convert(e)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.mipMapBlurShader=void 0,t.mipMapBlurShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform float intensity;\n    uniform float radius;\n    varying vec2 vuv;\n\n    float weight(float t, float log2radius, float gamma)\n    {\n        return exp(-gamma*pow(log2radius-t,2.));\n    }\n\n    vec3 sample_blured(vec2 uv, float radius, float gamma)\n    {\n        vec3 pix = vec3(0.);\n        float norm = 0.;\n        for(float i = 0.; i < 10.; i += 0.5)\n        {\n            float k = weight(i, log2(radius), gamma);\n            pix += k * texture2D(map, uv, i).rgb;\n            norm += k;\n        }\n        return pix*pow(norm,-0.95);\n    }\n\n    void main() {\n        gl_FragColor = vec4(sample_blured(vuv, mix(8.0, radius, intensity), intensity), 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.virtualBackShader=void 0,t.virtualBackShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform sampler2D backMap;\n    uniform vec3 backColor;\n    uniform vec2 size;\n    uniform vec2 bkSize;\n    uniform int backType;\n    uniform int emptyFrame;\n\n    varying vec2 vuv;\n\n    void main() {\n        if(emptyFrame > 0){\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }else{\n            vec3 color = texture2D(map, vuv).rgb;\n            float alpha = texture2D(maskMap, vuv).a;\n\n            vec3 bk = backColor;\n            // 背景图\n            if(backType == 1){\n                float ratio = size.x / size.y;\n                float bkRatio = bkSize.x / bkSize.y;\n                vec2 suv = vuv;\n                if(ratio > bkRatio){\n                    suv.y = (suv.y - 0.5) * bkRatio / ratio + 0.5;\n                }else{\n                    suv.x = (suv.x - 0.5) * ratio / bkRatio + 0.5;\n                }\n                bk = texture2D(backMap, suv).rgb;\n            }\n\n            gl_FragColor = vec4(mix(bk, color, alpha), 1.0);\n        }\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(11),s=i(203);class a extends r.EventEmitter{constructor(e){var t;super(),this.setAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log(`set advbeauty effect：[${e[0]}, ${e[1]}]`),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.setAdvEffect(...e))},this.presetAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log("preset advbeauty effect："+JSON.stringify(e[0])),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.presetAdvEffect(...e))},this.videPostProcess=e,null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.on("advBeautyResComplete",(e=>{this.videPostProcess.emit("advBeautyResComplete",e)}))}get advancedBeautyProcess(){const e=this.videPostProcess.getPlugin("AdvancedBeauty");return e||this.logger.error("Can not get AdvancedBeauty plugin"),e}init(e){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.on("facePoints-load",(()=>{this.emit("facePoints-load"),this.advancedBeautyProcess.setFaceSize(Math.min(5,Math.max(1,e||1)))})),this.advancedBeautyProcess.init())}destroy(){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.removeAllListeners(),this.advancedBeautyProcess.destroy())}get logger(){return this.videPostProcess.logger}setTrack(e,t){var i;return e&&a.configStaticRes(s.resSet,null===(i=this.videPostProcess.filters)||void 0===i?void 0:i.advBeauty),new Promise(((i,r)=>{this.videPostProcess.setTaskAndTrack("AdvancedBeauty",e,t).then((t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.advBeauty.setAdvData([]),i(t)})).catch((e=>{r(e)}))}))}get isEnable(){return this.videPostProcess.hasTask("AdvancedBeauty")}}t.default=a,a.configStaticRes=(e,t)=>{s.AdvBeautyFilter.configStaticRes(e,t)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r={beauty:{whiten:"https://yx-web-nosdn.netease.im/common/cab8e4f0696d3d8e29ee10d6dccc1204/meibai.png",redden:"https://yx-web-nosdn.netease.im/common/c614e2af82da88807067926d7ff3be3d/hongrun.png"},filters:{ziran:{src:"https://yx-web-nosdn.netease.im/common/c89328281947fceabdc71d5fa08b2345/ziran.png",intensity:1},baixi:{src:"https://yx-web-nosdn.netease.im/common/3a22a55384b0bd5b07fca3509bfc981a/baixi.png",intensity:.5},fennen:{src:"https://yx-web-nosdn.netease.im/common/db5befdae1f46dad2e5a6d702bad19ea/fennen.png",intensity:.5},weimei:{src:"https://yx-web-nosdn.netease.im/common/cf8bfec70d7998bb0033757276c6559a/weimei.png",intensity:.5},langman:{src:"https://yx-web-nosdn.netease.im/common/1c50a14532bfa3ad503a82ddd13f0ec8/langman.png",intensity:.5},rixi:{src:"https://yx-web-nosdn.netease.im/common/c414819383913b5db0d9b686276e3d57/rixi.png",intensity:.5},landiao:{src:"https://yx-web-nosdn.netease.im/common/4c77522852dc14448603be21abc571c8/landiao.png",intensity:.5},qingliang:{src:"https://yx-web-nosdn.netease.im/common/1150e94f831d24148239001588a7ca7d/qingliang.png",intensity:.5},huaijiu:{src:"https://yx-web-nosdn.netease.im/common/6a38caeab164d1b5cc086391d6a11a74/huaijiu.png",intensity:.5},qingcheng:{src:"https://yx-web-nosdn.netease.im/common/3b3332c5ae4306312b6f3c4c552a464a/qingcheng.png",intensity:1},wuhou:{src:"https://yx-web-nosdn.netease.im/common/200fc7a12177774f4eb23f55d72643ee/wuhou.png",intensity:1},zhigan:{src:"https://yx-web-nosdn.netease.im/common/848bd44506cf8e10ecabf564e3d74809/zhigan.png",intensity:1},mopian:{src:"https://yx-web-nosdn.netease.im/common/c454efa119520f0793ce51327951ed0a/mopian.png",intensity:1},dianying:{src:"https://yx-web-nosdn.netease.im/common/3a6a22adad29c5844fc829f4f889a79f/dianying.png",intensity:1},heibai:{src:"https://yx-web-nosdn.netease.im/common/941270f2948218ea19f2d79db5e7d349/heibai.png",intensity:1}}},s=new Set;t.default=class{constructor(e){this.lutLoaded=!1,this.videPostProcess=e,this.videPostProcess.on("contextLost",(()=>{this.lutLoaded=!1})),s.add(this)}startLut(){if(this.lutLoaded)return;const e=this.videPostProcess.filters;if(!e)return;let t=2;const i=[],s=()=>{t-=1,t<=0&&this.videPostProcess.emit("beautyResComplete",i)};e.beauty.setLutsSrc(r.beauty,(e=>{i.push(...e),s()})),e.lut.setLutsSrc(r.filters,(e=>{i.push(...e),s()})),this.lutLoaded=!0}setFilter(e,t){var i;null===(i=this.videPostProcess.filters)||void 0===i||i.lut.setlut(e,t)}setBeauty(e,t){return e&&this.startLut(),new Promise(((i,r)=>{this.videPostProcess.setTaskAndTrack("BasicBeauty",e,t).then((t=>{if(!e){const e=this.videPostProcess.filters;if(!e)return;e.beauty.whiten=0,e.beauty.redden=0,e.beauty.smooth=0,e.lut.setlut(null)}i(t)})).catch((e=>{r(e)}))}))}setBeautyOptions(e){const t=this.videPostProcess.filters;t&&("smoothnessLevel"in e&&(t.beauty.smooth=e.smoothnessLevel),"brightnessLevel"in e&&(t.beauty.whiten=e.brightnessLevel),"rednessLevel"in e&&(t.beauty.redden=e.rednessLevel))}get isEnable(){return this.videPostProcess.hasTask("BasicBeauty")}static configStaticRes(e){let t=!1;e.beauty&&(r.beauty=Object.assign({},e.beauty),t=!0),e.filters&&(r.filters=Object.assign({},e.filters),t=!0),t&&s.forEach((e=>{try{e.lutLoaded=!1,e.startLut()}catch(e){}}))}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(11),s=i(118);class a extends r.EventEmitter{constructor(e){super(),this.bgOption={type:"color",color:"#e7ad3c"},this.videPostProcess=e}get segmentProcess(){return this.videPostProcess.getPlugin("VirtualBackground")}init(){this.segmentProcess.on("segment-load",(()=>{this.emit("segment-load")})),this.segmentProcess.init()}destroy(){this.segmentProcess.removeAllListeners(),this.segmentProcess.destroy()}setVirtualBackGround(e){switch(this.bgOption=e,t){case"image":const{source:t}=e;if("object"==typeof t)this.setBackGround(t);else if("string"==typeof t)if(t.includes("data:image")){const e=new Image;e.onload=()=>{this.setBackGround(e)},e.src=t}else if(t.includes("http"))s.loadImage(t,(e=>{this.setBackGround(e)}));else{const e=new Image;e.onload=()=>{this.setBackGround(e)},e.src=t}break;case"color":this.setBackGround(e.color);break;case"blur":this.setBlurIntensity(e.level/10)}}setTrack(e,t){return new Promise(((i,r)=>{this.videPostProcess.setTaskAndTrack("VirtualBackground",e,t).then((t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.virtualBackground.setMaskMap(null),i(t)})).catch((e=>{r(e)}))}))}setBackGround(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBackground(e)}setBlurIntensity(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBlurIntensity(e)}get isEnable(){return this.videPostProcess.hasTask("VirtualBackground")}set emptyFrame(e){this.videPostProcess.filters.virtualBackground.emptyFrame=e}}t.default=a},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loadPlugin=void 0;const s=r(i(205));t.loadPlugin=function(e,t){return new Promise(((i,r)=>{-1==s.default.indexOf(e)&&r("unsupport plugin "+e);const a=document.createElement("script");a.defer=!0,a.src=t,document.body.appendChild(a),a.onload=function(){i()},a.onerror=function(e){r(`Load plugin ${t} error`)}}))}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.applyResolution=void 0,t.applyResolution=async function(e){const{track:t,targetWidth:i,targetHeight:r,keepAspectRatio:s,logger:a}=e;let n;if(n="getSettings"in MediaStreamTrack.prototype?t.getSettings():t.getConstraints(),n.width&&n.height)if(n.width!==i||n.height!==r){let e;s?(e={aspectRatio:n.width/n.height},n.width/n.height>=i/r?e.width=i:e.height=r):e={width:i,height:r},await t.applyConstraints(e),await new Promise((e=>{setTimeout(e,100)}));const o=t.getSettings();n.width!==o.width||n.height!==o.height?a.log(`applyResolution 成功修改分辨率 保留长宽比：${s} ${n.width}x${n.height} => ${o.width}x${o.height} (constraints: ${JSON.stringify(e)})【${t.label}】`):a.warn(`applyResolution 无法修改分辨率为${i}x${r}，目前的分辨率：${n.width}x${n.height} (constraints: ${JSON.stringify(e)})【${t.label}】`)}else a.log(`applyResolution 无需修改分辨率 ${n.width}x${n.height} 【${t.label}】`);else a.log(`applyResolution 摄像头不支持动态修改分辨率 【${t.label}】`)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.webassemblySupported=void 0,t.webassemblySupported=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return!1}return!1}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioProfile=void 0,t.AudioProfile=["speech_low_quality","speech_standard","music_standard","standard_stereo","high_quality","high_quality_stereo"]},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.serverError=t.clientNotYetPublished=t.STREAM_HAS_NO_MEDIA_ATTRIBUTES=t.clientNotYetUninitialized=t.invalidArguments=t.ok=void 0,t.ok={name:"OK",code:200,desc:"success"},t.invalidArguments={name:"invalid arguments",code:1,desc:"请检查参数的有效性"},t.clientNotYetUninitialized={name:"client not yet uninitialized",code:2,desc:"请先调用createClient创建Client"},t.STREAM_HAS_NO_MEDIA_ATTRIBUTES={name:"STREAM_HAS_NO_MEDIA_ATTRIBUTES",code:10,desc:"stream不合法，没有audio、video或者screen属性"},t.clientNotYetPublished={name:"client not yet published",code:11,desc:"请先publish"},t.serverError={name:"server error code",code:414,desc:""}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LIVE_STREAM_AUDIO_CODEC_PROFILE=t.LIVE_STREAM_AUDIO_SAMPLE_RATE=void 0,t.LIVE_STREAM_AUDIO_SAMPLE_RATE={SAMPLE_RATE_32000:32e3,SAMPLE_RATE_44100:44100,SAMPLE_RATE_48000:48e3},t.LIVE_STREAM_AUDIO_CODEC_PROFILE={LC_AAC:0,HE_AAC:1}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NETWORK_STATUS=void 0,t.NETWORK_STATUS={0:"UNKNOWN",1:"EXCELLENT",2:"GOOD",3:"POOR",4:"BAD",5:"VERYBAD",6:"DOWN"}}])},module.exports=t()})),NERTC$1=unwrapExports(NERTC),SignalControllerCallingStatus;NERTC.NERTC,function(e){e[e.idle=0]="idle",e[e.calling=1]="calling",e[e.called=2]="called",e[e.inCall=3]="inCall"}(SignalControllerCallingStatus||(SignalControllerCallingStatus={}));var eventemitter3=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(e,t,r,a,n){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,n),d=i?i+t:t;return e._events[d]?e._events[d].fn?e._events[d]=[e._events[d],o]:e._events[d].push(o):(e._events[d]=o,e._eventsCount++),e}function n(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,n=new Array(a);s<a;s++)n[s]=r[s].fn;return n},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,n){var o=i?i+e:e;if(!this._events[o])return!1;var d,c,l=this._events[o],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,s),!0;case 5:return l.fn.call(l.context,t,r,s,a),!0;case 6:return l.fn.call(l.context,t,r,s,a,n),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var h,p=l.length;for(c=0;c<p;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,r);break;case 4:l[c].fn.call(l[c].context,t,r,s);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d)}}return!0},o.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,s){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return n(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||n(this,a);else{for(var d=0,c=[],l=o.length;d<l;d++)(o[d].fn!==t||s&&!o[d].once||r&&o[d].context!==r)&&c.push(o[d]);c.length?this._events[a]=1===c.length?c[0]:c:n(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&n(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o})),EventEmitter=eventemitter3,bind$1=function(e,t){return function(){for(var i=new Array(arguments.length),r=0;r<i.length;r++)i[r]=arguments[r];return e.apply(t,i)}},bind=bind$1,toString=Object.prototype.toString,kindOf=(cache=Object.create(null),function(e){var t=toString.call(e);return cache[t]||(cache[t]=t.slice(8,-1).toLowerCase())}),cache;function kindOfTest(e){return e=e.toLowerCase(),function(t){return kindOf(t)===e}}function isArray(e){return Array.isArray(e)}function isUndefined(e){return void 0===e}function isBuffer(e){return null!==e&&!isUndefined(e)&&null!==e.constructor&&!isUndefined(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}var isArrayBuffer=kindOfTest("ArrayBuffer");function isArrayBufferView(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&isArrayBuffer(e.buffer)}function isString(e){return"string"==typeof e}function isNumber(e){return"number"==typeof e}function isObject(e){return null!==e&&"object"==typeof e}function isPlainObject(e){if("object"!==kindOf(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}var isDate=kindOfTest("Date"),isFile=kindOfTest("File"),isBlob=kindOfTest("Blob"),isFileList=kindOfTest("FileList");function isFunction(e){return"[object Function]"===toString.call(e)}function isStream(e){return isObject(e)&&isFunction(e.pipe)}function isFormData(e){var t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||toString.call(e)===t||isFunction(e.toString)&&e.toString()===t)}var isURLSearchParams=kindOfTest("URLSearchParams");function trim(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function isStandardBrowserEnv(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),isArray(e))for(var i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.call(null,e[s],s,e)}function merge(){var e={};function t(t,i){isPlainObject(e[i])&&isPlainObject(t)?e[i]=merge(e[i],t):isPlainObject(t)?e[i]=merge({},t):isArray(t)?e[i]=t.slice():e[i]=t}for(var i=0,r=arguments.length;i<r;i++)forEach(arguments[i],t);return e}function extend(e,t,i){return forEach(t,(function(t,r){e[r]=i&&"function"==typeof t?bind(t,i):t})),e}function stripBOM(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}function inherits(e,t,i,r){e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,i&&Object.assign(e.prototype,i)}function toFlatObject(e,t,i){var r,s,a,n={};t=t||{};do{for(s=(r=Object.getOwnPropertyNames(e)).length;s-- >0;)n[a=r[s]]||(t[a]=e[a],n[a]=!0);e=Object.getPrototypeOf(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t}function endsWith(e,t,i){e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;var r=e.indexOf(t,i);return-1!==r&&r===i}function toArray(e){if(!e)return null;var t=e.length;if(isUndefined(t))return null;for(var i=new Array(t);t-- >0;)i[t]=e[t];return i}var isTypedArray=(TypedArray="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(e){return TypedArray&&e instanceof TypedArray}),TypedArray,utils$1={isArray:isArray,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString,isNumber:isNumber,isObject:isObject,isPlainObject:isPlainObject,isUndefined:isUndefined,isDate:isDate,isFile:isFile,isBlob:isBlob,isFunction:isFunction,isStream:isStream,isURLSearchParams:isURLSearchParams,isStandardBrowserEnv:isStandardBrowserEnv,forEach:forEach,merge:merge,extend:extend,trim:trim,stripBOM:stripBOM,inherits:inherits,toFlatObject:toFlatObject,kindOf:kindOf,kindOfTest:kindOfTest,endsWith:endsWith,toArray:toArray,isTypedArray:isTypedArray,isFileList:isFileList},utils=utils$1;function encode(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var buildURL$1=function(e,t,i){if(!t)return e;var r;if(i)r=i(t);else if(utils.isURLSearchParams(t))r=t.toString();else{var s=[];utils.forEach(t,(function(e,t){null!=e&&(utils.isArray(e)?t+="[]":e=[e],utils.forEach(e,(function(e){utils.isDate(e)?e=e.toISOString():utils.isObject(e)&&(e=JSON.stringify(e)),s.push(encode(t)+"="+encode(e))})))})),r=s.join("&")}if(r){var a=e.indexOf("#");-1!==a&&(e=e.slice(0,a)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e};function InterceptorManager$1(){this.handlers=[]}InterceptorManager$1.prototype.use=function(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},InterceptorManager$1.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},InterceptorManager$1.prototype.forEach=function(e){utils.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var InterceptorManager_1=InterceptorManager$1,normalizeHeaderName$1=function(e,t){utils.forEach(e,(function(i,r){r!==t&&r.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[r])}))};function AxiosError(e,t,i,r,s){Error.call(this),this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),r&&(this.request=r),s&&(this.response=s)}utils.inherits(AxiosError,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var prototype=AxiosError.prototype,descriptors={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(e){descriptors[e]={value:e}})),Object.defineProperties(AxiosError,descriptors),Object.defineProperty(prototype,"isAxiosError",{value:!0}),AxiosError.from=function(e,t,i,r,s,a){var n=Object.create(prototype);return utils.toFlatObject(e,n,(function(e){return e!==Error.prototype})),AxiosError.call(n,e.message,t,i,r,s),n.name=e.name,a&&Object.assign(n,a),n};var AxiosError_1=AxiosError,transitional={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function toFormData(e,t){t=t||new FormData;var i=[];function r(e){return null===e?"":utils.isDate(e)?e.toISOString():utils.isArrayBuffer(e)||utils.isTypedArray(e)?"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}return function e(s,a){if(utils.isPlainObject(s)||utils.isArray(s)){if(-1!==i.indexOf(s))throw Error("Circular reference detected in "+a);i.push(s),utils.forEach(s,(function(i,s){if(!utils.isUndefined(i)){var n,o=a?a+"."+s:s;if(i&&!a&&"object"==typeof i)if(utils.endsWith(s,"{}"))i=JSON.stringify(i);else if(utils.endsWith(s,"[]")&&(n=utils.toArray(i)))return void n.forEach((function(e){!utils.isUndefined(e)&&t.append(o,r(e))}));e(i,o)}})),i.pop()}else t.append(a,r(s))}(e),t}transitional.silentJSONParsing,transitional.forcedJSONParsing,transitional.clarifyTimeoutError;var toFormData_1=toFormData,require$$5=AxiosError_1,settle$1=function(e,t,i){var r=i.config.validateStatus;i.status&&r&&!r(i.status)?t(new require$$5("Request failed with status code "+i.status,[require$$5.ERR_BAD_REQUEST,require$$5.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)},cookies$1=utils.isStandardBrowserEnv()?{write:function(e,t,i,r,s,a){var n=[];n.push(e+"="+encodeURIComponent(t)),utils.isNumber(i)&&n.push("expires="+new Date(i).toGMTString()),utils.isString(r)&&n.push("path="+r),utils.isString(s)&&n.push("domain="+s),!0===a&&n.push("secure"),document.cookie=n.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},isAbsoluteURL$1=function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)},combineURLs$1=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e},isAbsoluteURL=isAbsoluteURL$1,combineURLs=combineURLs$1,buildFullPath$1=function(e,t){return e&&!isAbsoluteURL(t)?combineURLs(e,t):t},ignoreDuplicateOf=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],parseHeaders$1=function(e){var t,i,r,s={};return e?(utils.forEach(e.split("\n"),(function(e){if(r=e.indexOf(":"),t=utils.trim(e.substr(0,r)).toLowerCase(),i=utils.trim(e.substr(r+1)),t){if(s[t]&&ignoreDuplicateOf.indexOf(t)>=0)return;s[t]="set-cookie"===t?(s[t]?s[t]:[]).concat([i]):s[t]?s[t]+", "+i:i}})),s):s},isURLSameOrigin$1=utils.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function r(e){var r=e;return t&&(i.setAttribute("href",r),r=i.href),i.setAttribute("href",r),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return e=r(window.location.href),function(t){var i=utils.isString(t)?r(t):t;return i.protocol===e.protocol&&i.host===e.host}}():function(){return!0};function CanceledError(e){require$$5.call(this,null==e?"canceled":e,require$$5.ERR_CANCELED),this.name="CanceledError"}utils.inherits(CanceledError,require$$5,{__CANCEL__:!0});var CanceledError_1=CanceledError,parseProtocol$1=function(e){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""},settle=settle$1,cookies=cookies$1,buildURL=buildURL$1,buildFullPath=buildFullPath$1,parseHeaders=parseHeaders$1,isURLSameOrigin=isURLSameOrigin$1,transitionalDefaults=transitional,require$$0$1=CanceledError_1,parseProtocol=parseProtocol$1,xhr=function(e){return new Promise((function(t,i){var r,s=e.data,a=e.headers,n=e.responseType;function o(){e.cancelToken&&e.cancelToken.unsubscribe(r),e.signal&&e.signal.removeEventListener("abort",r)}utils.isFormData(s)&&utils.isStandardBrowserEnv()&&delete a["Content-Type"];var d=new XMLHttpRequest;if(e.auth){var c=e.auth.username||"",l=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";a.Authorization="Basic "+btoa(c+":"+l)}var u=buildFullPath(e.baseURL,e.url);function h(){if(d){var r="getAllResponseHeaders"in d?parseHeaders(d.getAllResponseHeaders()):null,s={data:n&&"text"!==n&&"json"!==n?d.response:d.responseText,status:d.status,statusText:d.statusText,headers:r,config:e,request:d};settle((function(e){t(e),o()}),(function(e){i(e),o()}),s),d=null}}if(d.open(e.method.toUpperCase(),buildURL(u,e.params,e.paramsSerializer),!0),d.timeout=e.timeout,"onloadend"in d?d.onloadend=h:d.onreadystatechange=function(){d&&4===d.readyState&&(0!==d.status||d.responseURL&&0===d.responseURL.indexOf("file:"))&&setTimeout(h)},d.onabort=function(){d&&(i(new require$$5("Request aborted",require$$5.ECONNABORTED,e,d)),d=null)},d.onerror=function(){i(new require$$5("Network Error",require$$5.ERR_NETWORK,e,d,d)),d=null},d.ontimeout=function(){var t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",r=e.transitional||transitionalDefaults;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(new require$$5(t,r.clarifyTimeoutError?require$$5.ETIMEDOUT:require$$5.ECONNABORTED,e,d)),d=null},utils.isStandardBrowserEnv()){var p=(e.withCredentials||isURLSameOrigin(u))&&e.xsrfCookieName?cookies.read(e.xsrfCookieName):void 0;p&&(a[e.xsrfHeaderName]=p)}"setRequestHeader"in d&&utils.forEach(a,(function(e,t){void 0===s&&"content-type"===t.toLowerCase()?delete a[t]:d.setRequestHeader(t,e)})),utils.isUndefined(e.withCredentials)||(d.withCredentials=!!e.withCredentials),n&&"json"!==n&&(d.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&d.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&d.upload&&d.upload.addEventListener("progress",e.onUploadProgress),(e.cancelToken||e.signal)&&(r=function(e){d&&(i(!e||e&&e.type?new require$$0$1:e),d.abort(),d=null)},e.cancelToken&&e.cancelToken.subscribe(r),e.signal&&(e.signal.aborted?r():e.signal.addEventListener("abort",r))),s||(s=null);var m=parseProtocol(u);m&&-1===["http","https","file"].indexOf(m)?i(new require$$5("Unsupported protocol "+m+":",require$$5.ERR_BAD_REQUEST,e)):d.send(s)}))},_null=null,normalizeHeaderName=normalizeHeaderName$1,require$$4=toFormData_1,require$$1$1=xhr,require$$2$1=_null,DEFAULT_CONTENT_TYPE={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset(e,t){!utils.isUndefined(e)&&utils.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}function getDefaultAdapter(){var e;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(e=require$$1$1),e}function stringifySafely(e,t,i){if(utils.isString(e))try{return(t||JSON.parse)(e),utils.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(i||JSON.stringify)(e)}var defaults$1={transitional:transitionalDefaults,adapter:getDefaultAdapter(),transformRequest:[function(e,t){if(normalizeHeaderName(t,"Accept"),normalizeHeaderName(t,"Content-Type"),utils.isFormData(e)||utils.isArrayBuffer(e)||utils.isBuffer(e)||utils.isStream(e)||utils.isFile(e)||utils.isBlob(e))return e;if(utils.isArrayBufferView(e))return e.buffer;if(utils.isURLSearchParams(e))return setContentTypeIfUnset(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString();var i,r=utils.isObject(e),s=t&&t["Content-Type"];if((i=utils.isFileList(e))||r&&"multipart/form-data"===s){var a=this.env&&this.env.FormData;return require$$4(i?{"files[]":e}:e,a&&new a)}return r||"application/json"===s?(setContentTypeIfUnset(t,"application/json"),stringifySafely(e)):e}],transformResponse:[function(e){var t=this.transitional||defaults$1.transitional,i=t&&t.silentJSONParsing,r=t&&t.forcedJSONParsing,s=!i&&"json"===this.responseType;if(s||r&&utils.isString(e)&&e.length)try{return JSON.parse(e)}catch(e){if(s){if("SyntaxError"===e.name)throw require$$5.from(e,require$$5.ERR_BAD_RESPONSE,this,null,this.response);throw e}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:require$$2$1},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};utils.forEach(["delete","get","head"],(function(e){defaults$1.headers[e]={}})),utils.forEach(["post","put","patch"],(function(e){defaults$1.headers[e]=utils.merge(DEFAULT_CONTENT_TYPE)}));var defaults_1=defaults$1,defaults=defaults_1,transformData$1=function(e,t,i){var r=this||defaults;return utils.forEach(i,(function(i){e=i.call(r,e,t)})),e},isCancel=function(e){return!(!e||!e.__CANCEL__)},transformData=transformData$1,require$$2=isCancel;function throwIfCancellationRequested(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new require$$0$1}var dispatchRequest$1=function(e){return throwIfCancellationRequested(e),e.headers=e.headers||{},e.data=transformData.call(e,e.data,e.headers,e.transformRequest),e.headers=utils.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),utils.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||defaults.adapter)(e).then((function(t){return throwIfCancellationRequested(e),t.data=transformData.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return require$$2(t)||(throwIfCancellationRequested(e),t&&t.response&&(t.response.data=transformData.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},mergeConfig$1=function(e,t){t=t||{};var i={};function r(e,t){return utils.isPlainObject(e)&&utils.isPlainObject(t)?utils.merge(e,t):utils.isPlainObject(t)?utils.merge({},t):utils.isArray(t)?t.slice():t}function s(i){return utils.isUndefined(t[i])?utils.isUndefined(e[i])?void 0:r(void 0,e[i]):r(e[i],t[i])}function a(e){if(!utils.isUndefined(t[e]))return r(void 0,t[e])}function n(i){return utils.isUndefined(t[i])?utils.isUndefined(e[i])?void 0:r(void 0,e[i]):r(void 0,t[i])}function o(i){return i in t?r(e[i],t[i]):i in e?r(void 0,e[i]):void 0}var d={url:a,method:a,data:a,baseURL:n,transformRequest:n,transformResponse:n,paramsSerializer:n,timeout:n,timeoutMessage:n,withCredentials:n,adapter:n,responseType:n,xsrfCookieName:n,xsrfHeaderName:n,onUploadProgress:n,onDownloadProgress:n,decompress:n,maxContentLength:n,maxBodyLength:n,beforeRedirect:n,transport:n,httpAgent:n,httpsAgent:n,cancelToken:n,socketPath:n,responseEncoding:n,validateStatus:o};return utils.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=d[e]||s,r=t(e);utils.isUndefined(r)&&t!==o||(i[e]=r)})),i},data={version:"0.27.2"},require$$3=data,VERSION=require$$3.version,validators$1={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){validators$1[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));var deprecatedWarnings={};function assertOptions(e,t,i){if("object"!=typeof e)throw new require$$5("options must be an object",require$$5.ERR_BAD_OPTION_VALUE);for(var r=Object.keys(e),s=r.length;s-- >0;){var a=r[s],n=t[a];if(n){var o=e[a],d=void 0===o||n(o,a,e);if(!0!==d)throw new require$$5("option "+a+" must be "+d,require$$5.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new require$$5("Unknown option "+a,require$$5.ERR_BAD_OPTION)}}validators$1.transitional=function(e,t,i){function r(e,t){return"[Axios v"+VERSION+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return function(i,s,a){if(!1===e)throw new require$$5(r(s," has been removed"+(t?" in "+t:"")),require$$5.ERR_DEPRECATED);return t&&!deprecatedWarnings[s]&&(deprecatedWarnings[s]=!0,console.warn(r(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,s,a)}};var validator$1={assertOptions:assertOptions,validators:validators$1},InterceptorManager=InterceptorManager_1,dispatchRequest=dispatchRequest$1,mergeConfig=mergeConfig$1,validator=validator$1,validators=validator.validators;function Axios$1(e){this.defaults=e,this.interceptors={request:new InterceptorManager,response:new InterceptorManager}}Axios$1.prototype.request=function(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},(t=mergeConfig(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var i=t.transitional;void 0!==i&&validator.assertOptions(i,{silentJSONParsing:validators.transitional(validators.boolean),forcedJSONParsing:validators.transitional(validators.boolean),clarifyTimeoutError:validators.transitional(validators.boolean)},!1);var r=[],s=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(s=s&&e.synchronous,r.unshift(e.fulfilled,e.rejected))}));var a,n=[];if(this.interceptors.response.forEach((function(e){n.push(e.fulfilled,e.rejected)})),!s){var o=[dispatchRequest,void 0];for(Array.prototype.unshift.apply(o,r),o=o.concat(n),a=Promise.resolve(t);o.length;)a=a.then(o.shift(),o.shift());return a}for(var d=t;r.length;){var c=r.shift(),l=r.shift();try{d=c(d)}catch(e){l(e);break}}try{a=dispatchRequest(d)}catch(e){return Promise.reject(e)}for(;n.length;)a=a.then(n.shift(),n.shift());return a},Axios$1.prototype.getUri=function(e){e=mergeConfig(this.defaults,e);var t=buildFullPath(e.baseURL,e.url);return buildURL(t,e.params,e.paramsSerializer)},utils.forEach(["delete","get","head","options"],(function(e){Axios$1.prototype[e]=function(t,i){return this.request(mergeConfig(i||{},{method:e,url:t,data:(i||{}).data}))}})),utils.forEach(["post","put","patch"],(function(e){function t(t){return function(i,r,s){return this.request(mergeConfig(s||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}Axios$1.prototype[e]=t(),Axios$1.prototype[e+"Form"]=t(!0)}));var Axios_1=Axios$1;function CancelToken(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var i=this;this.promise.then((function(e){if(i._listeners){var t,r=i._listeners.length;for(t=0;t<r;t++)i._listeners[t](e);i._listeners=null}})),this.promise.then=function(e){var t,r=new Promise((function(e){i.subscribe(e),t=e})).then(e);return r.cancel=function(){i.unsubscribe(t)},r},e((function(e){i.reason||(i.reason=new require$$0$1(e),t(i.reason))}))}CancelToken.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},CancelToken.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},CancelToken.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},CancelToken.source=function(){var e;return{token:new CancelToken((function(t){e=t})),cancel:e}};var CancelToken_1=CancelToken,spread=function(e){return function(t){return e.apply(null,t)}},isAxiosError=function(e){return utils.isObject(e)&&!0===e.isAxiosError},Axios=Axios_1,require$$1=CancelToken_1,require$$6=spread,require$$7=isAxiosError;function createInstance(e){var t=new Axios(e),i=bind(Axios.prototype.request,t);return utils.extend(i,Axios.prototype,t),utils.extend(i,t),i.create=function(t){return createInstance(mergeConfig(e,t))},i}var axios$2=createInstance(defaults);axios$2.Axios=Axios,axios$2.CanceledError=require$$0$1,axios$2.CancelToken=require$$1,axios$2.isCancel=require$$2,axios$2.VERSION=require$$3.version,axios$2.toFormData=require$$4,axios$2.AxiosError=require$$5,axios$2.Cancel=axios$2.CanceledError,axios$2.all=function(e){return Promise.all(e)},axios$2.spread=require$$6,axios$2.isAxiosError=require$$7;var axios_1=axios$2,default_1=axios$2;axios_1.default=default_1;var require$$0=axios_1,axios$1=require$$0,axios=axios$1,index_cjs=createCommonjsModule((function(e,t){function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=i(axios),s=i(eventemitter3),a=function(e,t){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},a(e,t)};function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var o=function(){return o=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},o.apply(this,arguments)};function d(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{d(r.next(e))}catch(e){a(e)}}function o(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}d((r=r.apply(e,t||[])).next())}))}function c(e,t){var i,r,s,a,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(d){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(n=0)),n;)try{if(i=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,r=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(s=n.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){n.label=o[1];break}if(6===o[0]&&n.label<s[1]){n.label=s[1],s=o;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(o);break}s[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],r=0}finally{i=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,d])}}}function l(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function u(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,s,a=i.call(e),n=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)n.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(i=a.return)&&i.call(a)}finally{if(s)throw s.error}}return n}function h(e,t,i){if(i||2===arguments.length)for(var r,s=0,a=t.length;s<a;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var p=function(e){var t=e.method,i=void 0===t?"POST":t,s=e.url,a=e.data,n=e.headers;return d(void 0,void 0,void 0,(function(){var e,t;return c(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,r.default({method:i,url:s,data:a,headers:n})];case 1:return 200!==(e=o.sent()).data.code?[2,Promise.reject(e.data)]:[2,e.data];case 2:return t=o.sent(),[2,Promise.reject(t)];case 3:return[2]}}))}))},m=p,f=function(){function e(e,t){this.store=new Map,this.type="memory",this.salt="__salt__",e&&(this.type=e),t&&(this.salt=t)}return e.prototype.get=function(e){var t;switch(this.type){case"memory":return this.store.get(e);case"localStorage":return(t=localStorage.getItem("".concat(this.salt).concat(e)))?JSON.parse(t):t;case"sessionStorage":return(t=sessionStorage.getItem("".concat(this.salt).concat(e)))?JSON.parse(t):t}},e.prototype.set=function(e,t){switch(this.type){case"memory":this.store.set(e,t);break;case"localStorage":localStorage.setItem("".concat(this.salt).concat(e),JSON.stringify(t));break;case"sessionStorage":sessionStorage.setItem("".concat(this.salt).concat(e),JSON.stringify(t))}},e.prototype.remove=function(e){switch(this.type){case"memory":this.store.delete(e);break;case"localStorage":localStorage.removeItem("".concat(this.salt).concat(e));break;case"sessionStorage":sessionStorage.removeItem("".concat(this.salt).concat(e))}},e}(),g=function(){function e(e){var t=e.appKey,i=e.version,r=e.component,s=e.nertcVersion,a=e.imVersion,n=e.platform,o=void 0===n?"Web":n,d=e.channel,c=void 0===d?"netease":d;this.platform=o,this.appKey=t,this.version=i,this.component=r,this.nertcVersion=s,this.imVersion=a,this.channel=c}return e.prototype.track=function(e,t){return d(this,void 0,void 0,(function(){var i,r,s,a,n,o,d,l,u;return c(this,(function(c){switch(c.label){case 0:r=(i=this).appKey,s=i.version,a=i.component,n=i.nertcVersion,o=i.imVersion,d=i.platform,l=i.channel,u=Date.now(),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,m({method:"POST",url:"https://statistic.live.126.net/statics/report/xkit/action",data:{appKey:r,version:s,component:a,timeStamp:u,nertcVersion:n,imVersion:o,platform:d,reportType:e,data:t,channel:l}})];case 2:case 3:return c.sent(),[3,4];case 4:return[2]}}))}))},e}(),v=g,_=function(e){function t(t){var i=e.call(this)||this;return i.visibilityState=document.visibilityState,i.entries=[],i._visibilitychange=function(){i.visibilityState=document.visibilityState,i._trigger()},i.intersectionObserver=new IntersectionObserver(i._intersectionObserverHandler.bind(i),t),document.addEventListener("visibilitychange",i._visibilitychange),i}return n(t,e),t.prototype.observe=function(e){return this.intersectionObserver.observe(e)},t.prototype.unobserve=function(e){return this.intersectionObserver.unobserve(e)},t.prototype.destroy=function(){this.intersectionObserver.disconnect(),document.removeEventListener("visibilitychange",this._visibilitychange),this.entries=[]},t.prototype._intersectionObserverHandler=function(e,t){this.entries=e,this._trigger()},t.prototype._trigger=function(){var e=this;this.entries.forEach((function(t){"visible"!==e.visibilityState||t.intersectionRatio<=0?e.emit("visibleChange",{visible:!1,target:t.target}):e.emit("visibleChange",{visible:!0,target:t.target})}))},t}(s.default),y="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==commonjsGlobal?commonjsGlobal:"undefined"!=typeof self?self:{};var S=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,i;t=y,i=function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function s(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function n(t,i){for(var s=0;s<r.length;s++){var a=r[s];this[a]=s<t?e:this.methodFactory(a,t,i)}this.log=this.debug}function o(e,i,r){return function(){typeof console!==t&&(n.call(this,i,r),this[e].apply(this,arguments))}}function d(r,n,d){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&i?a:void 0!==console[r]?s(console,r):void 0!==console.log?s(console,"log"):e)}(r)||o.apply(this,arguments)}function c(e,i,s){var a,o=this;i=null==i?"WARN":i;var c="loglevel";function l(){var e;if(typeof window!==t&&c){try{e=window.localStorage[c]}catch(e){}if(typeof e===t)try{var i=window.document.cookie,r=i.indexOf(encodeURIComponent(c)+"=");-1!==r&&(e=/^([^;]+)/.exec(i.slice(r))[1])}catch(e){}return void 0===o.levels[e]&&(e=void 0),e}}"string"==typeof e?c+=":"+e:"symbol"==typeof e&&(c=void 0),o.name=e,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=s||d,o.getLevel=function(){return a},o.setLevel=function(i,s){if("string"==typeof i&&void 0!==o.levels[i.toUpperCase()]&&(i=o.levels[i.toUpperCase()]),!("number"==typeof i&&i>=0&&i<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+i;if(a=i,!1!==s&&function(e){var i=(r[e]||"silent").toUpperCase();if(typeof window!==t&&c){try{return void(window.localStorage[c]=i)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"="+i+";"}catch(e){}}}(i),n.call(o,i,e),typeof console===t&&i<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(e){i=e,l()||o.setLevel(e,!1)},o.resetLevel=function(){o.setLevel(i,!1),function(){if(typeof window!==t&&c){try{return void window.localStorage.removeItem(c)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}()},o.enableAll=function(e){o.setLevel(o.levels.TRACE,e)},o.disableAll=function(e){o.setLevel(o.levels.SILENT,e)};var u=l();null==u&&(u=i),o.setLevel(u,!1)}var l=new c,u={};l.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=u[e];return t||(t=u[e]=new c(e,l.getLevel(),l.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return u},l.default=l,l},e.exports?e.exports=i():t.log=i()})),R=S;function b(e){var t=["scene/apps/***/",'"rtcKey":"***"','"imKey":"***"','"appkey":"***"','"appkey": "***"','appkey:"***"','appkey: "***"','"appkey":***','"appkey": ***',"appkey:***","appkey: ***"];return["scene/apps/[a-z0-9]{32}/",'"rtcKey":"[a-z0-9]{32}"','"imKey":"[a-z0-9]{32}"','"appkey":"[a-z0-9]{32}"','"appkey": "[a-z0-9]{32}"','appkey:"[a-z0-9]{32}"','appkey: "[a-z0-9]{32}"','"appkey":[a-z0-9]{32}','"appkey": [a-z0-9]{32}',"appkey:[a-z0-9]{32}","appkey: [a-z0-9]{32}"].forEach((function(i,r){var s=new RegExp(i,"gi");e=e.replace(s,t[r])})),e}var E,T=function(e){var t=void 0===e?{appName:"",version:"",storeWindow:!1}:e,i=t.level,r=t.appName,s=void 0===r?"":r;t.version;var a,n=t.storeWindow,o=void 0!==n&&n,d=function(){try{var e=navigator.userAgent.toLocaleLowerCase(),t=e.match(/(msie|firefox|chrome|opera|version).*?([\d.]+)/)||[];return{browser:t[1].replace(/version/,"safari"),ver:t[2]}}catch(e){return null}},c=(a=new Proxy(R,{get:function(e,t){var i,r;if(t in e){var a=e[t];if(!["log","info","warn","error","trace","debug"].includes(t))return a;var n,o,c,l,p,m,f,g=(n=new Date,o=n.getFullYear(),c=n.getMonth()+1,l=n.getDate(),p=n.getHours()<10?"0".concat(n.getHours()):n.getHours(),m=n.getMinutes()<10?"0".concat(n.getMinutes()):n.getMinutes(),f=n.getSeconds()<10?"0".concat(n.getSeconds()):n.getSeconds(),"".concat(o,"-").concat(c,"-").concat(l," ").concat(p,":").concat(m,":").concat(f));d()&&(g+="[".concat(null===(i=d())||void 0===i?void 0:i.browser," ").concat(null===(r=d())||void 0===r?void 0:r.ver,"]")),g+="[".concat({log:"L",info:"I",warn:"W",error:"E",trace:"E",debug:"D"}[t],"]")+"[".concat(s,"]")+":";var v=this;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var i=0;i<e.length;i++){if("object"==typeof e[i])try{e[i]=JSON.stringify(e[i])}catch(t){console.warn("[日志打印对象无法序列化]",e[i]),e[i]=e[i]}"string"==typeof e[i]&&(e[i]=b(e[i]))}return a.apply(v,h([g],u(e),!1))}}}}),a);return i&&c.setLevel(i),o&&(window.__LOGGER__=c),c};t.EventPriority=void 0,(E=t.EventPriority||(t.EventPriority={}))[E.LOW=0]="LOW",E[E.NORMAL=1]="NORMAL",E[E.HIGH=2]="HIGH";var A=function(){function e(e){this.appKey="",this.component="",this.data={},this.framework="",this.version="",this.startTime=0,this.endTime=0,this.duration=0,this.data.startTime=(new Date).getTime(),this.data.timeStamp=this.data.startTime,this.eventId=e.eventId,this.priority=e.priority}return e.prototype.end=function(){this.data.endTime&&this.data.duration||(this.data.endTime=this.data.endTime||(new Date).getTime(),this.data.duration=this.data.duration||this.data.endTime-this.data.startTime)},e.prototype.setAppInfo=function(e){this.appKey=e.appKey,this.component=e.component,this.version=e.version,e.framework&&(this.framework=e.framework)},e.prototype.endWith=function(e){var t=e.code,i=e.msg,r=e.requestId,s=e.serverCost;this.data.code="number"!=typeof t?-2:t,this.data.message=i,this.data.requestId=r,this.data.serverCost=s,this.end()},e.prototype.endWithSuccess=function(e){if(e){var t=e.requestId,i=e.serverCost;this.data.requestId=t,this.data.serverCost=i}this.data.code=0,this.data.message="success",this.end()},e.prototype.endWithFailure=function(e){if(e){var t=e.requestId,i=e.serverCost;this.data.requestId=t,this.data.serverCost=i}this.data.code=-1,this.data.message="failure",this.end()},e.prototype.setParams=function(e){return this.data.params=o({},e),this},e.prototype.addParams=function(e){return this.data.params=o(o({},this.data.params),e),this},e.prototype.setData=function(e){this.data=o(o({},this.data),e)},e.prototype.setUserId=function(e){this.data.userId=e},e}(),w=function(e){function t(t){return e.call(this,t)||this}return n(t,e),t}(A),I=function(e){function t(t){var i=e.call(this,t)||this;return i._stepMap=new Map,i}return n(t,e),t.prototype.beginStep=function(e){if(this._stepMap.has(e))return this._stepMap[e];var t=new w({eventId:e,priority:this.priority});return t.setData({step:e}),this._stepMap.set(e,t),t},t.prototype.addStep=function(e){this._stepMap.set(e.eventId,e)},t.prototype.removeStep=function(e){this._stepMap.delete(e)},t.prototype.endWith=function(t){e.prototype.endWith.call(this,t),this.end()},t.prototype.endWithSuccess=function(t){e.prototype.endWithSuccess.call(this,t),this.end()},t.prototype.endWithFailure=function(t){e.prototype.endWithFailure.call(this,t),this.end()},t.prototype.end=function(){var t,i,r=[];e.prototype.end.call(this);try{for(var s=l(this._stepMap.values()),a=s.next();!a.done;a=s.next()){var n=a.value;n.data.index=r.length,r.push(n.data)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}r.length>0&&(this.data.steps=r)},t}(w);function C(){var e="Unknown",t="";try{var i=navigator.userAgent;if(-1!==i.indexOf("Chrome")){e="Chrome";var r=i.indexOf("Chrome")+7,s=i.indexOf(" ",r);t=i.substring(r,s)}else if(-1!==i.indexOf("Firefox")){e="Firefox";r=i.indexOf("Firefox")+8;t=i.substring(r)}else if(-1!==i.indexOf("Safari")){e="Safari";r=i.indexOf("Version")+8,s=i.indexOf(" ",r);t=i.substring(r,s)}else if(-1!==i.indexOf("Edg")){e="Edge";r=i.indexOf("Edg")+4;t=i.substring(r)}else if(-1!==i.indexOf("MSIE")){e="Internet Explorer";r=i.indexOf("MSIE")+5,s=i.indexOf(";",r);t=i.substring(r,s)}}catch(e){}return{name:e,version:t}}var O=function(){function e(e){this._eventsCache=[],this._noReport=!1,this._configMap=new Map,this._retryCount=0;var t=C(),i=window.__XKitReporter__,r="";try{r=navigator.userAgent}catch(e){}try{null===document||void 0===document?void 0:document.title}catch(e){}this.common={imVersion:e.imVersion,nertcVersion:e.nertcVersion,platform:"Web",osVer:t.version,userAgent:r,manufacturer:"",model:t.name,packageId:(null==i?void 0:i.packageId)||"",appVer:(null==i?void 0:i.appVer)||"",appName:(null==i?void 0:i.appName)||"",deviceId:e.deviceId},this._logger=T({level:"debug",appName:"XKitReporter",version:"2.0.0"})}return e.prototype.getConfig=function(e){return d(this,void 0,void 0,(function(){var t=this;return c(this,(function(i){return[2,r.default({method:"GET",url:"https://yiyong.netease.im/report_conf",headers:{platform:"web",appKey:e}}).then((function(i){t._configMap.set(e,i.data)})).catch((function(){t._retryCount+=1,t._retryCount>3?t._retryCount=0:t.getConfig(e)}))]}))}))},e.prototype.setNoReport=function(e){this._noReport=e},e.prototype.reportEvent=function(e,t){this._noReport||(this._eventsCache.length>=100?this._evictEvent(e):this._eventsCache.push(e),this._scheduleReportEventsTask(null==t?void 0:t.immediate))},e.prototype._evictEvent=function(e){var t=this._eventsCache.findIndex((function(t){return t.priority<e.priority}));this._eventsCache.push(e),-1!==t?this._evictEvent(this._eventsCache[t]):(this._logger.debug("Full event cache, evict event:",e),this._eventsCache=this._eventsCache.filter((function(t){return t!==e})))},e.prototype._scheduleReportEventsTask=function(e){var t=this;void 0===e&&(e=!1);var i=function(){return d(t,void 0,void 0,(function(){var e,t,i,r,s,a;return c(this,(function(n){switch(n.label){case 0:for(i in e=this._eventsCache.reduce((function(e,t){var i=t.appKey;return e[i]||(e[i]=[]),e[i].push(t),e}),{}),t=[],e)t.push(i);r=0,n.label=1;case 1:return r<t.length?(s=t[r],this._configMap.has(s)?[3,3]:[4,this.getConfig(s)]):[3,5];case 2:n.sent(),n.label=3;case 3:if(this._configMap.has(s)&&!(null==(a=this._configMap.get(s))?void 0:a.enabled))return[2];this._reportEventsToServer(s,e[s]),n.label=4;case 4:return r++,[3,1];case 5:return this._eventsCache=[],[2]}}))}))};e&&i(),this._queueTimer||(this._queueTimer=setInterval((function(){if(0===t._eventsCache.length)return t._queueTimer&&clearInterval(t._queueTimer),void(t._queueTimer=void 0);i()}),5e3))},e.prototype._determineMaxRetry=function(e){var i,r,s=0;try{for(var a=l(e),n=a.next();!n.done;n=a.next()){var o=n.value;if(o.priority===t.EventPriority.HIGH){s=5;break}o.priority===t.EventPriority.NORMAL&&(s=2)}}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return s},e.prototype._reportEventsToServer=function(e,t){return d(this,void 0,void 0,(function(){var i,r,s,a,n,d,l=this;return c(this,(function(c){return this._configMap.has(e)?(i=this._configMap.get(e),this._configMap.has(e),r=t.reduce((function(e,t){var r,s,a,n;if((null===(r=null==i?void 0:i.blacklist)||void 0===r?void 0:r.length)>0&&(null===(s=null==i?void 0:i.blacklist)||void 0===s?void 0:s.includes(t.component)))return e;if((null===(a=null==i?void 0:i.whitelist)||void 0===a?void 0:a.length)>0&&!(null===(n=null==i?void 0:i.whitelist)||void 0===n?void 0:n.includes(t.component)))return e;var d=t.eventId;return e[d]||(e[d]=[]),e[d].push(o(o({},t.data),{appKey:t.appKey,component:t.component,version:t.version,framework:t.framework})),e}),{}),s=this._determineMaxRetry(t),a=0,n={common:this.common,event:r},(d=function(){m({method:"POST",url:"https://statistic.live.126.net/statics/report/common/form",headers:{appkey:e,sdktype:"NEXKitStatistics",ver:"1.0.0","Content-Type":"application/json;charset=utf-8"},data:n}).catch((function(){a<=s?setTimeout(d,2e3*a):l._logger.debug("Failed to report events to server after ".concat(a," retries."),n),a++}))})(),[2]):[2]}))}))},e.setAppInfo=function(e){try{window.__XKitReporter__={packageId:e.packageId,appName:e.appName,appVer:e.appVer}}catch(e){}},e.getInstance=function(t){if(!t){if(!this.instance)throw new Error("XKitReporter not initialized");return this.instance}return this.instance||(this.instance=new e(t)),this.instance},e}(),k=O;t.EventStep=w,t.EventTracking=v,t.IntervalEvent=I,t.ReportEvent=A,t.Storage=f,t.VisibilityObserver=_,t.XKitReporter=k,t.addUrlSearch=function(e,t){var i=new URL(e);return i.search+=(i.search.startsWith("?")?"&":"?")+t,i.href},t.createLoggerDecorator=function(e,t){return function(i,r,s){var a=s.value;s.value=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];return d(this,void 0,void 0,(function(){var s,n,o;return c(this,(function(d){switch(d.label){case 0:t||(t=this.logger),["log","error"].some((function(e){return!t[e]}))&&console.warn("loggerDecorator warning: your logger is not complete"),s=a.name||r||"",d.label=1;case 1:return d.trys.push([1,3,,4]),null==t||t.log.apply(t,h([e,s],u(i),!1)),[4,a.apply(this,i)];case 2:return n=d.sent(),null==t||t.log(e,"".concat(s," success: "),n),[2,n];case 3:throw o=d.sent(),null==t||t.error(e,"".concat(s," failed: "),o),o;case 4:return[2]}}))}))}}},t.debounce=function(e,t){var i=null;return function(){for(var r=this,s=[],a=0;a<arguments.length;a++)s[a]=arguments[a];i&&(clearTimeout(i),i=null),i=setTimeout((function(){e.apply(r,s)}),t)}},t.frequencyControl=function(e,t){var i,r=[],s=0;return function(){for(var a=this,n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return new Promise((function(o,d){r.push({resolve:o,reject:d});var c=Date.now(),l=function(e,t){for(;r.length;){var i=r.shift(),s=i.resolve,a=i.reject;e?s(t):a(t)}},u=function(){s=c,r.length&&e.apply(a,n).then((function(e){l(!0,e)}),(function(e){l(!1,e)}))};c-s>t?u():(clearTimeout(i),i=setTimeout((function(){u()}),t))}))}},t.getBrowserInfo=C,t.getFileType=function(e){var t={img:/(png|gif|jpg)/i,pdf:/pdf$/i,word:/(doc|docx)$/i,excel:/(xls|xlsx)$/i,ppt:/(ppt|pptx)$/i,zip:/(zip|rar|7z)$/i,audio:/(mp3|wav|wmv)$/i,video:/(mp4|mkv|rmvb|wmv|avi|flv|mov)$/i};return Object.keys(t).find((function(i){return t[i].test(e)}))||""},t.getOperatingSystem=function(){try{var e=navigator.userAgent;return e.includes("Windows")?"Windows":e.includes("Mac OS")?"Mac OS":e.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iOS")?"iOS":"Unknown"}catch(e){return"Unknown"}},t.logDebug=T,t.parseFileSize=function(e,t){void 0===t&&(t=0);var i={0:"B",1:"KB",2:"MB",3:"GB",4:"TB"},r=function(e,t){return t>=Object.keys(i).length?"the file is too big":e<1024?"".concat(e).concat(i[t]):r(Math.round(e/1024),t+1)};return r(e,t)},t.request=m}));unwrapExports(index_cjs),index_cjs.EventPriority,index_cjs.EventStep;var index_cjs_3=index_cjs.EventTracking;index_cjs.IntervalEvent,index_cjs.ReportEvent,index_cjs.Storage,index_cjs.VisibilityObserver,index_cjs.XKitReporter,index_cjs.addUrlSearch;var index_cjs_10=index_cjs.createLoggerDecorator,index_cjs_11=index_cjs.debounce;index_cjs.frequencyControl,index_cjs.getBrowserInfo,index_cjs.getFileType,index_cjs.getOperatingSystem;var index_cjs_16=index_cjs.logDebug;index_cjs.parseFileSize,index_cjs.request;var name="@xkit-yx/call-kit",author="",description="",files=["dist","assets","miniprogram_dist"],keywords=[],license="MIT",miniprogram="miniprogram_dist",main="dist/index.cjs.js",module="dist/index.esm.js",unpkg="dist/index.umd.js",typings="dist/types/index.d.ts",publishConfig={access:"public"},scripts={dev:"rm -rf ./lib && rollup -c --environment DEV",build:"rollup -c"},version="2.2.0",dependencies={"@xkit-yx/utils":"^0.5.6",eventemitter3:"^4.0.7","nertc-web-sdk":"5.5.10","yunxin-log-debug":"^1.1.6"},devDependencies={"@rollup/plugin-json":"^4.1.0","@rollup/plugin-node-resolve":"^10.0.0",rollup:"^2.33.1","rollup-plugin-commonjs":"^10.1.0","rollup-plugin-terser":"^7.0.2","rollup-plugin-typescript2":"^0.31.2",typescript:"^4.0.3"},pkg={name:name,author:author,description:description,files:files,keywords:keywords,license:license,miniprogram:miniprogram,main:main,module:module,unpkg:unpkg,typings:typings,publishConfig:publishConfig,scripts:scripts,version:version,dependencies:dependencies,devDependencies:devDependencies},APP_NAME="NECall",logger=index_cjs_16({level:"debug",appName:APP_NAME,version:pkg.version}),CHANNEL_INFO_NULL={message:"channelInfo is null"},NOT_CALLING={message:"not calling"},NOT_BE_CALL={message:"not be call"},CALL_BUSY={message:"be call busy"},NOT_IN_CALL={message:"not in call"},CHANNEL_NOT_MATCH={message:"channel not match"};function uuidv4(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var TAG_NAME$1="SignalController",loggerDecorator$3=index_cjs_10(TAG_NAME$1,logger),SignalController=function(e){function t(t){var i=t.nim,r=t.enableMarkInviteEventDelay,s=void 0===r||r,a=e.call(this)||this;return a.callStatus=SignalControllerCallingStatus.idle,a.callTimeout=3e4,a.offlineEnabled=!0,a.enableAutoJoinSignalChannel=!1,a.enableRecord=!0,a.enableMarkInviteEventDelay=!1,a._delayInviteEvents=[],a._signal=i,a.enableMarkInviteEventDelay=s,a._addSignalEventListener(),a._signal.signalingSync(),setInterval((function(){var e,t=null===(e=a._channelInfo)||void 0===e?void 0:e.channelId;t&&a._signal.signalingDelay({channelId:t})}),12e4),a}return __extends(t,e),Object.defineProperty(t.prototype,"channelInfo",{get:function(){return this._channelInfo},enumerable:!1,configurable:!0}),t.prototype.call=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(this.callStatus!==SignalControllerCallingStatus.idle)throw CALL_BUSY;return this.callStatus=SignalControllerCallingStatus.calling,[4,this._signalCallEx(e)];case 1:return[2,t.sent()]}}))}))},t.prototype.accept=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(this.callStatus!==SignalControllerCallingStatus.called||!this._channelInfo)throw NOT_BE_CALL;return this.callStatus=SignalControllerCallingStatus.inCall,this.enableMarkInviteEventDelay&&this._markInviteEvents(),[4,this._signalAccept(__assign(__assign({},this._channelInfo),{account:this._channelInfo.callerId,nertcJoinRoomQueryParamMap:null==e?void 0:e.nertcJoinRoomQueryParamMap}))];case 1:return t.sent(),[2,this._channelInfo]}}))}))},t.prototype.cancel=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:if(this.callStatus!==SignalControllerCallingStatus.calling||!this._channelInfo)throw NOT_CALLING;if((null==e?void 0:e.channelId)&&(null===(t=this._channelInfo)||void 0===t?void 0:t.channelId)!==e.channelId)throw CHANNEL_NOT_MATCH;return i=this._channelInfo.attachExt,(null==e?void 0:e.extraString)&&(i._attachment=e.extraString),[4,this._signalCancel(__assign(__assign({},this._channelInfo),{attachExt:i,account:this._channelInfo.calleeId}))];case 1:return r.sent(),[2]}}))}))},t.prototype.reject=function(e){var t,i;return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(s){switch(s.label){case 0:if(this.callStatus!==SignalControllerCallingStatus.called)throw NOT_BE_CALL;if((null==e?void 0:e.channelId)&&(null===(t=this._channelInfo)||void 0===t?void 0:t.channelId)!==e.channelId)throw CHANNEL_NOT_MATCH;if(!this._channelInfo)throw CHANNEL_INFO_NULL;return this.enableMarkInviteEventDelay&&this._markInviteEvents(),(r=this._channelInfo.attachExt).reason=null!==(i=null==e?void 0:e.reason)&&void 0!==i?i:0,(null==e?void 0:e.extraString)&&(r._attachment=e.extraString),[4,this._signalReject(__assign(__assign({},this._channelInfo),{account:this._channelInfo.callerId,attachExt:r}))];case 1:return s.sent(),[2]}}))}))},t.prototype.hangup=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:if(this.callStatus!==SignalControllerCallingStatus.inCall||!this._channelInfo)throw NOT_IN_CALL;if((null==e?void 0:e.channelId)&&(null===(t=this._channelInfo)||void 0===t?void 0:t.channelId)!==e.channelId)throw CHANNEL_NOT_MATCH;return this.enableMarkInviteEventDelay&&this._markInviteEvents(),i=this._channelInfo.attachExt,(null==e?void 0:e.extraString)&&(i._attachment=e.extraString),[4,this._signalHangup(__assign({},this._channelInfo))];case 1:return r.sent(),[2]}}))}))},t.prototype.control=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this._channelInfo)throw CHANNEL_INFO_NULL;return[4,this._signal.signalingControl({channelId:this._channelInfo.channelId,account:"",attachExt:JSON.stringify(__assign(__assign({},this._channelInfo.attachExt),null==e?void 0:e.ext))})];case 1:return i.sent(),[3,3];case 2:throw t=i.sent(),logger.error(TAG_NAME$1,"control fail",t),t;case 3:return[2]}}))}))},t.prototype.reconnect=function(){this._signal.signalingSync()},t.prototype.resetState=function(){this._channelInfo=void 0,this.callStatus=SignalControllerCallingStatus.idle,this._callTimer&&clearTimeout(this._callTimer),this._rejectTimer&&clearTimeout(this._rejectTimer)},t.prototype.destroy=function(){var e,t,i;this.resetState(),null===(e=this._signal)||void 0===e||e.off("signalingNotify"),null===(t=this._signal)||void 0===t||t.off("signalingMutilClientSyncNotify"),null===(i=this._signal)||void 0===i||i.off("signalingUnreadMessageSyncNotify")},t.prototype._signalCallEx=function(e){var t,i,r,s,a,n,o,d,c,l;return __awaiter(this,void 0,void 0,(function(){var u,h,p,m,f=this;return __generator(this,(function(g){switch(g.label){case 0:return g.trys.push([0,2,,3]),u={callId:uuidv4(),channelName:e.nertcChannelName||uuidv4(),rtcTokenTtl:e.nertcTokenTtl||500,version:pkg.version,callType:0,global_extra:e.globalExtraCopy,extraInfo:e.extraInfo,_attachment:e.extraInfo,reason:0},h={offlineEnabled:this.offlineEnabled,account:e.accId,channelName:e.signalChannelName,type:e.callType,requestId:uuidv4(),attachExt:JSON.stringify(u),nertcChannelName:u.channelName,nertcTokenTtl:e.nertcTokenTtl,nertcJoinRoomQueryParamMap:e.nertcJoinRoomQueryParamMap,pushInfo:{pushTitle:null!==(i=null===(t=e.pushConfig)||void 0===t?void 0:t.pushTitle)&&void 0!==i?i:"邀请通知",pushContent:null!==(s=null===(r=e.pushConfig)||void 0===r?void 0:r.pushContent)&&void 0!==s?s:"你收到了通话邀请",pushPayload:void 0===(null===(a=e.pushConfig)||void 0===a?void 0:a.pushPayload)?"{}":JSON.stringify(null===(n=e.pushConfig)||void 0===n?void 0:n.pushPayload),needPush:null===(d=null===(o=e.pushConfig)||void 0===o?void 0:o.needPush)||void 0===d||d,needBadge:null===(l=null===(c=e.pushConfig)||void 0===c?void 0:c.needBadge)||void 0===l||l}},p=this,[4,this._signal.signalingCallEx(h)];case 1:return p._channelInfo=g.sent(),this._channelInfo.calleeId=h.account,this._channelInfo.requestId=h.requestId,this._channelInfo.attachExt=u,logger.log(TAG_NAME$1,"signalingCallEx success",this._channelInfo),this.emit("afterSignalCallEx",this._channelInfo),this.callTimeout&&(this._callTimer=setTimeout((function(){return __awaiter(f,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return this.callStatus===SignalControllerCallingStatus.calling&&this._channelInfo?(this._channelInfo.attachExt.reason=2,[4,this._signalCancel(__assign(__assign({},this._channelInfo),{account:this._channelInfo.calleeId}))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))}),this.callTimeout)),[2,this._channelInfo];case 2:throw m=g.sent(),logger.error(TAG_NAME$1,"signalingCallEx fail",m),this.resetState(),m;case 3:return[2]}}))}))},t.prototype._addSignalEventListener=function(){var e,t=this,i=function(e){return __awaiter(t,void 0,void 0,(function(){var t;return __generator(this,(function(i){if(this._batchMarkEvent([e]),"INVITE"!==e.eventType&&e.channelId!==(null===(t=this._channelInfo)||void 0===t?void 0:t.channelId))return[2];switch(logger.log(TAG_NAME$1,"handleSignalEvent",e.eventType,e),e.eventType){case"ROOM_JOIN":case"LEAVE":break;case"ROOM_CLOSE":this._roomCloseHandler(e);break;case"INVITE":this._inviteHandler(e);break;case"CANCEL_INVITE":this._cancelInviteHandler(e);break;case"REJECT":this._rejectHandler(e);break;case"ACCEPT":this._acceptHandler(e);break;case"CONTROL":this._controlHandler(e)}return[2]}))}))};null===(e=this._signal)||void 0===e||e.on("signalingNotify",i),this._signal.on("signalingMutilClientSyncNotify",(function(e){setTimeout((function(){var i;if(logger.log(TAG_NAME$1,"signalingMutilClientSyncNotify",e,t),t._batchMarkEvent([e]),(null===(i=t._channelInfo)||void 0===i?void 0:i.channelId)===e.channelId)switch(e.eventType){case"ACCEPT":t.resetState(),t.emit("whenSignalAcceptOtherClient");break;case"REJECT":t.resetState(),t.emit("whenSignalRejectOtherClient")}}),1e3)})),this._signal.on("signalingUnreadMessageSyncNotify",(function(e){return __awaiter(t,void 0,void 0,(function(){var t,r,s,a,n,o,d,c;return __generator(this,(function(l){switch(l.label){case 0:logger.log(TAG_NAME$1,"signalingUnreadMessageSyncNotify",e),t=e.filter((function(e){return!e.channelInValid})),r=function(e){return __generator(this,(function(r){switch(r.label){case 0:return"INVITE"===e.eventType&&t.find((function(t){return t.channelId===e.channelId&&"CANCEL_INVITE"===t.eventType}))?[3,2]:[4,i(e)];case 1:r.sent(),r.label=2;case 2:return[2]}}))},l.label=1;case 1:l.trys.push([1,6,7,8]),s=__values(t),a=s.next(),l.label=2;case 2:return a.done?[3,5]:(n=a.value,[5,r(n)]);case 3:l.sent(),l.label=4;case 4:return a=s.next(),[3,2];case 5:return[3,8];case 6:return o=l.sent(),d={error:o},[3,8];case 7:try{a&&!a.done&&(c=s.return)&&c.call(s)}finally{if(d)throw d.error}return[7];case 8:return[2]}}))}))}))},t.prototype._inviteHandler=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i,r,s,a,n,o,d=this;return __generator(this,(function(c){switch(c.label){case 0:if(e.channelInValid)return[2];i=e.channelId,r=e.requestId,s=e.from;try{a=JSON.parse(e.attachExt)}catch(e){throw logger.error(TAG_NAME$1,"inviteHandler parse attachExt fail",e),e}return this.callStatus===SignalControllerCallingStatus.idle?[3,3]:i===(null===(t=this._channelInfo)||void 0===t?void 0:t.channelId)?[3,2]:(this.enableMarkInviteEventDelay&&this._markInviteEvents(),a.reason=3,[4,this._signalReject({channelId:i,requestId:r,account:s,attachExt:a})]);case 1:c.sent(),c.label=2;case 2:return[2];case 3:return this.callStatus=SignalControllerCallingStatus.called,this.enableAutoJoinSignalChannel?(n=this,[4,this._signal.signalingJoin({channelId:e.channelId,nertcChannelName:a.channelName,nertcTokenTtl:a.rtcTokenTtl,offlineEnabled:this.offlineEnabled,attachExt:e.attachExt})]):[3,5];case 4:return n._channelInfo=c.sent(),[3,7];case 5:return o=this,[4,this._signal.signalingGetChannelInfo({channelName:e.channelName})];case 6:o._channelInfo=c.sent(),c.label=7;case 7:return this._channelInfo.callerId=s,this._channelInfo.requestId=r,this._channelInfo.attachExt=a,this.emit("whenSignalInvite",this._channelInfo),this.callTimeout&&(this._rejectTimer=setTimeout((function(){return __awaiter(d,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:if(!this._channelInfo)return[3,4];this._channelInfo.attachExt.reason=2,e.label=1;case 1:return e.trys.push([1,3,,4]),this.enableMarkInviteEventDelay&&this._markInviteEvents(),[4,this._signalReject(__assign(__assign({},this._channelInfo),{account:this._channelInfo.callerId}))];case 2:case 3:return e.sent(),[3,4];case 4:return[2]}}))}))}),this.callTimeout)),[2]}}))}))},t.prototype._roomCloseHandler=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){try{t=JSON.parse(e.attachExt)}catch(e){throw logger.error(TAG_NAME$1,"roomCloseHandler:","parse attachExt error:",e),e}return this.resetState(),this.emit("whenSignalRoomClose",t),[2]}))}))},t.prototype._cancelInviteHandler=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){this.enableMarkInviteEventDelay&&this._markInviteEvents();try{t=JSON.parse(e.attachExt)}catch(e){throw logger.error(TAG_NAME$1,"inviteHandler:","parse attachExt error:",e),e}return this.resetState(),this.emit("whenSignalCancel",t),[2]}))}))},t.prototype._rejectHandler=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i,r,s;return __generator(this,(function(a){if(i=e.from,(r=null===(t=this._channelInfo)||void 0===t?void 0:t.calleeId)===i){s=void 0;try{s=JSON.parse(e.attachExt)}catch(e){throw logger.error(TAG_NAME$1,"inviteHandler:","parse attachExt error:",e),e}switch(s.reason){case 3:this._sendMessage(r,"busy");break;case 2:this._sendMessage(r,"timeout");break;default:this._sendMessage(r,"rejected")}this.resetState(),this.emit("whenSignalReject",s)}return[2]}))}))},t.prototype._acceptHandler=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i,r;return __generator(this,(function(s){switch(s.label){case 0:this.callStatus=SignalControllerCallingStatus.inCall,this._callTimer&&clearTimeout(this._callTimer),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this._signal.signalingGetChannelInfo({channelName:null===(t=this._channelInfo)||void 0===t?void 0:t.channelName})];case 2:return i=s.sent(),this._channelInfo=__assign(__assign({},this._channelInfo),i),logger.log(TAG_NAME$1,"acceptHandler from signal success:",e),this.emit("whenSignalAccept",this._channelInfo),[3,4];case 3:throw r=s.sent(),logger.error(TAG_NAME$1,"acceptHandler error:",r),r;case 4:return[2]}}))}))},t.prototype._controlHandler=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){try{t=void 0;try{t=JSON.parse(e.attachExt)}catch(e){throw logger.error(TAG_NAME$1,"inviteHandler:","parse attachExt error:",e),e}logger.log(TAG_NAME$1,"controlHandler from signal success:",e),this.emit("whenSignalControl",t)}catch(e){throw logger.error(TAG_NAME$1,"controlHandler error:",e),e}return[2]}))}))},t.prototype._signalAccept=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i,r;return __generator(this,(function(s){switch(s.label){case 0:t=e.attachExt,s.label=1;case 1:return s.trys.push([1,6,,7]),this.enableAutoJoinSignalChannel?[3,3]:[4,this._signal.signalingJoinAndAccept(__assign(__assign({},e),{offlineEnabled:this.offlineEnabled,attachExt:JSON.stringify(t),nertcChannelName:t.channelName,nertcTokenTtl:t.rtcTokenTtl}))];case 2:return i=s.sent(),this._channelInfo=__assign(__assign({},this._channelInfo),i),[3,5];case 3:return[4,this._signal.signalingAccept(__assign(__assign({},e),{offlineEnabled:this.offlineEnabled,attachExt:JSON.stringify(t)}))];case 4:s.sent(),s.label=5;case 5:return this._channelInfo&&this.emit("afterSignalAccept",this._channelInfo),this._rejectTimer&&clearTimeout(this._rejectTimer),[3,7];case 6:throw r=s.sent(),logger.error(TAG_NAME$1,"acceptSignal fail:",r,this._channelInfo),r;case 7:return[2]}}))}))},t.prototype._signalCancel=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i,r,s;return __generator(this,(function(a){switch(a.label){case 0:t=e.account,i=e.attachExt,r=i.reason,a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this._signal.signalingCancel(__assign(__assign({},e),{offlineEnabled:this.offlineEnabled,attachExt:JSON.stringify(i)}))];case 2:return a.sent(),2===r?this._sendMessage(t,"timeout"):this._sendMessage(t,"canceled"),this.resetState(),this.emit("afterSignalCancel",i),logger.log(TAG_NAME$1,"signalCancel success"),[3,4];case 3:throw(!(s=a.sent())||"INVITE_HAS_ACCEPT"!==s.message&&10410!==s.code&&"INVITE_HAS_REJECT"!==s.message&&10409!==s.code)&&(this.resetState(),this.emit("afterSignalCancel",i)),logger.error(TAG_NAME$1,"signalCancel failed:",s,this._channelInfo),s;case 4:return[2]}}))}))},t.prototype._signalReject=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i;return __generator(this,(function(r){switch(r.label){case 0:t=e.attachExt.reason,r.label=1;case 1:return r.trys.push([1,3,,4]),3!==t&&(this.resetState(),this.emit("afterSignalReject",e.attachExt)),[4,this._signal.signalingReject(__assign(__assign({},e),{attachExt:JSON.stringify(e.attachExt),offlineEnabled:this.offlineEnabled}))];case 2:return r.sent(),logger.log(TAG_NAME$1,"rejectReject success"),[3,4];case 3:throw i=r.sent(),logger.error(TAG_NAME$1,"rejectReject failed:",i,this._channelInfo),i;case 4:return[2]}}))}))},t.prototype._signalHangup=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),this.resetState(),this.emit("afterSignalHangup",e.attachExt),[4,this._signal.signalingClose(__assign(__assign({},e),{offlineEnabled:this.offlineEnabled,attachExt:JSON.stringify(e.attachExt)}))];case 1:return i.sent(),logger.log("signalClose success"),[3,3];case 2:return t=i.sent(),logger.warn(TAG_NAME$1,"signalClose fail but resolve:",t,this._channelInfo),[3,3];case 3:return[2]}}))}))},t.prototype._batchMarkEvent=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i,r,s;return __generator(this,(function(a){switch(a.label){case 0:t=e,this.enableMarkInviteEventDelay&&((s=this._delayInviteEvents).push.apply(s,__spreadArray([],__read(e.filter((function(e){return"INVITE"===e.eventType}))),!1)),t=e.filter((function(e){return"INVITE"!==e.eventType}))),a.label=1;case 1:return a.trys.push([1,3,,4]),i=t.map((function(e){return e.msgid+""})),[4,this._signal.signalingMarkMsgRead({msgid:i})];case 2:return a.sent(),logger.log(TAG_NAME$1,"在线 signalingMarkMsgRead success"),[3,4];case 3:return r=a.sent(),logger.warn(TAG_NAME$1,"在线 signalingMarkMsgRead fail: ",r),[3,4];case 4:return[2]}}))}))},t.prototype._markInviteEvents=function(){return __awaiter(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),logger.log(TAG_NAME$1,"_markInviteEvents",this._delayInviteEvents),this._delayInviteEvents.length?(e=this._delayInviteEvents.map((function(e){return e.msgid+""})),[4,this._signal.signalingMarkMsgRead({msgid:e})]):[3,2];case 1:i.sent(),this._delayInviteEvents=[],logger.log(TAG_NAME$1,"_markInviteEvents success"),i.label=2;case 2:return[3,4];case 3:return t=i.sent(),logger.warn(TAG_NAME$1,"_markInviteEvents fail: ",t),[3,4];case 4:return[2]}}))}))},t.prototype._sendMessage=function(e,t){var i,r;return __awaiter(this,void 0,void 0,(function(){var s,a,n=this;return __generator(this,(function(o){switch(o.label){case 0:return this.enableRecord?(s={canceled:2,rejected:3,timeout:4,busy:5},a={type:null===(i=this._channelInfo)||void 0===i?void 0:i.type,channelId:null===(r=this._channelInfo)||void 0===r?void 0:r.channelId,status:s[t],durations:[]},[4,new Promise((function(t,i){n._signal.sendG2Msg({attach:a,scene:"p2p",to:e,done:function(r,s){if(r)return logger.error(TAG_NAME$1,"sendMessage fail:",a,r),i(r);logger.log(TAG_NAME$1,"sendMessage success",a,e,s),n.emit("afterCallRecordSend",__assign(__assign({},s),{accId:e,callType:Number(a.type),callState:a.status})),t()}})}))]):(logger.log(TAG_NAME$1,"sendMessage skip"),[2]);case 1:return[2,o.sent()]}}))}))},__decorate([loggerDecorator$3],t.prototype,"call",null),__decorate([loggerDecorator$3],t.prototype,"accept",null),__decorate([loggerDecorator$3],t.prototype,"cancel",null),__decorate([loggerDecorator$3],t.prototype,"reject",null),__decorate([loggerDecorator$3],t.prototype,"hangup",null),__decorate([loggerDecorator$3],t.prototype,"control",null),t}(EventEmitter),SignalController$1=SignalController,LOCAL_VIEW_NULL={message:"local view is null"},LOCAL_STREAM_NULL={message:"local stream is null"},REMOTE_VIEW_NULL={message:"remote view is null"},VIDEO_QUALITY,VIDEO_FRAME_RATE;!function(e){e[e.VIDEO_QUALITY_1080p=NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_1080p]="VIDEO_QUALITY_1080p",e[e.VIDEO_QUALITY_720p=NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_720p]="VIDEO_QUALITY_720p",e[e.VIDEO_QUALITY_480p=NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_480p]="VIDEO_QUALITY_480p",e[e.VIDEO_QUALITY_180p=NERTC$1.VIDEO_QUALITY.VIDEO_QUALITY_180p]="VIDEO_QUALITY_180p"}(VIDEO_QUALITY||(VIDEO_QUALITY={})),function(e){e[e.CHAT_VIDEO_FRAME_RATE_NORMAL=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL]="CHAT_VIDEO_FRAME_RATE_NORMAL",e[e.CHAT_VIDEO_FRAME_RATE_5=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5]="CHAT_VIDEO_FRAME_RATE_5",e[e.CHAT_VIDEO_FRAME_RATE_10=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10]="CHAT_VIDEO_FRAME_RATE_10",e[e.CHAT_VIDEO_FRAME_RATE_15=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15]="CHAT_VIDEO_FRAME_RATE_15",e[e.CHAT_VIDEO_FRAME_RATE_20=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20]="CHAT_VIDEO_FRAME_RATE_20",e[e.CHAT_VIDEO_FRAME_RATE_25=NERTC$1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25]="CHAT_VIDEO_FRAME_RATE_25"}(VIDEO_FRAME_RATE||(VIDEO_FRAME_RATE={}));var TAG_NAME="RTCController",loggerDecorator$2=index_cjs_10(TAG_NAME,logger),RTCController=function(e){function t(t){var i=t.appkey,r=t.rtcConfig,s=t.debug,a=void 0!==s&&s,n=e.call(this)||this;return n.remoteStreams=[],n._remoteViews=[],n._rtcConfig={videoResolution:VIDEO_QUALITY.VIDEO_QUALITY_720p,videoFrameRate:VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,audioQuality:"speech_low_quality"},n._inTheRoom=!1,n._rtcSDK=NERTC$1,n.client=n._rtcSDK.createClient({appkey:i,debug:a}),r&&(n._rtcConfig=r),n._addRtcEventListener(),n}return __extends(t,e),t.prototype.getChannelInfo=function(){return this.client.getChannelInfo()},t.prototype.initLocalStream=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.localStream?[2]:(this.localStream=this._rtcSDK.createStream(__assign(__assign({},this._rtcConfig.streamOptions),{uid:e.uid,audio:e.audio,video:e.video,screen:e.screen})),logger.log(TAG_NAME,"localStream create success",this.localStream,e.audio,e.video),this.localStream.setVideoProfile({resolution:this._rtcConfig.videoResolution||VIDEO_QUALITY.VIDEO_QUALITY_720p,frameRate:this._rtcConfig.videoFrameRate||VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL}),this.localStream.setAudioProfile(this._rtcConfig.audioQuality||"speech_low_quality"),[4,this.localStream.init()]);case 1:return t.sent(),[2]}}))}))},t.prototype.leaveRTCChannel=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),this._inTheRoom?[4,this.client.leave()]:[3,2];case 1:t.sent(),t.label=2;case 2:return this._inTheRoom=!1,this.resetState(),[3,4];case 3:throw e=t.sent(),logger.error(TAG_NAME,"leaveRTCChannel fail: ",e),e;case 4:return[2]}}))}))},t.prototype.joinRTCChannel=function(e){var t,i,r,s;return __awaiter(this,void 0,void 0,(function(){var a,n,o,d,c;return __generator(this,(function(l){switch(l.label){case 0:return l.trys.push([0,5,,6]),this._inTheRoom?(logger.warn(TAG_NAME,"joinRTCChannel in the room"),[2]):null===(t=e.token)||void 0===t?[3,1]:(n=t,[3,3]);case 1:return[4,null===(r=(i=this._rtcConfig).getToken)||void 0===r?void 0:r.call(i,e)];case 2:n=l.sent(),l.label=3;case 3:return a=n,o=null!==(s=e.neRtcServerAddresses)&&void 0!==s?s:this._rtcConfig.neRtcServerAddresses,logger.log(TAG_NAME,"joinRTCChannel:",e,a,o),[4,this.client.join(__assign(__assign({},e),{neRtcServerAddresses:o,token:a}))];case 4:return d=l.sent(),this._inTheRoom=!0,logger.log(TAG_NAME,"joinRTCChannel success: ",d),[3,6];case 5:throw c=l.sent(),logger.error(TAG_NAME,"joinRTCChannel fail: ",c),c;case 6:return[2]}}))}))},t.prototype.publishLocalStream=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:if(!this.localStream)throw LOCAL_STREAM_NULL;t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.client.publish(this.localStream)];case 2:return t.sent(),logger.log(TAG_NAME,"publishLocalStream success"),[3,4];case 3:throw e=t.sent(),logger.error(TAG_NAME,"publishLocalStream fail: ",e),e;case 4:return[2]}}))}))},t.prototype.enableLocalVideo=function(e,t){return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,4,,5]),!this.localStream)throw LOCAL_STREAM_NULL;if(!this._localView)throw LOCAL_VIEW_NULL;return[4,this.localStream[e?"open":"close"]({type:"video",deviceId:t})];case 1:return r.sent(),e?[4,this._startStreamPreview(this.localStream,"local",this._localView)]:[3,3];case 2:r.sent(),r.label=3;case 3:return logger.log(TAG_NAME,"_enableLocalVideo success:",e,t),[3,5];case 4:throw i=r.sent(),logger.error(TAG_NAME,"_enableLocalVideo fail:",e,t,i),i;case 5:return[2]}}))}))},t.prototype.enableLocalAudio=function(e,t){return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:if(r.trys.push([0,4,,5]),!this.localStream)throw LOCAL_STREAM_NULL;if(!this._localView)throw LOCAL_VIEW_NULL;return[4,this.localStream[e?"open":"close"]({type:"audio",deviceId:t})];case 1:return r.sent(),e?[4,this._startStreamPreview(this.localStream,"local",this._localView)]:[3,3];case 2:r.sent(),r.label=3;case 3:return logger.log(TAG_NAME,"_enableLocalVideo success:",e,t),[3,5];case 4:throw i=r.sent(),logger.error(TAG_NAME,"_enableLocalVideo fail:",e,t,i),i;case 5:return[2]}}))}))},t.prototype.muteLocalVideo=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.localStream)throw LOCAL_STREAM_NULL;return[4,this.localStream[e?"muteVideo":"unmuteVideo"]()];case 1:return i.sent(),logger.log(TAG_NAME,"muteLocalVideo success: ",e),[3,3];case 2:throw t=i.sent(),logger.error(TAG_NAME,"muteLocalVideo fail: ",e),t;case 3:return[2]}}))}))},t.prototype.muteLocalAudio=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:if(i.trys.push([0,2,,3]),!this.localStream)throw LOCAL_STREAM_NULL;return[4,this.localStream[e?"muteAudio":"unmuteAudio"]()];case 1:return i.sent(),logger.log(TAG_NAME,"muteLocalAudio success: ",e),[3,3];case 2:throw t=i.sent(),logger.error(TAG_NAME,"muteLocalAudio fail: ",e),t;case 3:return[2]}}))}))},t.prototype.playLocalStream=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(!this.localStream)throw LOCAL_STREAM_NULL;if(!this._localView)throw LOCAL_VIEW_NULL;return[4,this._startStreamPreview(this.localStream,"local",e||this._localView)];case 1:return t.sent(),[2]}}))}))},t.prototype.setLocalView=function(e){this._localView=e},t.prototype.setRemoteView=function(e,t){var i=this._remoteViews.find((function(e){return e.uid===t}));i?i.view=e:this._remoteViews.push({view:e,uid:t})},t.prototype.playRemoteStream=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i;return __generator(this,(function(r){switch(r.label){case 0:if(!(t=this._remoteViews.find((function(t){return t.uid===e.getId()}))))throw REMOTE_VIEW_NULL;r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._startStreamPreview(e,"remote",t.view)];case 2:return r.sent(),[3,4];case 3:throw i=r.sent(),logger.error(TAG_NAME,"_playRemoteStream fail: ",i),i;case 4:return[2]}}))}))},t.prototype.resetState=function(){var e;null===(e=this.localStream)||void 0===e||e.destroy(),this._localView=void 0,this.localStream=void 0,this._remoteViews=[],this.remoteStreams=[]},t.prototype.destroy=function(){this.leaveRTCChannel()},t.prototype._startStreamPreview=function(e,t,i){return __awaiter(this,void 0,void 0,(function(){var r,s;return __generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),e.stop(),[4,e.play(i)];case 1:return a.sent(),r={width:i.clientWidth,height:i.clientHeight,cut:!0},e["local"===t?"setLocalRenderMode":"setRemoteRenderMode"](r),logger.log(TAG_NAME,"local"===t?"setLocalRenderMode":"setRemoteRenderMode success",{params:r,type:t}),[3,3];case 2:throw s=a.sent(),logger.error(TAG_NAME,"startStreamPreview fail: ",s),s;case 3:return[2]}}))}))},t.prototype._addStream=function(e){e.setSubscribeConfig({audio:!0,video:!0}),this.client.subscribe(e);var t=e.getId();this.remoteStreams.some((function(e){return e.getId()===t}))?(logger.log(TAG_NAME,"stream-added：订阅的流已存在，更新流"),this._updateStream(e)):(logger.log(TAG_NAME,"stream-added：新增需要订阅的流"),this.remoteStreams.push(e))},t.prototype._updateStream=function(e){var t=e.getId();this.remoteStreams=this.remoteStreams.map((function(i){return i.getId()===t?e:i}))},t.prototype._addRtcEventListener=function(){return __awaiter(this,void 0,void 0,(function(){var e,t=this;return __generator(this,(function(i){return e=index_cjs_11((function(e){logger.log(TAG_NAME,"peer-online: ",e),t.emit("peerOnline",e.uid)}),100),this.client.on("peer-online",e),this.client.on("peer-leave",(function(e){logger.log(TAG_NAME,"peer-leave: ",e),t.emit("peerLeave",e.uid)})),this.client.on("stream-added",(function(e){logger.log(TAG_NAME,"stream-added: ",e),t._addStream(e.stream),t.emit("streamAdd",e.stream)})),this.client.on("stream-removed",(function(e){logger.log(TAG_NAME,"stream-removed: ",e);var i=e.stream;i.stop(e.mediaType),t._updateStream(i)})),this.client.on("stream-subscribed",(function(e){logger.log(TAG_NAME,"stream-subscribed: ",e),t.emit("streamSubscribed",e.stream)})),this.client.on("mute-video",(function(e){logger.log(TAG_NAME,"mute-video: ",e);var i=e.uid,r=t.remoteStreams.find((function(e){return e.getId()===i}));null==r||r.stop("video")})),this.client.on("unmute-video",(function(e){var i;logger.log(TAG_NAME,"unmute-video: ",e);var r=e.uid,s=null===(i=t._remoteViews.find((function(e){return e.uid===r})))||void 0===i?void 0:i.view,a=t.remoteStreams.find((function(e){return e.getId()===r}));s&&a&&t._startStreamPreview(a,"remote",s)})),this.client.on("mute-audio",(function(e){logger.log(TAG_NAME,"mute-audio: ",e)})),this.client.on("unmute-audio",(function(e){logger.log(TAG_NAME,"unmute-audio: ",e)})),this.client.on("error",(function(e){logger.log(TAG_NAME,"error: ",e),t.emit("error",e)})),[2]}))}))},__decorate([loggerDecorator$2],t.prototype,"initLocalStream",null),__decorate([loggerDecorator$2],t.prototype,"leaveRTCChannel",null),__decorate([loggerDecorator$2],t.prototype,"joinRTCChannel",null),__decorate([loggerDecorator$2],t.prototype,"publishLocalStream",null),__decorate([loggerDecorator$2],t.prototype,"enableLocalVideo",null),__decorate([loggerDecorator$2],t.prototype,"enableLocalAudio",null),__decorate([loggerDecorator$2],t.prototype,"muteLocalVideo",null),__decorate([loggerDecorator$2],t.prototype,"muteLocalAudio",null),__decorate([loggerDecorator$2],t.prototype,"playLocalStream",null),__decorate([loggerDecorator$2],t.prototype,"playRemoteStream",null),t}(EventEmitter),RTCController$1=RTCController,loggerDecorator$1=index_cjs_10("NECallEngine",logger),NECallEngine=function(e){function t(){var t=e.call(this)||this;return t.enableJoinRtcWhenCall=!1,t.enableSwitchVideoConfirm=!1,t.enableSwitchAudioConfirm=!1,t._unusualTimeout=15e3,t}return __extends(t,e),t.prototype.setup=function(e){var t=e.nim,i=e.appkey,r=e.enableRecord,s=void 0===r||r,a=e.enableAutoJoinSignalChannel,n=void 0!==a&&a,o=e.enableJoinRtcWhenCall,d=void 0!==o&&o,c=e.enableMarkInviteEventDelay,l=void 0===c||c,u=e.rtcContext,h=e.debug,p=void 0!==h&&h;this.signalController&&this.signalController.destroy(),this.signalController=new SignalController$1({nim:t,enableMarkInviteEventDelay:l}),this.signalController.enableRecord=s,this.signalController.enableAutoJoinSignalChannel=n,this.rtcController=new RTCController$1({appkey:i,rtcConfig:u,debug:p}),this._currentUserInfo={accId:t.account},this.enableJoinRtcWhenCall=d,this._bindSignalControllerHooks(),this._handleRtcEvents(),logger.setLevel(p?"debug":"warn"),new index_cjs_3({appKey:i,version:pkg.version,nertcVersion:NERTC$1.VERSION,component:"CallKit"}).track("init","")},t.prototype.call=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:return"number"==typeof e.callType&&(e.callType=String(e.callType)),this._callType=e.callType,this._remoteUserInfo={accId:e.accId,role:"callee"},t=this.rtcController.client.getParameter("getChannelInfo"),[4,this.signalController.call(__assign(__assign({},e),{nertcChannelName:e.rtcChannelName,nertcJoinRoomQueryParamMap:t}))];case 1:return i.sent(),[2,this.getCallInfo()]}}))}))},t.prototype.accept=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:return e=this.rtcController.client.getParameter("getChannelInfo"),[4,this.signalController.accept({nertcJoinRoomQueryParamMap:e})];case 1:return t.sent(),[2,this.getCallInfo()]}}))}))},t.prototype.hangup=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return 1!==this.signalController.callStatus?[3,2]:[4,this.signalController.cancel(e)];case 1:t.sent(),t.label=2;case 2:return 2!==this.signalController.callStatus?[3,4]:[4,this.signalController.reject(e)];case 3:t.sent(),t.label=4;case 4:return 3!==this.signalController.callStatus?[3,6]:[4,this.signalController.hangup(e)];case 5:t.sent(),t.label=6;case 6:return[2]}}))}))},t.prototype.switchCallType=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i;return __generator(this,(function(r){switch(r.label){case 0:return t=e.state,i=String(e.callType),1!==t?[3,2]:"1"===i&&this.enableSwitchAudioConfirm||"2"===i&&this.enableSwitchVideoConfirm?[3,2]:(this._callType=i,this.emit("onCallTypeChange",{callType:i,state:2}),[4,this.signalController.control({ext:{cid:2,type:Number(i)}})]);case 1:r.sent(),r.label=2;case 2:return 2===e.state&&(this._callType=i,this.emit("onCallTypeChange",{callType:i,state:2})),[4,this.signalController.control({ext:{cid:3,type:Number(i),state:t}})];case 3:return r.sent(),[2]}}))}))},t.prototype.setLocalView=function(e){this.rtcController.setLocalView(e)},t.prototype.setRemoteView=function(e){var t;this._remoteView=e;var i=null===(t=this._remoteUserInfo)||void 0===t?void 0:t.uid;i&&this.rtcController.setRemoteView(e,i)},t.prototype.enableLocalVideo=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.rtcController.enableLocalVideo(e)];case 1:return t.sent(),[2]}}))}))},t.prototype.muteLocalVideo=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.rtcController.muteLocalVideo(e)];case 1:return t.sent(),[2]}}))}))},t.prototype.muteLocalAudio=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.rtcController.muteLocalAudio(e)];case 1:return t.sent(),[2]}}))}))},t.prototype.initAndPlayLocalSteam=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.rtcController.initLocalStream({uid:this._currentUserInfo.uid,audio:!0,video:"2"===this._callType,screen:!1})];case 1:return t.sent(),[4,this.rtcController.playLocalStream(e)];case 2:return t.sent(),[2]}}))}))},t.prototype.setTimeout=function(e){this.signalController.callTimeout=1e3*e},t.prototype.setCallConfig=function(e){void 0!==e.enableOffline&&(this.signalController.offlineEnabled=e.enableOffline),void 0!==e.enableSwitchVideoConfirm&&(this.enableSwitchVideoConfirm=e.enableSwitchVideoConfirm),void 0!==e.enableSwitchAudioConfirm&&(this.enableSwitchAudioConfirm=e.enableSwitchAudioConfirm),void 0!==e.enableJoinRtcWhenCall&&(this.enableJoinRtcWhenCall=e.enableJoinRtcWhenCall)},t.prototype.getUidByAccId=function(e){return this._remoteUserInfo.accId===e?this._remoteUserInfo.uid:this._currentUserInfo.accId===e?this._currentUserInfo.uid:void 0},t.prototype.getCallInfo=function(){var e,t,i,r,s,a;if(0!==this.signalController.callStatus){var n=this._currentUserInfo,o=this._remoteUserInfo;"caller"===this._remoteUserInfo.role&&(n=this._remoteUserInfo,o=this._currentUserInfo),delete n.role,delete o.role;var d=this.rtcController.getChannelInfo();return{callId:null===(e=this.signalController.channelInfo)||void 0===e?void 0:e.attachExt.callId,callStatus:this.signalController.callStatus,callType:Number(this._callType),currentAccId:this._currentUserInfo.accId,rtcInfo:{channelId:d.cid,channelName:d.channelName,token:d.token},signalInfo:{channelId:null===(t=this.signalController.channelInfo)||void 0===t?void 0:t.channelId,requestId:null===(i=this.signalController.channelInfo)||void 0===i?void 0:i.requestId,channelName:null===(r=this.signalController.channelInfo)||void 0===r?void 0:r.channelName,extraInfo:null===(s=this.signalController.channelInfo)||void 0===s?void 0:s.attachExt.extraInfo,globalExtraCopy:null===(a=this.signalController.channelInfo)||void 0===a?void 0:a.attachExt.global_extra},callerInfo:n,calleeInfo:o}}},t.prototype.getCallConfig=function(){return{enableOffline:this.signalController.offlineEnabled,enableSwitchVideoConfirm:this.enableSwitchVideoConfirm,enableSwitchAudioConfirm:this.enableSwitchAudioConfirm}},t.prototype.reconnect=function(){this.signalController.reconnect()},t.prototype.destroy=function(){this.rtcController.destroy(),this.signalController.destroy(),this.removeAllListeners()},t.prototype._handleCallEnd=function(e){this._unusualTimer&&clearTimeout(this._unusualTimer),this._unusualTimer=void 0,this.signalController.resetState(),this.rtcController.leaveRTCChannel(),this.emit("onCallEnd",e)},t.prototype._rtcJoin=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i=this;return __generator(this,(function(r){switch(r.label){case 0:return this._unusualTimer=setTimeout((function(){i._handleCallEnd({reasonCode:5})}),this._unusualTimeout),this._remoteUserInfo.uid=null===(t=e.members.find((function(e){return e.accid===i._remoteUserInfo.accId})))||void 0===t?void 0:t.uid,this._remoteView&&this._remoteUserInfo.uid&&this.rtcController.setRemoteView(this._remoteView,this._remoteUserInfo.uid),[4,this.rtcController.joinRTCChannel({channelName:e.attachExt.channelName,uid:this._currentUserInfo.uid,token:e.nertcToken,getChanneInfoResponse:e.nertcJoinRoomResponse})];case 1:return r.sent(),this.signalController.callStatus!==SignalControllerCallingStatus.inCall?[3,4]:[4,this.initAndPlayLocalSteam()];case 2:return r.sent(),[4,this.rtcController.publishLocalStream()];case 3:r.sent(),r.label=4;case 4:return[2]}}))}))},t.prototype._syncCurrentUserInfoBySignalControllerMembers=function(e){var t=this,i=e.find((function(e){return e.accid===t._currentUserInfo.accId}));i&&(this._currentUserInfo.uid=i.uid)},t.prototype._bindSignalControllerHooks=function(){var e=this;this.signalController.on("afterSignalCallEx",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return console.log("afterSignalCallEx",t),this._syncCurrentUserInfoBySignalControllerMembers(t.members),this.enableJoinRtcWhenCall?[4,this.rtcController.joinRTCChannel({channelName:t.attachExt.channelName,uid:this._currentUserInfo.uid,token:t.nertcToken,getChanneInfoResponse:t.nertcJoinRoomResponse})]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))})),this.signalController.on("afterSignalAccept",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return this._syncCurrentUserInfoBySignalControllerMembers(t.members),[4,this._rtcJoin(t)];case 1:return e.sent(),[2]}}))}))})),this.signalController.on("afterSignalCancel",(function(t){e._handleCallEnd({extraString:t._attachment,reasonCode:2===t.reason?2:11})})),this.signalController.on("afterSignalReject",(function(t){e._handleCallEnd({extraString:t._attachment,reasonCode:2===t.reason?2:13})})),this.signalController.on("afterSignalHangup",(function(t){e._handleCallEnd({extraString:t._attachment,reasonCode:15})})),this.signalController.on("whenSignalCancel",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this._handleCallEnd({extraString:t._attachment,reasonCode:2===t.reason?2:12}),[2]}))}))})),this.signalController.on("whenSignalReject",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this._handleCallEnd({extraString:t._attachment,reasonCode:2===t.reason?2:3===t.reason?3:14}),[2]}))}))})),this.signalController.on("whenSignalAccept",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this._rtcJoin(t)];case 1:return e.sent(),[2]}}))}))})),this.signalController.on("whenSignalInvite",(function(t){return __awaiter(e,void 0,void 0,(function(){var e,i,r;return __generator(this,(function(s){return this._callType=t.type,this._syncCurrentUserInfoBySignalControllerMembers(t.members),this._remoteUserInfo={accId:t.callerId,uid:null===(i=t.members.find((function(e){return e.accid===t.callerId})))||void 0===i?void 0:i.uid,role:"caller"},e={callerAccId:this._remoteUserInfo.accId,callType:t.type,extraInfo:t.attachExt.extraInfo||(null===(r=t.attachExt)||void 0===r?void 0:r._attachment),channelId:t.channelId},this.emit("onReceiveInvited",e),[2]}))}))})),this.signalController.on("whenSignalControl",(function(t){return __awaiter(e,void 0,void 0,(function(){var e,i,r;return __generator(this,(function(s){switch(s.label){case 0:return 3!==t.cid&&2!==t.cid||!t.type?[3,4]:(e=null!==(r=t.state)&&void 0!==r?r:1,(i=String(t.type))===this._callType?[2]:1!==e?[3,3]:"1"===i&&this.enableSwitchAudioConfirm||"2"===i&&this.enableSwitchVideoConfirm?(this.emit("onCallTypeChange",{callType:i,state:1}),[3,3]):[3,1]);case 1:return this._callType=i,this.emit("onCallTypeChange",{callType:i,state:2}),[4,this.signalController.control({ext:{cid:3,type:Number(i),state:2}})];case 2:s.sent(),s.label=3;case 3:2===e&&(this._callType=i,this.emit("onCallTypeChange",{callType:i,state:2})),3===e&&this.emit("onCallTypeChange",{callType:i,state:3}),s.label=4;case 4:return[2]}}))}))})),this.signalController.on("whenSignalRoomClose",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this._handleCallEnd({extraString:t._attachment,reasonCode:16}),[2]}))}))})),this.signalController.on("whenSignalAcceptOtherClient",(function(){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this._handleCallEnd({reasonCode:18}),[2]}))}))})),this.signalController.on("whenSignalRejectOtherClient",(function(){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this._handleCallEnd({reasonCode:17}),[2]}))}))})),this.signalController.on("afterCallRecordSend",(function(t){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(e){return this.emit("onRecordSend",t),[2]}))}))}))},t.prototype._handleRtcEvents=function(){var e=this;this.rtcController.on("streamSubscribed",(function(t){e.rtcController.playRemoteStream(t)})),this.rtcController.on("peerOnline",(function(){e._unusualTimer&&clearTimeout(e._unusualTimer),e._unusualTimer=void 0,e.signalController.callStatus===SignalControllerCallingStatus.inCall&&e.emit("onCallConnected",e.getCallInfo())})),this.rtcController.on("peerLeave",(function(){e._unusualTimer||e.signalController.callStatus!==SignalControllerCallingStatus.inCall||(e._unusualTimer=setTimeout((function(){e._handleCallEnd({reasonCode:20})}),e._unusualTimeout))})),this.rtcController.on("error",(function(){e._unusualTimer||(e._unusualTimer=setTimeout((function(){e._handleCallEnd({reasonCode:14})}),e._unusualTimeout))}))},t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},__decorate([loggerDecorator$1],t.prototype,"call",null),__decorate([loggerDecorator$1],t.prototype,"accept",null),__decorate([loggerDecorator$1],t.prototype,"hangup",null),__decorate([loggerDecorator$1],t.prototype,"switchCallType",null),t}(EventEmitter),NECallEngine$1=NECallEngine,HttpRequestProxy;!function(e){e.GET="1",e.POST="2",e.PUT="3",e.DELETE="4"}(HttpRequestProxy||(HttpRequestProxy={}));var loggerDecorator=index_cjs_10("NEGroupCallEngine",logger),NEGroupCallEngine=function(e){function t(){var t=e.call(this)||this;return t.callStatus=0,t._rtcViews={},t._members=[],t}return __extends(t,e),t.prototype.setup=function(e){var t=e.nim,i=e.appkey,r=e.rtcConfig,s=e.debug;this.rtcController=new RTCController$1({appkey:i,rtcConfig:r,debug:s}),this._currentUserInfo={accId:t.account},this._baseUrl="/scene/groupCall/".concat(i,"/call/"),this._nim=t,this._handleRtcEvents(),logger.setLevel(s?"debug":"warn")},t.prototype.receiveNimMsg=function(e){var t=this,i=JSON.parse(e);if(i.isFromCallKitServer){if(0!==this.callStatus&&i.callId!==this._callId)1===i.type&&this._busyReject({callId:i.callId});else if(1===i.type)this._rejectTimer=setTimeout((function(){t._resetState(),t.emit("onCallEnd")}),1e3*i.timeout),this.callStatus=1,this._callId=i.callId,this._queryMembers().then((function(e){i.members=e,t._members=i.members,t.emit("onReceiveInvited",i)}));else if(2===i.type){var r=i.members.find((function(e){return e.imAccid===t._currentUserInfo.accId})),s=r&&2===this.callStatus&&3===r.state;r&&1===this.callStatus&&(3===r.state||2===r.state)||s?(this.rtcController.leaveRTCChannel(),this._resetState(),this.emit("onCallEnd")):(this._updateMembers(i.members),this.emit("onMembersChange",this._members))}else 3===i.type&&(this.rtcController.leaveRTCChannel(),this._resetState(),this.emit("onCallEnd"));return!0}return!1},t.prototype.groupCall=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i,r;return __generator(this,(function(s){switch(s.label){case 0:return t=this._baseUrl,e.callId&&(t+=e.callId),[4,this._nimHttpRequestProxy(t,HttpRequestProxy.PUT,e)];case 1:return i=s.sent(),this.callStatus=2,this._currentUserInfo.uid=i.callerUid,this._rtcChannelName=i.rtcChannelName,this._callId=i.callId,r=i,[4,this._queryMembers()];case 2:return r.members=s.sent(),this._members=i.members,this.emit("onMembersChange",this._members),[2,i]}}))}))},t.prototype.groupAccept=function(){return __awaiter(this,void 0,void 0,(function(){var e,t,i,r=this;return __generator(this,(function(s){switch(s.label){case 0:return e=this._baseUrl+this._callId+"/member/"+this._currentUserInfo.accId+"/state/accept",[4,this._nimHttpRequestProxy(e,HttpRequestProxy.POST,{})];case 1:return t=s.sent(),this.callStatus=2,t.members=this._sortMembers(t.members),this._members=t.members,this._rtcChannelName=t.rtcChannelName,this._callId=t.callId,(i=t.members.find((function(e){return e.imAccid===r._currentUserInfo.accId})))&&(this._currentUserInfo.uid=i.rtcUid),this._rejectTimer&&clearTimeout(this._rejectTimer),[2,t]}}))}))},t.prototype.groupHangup=function(){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(t){switch(t.label){case 0:switch(e=this._baseUrl+this._callId+"/member/"+this._currentUserInfo.accId+"/state/",this.callStatus){case 1:e+="reject";break;case 2:e+="leave"}return 2===this.callStatus&&this.rtcController.leaveRTCChannel(),this._resetState(),[4,this._nimHttpRequestProxy(e,HttpRequestProxy.POST,{})];case 1:return t.sent(),[2]}}))}))},t.prototype.groupInvite=function(e){return __awaiter(this,void 0,void 0,(function(){var t,i;return __generator(this,(function(r){switch(r.label){case 0:return t=this._baseUrl+this._callId+"/member/invite",[4,this._nimHttpRequestProxy(t,HttpRequestProxy.POST,e)];case 1:return r.sent(),i=this,[4,this._queryMembers()];case 2:return i._members=r.sent(),this.emit("onMembersChange",this._members),[2]}}))}))},t.prototype.groupJoin=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i,r,s,a=this;return __generator(this,(function(n){switch(n.label){case 0:return i=this._baseUrl+e.callId+"/member/join",[4,this._nimHttpRequestProxy(i,HttpRequestProxy.POST,e)];case 1:return r=n.sent(),this._currentUserInfo.uid=null===(t=r.members.find((function(e){return e.imAccid===a._currentUserInfo.accId})))||void 0===t?void 0:t.rtcUid,this._callId=e.callId,this.callStatus=2,this._rtcChannelName=r.rtcChannelName,s=this,[4,this._queryMembers()];case 2:return s._members=n.sent(),this.emit("onMembersChange",this._members),[2,r]}}))}))},t.prototype.groupQueryCallInfo=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:return i=this._baseUrl+(null!==(t=null==e?void 0:e.callId)&&void 0!==t?t:this._callId),[4,this._nimHttpRequestProxy(i,HttpRequestProxy.GET)];case 1:return[2,r.sent()]}}))}))},t.prototype.enableLocalVideo=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return e?[4,this.rtcController.enableLocalVideo(e)]:[3,2];case 1:return t.sent(),[3,5];case 2:return[4,this.rtcController.muteLocalVideo(!e)];case 3:return t.sent(),[4,this.rtcController.enableLocalVideo(e)];case 4:t.sent(),t.label=5;case 5:return[2]}}))}))},t.prototype.enableLocalAudio=function(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.rtcController.enableLocalAudio(e)];case 1:return t.sent(),[2]}}))}))},t.prototype.setRtcView=function(e,t){var i;if(this._rtcViews[t]&&e!==this._rtcViews[t]){var r=null===(i=this._members.find((function(e){return e.imAccid===t})))||void 0===i?void 0:i.rtcUid,s=this.rtcController.remoteStreams.find((function(e){return e.getId()===r}));r&&s&&(this.rtcController.setRemoteView(e,r),this.rtcController.playRemoteStream(s))}this._rtcViews[t]=e},t.prototype.joinRtc=function(e){var t;return __awaiter(this,void 0,void 0,(function(){var i;return __generator(this,(function(r){switch(r.label){case 0:if(!this._rtcChannelName)throw new Error("rtcChannelName is empty");return[4,this.rtcController.joinRTCChannel({channelName:this._rtcChannelName,uid:this._currentUserInfo.uid})];case 1:return r.sent(),i=this._rtcViews[this._currentUserInfo.accId],this.rtcController.setLocalView(i),[4,this.rtcController.initLocalStream({uid:this._currentUserInfo.uid,audio:!0,video:null!==(t=null==e?void 0:e.video)&&void 0!==t&&t,screen:!1})];case 2:return r.sent(),[4,this.rtcController.playLocalStream()];case 3:return r.sent(),[4,this.rtcController.publishLocalStream()];case 4:return r.sent(),[2]}}))}))},t.prototype.destroy=function(){this.rtcController.destroy(),this._resetState()},t.prototype._resetState=function(){this.callStatus=0,this._callId=void 0,this._rtcChannelName=void 0,this._rtcViews={},this._members=[],this._rejectTimer&&clearTimeout(this._rejectTimer)},t.prototype._busyReject=function(e){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(i){switch(i.label){case 0:return t=this._baseUrl+e.callId+"/member/"+this._currentUserInfo.accId+"/state/reject",[4,this._nimHttpRequestProxy(t,HttpRequestProxy.POST,{reason:"busy"})];case 1:return i.sent(),[2]}}))}))},t.prototype._queryMembers=function(){return __awaiter(this,void 0,void 0,(function(){var e,t;return __generator(this,(function(i){switch(i.label){case 0:return e=this._baseUrl+this._callId+"/members",[4,this._nimHttpRequestProxy(e,HttpRequestProxy.GET)];case 1:return(t=i.sent()).members=this._sortMembers(t.members),[2,t.members]}}))}))},t.prototype._updateMembers=function(e){var t=this;e.forEach((function(e){var i=t._members.findIndex((function(t){return t.imAccid===e.imAccid}));-1!==i?t._members[i]=e:t._members.push(e)}))},t.prototype._sortMembers=function(e){var t=this,i=e.findIndex((function(e){return e.imAccid===t._currentUserInfo.accId}));return-1!==i?e.splice(i,1).concat(e):e},t.prototype._handleRtcEvents=function(){var e=this;this.rtcController.on("streamSubscribed",(function(t){var i,r=t.getId();if(r){var s=null===(i=e._members.find((function(e){return e.rtcUid===r})))||void 0===i?void 0:i.imAccid;if(s){var a=e._rtcViews[s];e.rtcController.setRemoteView(a,r),e.rtcController.playRemoteStream(t)}else e._queryMembers().then((function(i){var s;e._members=i;var a=null===(s=e._members.find((function(e){return e.rtcUid===r})))||void 0===s?void 0:s.imAccid;if(a){var n=e._rtcViews[a];e.rtcController.setRemoteView(n,r),e.rtcController.playRemoteStream(t)}}))}})),this.rtcController.on("error",(function(){e.rtcController.leaveRTCChannel(),e._resetState(),e.emit("onCallEnd")}))},t.prototype._nimHttpRequestProxy=function(e,t,i){var r=this;return new Promise((function(s,a){r._nim.httpRequestProxy({header:JSON.stringify({groupCallVer:"1.6.0",user:r._currentUserInfo.accId}),method:t,path:e,body:i&&JSON.stringify(i),done:function(e,t){if(e)a(e);else try{var i=JSON.parse(t.body);0===i.code?s(i.data):a(i)}catch(e){a(e)}}})}))},t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},__decorate([loggerDecorator],t.prototype,"groupCall",null),__decorate([loggerDecorator],t.prototype,"groupAccept",null),__decorate([loggerDecorator],t.prototype,"groupHangup",null),__decorate([loggerDecorator],t.prototype,"groupInvite",null),__decorate([loggerDecorator],t.prototype,"groupJoin",null),__decorate([loggerDecorator],t.prototype,"groupQueryCallInfo",null),t}(EventEmitter),NEGroupCallEngine$1=NEGroupCallEngine;exports.NECall=NECallEngine$1,exports.NEGroupCall=NEGroupCallEngine$1,Object.defineProperty(exports,"__esModule",{value:!0})}));
